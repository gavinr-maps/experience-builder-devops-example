System.register(["jimu-core","jimu-ui","jimu-core/react","jimu-layouts/layout-runtime","jimu-core/react-dom/server"],(function(e){var t,s,n,i,r;return{setters:[function(e){t=e},function(e){s=e},function(e){n=e},function(e){i=e},function(e){r=e}],execute:function(){e(function(e){var t={};function s(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,s),i.l=!0,i.exports}return s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(n,i,function(t){return e[t]}.bind(null,i));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=982)}({0:function(e,s){e.exports=t},1:function(e,t){e.exports=s},18:function(e,t){e.exports=i},2:function(e,t){e.exports=n},279:function(e,t){e.exports='<svg viewBox="0 0 12 14" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.667V13a.667.667 0 01-1.333 0V1c0-.368.298-.667.666-.667H8c.177 0 .346.07.471.196l2.667 2.666a.667.667 0 01.195.472V13a.667.667 0 01-.666.667H4a.667.667 0 010-1.334h6v-8.39L7.724 1.667H2zm2 6a.667.667 0 110-1.334h4a.667.667 0 010 1.334H4zM4 5a.667.667 0 110-1.333h1.333a.667.667 0 010 1.333H4zm0 5.333A.667.667 0 014 9h2.667a.667.667 0 010 1.333H4z" fill="#FFF" fill-rule="nonzero"></path></svg>'},280:function(e,t){e.exports='<svg viewBox="0 0 12 14" xmlns="http://www.w3.org/2000/svg"><path d="M10.056 3.165V2.063H2.892l4.215 4.534A.732.732 0 017.1 7.602L2.93 11.937h7.125v-.666a.732.732 0 011.463 0v1.397a.733.733 0 01-.732.732H1.213a.73.73 0 01-.528-1.239l4.88-5.074L.677 1.83A.732.732 0 011.213.6h9.574c.404 0 .732.328.732.732v1.833a.733.733 0 01-1.463 0z" fill="#FFF" fill-rule="nonzero"></path></svg>'},281:function(e,t){e.exports='<svg viewBox="0 0 16 12" xmlns="http://www.w3.org/2000/svg"><path d="M2 6l4-4H4L0 6l4 4h2L2 6zm10-4h-2l4 4-4 4h2l4-4-4-4zM8.5 0L6 12h1.5L10 0H8.5z" fill="#FFF" fill-rule="nonzero"></path></svg>'},282:function(e,t){e.exports='<svg viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg"><path d="M3.333 0C2.597 0 2 .597 2 1.333V4c0 .736-.597 1.333-1.333 1.333H0v1.334h.667A1.333 1.333 0 012 8v2.667C2 11.403 2.597 12 3.333 12h1.334v-1.333H3.333V7.333C3.333 6.597 2.736 6 2 6c.736 0 1.333-.597 1.333-1.333V1.333h1.334V0m4 0C9.403 0 10 .597 10 1.333V4a1.333 1.333 0 001.333 1.333H12v1.334h-.667A1.333 1.333 0 0010 8v2.667C10 11.403 9.403 12 8.667 12H7.333v-1.333h1.334V7.333C8.667 6.597 9.264 6 10 6a1.333 1.333 0 01-1.333-1.333V1.333H7.333V0h1.334z" fill="#FFF" fill-rule="nonzero"></path></svg>'},42:function(e,t,s){"use strict";var n=s(43);function i(){}function r(){}r.resetWarningCache=i,e.exports=function(){function e(e,t,s,i,r,o){if(o!==n){var a=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw a.name="Invariant Violation",a}}function t(){return e}e.isRequired=e;var s={array:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,elementType:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:r,resetWarningCache:i};return s.PropTypes=s,s}},43:function(e,t,s){"use strict";e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},470:function(e,t){e.exports=r},471:function(e,t,s){"use strict";var n,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])})(e,t)},function(e,t){function s(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)}),r=this&&this.__assign||function(){return(r=Object.assign||function(e){for(var t,s=1,n=arguments.length;s<n;s++)for(var i in t=arguments[s])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},o=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),p=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.hasOwnProperty.call(e,s)&&o(t,e,s);return a(t,e),t},l=this&&this.__rest||function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(s[n[i]]=e[n[i]])}return s},c=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var d=p(s(2)),h=c(s(663)),u=p(s(6));function x(e){return e&&e.replace(/&nbsp;|\u202F|\u00A0/g," ")}var g=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lastHtml=t.props.html,t.el="function"==typeof t.props.innerRef?{current:null}:d.createRef(),t.getEl=function(){return(t.props.innerRef&&"function"!=typeof t.props.innerRef?t.props.innerRef:t.el).current},t.emitChange=function(e){var s=t.getEl();if(s){var n=s.innerHTML;if(t.props.onChange&&n!==t.lastHtml){var i=Object.assign({},e,{target:{value:n}});t.props.onChange(i)}t.lastHtml=n}},t}return i(t,e),t.prototype.render=function(){var e=this,t=this.props,s=t.tagName,n=t.html,i=t.innerRef,o=l(t,["tagName","html","innerRef"]);return d.createElement(s||"div",r(r({},o),{ref:"function"==typeof i?function(t){i(t),e.el.current=t}:i||this.el,onInput:this.emitChange,onBlur:this.props.onBlur||this.emitChange,onKeyUp:this.props.onKeyUp||this.emitChange,onKeyDown:this.props.onKeyDown||this.emitChange,contentEditable:!this.props.disabled,dangerouslySetInnerHTML:{__html:n}}),this.props.children)},t.prototype.shouldComponentUpdate=function(e){var t=this.props,s=this.getEl();return!s||(x(e.html)!==x(s.innerHTML)||(t.disabled!==e.disabled||t.tagName!==e.tagName||t.className!==e.className||t.innerRef!==e.innerRef||!h.default(t.style,e.style)))},t.prototype.componentDidUpdate=function(){var e=this.getEl();e&&(this.props.html!==e.innerHTML&&(e.innerHTML=this.props.html),this.lastHtml=this.props.html,function(e){var t=document.createTextNode("");e.appendChild(t);var s=document.activeElement===e;if(null!==t&&null!==t.nodeValue&&s){var n=window.getSelection();if(null!==n){var i=document.createRange();i.setStart(t,t.nodeValue.length),i.collapse(!0),n.removeAllRanges(),n.addRange(i)}e instanceof HTMLElement&&e.focus()}}(e))},t.propTypes={html:u.string.isRequired,onChange:u.func,disabled:u.bool,tagName:u.string,className:u.string,style:u.object,innerRef:u.oneOfType([u.object,u.func])},t}(d.Component);t.default=g},6:function(e,t,s){e.exports=s(42)()},663:function(e,t,s){"use strict";var n=Array.isArray,i=Object.keys,r=Object.prototype.hasOwnProperty;e.exports=function e(t,s){if(t===s)return!0;if(t&&s&&"object"==typeof t&&"object"==typeof s){var o,a,p,l=n(t),c=n(s);if(l&&c){if((a=t.length)!=s.length)return!1;for(o=a;0!=o--;)if(!e(t[o],s[o]))return!1;return!0}if(l!=c)return!1;var d=t instanceof Date,h=s instanceof Date;if(d!=h)return!1;if(d&&h)return t.getTime()==s.getTime();var u=t instanceof RegExp,x=s instanceof RegExp;if(u!=x)return!1;if(u&&x)return t.toString()==s.toString();var g=i(t);if((a=g.length)!==i(s).length)return!1;for(o=a;0!=o--;)if(!r.call(s,g[o]))return!1;for(o=a;0!=o--;)if(!e(t[p=g[o]],s[p]))return!1;return!0}return t!=t&&s!=s}},78:function(e,t){e.exports='<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8 6.598L14.308.29a.991.991 0 011.402 1.402L9.402 8l6.308 6.308a.991.991 0 01-1.402 1.402L8 9.402 1.692 15.71A.991.991 0 01.29 14.308L6.598 8 .29 1.692A.991.991 0 011.692.29L8 6.598z" fill="#000" fill-rule="nonzero"></path></svg>'},982:function(e,t,s){"use strict";s.r(t),s.d(t,"ExpressionEditor",(function(){return be})),s.d(t,"ExpressionBuilder",(function(){return Oe})),s.d(t,"ExpressionBuilderPopup",(function(){return Fe})),s.d(t,"ExpressionInput",(function(){return Re})),s.d(t,"ExpressionBuilderType",(function(){return p})),s.d(t,"ExpressionInputType",(function(){return d}));var n={};s.r(n),s.d(n,"ExpressionBuilder",(function(){return r})),s.d(n,"ExpressionEditor",(function(){return o})),s.d(n,"ExpressionInput",(function(){return a}));var i=s(0);function r(e){const t=e.theme;return i.css`
    .component-expression-builder{
      .w-33{
        width: 33% !important;
      }
      .secondary-title{
        font-size: ${i.polished.rem(14)};
        color: ${t.colors.palette.dark[400]};
        font-weight: 400;
      }
      .expression-builder-tab{
        padding-top: 1rem;
        padding-bottom: 1rem;
        overflow: hidden;
        width: 100%;
        height: calc(100% - 10px);
      }
      .has-nav .expression-builder-tab{
        height: calc(100% - 40px);
      }
      .common-tab{
        .mb-12{
          margin-bottom: 12px;
        }
        .option-label{
          font-size: ${i.polished.rem(13)};
          font-weight: 500;
          color: ${t.colors.palette.dark[400]};
        }
        .data-option{
          padding-left: 1rem;
          padding-right: 1rem;
        }
      }
      .field-selector-container{
        height: 100%;
      }
      .expression-editor-container{
        height: calc(100% - 20px);
      }
      .expression-editor-helper{
        height: calc(100% - 130px);
      }
      .exp-editor-helper-tab{
        height: calc(100% - 30px);
      }
      .field-selector-container, .expression-editor-container{
        width: 100%;
      }
      .expression-insert-btn{
        height: ${i.polished.rem(26)};
      }
      .expression-insert-btn{
        max-width: 100%;
        >button{
          max-width: 100%;
        }
      }

    }

  `}function o(e){const t=e.theme;return i.css`
    .component-expression-editor{
      .mt-18{
        margin-top: 18px;
      }
      .mt-12{
        margin-top: 12px;
      }
      .jimu-nav.nav.nav-pills.nav-fill{
        border-top: 0;
        border-left: 0;
        border-right: 0;
      }
      .expression-editor-input{
        -webkit-user-select: text !important;
        user-select: text !important;
        font-size: 13px;
        font-weight: 400;
        overflow-x: hidden;
        overflow-y: auto;
        min-height: ${i.polished.rem(48)};
        max-height: ${i.polished.rem(100)};
        user-select: none;
        border: 0;
        outline: none;
        background-color: ${t.colors.palette.light[200]};
        padding: 1px;
        .expression-editor-input-content-editable:focus{
          border-color: ${t.colors.palette.primary[700]};
          outline: none;
        }
        .expression-editor-input-content-editable{
          border: 1px solid ${t.colors.palette.light[200]};
          min-height: ${i.polished.rem(48)};
          max-height: ${i.polished.rem(100)};
          border-radius: 2px;
          outline: none;
        }
        p{
          min-height: 100%;
        }
        .break-all{
          word-break: break-all;
        }
        span.error-exp{
          color: #FF5066;
        }
        .field-exp{
          color: #FFDE72;
        }
        .function-exp{
          color: #B685FF;
        }
        .number-exp{
          color: #74D3FF;
        }
        .string-exp{
          color: #98FF64;
        }
        .operator-exp{
          color: #F5A623;
        }
        .unknown-exp{
          color: #FF5066;
        }
        .ds-disabled-exp{
          color: #FF5066;
        }
      }

      .error-border{
        border: 1px solid #FF5066;
        outline: none;
        .expression-editor-input-content-editable{
          outline: none;
          border: 0;
        }
      }

      .expression-editor-function-item{
        border: 1px solid transparent;
        cursor: pointer;
        background-color: ${t.colors.palette.light[400]};
        user-select: none;
      }
      .expression-editor-function-item-selected{
        border: 1px solid ${t.colors.primary};
      }
      .expression-editor-function-item:hover{
        background-color: ${t.colors.palette.light[500]};
      }
      .expression-editor-function-item:active.expression-editor-function-item:hover{
        background-color: ${t.colors.white};
      }

      .exp-editor-helper-tab{
        margin-left: -16px;
        margin-right: -16px;
      }

      .error-message{
        height: 20px;
        line-height: 20px;
      }

      .exp-poper{
        background-color: ${t.colors.palette.light[200]};
        border: 1px solid ${t.colors.palette.light[800]};
        font-size: 13px;
        width: ${i.polished.rem(200)};
        z-index: 1;
        padding: 0 !important;
        box-shadow: 0 0 8px 0 ${i.polished.rgba(t.colors.white,.5)};
        .exp-popper-item{
          padding-left: 8px;
          padding-right: 8px;
        }
        .jimu-popper--arrow::after {
          border-bottom-color: ${t.colors.palette.light[200]} !important;
        }
      }
      .exp-popper-selected-item, .exp-popper-item:hover{
        background-color: ${t.colors.secondary};
        cursor: pointer;
      }

    }

  `}function a(e){const t=e.theme;return i.css`
    .component-expression-input{
      font-size: ${t.typography.fontSizeBase};
      .input-wrapper{
        height: ${i.polished.rem(26)};
        padding-top: 0;
        padding-bottom: 0;
      }
      .disabled-input-cover{
        width: 100%;
        height: 100%;
        position: relative;
        top: -100%;
        &.ds-disabled{
          background-color: transparent;
        }
      }
      .ds-disabled{
        background-color: ${t.colors.palette.light[200]};
        cursor: pointer;
        border: 0;
        >span.error-wrapper{
          color: ${t.colors.dark};
          background-color: ${i.polished.rgba(t.colors.palette.danger[600],.5)};
          vertical-align: sub;
          margin-left: 5px;
          margin-right: 5px;
        }
      }
      .ds-placeholder{
        >span{
          color: ${t.colors.palette.dark[400]};
          background-color: ${t.colors.transparent};
        }
      }
      .expression-builder-trigger{
        cursor: pointer;
        width: 26px;
        height: 26px;
        padding: 0;
        .dropdown-button-content{
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .expression-builder-trigger-dropdown{
          padding: 0;
          .trigger-dropdown-toggle{
            background: ${t.colors.palette.light[600]};
            border-radius: 2px 0 0 2px;
            border-color: ${t.colors.palette.light[600]};
          }
        }
      }
      .expression-input{
        height: ${i.polished.rem(26)};
        .jimu-input, .ds-placeholder{
          border-radius: 0 2px 2px 0;
        }
      }
    }

  `}var p,l,c=s(1);!function(e){e.Attribute="ATTRIBUTE",e.Statistics="STATISTICS",e.Expression="EXPRESSION"}(p||(p={})),function(e){e.Static="STATIC"}(l||(l={}));const d=Object.assign(Object.assign({},l),p);function h(e,t){const s=i.DataSourceManager.getInstance();if(e&&e.dataSourceId&&t){if(e.dataSourceId.split("-").reverse()[0]===i.CONSTANTS.SELECTION_DATA_VIEW_ID){const s=i.DataSourceManager.getInstance().getDataSource(e.dataSourceId),n=s&&s.getMainDataSource(),r=n&&n.id;return t.some(e=>(null==e?void 0:e.mainDataSourceId)===r)}return!!(t.some(t=>(null==t?void 0:t.dataSourceId)===e.dataSourceId)&&s&&s.getDataSource(e.dataSourceId))}return!0}function u(e,t){if(!e)return"";switch(e){case d.Attribute:return t.formatMessage({id:"attribute",defaultMessage:c.defaultMessages.attribute});case d.Statistics:return t.formatMessage({id:"statistics",defaultMessage:c.defaultMessages.statistics});case d.Expression:return t.formatMessage({id:"expression",defaultMessage:c.defaultMessages.expression});case d.Static:return t.formatMessage({id:"static",defaultMessage:c.defaultMessages.static});default:return""}}var x=s(470),g=s(471),m=s.n(g);var f,S;!function(e){e.Part="PART",e.Char="CHAR"}(f||(f={})),function(e){e.Field="FIELD",e.DataSource="DATASOURCE",e.Function="FUNCTION"}(S||(S={}));class b extends i.React.PureComponent{constructor(e){super(e)}render(){return i.React.createElement("span",{className:this.props.className,contentEditable:!!this.props.isEditable,suppressContentEditableWarning:!0,id:this.props.id,style:this.props.style,title:this.props.title||null,tabIndex:this.props.tabIndex||null},this.props.exp)}}class y extends i.React.PureComponent{constructor(e){super(e),this.getDsLabel=()=>{const e=i.DataSourceManager.getInstance(),t=e&&e.getDataSource(this.props.dataSourceId);return t?t.getLabel():null}}render(){return i.React.createElement(b,Object.assign({},this.props,{className:Object(i.classNames)("field-exp",{[this.props.className]:!!this.props.className,"error-exp":this.props.isError,"ds-disabled-exp":this.props.isDsDisabled}),style:this.props.style,title:this.getDsLabel(),tabIndex:0}))}}class E extends i.React.PureComponent{constructor(e){super(e),this.state={}}render(){return i.React.createElement(b,Object.assign({},this.props,{className:"string-exp",tabIndex:0}))}}class v extends i.React.PureComponent{constructor(e){super(e),this.getFunctionTooltip=e=>{if(!e)return null;switch(this.props.exp){case i.ExpressionFunctions.Average:return"Average ( fieldName ) returns  { Number }";case i.ExpressionFunctions.Count:return"Count ( ) returns  { Number }";case i.ExpressionFunctions.Sum:return"Sum ( fieldName ) returns  { Number }";case i.ExpressionFunctions.Max:return"Max ( fieldName ) returns  { Number }";case i.ExpressionFunctions.Min:return"Min ( fieldName ) returns  { Number }";default:return null}}}render(){return i.React.createElement("span",{className:Object(i.classNames)("function-exp",{[this.props.className]:!!this.props.className,"ds-disabled-exp":this.props.isDsDisabled}),contentEditable:!!this.props.isEditable,suppressContentEditableWarning:!0,id:this.props.id,title:this.getFunctionTooltip(this.props.exp)},this.props.exp)}}class I extends i.React.PureComponent{constructor(e){super(e)}render(){return i.React.createElement(b,Object.assign({},this.props,{className:Object(i.classNames)("number-exp",{[this.props.className]:!!this.props.className}),style:this.props.style,tabIndex:0}))}}class O extends i.React.PureComponent{constructor(e){super(e),this.state={}}render(){return i.React.createElement(b,Object.assign({},this.props,{className:"unknown-exp"}))}}class C extends i.React.PureComponent{constructor(e){super(e)}render(){return i.React.createElement(b,Object.assign({},this.props,{className:"operator-exp"}))}}class j extends i.React.PureComponent{constructor(e){super(e),this.itemHeight=25,this.popoverItemStyle={lineHeight:this.itemHeight+"px !important"},this.getTarget=(e,t)=>e&&t?t.querySelector("#"+e):null,this.state={targetNode:this.getTarget(this.props.targetNodeId,this.props.containerNode)}}componentDidUpdate(e){if(this.props.selectedItemIndex!==e.selectedItemIndex&&this.props.selectedItemIndex&&this.root){let t;if(parseInt(this.props.selectedItemIndex)>parseInt(e.selectedItemIndex))if(parseInt(this.props.selectedItemIndex)===this.props.items.length-1)t=this.root.scrollHeight-this.root.offsetHeight;else{const e=Math.floor((this.root.scrollTop+this.root.offsetHeight)/this.itemHeight)-1;t=parseInt(this.props.selectedItemIndex)>=e?this.root.scrollTop+this.itemHeight:this.root.scrollTop}else if(0===parseInt(this.props.selectedItemIndex))t=0;else{const e=Math.floor(this.root.scrollTop/this.itemHeight);t=parseInt(this.props.selectedItemIndex)<=e?this.root.scrollTop-this.itemHeight:this.root.scrollTop}this.root.scrollTo(null,t)}this.props.expSelection===e.expSelection&&this.props.targetNodeId===e.targetNodeId&&this.props.containerNode===e.containerNode||this.setState({targetNode:this.getTarget(this.props.targetNodeId,this.props.containerNode)})}render(){return this.state.targetNode&&this.props.items&&0!==this.props.items.length?Object(i.jsx)(c.Popper,{reference:this.state.targetNode,open:this.props.isOpen,placement:"bottom",className:"exp-poper",offset:[0,5],showArrow:!0,disablePortal:!0},Object(i.jsx)("div",{style:{width:"200px",maxHeight:"200px",overflow:"auto"},ref:e=>this.root=e},this.props.items.map((e,t)=>Object(i.jsx)("div",{key:t,onClick:()=>this.props.onClick&&this.props.onClick(e,this.props.targetNodeId),className:Object(i.classNames)("text-break exp-popper-item",{"exp-popper-selected-item":""+t===this.props.selectedItemIndex}),title:e.content,css:Object(i.css)(this.popoverItemStyle)},e.content)))):null}}var F,P=s(18);function N(e,t){return e?t?t.querySelector("#"+e):document&&document.querySelector("#"+e):null}function D(e,t){if(!t||function(e){if(!e)return!1;const t=e.split("-");return!(!t.length||2!==t.length||"expression"!==t[0]||!/^\d+$/.test(t[1]))}(t.id))return null;for(;t&&!R(e,t.id);)t=t.parentElement;return t?t.id:null}function w(e,t){return k(t)?`${e}-part-${t}`:null}function T(e,t){if(!t)return null;const s=t.split("-"),n=R(e,t)?s.length-1:-1;return n>-1?parseInt(s[n]):null}function R(e,t){if(!t||!e)return!1;const s=function(e,t){return t&&e?t.split(e+"-")[1]:null}(e,t);return!(!s||s.split("-").length!=="part".split("-").length+1||t.indexOf("part")!==e.length+1||!/\d$/.test(t))}function M(e){return!e||(e.type?e.type===i.ExpressionPartType.String||e.type===i.ExpressionPartType.Field||e.type===i.ExpressionPartType.Operator:(console.warn("Part has no type: ",e),!1))}function _(e){return!!e&&(H(e)||A(e)||$(e))}function k(e){return!isNaN(e)&&"[object Number]"===Object.prototype.toString.call(e)}function A(e){return!(!e||'"'!==e)}function $(e){return!(!e||"{"!==e)}function V(e){return/^\{(.*?)\}$/.test(e)}function W(e){return!!e&&/^\"(.*?)\"$/.test(e)}function H(e){return!!e&&/^[\+\-\*\/\,\(\)\s+]$/.test(e)}function L(e){return e&&e===i.ExpressionFunctions.Count}function B(e,t,s,n){const r=function(e,t,s){if(!s||!t||0===t.length)return{};const n={};return t.forEach(e=>{n[e.mainDataSourceId]||(n[e.mainDataSourceId]=[]),n[e.mainDataSourceId].some(t=>t.dataSourceId===e.dataSourceId)||(n[e.mainDataSourceId]=n[e.mainDataSourceId].concat(e))}),n}(0,t,s);Object.keys(r).forEach(o=>{var a;r[o]=null===(a=r[o])||void 0===a?void 0:a.concat(function(e,t,s,n,r){if(!t||0===t.length||!n)return[];let o=[];if(!t.some(e=>e.dataViewId===i.CONSTANTS.SELECTION_DATA_VIEW_ID)){const e=t[0].set("dataSourceId",i.DataSourceManager.getInstance().getDataViewDataSourceId(t[0].mainDataSourceId,i.CONSTANTS.SELECTION_DATA_VIEW_ID)).set("dataViewId",i.CONSTANTS.SELECTION_DATA_VIEW_ID);o=o.concat(e)}if(r&&function(e,t,s,n){var r,o,a,p,l;const c=(null===(r=null===window||void 0===window?void 0:window.jimuConfig)||void 0===r?void 0:r.isBuilder)?null===(a=null===(o=Object(i.getAppStore)().getState())||void 0===o?void 0:o.appStateInBuilder)||void 0===a?void 0:a.appConfig:null===(p=Object(i.getAppStore)().getState())||void 0===p?void 0:p.appConfig;if(!(c&&e&&t&&0!==t.length&&s&&n))return!1;const d=P.searchUtils.getParentWidgetIdOfContent(c,e,i.LayoutItemType.Widget,n),h=c.widgets[d],u=h&&(null===(l=h.manifest.properties)||void 0===l?void 0:l.canProvideRepeatDataSource);let x=!1;for(let e=0;e<t.length;e++){const n=U(t[e],s);if(x=(null==h?void 0:h.useDataSources)&&h.useDataSources.some(e=>(null==n?void 0:n.dataSourceId)===e.dataSourceId),x)break}return u&&x}(e,t,s,n)){const e=t[0].set("dataSourceId",i.DataSourceManager.getInstance().getDataViewDataSourceId(t[0].mainDataSourceId,i.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID)).set("dataViewId",i.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID);o=o.concat(e)}return o}(e,r[o],t,s,n))});let o=Object(i.Immutable)([]);return Object.values(r).forEach(e=>{o=o.concat(e)}),o}function U(e,t){if(!e)return null;if(e.dataViewId===i.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID){const s=t.find(t=>t.mainDataSourceId===e.mainDataSourceId);return s&&Object(i.Immutable)(s)}return e}function z(e,t){if(!e||!e.collapsed||!t)return;let s;const n=e;return!!(n.compareBoundaryPoints&&document&&document.createRange)&&(s=document.createRange(),s.selectNodeContents(t),s.collapse(!0),n.compareBoundaryPoints(n.START_TO_END,s)<1)}function J(e,t){if(!e||!e.collapsed||!t)return;let s;const n=e;return!!(n.compareBoundaryPoints&&document&&document.createRange)&&(s=document.createRange(),s.selectNodeContents(t),s.collapse(!1),n.compareBoundaryPoints(n.START_TO_END,s)>-1)}function q(e,t,s){const n=N(e,s);if(n&&t>=0&&window.getSelection){const e=function e(t,s,n){if(!document||!document.createRange)return null;n||((n=document.createRange()).selectNodeContents(t),n.setStart(t,0));if(0===s.count)n.setEnd(t,s.count);else if(t&&s.count>0)if(t.nodeType===Node.TEXT_NODE)t.textContent.length<s.count?s.count-=t.textContent.length:(n.setEnd(t,s.count),s.count=0);else for(let i=0;i<t.childNodes.length&&(n=e(t.childNodes[i],s,n),0!==s.count);i++);return n}(n,{count:t});e&&(e.collapse(!1),window.getSelection().removeAllRanges(),window.getSelection().addRange(e))}}function X(){let e=null;if(window.getSelection&&window.getSelection().getRangeAt){const t=window.getSelection();t.rangeCount>0&&(e=t.getRangeAt(0))}return e}function K(e,t){const s=X();if(!s)return console.warn("Can not get range"),null;let n=null;const i=s.startContainer.nodeType===Node.TEXT_NODE?s.startContainer.parentElement:s.startContainer,r=i===(s.endContainer.nodeType===Node.TEXT_NODE?s.endContainer.parentElement:s.endContainer)&&i&&R(e,i.id),o=r?i:null,a=r?i.id:null;return o&&a&&(n={partId:a,startOffset:s.startOffset,endOffset:s.endOffset,contentLength:o.textContent.length||0}),n}function Y(e){const t=document&&document.querySelector("#"+e),s=X();let n,i;if(t&&s)for(n=t.lastElementChild;n;){if(J(s,n)&&R(e,n.id)){i=n;break}n=n.previousElementSibling}return i}function G(e){const t=document&&document.querySelector("#"+e),s=X();let n,i;if(t&&s)for(n=t.firstElementChild;n;){if(z(s,n)&&R(e,n.id)){i=n;break}n=n.nextElementSibling}return i}function Q(e,t,s,n,i){const r=N(t,document&&document.querySelector("#"+e));let o=null,a=null;return r?(!s&&r.nextElementSibling&&R(e,r.nextElementSibling.id)?o=r.nextElementSibling.id:s&&r.previousElementSibling&&R(e,r.previousElementSibling.id)&&(o=r.previousElementSibling.id),a=o?{type:f.Char,partId:o,startOffset:s?N(o,document&&document.querySelector("#"+e)).textContent.length:0}:{partId:w(e,s?0:i&&i.length>0?i.length-1:0),toStart:s,type:f.Part},a):null}function Z(e){const t=X();let s;if(t.collapsed){const t=Y(e);s=t&&t.id&&R(e,t.id)&&T(e,t.id)}else t.startContainer.nodeType===Node.TEXT_NODE&&(/^\ufeff$/.test(t.startContainer.textContent)||/^\ufeff$/.test(t.startContainer.parentElement.previousSibling.textContent))?s=0:t.startContainer.id===e?s=t.startOffset-1:R(e,t.startContainer.id)?s=T(e,t.startContainer.id)+t.startOffset+1:console.warn("Can not get start part of selection");return k(s)?s:null}function ee(e,t=[]){const s=X();let n;if(s.collapsed){const t=Y(e);n=t&&t.id&&R(e,t.id)&&T(e,t.id)}else s.endContainer.nodeType===Node.TEXT_NODE&&(/^\ufeff$/.test(s.endContainer.textContent)||/^\ufeff$/.test(s.startContainer.parentElement.previousSibling.textContent))?n=t.length-1>-1?t.length-1:0:s.endContainer.id===e?n=s.endOffset-2:R(e,s.endContainer.id)?n=T(e,s.endContainer.id)-s.endOffset-1:console.warn("Can not get end part of selection");return k(n)?n:null}function te(e,t,s,n,r,o){let a=null;if(!s)return a;const p=Object.keys(s).find(e=>s[e]&&s[e].part&&(s[e].part.type===i.ExpressionPartType.String&&'""'===s[e].part.exp||s[e].part.type===i.ExpressionPartType.Field&&"{}"===s[e].part.exp));if(p&&s[p]&&s[p].part)a={partId:w(e,parseInt(p)),type:f.Char,startOffset:1};else{const p=function(e){return e?Object.keys(e).filter(t=>e[t]&&e[t].part&&!e[t].isReplacing).map(e=>parseInt(e)):[]}(s),l=function(e){return e?Object.keys(e).filter(t=>e[t]&&!e[t].part&&e[t].isReplacing).map(e=>parseInt(e)):[]}(s),c=p.length>0;if(l.length>0){const r=Math.min.apply(null,l)-1,o=n[r];if(t)if(o)a=l.length===Object.keys(s).length?{partId:w(e,r),type:f.Char,startOffset:o.type===i.ExpressionPartType.String||o.type===i.ExpressionPartType.Field?o.exp.length-1:o.exp.length}:se(e,n,s);else{a={partId:w(e,r>-1?r:0),type:f.Part,toStart:!0}}else if(l.length===Object.keys(s).length){const t=!(r>-1);a={partId:w(e,r>-1?r:0),type:f.Part,toStart:t}}else a=se(e,n,s)}else if(c)if(p.length===Object.keys(s).length){const t=Math.max.apply(null,p),n=w(e,t),i=s[t]&&s[t].part;a={partId:n,type:f.Char,startOffset:i&&i.exp&&i.exp.length}}else a=se(e,n,s);else{const i=ne(e,s),p=k(i)?i:parseInt(Object.keys(s)[0]),l=k(p)&&w(e,p);if(t){const t=r&&r.partId,i=l===t,c=r.endOffset-(k(o)?o:0),d=n[T(e,t)],h=d&&d.exp?d.exp.length:-1;a={partId:l,type:f.Char,startOffset:i&&c>=0&&c<=h?c:s[p]&&k(s[p].startOffset)?s[p].startOffset:0}}else a={partId:l,type:f.Char,startOffset:s[p].startOffset}}}return a}function se(e,t,s){const n=ne(e,s),i=k(n),r=i?n:t.length-1,o=i?s[n].startOffset:0;return{partId:w(e,r),type:f.Char,startOffset:o}}function ne(e,t){const s=Object.keys(t).find(e=>t[e].part&&k(t[e].startOffset));return parseInt(s)}function ie(e){let t=function(e){const t=e.split(/([\"])/g).filter(e=>!!e);let s="",n=!1,i=!1;const r=[];return t.forEach((e,o)=>{'"'===e?(s+=e,i=n,n=!0,n&&i&&(r.push(s),s="",n=!1,i=!1)):n?s+=e:r.push(e),o===t.length-1&&n&&!i&&r.push(s)}),r}(e.replace(/\ufeff/g,""));return t=function(e){let t=e.map(e=>W(e)?e:e.split(/({[^\{\}]*})/g).filter(e=>!!e));return t=Array.prototype.concat.apply([],t),t}(t),t=function(e){let t=e.map(e=>W(e)||V(e)?e:e.split(/(\s*[\+\-\*\/\(\)\s]\s*)/g).filter(e=>!!e));return t=Array.prototype.concat.apply([],t),t}(t),t}function re(e,t,s,n,i){const r={};return!e||!k(t)||t<0||e.forEach((e,o)=>{const a=k(s)&&s>-1&&o===s,p=k(i)&&i>-1&&o===i?n:null;r[t+o]={part:e,isReplacing:a,startOffset:p}}),r}function oe(e,t=[]){if(!e)return t;const s=(t=t||[]).slice();let n=0;const i=[];return Object.keys(e).sort((e,t)=>parseInt(e)-parseInt(t)).forEach(t=>{n+=e[t].isReplacing?1:0,e[t].part&&i.push(e[t].part)}),s.splice(Math.min.apply(null,Object.keys(e)),n,...i),s}function ae(e){return!!e&&(e===i.ExpressionPartType.Field||e===i.ExpressionPartType.Function)}function pe(e,t){if(!e||!t)return null;const s=i.DataSourceManager.getInstance().getDataSource(e),n=s&&s.getSchema&&s.getSchema(),r=n&&n.fields;return r&&Object.keys(r).sort((e,t)=>e.localeCompare(t)).find(e=>(r[e].alias||r[e].name)===t)||null}function le(e,t,s,n){return V(e)?{type:i.ExpressionPartType.Field,exp:e,dataSourceId:t,jimuFieldName:n||pe(t,e.replace(/^\{/,"").replace(/\}$/,"")),isFromRepeatedDataSourceContext:!!s}:function(e){return!!e&&Object.keys(i.ExpressionFunctions).some(t=>i.ExpressionFunctions[t]===e)}(e)?{type:i.ExpressionPartType.Function,exp:e,dataSourceId:(r=e,r&&r===i.ExpressionFunctions.Count?t:void 0)}:function(e){return!!e&&(/^\d*\.?\d+(\d|\s)*$/.test(e)||/^\d+\.?\d*(\d|\s)*$/.test(e))}(e)?{type:i.ExpressionPartType.Number,exp:e}:H(e)?{type:i.ExpressionPartType.Operator,exp:e}:W(e)?{type:i.ExpressionPartType.String,exp:e}:{type:i.ExpressionPartType.Unknown,exp:e};var r}function ce(e,t=[],s,n){if(!t||!k(s)||!k(n))return null;const i=t[s-1],r=t[n+1],o={};if(i&&r&&!M(i)&&!M(r)){const e=ie(i.exp+r.exp).map((e,t)=>le(e));for(let t=s-1;t<=n+1;t++)o[t]={part:e[t-(s-1)]||null,isReplacing:!0,startOffset:e[t-(s-1)]?i.exp.length:null}}else for(let e=s;e<=n;e++)o[e]={part:null,isReplacing:!0,startOffset:null};return o}function de(e,t=[],s,n,i){const r=T(e,s),o=t&&t[r];if(!o||!o.exp||!k(n)||!k(i)||n<0||i<0)return null;let a={};const p=o.exp.slice(n,i+1),l=0===n,c=i===o.exp.length-1;let d,h;var u;if(d=(l||c)&&A(p)?o.exp.replace(/^\"/,"").replace(/\"$/,""):l&&$(p)||c&&((u=p)&&"}"===u)?o.exp.replace(/^\{/,"").replace(/\}$/,""):`${o.exp.slice(0,n)}${o.exp.slice(i+1)}`,h=le(d,o.dataSourceId,o.isFromRepeatedDataSourceContext,o.jimuFieldName),h.exp.length>0)if(M(h))a[r]={part:h,isReplacing:!0,startOffset:n+1-(i-n+1)};else{const e=t[r-1],s=t[r+1],n=ie(d.replace(/\"/g,'""').replace(/\{/g,"{}")).map(e=>le(e)),i=M(e),o=M(s);let p,h,u,x;e&&s&&!i&&!o?(h=e.exp+d+s.exp,p=2):e&&!i?(h=e.exp+d,p=1):s&&!o?(h=d+s.exp,p=1):(h=d,p=0),e&&!i?(u=r-1,x=l?e.exp.length:c?n[n.length-1].exp.length:0):(u=r,x=l?0:c?n[n.length-1].exp.length:0);const g=ie(h.replace(/\"/g,'""').replace(/\{/g,"{}")).map(e=>le(e)),m=l?u:c?u+g.length-1:null;for(let e=u;e<=u+g.length+p-1;e++)a[e]={part:g[e-u]||null,isReplacing:e-u<=p,startOffset:e===m?x:null}}else a=ce(0,t,r,r);return a}function he(e,t,s=[],n,r,o){if(!t||!s)return[];let a=[];const p=T(e,t),l=s[p];if(l){if(l.type===i.ExpressionPartType.Field){if(l.dataSourceId){const e=i.DataSourceManager.getInstance().getDataSource(l.dataSourceId),t=e&&e.getSchema&&e.getSchema().fields;t&&Object.keys(t).filter(e=>{const s=t[e].alias||t[e].name;return s&&0===s.toLowerCase().indexOf(l.exp.replace(/[\{\}]/g,"").toLowerCase())}).filter(e=>!s[p-1]||s[p-1].type!==i.ExpressionPartType.Operator||"("!==s[p-1].exp||!s[p-2]||s[p-2].type!==i.ExpressionPartType.Function||t[e].type===i.JimuFieldType.Number).sort((e,s)=>t[e].name.localeCompare(t[s].name)).forEach(e=>{a.push({id:e,content:t[e].alias||t[e].name,type:S.Field})})}else if(n&&n.length>0){const e=p>1&&"("===s[p-1].exp&&s[p-2].type===i.ExpressionPartType.Function;a=ue(B(r,n,o,!e),n)}}else l.type===i.ExpressionPartType.Unknown?(c=i.ExpressionFunctions,Object.keys(c).sort((e,t)=>e.localeCompare(t))).filter(e=>0===i.ExpressionFunctions[e].toLowerCase().indexOf(l.exp.toLowerCase())).forEach(e=>{a.push({id:e,content:i.ExpressionFunctions[e],type:S.Function})}):l.type===i.ExpressionPartType.Function&&l.exp===i.ExpressionFunctions.Count&&n&&(a=ue(B(r,n,o,!1),n));var c;return a}}function ue(e,t){const s=[];return e&&e.asMutable().forEach(e=>{const n=i.DataSourceManager.getInstance().getDataSource(U(e,t).dataSourceId);if(n){let t;t=e.dataViewId&&e.dataViewId!==i.CONSTANTS.OUTPUT_DATA_VIEW_ID?e.dataViewId===i.CONSTANTS.SELECTION_DATA_VIEW_ID?`${n.getMainDataSource().getLabel()} / ${i.i18n.getIntl().formatMessage({id:"selectionDataView"})}`:e.dataViewId===i.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID?`${n.getMainDataSource().getLabel()} / ${i.i18n.getIntl().formatMessage({id:"populatedDataView"})}`:`${n.getMainDataSource().getLabel()} / ${n.getLabel()}`:n.getLabel(),s.push({id:e.dataSourceId,content:t,type:S.DataSource})}}),s}function xe(e,t,s){if(!document||!document.querySelector("#"+e))return null;let n=Y(e);for(;n&&s[T(e,n.id)]&&s[T(e,n.id)].type===i.ExpressionPartType.Operator;)n=n.previousElementSibling;return!t&&n?n.id:function(e){const t=X();if(t&&t.collapsed&&t.startContainer){return D(e,t.startContainer)}return null}(e)}!function(e){e.Fields="FIELDS",e.Functions="FUNCTIONS"}(F||(F={}));class ge extends i.React.PureComponent{constructor(e){var t,s;super(e),this.dsManager=i.DataSourceManager.getInstance(),this.__unmount=!1,this.ExpEditorHelperTabs={[F.Fields]:this.props.intl.formatMessage({id:"fields",defaultMessage:c.defaultMessages.fields}),[F.Functions]:this.props.intl.formatMessage({id:"functions",defaultMessage:c.defaultMessages.functions})},this.getTab=e=>{const t=this.state.FieldSelector;switch(e){case F.Fields:return t&&i.React.createElement(t,{widgetId:this.props.widgetId,useDataSources:this.props.useDataSources,onChange:this.onFieldSelect,useSelectionDataView:!0,usePopulatedDataView:!0,selectedFields:this.getSelectedFields()});case F.Functions:return i.React.createElement(me,{onSelect:this.onFunctionSelect,selectedFunction:this.getSelectedFunction()});default:return null}},this.getSelectedFields=()=>{var e,t;const s=this.getEditingPartIndex(),n=null===(t=null===(e=this.props.expression)||void 0===e?void 0:e.parts)||void 0===t?void 0:t[s];if((null==n?void 0:n.type)===i.ExpressionPartType.Field){const e=n.jimuFieldName;if(e){const t=n.dataSourceId;return t?Object(i.Immutable)({[t]:[e]}):null}}return null},this.getSelectedFunction=()=>{var e,t;const s=this.getEditingPartIndex(),n=null===(t=null===(e=this.props.expression)||void 0===e?void 0:e.parts)||void 0===t?void 0:t[s];return(null==n?void 0:n.type)===i.ExpressionPartType.Function?n.exp:null},this.onFunctionSelect=e=>{if(!e)return;const t={type:i.ExpressionPartType.Function,exp:e};let s;s=this.getIsReplacing()?[t]:[t,{type:i.ExpressionPartType.Operator,exp:"("},{type:i.ExpressionPartType.Operator,exp:")"}],this.changeExpression(s,this.props.expression)},this.onFieldSelect=(e,t,s)=>{const n=e&&e[0];if(!n||!t)return;const r={type:i.ExpressionPartType.Field,exp:`{${n.alias||n.name}}`,dataSourceId:t.id,jimuFieldName:n.jimuName,isFromRepeatedDataSourceContext:s};this.changeExpression([r],this.props.expression)},this.onActiveTabChange=e=>{this.setState({active:e})},this.getSelectionPartId=()=>{var e;let t;if(this.props.inEditablePart){const e=K(this.props.externalId,this.props.container);t=e&&e.partId}else{const e=Y(this.props.externalId);t=e&&e.id}return t=t||(null===(e=this.props.expSelection)||void 0===e?void 0:e.partId),t||(t=w(this.props.externalId,0)),t},this.changeExpression=(e,t)=>{if(!e)return;const s=this.getIsReplacing(),n=this.getNewPartIndex(e,t,s),i=w(this.props.externalId,n);let r=t&&t.parts&&t.parts.slice()||[];if(0===r.length)r=e;else{const t=s?1:0;r.splice(n,t,...e)}this.props.onSelect({name:t&&t.name||this.props.externalId,parts:r},i,s)},this.getNewPartIndex=(e,t,s)=>{if(!e)return null;let n;if(0===(t&&t.parts||[]).length)n=0;else if(s)n=this.getEditingPartIndex();else{const t=this.getSelectionPartId(),s=T(this.props.externalId,t);n=function(e){if(!e)return!1;const t=e[0]&&e[0].type===i.ExpressionPartType.Function,s=e[1]&&e[1].type===i.ExpressionPartType.Operator&&"("===e[1].exp,n=e[e.length-1]&&e[e.length-1].type===i.ExpressionPartType.Operator&&")"===e[e.length-1].exp;return t&&s&&n}(e)?s+1:s+e.length}return n},this.getEditingPartIndex=()=>{if(!this.props.inEditablePart)return null;const e=this.getSelectionPartId();return T(this.props.externalId,e)},this.getIsReplacing=()=>{var e,t;const s=this.getEditingPartIndex(),n=null===(t=null===(e=this.props.expression)||void 0===e?void 0:e.parts)||void 0===t?void 0:t[s];return(null==n?void 0:n.type)===i.ExpressionPartType.Field||(null==n?void 0:n.type)===i.ExpressionPartType.Function};const n=this.getEditingPartIndex(),r=null===(s=null===(t=this.props.expression)||void 0===t?void 0:t.parts)||void 0===s?void 0:s[n];this.state={active:(null==r?void 0:r.type)===i.ExpressionPartType.Function?F.Functions:F.Fields,FieldSelector:null}}componentDidMount(){this.__unmount=!1,i.moduleLoader.loadModule("jimu-ui/advanced/data-source-selector").then(e=>!this.__unmount&&this.setState({FieldSelector:e.FieldSelector}))}componentDidUpdate(e){var t,s;if(e.expSelection!==this.props.expSelection&&this.getIsReplacing()){const e=this.getEditingPartIndex(),n=null===(s=null===(t=this.props.expression)||void 0===t?void 0:t.parts)||void 0===s?void 0:s[e];this.setState({active:(null==n?void 0:n.type)===i.ExpressionPartType.Function?F.Functions:F.Fields})}}componentWillUnmount(){this.__unmount=!0}render(){return this.props.container?i.React.createElement("div",{className:"exp-editor-helper h-100"},i.React.createElement(c.Nav,{fill:!0,pills:!0},Object.keys(F).map((e,t)=>i.React.createElement(c.NavItem,{key:t,style:{width:100/Object.keys(F).length+"%"}},i.React.createElement(c.NavLink,{className:"text-truncate",onClick:()=>{this.onActiveTabChange(F[e])},active:this.state.active===F[e]},this.ExpEditorHelperTabs[F[e]])))),i.React.createElement("div",{className:"exp-editor-helper-tab"},this.getTab(this.state.active))):null}}const me=({onSelect:e,selectedFunction:t})=>i.React.createElement("div",{className:"mt-18 px-3"},Object.keys(i.ExpressionFunctions).map((s,n)=>i.React.createElement("div",{onClick:()=>e(i.ExpressionFunctions[s]),key:n,className:Object(i.classNames)("mt-12 p-1 expression-editor-function-item",{"expression-editor-function-item-selected":t===i.ExpressionFunctions[s]})},i.ExpressionFunctions[s])));class fe extends i.React.PureComponent{constructor(e){super(e),this.expressionString="",this.ltrStyle={direction:"ltr"},this.resizeHelperContainer=()=>{var e,t,s,n;const i=(null===(t=null===(e=this.contentEditableContainer)||void 0===e?void 0:e.current)||void 0===t?void 0:t.offsetHeight)||0,r=(null===(n=null===(s=this.errorMsgContainer)||void 0===s?void 0:s.current)||void 0===n?void 0:n.offsetHeight)||0;this.helperContainer.current.style.height=`calc(100% - 30px - ${i}px - ${r}px)`},this.setSelectionToEnd=()=>{this.setState({isPopoverOpen:!1,expSelection:{partId:this.props.expression&&this.props.expression.parts&&w(this.id,this.props.expression.parts.length-1)||w(this.id,0),type:f.Part,toStart:!1}})},this.getWhetherLoseFocus=()=>{const e=window.getSelection&&window.getSelection();return!(e&&this.contentEditableContainer&&this.contentEditableContainer.current.contains(e.focusNode)&&this.contentEditableContainer.current!==e.focusNode)},this.getExpressionString=e=>{const t=e||this.contentEditableContainer?this.contentEditableContainer.current:document,s=t&&t.querySelector("#"+this.id);return s?s.textContent.replace(/\ufeff/g,""):""},this.getComponent=(e,t)=>{const s=w(this.id,t),n=this.getWhetherInEditablePart();switch(e.type){case i.ExpressionPartType.Field:return Object(i.jsx)(y,{exp:e.exp,id:s,key:t,isDsDisabled:!h(e,this.props.useDataSources),isEditable:n&&this.state.expSelection.partId===s,dataSourceId:e.dataSourceId,isError:!i.expressionUtils.getWhetherFieldInDs(e.dataSourceId,e.jimuFieldName,e.exp.replace(/^\{/,"").replace(/\}$/,""))});case i.ExpressionPartType.String:return Object(i.jsx)(E,{exp:e.exp,id:s,key:t,isEditable:n&&this.state.expSelection.partId===s});case i.ExpressionPartType.Operator:return Object(i.jsx)(C,{exp:e.exp,id:s,key:t,isEditable:n&&this.state.expSelection.partId===s});case i.ExpressionPartType.Function:return Object(i.jsx)(v,{exp:e.exp,id:s,key:t,isDsDisabled:!h(e,this.props.useDataSources),isEditable:n&&this.state.expSelection.partId===s,externalId:this.id,dataSourceIds:this.props.useDataSources.map(e=>e.dataSourceId)});case i.ExpressionPartType.Number:return Object(i.jsx)(I,{exp:e.exp,id:s,key:t,isEditable:n&&this.state.expSelection.partId===s});case i.ExpressionPartType.Unknown:return Object(i.jsx)(O,{exp:e.exp,id:s,key:t,isEditable:n&&this.state.expSelection.partId===s});default:return null}},this.getWhetherInEditablePart=()=>!(!this.state.expSelection||this.state.expSelection.type!==f.Char),this.getSingleExpFromPopoverItem=e=>{switch(e.type){case S.Field:return`{${e.content}}`;default:return e.content}},this.renderPartsToHtml=e=>x.renderToStaticMarkup(Object(i.jsx)("p",{id:this.id,className:"w-100 m-0 p-1",spellCheck:!1,style:{textAlign:"left"}},"\ufeff",e&&e.map((e,t)=>this.getComponent(e,t)),"\ufeff")),this.getNewExpression=e=>({parts:e,name:this.props.expression&&this.props.expression.name||this.id}),this.onChange=e=>{const t=e.currentTarget.querySelector("#"+this.id);if(!t||!e.isTrusted)return;const s=this.getExpressionString(t),n=function(e,t){const s=e.split("");return t.split("").find((e,t)=>e!==s[t])}(this.expressionString,s);if(!n)return;const i=this.getWhetherInEditablePart(),r=this.props.expression&&this.props.expression.parts,o=i?X():null,a=G(this.id),p=function(e,t=[],s,n,i,r,o){let a={};if(!s)return a;t=t||[];const p=o?T(e,o.id):t.length,l=A(s)?'""':$(s)?"{}":s,c=ie(l).map(e=>le(e)),d=c[0]&&1===c[0].exp.length?_(c[0].exp):M(c[0]),h=c[c.length-1]&&1===c[c.length-1].exp.length?_(c[c.length-1].exp):M(c[c.length-1]);if(n){const e=p-1>0?p-1:0,n=t[e],i=M(n),o=r&&r.startOffset,u=r&&r.startContainer,x=!(!o||o!==s.length),g=!(!o||!u||o!==u.textContent.length);if(i)if(x){const s=e-1,n=t[s];if(M(n)||d)a=re(c,e);else{const e=ie(n.exp+l).map(e=>le(e));a=re(e,s,0,e[e.length-1].exp.length,e.length-1)}}else if(g){const e=t[p];if(M(e)||h)a=re(c,p);else{const t=ie(l+e.exp).map(e=>le(e)),s=t[t.length-1].exp.length-e.exp.length>-1?t[t.length-1].exp.length-e.exp.length:t[t.length-1].exp.length;a=re(t,p,t.length-1,s,t.length-1)}}else{const s=t[e],n=u&&u.textContent,i=s&&n&&le(n,s.dataSourceId,s.isFromRepeatedDataSourceContext,s.jimuFieldName);a[e]={part:i,isReplacing:!0,startOffset:r&&r.startOffset}}else if(x)if(h)a=re(c,e);else{const t=ie(l+n.exp).map(e=>le(e)),s=t[t.length-1].exp.length-n.exp.length>-1?t[t.length-1].exp.length-n.exp.length:t[t.length-1].exp.length;a=re(t,e,t.length-1,s,t.length-1)}else if(g)if(d)a=re(c,p);else{const t=ie(n.exp+l).map(e=>le(e));a=re(t,e,0,t[0].exp.length,0)}else{const t=ie((u&&u.textContent).replace(/\"/g,'""').replace(/\{/g,"{}")).map(e=>le(e));a=re(t,e,0,1===t.length?o:t[t.length-1].exp.length,1===t.length?0:t.length-1)}}else{const e=t[p],s=p-1>0?p-1:0,n=t[s],i=M(n),r=M(e);if(i&&r)a=re(c,p);else if(r)if(i)console.warn("One mergeable part can not be next to another mergeable part");else if(d)a=re(c,p);else{const e=ie(n.exp+l).map(e=>le(e));a=re(e,s,0,e[0].exp.length,0)}else if(h)a=re(c,p);else{const t=ie(l+e.exp).map(e=>le(e)),s=t[t.length-1].exp.length-e.exp.length>-1?t[t.length-1].exp.length-e.exp.length:t[t.length-1].exp.length;a=re(t,p,t.length-1,s,t.length-1)}}return a}(this.id,r,n,i,this.props.useDataSources.asMutable().map(e=>e.dataSourceId),o,a),l=oe(p,r),c=i?K(this.id,document&&document.querySelector("#"+this.id)):null,d=te(this.id,i,p,l,c);this.setState({isPopoverOpen:!1,expSelection:d},()=>{this.setState({isPopoverOpen:!0})}),this.props.onChange(this.getNewExpression(l))},this.onClick=e=>{const t=D(this.id,e.target),s=T(this.id,t);if(!k(s)||s<0)return void((e.target===this.contentEditableContainer.current||this.contentEditableContainer.current.contains(e.target))&&this.setSelectionToEnd());const n=s>-1?N(t,this.contentEditableContainer.current):null;if(n&&this.state.expSelection&&(this.state.expSelection.type!==f.Char||T(this.id,this.state.expSelection.partId)!==s)&&this.props.expression&&this.props.expression.parts&&this.props.expression.parts[s]){const e={partId:t,type:f.Char,startOffset:n.textContent.length};this.setState({expSelection:e,isPopoverOpen:!1},()=>this.setState({isPopoverOpen:ae(this.props.expression.parts[s].type)}))}},this.onHelperItemSelect=(e,t,s)=>{if(this.props.onChange(e),e&&e.parts&&t){const n=T(this.id,t),r=e.parts[n];if(!r)return void console.warn("Can not move selection because can not find part: ",t);let o=!1,a={type:f.Char,partId:t,startOffset:r.exp.length};if(r.type===i.ExpressionPartType.Function){const e=L(r.exp),n=r.dataSourceId;s?e&&!n&&(o=!0):(a={type:f.Part,partId:w(this.id,T(this.id,t)+1),toStart:!1},e&&(n?a.partId=w(this.id,T(this.id,t)+2):o=!0))}this.setState({expSelection:a,isPopoverOpen:!1},()=>this.setState({isPopoverOpen:o}))}},this.onBlur=e=>{this.props.onChange(this.props.expression)},this.onKeyDown=e=>{if(e.stopPropagation(),e.nativeEvent.stopImmediatePropagation(),8===e.keyCode||46===e.keyCode||39===e.keyCode||37===e.keyCode||13===e.keyCode||40===e.keyCode||38===e.keyCode)e.preventDefault(),8!==e.keyCode&&46!==e.keyCode||function(e){if(!e)return;const t=new Event("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(t)}(e.currentTarget),8===e.keyCode?this.handleBackspace():46===e.keyCode?this.handleDelete():37===e.keyCode?this.handleLeftArrow():39===e.keyCode?this.handleRightArrow():13===e.keyCode?this.handleEnter():40===e.keyCode?this.handleDownArrow():38===e.keyCode&&this.handleUpArrow();else if(e.keyCode>=48&&e.keyCode<=57||e.keyCode>=65&&e.keyCode<=90){X().collapsed||this.handleBackspace()}},this.handleBackspace=()=>{const e=this.props.expression&&this.props.expression.parts;let t,s;if(this.getWhetherInEditablePart()){const n=K(this.id,this.contentEditableContainer.current);if(n&&n.partId){const i=n.startOffset===n.endOffset?n.startOffset-1:n.startOffset,r=n.endOffset-1;t=de(this.id,e,n.partId,i,r),s=r-i+1}}else{const n=Z(this.id),i=ee(this.id,e);t=ce(this.id,e,n,i),s=0}this.doRemove(t,e,s)},this.handleDelete=()=>{const e=this.props.expression&&this.props.expression.parts;let t,s;if(this.getWhetherInEditablePart()){const n=K(this.id,this.contentEditableContainer.current);if(n&&n.partId){const i=n.startOffset,r=n.startOffset===n.endOffset?n.endOffset:n.endOffset-1;t=de(this.id,e,n.partId,i,r),s=i===r?0:r-i+1}}else{const n=Z(this.id),i=ee(this.id,e),r=X(),o=r.collapsed?k(n)?n+1:0:n,a=r.collapsed?k(n)?n+1:0:i;t=ce(this.id,e,o,a),s=0}this.doRemove(t,e,s)},this.doRemove=(e,t,s)=>{const n=oe(e,t),i=this.getWhetherInEditablePart(),r=i?K(this.id,document&&document.querySelector("#"+this.id)):null,o=e?te(this.id,i,e,n,r,s):this.state.expSelection;this.props.onChange(this.getNewExpression(n)),this.setState({isPopoverOpen:!1,expSelection:o},()=>this.setState({isPopoverOpen:o.partId&&n[T(this.id,o.partId)]&&ae(n[T(this.id,o.partId)].type)}))},this.handleLeftArrow=()=>{if(this.getWhetherInEditablePart()){const e=K(this.id,this.contentEditableContainer.current);if(e&&e.partId){const t=e.startOffset-1>-1?{type:f.Char,partId:e.partId,startOffset:e.startOffset-1}:Q(this.id,e.partId,!0,0,this.props.expression&&this.props.expression.parts);this.setState({expSelection:t,isPopoverOpen:!1})}}else{const e=Y(this.id);e&&this.setState({expSelection:{partId:e.id,toStart:!0,type:f.Part},isPopoverOpen:!1})}},this.handleRightArrow=()=>{if(this.getWhetherInEditablePart()){const e=K(this.id,this.contentEditableContainer.current);if(e&&e.partId){const t=e.startOffset+1<=e.contentLength?{type:f.Char,partId:e.partId,startOffset:e.startOffset+1}:Q(this.id,e.partId,!1,0,this.props.expression&&this.props.expression.parts);this.setState({expSelection:t,isPopoverOpen:!1})}}else{const e=G(this.id);e&&this.setState({expSelection:{partId:e.id,toStart:!1,type:f.Part},isPopoverOpen:!1})}},this.handleDownArrow=()=>{if(this.state.isPopoverOpen){const e=xe(this.id,this.getWhetherInEditablePart(),this.props.expression&&this.props.expression.parts),t=he(this.id,e,this.props.expression&&this.props.expression.parts,this.props.useDataSources,this.props.widgetId,this.props.browserSizeMode);let s=this.state.selectedPopoverItemIndex;s=s?parseInt(s)<t.length-1?""+(parseInt(this.state.selectedPopoverItemIndex)+1):""+(t.length-1):"0",this.setState({selectedPopoverItemIndex:s})}},this.handleUpArrow=()=>{if(this.state.isPopoverOpen){const e=xe(this.id,this.getWhetherInEditablePart(),this.props.expression&&this.props.expression.parts),t=he(this.id,e,this.props.expression&&this.props.expression.parts,this.props.useDataSources,this.props.widgetId,this.props.browserSizeMode);let s=this.state.selectedPopoverItemIndex;s=s?parseInt(s)>0?""+(parseInt(this.state.selectedPopoverItemIndex)-1):"0":""+(t.length-1),this.setState({selectedPopoverItemIndex:s})}},this.handleEnter=()=>{if(this.state.isPopoverOpen&&this.state.selectedPopoverItemIndex){const e=xe(this.id,this.getWhetherInEditablePart(),this.props.expression&&this.props.expression.parts),t=he(this.id,e,this.props.expression&&this.props.expression.parts,this.props.useDataSources,this.props.widgetId,this.props.browserSizeMode);this.setState({selectedPopoverItemIndex:null}),this.handlePopoverItemClick(t[this.state.selectedPopoverItemIndex],e)}else{const e=this.props.expression&&this.props.expression.parts&&this.props.expression.parts.length||0;this.setState({isPopoverOpen:!1,expSelection:{partId:this.state.expSelection&&this.state.expSelection.type===f.Char?this.state.expSelection.partId:w(this.id,e>0?e-1:0),toStart:!1,type:f.Part}})}},this.handlePopoverItemClick=(e,t)=>{if(!e||!t)return;const s=this.props.expression&&this.props.expression.parts?this.props.expression.parts.slice():[];e.type===S.Field?this.handleFieldPopoverClick(s,t,e):e.type===S.DataSource?this.handleDsPopoverClick(s,t,e):e.type===S.Function&&this.handleFunctionPopoverClick(s,t,e)},this.handleFieldPopoverClick=(e=[],t,s)=>{const n=T(this.id,t),i=e[n].dataSourceId,r=le(this.getSingleExpFromPopoverItem(s),i,e[n].isFromRepeatedDataSourceContext,s.id);e.splice(n,1,r);const o={partId:w(this.id,n),toStart:!1,type:f.Part};this.setState({isPopoverOpen:!1,expSelection:o}),this.props.onChange(this.getNewExpression(e))},this.handleDsPopoverClick=(e=[],t,s)=>{const n=T(this.id,t);let r,o=e.slice();if(s.id.split("-").reverse()[0]===i.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID){const e=s.id.split("-").reverse().slice(1).reverse().join("-"),t=U(Object(i.Immutable)({dataSourceId:s.id,mainDataSourceId:e,dataViewId:i.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID}),this.props.useDataSources);o[n].isFromRepeatedDataSourceContext=!0,o[n].dataSourceId=t&&t.dataSourceId}else o[n].dataSourceId=s.id;if(o[n].type===i.ExpressionPartType.Function&&L(o[n].exp)){const e=n+2;r={partId:w(this.id,e),type:f.Part,toStart:!1},(n+2>=o.length||"("!==o[n+1].exp||")"!==o[n+2].exp)&&(o=o.slice(0,n+1).concat([{type:i.ExpressionPartType.Operator,exp:"("},{type:i.ExpressionPartType.Operator,exp:")"}]).concat(o.slice(n+1)))}else r={partId:t,type:f.Char,startOffset:o[n].exp.length};this.props.onChange(this.getNewExpression(o)),this.setState({isPopoverOpen:!1,expSelection:r},()=>this.setState({isPopoverOpen:!(o[n].type===i.ExpressionPartType.Function&&o[n].exp===i.ExpressionFunctions.Count)}))},this.handleFunctionPopoverClick=(e=[],t,s)=>{const n=T(this.id,t),r=le(this.getSingleExpFromPopoverItem(s)),o={partId:w(this.id,n+1),type:f.Part,toStart:!1};e.splice(n,1,r,{type:i.ExpressionPartType.Operator,exp:"("},{type:i.ExpressionPartType.Operator,exp:")"}),this.props.onChange(this.getNewExpression(e)),this.setState({isPopoverOpen:L(r.exp),expSelection:o})},fe.count++,this.id="expression-"+fe.count,this.contentEditableContainer=i.React.createRef(),this.helperContainer=i.React.createRef(),this.state={isPopoverOpen:!1,isEditorMounted:!1,expSelection:null,selectedPopoverItemIndex:null}}componentDidMount(){this.resizeObserver=new i.ResizeObserver(this.resizeHelperContainer),this.resizeObserver.observe(this.contentEditableContainer.current),this.expressionString=this.getExpressionString()||"",this.props.autoFocus&&(this.props.expression&&this.props.expression.parts&&1===this.props.expression.parts.length&&this.props.expression.parts[0].type===i.ExpressionPartType.String?this.setState({expSelection:{partId:w(this.id,0),type:f.Char,startOffset:this.props.expression.parts[0].exp.length-1}}):(this.contentEditableContainer.current.focus(),this.setSelectionToEnd())),this.setState({isEditorMounted:!0}),this.contentEditableContainer.current.ondragstart=()=>!1,this.contentEditableContainer.current.onpaste=()=>!1}componentDidUpdate(e,t){this.state.expSelection&&this.state.expSelection.partId&&(t.expSelection!==this.state.expSelection||this.props.autoFocus&&this.getWhetherLoseFocus())&&(this.state.expSelection.type===f.Part?function(e,t,s){const n=N(e,s);if(n){if(window.getSelection&&document&&document.createRange){const e=document.createRange();n&&(e.selectNode(n),e.collapse(t),window.getSelection().removeAllRanges(),window.getSelection().addRange(e))}}else s&&s.focus()}(this.state.expSelection.partId,this.state.expSelection.toStart,this.contentEditableContainer.current):this.state.expSelection.type===f.Char&&q(this.state.expSelection.partId,this.state.expSelection.startOffset,this.contentEditableContainer.current)),e.expression!==this.props.expression&&(this.props.expression&&this.props.expression.parts?this.expressionString=this.getExpressionString():this.expressionString="")}componentWillUnmount(){this.resizeObserver.disconnect()}render(){var e;let t;this.state.isPopoverOpen&&(t=xe(this.id,this.getWhetherInEditablePart(),this.props.expression&&this.props.expression.parts));let s=this.renderPartsToHtml(this.props.expression&&this.props.expression.parts);s=s&&s.replace(/&quot;/g,'"');const n=i.expressionUtils.getWhetherExpressionValid(this.props.expression);return Object(i.jsx)(i.MultipleDataSourceComponent,{useDataSources:this.props.useDataSources},Object(i.jsx)("div",{style:this.props.style,onClick:this.onClick,className:Object(i.classNames)("w-100 h-100",{[this.props.className]:!!this.props.className})},Object(i.jsx)("div",{className:"w-100 h-100 component-expression-editor"},Object(i.jsx)("div",{className:Object(i.classNames)("w-100 expression-editor-input",{"error-border":!n})},Object(i.jsx)(m.a,{innerRef:this.contentEditableContainer,html:s,disabled:!(!this.state.expSelection||this.state.expSelection.type!==f.Char),onChange:this.onChange,onKeyDown:this.onKeyDown,onBlur:this.onBlur,className:"w-100 break-all expression-editor-input-content-editable",style:this.ltrStyle}),Object(i.jsx)(j,{targetNodeId:t,containerNode:null===(e=this.contentEditableContainer)||void 0===e?void 0:e.current,expSelection:this.state.expSelection,items:he(this.id,t,this.props.expression&&this.props.expression.parts,this.props.useDataSources,this.props.widgetId,this.props.browserSizeMode),isOpen:this.state.isPopoverOpen,onClick:this.handlePopoverItemClick,theme:this.props.theme,selectedItemIndex:this.state.selectedPopoverItemIndex})),!n&&Object(i.jsx)("div",{className:"mt-3 error-message",ref:this.errorMsgContainer},this.props.intl.formatMessage({id:"invalidExpression",defaultMessage:c.defaultMessages.invalidExpression})),Object(i.jsx)("div",{className:"expression-editor-helper mt-3",ref:this.helperContainer},Object(i.jsx)(ge,{expression:this.props.expression,useDataSources:this.props.useDataSources,onSelect:this.onHelperItemSelect,intl:this.props.intl,externalId:this.id,inEditablePart:this.getWhetherInEditablePart(),container:this.state.isEditorMounted?this.contentEditableContainer.current:null,expSelection:this.state.expSelection,widgetId:this.props.widgetId})))))}}fe.count=-1;const Se=i.ReactRedux.connect((e,t)=>{var s,n;return{browserSizeMode:(null===(s=null==e?void 0:e.appContext)||void 0===s?void 0:s.isBuilder)?null===(n=null==e?void 0:e.appStateInBuilder)||void 0===n?void 0:n.browserSizeMode:null==e?void 0:e.browserSizeMode}})(fe);var be=Object(i.injectIntl)(i.themeUtils.withTheme(i.themeUtils.withStyles(Se,"ExpressionEditor")));class ye extends i.React.PureComponent{constructor(e){super(e),this.__unmount=!1,this.getSelectedFields=()=>{if(!this.props.expression||!this.props.useDataSources)return null;const e=this.props.expression.parts&&this.props.expression.parts[0],t=e&&h(e,this.props.useDataSources)&&e.type===i.ExpressionPartType.Field?e.jimuFieldName:null;if(t){const s=e.dataSourceId;return{fields:s?Object(i.Immutable)({[s]:[t]}):null,isSelectedFromRepeatedDataSourceContext:e.isFromRepeatedDataSourceContext}}return null},this.onSelectedFieldsChange=(e,t,s)=>{const n=e&&e[0];if(!n||!t)return;const r={type:i.ExpressionPartType.Field,exp:`{${n.alias||n.name}}`,dataSourceId:t.id,jimuFieldName:n.jimuName,isFromRepeatedDataSourceContext:!!s};this.props.onChange({name:r.exp,parts:[r]})},this.state={FieldSelector:null}}componentDidMount(){this.__unmount=!1,i.moduleLoader.loadModule("jimu-ui/advanced/data-source-selector").then(e=>!this.__unmount&&this.setState({FieldSelector:e.FieldSelector}))}componentWillUnmount(){this.__unmount=!0}render(){const e=this.state.FieldSelector,t=this.getSelectedFields();return i.React.createElement("div",{className:"expression-builder-tab attribute-tab common-tab p-0"},i.React.createElement("div",{className:"field-selector-container"},e&&i.React.createElement(e,{types:this.props.types,useDataSources:this.props.useDataSources,widgetId:this.props.widgetId,onChange:this.onSelectedFieldsChange,selectedFields:null==t?void 0:t.fields,isSelectedFromRepeatedDataSourceContext:null==t?void 0:t.isSelectedFromRepeatedDataSourceContext,useSelectionDataView:!0,usePopulatedDataView:!0})))}}class Ee extends i.React.PureComponent{constructor(e){super(e),this.getMutableExpression=e=>this.props.expression&&this.props.expression.asMutable?this.props.expression.asMutable({deep:!0}):this.props.expression,this.onExpChange=e=>{this.setState({expression:e})},this.onChange=()=>{this.props.onChange({name:this.state.name||this.getDefaultName(),parts:this.state.expression&&this.state.expression.parts})},this.onNameChange=e=>{this.setState({name:e.target.value})},this.getDefaultName=()=>`${this.props.intl.formatMessage({id:"expression",defaultMessage:c.defaultMessages.expression})} ${Ee.count}`,this.getWhetherDisableInsert=()=>!this.state.expression||!this.state.expression.parts||0===this.state.expression.parts.length||!i.expressionUtils.getWhetherExpressionValid(this.state.expression),Ee.count++,this.state={expression:this.getMutableExpression(this.props.expression),name:this.props.expression&&this.props.expression.name||this.getDefaultName()}}componentDidUpdate(e){e.expression!==this.props.expression&&this.setState({expression:this.getMutableExpression(this.props.expression)})}render(){return i.React.createElement("div",{className:"expression-builder-tab expression-tab px-3"},i.React.createElement("div",{className:"mb-3"},i.React.createElement("div",{className:"d-flex justify-content-between"},i.React.createElement(c.TextInput,{className:"flex-grow-1",value:this.state.name,onChange:this.onNameChange,id:"expression-name-input",size:"sm"}),i.React.createElement(c.Button,{onClick:this.onChange,type:"primary",disabled:this.getWhetherDisableInsert(),className:"expression-insert-btn ml-2",size:"sm"},i.React.createElement("div",{className:"text-truncate"},this.props.intl.formatMessage({id:"insert",defaultMessage:c.defaultMessages.insert}))))),i.React.createElement("div",{className:"expression-editor-container"},i.React.createElement(be,Object.assign({},this.props,{expression:this.state.expression,onChange:this.onExpChange,autoFocus:!0}))))}}Ee.count=0;class ve extends i.React.PureComponent{constructor(e){super(e),this.dsManager=i.DataSourceManager.getInstance(),this.__unmount=!1,this.getWhetherExpressionIsFuncAndHasOnePart=e=>!!e&&!(1!==e.length||!e[0]||e[0].type!==i.ExpressionPartType.Function),this.hasNoParamAndDsEnabled=e=>!!e&&((!e.parts||0===e.parts.length)&&h(e,this.props.useDataSources)),this.hasOneParamAndDsEnabled=e=>!!e&&(e.parts&&1===e.parts.length&&h(e.parts[0],this.props.useDataSources)),this.getWhetherUseSelectedDs=e=>!this.state||!this.state.selectedDsId||e.dataSourceId===this.state.selectedDsId,this.getDefaultDsId=()=>{const e=this.props.expression&&this.props.expression.parts,t=Object(i.groupExpressionPartsByFunction)(e);if(this.getWhetherExpressionIsFuncAndHasOnePart(t)){const e=t[0];if(this.hasNoParamAndDsEnabled(e))return e.dataSourceId;if(this.hasOneParamAndDsEnabled(e))return e.parts[0].dataSourceId}return null},this.getDefaultFunc=()=>{const e=this.props.expression&&this.props.expression.parts,t=Object(i.groupExpressionPartsByFunction)(e);if(this.getWhetherExpressionIsFuncAndHasOnePart(t)){return t[0].exp||i.ExpressionFunctions.Average}return i.ExpressionFunctions.Average},this.getDefaultJimuName=e=>{const t=this.props.expression&&this.props.expression.parts,s=Object(i.groupExpressionPartsByFunction)(t),n=s[0];return this.getWhetherExpressionIsFuncAndHasOnePart(s)&&this.hasOneParamAndDsEnabled(n)&&this.getWhetherUseSelectedDs(n.parts[0])&&n.parts[0].jimuFieldName||e&&Object.keys(e)[0]},this.getDataSourceId=()=>this.state.selectedDsId,this.getSelectedFieldName=(e,t)=>e?t&&e[t]&&(e[t].alias||e[t].name):"",this.getSelectedJimuFieldName=()=>this.state.selectedJimuFieldName,this.getSelectedFunction=()=>this.state.selectedFunction,this.getNumberFields=e=>{if(!e)return{};const t=this.dsManager&&this.dsManager.getDataSource(e),s=t&&t.getSchema(),n=s&&s.fields;if(!n)return{};const r={};return Object.keys(n).forEach(e=>{n[e].type===i.JimuFieldType.Number&&(r[e]=n[e])}),r},this.getDsLabel=e=>{const t=this.dsManager&&this.dsManager.getDataSource(e);return t?t.getLabel()||t.id:e},this.getSelectedUseDataSource=()=>{var e;const t=i.DataSourceManager.getInstance().getDataSource(this.state.selectedDsId);return this.state.selectedDsId&&t?Object(i.Immutable)({dataSourceId:t.id,mainDataSourceId:t.getMainDataSource().id,dataViewId:t.dataViewId,rootDataSourceId:null===(e=t.getRootDataSource())||void 0===e?void 0:e.id}):null},this.onFieldChange=e=>{const t=e.currentTarget.value;this.setState({selectedJimuFieldName:t})},this.onFunctionChange=e=>{const t=e.currentTarget.value;this.setState({selectedFunction:t})},this.onChange=()=>{const e=this.getNumberFields(this.state.selectedDsId),t=this.getSelectedFieldName(e,this.state.selectedJimuFieldName),s=this.state.selectedFunction===i.ExpressionFunctions.Count?this.state.selectedFunction+"()":`${this.state.selectedFunction}({${t}})`;let n=[{type:i.ExpressionPartType.Function,exp:this.state.selectedFunction}];this.state.selectedFunction===i.ExpressionFunctions.Count?(n[0].dataSourceId=this.state.selectedDsId,n=n.concat([{type:i.ExpressionPartType.Operator,exp:"("},{type:i.ExpressionPartType.Operator,exp:")"}])):n=n.concat([{type:i.ExpressionPartType.Operator,exp:"("},{type:i.ExpressionPartType.Field,exp:`{${t}}`,dataSourceId:this.state.selectedDsId,jimuFieldName:this.state.selectedJimuFieldName},{type:i.ExpressionPartType.Operator,exp:")"}]),this.props.onChange({name:s,parts:n})},this.onSelectedUseDsChange=e=>this.setState({selectedDsId:null==e?void 0:e.dataSourceId});const t=this.getDefaultDsId(),s=this.getNumberFields(t),n=this.getDefaultJimuName(s),r=this.getDefaultFunc();this.state={selectedDsId:t,selectedJimuFieldName:n,selectedFunction:r,MainDataAndViewSelector:null,DataViewPriority:null}}componentDidMount(){this.__unmount=!1,i.moduleLoader.loadModule("jimu-ui/advanced/data-source-selector").then(e=>!this.__unmount&&this.setState({MainDataAndViewSelector:e.MainDataAndViewSelector,DataViewPriority:e.DataViewPriority}))}componentDidUpdate(e,t){if(e.expression!==this.props.expression||e.useDataSources!==this.props.useDataSources){const e=this.getDefaultDsId(),t=this.getNumberFields(e),s=this.getDefaultJimuName(t),n=this.getDefaultFunc();this.setState({selectedDsId:e,selectedJimuFieldName:s,selectedFunction:n})}if(t.selectedDsId!==this.state.selectedDsId){const e=this.getNumberFields(this.state.selectedDsId),t=this.getDefaultJimuName(e);this.setState({selectedJimuFieldName:t})}}componentWillUnmount(){this.__unmount=!0}render(){const e=this.getNumberFields(this.state.selectedDsId),t=this.state.MainDataAndViewSelector,s=this.state.DataViewPriority;return i.React.createElement("div",{className:"expression-builder-tab statistics-tab common-tab"},t&&i.React.createElement(t,{useDataSources:this.props.useDataSources,onChange:this.onSelectedUseDsChange,useSelectionDataView:!0,className:"p-3",selectedUseDataSource:this.getSelectedUseDataSource(),defaultDataViewPriority:s.Second}),i.React.createElement("div",{className:"data-option mb-12"},i.React.createElement("div",{className:"w-100 text-truncate mb-12 option-label"},this.props.intl.formatMessage({id:"operator",defaultMessage:c.defaultMessages.operator})),i.React.createElement("div",{className:"flex-grow-1"},i.React.createElement(c.Select,{value:this.getSelectedFunction(),className:"select-max-width text-truncate",size:"sm",onChange:this.onFunctionChange},Object.keys(i.ExpressionFunctions).map((e,t)=>i.React.createElement("option",{value:i.ExpressionFunctions[e],key:t,className:"select-max-width text-truncate"},i.ExpressionFunctions[e]))))),this.state.selectedFunction&&this.state.selectedFunction!==i.ExpressionFunctions.Count&&i.React.createElement("div",{className:"data-option mb-12"},i.React.createElement("div",{className:"w-100 text-truncate mb-12 option-label"},this.props.intl.formatMessage({id:"field",defaultMessage:c.defaultMessages.field})),i.React.createElement("div",{className:"flex-grow-1"},i.React.createElement(c.Select,{value:this.getSelectedJimuFieldName(),size:"sm",onChange:this.onFieldChange,className:"select-max-width text-truncate"},e&&Object.keys(e).map((t,s)=>i.React.createElement("option",{value:e[t].jimuName,key:s,className:"select-max-width text-truncate"},e[t].alias||e[t].name))))),i.React.createElement("div",{className:"data-option mt-2 float-right expression-insert-btn"},i.React.createElement(c.Button,{onClick:this.onChange,type:"primary"},i.React.createElement("div",{className:"text-truncate"},this.props.intl.formatMessage({id:"insert",defaultMessage:c.defaultMessages.insert})))))}}class Ie extends i.React.PureComponent{constructor(e){super(e),this.expressionFrom={[p.Attribute]:this.props.intl.formatMessage({id:"attribute",defaultMessage:c.defaultMessages.attribute}),[p.Statistics]:this.props.intl.formatMessage({id:"statistics",defaultMessage:c.defaultMessages.statistics}),[p.Expression]:this.props.intl.formatMessage({id:"expression",defaultMessage:c.defaultMessages.expression})},this.onChange=e=>{this.props.onChange&&this.props.onChange(e)},this.getActiveExpressionFrom=()=>{if(!this.props.expression||!this.props.expression.parts||0===this.props.expression.parts.length)return this.props.types[0];const e=Object(i.groupExpressionPartsByFunction)(this.props.expression.parts);return 1===e.length&&e[0].type===i.ExpressionPartType.Field?this.props.types.some(e=>e===p.Attribute)?p.Attribute:this.props.types.some(e=>e===p.Expression)?p.Expression:this.props.types[0]:1===e.length&&e[0].type===i.ExpressionPartType.Function&&this.props.types.some(e=>e===p.Statistics)?p.Statistics:this.props.types.some(e=>e===p.Expression)?p.Expression:this.props.types[0]},this.getTab=(e,t,s)=>{switch(e){case p.Attribute:return Object(i.jsx)(ye,{types:this.props.fieldTypes,useDataSources:t,expression:s,onChange:this.onChange,intl:this.props.intl,widgetId:this.props.widgetId});case p.Statistics:return Object(i.jsx)(ve,{useDataSources:t,expression:s,onChange:this.onChange,intl:this.props.intl,widgetId:this.props.widgetId});case p.Expression:return Object(i.jsx)(Ee,Object.assign({},this.props,{useDataSources:t,expression:s,onChange:this.onChange,intl:this.props.intl}));default:return null}},this.onActiveTabChange=e=>{this.setState({active:e})},this.state={active:this.getActiveExpressionFrom()}}componentDidUpdate(e,t){this.props.types===e.types&&this.props.expression===e.expression||this.setState({active:this.getActiveExpressionFrom()})}render(){return Object(i.jsx)(i.MultipleDataSourceComponent,{useDataSources:this.props.useDataSources},Object(i.jsx)("div",{style:this.props.style,className:Object(i.classNames)("w-100 h-100",{[this.props.className]:!!this.props.className})},Object(i.jsx)("div",{className:"w-100 h-100 component-expression-builder"},this.props.types&&this.props.types.length>1?Object(i.jsx)(c.Nav,{fill:!0,underline:!0},this.props.types.map((e,t)=>Object(i.jsx)(c.NavItem,{key:t,className:"w-33"},Object(i.jsx)(c.NavLink,{className:"text-truncate",title:this.expressionFrom[e],onClick:()=>{this.onActiveTabChange(e)},active:this.state.active===e},this.expressionFrom[e])))):null,Object(i.jsx)("div",{className:Object(i.classNames)("h-100",{"has-nav":this.props.types&&this.props.types.length>1})},this.getTab(this.state.active,this.props.useDataSources,this.props.expression)))))}}var Oe=Object(i.injectIntl)(i.themeUtils.withStyles(Ie,"ExpressionBuilder"));const Ce=s(78);class je extends i.React.PureComponent{constructor(e){var t,s,n,i;super(e),this.cursorStyle={cursor:"pointer"},this.fontSizeStyle={fontSize:"16px",fontWeight:500,color:null===(i=null===(n=null===(s=null===(t=null==this?void 0:this.props)||void 0===t?void 0:t.theme)||void 0===s?void 0:s.colors)||void 0===n?void 0:n.palette)||void 0===i?void 0:i.dark[600]},this.titleStyle={height:"51px",borderBottom:"0"},this.overflowYStyle={overflow:"hidden",height:"calc(100% - 51px)"},this.__unmount=!1,this.state={SidePopper:null}}componentDidMount(){this.__unmount=!1,i.moduleLoader.loadModule("jimu-ui/advanced/setting-components").then(e=>!this.__unmount&&this.setState({SidePopper:e.SidePopper}))}componentWillUnmount(){this.__unmount=!0}render(){const e=this.state.SidePopper,t=this.props.types,s=t?t.length>1?this.props.intl.formatMessage({id:"dynamicContent",defaultMessage:c.defaultMessages.dynamicContent}):u(t[0],this.props.intl):"";return Object(i.jsx)("div",{className:"w-100 h-100"},e&&Object(i.jsx)(e,{isOpen:this.props.isOpen&&!i.urlUtils.getAppIdPageIdFromUrl().pageId,position:"right",toggle:this.props.onClose,trigger:this.props.trigger},Object(i.jsx)("div",{className:"h-100 bg-light-300 border-color-gray-400 component-expression-builder-popup"},Object(i.jsx)("div",{className:"w-100 h-100 expression-popup"},Object(i.jsx)("div",{className:"jimu-widget-setting--header d-flex",style:this.titleStyle},Object(i.jsx)("div",{className:"m-0 text-truncate flex-grow-1 d-flex align-items-center",style:this.fontSizeStyle,title:s},s),Object(i.jsx)(c.Button,{size:"sm",icon:!0,type:"tertiary",className:"flex-shrink-0 text-center px-2 pt-1",style:this.cursorStyle,onClick:()=>this.props.onClose()},Object(i.jsx)(c.Icon,{icon:Ce,size:"16"}))),Object(i.jsx)("div",{style:this.overflowYStyle},Object(i.jsx)(Oe,Object.assign({},this.props)))))))}}var Fe=Object(i.injectIntl)(i.themeUtils.withTheme(je));const Pe=s(279),Ne=s(280),De=s(281),we=s(282);class Te extends i.React.PureComponent{constructor(e){super(e),this.expBuilderTrigger=i.React.createRef(),this.toggleDropdown=()=>this.setState({isDropdownOpen:!this.state.isDropdownOpen}),this.getExpFromIcon=e=>{switch(e){case d.Static:return Pe;case d.Attribute:return we;case d.Statistics:return Ne;case d.Expression:return De;default:return null}},this.getSelectedExpFromExpression=()=>{if(!this.props.expression||!this.props.expression.parts||0===this.props.expression.parts.length)return this.props.types.some(e=>e===d.Static)?d.Static:this.props.types.some(e=>e===d.Attribute)?d.Attribute:this.props.types.some(e=>e===d.Statistics)?d.Statistics:this.props.types.some(e=>e===d.Expression)?d.Expression:null;const e=Object(i.groupExpressionPartsByFunction)(this.props.expression.parts);return 1===e.length&&e[0].type===i.ExpressionPartType.Field?this.props.types.some(e=>e===d.Attribute)?d.Attribute:this.props.types.some(e=>e===d.Expression)?d.Expression:null:1===e.length&&e[0].type===i.ExpressionPartType.Function?this.props.types.some(e=>e===d.Statistics)?d.Statistics:this.props.types.some(e=>e===d.Expression)?d.Expression:null:1===e.length&&e[0].type===i.ExpressionPartType.String&&this.props.types.some(e=>e===d.Static)?d.Static:this.props.types.some(e=>e===d.Expression)?d.Expression:null},this.getWhetherFromExpBuilder=e=>e&&Object.keys(p).some(t=>p[t]===e),this.getExpressionFrom=()=>this.getWhetherFromExpBuilder(this.state.selectedExpFrom)?Object(i.Immutable)([this.state.selectedExpFrom]):Object(i.Immutable)([]),this.getStringFromExpression=()=>this.props.expression&&1===this.props.expression.parts.length&&this.props.expression.parts[0].type===i.ExpressionPartType.String?this.props.expression.parts[0].exp.replace(/^"/,"").replace(/"$/,""):"",this.onInputBlur=e=>{const t=e.target.value,s={name:t,parts:[{type:i.ExpressionPartType.String,exp:`"${t}"`}]};this.props.onChange&&this.props.onChange(s)},this.onInputChange=e=>{this.setState({inputValue:e.target.value})},this.onExpChange=e=>{this.props.onChange&&this.props.onChange(e)},this.onExpFromChange=e=>{e!==this.state.selectedExpFrom?(this.onExpChange({name:"",parts:[]}),this.setState({selectedExpFrom:e})):this.toggleExpPopup()},this.getWhetherExpDssMatchInUseDss=e=>{const t=e&&e.parts;return!!t&&t.every(e=>h(e,this.props.useDataSources))},this.toggleExpPopup=()=>{this.getWhetherFromExpBuilder(this.state.selectedExpFrom)?this.props.isExpPopupOpen?this.props.closeExpPopup():this.props.openExpPopup():this.props.closeExpPopup()},this.state={selectedExpFrom:this.getSelectedExpFromExpression(),isDropdownOpen:!1,inputValue:this.getStringFromExpression()}}componentDidUpdate(e,t){t.selectedExpFrom!==this.state.selectedExpFrom&&this.toggleExpPopup()}render(){var e,t,s,n,r;const o=this.getWhetherFromExpBuilder(this.state.selectedExpFrom),a=o?this.props.expression&&this.props.expression.name||"":(null===(n=null===(s=null===(t=null===(e=this.props.expression)||void 0===e?void 0:e.parts)||void 0===t?void 0:t[0])||void 0===s?void 0:s.exp)||void 0===n?void 0:n.replace(/^"/,"").replace(/"$/,""))||"",p=i.expressionUtils.getWhetherExpressionValid(this.props.expression),l=this.getWhetherExpDssMatchInUseDss(this.props.expression),d=!p||!l,{placeHolders:h={},autoHide:x}=this.props,{selectedExpFrom:g}=this.state;return Object(i.jsx)("div",{style:this.props.style,className:Object(i.classNames)("w-100 h-100",{[this.props.className]:!!this.props.className})},Object(i.jsx)("div",{className:"d-flex justify-content-start align-items-center component-expression-input"},!(x&&(this.props.types||[]).length<=1)&&Object(i.jsx)("div",{className:"expression-builder-trigger",ref:this.expBuilderTrigger},Object(i.jsx)(c.Dropdown,{isOpen:this.state.isDropdownOpen,toggle:this.toggleDropdown,className:"w-100 h-100 expression-builder-trigger-dropdown"},Object(i.jsx)(c.DropdownButton,{arrow:!1,title:u(this.state.selectedExpFrom,this.props.intl),className:"text-truncate d-flex justify-content-center align-items-center trigger-dropdown-toggle p-0"},g&&Object(i.jsx)(c.Icon,{icon:this.getExpFromIcon(g),className:"m-0 p-0"})),Object(i.jsx)(c.DropdownMenu,{appendToBody:!1,strategy:"fixed"},this.props.types.map((e,t)=>Object(i.jsx)(c.DropdownItem,{onClick:t=>this.onExpFromChange(e),key:t,className:"text-dark"},Object(i.jsx)(c.Icon,{icon:this.getExpFromIcon(e),className:"mr-2"}),Object(i.jsx)("span",null,u(e,this.props.intl))))))),Object(i.jsx)("div",{className:"flex-grow-1 expression-input"},d&&o?a?Object(i.jsx)("div",{className:"w-100 h-100 text-truncate ds-disabled d-flex align-items-center",onClick:this.toggleExpPopup},Object(i.jsx)("span",{className:"error-wrapper",title:a},a)):Object(i.jsx)("div",{className:"w-100 h-100 text-truncate ds-disabled ds-placeholder d-flex align-items-center",onClick:this.toggleExpPopup},Object(i.jsx)("span",{className:"error-wrapper",title:h[g]},h[g])):Object(i.jsx)("div",{className:"w-100 h-100",onClick:o?this.toggleExpPopup:void 0},Object(i.jsx)("div",{className:"w-100 h-100"},Object(i.jsx)(c.TextInput,{className:Object(i.classNames)("w-100 h-100",{"ds-disabled":o}),value:a,disabled:o,onChange:this.onInputChange,onBlur:this.onInputBlur,title:a,placeholder:h[g]}),o&&Object(i.jsx)("div",{className:"ds-disabled disabled-input-cover"}))))),this.props.isExpPopupOpen?Object(i.jsx)(Fe,Object.assign({},this.props,{onChange:this.onExpChange,types:this.getExpressionFrom(),isOpen:this.props.isExpPopupOpen,onClose:this.props.closeExpPopup,trigger:null===(r=this.expBuilderTrigger)||void 0===r?void 0:r.current})):null)}}var Re=Object(i.injectIntl)(i.themeUtils.withStyles(Te,"ExpressionInput"));i.ThemeManager.getInstance().registerJimuThemeStyleModule("jimu-ui/advanced/expression-builder/",{componentStyles:n})}}))}}}));
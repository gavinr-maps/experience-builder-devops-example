System.register(["jimu-core","jimu-theme"],(function(e,t){var i={},r={};return{setters:[function(e){i.AppMode=e.AppMode,i.DataRecordsSelectionChangeMessage=e.DataRecordsSelectionChangeMessage,i.DataSourceManager=e.DataSourceManager,i.DataSourceStatus=e.DataSourceStatus,i.ExternalResolvablePromise=e.ExternalResolvablePromise,i.Immutable=e.Immutable,i.JimuMapViewStatus=e.JimuMapViewStatus,i.LocationChangeMessage=e.LocationChangeMessage,i.MessageManager=e.MessageManager,i.MutableStoreManager=e.MutableStoreManager,i.React=e.React,i.ReactRedux=e.ReactRedux,i.ServiceManager=e.ServiceManager,i.SessionChangedReasonType=e.SessionChangedReasonType,i.SessionManager=e.SessionManager,i.SupportedLayerServiceTypes=e.SupportedLayerServiceTypes,i.WidgetState=e.WidgetState,i.appActions=e.appActions,i.appConfigUtils=e.appConfigUtils,i.dataSourceUtils=e.dataSourceUtils,i.defaultMessages=e.defaultMessages,i.geometryUtils=e.geometryUtils,i.getAppStore=e.getAppStore,i.i18n=e.i18n,i.jimuHistory=e.jimuHistory,i.loadArcGISJSAPIModule=e.loadArcGISJSAPIModule,i.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules,i.lodash=e.lodash,i.moduleLoader=e.moduleLoader,i.observeStore=e.observeStore,i.portalUrlUtils=e.portalUrlUtils,i.requestUtils=e.requestUtils,i.urlUtils=e.urlUtils,i.utils=e.utils},function(e){r.ThemeStore=e.ThemeStore,r.getTheme=e.getTheme}],execute:function(){e((()=>{"use strict";var e={891:e=>{e.exports=i},796:e=>{e.exports=r}},t={};function s(i){var r=t[i];if(void 0!==r)return r.exports;var a=t[i]={exports:{}};return e[i](a,a.exports,s),a.exports}s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var a={};return(()=>{s.r(a),s.d(a,{ADD_TO_MAP_DATA_ID_PREFIX:()=>ye,ActionType:()=>le,ArcGISDataSourceFactoryUriExtension:()=>We,ArcGISDataSourceTypes:()=>n,ArcGISDependencyDefineExtension:()=>Te,DataChangeStatus:()=>ce,DataChangeType:()=>ue,DataSourceTypes:()=>n,JimuFeatureLayerView:()=>ee,JimuLayerView:()=>z,JimuLayerViewComponent:()=>ke,JimuMapView:()=>pe,JimuMapViewComponent:()=>Ge,JimuMapViewGroup:()=>ge,JimuSceneLayerView:()=>te,LayerTypes:()=>o,MapViewManager:()=>me,SHOW_ON_MAP_DATA_ID_PREFIX:()=>he,SelectionMode:()=>X,basemapUtils:()=>r,defaultMessages:()=>_,featureUtils:()=>i,geometryUtils:()=>l.geometryUtils,init:()=>He,loadArcGISJSAPIModules:()=>c,portalUtils:()=>t,zoomToUtils:()=>e});var e={};s.r(e),s.d(e,{getExtentFromScale:()=>p,layerExtent:()=>A,projectToSpatialReference:()=>J,zoomTo:()=>y});var t={};s.r(t),s.d(t,{checkDefaultBaseMapIsExist:()=>W,getDefaultWebMap:()=>E,getDefaultWebMapWithoutCache:()=>R,getItemQueryStringByTypes:()=>B});var i={};s.r(i),s.d(i,{convertDataRecordSetToFeatureSet:()=>G,getDefaultSymbol:()=>k});var r={};s.r(r),s.d(r,{getBasemapGroup:()=>q,getBasemapItemsByGroupId:()=>N,getOrgBasemaps:()=>H});var n,o,l=s(891),u=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};function c(e){return u(this,void 0,void 0,(function*(){return yield(0,l.loadArcGISJSAPIModules)(e)}))}!function(e){e.Map="MAP",e.WebMap="WEB_MAP",e.WebScene="WEB_SCENE"}(n||(n={})),function(e){e.BaseDynamicLayer="base-dynamic",e.BaseElevationLayer="base-elevation",e.BaseTileLayer="base-tile",e.BuildingSceneLayer="building-scene",e.CSVLayer="csv",e.ElevationLayer="elevation",e.FeatureLayer="feature",e.GeoJSONLayer="geojson",e.GeoRSSLayer="geo-rss",e.GraphicsLayer="graphics",e.GroupLayer="group",e.SubtypeGroupLayer="subtype-group",e.ImageryLayer="imagery",e.IntegratedMeshLayer="integrated-mesh",e.KMLLayer="kml",e.MapImageLayer="map-image",e.MapNotesLayer="map-notes",e.PointCloudLayer="point-cloud",e.SceneLayer="scene",e.TileLayer="tile",e.UnknownLayer="unknown",e.UnsupportedLayer="unsupported",e.VectorTileLayer="vector-tile",e.WMSLayer="wms",e.WMTSLayer="wmts",e.WebTileLayer="web-tile"}(o||(o={}));var d=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};let h=null;function y(e,t,i){return d(this,void 0,void 0,(function*(){if(!e)return yield Promise.reject(new Error("Invalid target."));if(!t)return yield Promise.reject(new Error("Invalid target."));let r,s,a;i||(i={});const n=yield c(["esri/Graphic","esri/geometry/Extent","esri/layers/Layer","esri/layers/support/TileInfo"]);[r,s,a,h]=n;const o=i.padding;o&&e.padding&&(e.padding.left=o.left||0,e.padding.right=o.right||0,e.padding.top=o.top||0,e.padding.bottom=o.bottom||0);let l=null;try{t instanceof s?yield v(e,t,i.scale):Array.isArray(t)&&t.length&&t[0]instanceof r?yield g(e,t,i.scale):Array.isArray(t)&&t.length&&t[0]instanceof Array&&t[0][0]instanceof r?yield function(e,t,i){return d(this,void 0,void 0,(function*(){if(0===t.length)return Promise.resolve();if(1===t.length)return g(e,t[0],i);{const r=[];t.forEach((t=>{r.push(M(e,t).catch((()=>null)))}));let s=null;return Promise.all(r).then((t=>(t.forEach((e=>{e&&(s=s?s.union(e):e)})),v(e,s,i))))}}))}(e,t,i.scale):t instanceof a?yield m(e,t,null,null,i):t.layer&&t.layer instanceof a&&t.extent&&t.extent instanceof s?yield m(e,t.layer,null,t.extent,i):t.layer&&t.layer instanceof a&&Array.isArray(t.graphics)?0===t.graphics.length?yield m(e,t.layer,null,null,i):t.graphics.length&&t.graphics[0]instanceof r&&(yield m(e,t.layer,t.graphics,null,i)):Array.isArray(t)&&t.length&&t[0]instanceof a?yield function(e,t,i){return d(this,void 0,void 0,(function*(){if(1===(null==t?void 0:t.length))return m(e,t[0],null,null,i);{let r=null;const s=[];return t.forEach((t=>s.push(A(e,t,null==i?void 0:i.queryParams)))),Promise.all(s).then((t=>(t.forEach((e=>{e&&(r=r?r.union(e):e)})),f(e,r))))}}))}(e,t,i):l=new Error("Invalid target.")}catch(e){l=e}return e.padding&&(e.padding.left=0,e.padding.right=0,e.padding.top=0,e.padding.bottom=0),l?(console.warn("zoomTo warning",l),Promise.reject(l)):Promise.resolve()}))}function p(e,t,i,r=!0){return d(this,void 0,void 0,(function*(){return D(e,t,i,r)}))}function g(e,t,i){return d(this,void 0,void 0,(function*(){return"3d"!==e.type||i?M(e,t).then((t=>d(this,void 0,void 0,(function*(){return v(e,t,i)})))).catch((e=>d(this,void 0,void 0,(function*(){return Promise.reject(e)})))):e.goTo(t)}))}function m(e,t,i,r,s){return d(this,void 0,void 0,(function*(){let a,n=null==s?void 0:s.scale;if(a=r&&w(r)?r:i&&i.length>0?yield M(e,i):yield A(e,t,null==s?void 0:s.queryParams),!w(a))return Promise.reject(new Error("Invalid extent."));const o=yield J([a],e.spatialReference);if(a=o[0],n)return j(e,a,n).then((t=>f(e,t)));if("3d"===e.type)return e.goTo(a);{let i=t.minScale||0,r=t.maxScale||0;if(L(a)){let t=C(e,i,r,3);return t?(a=P(e,a),j(e,a,t).then((t=>f(e,t)))):f(e,a)}return a=P(e,a),function(e,t){return d(this,void 0,void 0,(function*(){return yield c(["esri/config","esri/geometry/support/WKIDUnitConversion"]).then((i=>{let r,s,a;[r,s]=i;const n=e.size[0],o=s;let l,u,c=t.spatialReference;c&&(l=c.wkid,u=c.wkt);let d=null;if(l)d=o.values[o[l]];else if(u&&-1!==u.search(/^PROJCS/i)){const e=/UNIT\[([^\]]+)\]\]$/i.exec(u);e&&e[1]&&(d=parseFloat(e[1].split(",")[1]))}return a=t.width/n*(d||20015077/180)*39.37*(r.screenDPI||96),a})).catch((e=>d(this,void 0,void 0,(function*(){return yield Promise.reject()}))))}))}(e,a).then((t=>i>0&&t>i?(i=F(e,i,!0),j(e,a,i).then((t=>f(e,t)))):t<r?(r=F(e,r,!1),j(e,a,r).then((t=>f(e,t)))):f(e,a)))}}))}function v(e,t,i){return d(this,void 0,void 0,(function*(){return w(t=t.clone())?J([t],e.spatialReference).then((i=>{let r=i&&i[0];return r||(r=t),L(r)?function(e,t){return d(this,void 0,void 0,(function*(){const i=C(e,0,0,3);return i?yield j(e,t,i):yield Promise.reject()}))}(e,r):r})).then((t=>i?j(e,t,i,!1):t)).then((t=>f(e,t))).catch((e=>d(this,void 0,void 0,(function*(){return Promise.reject(e)})))):Promise.reject(new Error("Invalid extent."))}))}function f(e,t){return new Promise(((i,r)=>{setTimeout((()=>{e.goTo(t).then((()=>{i()})).catch((()=>{r()}))}),400)}))}function w(e){return e&&S(e.xmin)&&S(e.ymin)&&S(e.xmax)&&S(e.ymax)}function S(e){return 0===e||!!e}var I;function L(e){return e.xmin+I.X===e.xmax-I.X&&e.ymin+I.Y===e.ymax-I.Y}function M(e,t,i={}){return d(this,void 0,void 0,(function*(){let r=t&&t[0]&&t[0].layer;return r&&"scene"===r.type?yield function(e,t,i){return d(this,void 0,void 0,(function*(){return yield c(["esri/rest/support/Query"]).then((i=>d(this,void 0,void 0,(function*(){const[r]=i;if(t){const i=new r;return i.objectIds=e.map((e=>e.attributes[t.objectIdField])),i.returnGeometry=!0,t.queryExtent(i).then((e=>1===e.count?e.extent.expand(3.5):e.extent.expand(2)))}return Promise.reject()})))).catch((e=>d(this,void 0,void 0,(function*(){return yield Promise.reject(e)}))))}))}(t,r,i.factor):"3d"===e.type?yield V(t,3):yield V(t)}))}function V(e,t){return d(this,void 0,void 0,(function*(){return yield c(["esri/Graphic","esri/geometry/Extent","esri/geometry/Point"]).then((i=>{let r,s,a,n=null,o=e;[r,s,a]=i;try{if(o&&1===o.length&&o[0].geometry&&"esri.geometry.Multipoint"===o[0].geometry.declaredClass&&1===o[0].geometry.points.length){const e=o[0].geometry.points[0];o=[new r({geometry:new a({x:e[0],y:e[1],spatialReference:o[0].geometry.spatialReference})})]}if(o&&1===o.length&&o[0].geometry&&"esri.geometry.Point"===o[0].geometry.declaredClass){const e=o[0].geometry;n=new s({xmin:e.x-I.X,ymin:e.y-I.Y,xmax:e.x+I.X,ymax:e.y+I.Y,spatialReference:e.spatialReference})}else o&&o.length>0&&(n=function(e,t){if(!e||!e.length)return null;let i,r=null,s=e.length;for(i=0;i<s;i++){const s=e[i].geometry;if(!s)continue;let a=s.extent;a||"point"!==s.type||null==s.x||null==s.y||(a=new t({xmin:s.x,ymin:s.y,xmax:s.x,ymax:s.y,spatialReference:s.spatialReference})),a&&(r=r?r.union(a):a)}return!r||r.width<0||r.height<0?null:r}(o,s),n&&t&&t>0&&(n=n.expand(t)));return n}catch(e){return Promise.reject(e)}})).catch((e=>d(this,void 0,void 0,(function*(){return yield Promise.reject(e)}))))}))}function b(e){let t=[];return e.map.basemap.baseLayers.forEach((e=>{e&&e.tileInfo&&e.tileInfo.lods&&t.length<e.tileInfo.lods.length&&(t=e.tileInfo.lods)})),0===t.length?h.create().lods:t}function C(e,t,i,r){const s=b(e);let a,n=1;if(s){const e=[],o=[];let l;s.forEach((r=>{t>0&&r.scale>t||(r.scale<i?o.push(r.scale):e.push(r.scale))})),e.reverse(),e.length>=1?(n=o.length?o.length/s.length:1,l=Math.floor((e.length-1)/(r/n)),a=e[l]):a=null}else a=0===t?null:(t-i)/r;return a}function F(e,t,i){let r;const s=b(e);if(s){if(i){for(r=0;r<s.length;r++)if(s[r].scale<t)return s[r].scale-1;return s[s.length-1].scale-1}for(r=s.length-1;r>=0;r--)if(s[r].scale>t)return s[r].scale+1;return s[0].scale+1}return i?t-1:t+1}function P(e,t){const i=e.size[0]/e.size[1],r=t.width/t.height,s=t.center.x,a=t.center.y;if(r>i){const e=t.width/i/2;t.ymin=a-e,t.ymax=a+e}else if(r<i){const e=t.height*i/2;t.xmin=s-e,t.xmax=s+e}return t}function j(e,t,i,r=!0){return d(this,void 0,void 0,(function*(){return D({width:e.size[0],height:e.size[1]},t,i,r)}))}function D(e,t,i,r=!0){return d(this,void 0,void 0,(function*(){return r&&(t=function(e,t){const i=t.width*(e.height/e.width)/5,r=t.center.y;return t.ymin=r-i,t.ymax=r+i,t}(e,t.clone())),yield c(["esri/config","esri/geometry/support/WKIDUnitConversion"]).then((r=>{let s,a;[s,a]=r;const n=e.width,o=a;let l,u,c=t.spatialReference;c&&(l=c.wkid,u=c.wkt);let d=null;if(l)d=o.values[o[l]];else if(u&&-1!==u.search(/^PROJCS/i)){const e=/UNIT\[([^\]]+)\]\]$/i.exec(u);e&&e[1]&&(d=parseFloat(e[1].split(",")[1]))}return t.expand(i*n/(39.37*(d||20015077/180)*(s.screenDPI||96))/t.width)})).catch((e=>d(this,void 0,void 0,(function*(){return yield Promise.reject()}))))}))}function A(e,t,i){var r,s;return d(this,void 0,void 0,(function*(){if(!t.loaded&&t.load&&(yield t.load()),t.sublayers||t.type===o.GroupLayer){const r=[];let s=null;return(t.type===o.GroupLayer?t.layers:t.sublayers).forEach((t=>r.push(A(e,t,i)))),Promise.all(r).then((e=>{var i;return e.forEach((e=>{e&&(s=s?s.union(e):e)})),s||(null===(i=t.fullExtent)||void 0===i?void 0:i.clone())}))}return(null===(r=t.capabilities)||void 0===r?void 0:r.query)?yield function(e,t,i){var r;return d(this,void 0,void 0,(function*(){const s=null===(r=t.fullExtent)||void 0===r?void 0:r.clone(),a=t.capabilities.query;return a?yield c(["esri/rest/support/Query","esri/geometry/Extent"]).then((r=>{let n,o;[n,o]=r;const l=new n;return l.where=(null==i?void 0:i.where)||(null==t?void 0:t.definitionExpression)||"1=1",l.outSpatialReference=e.spatialReference,l.returnGeometry=!0,a.supportsExtent?t.queryExtent(l).then((i=>{var r,s;if("3d"===e.type)return i.extent;if(1===i.count&&"point"===t.geometryType&&(null===(r=null==i?void 0:i.extent)||void 0===r?void 0:r.center)){const t=null===(s=null==i?void 0:i.extent)||void 0===s?void 0:s.center;return new o({xmin:t.x-I.X,ymin:t.y-I.Y,xmax:t.x+I.X,ymax:t.y+I.Y,spatialReference:e.spatialReference})}return i.extent})).catch((e=>d(this,void 0,void 0,(function*(){return yield Promise.resolve(s)})))):t.queryFeatures?t.queryFeatures(l).then((t=>d(this,void 0,void 0,(function*(){return M(e,t.features)})))).catch((e=>d(this,void 0,void 0,(function*(){return yield Promise.resolve(s)})))):Promise.resolve(s)})).catch((e=>d(this,void 0,void 0,(function*(){return yield Promise.resolve(s)})))):Promise.resolve(s)}))}(e,t,i):yield Promise.resolve(null===(s=t.fullExtent)||void 0===s?void 0:s.clone())}))}function J(e,t){return d(this,void 0,void 0,(function*(){return yield c(["esri/geometry/Extent"]).then((i=>{let r;return[r]=i,l.geometryUtils.projectToSpatialReference(e,t).then((e=>e.map((e=>"extent"!==e.type||0!==e.width&&0!==e.height?e:new r({xmin:e.xmin-I.X,ymin:e.ymin-I.Y,xmax:e.xmax+I.X,ymax:e.ymax+I.Y,spatialReference:e.spatialReference})))))})).catch((e=>d(this,void 0,void 0,(function*(){return yield Promise.reject()}))))}))}!function(e){e[e.X=1e-4]="X",e[e.Y=1e-4]="Y"}(I||(I={}));var O=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};const x=" "+B(["Web Map"])+" ";let T=null;function W(){const e=(0,l.getAppStore)().getState().portalSelf;return!!(e&&e.defaultBasemap&&e.defaultBasemap.baseMapLayers&&e.defaultBasemap.baseMapLayers[0]&&e.defaultBasemap.baseMapLayers[0].url)}function E(e){return O(this,void 0,void 0,(function*(){return T||(T=R(e),T)}))}function R(e){return O(this,void 0,void 0,(function*(){const t=new(0,(yield c(["esri/portal/Portal"]))[0])({url:e});yield t.load();const i=t.sourceJSON,r=i.defaultBasemap&&i.defaultBasemap.id,s=i.defaultExtent;if(r)return{defaultMapId:r,defaultExtent:s};const a=yield function(e,t,i){return O(this,void 0,void 0,(function*(){const e=t.defaultBasemap&&t.defaultBasemap.title,r=t.useVectorBasemaps&&t.vectorBasemapGalleryGroupQuery?t.vectorBasemapGalleryGroupQuery:t.basemapGalleryGroupQuery;return yield i.queryGroups({f:"json",query:r}).then((t=>O(this,void 0,void 0,(function*(){const r=t.results;if(r.length>0){const t=r[0],s=x+" AND group:"+t.id;return yield i.queryItems({start:1,num:1,f:"json",query:s}).then((t=>O(this,void 0,void 0,(function*(){let r=t.results;r=r.filter((e=>e.type&&"web map"===e.type.toLowerCase()));let s=null;if(r.length>0&&(s=r.find((t=>{var i;return null===(i=t.title)||void 0===i?void 0:i.toLowerCase().includes(null==e?void 0:e.toLowerCase())}))),s)return Promise.resolve(s.id);{const t=`${x} AND owner:esri AND title:"${e}"`;return i.queryItems({start:1,num:1,f:"json",query:t}).then((e=>O(this,void 0,void 0,(function*(){let t=e.results;if(t=t.filter((e=>e.type&&"web map"===e.type.toLowerCase())),t.length>0){const e=t[0];return Promise.resolve(e.id)}return Promise.resolve(null)}))))}}))))}}))))}))}(0,i,t);if(a){const e=yield function(e,t){return O(this,void 0,void 0,(function*(){try{const i=new(0,(yield c(["esri/portal/PortalItem"]))[0])({portal:e,id:t}),r=yield i.fetchData();if(r&&r.version&&"string"==typeof r.version)return parseFloat(r.version.split(".")[0])>=2}catch(e){return console.error("validate web map version error",t,e),!1}return!1}))}(t,a);if(e)return{defaultMapId:a,defaultExtent:s}}const n=yield function(e){return O(this,void 0,void 0,(function*(){const t={start:1,num:1,f:"json",query:x+" AND access:public AND owner:esri_en",sortField:"num-views",sortOrder:"desc"};return yield e.queryItems(t).then((e=>O(this,void 0,void 0,(function*(){let t=e.results;if(t=t.filter((e=>e.type&&"web map"===e.type.toLowerCase())),t.length>0){const e=t[0];return Promise.resolve(e.id)}return Promise.resolve(null)}))))}))}(t);return{defaultMapId:n,defaultExtent:s}}))}function B(e){let t="";const i=function(){let e=[];return e=e.concat(["Web Map","Web Scene","CityEngine Web Scene"]).concat(["Feature Service","Map Service","Image Service","KML","WMS","Feature Collection","Feature Collection Template","Geodata Service","Globe Service"]).concat(["Geometry Service","Geocoding Service","Network Analysis Service","Geoprocessing Service"]).concat(["Web Mapping Application","Mobile Application","Code Attachment","Operations Dashboard Add In","Operation View"]).concat(["Symbol Set","Color Set","Shapefile","CSV","Service Definition","Document Link","Microsoft Word","Microsoft PowerPoint","Microsoft Excel","PDF","Image","Visio Document"]),e=e.concat(["Map Document","Map Package","Tile Package","ArcPad Package","Explorer Map","Globe Document","Scene Document","Published Map","Map Template","Windows Mobile Package"]).concat(["Layer","Layer Package","Explorer Layer"]).concat(["Geoprocessing Package","Geoprocessing Sample","Locator Package","Rule Package"]).concat(["Workflow Manager Package","Desktop Application","Desktop Application Template","Code Sample","Desktop Add In","Explorer Add In"]),e}();if(e&&e.length>0&&e.length>0){let r="";for(let t=0;t<e.length;t++)r+=' type:"'+e[t]+'" ',t!==e.length-1&&(r+=" OR ");t=" ( "+r+" ) ";const s=e.concat(i).filter((t=>e.every((e=>!e.toLowerCase().includes(t.toLowerCase())))));for(let e=0;e<s.length;e++)t+=' -type:"'+s[e]+'" '}return t}var U=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};function G(e){return(0,l.loadArcGISJSAPIModules)(["esri/Graphic","esri/rest/support/FeatureSet"]).then((t=>U(this,void 0,void 0,(function*(){const[i,r]=t,s=new r,a=l.dataSourceUtils.changeRestAPIGeometryTypeToJSAPIGeometryType(e.dataSource.getGeometryType());return s.geometryType=a,s.features=e.records.map((e=>{let t;const r=e.feature;return"esri.Graphic"===(null==r?void 0:r.declaredClass)?t=r.clone():(r.geometry.type=a,t=new i({geometry:r.geometry,attributes:r.attributes})),t})),s})))).catch((e=>(console.warn(e),null)))}function k(e){let t=null;switch(e){case"point":t={type:"esriSMS",color:[255,255,0,150],outline:{color:[255,255,0,150],width:1}};break;case"polyline":t={type:"esriSLS",color:[255,255,0,150]};break;case"polygon":t={type:"esriSFS",color:[255,255,0,150],outline:{color:[255,255,0,150],width:1}}}return t}var Q=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};function H(){return Q(this,void 0,void 0,(function*(){const e=yield c(["esri/portal/Portal","esri/Basemap"]),[t,i]=e;let r=[];const s=(0,l.getAppStore)().getState().portalUrl,a=new t({url:s});yield a.load();const n=a.sourceJSON,o=(yield q(a,n,!1)).id;r=yield N(a,s,o);const u=r.map((e=>function(e,t){return Q(this,void 0,void 0,(function*(){const i=new e({portalItem:{id:t.id}});return yield i.load()}))}(i,e)));return yield Promise.all(u)}))}function q(e,t,i=!1){return Q(this,void 0,void 0,(function*(){try{const r='title:"ArcGIS Online Basemaps" AND owner:esri_en',s=t.useVectorBasemaps&&t.vectorBasemapGalleryGroupQuery?t.vectorBasemapGalleryGroupQuery:t.basemapGalleryGroupQuery,a=i?r:s,n=yield e.queryGroups({query:a});return n.results.length>0?n.results[0]:null}catch(e){return console.log("Failed to get basemap groups",e),null}}))}function N(e,t,i){return Q(this,void 0,void 0,(function*(){try{const r=B(["Web Map"]),s=`group:${i} AND ${r}`,a=yield e.queryItems({start:1,num:100,sortField:"title",sortOrder:"asc",query:s}),n=function(e,t){const i=[];return e.forEach((e=>{const r=l.portalUrlUtils.getItemUrl(t,e.id)+"/info/"+e.thumbnail,s={id:e.id,title:e.title,thumbnailUrl:r,type:e.type};i.push(s)})),i}((null==a?void 0:a.results)?a.results:[],t);return n}catch(e){return console.log("Failed to get basemap items by  group id",e),[]}}))}const _={layerIsNotSupported:"This layer type is not supported."};var $=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};class z{constructor(e){this.runTimeIsHidden=!1,this.removeableByMapTool=!1,this.id=e.id,this.mapViewManager=e.mapViewManager,this.type=e.type,this.layerDataSourceId=e.layerDataSourceId,this.jimuMapViewId=e.jimuMapViewId,this.jimuLayerId=e.jimuLayerId,this.layer=e.layer,this.parentJimuLayerViewId=e.parentJimuLayerViewId,this.index=e.index,this.fromRuntime=e.fromRuntime,this.isLoaded=!1;const t=l.appConfigUtils.getDataSourceJsonById(this.getAppConfig(),this.layerDataSourceId);if(t){const e=t.isHidden,i=t.label;i&&i!==this.layer.title&&(this.layer.title=i),this.runTimeIsHidden=e,e&&(this.layer.visible=!e)}this.initListenToDataSourceJsonChange(),this.initListenToDataSourceInfoChange(),this.isLayerDataSourceUsed()&&this.createLayerDataSource()}ready(){return $(this,void 0,void 0,(function*(){return Promise.resolve(this)}))}getLayerDataSource(){return l.DataSourceManager.getInstance().getDataSource(this.layerDataSourceId)}createLayerDataSource(){return $(this,void 0,void 0,(function*(){let e=l.DataSourceManager.getInstance().getDataSource(this.layerDataSourceId);if(!e)try{const t=this.getMapDataSource();if(t)e=yield t.createDataSourceByLayer(this.layer);else{e=l.DataSourceManager.getInstance().getDataSource(this.layerDataSourceId);const t=this.getParentJimuLayerView();if(t){const i=t.getLayerDataSource();i&&i.createDataSourceById&&(e=yield i.createDataSourceById(this.layerDataSourceId))}}}catch(t){console.error(`JimuLayerView ${this.id} create layer data source failed:`,t),e=null}return e}))}getParentJimuLayerView(){const e=this.getJimuMapView();return e&&this.parentJimuLayerViewId?e.jimuLayerViews[this.parentJimuLayerViewId]:null}isLayerDataSourceUsed(){return l.DataSourceManager.getInstance().isDataSourceUsed(this.layerDataSourceId)||this.isLayerUsedByMessage()||this.isLayerUsedByFilter()}isLayerUsedByMessage(){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId),t=null==e?void 0:e.mapWidgetId;if(t){const e=(0,l.getAppStore)().getState().appConfig.messageConfigs;if(e){const i=Object.values(e);if(i.length>0)return i.some((e=>e.widgetId===t&&e.actions&&e.actions.length>0))}}return!1}isLayerUsedByFilter(){const e=(0,l.getAppStore)().getState().appConfig.dataSources||{},t=Object.values(e);for(;t.length>0;){const e=t.shift();if(e.id===this.layerDataSourceId)return!!e.query;if(this.layerDataSourceId.startsWith(e.id)&&e.childDataSourceJsons){const i=Object.values(e.childDataSourceJsons);t.push(...i)}}return!1}isLayerVisible(){return!this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).getParentJimuLayerViews(this.id).some((e=>!e.layer.visible))&&this.layer.visible}getMapSceneView(){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId);return e&&e.view}getMapDataSource(){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).dataSourceId;return l.DataSourceManager.getInstance().getDataSource(e)}onLayerDataSourceInfoChange(e,t){var i;const r=null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getLabel();if(r&&r!==this.layer.title){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId),t=l.i18n.getIntl().formatMessage({id:"action_addedData",defaultMessage:l.defaultMessages.action_addedData},{label:r});this.layer.title=r,l.MutableStoreManager.getInstance().updateStateValue(e.mapWidgetId,`addToMapDatas.${this.layer.id}.title`,t)}}getJimuMapView(){return this.mapViewManager.getJimuMapViewById(this.jimuMapViewId)}destroy(){this.dataSourceInfoObserver&&this.dataSourceInfoObserver(),this.dataSourceJsonObserver&&this.dataSourceJsonObserver()}getAppConfig(){var e;return window.jimuConfig.isBuilder?null===(e=(0,l.getAppStore)().getState().appStateInBuilder)||void 0===e?void 0:e.appConfig:(0,l.getAppStore)().getState().appConfig}initListenToDataSourceJsonChange(){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).dataSourceId;this.dataSourceJsonObserver=(0,l.observeStore)(this.onLayerDatasourceJsonChange.bind(this),["appConfig","dataSources",e])}initListenToDataSourceInfoChange(){this.dataSourceInfoObserver=(0,l.observeStore)(this.onLayerDataSourceInfoChange.bind(this),["dataSourcesInfo",this.layerDataSourceId])}onLayerDatasourceJsonChange(e,t){if(!l.appConfigUtils.getDataSourceJsonById(this.getAppConfig(),this.layerDataSourceId))return;const i=l.appConfigUtils.getDataSourceJsonById(this.getAppConfig(),this.layerDataSourceId).isHidden;this.runTimeIsHidden!==i&&(this.runTimeIsHidden=i,this.layer.visible=!i)}getMapWidgetId(){const e=this.getJimuMapView();return(null==e?void 0:e.mapWidgetId)||""}setRemoveableByMapTool(e){var t;this.removeableByMapTool=e;const i=this.getMapWidgetId(),r=null===(t=this.layer)||void 0===t?void 0:t.id,s=this.getJimuMapView();if(i&&r&&s){const e=s.id,t=(l.MutableStoreManager.getInstance().getStateValue([i])||{}).removeableLayerIdsInfo||{},r=[];Object.values(s.jimuLayerViews).forEach((e=>{e.removeableByMapTool&&e.layer&&r.push(e.layer.id)})),t[e]=r,l.MutableStoreManager.getInstance().updateStateValue(i,"removeableLayerIdsInfo",t)}}}var X,K=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};!function(e){e.New="New",e.AddToCurrent="AddToCurrent",e.RemoveFromCurrent="RemoveFromCurrent",e.SelectFromCurrent="SelectFromCurrent"}(X||(X={}));const Y="__EXB_OID__";class Z extends z{constructor(e){super(e),this.highlightFeatureLayer=null,this.highlightFeatureLayerView=null,this.localDefinitionExpression="",this.originalGdbVersion=null,this.selectQueryId=0,this.selectQueryIdChangeListeners=[],this.selectedFeatureIds=[],this.originalGdbVersion=this.layer.gdbVersion}ready(){return K(this,void 0,void 0,(function*(){return[this.reactiveUtils,this.Graphic]=yield(0,l.loadArcGISJSAPIModules)(["esri/core/reactiveUtils","esri/Graphic"]),this.watchHighlightOptions(),this.watchLayerVisible(),this.watchPopupSelectFeature(),this.watchPopupVisible(),this.tryMoveToCenter(),Promise.resolve(this)}))}destroy(){this.updateWatchHandle&&(this.updateWatchHandle.remove(),this.updateWatchHandle=null),this.highlightLayerUpdateWatchHandle&&(this.highlightLayerUpdateWatchHandle.remove(),this.highlightLayerUpdateWatchHandle=null),this.popupSelectFeatureWatchHandle&&(this.popupSelectFeatureWatchHandle.remove(),this.popupSelectFeatureWatchHandle=null),this.releasePopupVisibleWatchHandle(),this.layerVisibleWatchHandle&&(this.layerVisibleWatchHandle.remove(),this.layerVisibleWatchHandle=null),this.highlightOptionsWatchHandle&&(this.highlightOptionsWatchHandle.remove(),this.highlightOptionsWatchHandle=null),super.destroy()}getSelectedFeatureCount(){let e=0;const t=this.getLayerDataSource();return t&&(e=t.getSelectedRecords().length),0===e&&this.selectedFeatureIds&&(e=this.selectedFeatureIds.length),e}getSelectedFeatures(){return K(this,void 0,void 0,(function*(){let e=[];const t=this.getLayerDataSource();let i=[];return t&&(i=t.getSelectedRecords()),e=i.length>0?i.map((e=>"esri.Graphic"===e.feature.declaredClass?e.feature:this.Graphic.fromJSON(e.feature))):yield this.querySelectedFeaturesFromClient(),e.forEach((e=>{e.jimuLayerViewId=this.id})),e}))}queryFeaturesFromClient(e){return K(this,void 0,void 0,(function*(){return new Promise((t=>{if(!this.view)return void t([]);const i=()=>K(this,void 0,void 0,(function*(){let i=null,r=null;try{const t=yield this.view.queryFeatures(e);i=null==t?void 0:t.features}catch(e){console.error("Query feature from view error.",this.id,e),r=e,i=[]}if(r&&"esri.views.3d.layers.SceneLayerView3D"===this.view.declaredClass&&e.returnGeometry){const t=Object.assign({},e,{returnGeometry:!1});try{const e=yield this.view.queryFeatures(t);i=null==e?void 0:e.features}catch(e){console.error("Query feature from view error.",this.id,e),i=[]}}i||(i=[]),t(i)}));this.view.updating?(this.updateWatchHandle&&(this.updateWatchHandle.remove(),this.updateWatchHandle=null),this.updateWatchHandle=this.view.watch("updating",(e=>{e||i()}))):i()}))}))}queryFeaturesFromClientHighlightLayer(e){return K(this,void 0,void 0,(function*(){return new Promise((t=>{const i=this.highlightFeatureLayerView;if(e||(e=[]),!i||0===e.length)return void t([]);const r=()=>{this.highlightFeatureLayer.queryFeatures({where:"1=1",returnGeometry:!0}).then((i=>{var r;const s={},a=[];(null===(r=i.features)||void 0===r?void 0:r.length)>0&&(i.features.forEach((e=>{const t=e.getAttribute(Y);s[t]=e})),e.forEach((e=>{const t=s[e];t&&a.push(t)}))),t(a)}),(e=>{console.error("Query feature from highlightFeatureLayer error.",e),t([])}))};i.updating?(this.highlightLayerUpdateWatchHandle&&(this.highlightLayerUpdateWatchHandle.remove(),this.highlightLayerUpdateWatchHandle=null),this.highlightLayerUpdateWatchHandle=i.watch("updating",(e=>{e||r()}))):r()}))}))}queryFeatureByIdFromClient(e){return K(this,void 0,void 0,(function*(){const t={objectIds:[e],returnGeometry:!0};return this.queryFeaturesFromClient(t).then((e=>e[0]))}))}querySelectedFeaturesFromClient(){return K(this,void 0,void 0,(function*(){let e=[];if(0===this.selectedFeatureIds.length)return e;const t={objectIds:this.selectedFeatureIds,returnGeometry:!0};return e=this.highlightFeatureLayer?yield this.queryFeaturesFromClientHighlightLayer(this.selectedFeatureIds):yield this.queryFeaturesFromClient(t),e}))}selectFeatureById(e,t){var i;return K(this,void 0,void 0,(function*(){const r=this.selectedFeatureIds.length;this.selectedFeatureIds=[];const s=yield this.getOrCreateLayerDataSourceIfUsed();if(s){if(!e&&0===s.getSelectedRecordIds().length&&0===r)return;if(e){let i=null;i=t&&"esri.Graphic"===t.declaredClass?s.buildRecord(t):t,s.selectRecordById(e+"",i)}else null===(i=this.getLayerDataSource())||void 0===i||i.selectRecordById(null)}else e?(this.highLightFeatures([e],t?[t]:null),this.selectedFeatureIds=[Number(e)],l.jimuHistory.changeQueryObjectByDataRecordIds(this.layerDataSourceId,[e+""])):(this.clearHighLight(),l.jimuHistory.changeQueryObjectByDataRecordIds(this.layerDataSourceId,[]))}))}selectFeaturesByIds(e,t){return K(this,void 0,void 0,(function*(){const i=this.selectedFeatureIds.length;this.selectedFeatureIds=[];const r=yield this.getOrCreateLayerDataSourceIfUsed();if(r){if(0===e.length&&0===r.getSelectedRecordIds().length&&0===i)return;r.selectRecordsByIds(e.map((e=>e+"")),t)}else{if(e.length>0){const t=e.map((e=>Number(e)));this.highLightFeatures(t),this.selectedFeatureIds=t.slice()}else this.clearHighLight();l.jimuHistory.changeQueryObjectByDataRecordIds(this.layerDataSourceId,e.map((e=>e+"")))}}))}selectFeaturesByQuery(e,t){t!==X.AddToCurrent&&t!==X.RemoveFromCurrent&&t!==X.SelectFromCurrent&&(t=X.New),e.geometry=e.geometry.toJSON?e.geometry.toJSON():e.geometry,e=l.lodash.cloneDeep(e),this.selectedFeatureIds=[];const i=this.selectQueryId+1;this.setSelectQueryId(i);const r=this.selectQueryPromise||Promise.resolve([]);return this.selectQueryPromise=new Promise((s=>{r.finally((()=>K(this,void 0,void 0,(function*(){let r=null,a=[];try{r=yield this.getOrCreateLayerDataSource(),r&&(a=this.isClientQueryAvailable()?yield this.selectFeaturesFromClientByQuery(r,e,t):yield this.selectFeaturesFromServerByQuery(r,e,t,i))}catch(e){a=[]}const n=a.map((e=>e.getId())),o=a.map((e=>e.feature)),u=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId),c=new l.DataRecordsSelectionChangeMessage(u.mapWidgetId,a);l.MessageManager.getInstance().publishMessage(c),r&&r.selectRecordsByIds(n,a),this.setSelectQueryProgress(i,1),this.selectQueryPromise.selectQueryId===i&&(this.selectQueryPromise=null),s(o)}))))})),this.selectQueryPromise.selectQueryId=i,this.selectQueryPromise}isClientQueryAvailable(){return!1}selectFeaturesFromClientByQuery(e,t,i){return K(this,void 0,void 0,(function*(){t.geometry=t.geometry.toJSON?t.geometry.toJSON():t.geometry,t=l.lodash.cloneDeep(t);const[r]=yield(0,l.loadArcGISJSAPIModules)(["esri/rest/support/Query"]),s=r.fromJSON(t),a=yield this.queryFeaturesFromClient(s);let n=[];if(i===X.New)n=a;else{const e=yield this.getSelectedFeatures(),t=e.map((e=>e.getObjectId())),r=a.map((e=>e.getObjectId()));if(i===X.AddToCurrent){const i={};t.forEach((e=>{i[e]=!0}));const r=a.filter((e=>{const t=e.getObjectId();return!i[t]}));n=[...e,...r]}else{const t={};r.forEach((e=>{t[e]=!0})),i===X.RemoveFromCurrent?n=e.filter((e=>{const i=e.getObjectId();return!t[i]})):i===X.SelectFromCurrent&&(n=e.filter((e=>{const i=e.getObjectId();return t[i]})))}}let o=[];return e&&(o=n.map((t=>e.buildRecord(t)))),o}))}selectFeaturesFromServerByQuery(e,t,i,r){return K(this,void 0,void 0,(function*(){let s=[];return new Promise((a=>K(this,void 0,void 0,(function*(){let n=!1;const o=()=>{n||(n=!0,a(s))};try{if(i===X.New)s=yield this.queryFeatureDataRecordsFromServerByQuery(e,t,r,!0);else{const a=yield this.getSelectedFeatures(),n=a.map((t=>e.buildRecord(t))),u=a.map((e=>e.getObjectId()));if(!this.isFreshSelectQueryId(r))return void o();const c=yield this.queryFeatureIdsFromServerByQuery(e,t,r);if(!this.isFreshSelectQueryId(r))return void o();if(i===X.AddToCurrent){const i={};u.forEach((e=>{i[e]=!0}));const a=c.filter((e=>!i[e]));if(a.length>0){const i=l.lodash.cloneDeep(t);i.geometry=null,i.where="",i.objectIds=a;const o=yield this.queryFeatureDataRecordsFromServerByQuery(e,i,r,!0);s=[...n,...o]}else s=n}else{const e={};c.forEach((t=>{e[t]=!0})),i===X.RemoveFromCurrent?s=n.filter((t=>{const i=t.getId();return!e[i]})):i===X.SelectFromCurrent&&(s=n.filter((t=>{const i=t.getId();return e[i]})))}}}catch(e){console.error("select features from server error",e)}o()}))))}))}queryFeatureIdsFromServerByQuery(e,t,i){return K(this,void 0,void 0,(function*(){t=l.lodash.cloneDeep(t);let r=[];return new Promise((s=>K(this,void 0,void 0,(function*(){let a=!1,n=null;const o=()=>{this.removeSelectQueryIdChangeListener(n),a||(a=!0,s(r))};n=()=>!this.isFreshSelectQueryId(i)&&(o(),!0),this.addSelectQueryIdChangeListener(n);try{if(this.layer&&this.layer.queryObjectIds){const[i]=yield(0,l.loadArcGISJSAPIModules)(["esri/rest/support/Query"]),s=e.getRealQueryParams(t,"query"),a=i.fromJSON(s);r=yield this.layer.queryObjectIds(a),r||(r=[])}else{t.returnGeometry=!1,t.outFields=[];const s=yield this.queryFeatureDataRecordsFromServerByQuery(e,t,i,!1);r=s.map((e=>parseInt(e.getId())))}}catch(e){console.error("query featureIds from server error",e)}o()}))))}))}queryFeatureDataRecordsFromServerByQuery(e,t,i,r){const s=l.lodash.cloneDeep(t);t=l.lodash.cloneDeep(t);const a=[];return this.isLayerVisible()&&e&&e.layer?new Promise((n=>K(this,void 0,void 0,(function*(){let o=!1,l=null;const u=()=>{this.removeSelectQueryIdChangeListener(l),o||(o=!0,n(a))};l=()=>!this.isFreshSelectQueryId(i)&&(u(),!0),this.addSelectQueryIdChangeListener(l);try{const n=yield e.queryCount(s);if(l())return;const o=n.count;if(o>0){const s=this.getDataSourceQueryPageSize(e),n=Math.ceil(o/s);for(let o=1;o<=n;o++){t.page=o,t.pageSize=s;const u=yield e.query(t);if(l())return;const c=null==u?void 0:u.records;if(c&&c.length>0&&a.push(...c),r){const e=o/n*.9;this.setSelectQueryProgress(i,e)}}}}catch(e){console.error(`JimuLayerView ${this.id} query records error`,e)}u()})))):Promise.resolve(a)}getDataSourceQueryPageSize(e){let t=1e3;const i=e.getLayerDefinition();return i&&i.maxRecordCount>0&&(t=i.maxRecordCount),t=Math.min(t,1e4),t}cancelSelectByQuery(){if(this.selectQueryPromise){const e=this.selectQueryId+1;this.setSelectQueryId(e)}}setSelectQueryId(e){this.selectQueryId!==e&&(this.selectQueryId=e,this.selectQueryIdChangeListeners.forEach((e=>{e()})))}isFreshSelectQueryId(e){return this.selectQueryId===e}addSelectQueryIdChangeListener(e){this.selectQueryIdChangeListeners.includes(e)||this.selectQueryIdChangeListeners.push(e)}removeSelectQueryIdChangeListener(e){const t=this.selectQueryIdChangeListeners.indexOf(e);t>=0&&this.selectQueryIdChangeListeners.splice(t,1)}getOrCreateLocalDataSource(e){return K(this,void 0,void 0,(function*(){const t=yield this.getOrCreateLayerDataSource();return t?t.dataSourceManager.createLocalDataSource(t,e):null}))}getSelectQueryProgress(){if(this.selectQueryPromise){const e=this.selectQueryPromise.progress,t=.01;return"number"==typeof e?Math.max(e,t):t}return 1}setSelectQueryProgress(e,t){if(this.selectQueryPromise&&this.selectQueryPromise.selectQueryId===e){const e=0,i=1;this.selectQueryPromise.progress=Math.max(e,Math.min(t,i)),this.getJimuMapView().onSelectByQueryProgressChange()}}setDefinitionExpression(e){var t;this.localDefinitionExpression=e,(null===(t=this.getLayerDataSource())||void 0===t?void 0:t.getCurrentQueryParams())&&this.setDefinitionExpressionToLayer(this.getLayerDataSource().getCurrentQueryParams())}getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}getOrCreateLayerDataSource(){return K(this,void 0,void 0,(function*(){let e=this.getLayerDataSource();if(!e)try{e=yield this.createLayerDataSource()}catch(t){e=null,console.error(`JimuLayerView ${this.id} createLayerDataSource error`,t)}return e}))}getOrCreateLayerDataSourceIfUsed(){return K(this,void 0,void 0,(function*(){let e=this.getLayerDataSource();if(!e&&this.isLayerDataSourceUsed())try{e=yield this.createLayerDataSource()}catch(t){e=null,console.error(`JimuLayerView ${this.id} createLayerDataSource error`,t)}return e}))}getHighlightLayerLayer(){return this.highlightFeatureLayer}onLayerDataSourceInfoChange(e,t){var i,r,s;super.onLayerDataSourceInfoChange(e,t),((null==e?void 0:e.selectedIds)||null)!==((null==t?void 0:t.selectedIds)||null)&&((null===(i=null==t?void 0:t.selectedIds)||void 0===i?void 0:i.length)>0?this.highLightSelectedRecords():this.clearHighLight()),this.getLayerDataSource()?this.getLayerDataSource().getCurrentQueryParams()&&this.setDefinitionExpressionToLayer(this.getLayerDataSource().getCurrentQueryParams()):(null===(r=t.widgetQueries)||void 0===r?void 0:r._filterInUrl)&&this.createLayerDataSource().then((()=>{var e;this.setDefinitionExpressionToLayer(null===(e=t.widgetQueries)||void 0===e?void 0:e._filterInUrl)})),this.view&&((null==t?void 0:t.gdbVersion)&&(this.layer.gdbVersion=t.gdbVersion),!(null==t?void 0:t.gdbVersion)&&this.originalGdbVersion&&(this.layer.gdbVersion=this.originalGdbVersion)),this.setRefreshIntervalForLayer(null===(s=this.getLayerDataSource())||void 0===s?void 0:s.getAutoRefreshInterval())}watchPopupSelectFeature(){this.popupSelectFeatureWatchHandle&&(this.popupSelectFeatureWatchHandle.remove(),this.popupSelectFeatureWatchHandle=null),this.popupSelectFeatureWatchHandle=this.reactiveUtils.watch((()=>{var e;return null===(e=this.getMapSceneView().popup)||void 0===e?void 0:e.selectedFeature}),(e=>K(this,void 0,void 0,(function*(){const t=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId);if((!t||!t.isPopupFeaturesFromSelection())&&e){const t=this.getLayerFromFeature(e);if(!t)return;if(t===this.layer){const t=e.getObjectId();if(!this.isLayerDataSourceUsed()&&!this.getLayerDataSource())return void this.selectFeatureById(t);const i=this.getLayerDataSource()||(yield this.createLayerDataSource());if(!i)return;if(i.getSelectedRecordIds().includes(t+""))return;const r=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId);i.queryById(t+"").then((i=>{var s,a;(null===(a=null===(s=r.view)||void 0===s?void 0:s.popup)||void 0===a?void 0:a.selectedFeature)===e&&(this.selectFeatureById(Number(t),i),l.MessageManager.getInstance().publishMessage(new l.DataRecordsSelectionChangeMessage(r.mapWidgetId,[i])))}))}else this.selectFeatureById(null)}}))))}releasePopupVisibleWatchHandle(){this.popupVisibleWatchHandle&&(this.popupVisibleWatchHandle.remove(),this.popupVisibleWatchHandle=null)}watchPopupVisible(){this.releasePopupVisibleWatchHandle(),this.popupVisibleWatchHandle=this.reactiveUtils.watch((()=>{var e;return null===(e=this.getMapSceneView().popup)||void 0===e?void 0:e.visible}),(e=>{const t=this.getMapSceneView().popup;if(!e&&t&&this.isPopupSelectCurrentLayerFeature()){t.features=[];const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId);l.MessageManager.getInstance().publishMessage(new l.DataRecordsSelectionChangeMessage(e.mapWidgetId,[])),this.selectFeatureById(null)}}))}isPopupSelectCurrentLayerFeature(){const e=this.getMapSceneView().popup;return e&&e.selectedFeature&&this.getLayerFromFeature(e.selectedFeature)===this.layer}onParentLayerVisibleChange(e){this.onLayerFinalVisibleChange()}watchLayerVisible(){this.layerVisibleWatchHandle&&(this.layerVisibleWatchHandle.remove(),this.layerVisibleWatchHandle=null),this.layerVisibleWatchHandle=this.layer.watch("visible",((e,t)=>{this.onLayerFinalVisibleChange()}))}onLayerFinalVisibleChange(){const e=this.isLayerVisible();this.highlightFeatureLayer&&(this.highlightFeatureLayer.visible=e);const t=this.getMapSceneView().popup;t&&this.isPopupSelectCurrentLayerFeature()&&t.visible!==e&&(this.releasePopupVisibleWatchHandle(),t.visible=e,this.watchPopupVisible())}watchHighlightOptions(){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).view;this.highlightOptionsWatchHandle&&(this.highlightOptionsWatchHandle.remove(),this.highlightOptionsWatchHandle=null),this.highlightOptionsWatchHandle=e.watch("highlightOptions",(()=>{this.highlightFeatureLayer&&(this.highlightFeatureLayer.renderer=this.getRendererForHighlightLayer(this.highlightFeatureLayer.geometryType,e))}))}tryMoveToCenter(){var e,t,i,r;return K(this,void 0,void 0,(function*(){let s=this.layerDataSourceId,a=null;if(this.type===o.SceneLayer){let e=null;if(a=yield this.getOrCreateLayerDataSource(),a&&a.getAssociatedDataSource&&(e=a.getAssociatedDataSource()),!e)return;s=e.id}const n=((null===(t=null===(e=(0,l.getAppStore)().getState().dataSourcesInfo[s])||void 0===e?void 0:e.selectedIds)||void 0===t?void 0:t.asMutable())||[]).map((e=>Number(e)));if(n.length>0&&(a||(a=yield this.getOrCreateLayerDataSource()),a)){const e=(yield a.query({objectIds:n.slice(),returnGeometry:!0,returnZ:!0})).records;if(e&&e.length>0){this.selectFeaturesByIds(n,e);const t=null===(r=null===(i=e[0])||void 0===i?void 0:i.feature)||void 0===r?void 0:r.geometry;if(t)try{this.moveFeatureToCenter(t)}catch(e){console.error("fail to move feature to center",e)}}}}))}getLayerFromFeature(e){return e.layer||e.sourceLayer}setRefreshIntervalForLayer(e){this.view&&null!=e&&((0,l.getAppStore)().getState().appRuntimeInfo.appMode===l.AppMode.Design?this.layer.refreshInterval=0:this.layer.refreshInterval=e/60)}setDefinitionExpressionToLayer(e){var t,i,r,s,a;if(e){if(this.view&&this.view.layer){const i={outFields:["*"],where:this.localDefinitionExpression,returnGeometry:!0},r=(null===(t=this.getLayerDataSource())||void 0===t?void 0:t.getRealQueryParams(i,"query"))||e;if(r&&r.where!==this.view.layer.definitionExpression&&(this.view.layer.definitionExpression=r.where),this.type===o.FeatureLayer&&(null!=(null==r?void 0:r.time)?this.view.layer.useViewTime=!1:this.view.layer.useViewTime=!0,this.view.layer.timeExtent=l.dataSourceUtils.changeJimuTimeToJSAPITimeExtent(null==r?void 0:r.time)),e.geometry){if(this.view.filter&&this.view.filter.geometry===e.geometry)return;(0,l.loadArcGISJSAPIModules)(["esri/geometry/support/jsonUtils"]).then((t=>{const i=t[0];this.view.filter={geometry:i.fromJSON(e.geometry)}}))}else this.view.filter&&(this.view.filter=null);return}if(!this.view&&this.layer){const e={outFields:["*"],where:this.localDefinitionExpression,returnGeometry:!0},t=null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getRealQueryParams(e,"query"),n="esri.layers.support.Sublayer"===this.layer.declaredClass&&(null===(a=null===(s=null===(r=this.layer.layer)||void 0===r?void 0:r.capabilities)||void 0===s?void 0:s.exportMap)||void 0===a?void 0:a.supportsSublayerDefinitionExpression)||"esri.layers.FeatureLayer"===this.layer.declaredClass;t&&n&&t.where!==this.layer.definitionExpression&&(this.layer.definitionExpression=t.where)}}}highLightSelectedRecords(){0!==this.getSelectedRecordIds().length&&this.highLightFeatures(this.getSelectedRecordIds().map((e=>parseInt(e))))}tryCreateHighLightFeatureLayer(){return K(this,void 0,void 0,(function*(){if(this.view||this.type!==o.FeatureLayer||!this.isLoaded)return;yield this.getJimuMapView().whenJimuLayerViewLoaded(this.id);const e=this.getLayerDataSource()||(yield this.createLayerDataSource());if(!e)return;if(this.highLightLayerCreationPromise)return this.highLightLayerCreationPromise;const t=this.getObjectIdField(e.layer.fields,e.layer.objectIdField),i={name:Y,type:"integer",alias:Y,description:""},r=t?[t,i]:[i];return this.highLightLayerCreationPromise=(0,l.loadArcGISJSAPIModules)(["esri/layers/FeatureLayer"]).then((t=>{var i,s;const a=t[0],n=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).view,o=(null===(s=null===(i=this.layer)||void 0===i?void 0:i.sourceJSON)||void 0===s?void 0:s.hasZ)||!1;return this.highlightFeatureLayer=new a({title:`${e.layer.title}-highlight`,geometryType:e.layer.geometryType,spatialReference:e.layer.spatialReference,source:[],fields:r,objectIdField:e.layer.objectIdField,renderer:this.getRendererForHighlightLayer(e.layer.geometryType,n),listMode:"hide",legendEnabled:!1,visible:this.isLayerVisible(),hasZ:o}),this.highlightFeatureLayer.bookmarkIgnore=!0,n.map.add(this.highlightFeatureLayer),new Promise(((e,t)=>{this.highlightFeatureLayer.on("layerview-create",(t=>{this.highlightFeatureLayerView=t.layerView,this.getSelectedRecordIds().length>0&&this.highLightSelectedRecords(),e()})),this.isLayerVisible()||e()}))})),this.highLightLayerCreationPromise}))}addFeaturesToHighlightFeatureLayer(e,t){const i=this.getLayerDataSource().getIdField();if(t||(t=e.map((e=>{var t;return null===(t=this.getLayerDataSource().getSelectedRecords().find((t=>t.getId()===e+"")))||void 0===t?void 0:t.feature})).filter((e=>!!e))),0===t.length)return Promise.resolve(!0);const r=t.map((e=>{const t=e.clone(),r=t.attributes[i];return t.attributes={},t.attributes[i]=r,t.attributes[Y]=r,t}));return this.highlightFeatureLayer.applyEdits({addFeatures:r}).then((e=>!e.addFeatureResults.find((e=>e.error))))}removeFeaturesFromHighlightFeatureLayer(){return this.highlightFeatureLayer.queryFeatures({where:"1=1"}).then((e=>{const t=e.features;return 0===t.length?Promise.resolve(!0):this.highlightFeatureLayer.applyEdits({deleteFeatures:t}).then((e=>!e.deleteFeatureResults.find((e=>e.error))))}))}highLightFeatures(e,t){return K(this,void 0,void 0,(function*(){this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null),yield this.tryCreateHighLightFeatureLayer();const i=this.view||this.highlightFeatureLayerView;if(i){if(this.highlightFeatureLayerView){const i=yield this.removeFeaturesFromHighlightFeatureLayer(),r=yield this.addFeaturesToHighlightFeatureLayer(e,t);if(!i||!r)return void this.onSelectedFeaturesChange(!1)}i.when((()=>{this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null),this.highLightHandle=i.highlight(e),this.onSelectedFeaturesChange(!1)}))}else this.onSelectedFeaturesChange(!1)}))}clearHighLight(){if(this.highLightHandle){this.highLightHandle.remove(),this.highLightHandle=null,this.highlightFeatureLayerView&&this.removeFeaturesFromHighlightFeatureLayer();const e=this.getMapSceneView();this.isPopupSelectCurrentLayerFeature()&&e.closePopup(),this.onSelectedFeaturesChange(!0)}}onSelectedFeaturesChange(e){const t=this.getJimuMapView();t&&t.onJimuLayerViewSelectedFeaturesChange(this,e)}moveFeatureToCenter(e){return K(this,void 0,void 0,(function*(){const t=this.getCenterPoint(e);if(!t)throw new Error("Does not find center point.");{const e=this.getMapSceneView(),i=e;if(i.extentChangeRelatedWidgetIds=[],i.receiveMessageTimeOfLastViewUpdate=Date.now(),yield e.goTo(t,{animate:!1}),i.publishExtentChangeMessage){i.extentChangeRelatedWidgetIds=[],i.receiveMessageTimeOfLastViewUpdate=Date.now();const e=!0,t=!0;i.publishExtentChangeMessage(e,t)}}}))}getCenterPoint(e){switch(e.type){case"point":return e;case"extent":return e.center;case"polygon":return e.centroid;case"polyline":return e.extent.center;default:return e&&e.extent?e.extent.center:void 0}}getSelectedRecordIds(){return this.getLayerDataSource()?this.getLayerDataSource().getSelectedRecordIds().filter((e=>!!e)):[]}getObjectIdField(e,t){let i=null;for(let r=0;r<e.length;r++)if(e[r].name===t)return i=e[r],i;return i}getRendererForHighlightLayer(e,t){const i=t.highlightOptions.color.clone(),r=t.highlightOptions.haloColor.clone();return["point","multipoint"].includes(e)?{type:"simple",symbol:{type:"simple-marker",style:"circle",color:i,size:"16px",outline:{color:r,width:1}}}:["polyline"].includes(e)?{type:"simple",symbol:{type:"simple-line",color:i,width:1,style:"solid"}}:["polygon","extent"].includes(e)?{type:"simple",symbol:{type:"simple-fill",color:[0,255,255,0],style:"solid",outline:{color:r,width:1}}}:["mesh"].includes(e)?{type:"simple",symbol:{type:"mesh-3d",symbolLayers:[{type:"fill",material:{color:i}}]}}:null}}class ee extends Z{getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}class te extends Z{getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}function ie(e,t){t.layer.watch("visible",(i=>{e.getAllChildJimuLayerViews(t.id).forEach((e=>{const t=e;t.onParentLayerVisibleChange&&t.onParentLayerVisibleChange(i)}))}))}class re extends z{constructor(e){super(e),this.url=null,this.url=e.url,ie(this.getJimuMapView(),this)}ready(){var e,t,i,r,s,a,n,o;return s=this,a=void 0,o=function*(){const s=(null===(t=null===(e=this.layer.layers)||void 0===e?void 0:e.toArray())||void 0===t?void 0:t.reverse())||(null===(r=null===(i=this.layer.sublayers)||void 0===i?void 0:i.toArray())||void 0===r?void 0:r.reverse());if(s&&s.length>0)for(let e=0;e<s.length;e++)yield this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).createJimuLayerView(s[e],this.jimuLayerId,e,null,this.fromRuntime);return this},new((n=void 0)||(n=Promise))((function(e,t){function i(e){try{l(o.next(e))}catch(e){t(e)}}function r(e){try{l(o.throw(e))}catch(e){t(e)}}function l(t){var s;t.done?e(t.value):(s=t.value,s instanceof n?s:new n((function(e){e(s)}))).then(i,r)}l((o=o.apply(s,a||[])).next())}))}}class se extends z{ready(){var e,t,i,r,s,a;return i=this,r=void 0,a=function*(){const i=null===(t=null===(e=this.layer.sublayers)||void 0===e?void 0:e.toArray())||void 0===t?void 0:t.reverse();if(i&&i.length>0){const e=[];for(let t=0;t<i.length;t++){const r=i[t],s=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).createJimuLayerView(r,this.jimuLayerId,t,null,this.fromRuntime);e.push(s)}yield Promise.all(e)}return this},new((s=void 0)||(s=Promise))((function(e,t){function n(e){try{l(a.next(e))}catch(e){t(e)}}function o(e){try{l(a.throw(e))}catch(e){t(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof s?i:new s((function(e){e(i)}))).then(n,o)}l((a=a.apply(i,r||[])).next())}))}}class ae extends z{constructor(e){super(e),this.url=null,this.url=e.url,ie(this.mapViewManager.getJimuMapViewById(this.jimuMapViewId),this)}ready(){var e,t,i,r,s,a;return i=this,r=void 0,a=function*(){yield this.layer.loadAll?this.layer.loadAll():this.layer.load();const i=null===(t=null===(e=this.layer.sublayers)||void 0===e?void 0:e.toArray())||void 0===t?void 0:t.reverse();if(i&&i.length>0)for(let e=0;e<i.length;e++)yield this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).createJimuLayerView(i[e],this.jimuLayerId,e,null,this.fromRuntime);return this},new((s=void 0)||(s=Promise))((function(e,t){function n(e){try{l(a.next(e))}catch(e){t(e)}}function o(e){try{l(a.throw(e))}catch(e){t(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof s?i:new s((function(e){e(i)}))).then(n,o)}l((a=a.apply(i,r||[])).next())}))}}class ne extends ae{}class oe extends ae{constructor(e){super(e),this.url=null,this.originalGdbVersion=null,this.originalGdbVersion=this.layer.gdbVersion}onLayerDataSourceInfoChange(e,t){const i=this.getLayerDataSource();if(!i)return;const r=i.getTimeExtent(),s=this.layer;s.useViewTime=null==r,s.timeExtent=l.dataSourceUtils.changeJimuTimeToJSAPITimeExtent(r),(null==t?void 0:t.gdbVersion)&&(s.gdbVersion=t.gdbVersion),!(null==t?void 0:t.gdbVersion)&&this.originalGdbVersion&&(s.gdbVersion=this.originalGdbVersion)}}var le,ue,ce,de=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};!function(e){e.DataAction="DATA_ACTION",e.MessageAction="MESSAGE_ACTION"}(le||(le={})),function(e){e.Create="CREATE",e.Creating="CREATING",e.Created="CREATED",e.Remove="REMOVE"}(ue||(ue={})),function(e){e.Fulfilled="FULFILLED",e.Pending="PENDING",e.Rejected="REJECTED",e.RejectedAndKnown="REJECTEDANDKNOWN"}(ce||(ce={}));const he="layer_of_showOnMap_action_",ye="layer_of_addToMap_action_";class pe{constructor(e){this.clickHighlightEnabled=!0,this.cacheListeners=[],this.restoreListeners=[],this.selectedFeaturesChangeListeners=[],this.jimuLayerViewCreatedListeners=[],this.selectByQueryProgressChangeListeners=[],this.popupFeaturesFromSelection=!1,this.showPopupUponSelection=!1,this.getJimuLayerViewIdByJimuLayerId=e=>`${this.id}-${e}`,this.getJimuLayerViewIdByAPILayer=e=>this.getJimuLayerViewIdByJimuLayerId(l.dataSourceUtils.getJimuLayerIdByJSAPILayer(e)),this.id=e.mapWidgetId+"-"+e.dataSourceId,this.mapWidgetId=e.mapWidgetId,this.isActive=e.isActive,this.dataSourceId=e.dataSourceId,this.view=e.view,this.mapViewManager=e.mapViewManager,this.jimuLayerViews={},this.status=l.JimuMapViewStatus.Loading,this.view&&(this.view.popupEnabled=void 0===e.isEnablePopup||null===e.isEnablePopup||e.isEnablePopup),this.showOnMapDatas={},this.jimuMapTools=[],this.jimuLayerViewLoadPromises={},this.initView(this.view),(0,l.observeStore)(this.onStoreChange.bind(this),["dataSourcesInfo"]),this.watchPopupFeaturesAndSelectedFeature()}watchPopupFeaturesAndSelectedFeature(){return de(this,void 0,void 0,(function*(){const e=yield(0,l.loadArcGISJSAPIModule)("esri/core/reactiveUtils");this.watchPopupFeaturesHandle&&(this.watchPopupFeaturesHandle.remove(),this.watchPopupFeaturesHandle=null),this.watchPopupSelectedHandle&&(this.watchPopupSelectedHandle.remove(),this.watchPopupSelectedHandle=null),this.watchPopupFeaturesHandle=e.watch((()=>{var e;return null===(e=this.view.popup)||void 0===e?void 0:e.features}),(e=>{this.popupFeaturesFromSelection=null==e?void 0:e.fromSelection})),this.watchPopupSelectedHandle=e.watch((()=>{var e;return null===(e=this.view.popup)||void 0===e?void 0:e.selectedFeature}),(()=>{var e,t;if(!this.popupFeaturesFromSelection)return;const i=null===(e=this.view)||void 0===e?void 0:e.popup;if(i&&i.selectedFeature){const e=i.selectedFeature.geometry;let r=null;e&&(r="esri.geometry.Point"===e.declaredClass?e.clone():null===(t=e.extent)||void 0===t?void 0:t.center),r&&(i.location=r)}}))}))}handlePopupOnSelectionChange(e,t){var i;return de(this,void 0,void 0,(function*(){const r=null===(i=this.view)||void 0===i?void 0:i.popup;if(r)if(this.isAutoShowPopupWhenSelectFeatures()&&!this.isMapWidgetActive())yield this.updatePopupFeaturesWhenSelectionChange(r,e,t);else if(r.visible){const t=r.selectedFeature;if(t&&(e.layer&&t.layer===e.layer||e.layer&&t.sourceLayer===e.layer||e.id&&t.jimuLayerViewId===e.id)){const i=t.getObjectId();(yield e.getSelectedFeatures()).some((e=>e.getObjectId()===i))||this.closePopup()}}}))}updatePopupFeaturesWhenSelectionChange(e,t,i){return de(this,void 0,void 0,(function*(){if(!e)return;if(!e.visible&&i)return void(this.popupFeaturesFromSelection&&this.closePopup());let r=yield this.getSelectedFeatures();const s=e.selectedFeature,a=s&&s.jimuLayerViewId;let n=null;if(i?a&&(n=a):n=t.id,n){const e=[],t=[];r.forEach((i=>{i.jimuLayerViewId===n?e.push(i):t.push(i)})),r=[...e,...t]}if(s&&r.length>0&&(a&&a===n||!n)){let e=r.indexOf(s);if(e<0){const t=s.getObjectId();if(t>=0){const i=r.length;for(let s=0;s<i;s++)if(r[s].getObjectId()===t){e=s;break}}}e>=0&&(r.splice(e,1),r.unshift(s))}r.length>0?(r.fromSelection=!0,this.view.openPopup({features:r})):this.closePopup()}))}closePopup(){if(this.view){const e=this.view.popup;e&&(e.features=[]),this.view.closePopup()}}isAutoShowPopupWhenSelectFeatures(){return this.view.popupEnabled&&this.showPopupUponSelection}setShowPopupUponSelection(e){this.showPopupUponSelection=!!e}isPopupFeaturesFromSelection(){return this.popupFeaturesFromSelection}getSelectedFeatures(){return de(this,void 0,void 0,(function*(){const e=[],t=Object.values(this.jimuLayerViews),i=[];if(t.forEach((e=>{const t=e;if(t.getSelectedFeatures){const e=t.getSelectedFeatures();i.push(e)}})),i.length>0){const t=yield Promise.all(i);t.length>0&&t.forEach((t=>{t&&t.length>0&&t.forEach((t=>{e.push(t)}))}))}return e}))}getSelectedFeatureCount(){let e=0;return Object.values(this.jimuLayerViews).forEach((t=>{const i=t;i.getSelectedFeatureCount&&(e+=i.getSelectedFeatureCount())})),e}addJimuMapTool(e){this.jimuMapTools.find((t=>t.name===e.name))||this.jimuMapTools.push(e)}deleteJimuMapTool(e){this.jimuMapTools.find((t=>t.name===e))&&(this.jimuMapTools=this.jimuMapTools.filter((t=>t.name!==e)))}enableClickOpenPopup(){this.view.popupEnabled=!0}disableClickOpenPopup(){this.view.popupEnabled=!1}isClickOpenPopupEnabled(){return this.view.popupEnabled}enableClickHighlight(){this.clickHighlightEnabled=!0}disableClickHighlight(){this.clickHighlightEnabled=!1}isClickHighlightEnabled(){return this.clickHighlightEnabled}setIsActive(e){this.isActive=e,this.mapViewManager.setJimuMapView(this)}setMapWidgetState(e){this.mapWidgetState=e}isMapWidgetActive(){return this.mapWidgetState===l.WidgetState.Active}initView(e){e&&e.when((()=>{e.on("click",this.onClick.bind(this))}))}onClick(e){const t={x:e.x,y:e.y},i=this.view.toMap(t);i&&(l.MessageManager.getInstance().publishMessage(new l.LocationChangeMessage(this.mapWidgetId,i.toJSON())),this.view.hitTest(t).then((e=>{if(!this.isClickHighlightEnabled())return;const t=e.results.filter((e=>"graphic"===e.type));this.selectDataSourceOrFeatureByFeatures(this.isClickOpenPopupEnabled(),t.map((e=>e.graphic)),i)}),(()=>{this.clearAllJimuLayerViewsSelectRecord()})))}selectDataSourceOrFeatureByFeatures(e,t,i){return de(this,void 0,void 0,(function*(){if(yield this.clearAllJimuLayerViewsSelectRecord(),l.MessageManager.getInstance().publishMessage(new l.DataRecordsSelectionChangeMessage(this.mapWidgetId,[])),e)return;const r=t.find((e=>(e.layer.type===o.FeatureLayer||e.layer.type===o.SceneLayer)&&e.layer.popupEnabled));if(!r)return void this.tryIdentifyClickedFeature(i);const s=this.getJimuLayerViewIdByAPILayer(r.layer),a=this.jimuLayerViews[s];if(!a)return;const n=r.attributes[r.layer.objectIdField];if(a.isLayerDataSourceUsed()){const e=a.getLayerDataSource()||(yield a.createLayerDataSource()),t=yield e.queryById(n+"");l.MessageManager.getInstance().publishMessage(new l.DataRecordsSelectionChangeMessage(this.mapWidgetId,[t])),yield a.selectFeatureById(n,t)}else yield a.selectFeatureById(n)}))}isMapServiceLayerPopupEnabled(e){var t;if(e.popupEnabled){const i=null===(t=e.sublayers)||void 0===t?void 0:t.toArray();if(i&&i.length>0)return i.some((e=>e.popupEnabled))}return!1}tryIdentifyClickedFeature(e){var t,i;let r=null;const s=this.view.map.layers.toArray().reverse(),a=Object.values(this.jimuLayerViews);for(let e=0;e<s.length;e++){const n=s[e];if(n.type===o.MapImageLayer||n.type===o.TileLayer){const e=n;if((null===(i=null===(t=e.capabilities)||void 0===t?void 0:t.operations)||void 0===i?void 0:i.supportsIdentify)&&this.isMapServiceLayerPopupEnabled(e)){const e=a.find((e=>e.layer===n));if(e){r=e;break}}}}if(r)return c(["esri/rest/identify","esri/rest/support/IdentifyParameters"]).then((([t,i])=>{const s=this.getAllChildJimuLayerViews(r.id).filter((e=>e.layer.popupEnabled)).map((e=>e.layer.id)),a=new i;a.tolerance=3,a.layerIds=s,a.layerOption="top",a.width=this.view.width,a.height=this.view.height,a.geometry=e,a.mapExtent=this.view.extent,a.returnFieldName=!0,a.returnGeometry=!0,a.returnUnformattedValues=!0,t.identify(r.layer.url,a).then((e=>de(this,void 0,void 0,(function*(){var t;const i=e.results[0];if(!i)return;const s=`${r.id}-${i.layerId}`,a=this.jimuLayerViews[s];if(a)if(a.isLayerDataSourceUsed()||a.getLayerDataSource()){const e=null===(t=a.getLayerDataSource())||void 0===t?void 0:t.buildRecord(i.feature);a.selectFeatureById(Number(e.getId()),e),l.MessageManager.getInstance().publishMessage(new l.DataRecordsSelectionChangeMessage(this.mapWidgetId,[e]))}else a.selectFeatureById(i.feature.attributes[a.layer.objectIdField],i.feature)}))))}))}getJimuLayerViewByAPILayer(e){return Object.values(this.jimuLayerViews).find((t=>t.layer===e))}clearAllJimuLayerViewsSelectRecord(){return de(this,void 0,void 0,(function*(){const e=this.jimuLayerViews,t=Object.keys(e),i=[];for(let r=0;r<t.length;r++){const s=e[t[r]];if(s.type===o.FeatureLayer||s.type===o.SceneLayer){const e=s.selectFeaturesByIds&&s.selectFeaturesByIds([]);i.push(e)}}i.length>0&&(yield Promise.all(i))}))}addJimuLayerView(e){this.jimuLayerViews[e.id]=e}whenJimuMapViewLoaded(){return de(this,void 0,void 0,(function*(){return this.jimuMapViewLoadPromise?this.jimuMapViewLoadPromise:this.view?(this.jimuMapViewLoadPromise=this.view.when().then((()=>de(this,void 0,void 0,(function*(){return this.startCreateJimuLayerViews(),this.status=l.JimuMapViewStatus.Loaded,this.mapViewManager.setJimuMapView(this),Promise.resolve(this)}))),(e=>de(this,void 0,void 0,(function*(){return console.error(e),this.status=l.JimuMapViewStatus.Failed,this.mapViewManager.setJimuMapView(this),Promise.reject(this)})))),this.jimuMapViewLoadPromise):(this.status=l.JimuMapViewStatus.Failed,this.mapViewManager.setJimuMapView(this),this.jimuMapViewLoadPromise=Promise.reject(this),this.jimuMapViewLoadPromise)}))}whenJimuLayerViewLoaded(e){return de(this,void 0,void 0,(function*(){if(this.jimuLayerViewLoadPromises[e])return this.jimuLayerViewLoadPromises[e];try{yield this.makeSureParentLayerViewsLoaded(e)}catch(e){console.log(e)}return this.jimuLayerViewLoadPromises[e]?this.jimuLayerViewLoadPromises[e]:Promise.reject(Error("Bad jimuLayerViewId:"+e))}))}whenJimuLayerViewLoadedByDataSource(e){return de(this,void 0,void 0,(function*(){const t=e.jimuLayerId;if(!t)return console.error("Can not find jimuLayerId in data source.",e.id),Promise.resolve(null);const i=this.getJimuLayerViewIdByJimuLayerId(t);return this.whenJimuLayerViewLoaded(i)}))}makeSureParentLayerViewsLoaded(e){return de(this,void 0,void 0,(function*(){const t=Object.keys(this.jimuLayerViewLoadPromises).length,i=Object.keys(this.jimuLayerViewLoadPromises).filter((t=>e.startsWith(t)));yield Promise.all(i),Object.keys(this.jimuLayerViewLoadPromises).length>t&&(yield this.makeSureParentLayerViewsLoaded(e))}))}whenAllJimuLayerViewLoaded(){return de(this,void 0,void 0,(function*(){const e={};return yield this.whenChildJimuLayerViewLoaded(null,e),e}))}whenChildJimuLayerViewLoaded(e,t){return de(this,void 0,void 0,(function*(){const i=yield Promise.all(this.getChildJimuLayerViewIds(e).map((e=>this.whenJimuLayerViewLoaded(e).then((i=>(t[e]=i,i))).catch((t=>(console.error("JimuLayerView fails.",e,t),null))))));yield Promise.all(i.filter((e=>e)).map((e=>this.whenChildJimuLayerViewLoaded(e.id,t))))}))}getParentJimuLayerViews(e){const t=[];let i=this.jimuLayerViews[e];for(;null==i?void 0:i.parentJimuLayerViewId;){const e=this.jimuLayerViews[i.parentJimuLayerViewId];t.push(e),i=e}return t}getAllChildJimuLayerViews(e){const t=[];return this.findChildLayerView(e,t),t}getChildJimuLayerViewIds(e){return Object.keys(this.jimuLayerViews).filter((t=>this.jimuLayerViews[t].parentJimuLayerViewId===e))}findChildLayerView(e,t){const i=this.jimuLayerViews,r=Object.keys(i);for(let s=0;s<r.length;s++)if(i[r[s]].parentJimuLayerViewId===e){const e=i[r[s]];t.push(e),this.findChildLayerView(e.id,t)}}startCreateJimuLayerViews(){return de(this,void 0,void 0,(function*(){Object.keys(this.jimuLayerViewLoadPromises).length>0||this.view.map.layers.toArray().reverse().forEach(((e,t)=>de(this,void 0,void 0,(function*(){try{this.createJimuLayerView(e,null,t)}catch(e){console.log("Create JimuLayerViews error.",e)}}))))}))}createJimuLayerView(e,t,i,r,s){var a,n,u;return de(this,void 0,void 0,(function*(){let c=null;const d=l.DataSourceManager.getInstance().getDataSource(this.dataSourceId),h=e.id+"",y=l.dataSourceUtils.getJimuLayerIdByJSAPILayer(e),p=`${this.id}-${y}`,g=t?this.getJimuLayerViewIdByJimuLayerId(t):null;let m=(null==r?void 0:r.id)||(null==d?void 0:d.getDataSourceIdByLayer(e));if(!m&&s&&g){const e=this.jimuLayerViews[g],t=e&&e.getLayerDataSource();t&&t.getChildDataSourceId&&(m=t.getChildDataSourceId(i.toString()))}m||(m="");const v={id:p,jimuLayerId:y,layerDataSourceId:m,jimuMapViewId:this.id,parentJimuLayerViewId:g,mapViewManager:this.mapViewManager,index:i,fromRuntime:s};if("esri.layers.support.Sublayer"===e.declaredClass){const t=e,i=(null===(a=t.sourceJSON)||void 0===a?void 0:a.layerType)||(null===(n=t.sourceJSON)||void 0===n?void 0:n.type);i===l.SupportedLayerServiceTypes.GroupLayer?(null===(u=t.sublayers)||void 0===u?void 0:u.length)>0&&(Object.assign(v,{type:o.GroupLayer,layer:t}),c=new re(v)):i===l.SupportedLayerServiceTypes.FeatureLayer?(Object.assign(v,{type:o.FeatureLayer,layer:t}),c=new ee(v)):"Raster Layer"===i?(Object.assign(v,{type:t.type,layer:t}),c=new z(v)):console.log("Unsupported sub layer type.",h)}else{const t=e;switch(t.type){case o.SceneLayer:Object.assign(v,{type:t.type,layer:t}),c=new te(v);break;case o.FeatureLayer:Object.assign(v,{type:t.type,layer:t}),c=new ee(v);break;case o.MapImageLayer:case o.TileLayer:Object.assign(v,{type:t.type,layer:t}),t.type===o.MapImageLayer&&(c=new oe(v)),t.type===o.TileLayer&&(c=new ne(v));break;case o.GroupLayer:Object.assign(v,{view:null,type:t.type,layer:t}),c=new re(v);break;case o.SubtypeGroupLayer:Object.assign(v,{type:t.type,layer:t}),c=new se(v);break;default:Object.assign(v,{type:t.type,layer:t}),c=new z(v)}}if(c){this.addJimuLayerView(c);const e="esri.layers.support.Sublayer"===c.layer.declaredClass||c.type===o.GroupLayer||"esri.layers.support.SubtypeSublayer"===c.layer.declaredClass?Promise.resolve(null):this.view.whenLayerView(c.layer);return this.jimuLayerViewLoadPromises[p]=e.then((e=>(c.view=e,c.ready()))).then((e=>(e.isLoaded=!0,setTimeout((()=>{this.onJimuLayerViewCreated(e)}),0),e))),c}return Promise.resolve(null)}))}onStoreChange(e,t){Object.keys(t||{}).forEach((i=>{if(t[i].instanceStatus===l.DataSourceStatus.Created&&(!(null==e?void 0:e[i])||e[i].instanceStatus!==l.DataSourceStatus.Created)){const e=l.DataSourceManager.getInstance().getDataSource(i),t=Object.keys(this.jimuLayerViews).find((t=>!this.jimuLayerViews[t].layerDataSourceId&&this.jimuLayerViews[t].jimuLayerId===(null==e?void 0:e.jimuLayerId)));t&&(this.jimuLayerViews[t].layerDataSourceId=e.id)}}))}clearSelectedFeatures(){this.clearAllJimuLayerViewsSelectRecord(),l.MessageManager.getInstance().publishMessage(new l.DataRecordsSelectionChangeMessage(this.mapWidgetId,[]))}selectFeaturesByGraphic(e,t,i){return de(this,void 0,void 0,(function*(){return c(["esri/geometry/geometryEngine"]).then((r=>de(this,void 0,void 0,(function*(){const s=r[0];let a=e.geometry;if("point"===a.type||"polyline"===a.type){const e=2.54*this.view.scale/9600;a=s.buffer(a,10*e,"meters")}const n={geometry:a,spatialRelationship:t,returnGeometry:!0,returnZ:!0,outFields:["*"]},l=this.jimuLayerViews,u=Object.keys(l),c=[];for(let e=0;e<u.length;e++){const t=l[u[e]];if((t.type===o.FeatureLayer||t.type===o.SceneLayer)&&t.selectFeaturesByQuery){const e=t.selectFeaturesByQuery(n,i);c.push(e)}}return this.onSelectByQueryProgressChange(),Promise.all(c)}))))}))}cancelSelectByQuery(){const e=this.jimuLayerViews,t=Object.keys(e);for(let i=0;i<t.length;i++){const r=e[t[i]];r.type!==o.FeatureLayer&&r.type!==o.SceneLayer||r.cancelSelectByQuery&&r.cancelSelectByQuery()}}getSelectByQueryProgress(){const e=[],t=this.jimuLayerViews,i=Object.keys(t);for(let r=0;r<i.length;r++){const s=t[i[r]];if((s.type===o.FeatureLayer||s.type===o.SceneLayer)&&s.getSelectQueryProgress){const t=s.getSelectQueryProgress();e.push(t)}}if(0===e.length)return 1;{let t=e.reduce(((e,t)=>e+t));return t/=e.length,t=Math.max(0,Math.min(t,1)),t}}destroy(){this.cacheListeners=[],this.restoreListeners=[],this.selectedFeaturesChangeListeners=[],this.jimuLayerViewCreatedListeners=[],this.selectByQueryProgressChangeListeners=[],this.watchPopupFeaturesHandle&&(this.watchPopupFeaturesHandle.remove(),this.watchPopupFeaturesHandle=null),this.watchPopupSelectedHandle&&(this.watchPopupSelectedHandle.remove(),this.watchPopupSelectedHandle=null);const e=this.id,t=l.MutableStoreManager.getInstance().getStateValue([this.mapWidgetId])||{},i=t.addToMapDatas,r=t.showOnMapDatas;i&&Object.keys(i).forEach((t=>{const r=i[t];r&&r.mapWidgetId===this.mapWidgetId&&r.jimuMapViewId===e&&delete i[t]})),r&&Object.keys(r).forEach((t=>{const i=r[t];i&&i.mapWidgetId===this.mapWidgetId&&i.jimuMapViewId===e&&delete r[t]}));const s=this.jimuLayerViews,a=Object.keys(s);for(let e=0;e<a.length;e++)s[a[e]].destroy();this.view&&(this.view.destroyed||(this.view.graphics&&this.view.graphics.destroyed&&this.view.graphics.destroy(),this.view.container=null,this.view.allLayerViews&&this.view.allLayerViews.destroyed&&this.view.allLayerViews.destroy(),this.view.layerViews&&this.view.layerViews.destroyed&&this.view.layerViews.destroy(),this.jimuMapTools=[],this.view.destroy(),this.view=null))}_getDefaultJimuMapViewId(){const e=(0,l.getAppStore)().getState().jimuMapViewsInfo;return Object.keys(e||{}).find((t=>e[t].mapWidgetId===this.mapWidgetId))}drawDataOnMap(e){const t=[];Object.entries(e).forEach((e=>{const i=e[0],r=e[1];let s=r.jimuMapViewId;if(s||r.mapWidgetId!==this.mapWidgetId||(s=this._getDefaultJimuMapViewId()),s===this.id){let e=null;e=this.showOnMapDatas[i]?this.updateDrawnDataRecordSet(r.dataSet,i,r.title,r.symbolOption):this.drawDataRecordSet(r.dataSet,i,r.title,r.symbolOption),r.type===le.DataAction&&t.push(e),this.showOnMapDatas[i]=r}})),Object.entries(this.showOnMapDatas).forEach((t=>{const i=t[0];if(!e[i]){const e=this.view.map.findLayerById(i);delete this.showOnMapDatas[i],e&&this.view.map.remove(e)}})),Promise.all(t).then((e=>{const t=e.flat();t.length>0&&y(this.view,t,{padding:{left:50,right:50,top:50,bottom:50}})}))}drawDataRecordSet(e,t,i,r){return de(this,void 0,void 0,(function*(){return c(["esri/layers/GraphicsLayer"]).then((s=>de(this,void 0,void 0,(function*(){const[a]=s,n=yield this.getGraphicsFromRecords(e,r),o=new a({id:t,title:i,listMode:"hide",graphics:n});return this.view.map.add(o),n})))).catch((e=>(console.warn(e),[])))}))}updateDrawnDataRecordSet(e,t,i,r){var s;return de(this,void 0,void 0,(function*(){const i=this.view.map.findLayerById(t);let a=[];if(i){let n=!1;const o=e.records||[],l=(null===(s=this.showOnMapDatas[t])||void 0===s?void 0:s.dataSet.records)||[];n=(null==o?void 0:o.length)!==(null==l?void 0:l.length)||o.some(((e,t)=>{var i;return e.getId()!==(null===(i=l[t])||void 0===i?void 0:i.getId())})),n&&(i.removeAll(),a=yield this.getGraphicsFromRecords(e,r),i.addMany(a))}return a}))}getGraphicsFromRecords(e,t){return de(this,void 0,void 0,(function*(){return c(["esri/symbols/support/symbolUtils","esri/symbols/support/jsonUtils"]).then((i=>de(this,void 0,void 0,(function*(){const[r,s]=i,a=yield G(e),n=a.features.map((i=>de(this,void 0,void 0,(function*(){if(!i.symbol){const a=e.dataSource.getGeometryType(),n=l.dataSourceUtils.changeRestAPIGeometryTypeToJSAPIGeometryType(a);let o;o="multipoint"===n?"point":"extent"===n?"polygon":n,i.symbol=yield this.getSymbol(r,s,i,o,t)}}))));return yield Promise.all(n),a.features})))).catch((e=>(console.warn(e),null)))}))}getSymbol(e,t,i,r,s){return de(this,void 0,void 0,(function*(){let a=null;return s?s.pointSymbol&&"point"===r?a=t.fromJSON(s.pointSymbol):s.polylineSymbol&&"polyline"===r?a=t.fromJSON(s.polylineSymbol):s.polygonSymbol&&"polygon"===r&&(a=t.fromJSON(s.polygonSymbol)):void 0===s?a=this.getDefaultSymbol(e,t,i,r):null===s&&(a=this.getDefaultSymbolByRenderer(e,t,i)),a||(a=this.getDefaultSymbol(e,t,i,r)),a}))}getDefaultSymbol(e,t,i,r){return de(this,void 0,void 0,(function*(){let s=k(r);if(s=t.fromJSON(s),(null==i?void 0:i.layer)&&"polyline"===r){const r=yield this.getDefaultSymbolByRenderer(e,t,i);r&&((null==r?void 0:r.color)?r.color=s.color:(null==r?void 0:r.material)&&(r.material.color=s.color),s=r)}return s}))}getDefaultSymbolByRenderer(e,t,i){var r,s,a,n,o,l,u,c,d,h,y;return de(this,void 0,void 0,(function*(){let p=null,g=null;try{g=yield e.getDisplayedSymbol(i)}catch(e){g=null,p=null}if(g&&(p=g,this.view&&"esri.views.MapView"===this.view.declaredClass))if("esri.symbols.PointSymbol3D"===g.declaredClass){const e={type:"esriSMS",color:[255,255,0,150],outline:{color:[255,255,0,150],width:1}},i=g.symbolLayers.toArray();if(i.length>0){const t=null===(s=null===(r=i[0].material)||void 0===r?void 0:r.color)||void 0===s?void 0:s.toJSON();t&&(e.color=t,e.outline.color=t)}p=t.fromJSON(e)}else if("esri.symbols.LineSymbol3D"===g.declaredClass){const e={type:"esriSLS",color:[255,255,0,150],width:1},i=g.symbolLayers.toArray();if(i.length>0){const t=i.find((e=>"esri.symbols.LineSymbol3DLayer"===e.declaredClass));if(t){const i=null===(n=null===(a=t.material)||void 0===a?void 0:a.color)||void 0===n?void 0:n.toJSON();i&&(e.color=i),t.size>0&&(e.width=t.size)}else{const t=null===(l=null===(o=i[0].material)||void 0===o?void 0:o.color)||void 0===l?void 0:l.toJSON();t&&(e.color=t)}}p=t.fromJSON(e)}else if("esri.symbols.PolygonSymbol3D"===g.declaredClass){const e={type:"esriSFS",color:[255,255,0,150],outline:{color:[255,255,0,150],width:1}},i=g.symbolLayers.toArray();if(i.length>0){const t=i.find((e=>"esri.symbols.FillSymbol3DLayer"===e.declaredClass)),r=i.find((e=>"esri.symbols.ExtrudeSymbol3DLayer"===e.declaredClass));if(t){const i=null===(c=null===(u=t.material)||void 0===u?void 0:u.color)||void 0===c?void 0:c.toJSON();if(i&&(e.color=i,e.outline.color=i),t.outline){const i=null===(d=t.outline.color)||void 0===d?void 0:d.toJSON();i&&(e.outline.color=i),t.outline.size>0&&(e.outline.width=t.outline.size)}}else if(r){const t=null===(y=null===(h=r.material)||void 0===h?void 0:h.color)||void 0===y?void 0:y.toJSON();t&&(e.color=t,e.outline.color=t)}}p=t.fromJSON(e)}return p}))}addOrRemoveDataOnMap(e){Object.entries(e).forEach((t=>{const i=t[0],r=t[1];let s=r.jimuMapViewId;if(s||r.mapWidgetId!==this.mapWidgetId||(s=this._getDefaultJimuMapViewId()),s===this.id&&r.dataChangeType===ue.Create){if(r.dataChangeType===ue.Create){r.dataChangeType=ue.Creating;const e=i;this.addLayerToMap(r.dataSourceId,i).then((()=>{const t=l.MutableStoreManager.getInstance().getStateValue([this.mapWidgetId,"addToMapDatas",`${e}`]);l.MutableStoreManager.getInstance().updateStateValue(this.mapWidgetId,`addToMapDatas.${e}`,Object.assign(Object.assign({},t),{dataChangeType:ue.Created,dataChangeStatus:ce.Fulfilled}))})).catch((t=>{l.MutableStoreManager.getInstance().updateStateValue(this.mapWidgetId,`addToMapDatas.${e}.dataChangeStatus`,ce.Rejected),setTimeout((()=>{l.MutableStoreManager.getInstance().updateStateValue(this.mapWidgetId,`addToMapDatas.${e}.dataChangeStatus`,ce.RejectedAndKnown)}),3e3)}))}}else s===this.id&&r.dataChangeType===ue.Remove&&(this.removeLayerFromMap(i),delete e[i])}))}addLayerToMap(e,t){return de(this,void 0,void 0,(function*(){const i=l.DataSourceManager.getInstance().getDataSource(e),r=yield null==i?void 0:i.createJSAPILayerByDataSource();return r.id=t,this.view.map.add(r),yield this.createJimuLayerView(r,null,this.getMaxLayerIndex(),i,!0)}))}getMaxLayerIndex(){let e=0;return Object.keys(this.jimuLayerViews).filter((e=>!this.jimuLayerViews[e].parentJimuLayerViewId)).forEach((t=>{e=Math.max(this.jimuLayerViews[t].index,e)})),e}removeLayerFromMap(e){const t=this.view.map.findLayerById(e);t&&this.view.map.remove(t)}isDestroyed(){return!this.view||this.view.destroyed}isCached(){var e;const t=null===(e=this.view)||void 0===e?void 0:e.container;return t&&!document.body.contains(t)}addCacheListener(e){this.cacheListeners.includes(e)||this.cacheListeners.push(e)}removeCacheListener(e){const t=this.cacheListeners.indexOf(e);t>=0&&this.cacheListeners.splice(t,1)}onCache(){this.cacheListeners.forEach((e=>{try{e(this)}catch(t){console.error("JimuMapView onCache listener error",this.id,e,t)}}))}addRestoreListener(e){this.restoreListeners.includes(e)||this.restoreListeners.push(e)}removeRestoreListener(e){const t=this.restoreListeners.indexOf(e);t>=0&&this.restoreListeners.splice(t,1)}onRestore(){this.restoreListeners.forEach((e=>{try{e(this)}catch(t){console.error("JimuMapView onRestore listener error",this.id,e,t)}}))}addJimuLayerViewSelectedFeaturesChangeListener(e){this.selectedFeaturesChangeListeners.includes(e)||this.selectedFeaturesChangeListeners.push(e)}removeJimuLayerViewSelectedFeaturesChangeListener(e){const t=this.selectedFeaturesChangeListeners.indexOf(e);t>=0&&this.selectedFeaturesChangeListeners.splice(t,1)}onJimuLayerViewSelectedFeaturesChange(e,t){return de(this,void 0,void 0,(function*(){this.selectedFeaturesChangeListeners.forEach((t=>{try{t(e)}catch(e){console.error("onJimuLayerViewSelectedFeaturesChange listener error",this.id,t,e)}})),yield this.handlePopupOnSelectionChange(e,t)}))}addSelectByQueryProgressChangeListener(e){this.selectByQueryProgressChangeListeners.includes(e)||this.selectByQueryProgressChangeListeners.push(e)}removeSelectByQueryProgressChangeListener(e){const t=this.selectByQueryProgressChangeListeners.indexOf(e);t>=0&&this.selectByQueryProgressChangeListeners.splice(t,1)}onSelectByQueryProgressChange(){const e=this.getSelectByQueryProgress();this.selectByQueryProgressChangeListeners.forEach((t=>{try{t(e)}catch(e){console.error("onSelectByQueryProgressChange listener error",this.id,t,e)}}))}addJimuLayerViewCreatedListener(e){this.jimuLayerViewCreatedListeners.includes(e)||this.jimuLayerViewCreatedListeners.push(e)}removeJimuLayerViewCreatedListener(e){const t=this.jimuLayerViewCreatedListeners.indexOf(e);t>=0&&this.jimuLayerViewCreatedListeners.splice(t,1)}onJimuLayerViewCreated(e){this.jimuLayerViewCreatedListeners.forEach((t=>{try{t(e)}catch(e){console.error("onJimuLayerViewCreated listener error",this.id,t,e)}}))}}class ge{constructor(e){this.switchMap=(e=!1)=>{return t=this,i=void 0,s=function*(){if(this.mapWidgetInstance)return yield this.mapWidgetInstance.switchMap(e);yield Promise.resolve()},new((r=void 0)||(r=Promise))((function(e,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function o(e){try{l(s.throw(e))}catch(e){a(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof r?i:new r((function(e){e(i)}))).then(n,o)}l((s=s.apply(t,i||[])).next())}));var t,i,r,s},this.fullScreenMap=()=>{this.mapWidgetInstance&&this.mapWidgetInstance.fullScreenMap()},this.mapWidgetId=e,this.jimuMapViews={}}setMapWidgetInstance(e){this.mapWidgetInstance=e}addJimuMapView(e){this.jimuMapViews[e.id]=e}setJimuMapView(e){this.jimuMapViews[e.id]=e}removeJimuMapView(e){delete this.jimuMapViews[e.id]}getActiveJimuMapView(){const e=Object.keys(this.jimuMapViews);for(let t=0;t<e.length;t++)if(this.jimuMapViews[e[t]].isActive)return this.jimuMapViews[e[t]];return null}showMapTools(){this.getAllJimuMapViews().forEach((e=>{const t=e.view;t&&t.showMapTools&&t.showMapTools()}))}hideMapTools(){this.getAllJimuMapViews().forEach((e=>{const t=e.view;t&&t.hideMapTools&&t.hideMapTools()}))}getAllJimuMapViews(){return Object.keys(this.jimuMapViews).map((e=>this.jimuMapViews[e]))}}class me{constructor(){this.jimuMapViewGroups={}}static getInstance(){return window.jimuConfig.isBuilder?window._appWindow&&window._appWindow._mapViewManager:(me._instance||(me._instance=new me,window._mapViewManager=me._instance),me._instance)}getJimuMapViewById(e){const t=Object.keys(this.jimuMapViewGroups);if(0===t.length)return null;for(let i=0;i<t.length;i++){const r=t[i];if(Object.keys(this.jimuMapViewGroups[r].jimuMapViews).includes(e))return this.jimuMapViewGroups[r].jimuMapViews[e]}return null}getJimuMapViewGroup(e){return this.jimuMapViewGroups[e]?this.jimuMapViewGroups[e]:null}createJimuMapView(e){return t=this,i=void 0,s=function*(){const t=e.mapWidgetId+"-"+e.dataSourceId;if(this.getJimuMapViewById(t))return yield Promise.resolve(this.getJimuMapViewById(t));const i=new pe(e);return this.addJimuMapView(i),yield i.whenJimuMapViewLoaded()},new((r=void 0)||(r=Promise))((function(e,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function o(e){try{l(s.throw(e))}catch(e){a(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof r?i:new r((function(e){e(i)}))).then(n,o)}l((s=s.apply(t,i||[])).next())}));var t,i,r,s}addJimuMapView(e){if(this.jimuMapViewGroups[e.mapWidgetId])this.jimuMapViewGroups[e.mapWidgetId].addJimuMapView(e);else{const t=new ge(e.mapWidgetId);t.addJimuMapView(e),this.jimuMapViewGroups[e.mapWidgetId]=t}(0,l.getAppStore)().dispatch(l.appActions.jimuMapViewAdded(e.id,(0,l.Immutable)({id:e.id,mapWidgetId:e.mapWidgetId,dataSourceId:e.dataSourceId,status:e.status})))}setJimuMapView(e){if(this.jimuMapViewGroups[e.mapWidgetId])this.jimuMapViewGroups[e.mapWidgetId].setJimuMapView(e);else{const t=new ge(e.mapWidgetId);t.addJimuMapView(e),this.jimuMapViewGroups[e.mapWidgetId]=t}(0,l.getAppStore)().dispatch(l.appActions.jimuMapViewUpdated(e.id,(0,l.Immutable)({id:e.id,mapWidgetId:e.mapWidgetId,dataSourceId:e.dataSourceId,isActive:e.isActive,status:e.status})))}destroyJimuMapView(e){const t=this.getJimuMapViewById(e);t&&t.destroy();const i=Object.keys(this.jimuMapViewGroups);if(0===i.length);else for(let t=0;t<i.length;t++){const r=i[t];if(Object.keys(this.jimuMapViewGroups[r].jimuMapViews).includes(e)){delete this.jimuMapViewGroups[r].jimuMapViews[e],0===Object.keys(this.jimuMapViewGroups[r].jimuMapViews).length&&delete this.jimuMapViewGroups[r],(0,l.getAppStore)().dispatch(l.appActions.jimuMapViewRemoved(e));break}}}getAllJimuMapViewIds(){const e=[];return Object.keys(this.jimuMapViewGroups).forEach((t=>{Object.keys(this.jimuMapViewGroups[t].jimuMapViews).forEach((t=>{e.push(t)}))})),e}destroyAllJimuMapViews(){this.getAllJimuMapViewIds().forEach((e=>{this.destroyJimuMapView(e)}))}}var ve=s(796),fe=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};const{loadModules:we,resolveModuleFullPath:Se}=l.moduleLoader,{getPortalProxyUrl:Ie,getStandardPortalUrl:Le,isAGOLDomain:Me,isSamePortalUrl:Ve,getPlatformUrlByOrgUrl:be}=l.portalUrlUtils,{normalize:Ce,getFolder:Fe,getFixedRootPath:Pe}=l.urlUtils,{removeFromLocalStorage:je,removeFromSessionStorage:De}=l.utils;let Ae,Je,Oe,xe;class Te{constructor(){this.id="arcgis-dependency-define"}getDependencyKey(){return"jimu-arcgis"}getResources(){this.themeLoadObserver||(this.themeLoadObserver=ve.ThemeStore.subscribe(this.onCurrentThemeLoad.bind(this)));let e=window.jimuConfig.arcgisJsApiUrl;if((0,l.getAppStore)().getState().queryObject.apiurl&&(e=(0,l.getAppStore)().getState().queryObject.apiurl,!this.checkApiUrl(e)))return void console.log("Bad apiurl.",e);/\/$/.test(e)||(e+="/"),window.jimuConfig.arcgisJsApiUrl=e;const t=[{url:`${e}init.js`}];(0,ve.getTheme)()&&((0,ve.getTheme)().darkTheme?(document.body.classList.add("calcite-mode-dark"),t.push({url:this.getAPIThemeUrl(e,!0)})):t.push({url:this.getAPIThemeUrl(e,!1)}));const i=`${Pe()}arcgis-amd-packages/`;return window.dojoConfig={packages:[{name:"arcgis-charts-js",location:i+"arcgis-charts-js",main:"index"},{name:"arcgis-charts-shared-utils",location:i+"arcgis-charts-shared-utils",main:"index"},{name:"arcgis-charts-components",location:i+"arcgis-charts-components",main:"index"},{name:"analysis-components",location:i+"analysis-components",main:"index"},{name:"analysis-core",location:i+"analysis-core",main:"index"},{name:"analysis-shared-utils",location:i+"analysis-shared-utils",main:"index"},{name:"analysis-tool-app",location:i+"analysis-tool-app",main:"index"}]},[{url:"jimu-arcgis",dependencies:t}]}postInit(){var e,t,i;return fe(this,void 0,void 0,(function*(){yield this.initModules(),this.initToRegistOAuthForMainPortalAndAGOL();const r=(0,l.getAppStore)().getState().portalUrl;xe.setLocale((0,l.getAppStore)().getState().appContext.locale),Oe.request.proxyUrl=Ie(r),this.initInterceptor(),Oe.portalUrl=r,Oe.userPrivilegesApplied=!1;const s=null===(i=null===(t=null===(e=(0,l.getAppStore)().getState().portalSelf)||void 0===e?void 0:e.helperServices)||void 0===t?void 0:t.geometry)||void 0===i?void 0:i.url;s&&(Oe.geometryServiceUrl=s),this.addToTrustedServers(),(window.jimuConfig.isBuilder||window.jimuConfig.isInBuilder)&&(window.jimuConfig.isDevEdition||window.jimuConfig.isInPortal)?this.replaceGetCredential():this.replaceGetCredential(!1)}))}initModules(){return fe(this,void 0,void 0,(function*(){[Je,Ae,Oe,xe]=yield we(["esri/identity/IdentityManager","esri/identity/OAuthInfo","esri/config","esri/intl","esri/core/Error"])}))}initInterceptor(){var e;l.requestUtils.registerCacheableUrl(Ee),l.requestUtils.registerCacheableUrl(Re),l.requestUtils.registerCacheableUrl(Be),null===(e=Oe.request.interceptors)||void 0===e||e.push({before:e=>{var t,i,r;if(!l.requestUtils.isURLCacheable(e.url,null===(t=e.requestOptions)||void 0===t?void 0:t.query))return;const s=l.requestUtils.getRequestCache(e.url,null===(i=e.requestOptions)||void 0===i?void 0:i.query);if(s)return s.promise;{const t=new l.ExternalResolvablePromise;l.requestUtils.setRequestCache(e.url,null===(r=e.requestOptions)||void 0===r?void 0:r.query,t)}},after:e=>{var t,i,r,s,a,n;if(!e||!e.url)return;if(e.url.indexOf("/rest/info")&&(null===(t=e.data)||void 0===t?void 0:t.owningSystemUrl)&&this.registOAuthInfo(e.data.owningSystemUrl),!l.requestUtils.isURLCacheable(e.url,null===(i=e.requestOptions)||void 0===i?void 0:i.query))return;const o=l.requestUtils.getRequestCache(e.url,null===(r=e.requestOptions)||void 0===r?void 0:r.query);if(o&&(o.resolve(e.data),null===(s=e.data)||void 0===s?void 0:s.editingInfo)){const t=l.DataSourceManager.getInstance().getDataSources(),i=Object.keys(t).filter((i=>t[i].url===e.url)).map((e=>t[e]));i.length>0?i.find((e=>e.getAutoRefreshInterval&&e.getAutoRefreshInterval()>0))&&l.requestUtils.deleteRequestCache(e.url,null===(a=e.requestOptions)||void 0===a?void 0:a.query):l.requestUtils.deleteRequestCache(e.url,null===(n=e.requestOptions)||void 0===n?void 0:n.query)}},error:e=>{var t,i,r,s,a,n;const o=l.requestUtils.getRequestCache(null===(t=null==e?void 0:e.details)||void 0===t?void 0:t.url,null===(r=null===(i=null==e?void 0:e.details)||void 0===i?void 0:i.requestOptions)||void 0===r?void 0:r.query);o&&(o.reject(e),l.requestUtils.deleteRequestCache(null===(s=null==e?void 0:e.details)||void 0===s?void 0:s.url,null===(n=null===(a=null==e?void 0:e.details)||void 0===a?void 0:a.requestOptions)||void 0===n?void 0:n.query))}})}replaceGetCredential(e=!0){const t=l.SessionManager.getInstance(),i=Je.getCredential;let r;Je.getCredential=(s,a)=>{try{const n=!!t.getServerKeyFromUrl(s),o=l.SessionManager.getInstance().getClientIdByUrl(s),u=(null==s?void 0:s.indexOf("/sharing/rest/portals/self"))>0;let c=null;if(!(null==a?void 0:a.prompt)||Je.findCredential(s)||t.getSessionByUrl(s)||(c=t.tryToPendingSignInDialog(s)),c)r=c.promise.then((()=>i.call(Je,s,a)));else if(n||o||!(null==a?void 0:a.prompt)||Je.findCredential(s)||Je.findOAuthInfo(s)||!e)r=i.call(Je,s,a);else{const e=Le(s);r=t.useDialogToSetClientIdToConnectiosOfAppConfigAndSignIn(e).then((()=>(this.registOAuthInfo(e),i.call(Je,s,a)))).catch((()=>i.call(Je,s,a)))}return r.then((e=>u?Promise.resolve(e):l.SessionManager.getInstance().isValidToken(s,e.token).then((r=>{var n;if(r.valid)return e;if(403===(null===(n=null==r?void 0:r.error)||void 0===n?void 0:n.code)){let r;return r="server"===e.scope?l.ServiceManager.getInstance().fetchArcGISServerInfo(e.server||"").then((e=>null==e?void 0:e.owningSystemUrl)):Promise.resolve(e.server),r.then((r=>fe(this,void 0,void 0,(function*(){if(!r)return i.call(Je,s,a);if(!t.getFlagForSignInAgainWhen403Error(r))return e;try{this.removePortalAndItsServerCredentials(s,e.userId,r)}catch(e){console.warn(null==e?void 0:e.message)}a.prompt=!0,Ve(be(r),be((0,l.getAppStore)().getState().portalUrl))&&(De("esriJSAPIOAuth"),je("esriJSAPIOAuth"));const n=Je.findOAuthInfo(r);n&&n.set("forceLogin",!0);const o=i.call(Je,s,a).then((e=>(n&&n.set("forceLogin",!1),e)));return o}))))}return e})).catch((t=>(console.warn(null==t?void 0:t.message),e))))).then((e=>e)).catch((e=>(l.SessionManager.getInstance().releasePendingSignIn(s,e),Promise.reject(e))))}catch(e){return console.warn('replaced "getCredential" method error',e),i.call(Je,s,a)}}}initToRegistOAuthForMainPortalAndAGOL(){return fe(this,void 0,void 0,(function*(){const e=l.SessionManager.getInstance(),{portalUrl:t,isWebTier:i}=(0,l.getAppStore)().getState();i||(Me(t)?this.registOAuthInfo(be(t)):this.registOAuthInfo(t)),this.registOAuthInfo("https://devext.arcgis.com"),this.registOAuthInfo("https://qaext.arcgis.com"),this.registOAuthInfo("https://www.arcgis.com"),this.syncToArcgisJSAPI(e.getSessions()),e.addSessionChangeListener(this.onSessionChangedCallback.bind(this)),this.listeningJsApiSignIn()}))}registOAuthInfo(e,t){let i=Je.findOAuthInfo(e);if(t=t||l.SessionManager.getInstance().getClientIdByUrl(e),!i&&t){const r=Ce(`${window.location.origin}${Fe(Se("jimu-arcgis"))}/oauth-callback.html`);i=new Ae({appId:t,expiration:20159,portalUrl:e,authNamespace:"/",popup:!0,flowType:"auto",popupCallbackUrl:r}),Je.registerOAuthInfos([i])}}getFlowTypeForRegisteringOAuthInfo(e){var t;let i;if(Me(e))return"authorization-code";if(Ve(e,(0,l.getAppStore)().getState().portalUrl))i=null===(t=(0,l.getAppStore)().getState().portalSelf)||void 0===t?void 0:t.currentVersion;else{const t=l.appConfigUtils.getConnectionInfoFromAppConfig(e);i=null==t?void 0:t.portalVersion}return i&&Number(i)>=8.4?"authorization-code":"auto"}removePortalAndItsServerCredentials(e,t,i){const r=Je.findCredential(e,t),s=[];let a;a="portal"===(null==r?void 0:r.scope)?r.server:i,Je.credentials.forEach((e=>{if("server"===e.scope){const t=Je.serverInfos.find((t=>t.server===e.server));a===(null==t?void 0:t.owningSystemUrl)&&s.push(e)}else a===e.server&&s.push(e)})),s.forEach((e=>(null==e?void 0:e.server)&&e.destroy()))}addCredentialToSessionManger(e){const t=l.SessionManager.getInstance();return"server"===e.scope&&e.server?l.ServiceManager.getInstance().fetchArcGISServerInfo(e.server).then((i=>fe(this,void 0,void 0,(function*(){return t.addFromArcGisJSCredential(e,i),e})))):(t.addFromArcGisJSCredential(e,null),Promise.resolve(e))}listeningJsApiSignIn(){Je.on("credential-create",(({credential:e})=>{this.addCredentialToSessionManger(e).then((e=>{var t;let i;i="server"===e.scope?(null===(t=e.resources)||void 0===t?void 0:t.length)>0?e.resources[0]:`${e.server}/rest/services`:e.server,l.SessionManager.getInstance().releasePendingSignIn(i)})),e.on("token-change",(()=>{this.addCredentialToSessionManger(e)}))}))}syncToArcgisJSAPI(e){var t;e&&e.forEach((e=>{var t;const i=e.server?`${e.server}/rest/services`:e.portal,r=Je.findCredential(i);if((!r||e.username!==r.userId)&&(Je.registerToken({server:i,token:e.token,expires:null===(t=e.tokenExpires)||void 0===t?void 0:t.getTime(),ssl:e.ssl,userId:e.username}),e.server)){const t=Je.findServerInfo(e.server);t&&(t.owningSystemUrl=Le(e.portal),t.tokenServiceUrl="",t.adminTokenServiceUrl="",t.hasPortal=!0)}}));const i=[],r=l.SessionManager.getInstance();null===(t=Je.credentials)||void 0===t||t.forEach((t=>{const s="server"===t.scope?`${t.server}/rest/services`:t.server,a=r.getSessionKeyFromUrl(s);e.find((e=>{const i=l.SessionManager.getInstance().getSessionKeyFromSession(e);return a===i&&t.userId===e.username}))||i.push(t)})),i.forEach((e=>e.destroy()))}onSessionChangedCallback(e,t){t!==l.SessionChangedReasonType.ArcGISJSSync&&this.syncToArcgisJSAPI(e)}addToTrustedServers(){const{portalUrl:e,isWebTier:t}=(0,l.getAppStore)().getState(),i=l.SessionManager.getInstance().getTrustedServers();t&&Oe.request.trustedServers.push(e),i.forEach((e=>{Oe.request.trustedServers.includes(e)||Oe.request.trustedServers.push(e)}))}onCurrentThemeLoad(e){e&&(this.checkAPITheme(this.getAPIThemeUrl(window.jimuConfig.arcgisJsApiUrl,e.variables.darkTheme))||(this.removeApiThemeStyle(this.getAPIThemeUrl(window.jimuConfig.arcgisJsApiUrl,!e.variables.darkTheme)),l.moduleLoader.loadModule(this.getAPIThemeUrl(window.jimuConfig.arcgisJsApiUrl,e.variables.darkTheme)),e.variables.darkTheme&&!document.body.classList.contains("calcite-mode-dark")?document.body.classList.add("calcite-mode-dark"):document.body.classList.remove("calcite-mode-dark"),me.getInstance().getAllJimuMapViewIds().forEach((t=>{var i;const r=null===(i=me.getInstance().getJimuMapViewById(t).view)||void 0===i?void 0:i.ui.container;r&&(e.variables.darkTheme&&!r.classList.contains("calcite-mode-dark")?(r.classList.remove("calcite-theme-light"),r.classList.add("calcite-mode-dark")):(r.classList.remove("calcite-mode-dark"),r.classList.add("calcite-theme-light")))}))))}removeApiThemeStyle(e){var t;l.moduleLoader.deleteModule(e),null===(t=document.querySelector(`link[href="${e}"]`))||void 0===t||t.remove()}getAPIThemeUrl(e,t){return t?`${e}esri/themes/dark/main.css`:`${e}esri/css/main.css`}checkAPITheme(e){return!!document.querySelector(`link[href="${e}"]`)}checkApiUrl(e){return"development"===window.env||!/^\/\//.test(e)&&!/^https?:\/\//.test(e)||/(?:[\w\-\_]+\.)+(?:esri|arcgis)\.com/.test(e)}}class We{constructor(){this.id="arcgis-ds-factory"}getFactoryUri(e){if(Object.keys(n).map((e=>n[e])).includes(e))return"jimu-arcgis/arcgis-data-source"}}function Ee(e,t){return/rest\/services\/(.+)\/(MapServer|FeatureServer|ImageServer)\/(\d+)\/?$/.test(e)}function Re(e,t){return/sharing\/rest\/community\/self\/?$/.test(e)}function Be(e,t){const i=e.indexOf("sharing/rest/content/items/");if(i>-1){const t=e.substring(i+27).split("/");if(t.length>0&&(1===t.length||"data"===t[t.length-1]))return!0}return!1}class Ue extends l.React.PureComponent{constructor(){super(...arguments),this.viewManager=me.getInstance(),this.onViewsCreate=e=>{this.props.onViewsCreate&&this.props.onViewsCreate(e)},this.onViewGroupCreate=()=>{if(this.props.onViewGroupCreate&&this.viewManager&&this.props.useMapWidgetId){const e=this.viewManager.getJimuMapViewGroup(this.props.useMapWidgetId);this.props.onViewGroupCreate(e)}},this.onActiveViewChange=e=>{if(!this.props.onActiveViewChange)return;let t=null;if(this.viewManager){const e=this.getActiveViewId(this.props.useMapWidgetId,this.props.viewInfos);e&&(t=this.viewManager.getJimuMapViewById(e))}this.props.onActiveViewChange(t,e)},this.getActiveViewId=(e,t)=>{let i="";return e&&t&&(i=t&&Object.keys(t).find((i=>t[i].mapWidgetId===e&&t[i].isActive&&t[i].status===l.JimuMapViewStatus.Loaded))),i||(i=""),i},this.getWhetherAllViewsCreated=(e,t,i)=>!((null==e?void 0:e.length)<(null==i?void 0:i.length))&&(null==e?void 0:e.length)>0&&!e.some((e=>!this.getWhetherViewCreated(e,t))),this.getWhetherViewCreated=(e,t)=>!!(e&&t&&t[e]&&t[e].status&&t[e].status===l.JimuMapViewStatus.Loaded),this.getViewIdsFromMapWidgetId=(e,t)=>t?Object.keys(t).filter((i=>t[i].mapWidgetId===e)):[],this.getViews=e=>{if(!e)return null;const t={};return e.forEach((e=>{t[e]=this.viewManager.getJimuMapViewById(e)})),t}}componentDidMount(){this.checkPropCallbacksForCurrentMapWidgetId("")}componentDidUpdate(e){const t=e.useMapWidgetId||"";if((this.props.useMapWidgetId||"")===t){const t=this.getViewIdsFromMapWidgetId(e.useMapWidgetId,e.viewInfos),i=this.getViewIdsFromMapWidgetId(this.props.useMapWidgetId,this.props.viewInfos);if(0===t.length&&i.length>0&&this.onViewGroupCreate(),!this.getWhetherAllViewsCreated(t,e.viewInfos,e.useDataSources)&&this.getWhetherAllViewsCreated(i,this.props.viewInfos,this.props.useDataSources)){const e=this.getViews(i);this.onViewsCreate(e)}const r=this.getActiveViewId(e.useMapWidgetId,e.viewInfos);r!==this.getActiveViewId(this.props.useMapWidgetId,this.props.viewInfos)&&this.onActiveViewChange(r)}else{const t=this.getActiveViewId(e.useMapWidgetId,e.viewInfos);this.checkPropCallbacksForCurrentMapWidgetId(t)}}checkPropCallbacksForCurrentMapWidgetId(e){const{useMapWidgetId:t,viewInfos:i,useDataSources:r}=this.props,s=this.getViewIdsFromMapWidgetId(t,i);if(s.length>0&&this.onViewGroupCreate(),this.getWhetherAllViewsCreated(s,i,r)){const e=this.getViews(s);this.onViewsCreate(e)}e!==this.getActiveViewId(t,i)&&this.onActiveViewChange(e)}render(){if(!this.props.useMapWidgetId||!this.props.viewInfos||!this.props.children)return null;const e=this.getViewIdsFromMapWidgetId(this.props.useMapWidgetId,this.props.viewInfos),t=this.getViews(e);return"function"==typeof this.props.children?this.props.children(t):this.props.children}}const Ge=l.ReactRedux.connect(((e,t)=>{var i,r,s;const a=null!==(i=e.appStateInBuilder)&&void 0!==i?i:e;return{viewInfos:a.jimuMapViewsInfo,useDataSources:null===(s=null===(r=a.appConfig)||void 0===r?void 0:r.widgets[t.useMapWidgetId])||void 0===s?void 0:s.useDataSources}}))(Ue);function ke(e){const[,t]=l.React.useState(!1);if(l.React.useEffect((()=>{this.getJimuLayerView()?t(!0):me.getInstance().getJimuMapViewById(this.props.jimuMapViewId).whenJimuLayerViewLoaded(this.props.jimuLayerViewId).then((()=>{t(!0)}))}),[]),!e.jimuLayerViewId||!e.children)return null;const i=(()=>{const t=me.getInstance().getJimuMapViewById(e.jimuMapViewId);return null==t?void 0:t.jimuLayerViews[e.jimuLayerViewId]})();return i?"function"==typeof e.children?e.children(i):e.children:null}var Qe=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};function He(){return Qe(this,void 0,void 0,(function*(){return yield Promise.resolve(null)}))}})(),a})())}}}));
System.register(["jimu-core","jimu-theme"],(function(e,t){var i={},r={};return{setters:[function(e){i.AppMode=e.AppMode,i.DataRecordsSelectionChangeMessage=e.DataRecordsSelectionChangeMessage,i.DataSourceManager=e.DataSourceManager,i.ExternalResolvablePromise=e.ExternalResolvablePromise,i.Immutable=e.Immutable,i.JimuMapViewStatus=e.JimuMapViewStatus,i.LocationChangeMessage=e.LocationChangeMessage,i.MessageManager=e.MessageManager,i.MutableStoreManager=e.MutableStoreManager,i.React=e.React,i.ReactRedux=e.ReactRedux,i.ServiceManager=e.ServiceManager,i.SessionChangedReasonType=e.SessionChangedReasonType,i.SessionManager=e.SessionManager,i.SupportedLayerServiceTypes=e.SupportedLayerServiceTypes,i.appActions=e.appActions,i.appConfigUtils=e.appConfigUtils,i.dataSourceUtils=e.dataSourceUtils,i.defaultMessages=e.defaultMessages,i.getAppStore=e.getAppStore,i.i18n=e.i18n,i.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules,i.moduleLoader=e.moduleLoader,i.observeStore=e.observeStore,i.portalUrlUtils=e.portalUrlUtils,i.requestUtils=e.requestUtils,i.urlUtils=e.urlUtils,i.utils=e.utils},function(e){r.ThemeStore=e.ThemeStore,r.getTheme=e.getTheme}],execute:function(){e((()=>{"use strict";var e={891:e=>{e.exports=i},796:e=>{e.exports=r}},t={};function s(i){var r=t[i];if(void 0!==r)return r.exports;var a=t[i]={exports:{}};return e[i](a,a.exports,s),a.exports}s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var a={};return(()=>{s.r(a),s.d(a,{ADD_TO_MAP_DATA_ID_PREFIX:()=>te,ActionType:()=>K,ArcGISDataSourceFactoryUriExtension:()=>Me,ArcGISDataSourceTypes:()=>l,ArcGISDependencyDefineExtension:()=>Le,DataChangeType:()=>Y,DataSourceTypes:()=>l,JimuFeatureLayerView:()=>_,JimuLayerView:()=>q,JimuLayerViewComponent:()=>Ae,JimuMapView:()=>ie,JimuMapViewComponent:()=>De,JimuMapViewGroup:()=>re,JimuSceneLayerView:()=>Q,LayerTypes:()=>u,MapViewManager:()=>se,SHOW_ON_MAP_DATA_ID_PREFIX:()=>ee,defaultMessages:()=>U,featureUtils:()=>r,geometryUtils:()=>e,init:()=>Ce,loadArcGISJSAPIModules:()=>o,portalUtils:()=>i,zoomToUtils:()=>t});var e={};s.r(e),s.d(e,{projectToSpatialReference:()=>h});var t={};s.r(t),s.d(t,{getExtentFromScale:()=>m,layerExtent:()=>x,projectToSpatialReference:()=>J,zoomTo:()=>g});var i={};s.r(i),s.d(i,{checkDefaultBaseMapIsExist:()=>E,getDefaultWebMap:()=>W,getItemQueryStringByTypes:()=>k});var r={};s.r(r),s.d(r,{convertDataRecordSetToFeatureSet:()=>B,getDefaultSymbol:()=>G});var n=s(891);function o(e){return t=this,i=void 0,s=function*(){return yield(0,n.loadArcGISJSAPIModules)(e)},new((r=void 0)||(r=Promise))((function(e,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function o(e){try{l(s.throw(e))}catch(e){a(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof r?i:new r((function(e){e(i)}))).then(n,o)}l((s=s.apply(t,i||[])).next())}));var t,i,r,s}var l,u,d=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};function h(e,t){return d(this,void 0,void 0,(function*(){return e&&0!==e.length&&e[0]&&t.wkid!==e[0].spatialReference.wkid&&!t.equals(e[0].spatialReference)?yield o(["esri/rest/geometryService","esri/rest/support/ProjectParameters","esri/geometry/projection"]).then((i=>d(this,void 0,void 0,(function*(){var r,s;let a,n,o;if([a,n,o]=i,o.isLoaded()&&(null===(s=null===(r=e[0])||void 0===r?void 0:r.spatialReference)||void 0===s?void 0:s.wkid)){const i=function(e,t,i){return i.project(e,t)}(e,t,o);return i&&i[0]?yield Promise.resolve(i):yield c(e,t,a,n).then((e=>d(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))),(e=>d(this,void 0,void 0,(function*(){return console.error(e),yield Promise.reject(e)}))))}return o.load(),yield c(e,t,a,n).then((e=>d(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))),(e=>d(this,void 0,void 0,(function*(){return console.error(e),yield Promise.reject(e)}))))})))):yield Promise.resolve(e)}))}function c(e,t,i,r){return d(this,void 0,void 0,(function*(){const s=n.utils.getGeometryService(),a=new r({geometries:e,outSpatialReference:t});return yield i.project(s,a)}))}!function(e){e.Map="MAP",e.WebMap="WEB_MAP",e.WebScene="WEB_SCENE"}(l||(l={})),function(e){e.BaseDynamicLayer="base-dynamic",e.BaseElevationLayer="base-elevation",e.BaseTileLayer="base-tile",e.BuildingSceneLayer="building-scene",e.CSVLayer="csv",e.ElevationLayer="elevation",e.FeatureLayer="feature",e.GeoJSONLayer="geojson",e.GeoRSSLayer="geo-rss",e.GraphicsLayer="graphics",e.GroupLayer="group",e.ImageryLayer="imagery",e.IntegratedMeshLayer="integrated-mesh",e.KMLLayer="kml",e.MapImageLayer="map-image",e.MapNotesLayer="map-notes",e.PointCloudLayer="point-cloud",e.SceneLayer="scene",e.TileLayer="tile",e.UnknownLayer="unknown",e.UnsupportedLayer="unsupported",e.VectorTileLayer="vector-tile",e.WMSLayer="wms",e.WMTSLayer="wmts",e.WebTileLayer="web-tile"}(u||(u={}));var p=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};let y=null;function g(e,t,i){return p(this,void 0,void 0,(function*(){return e&&t?(i||(i={}),yield o(["esri/Graphic","esri/geometry/Extent","esri/layers/Layer","esri/layers/support/TileInfo"]).then((r=>p(this,void 0,void 0,(function*(){let s,a,n;[s,a,n,y]=r;try{if(t instanceof a)return yield w(e,t,i.scale);if(Array.isArray(t)&&t.length&&t[0]instanceof s)return yield v(e,t,i.scale);if(Array.isArray(t)&&t.length&&t[0]instanceof Array&&t[0][0]instanceof s)return yield function(e,t,i){return p(this,void 0,void 0,(function*(){if(0===t.length)return Promise.resolve();if(1===t.length)return v(e,t[0],i);{const r=[];t.forEach((t=>{r.push(b(e,t).catch((()=>null)))}));let s=null;return Promise.all(r).then((t=>(t.forEach((e=>{e&&(s=s?s.union(e):e)})),w(e,s,i))))}}))}(e,t,i.scale);if(t instanceof n)return yield f(e,t,null,null,i);if(t.layer&&t.layer instanceof n&&t.extent&&t.extent instanceof a)return yield f(e,t.layer,null,t.extent,i);if(!(t.layer&&t.layer instanceof n&&Array.isArray(t.graphics)))return Array.isArray(t)&&t.length&&t[0]instanceof n?yield function(e,t,i){return p(this,void 0,void 0,(function*(){if(1!==(null==t?void 0:t.length)){let r=null;const s=[];return t.forEach((t=>s.push(x(e,t,null==i?void 0:i.queryParams)))),Promise.all(s).then((t=>(t.forEach((e=>{e&&(r=r?r.union(e):e)})),I(e,r))))}f(e,t[0],null,null,i)}))}(e,t,i):yield Promise.reject(new Error("Invalid target."));if(0===t.graphics.length)return yield f(e,t.layer,null,null,i);if(t.graphics.length&&t.graphics[0]instanceof s)return yield f(e,t.layer,t.graphics,null,i)}catch(e){console.warn(e)}}))))):yield Promise.reject(new Error("Invalid target."))}))}function m(e,t,i,r=!0){return p(this,void 0,void 0,(function*(){return C(e,t,i,r)}))}function v(e,t,i){return p(this,void 0,void 0,(function*(){return"3d"!==e.type||i?yield b(e,t).then((t=>p(this,void 0,void 0,(function*(){return yield w(e,t,i)})))).catch((e=>p(this,void 0,void 0,(function*(){return yield Promise.reject(e)})))):e.goTo(t)}))}function f(e,t,i,r,s){return p(this,void 0,void 0,(function*(){let a,n=null==s?void 0:s.scale;if(r&&S(r)){if("3d"===e.type&&!n)return J([r],e.spatialReference).then((t=>e.goTo(t)));a=Promise.resolve(r)}else if(i&&i.length>0){if("3d"===e.type&&!n)return J(i.map((e=>e.geometry)),e.spatialReference).then((t=>e.goTo(t)));a=b(e,i)}else a=x(e,t,null==s?void 0:s.queryParams);return a.then((t=>p(this,void 0,void 0,(function*(){return S(t)?yield J([t],e.spatialReference).then((e=>e&&e[0])):yield Promise.reject(new Error("Invalid extent."))})))).then((i=>p(this,void 0,void 0,(function*(){if(n)return yield A(e,i,n).then((t=>I(e,t)));const r=4513.9887;let s=t.minScale||0,a=t.maxScale||0;if(!V(i))return i=function(e,t){const i=e.size[0]/e.size[1],r=t.width/t.height;if(r>i){const e=t.width/i/2;t.ymin=t.center.y-e,t.ymax=t.center.y+e}else if(r<i){const e=t.height*i/2;t.xmin=t.center.x-e,t.xmax=t.center.x+e}return t}(e,i),function(e,t){return p(this,void 0,void 0,(function*(){return yield o(["esri/config","esri/geometry/support/WKIDUnitConversion"]).then((i=>{let r,s,a;[r,s]=i;const n=e.size[0],o=s;let l,u,d=t.spatialReference;d&&(l=d.wkid,u=d.wkt);let h=null;if(l)h=o.values[o[l]];else if(u&&-1!==u.search(/^PROJCS/i)){const e=/UNIT\[([^\]]+)\]\]$/i.exec(u);e&&e[1]&&(h=parseFloat(e[1].split(",")[1]))}return a=t.width/n*(h||20015077/180)*39.37*(r.screenDPI||96),a})).catch((e=>p(this,void 0,void 0,(function*(){return yield Promise.reject()}))))}))}(e,i).then((t=>s>0&&t>s?(s=F(e,s,!0),A(e,i,s).then((t=>I(e,t)))):t<a?(a=F(e,a,!1),A(e,i,a).then((t=>I(e,t)))):I(e,i)));{let t=D(e,s,a,3);if(t)return"3d"===e.type&&r>t&&(t=0===s||r<s?r:s),A(e,i,t).then((t=>I(e,t)))}})))).catch((e=>p(this,void 0,void 0,(function*(){return yield Promise.reject(e)}))))}))}function w(e,t,i){return p(this,void 0,void 0,(function*(){return S(t=t.clone())?yield J([t],e.spatialReference).then((i=>{let r=i&&i[0];return r||(r=t),V(r)?function(e,t){return p(this,void 0,void 0,(function*(){const i=D(e,0,0,3);return i?yield A(e,t,i):yield Promise.reject()}))}(e,r):r})).then((t=>i?A(e,t,i,!1):t)).then((t=>I(e,t))).catch((e=>p(this,void 0,void 0,(function*(){return yield Promise.reject(e)})))):yield Promise.reject(new Error("Invalid extent."))}))}function I(e,t){return new Promise(((i,r)=>{setTimeout((()=>{e.goTo(t).then((()=>i())).catch((()=>r()))}),400)}))}function S(e){return e&&L(e.xmin)&&L(e.ymin)&&L(e.xmax)&&L(e.ymax)}function L(e){return 0===e||!!e}var M;function V(e){return e.xmin+M.X===e.xmax-M.X&&e.ymin+M.Y===e.ymax-M.Y}function b(e,t,i={}){return p(this,void 0,void 0,(function*(){let r=t&&t[0]&&t[0].layer;return r&&"scene"===r.type?yield function(e,t,i){return p(this,void 0,void 0,(function*(){return yield o(["esri/rest/support/Query"]).then((i=>p(this,void 0,void 0,(function*(){const[r]=i;if(t){const i=new r;return i.objectIds=e.map((e=>e.attributes[t.objectIdField])),i.returnGeometry=!0,t.queryExtent(i).then((e=>1===e.count?e.extent.expand(3.5):e.extent.expand(2)))}return Promise.reject()})))).catch((e=>p(this,void 0,void 0,(function*(){return yield Promise.reject(e)}))))}))}(t,r,i.factor):"3d"===e.type?yield j(t,3):yield j(t)}))}function j(e,t){return p(this,void 0,void 0,(function*(){return yield o(["esri/Graphic","esri/geometry/Extent","esri/geometry/Point"]).then((i=>{let r,s,a,n=null,o=e;[r,s,a]=i;try{if(o&&1===o.length&&o[0].geometry&&"esri.geometry.Multipoint"===o[0].geometry.declaredClass&&1===o[0].geometry.points.length){const e=o[0].geometry.points[0];o=[new r({geometry:new a({x:e[0],y:e[1],spatialReference:o[0].geometry.spatialReference})})]}if(o&&1===o.length&&o[0].geometry&&"esri.geometry.Point"===o[0].geometry.declaredClass){const e=o[0].geometry;n=new s({xmin:e.x-M.X,ymin:e.y-M.Y,xmax:e.x+M.X,ymax:e.y+M.Y,spatialReference:e.spatialReference})}else o&&o.length>0&&(n=function(e,t){if(!e||!e.length)return null;let i,r=null,s=e.length;for(i=0;i<s;i++){const s=e[i].geometry;if(!s)continue;let a=s.extent;a||"point"!==s.type||null==s.x||null==s.y||(a=new t({xmin:s.x,ymin:s.y,xmax:s.x,ymax:s.y,spatialReference:s.spatialReference})),a&&(r=r?r.union(a):a)}return!r||r.width<0||r.height<0?null:r}(o,s),n&&t&&t>0&&(n=n.expand(t)));return n}catch(e){return console.error(e),Promise.reject()}})).catch((e=>p(this,void 0,void 0,(function*(){return yield Promise.reject()}))))}))}function P(e){let t=[];return e.map.basemap.baseLayers.forEach((e=>{e&&e.tileInfo&&e.tileInfo.lods&&t.length<e.tileInfo.lods.length&&(t=e.tileInfo.lods)})),0===t.length?y.create().lods:t}function D(e,t,i,r){const s=P(e);let a,n=1;if(s){const e=[],o=[];let l;s.forEach((r=>{t>0&&r.scale>t||(r.scale<i?o.push(r.scale):e.push(r.scale))})),e.reverse(),e.length>=1?(n=o.length?o.length/s.length:1,l=Math.floor((e.length-1)/(r/n)),a=e[l]):a=null}else a=0===t?null:(t-i)/r;return a}function F(e,t,i){let r;const s=P(e);if(s){if(i){for(r=0;r<s.length;r++)if(s[r].scale<t)return s[r].scale-1;return s[s.length-1].scale-1}for(r=s.length-1;r>=0;r--)if(s[r].scale>t)return s[r].scale+1;return s[0].scale+1}return i?t-1:t+1}function A(e,t,i,r=!0){return p(this,void 0,void 0,(function*(){return C({width:e.size[0],height:e.size[1]},t,i,r)}))}function C(e,t,i,r=!0){return p(this,void 0,void 0,(function*(){return r&&(t=function(e,t){const i=t.width*(e.height/e.width)/5;return t.ymin=t.center.y-i,t.ymax=t.center.y+i,t}(e,t.clone())),yield o(["esri/config","esri/geometry/support/WKIDUnitConversion"]).then((r=>{let s,a;[s,a]=r;const n=e.width,o=a;let l,u,d=t.spatialReference;d&&(l=d.wkid,u=d.wkt);let h=null;if(l)h=o.values[o[l]];else if(u&&-1!==u.search(/^PROJCS/i)){const e=/UNIT\[([^\]]+)\]\]$/i.exec(u);e&&e[1]&&(h=parseFloat(e[1].split(",")[1]))}return t.expand(i*n/(39.37*(h||20015077/180)*(s.screenDPI||96))/t.width)})).catch((e=>p(this,void 0,void 0,(function*(){return yield Promise.reject()}))))}))}function x(e,t,i){var r,s;return p(this,void 0,void 0,(function*(){if(!t.loaded&&t.load&&(yield t.load()),t.sublayers||t.type===u.GroupLayer){const r=[];let s=null;return(t.type===u.GroupLayer?t.layers:t.sublayers).forEach((t=>r.push(x(e,t,i)))),Promise.all(r).then((e=>{var i;return e.forEach((e=>{e&&(s=s?s.union(e):e)})),s||(null===(i=t.fullExtent)||void 0===i?void 0:i.clone())}))}return(null===(r=t.capabilities)||void 0===r?void 0:r.query)?yield function(e,t,i){var r;return p(this,void 0,void 0,(function*(){const s=null===(r=t.fullExtent)||void 0===r?void 0:r.clone(),a=t.capabilities.query;return a?yield o(["esri/rest/support/Query"]).then((r=>{let n;[n]=r;const o=new n;return o.where=(null==i?void 0:i.where)||(null==t?void 0:t.definitionExpression)||"1=1",o.outSpatialReference=e.spatialReference,o.returnGeometry=!0,a.supportsExtent?t.queryExtent(o).then((e=>e.extent)).catch((e=>p(this,void 0,void 0,(function*(){return yield Promise.resolve(s)})))):t.queryFeatures?t.queryFeatures(o).then((t=>p(this,void 0,void 0,(function*(){return b(e,t.features)})))).catch((e=>p(this,void 0,void 0,(function*(){return yield Promise.resolve(s)})))):Promise.resolve(s)})).catch((e=>p(this,void 0,void 0,(function*(){return yield Promise.resolve(s)})))):Promise.resolve(s)}))}(e,t,i):yield Promise.resolve(null===(s=t.fullExtent)||void 0===s?void 0:s.clone())}))}function J(e,t){return p(this,void 0,void 0,(function*(){return yield o(["esri/geometry/Extent"]).then((i=>{let r;return[r]=i,h(e,t).then((e=>e.map((e=>"extent"!==e.type||0!==e.width&&0!==e.height?e:new r({xmin:e.xmin-M.X,ymin:e.ymin-M.Y,xmax:e.xmax+M.X,ymax:e.ymax+M.Y,spatialReference:e.spatialReference})))))})).catch((e=>p(this,void 0,void 0,(function*(){return yield Promise.reject()}))))}))}!function(e){e[e.X=1e-4]="X",e[e.Y=1e-4]="Y"}(M||(M={}));var R=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};const T=" "+k(["Web Map"])+" ";let O=null;function E(){const e=(0,n.getAppStore)().getState().portalSelf;return!!(e&&e.defaultBasemap&&e.defaultBasemap.baseMapLayers&&e.defaultBasemap.baseMapLayers[0]&&e.defaultBasemap.baseMapLayers[0].url)}function W(e){return R(this,void 0,void 0,(function*(){return O||(O=o(["esri/portal/Portal"]).then((t=>R(this,void 0,void 0,(function*(){let i=null;[i]=t;const r=new i({url:e});return yield r.load().then((()=>R(this,void 0,void 0,(function*(){const e=r.sourceJSON,t=e.defaultBasemap&&e.defaultBasemap.id,i=e.defaultExtent;return t?yield Promise.resolve({defaultMapId:t,defaultExtent:i}):yield function(e,t,i){return R(this,void 0,void 0,(function*(){const e=t.defaultBasemap&&t.defaultBasemap.title,r=t.useVectorBasemaps&&t.vectorBasemapGalleryGroupQuery?t.vectorBasemapGalleryGroupQuery:t.basemapGalleryGroupQuery;return yield i.queryGroups({f:"json",query:r}).then((t=>R(this,void 0,void 0,(function*(){const r=t.results;if(r.length>0){const t=r[0],s=T+" AND group:"+t.id;return yield i.queryItems({start:1,num:1,f:"json",query:s}).then((t=>R(this,void 0,void 0,(function*(){let r=t.results;if(r=r.filter((e=>e.type&&"web map"===e.type.toLowerCase())),r.length>0){const t=r.find((t=>{var i;return null===(i=t.title)||void 0===i?void 0:i.toLowerCase().includes(null==e?void 0:e.toLowerCase())})),i=t||r[0];return Promise.resolve(i.id)}{const t=T+" AND title:"+e;return i.queryItems({start:1,num:1,f:"json",query:t}).then((e=>R(this,void 0,void 0,(function*(){let t=e.results;if(t=t.filter((e=>e.type&&"web map"===e.type.toLowerCase())),t.length>0){const e=t[0];return Promise.resolve(e.id)}return Promise.resolve(null)}))))}}))))}}))))}))}(0,e,r).then((e=>R(this,void 0,void 0,(function*(){return e?yield Promise.resolve({defaultMapId:e,defaultExtent:i}):yield function(e){return R(this,void 0,void 0,(function*(){const t={start:1,num:1,f:"json",query:T+" AND access:public AND owner:esri_en",sortField:"num-views",sortOrder:"desc"};return yield e.queryItems(t).then((e=>R(this,void 0,void 0,(function*(){let t=e.results;if(t=t.filter((e=>e.type&&"web map"===e.type.toLowerCase())),t.length>0){const e=t[0];return Promise.resolve(e.id)}return Promise.resolve(null)}))))}))}(r).then((e=>R(this,void 0,void 0,(function*(){return yield Promise.resolve({defaultMapId:e,defaultExtent:i})}))))}))))}))))})))),O)}))}function k(e){let t="";const i=function(){let e=[];return e=e.concat(["Web Map","Web Scene","CityEngine Web Scene"]).concat(["Feature Service","Map Service","Image Service","KML","WMS","Feature Collection","Feature Collection Template","Geodata Service","Globe Service"]).concat(["Geometry Service","Geocoding Service","Network Analysis Service","Geoprocessing Service"]).concat(["Web Mapping Application","Mobile Application","Code Attachment","Operations Dashboard Add In","Operation View"]).concat(["Symbol Set","Color Set","Shapefile","CSV","Service Definition","Document Link","Microsoft Word","Microsoft PowerPoint","Microsoft Excel","PDF","Image","Visio Document"]),e=e.concat(["Map Document","Map Package","Tile Package","ArcPad Package","Explorer Map","Globe Document","Scene Document","Published Map","Map Template","Windows Mobile Package"]).concat(["Layer","Layer Package","Explorer Layer"]).concat(["Geoprocessing Package","Geoprocessing Sample","Locator Package","Rule Package"]).concat(["Workflow Manager Package","Desktop Application","Desktop Application Template","Code Sample","Desktop Add In","Explorer Add In"]),e}();if(e&&e.length>0&&e.length>0){let r="";for(let t=0;t<e.length;t++)r+=' type:"'+e[t]+'" ',t!==e.length-1&&(r+=" OR ");t=" ( "+r+" ) ";const s=e.concat(i).filter((t=>e.every((e=>!e.toLowerCase().includes(t.toLowerCase())))));for(let e=0;e<s.length;e++)t+=' -type:"'+s[e]+'" '}return t}function B(e){return(0,n.loadArcGISJSAPIModules)(["esri/Graphic","esri/rest/support/FeatureSet"]).then((t=>{return i=this,r=void 0,a=function*(){const[i,r]=t,s=new r,a=n.dataSourceUtils.changeRestAPIGeometryTypeToJSAPIGeometryType(e.dataSource.getGeometryType());return s.geometryType=a,s.features=e.records.map((e=>{let t;const r=e.feature;return"esri.Graphic"===(null==r?void 0:r.declaredClass)?t=r.clone():(r.geometry.type=a,t=new i({geometry:r.geometry,attributes:r.attributes})),t})),s},new((s=void 0)||(s=Promise))((function(e,t){function n(e){try{l(a.next(e))}catch(e){t(e)}}function o(e){try{l(a.throw(e))}catch(e){t(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof s?i:new s((function(e){e(i)}))).then(n,o)}l((a=a.apply(i,r||[])).next())}));var i,r,s,a})).catch((e=>(console.warn(e),null)))}function G(e){let t=null;switch(e){case"point":t={type:"esriSMS",color:[255,255,0,150],outline:{color:[255,255,0,150],width:1}};break;case"polyline":t={type:"esriSLS",color:[255,255,0,150]};break;case"polygon":t={type:"esriSFS",color:[255,255,0,150],outline:{color:[255,255,0,150],width:1}}}return t}const U={layerIsNotSupported:"This layer type is not supported."};class q{constructor(e){var t;if(this.runTimeIsHidden=!1,this.id=`${e.jimuMapViewId}-${e.jimuLayerId}`,this.mapViewManager=e.mapViewManager,this.view=e.view,this.type=e.type,this.layerDataSourceId=e.layerDataSourceId,this.jimuMapViewId=e.jimuMapViewId,this.jimuLayerId=e.jimuLayerId,this.layer=e.layer,this.parentJimuLayerViewId=e.parentJimuLayerViewId,this.index=e.index,this.dataSourceInfoObserver=(0,n.observeStore)(this.onLayerDataSourceInfoChange.bind(this),["dataSourcesInfo",this.layerDataSourceId]),this.getLayerDataSource()){const e=this.getLayerDataSource(),i=null===(t=e.getDataSourceJson())||void 0===t?void 0:t.isHidden;this.runTimeIsHidden=i,i&&(this.layer.visible=!i);const r=e.getRootDataSource();r&&(this.layerDataSourceJsonObserver=(0,n.observeStore)(this.onLayerDatasourceJsonChange.bind(this),["appConfig","dataSources",r.id]))}}ready(){return Promise.resolve(this)}onLayerDataSourceInfoChange(e,t){var i;const r=null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getLabel();if(r&&r!==this.layer.title){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId),t=n.i18n.getIntl().formatMessage({id:"action_addedData",defaultMessage:n.defaultMessages.action_addedData},{label:r});this.layer.title=r,n.MutableStoreManager.getInstance().updateStateValue(e.mapWidgetId,`addToMapDatas.${this.layer.id}.title`,t)}}onLayerDatasourceJsonChange(e,t){var i,r;const s=null===(r=null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getDataSourceJson())||void 0===r?void 0:r.isHidden;this.runTimeIsHidden!==s&&(this.runTimeIsHidden=s,this.layer.visible=!s)}getLayerDataSource(){return n.DataSourceManager.getInstance().getDataSource(this.layerDataSourceId)}selectFeaturesByIds(e){}selectFeatureById(e){}getMapSceneView(){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId);return e&&e.view}destroy(){this.dataSourceInfoObserver&&this.dataSourceInfoObserver()}}var H=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};class _ extends q{constructor(e){super(e),this.features=[],this.isReservePopup=!1,this.highlightFeatureLayer=null,this.highlightFeatureLayerView=null,this.localDefinitionExpression="",this.originalGdbVersion=null,this.layer&&(this.originalGdbVersion=this.layer.gdbVersion,this.layer.watch("visible",((e,t)=>{this.highlightFeatureLayer&&(this.highlightFeatureLayer.visible=e)}))),this.view||(this.highLightLayerPromise=this.createHighLightFeatureLayer()),this.getMapSceneView().popup.watch("selectedFeature",(e=>{if(e){const t=this.getLayerFromFeature(e);if(!t)return;if(t===this.layer){const i=String(e.attributes[t.objectIdField]),r=this.getLayerDataSource();if(!r)return;if(r.getSelectedRecordIds().includes(i))return;const s=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId);r.queryById(i).then((e=>{this.selectFeatureById(i,e),this.isReservePopup=!0,n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(s.mapWidgetId,[e]))}))}else this.isReservePopup=!1,this.selectFeatureById(null)}})),this.getMapSceneView().popup.watch("visible",(e=>{const t=this.getMapSceneView();if(!e&&t.popup.selectedFeature&&this.getLayerFromFeature(t.popup.selectedFeature)===this.layer){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId);n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(e.mapWidgetId,[])),this.isReservePopup=!1,this.selectFeatureById(null)}})),this.getSelectedRecordIds().length>0?this.moveFeatureToCenter(this.getSelectedRecordIds()[0]).then((()=>{this.highLightSelectedFeatures()})):this.getLayerDataSource()&&this.getLayerDataSource().getSelectedRecordIds().length>0&&this.moveFeatureToCenter(this.getLayerDataSource().getSelectedRecordIds()[0]).then((()=>{this.highLightFeatures(this.getLayerDataSource().getSelectedRecordIds().map((e=>parseInt(e))))}),(e=>console.error(e)))}ready(){return this.highLightLayerPromise?this.highLightLayerPromise:Promise.resolve(this)}getLayerFromFeature(e){return e.layer||e.sourceLayer}doQuery(e){return H(this,void 0,void 0,(function*(){return yield new Promise((t=>{if(!this.view)return t([]);this.view.updating?(this.updateWatchHandle&&(this.updateWatchHandle.remove(),this.updateWatchHandle=null),this.updateWatchHandle=this.view.watch("updating",(i=>{i||this.view.queryFeatures(e).then((e=>{this.features=e.features,t(this.features)}))}))):this.view.queryFeatures(e).then((e=>{this.features=e.features,t(this.features)}),(e=>{console.error(e)}))}))}))}doQueryById(e){return H(this,void 0,void 0,(function*(){const t={objectIds:[parseInt(e)],returnGeometry:!0};return yield this.doQuery(t).then((e=>e[0]))}))}setRefreshIntervalForLayer(e){this.view&&null!=e&&((0,n.getAppStore)().getState().appRuntimeInfo.appMode===n.AppMode.Design?this.layer.refreshInterval=0:this.layer.refreshInterval=e/60)}setDefinitionExpressionForLayer(e){var t,i,r,s,a;if(e){if(this.view&&this.view.layer){const i={outFields:["*"],where:this.localDefinitionExpression,returnGeometry:!0},r=null===(t=this.getLayerDataSource())||void 0===t?void 0:t.getRealQueryParams(i,"query");if(r&&r.where!==this.view.layer.definitionExpression&&(this.view.layer.definitionExpression=r.where),null!=(null==r?void 0:r.time)?this.view.layer.useViewTime=!1:this.view.layer.useViewTime=!0,this.view.layer.timeExtent=n.dataSourceUtils.changeJimuTimeToJSAPITimeExtent(null==r?void 0:r.time),e.geometry){if(this.view.filter&&this.view.filter.geometry===e.geometry)return;o(["esri/geometry/support/jsonUtils"]).then((t=>{const i=t[0];this.view.filter={geometry:i.fromJSON(e.geometry)}}))}else this.view.filter&&(this.view.filter=null);return}if(!this.view&&this.layer){const e={outFields:["*"],where:this.localDefinitionExpression,returnGeometry:!0},t=null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getRealQueryParams(e,"query"),n="esri.layers.support.Sublayer"===this.layer.declaredClass&&(null===(a=null===(s=null===(r=this.layer.layer)||void 0===r?void 0:r.capabilities)||void 0===s?void 0:s.exportMap)||void 0===a?void 0:a.supportsSublayerDefinitionExpression)||"esri.layers.FeatureLayer"===this.layer.declaredClass;t&&n&&t.where!==this.layer.definitionExpression&&(this.layer.definitionExpression=t.where)}}}setLocalDefinitionExpression(e){var t;this.localDefinitionExpression=e,(null===(t=this.getLayerDataSource())||void 0===t?void 0:t.getCurrentQueryParams())&&this.setDefinitionExpressionForLayer(this.getLayerDataSource().getCurrentQueryParams())}highLightSelectedFeatures(){0!==this.getSelectedRecordIds().length&&this.highLightFeatures(this.getSelectedRecordIds().map((e=>parseInt(e))))}createHighLightFeatureLayer(){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId),t=this.getLayerDataSource();if(!t)return;const i=this.getObjectIdField(t.layer.fields,t.layer.objectIdField);return o(["esri/layers/FeatureLayer"]).then((r=>{const s=r[0];return this.highlightFeatureLayer=new s({title:`${t.layer.title}-highlight`,geometryType:t.layer.geometryType,spatialReference:t.layer.spatialReference,source:[],fields:i?[i]:[],objectIdField:t.layer.objectIdField,renderer:this.getRendererForVirtualLayer(t.layer.geometryType),listMode:"hide",legendEnabled:!1}),e.view.map.add(this.highlightFeatureLayer),this.highlightFeatureLayer.on("layerview-create",(e=>{this.highlightFeatureLayerView=e.layerView,this.getSelectedRecordIds().length>0&&this.highLightSelectedFeatures()})),Promise.resolve(this)}))}addFeaturesToHighlightFeatureLayer(e){const t=this.getLayerDataSource().getIdField(),i=e.map((e=>{var t;return null===(t=this.getLayerDataSource().getSelectedRecords().find((t=>t.getId()===e+"")))||void 0===t?void 0:t.feature})).filter((e=>!!e));if(0===i.length)return Promise.resolve(!0);const r=i.map((e=>{const i=e.clone(),r=i.attributes[t];return i.attributes={},i.attributes[t]=r,i}));return this.highlightFeatureLayer.applyEdits({addFeatures:r}).then((e=>!e.addFeatureResults.find((e=>e.error))))}removeFeaturesFromHighlightFeatureLayer(){return this.highlightFeatureLayer.queryFeatures({where:"1=1"}).then((e=>{const t=e.features;return 0===t.length?Promise.resolve(!0):this.highlightFeatureLayer.applyEdits({deleteFeatures:t}).then((e=>!e.deleteFeatureResults.find((e=>e.error))))}))}isLayerVisible(){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).getParentJimuLayerViews(this.id);let t=!0;for(let i=0;i<e.length;i++)if(!e[i].layer.visible){t=!1;break}return!(!t||!this.layer.visible)}highLightFeatures(e){return H(this,void 0,void 0,(function*(){if(!this.isLayerVisible())return;const t=this.view||this.highlightFeatureLayerView;if(t){if(this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null),this.highlightFeatureLayerView){const t=yield this.removeFeaturesFromHighlightFeatureLayer(),i=yield this.addFeaturesToHighlightFeatureLayer(e);if(!t||!i)return}t.when((()=>{this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null),this.highLightHandle=t.highlight(e)}))}}))}clearHighLight(){this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null,this.highlightFeatureLayerView&&this.removeFeaturesFromHighlightFeatureLayer(),this.isReservePopup&&(this.getMapSceneView().popup.close(),this.isReservePopup=!1))}selectFeatureById(e,t){var i,r;(e||0!==(null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getSelectedRecordIds().length))&&(null===(r=this.getLayerDataSource())||void 0===r||r.selectRecordById(e,t))}selectFeaturesByIds(e,t){var i,r;0===e.length&&0===(null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getSelectedRecordIds().length)||null===(r=this.getLayerDataSource())||void 0===r||r.selectRecordsByIds(e,t)}onLayerDataSourceInfoChange(e,t){var i,r,s;super.onLayerDataSourceInfoChange(e,t),(null===(i=null==t?void 0:t.selectedIds)||void 0===i?void 0:i.length)>0?this.highLightSelectedFeatures():this.clearHighLight(),(null===(r=this.getLayerDataSource())||void 0===r?void 0:r.getCurrentQueryParams())&&this.setDefinitionExpressionForLayer(this.getLayerDataSource().getCurrentQueryParams()),this.view&&((null==t?void 0:t.gdbVersion)&&(this.layer.gdbVersion=t.gdbVersion),!(null==t?void 0:t.gdbVersion)&&this.originalGdbVersion&&(this.layer.gdbVersion=this.originalGdbVersion)),this.setRefreshIntervalForLayer(null===(s=this.getLayerDataSource())||void 0===s?void 0:s.getAutoRefreshInterval())}moveFeatureToCenter(e){return H(this,void 0,void 0,(function*(){return yield this.doQueryById(e).then((t=>t||(this.getLayerDataSource()?this.getLayerDataSource().queryById(e).then((e=>e&&e.feature)):null))).then((t=>H(this,void 0,void 0,(function*(){if(t){const e=this.getCenterPoint(t.geometry);return e?yield this.getMapSceneView().goTo(e):yield Promise.reject("Does not find center point.")}return yield Promise.reject("Dose not find feature."+e)}))))}))}getCenterPoint(e){switch(e.type){case"point":return e;case"extent":return e.center;case"polygon":return e.centroid;case"polyline":return e.extent.center;default:return e&&e.extent?e.extent.center:void 0}}getSelectedRecordIds(){return this.getLayerDataSource()?this.getLayerDataSource().getSelectedRecordIds().filter((e=>!!e)):[]}getLayerDataSource(){return super.getLayerDataSource()}selectRecordsByQuery(e){return H(this,void 0,void 0,(function*(){return yield o(["esri/layers/FeatureLayer"]).then((t=>H(this,void 0,void 0,(function*(){const t=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId),i=t.getParentJimuLayerViews(this.id);let r=!0;for(let e=0;e<i.length;e++)if(!i[e].layer.visible){r=!1;break}if(!r||!this.layer.visible)return yield Promise.resolve([]);this.highlightFeatureLayer&&this.clearHighLight();const s=this.getLayerDataSource();e.geometry=e.geometry.toJSON?e.geometry.toJSON():e.geometry;const a=null==s?void 0:s.dataSourceManager.createLocalDataSource(s,"view");return a&&a.layer?yield a.load(e,{widgetId:"view"}).then((e=>H(this,void 0,void 0,(function*(){if(e&&e.length>0){const i=[],r=[],s=[];for(let t=0;t<e.length;t++)i.push(e[t].getId()),r.push(e[t].feature),s.push(e[t]);return n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(t.mapWidgetId,s)),a.selectRecordsByIds(i),yield Promise.resolve(r)}return yield Promise.resolve([])})))):yield Promise.resolve([])}))),(()=>H(this,void 0,void 0,(function*(){return yield Promise.resolve([])})))).then((e=>H(this,void 0,void 0,(function*(){if(!e||e&&0===e.length){const e=this.getLayerDataSource();null==e||e.selectRecordsByIds([])}return yield Promise.resolve(e)}))))}))}getObjectIdField(e,t){let i=null;for(let r=0;r<e.length;r++)if(e[r].name===t)return i=e[r],i;return i}getRendererForVirtualLayer(e){return["point","multipoint"].includes(e)?{type:"simple",symbol:{type:"simple-marker",style:"circle",color:this.getMapSceneView().highlightOptions.color,size:"16px",outline:{color:this.getMapSceneView().highlightOptions.color,width:1}}}:["polyline"].includes(e)?{type:"simple",symbol:{type:"simple-line",color:this.getMapSceneView().highlightOptions.color,width:1,style:"solid"}}:["polygon","extent"].includes(e)?{type:"simple",symbol:{type:"simple-fill",color:[0,255,255,0],style:"solid",outline:{color:this.getMapSceneView().highlightOptions.color,width:1}}}:["mesh"].includes(e)?{type:"simple",symbol:{type:"mesh-3d",symbolLayers:[{type:"fill",material:{color:this.getMapSceneView().highlightOptions.color}}]}}:null}}var N=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};class Q extends q{constructor(e){super(e),this.features=[],this.isReservePopup=!1,this.localDefinitionExpression="",this.getMapSceneView().popup.watch("selectedFeature",(e=>{if(e){if(!e||!e.layer)return;if(e.layer===this.layer){const t=String(e.attributes[e.layer.objectIdField]),i=this.getLayerDataSource();if(!i)return;if(i.getSelectedRecordIds().includes(t))return;const r=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId);null==i||i.queryById(t).then((e=>{this.selectFeatureById(t,e),this.isReservePopup=!0,n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(r.mapWidgetId,[e]))}))}else this.isReservePopup=!1,this.selectFeatureById(null)}})),this.getMapSceneView().popup.watch("visible",(e=>{const t=this.getMapSceneView();if(!e&&t.popup.selectedFeature&&t.popup.selectedFeature.layer===this.layer){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId);n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(e.mapWidgetId,[])),this.isReservePopup=!1,this.selectFeatureById(null)}})),this.getSelectedRecordIds().length>0?this.moveFeatureToCenter(this.getSelectedRecordIds()[0]).then((()=>{this.highLightSelectedFeatures()})):this.getLayerDataSource()&&this.getLayerDataSource().getSelectedRecordIds().length>0&&this.moveFeatureToCenter(this.getLayerDataSource().getSelectedRecordIds()[0]).then((()=>{this.highLightFeatures(this.getLayerDataSource().getSelectedRecordIds().map((e=>parseInt(e))))}),(e=>console.error(e)))}doQuery(e){return N(this,void 0,void 0,(function*(){return yield new Promise((t=>{this.view.updating?(this.updateWatchHandle&&(this.updateWatchHandle.remove(),this.updateWatchHandle=null),this.updateWatchHandle=this.view.watch("updating",(i=>{i||this.view.queryFeatures(e).then((e=>{this.features=e.features,t(this.features)}))}))):this.view.queryFeatures(e).then((e=>{this.features=e.features,t(this.features)}),(e=>{console.error(e)}))}))}))}doQueryById(e){return N(this,void 0,void 0,(function*(){const t={objectIds:[parseInt(e)],returnGeometry:!0};return yield this.doQuery(t).then((e=>e[0]))}))}setRefreshIntervalForLayer(e){this.view&&null!=e&&((0,n.getAppStore)().getState().appRuntimeInfo.appMode===n.AppMode.Design?this.layer.refreshInterval=0:this.layer.refreshInterval=e/60)}setDefinitionExpressionForLayer(e){var t,i;if(e){if(this.view&&this.view.layer){const i={outFields:["*"],where:this.localDefinitionExpression,returnGeometry:!0},r=null===(t=this.getLayerDataSource())||void 0===t?void 0:t.getRealQueryParams(i,"query");if(r&&(this.view.layer.definitionExpression=r.where),e.geometry){if(this.view.filter&&this.view.filter.geometry===e.geometry)return;o(["esri/geometry/support/jsonUtils"]).then((t=>{const i=t[0];this.view.filter={geometry:i.fromJSON(e.geometry)}}))}else this.view.filter&&(this.view.filter=null);return}if(!this.view&&this.layer){const e={outFields:["*"],where:this.localDefinitionExpression,returnGeometry:!0},t=null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getRealQueryParams(e,"query");t&&(this.layer.definitionExpression=t.where)}}}setLocalDefinitionExpression(e){var t;this.localDefinitionExpression=e,(null===(t=this.getLayerDataSource())||void 0===t?void 0:t.getCurrentQueryParams())&&this.setDefinitionExpressionForLayer(this.getLayerDataSource().getCurrentQueryParams())}highLightSelectedFeatures(){0!==this.getSelectedRecordIds().length&&this.highLightFeatures(this.getSelectedRecordIds().map((e=>parseInt(e))))}highLightFeatures(e){this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null),this.view&&this.view.when((()=>{this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null),this.highLightHandle=this.view.highlight(e)}))}clearHighLight(){this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null,this.isReservePopup&&(this.getMapSceneView().popup.close(),this.isReservePopup=!1))}selectFeatureById(e,t){var i,r;(e||0!==(null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getSelectedRecordIds().length))&&(null===(r=this.getLayerDataSource())||void 0===r||r.selectRecordById(e,t))}selectFeaturesByIds(e,t){var i,r;0===e.length&&0===(null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getSelectedRecordIds().length)||null===(r=this.getLayerDataSource())||void 0===r||r.selectRecordsByIds(e,t)}onLayerDataSourceInfoChange(e,t){var i,r,s;(null===(i=null==t?void 0:t.selectedIds)||void 0===i?void 0:i.length)>0?this.highLightSelectedFeatures():this.clearHighLight(),(null===(r=this.getLayerDataSource())||void 0===r?void 0:r.getCurrentQueryParams())&&this.setDefinitionExpressionForLayer(this.getLayerDataSource().getCurrentQueryParams()),this.setRefreshIntervalForLayer(null===(s=this.getLayerDataSource())||void 0===s?void 0:s.getAutoRefreshInterval())}moveFeatureToCenter(e){return N(this,void 0,void 0,(function*(){return yield this.doQueryById(e).then((t=>t||(this.getLayerDataSource()?this.getLayerDataSource().queryById(e).then((e=>e&&e.feature)):null))).then((t=>N(this,void 0,void 0,(function*(){if(t){const e=this.getCenterPoint(t.geometry);return e?yield this.getMapSceneView().goTo(e):yield Promise.reject("Does not find center point.")}return yield Promise.reject("Dose not find feature."+e)}))))}))}getCenterPoint(e){switch(e.type){case"point":return e;case"extent":return e.center;case"polygon":return e.centroid;case"polyline":return e.extent.center;default:return e&&e.extent?e.extent.center:void 0}}getSelectedRecordIds(){return this.getLayerDataSource()?this.getLayerDataSource().getSelectedRecordIds().filter((e=>!!e)):[]}getLayerDataSource(){return super.getLayerDataSource()}selectRecordsByQuery(e){return N(this,void 0,void 0,(function*(){return yield o(["esri/layers/FeatureLayer"]).then((t=>N(this,void 0,void 0,(function*(){const t=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId),i=t.getParentJimuLayerViews(this.id);let r=!0;for(let e=0;e<i.length;e++)if(!i[e].layer.visible){r=!1;break}if(!r||!this.layer.visible)return yield Promise.resolve([]);const s=this.getLayerDataSource();e.geometry=e.geometry.toJSON?e.geometry.toJSON():e.geometry;const a=null==s?void 0:s.dataSourceManager.createLocalDataSource(s,"view");return a&&a.layer?yield a.load(e,{widgetId:"view"}).then((e=>N(this,void 0,void 0,(function*(){if(e&&e.length>0){const i=[],r=[],s=[];for(let t=0;t<e.length;t++)i.push(e[t].getId()),r.push(e[t].feature),s.push(e[t]);return n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(t.mapWidgetId,s)),a.selectRecordsByIds(i),yield Promise.resolve(r)}return yield Promise.resolve([])})))):yield Promise.resolve([])}))),(()=>N(this,void 0,void 0,(function*(){return yield Promise.resolve([])})))).then((e=>N(this,void 0,void 0,(function*(){if(!e||e&&0===e.length){const e=this.getLayerDataSource();null==e||e.selectRecordsByIds([])}return yield Promise.resolve(e)}))))}))}}class $ extends q{constructor(e){super(e),this.url=null,this.url=e.url,this.layer&&this.layer.watch("visible",(e=>{const t=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).getChildJimuLayerViews(this.id);if(t&&t.length>0)for(let i=0;i<t.length;i++)t[i].virtualLayer&&(t[i].virtualLayer.visible=e&&t[i].layer.visible),t[i].view||t[i].type!==u.FeatureLayer||t[i].highLightSelectedFeatures()}))}}class z extends q{constructor(e){super(e),this.url=null,this.url=e.url,this.layer&&this.layer.watch("visible",(e=>{const t=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).getChildJimuLayerViews(this.id);if(t&&t.length>0)for(let i=0;i<t.length;i++)t[i].virtualLayer&&(t[i].virtualLayer.visible=e&&t[i].layer.visible),t[i].view||t[i].type!==u.FeatureLayer||t[i].highLightSelectedFeatures()}))}}class X extends q{constructor(e){super(e),this.url=null,this.originalGdbVersion=null,this.url=e.url,this.originalGdbVersion=this.layer.gdbVersion,this.layer&&this.layer.watch("visible",(e=>{const t=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).getChildJimuLayerViews(this.id);if(t&&t.length>0)for(let i=0;i<t.length;i++)t[i].virtualLayer&&(t[i].virtualLayer.visible=e&&t[i].layer.visible),t[i].view||t[i].type!==u.FeatureLayer||t[i].highLightSelectedFeatures()}))}onLayerDataSourceInfoChange(e,t){const i=this.getLayerDataSource().getTimeExtent();this.view.layer.useViewTime=null==i,this.view.layer.timeExtent=n.dataSourceUtils.changeJimuTimeToJSAPITimeExtent(i),(null==t?void 0:t.gdbVersion)&&(this.layer.gdbVersion=t.gdbVersion),!(null==t?void 0:t.gdbVersion)&&this.originalGdbVersion&&(this.layer.gdbVersion=this.originalGdbVersion)}}var K,Y,Z=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};!function(e){e.DataAction="DATA_ACTION",e.MessageAction="MESSAGE_ACTION"}(K||(K={})),function(e){e.Create="CREATE",e.Created="CREATED",e.Remove="REMOVE"}(Y||(Y={}));const ee="layer_of_showOnMap_action_",te="layer_of_addToMap_action_";class ie{constructor(e){var t;this.clickHighlightEnabled=!0,this.getJimuLayerViewIdByJimuLayerId=e=>`${this.id}-${e}`,this.getJimuLayerViewIdByAPILayer=e=>this.getJimuLayerViewIdByJimuLayerId(n.dataSourceUtils.getJimuLayerIdByJSAPILayer(e)),this.id=e.mapWidgetId+"-"+e.dataSourceId,this.mapWidgetId=e.mapWidgetId,this.isActive=e.isActive,this.dataSourceId=e.dataSourceId,this.view=e.view,this.mapViewManager=e.mapViewManager,this.jimuLayerViews={},this.status=n.JimuMapViewStatus.Loading,(null===(t=this.view)||void 0===t?void 0:t.popup)&&(this.view.popup.autoOpenEnabled=void 0===e.isEnablePopup||null===e.isEnablePopup||e.isEnablePopup),this.showOnMapDatas={},this.jimuMapTools=[],this.initView(this.view)}addJimuMapTool(e){this.jimuMapTools.find((t=>t.name===e.name))||this.jimuMapTools.push(e)}deleteJimuMapTool(e){this.jimuMapTools.find((t=>t.name===e))&&(this.jimuMapTools=this.jimuMapTools.filter((t=>t.name!==e)))}enableClickOpenPopup(){var e;(null===(e=this.view)||void 0===e?void 0:e.popup)&&(this.view.popup.autoOpenEnabled=!0)}disableClickOpenPopup(){var e;(null===(e=this.view)||void 0===e?void 0:e.popup)&&(this.view.popup.autoOpenEnabled=!1)}isClickOpenPopupEnabled(){var e;if(null===(e=this.view)||void 0===e?void 0:e.popup)return this.view.popup.autoOpenEnabled}enableClickHighlight(){this.clickHighlightEnabled=!0}disableClickHighlight(){this.clickHighlightEnabled=!1}isClickHighlightEnabled(){return this.clickHighlightEnabled}setIsActive(e){this.isActive=e,this.mapViewManager.setJimuMapView(this)}initView(e){e&&e.when((()=>{e.on("click",this.onClick.bind(this))}))}onClick(e){const t={x:e.x,y:e.y},i=this.view.toMap(t);i&&(n.MessageManager.getInstance().publishMessage(new n.LocationChangeMessage(this.mapWidgetId,i.toJSON())),this.view.hitTest(t).then((e=>{if(!this.isClickHighlightEnabled)return;const t=e.results.filter((e=>"graphic"===e.type));this.selectDataSourceByFeatures(this.isClickOpenPopupEnabled(),t.map((e=>e.graphic)),i)}),(()=>{this.clearAllJimuLayerViewsSelectRecord()})))}selectDataSourceByFeatures(e,t,i){if(this.clearAllJimuLayerViewsSelectRecord(),n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(this.mapWidgetId,[])),e)return;const r=t.find((e=>(e.layer.type===u.FeatureLayer||e.layer.type===u.SceneLayer)&&e.layer.popupEnabled));if(!r)return void this.tryIdentifyClickedFeature(i);const s=this.getJimuLayerViewIdByAPILayer(r.layer),a=this.jimuLayerViews[s];if(!a)return;const o=String(r.attributes[r.layer.objectIdField]),l=a.getLayerDataSource();return null==l?void 0:l.queryById(o).then((e=>{a.selectFeatureById(o,e),n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(this.mapWidgetId,[e]))}))}tryIdentifyClickedFeature(e){const t=this.jimuLayerViews[Object.keys(this.jimuLayerViews).find((e=>{const t=this.jimuLayerViews[e].layer;return t.type===u.MapImageLayer||t.type===u.TileLayer}))];if(t)return o(["esri/rest/identify","esri/rest/support/IdentifyParameters"]).then((([i,r])=>{const s=this.getChildJimuLayerViews(t.id).filter((e=>e.layer.popupEnabled)).map((e=>e.layer.id)),a=new r;a.tolerance=3,a.layerIds=s,a.layerOption="top",a.width=this.view.width,a.height=this.view.height,a.geometry=e,a.mapExtent=this.view.extent,a.returnFieldName=!0,a.returnGeometry=!0,a.returnUnformattedValues=!0,i.identify(t.layer.url,a).then((e=>{var i;const r=e.results[0];if(!r)return;const s=`${t.id}-${r.layerId}`,a=this.jimuLayerViews[s];if(!a)return;const o=null===(i=a.getLayerDataSource())||void 0===i?void 0:i.buildRecord(r.feature);a.selectFeatureById(o.getId(),o),n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(this.mapWidgetId,[o]))}))}))}clearAllJimuLayerViewsSelectRecord(){const e=this.jimuLayerViews,t=Object.keys(e);for(let i=0;i<t.length;i++)e[t[i]].selectFeaturesByIds([])}addJimuLayerView(e){this.jimuLayerViews[e.id]=e}whenJimuMapViewLoaded(){return Z(this,void 0,void 0,(function*(){return this.jimuMapViewLoadPromise?yield this.jimuMapViewLoadPromise:this.view?(this.jimuMapViewLoadPromise=this.view.when().then((()=>Z(this,void 0,void 0,(function*(){return yield this.createJimuLayerViews().then((()=>Z(this,void 0,void 0,(function*(){return this.status=n.JimuMapViewStatus.Loaded,this.mapViewManager.setJimuMapView(this),yield Promise.resolve(this)}))))}))),(e=>Z(this,void 0,void 0,(function*(){return console.error(e),this.status=n.JimuMapViewStatus.Failed,this.mapViewManager.setJimuMapView(this),yield Promise.reject(this)})))),yield this.jimuMapViewLoadPromise):(this.status=n.JimuMapViewStatus.Failed,this.mapViewManager.setJimuMapView(this),this.jimuMapViewLoadPromise=Promise.reject(this),yield this.jimuMapViewLoadPromise)}))}getParentJimuLayerViews(e){const t=[];let i=this.jimuLayerViews[e];for(;null==i?void 0:i.parentJimuLayerViewId;){const e=this.jimuLayerViews[i.parentJimuLayerViewId];t.push(e),i=e}return t}getChildJimuLayerViews(e){const t=[];return this.findChildLayerView(e,t),t}findChildLayerView(e,t){const i=this.jimuLayerViews,r=Object.keys(i);for(let s=0;s<r.length;s++)if(i[r[s]].parentJimuLayerViewId===e){const e=i[r[s]];t.push(e),this.findChildLayerView(e.id,t)}}createJimuLayerViews(){return Z(this,void 0,void 0,(function*(){return Promise.all(this.view.map.layers.toArray().map(((e,t)=>Z(this,void 0,void 0,(function*(){try{const i=yield this.view.whenLayerView(e);return(yield this.createJimuLayerView(e,i,null,t)).ready()}catch(e){return console.log("createJimuLayerViews",e),Promise.resolve(null)}}))))).then((()=>null))}))}createJimuLayerView(e,t,i,r,s){var a,o,l;return Z(this,void 0,void 0,(function*(){let d=null,h=null;const c=n.DataSourceManager.getInstance().getDataSource(this.dataSourceId),p=e.id+"",y=n.dataSourceUtils.getJimuLayerIdByJSAPILayer(e),g=i?this.getJimuLayerViewIdByJimuLayerId(i):null,m=(null==c?void 0:c.getDataSourceByLayer(e))||s;if("esri.layers.support.Sublayer"===e.declaredClass){const i=e,s=(null===(a=i.sourceJSON)||void 0===a?void 0:a.layerType)||(null===(o=i.sourceJSON)||void 0===o?void 0:o.type);if((null===(l=i.sublayers)||void 0===l?void 0:l.length)>0){d={jimuLayerId:y,layerDataSourceId:m&&m.id,view:null,jimuMapViewId:this.id,type:u.GroupLayer,layer:i,parentJimuLayerViewId:g,mapViewManager:this.mapViewManager,index:r},h=new $(d),this.addJimuLayerView(h);const e=i.sublayers;if(e&&e.length>0)for(let t=0;t<e.length;t++)yield this.createJimuLayerView(e.getItemAt(t),null,y,t)}else s===n.SupportedLayerServiceTypes.FeatureLayer?(d={jimuLayerId:y,layerDataSourceId:m&&m.id,view:t,jimuMapViewId:this.id,type:u.FeatureLayer,layer:i,parentJimuLayerViewId:g,mapViewManager:this.mapViewManager,index:r},h=new _(d),this.addJimuLayerView(h)):console.log("Unsupported sub layer type.",p)}else{const i=e;switch(i.type){case u.SceneLayer:d={jimuLayerId:y,layerDataSourceId:m&&m.id,view:t,jimuMapViewId:this.id,type:i.type,layer:i,parentJimuLayerViewId:g,mapViewManager:this.mapViewManager,index:r},h=new Q(d),this.addJimuLayerView(h);break;case u.FeatureLayer:d={jimuLayerId:y,layerDataSourceId:m&&m.id,view:t,jimuMapViewId:this.id,type:i.type,layer:i,parentJimuLayerViewId:g,mapViewManager:this.mapViewManager,index:r},h=new _(d),this.addJimuLayerView(h);break;case u.MapImageLayer:case u.TileLayer:d={jimuLayerId:y,layerDataSourceId:m&&m.id,view:t,jimuMapViewId:this.id,type:i.type,layer:i,parentJimuLayerViewId:g,mapViewManager:this.mapViewManager,index:r},i.type===u.MapImageLayer&&(h=new X(d)),i.type===u.TileLayer&&(h=new z(d)),this.addJimuLayerView(h),yield i.loadAll?i.loadAll():i.load();const e=i.sublayers;if(e&&e.length>0)for(let t=0;t<e.length;t++)yield this.createJimuLayerView(e.getItemAt(t),null,y,t);break;case u.GroupLayer:d={jimuLayerId:y,layerDataSourceId:m&&m.id,view:null,jimuMapViewId:this.id,type:i.type,layer:i,parentJimuLayerViewId:g,mapViewManager:this.mapViewManager,index:r},h=new $(d),this.addJimuLayerView(h);const s=i.layers;if(s&&s.length>0)for(let e=0;e<s.length;e++){const t=yield this.view.whenLayerView(s.getItemAt(e));yield this.createJimuLayerView(s.getItemAt(e),t,y,e)}break;default:d={jimuLayerId:y,layerDataSourceId:m&&m.id,view:t,jimuMapViewId:this.id,type:i.type,layer:i,parentJimuLayerViewId:g,mapViewManager:this.mapViewManager,index:r},h=new q(d),this.addJimuLayerView(h)}}return h}))}clearSelectedFeatures(){const e=this.jimuLayerViews,t=Object.keys(e);for(let i=0;i<t.length;i++){const r=e[t[i]];r.type!==u.FeatureLayer&&r.type!==u.SceneLayer||r.selectFeaturesByIds([])}n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(this.mapWidgetId,[]))}selectFeaturesByGraphic(e,t){return Z(this,void 0,void 0,(function*(){return yield o(["esri/geometry/geometryEngine"]).then((i=>Z(this,void 0,void 0,(function*(){const r=i[0];let s=e.geometry;if("point"===s.type||"polyline"===s.type){const e=2.54*this.view.scale/9600;s=r.buffer(s,10*e,"meters")}const a={geometry:s,spatialRelationship:t,returnGeometry:!0,returnZ:!0,outFields:["*"]},n=this.jimuLayerViews,o=Object.keys(n),l=[];for(let e=0;e<o.length;e++){const t=n[o[e]];if(t.type===u.FeatureLayer||t.type===u.SceneLayer){const e=this.getSelectRecordsByQueryPromise(t,a);l.push(e)}}return yield Promise.all(l)}))))}))}getSelectRecordsByQueryPromise(e,t){return Z(this,void 0,void 0,(function*(){return yield e.selectRecordsByQuery(t)}))}destroy(){const e=this.jimuLayerViews,t=Object.keys(e);for(let i=0;i<t.length;i++)e[t[i]].destroy();this.view&&(this.view.destroyed||(this.view.graphics&&this.view.graphics.destroyed&&this.view.graphics.destroy(),this.view.container=null,this.view.allLayerViews&&this.view.allLayerViews.destroyed&&this.view.allLayerViews.destroy(),this.view.layerViews&&this.view.layerViews.destroyed&&this.view.layerViews.destroy(),this.jimuMapTools=[],this.view.destroy(),this.view=null))}_getDefaultJimuMapViewId(){const e=(0,n.getAppStore)().getState().jimuMapViewsInfo;return Object.keys(e||{}).find((t=>e[t].mapWidgetId===this.mapWidgetId))}drawDataOnMap(e){Object.entries(e).forEach((e=>{let t=e[1].jimuMapViewId;t||e[1].mapWidgetId!==this.mapWidgetId||(t=this._getDefaultJimuMapViewId()),this.showOnMapDatas[e[0]]||t!==this.id?t===this.id&&this.updateDrawnDataRecordSet(e[1].dataSet,e[0],e[1].title,e[1].symbolOption):this.drawDataRecordSet(e[1].dataSet,e[0],e[1].title,e[1].symbolOption),this.showOnMapDatas[e[0]]=e[1]})),Object.entries(this.showOnMapDatas).forEach((t=>{if(!e[t[0]]){const e=this.view.map.findLayerById(t[0]);delete this.showOnMapDatas[t[0]],e&&this.view.map.remove(e)}}))}drawDataRecordSet(e,t,i,r){return Z(this,void 0,void 0,(function*(){return o(["esri/layers/GraphicsLayer"]).then((s=>Z(this,void 0,void 0,(function*(){const[a]=s,n=yield this.getGraphicsFromRecords(e,r),o=new a({id:t,title:i,listMode:"hide",graphics:n});return this.view.map.add(o),n})))).catch((e=>(console.warn(e),[])))}))}updateDrawnDataRecordSet(e,t,i,r){return Z(this,void 0,void 0,(function*(){const i=this.view.map.findLayerById(t);let s=[];return i&&e.records.some(((e,i)=>{var r,s;return e.getId()!==(null===(s=null===(r=this.showOnMapDatas[t])||void 0===r?void 0:r.dataSet.records[i])||void 0===s?void 0:s.getId())}))&&(i.removeAll(),s=yield this.getGraphicsFromRecords(e,r),i.addMany(s)),Promise.resolve(s)}))}getGraphicsFromRecords(e,t){return Z(this,void 0,void 0,(function*(){return o(["esri/symbols/support/symbolUtils","esri/symbols/support/jsonUtils"]).then((i=>Z(this,void 0,void 0,(function*(){const[r,s]=i,a=yield B(e);for(let i=0;i<a.features.length;i++){const o=a.features[i];o.symbol||(o.symbol=yield this.getSymbol(r,s,o,n.dataSourceUtils.changeRestAPIGeometryTypeToJSAPIGeometryType(e.dataSource.getGeometryType()),t))}return a.features})))).catch((e=>(console.warn(e),null)))}))}getSymbol(e,t,i,r,s){return Z(this,void 0,void 0,(function*(){return(null==s?void 0:s.pointSymbol)&&"point"===r?Promise.resolve(t.fromJSON(s.pointSymbol)):(null==s?void 0:s.polylineSymbol)&&"polyline"===r?Promise.resolve(t.fromJSON(s.polylineSymbol)):(null==s?void 0:s.polygonSymbol)&&"polygon"===r?Promise.resolve(t.fromJSON(s.polygonSymbol)):void 0===s?this.getDefaultSymbol(e,t,i,r):this.getDefaultSymbolByRenderer(e,i,r)||this.getDefaultSymbol(e,t,i,r)}))}getDefaultSymbol(e,t,i,r){return Z(this,void 0,void 0,(function*(){let s=G(r);if(s=t.fromJSON(s),(null==i?void 0:i.layer)&&"polyline"===r){const t=yield this.getDefaultSymbolByRenderer(e,i,r);(null==t?void 0:t.color)?t.color=s.color:(null==t?void 0:t.material)&&(t.material.color=s.color),s=t}return Promise.resolve(s)}))}getDefaultSymbolByRenderer(e,t,i){return Z(this,void 0,void 0,(function*(){return e.getDisplayedSymbol(t).then((e=>e)).catch((()=>null))}))}addOrRemoveDataOnMap(e){Object.entries(e).forEach((t=>{const i=t[0],r=t[1];let s=r.jimuMapViewId;s||r.mapWidgetId!==this.mapWidgetId||(s=this._getDefaultJimuMapViewId()),s===this.id&&r.dataChangeType===Y.Create?this.addLayerToMap(r.dataSourceId,i,r.title):s===this.id&&r.dataChangeType===Y.Remove&&(this.removeLayerFromMap(i),delete e[i])}))}addLayerToMap(e,t,i){const r=n.DataSourceManager.getInstance().getDataSource(e);null==r||r.createJSAPILayerByDataSource().then((e=>{e.id=t,this.view.map.add(e),this.view.whenLayerView(e).then((t=>{this.createJimuLayerView(e,t,null,this.getMaxLayerIndex(),r)}))})),n.MutableStoreManager.getInstance().updateStateValue(this.mapWidgetId,`addToMapDatas.${t}.dataChangeType`,Y.Created)}getMaxLayerIndex(){let e=0;return Object.keys(this.jimuLayerViews).filter((e=>!this.jimuLayerViews[e].parentJimuLayerViewId)).forEach((t=>{e=Math.max(this.jimuLayerViews[t].index,e)})),e}removeLayerFromMap(e){const t=this.view.map.findLayerById(e);t&&this.view.map.remove(t)}}class re{constructor(e){this.switchMap=()=>{return e=this,t=void 0,r=function*(){return this.mapWidgetInstance?yield this.mapWidgetInstance.switchMap():yield Promise.resolve()},new((i=void 0)||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}));var e,t,i,r},this.fullScreenMap=()=>{this.mapWidgetInstance&&this.mapWidgetInstance.fullScreenMap()},this.mapWidgetId=e,this.jimuMapViews={}}setMapWidgetInstance(e){this.mapWidgetInstance=e}addJimuMapView(e){this.jimuMapViews[e.id]=e}setJimuMapView(e){this.jimuMapViews[e.id]=e}removeJimuMapView(e){delete this.jimuMapViews[e.id]}getActiveJimuMapView(){const e=Object.keys(this.jimuMapViews);for(let t=0;t<e.length;t++)if(this.jimuMapViews[e[t]].isActive)return this.jimuMapViews[e[t]];return null}}class se{constructor(){this.jimuMapViewGroups={}}static getInstance(){return window.jimuConfig.isBuilder?window._appWindow&&window._appWindow._mapViewManager:(se._instance||(se._instance=new se,window._mapViewManager=se._instance),se._instance)}getJimuMapViewById(e){const t=Object.keys(this.jimuMapViewGroups);if(0===t.length)return null;for(let i=0;i<t.length;i++){const r=t[i];if(Object.keys(this.jimuMapViewGroups[r].jimuMapViews).includes(e))return this.jimuMapViewGroups[r].jimuMapViews[e]}return null}getJimuMapViewGroup(e){return this.jimuMapViewGroups[e]?this.jimuMapViewGroups[e]:null}createJimuMapView(e){return t=this,i=void 0,s=function*(){const t=e.mapWidgetId+"-"+e.dataSourceId;if(this.getJimuMapViewById(t))return yield Promise.resolve(this.getJimuMapViewById(t));const i=new ie(e);return this.addJimuMapView(i),yield i.whenJimuMapViewLoaded()},new((r=void 0)||(r=Promise))((function(e,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function o(e){try{l(s.throw(e))}catch(e){a(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof r?i:new r((function(e){e(i)}))).then(n,o)}l((s=s.apply(t,i||[])).next())}));var t,i,r,s}addJimuMapView(e){if(this.jimuMapViewGroups[e.mapWidgetId])this.jimuMapViewGroups[e.mapWidgetId].addJimuMapView(e);else{const t=new re(e.mapWidgetId);t.addJimuMapView(e),this.jimuMapViewGroups[e.mapWidgetId]=t}(0,n.getAppStore)().dispatch(n.appActions.jimuMapViewAdded(e.id,(0,n.Immutable)({id:e.id,mapWidgetId:e.mapWidgetId,dataSourceId:e.dataSourceId,status:e.status})))}setJimuMapView(e){if(this.jimuMapViewGroups[e.mapWidgetId])this.jimuMapViewGroups[e.mapWidgetId].setJimuMapView(e);else{const t=new re(e.mapWidgetId);t.addJimuMapView(e),this.jimuMapViewGroups[e.mapWidgetId]=t}(0,n.getAppStore)().dispatch(n.appActions.jimuMapViewUpdated(e.id,(0,n.Immutable)({id:e.id,mapWidgetId:e.mapWidgetId,dataSourceId:e.dataSourceId,isActive:e.isActive,status:e.status})))}destroyJimuMapView(e){const t=this.getJimuMapViewById(e);t&&t.destroy();const i=Object.keys(this.jimuMapViewGroups);if(0===i.length);else for(let t=0;t<i.length;t++){const r=i[t];if(Object.keys(this.jimuMapViewGroups[r].jimuMapViews).includes(e)){delete this.jimuMapViewGroups[r].jimuMapViews[e],0===Object.keys(this.jimuMapViewGroups[r].jimuMapViews).length&&delete this.jimuMapViewGroups[r],(0,n.getAppStore)().dispatch(n.appActions.jimuMapViewRemoved(e));break}}}getAllJimuMapViewIds(){const e=[];return Object.keys(this.jimuMapViewGroups).forEach((t=>{Object.keys(this.jimuMapViewGroups[t].jimuMapViews).forEach((t=>{e.push(t)}))})),e}destroyAllJimuMapViews(){this.getAllJimuMapViewIds().forEach((e=>{this.destroyJimuMapView(e)}))}}var ae=s(796),ne=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};const{loadModules:oe,resolveModuleFullPath:le}=n.moduleLoader,{getPortalProxyUrl:ue,getStandardPortalUrl:de,isAGOLDomain:he,isSamePortalUrl:ce,getPlatformUrlByOrgUrl:pe}=n.portalUrlUtils,{normalize:ye,getFolder:ge}=n.urlUtils,{removeFromLocalStorage:me,removeFromSessionStorage:ve}=n.utils;let fe,we,Ie,Se;class Le{constructor(){this.id="arcgis-dependency-define"}getDependencyKey(){return"jimu-arcgis"}getResources(){this.themeLoadObserver||(this.themeLoadObserver=ae.ThemeStore.subscribe(this.onCurrentThemeLoad.bind(this)));let e=window.jimuConfig.arcgisJsApiUrl;if((0,n.getAppStore)().getState().queryObject.apiurl&&(e=(0,n.getAppStore)().getState().queryObject.apiurl,!this.checkApiUrl(e)))return void console.log("Bad apiurl.",e);/\/$/.test(e)||(e+="/"),window.jimuConfig.arcgisJsApiUrl=e;const t=[{url:`${e}init.js`}];return(0,ae.getTheme)()&&((0,ae.getTheme)().darkTheme?(document.body.classList.add("calcite-mode-dark"),t.push({url:this.getAPIThemeUrl(e,!0)})):t.push({url:this.getAPIThemeUrl(e,!1)})),[{url:"jimu-arcgis",dependencies:t}]}postInit(){var e,t,i;return ne(this,void 0,void 0,(function*(){yield this.initModules(),this.initToRegistOAuthForMainPortalAndAGOL();const r=(0,n.getAppStore)().getState().portalUrl;Se.setLocale((0,n.getAppStore)().getState().appContext.locale),Ie.request.proxyUrl=ue(r),this.initInterceptor(),Ie.portalUrl=r;const s=null===(i=null===(t=null===(e=(0,n.getAppStore)().getState().portalSelf)||void 0===e?void 0:e.helperServices)||void 0===t?void 0:t.geometry)||void 0===i?void 0:i.url;s&&(Ie.geometryServiceUrl=s),this.addToTrustedServers(),(window.jimuConfig.isBuilder||window.jimuConfig.isInBuilder)&&(window.jimuConfig.isDevEdition||window.jimuConfig.isInPortal)?this.replaceGetCredential():this.replaceGetCredential(!1)}))}initModules(){return ne(this,void 0,void 0,(function*(){[we,fe,Ie,Se]=yield oe(["esri/identity/IdentityManager","esri/identity/OAuthInfo","esri/config","esri/intl"])}))}initInterceptor(){var e;n.requestUtils.registerCacheableUrl(Ve),n.requestUtils.registerCacheableUrl(be),n.requestUtils.registerCacheableUrl(je),null===(e=Ie.request.interceptors)||void 0===e||e.push({before:e=>{var t,i,r;if(!n.requestUtils.isURLCacheable(e.url,null===(t=e.requestOptions)||void 0===t?void 0:t.query))return;const s=n.requestUtils.getRequestCache(e.url,null===(i=e.requestOptions)||void 0===i?void 0:i.query);if(s)return s.promise;{const t=new n.ExternalResolvablePromise;n.requestUtils.setRequestCache(e.url,null===(r=e.requestOptions)||void 0===r?void 0:r.query,t)}},after:e=>{var t,i,r;if(!e||!e.url)return;if(e.url.indexOf("/rest/info")&&(null===(t=e.data)||void 0===t?void 0:t.owningSystemUrl)&&this.registOAuthInfo(e.data.owningSystemUrl),!n.requestUtils.isURLCacheable(e.url,null===(i=e.requestOptions)||void 0===i?void 0:i.query))return;const s=n.requestUtils.getRequestCache(e.url,null===(r=e.requestOptions)||void 0===r?void 0:r.query);s&&s.resolve(e.data)},error:e=>{var t,i,r,s,a,o;const l=n.requestUtils.getRequestCache(null===(t=null==e?void 0:e.details)||void 0===t?void 0:t.url,null===(r=null===(i=null==e?void 0:e.details)||void 0===i?void 0:i.requestOptions)||void 0===r?void 0:r.query);l&&(l.reject(e),n.requestUtils.deleteRequestCache(null===(s=null==e?void 0:e.details)||void 0===s?void 0:s.url,null===(o=null===(a=null==e?void 0:e.details)||void 0===a?void 0:a.requestOptions)||void 0===o?void 0:o.query))}})}replaceGetCredential(e=!0){const t=n.SessionManager.getInstance(),i=we.getCredential;let r;we.getCredential=(s,a)=>{try{const o=!!t.getServerKeyFromUrl(s),l=n.SessionManager.getInstance().getClientIdByUrl(s);if(!(o||l||!(null==a?void 0:a.prompt)||we.findCredential(s)||we.findOAuthInfo(s))&&e){const e=de(s);return t.useDialogToSetClientIdToConnectiosOfAppConfigAndSignIn(e).then((()=>{this.registOAuthInfo(e),r=i.call(we,s,a)})).catch((()=>{r=i.call(we,s,a)}))}return r=i.call(we,s,a),r.then((e=>(null==s?void 0:s.indexOf("/sharing/rest/portals/self"))>0?Promise.resolve(e):n.SessionManager.getInstance().isValidToken(s,e.token).then((r=>{var o;if(r.valid)return e;if(403===(null===(o=null==r?void 0:r.error)||void 0===o?void 0:o.code)){let r;return r="server"===e.scope?n.ServiceManager.getInstance().fetchArcGISServerInfo(e.server).then((e=>null==e?void 0:e.owningSystemUrl)):Promise.resolve(e.server),r.then((r=>ne(this,void 0,void 0,(function*(){if(!t.getFlagForSignInAgainWhen403Error(r))return e;const o=we.findCredential(r,e.userId);try{this.removePortalAndItsServerCredentials(o)}catch(e){console.warn(null==e?void 0:e.message)}a.prompt=!0,ce(pe(r),pe((0,n.getAppStore)().getState().portalUrl))&&(ve("esriJSAPIOAuth"),me("esriJSAPIOAuth"));const l=we.findOAuthInfo(r);l&&l.set("forceLogin",!0);const u=i.call(we,s,a).then((e=>(l&&l.set("forceLogin",!1),e)));return u}))))}return e})).catch((t=>(console.warn(null==t?void 0:t.message),e)))))}catch(e){return console.warn('replaced "getCredential" method error',e),i.call(we,s,a)}}}initToRegistOAuthForMainPortalAndAGOL(){return ne(this,void 0,void 0,(function*(){const e=n.SessionManager.getInstance(),{portalUrl:t,isWebTier:i}=(0,n.getAppStore)().getState();i||(he(t)?this.registOAuthInfo(pe(t)):this.registOAuthInfo(t)),this.registOAuthInfo("https://devext.arcgis.com"),this.registOAuthInfo("https://qaext.arcgis.com"),this.registOAuthInfo("https://www.arcgis.com"),this.syncToArcgisJSAPI(e.getSessions()),e.addSessionChangeListener(this.onSessionChangedCallback.bind(this)),this.listeningJsApiSignIn()}))}registOAuthInfo(e,t){let i=we.findOAuthInfo(e);if(t=t||n.SessionManager.getInstance().getClientIdByUrl(e),!i&&t){const r=ye(`${window.location.origin}${ge(le("jimu-arcgis"))}/oauth-callback.html`);i=new fe({appId:t,expiration:20159,portalUrl:e,authNamespace:"/",popup:!0,flowType:this.getFlowTypeForRegisteringOAuthInfo(e),popupCallbackUrl:r}),we.registerOAuthInfos([i])}}getFlowTypeForRegisteringOAuthInfo(e){var t;let i;if(he(e))return"authorization-code";if(ce(e,(0,n.getAppStore)().getState().portalUrl))i=null===(t=(0,n.getAppStore)().getState().portalSelf)||void 0===t?void 0:t.currentVersion;else{const t=n.appConfigUtils.getConnectionInfoFromAppConfig(e);i=null==t?void 0:t.portalVersion}return i&&Number(i)>=8.4?"authorization-code":"auto"}removePortalAndItsServerCredentials(e){if("portal"===(null==e?void 0:e.scope)){const t=[];we.credentials.forEach((i=>{if("server"===i.scope){const r=we.serverInfos.find((e=>e.server===i.server)),s=we.findCredential(null==r?void 0:r.owningSystemUrl,e.userId);e.server===(null==s?void 0:s.server)&&t.push(i)}})),t.forEach((e=>(null==e?void 0:e.server)&&e.destroy())),(null==e?void 0:e.server)&&e.destroy()}}addCredentialToSessionManger(e){const t=n.SessionManager.getInstance();"server"===e.scope&&e.server?n.ServiceManager.getInstance().fetchArcGISServerInfo(e.server).then((i=>ne(this,void 0,void 0,(function*(){t.addFromArcGisJSCredential(e,i)})))):t.addFromArcGisJSCredential(e,null)}listeningJsApiSignIn(){we.on("credential-create",(({credential:e})=>{this.addCredentialToSessionManger(e),e.on("token-change",(()=>{this.addCredentialToSessionManger(e)}))}))}syncToArcgisJSAPI(e){var t;e&&e.forEach((e=>{var t;const i=e.server?`${e.server}/rest/services`:e.portal,r=we.findCredential(i);if((!r||e.username!==r.userId)&&(we.registerToken({server:i,token:e.token,expires:null===(t=e.tokenExpires)||void 0===t?void 0:t.getTime(),ssl:e.ssl,userId:e.username}),e.server)){const t=we.findServerInfo(e.server);t&&(t.owningSystemUrl=de(e.portal),t.tokenServiceUrl="",t.adminTokenServiceUrl="",t.hasPortal=!0)}}));const i=[],r=n.SessionManager.getInstance();null===(t=we.credentials)||void 0===t||t.forEach((t=>{const s="server"===t.scope?`${t.server}/rest/services`:t.server,a=r.getSessionKeyFromUrl(s);e.find((e=>{const i=n.SessionManager.getInstance().getSessionKeyFromSession(e);return a===i&&t.userId===e.username}))||i.push(t)})),i.forEach((e=>e.destroy()))}onSessionChangedCallback(e,t){t!==n.SessionChangedReasonType.ArcGISJSSync&&this.syncToArcgisJSAPI(e)}addToTrustedServers(){const{portalUrl:e,isWebTier:t}=(0,n.getAppStore)().getState(),i=n.SessionManager.getInstance().getTrustedServers();t&&Ie.request.trustedServers.push(e),i.forEach((e=>{Ie.request.trustedServers.includes(e)||Ie.request.trustedServers.push(e)}))}onCurrentThemeLoad(e){e&&(this.checkAPITheme(this.getAPIThemeUrl(window.jimuConfig.arcgisJsApiUrl,e.variables.darkTheme))||(this.removeApiThemeStyle(this.getAPIThemeUrl(window.jimuConfig.arcgisJsApiUrl,!e.variables.darkTheme)),n.moduleLoader.loadModule(this.getAPIThemeUrl(window.jimuConfig.arcgisJsApiUrl,e.variables.darkTheme)),e.variables.darkTheme&&!document.body.classList.contains("calcite-mode-dark")?document.body.classList.add("calcite-mode-dark"):document.body.classList.remove("calcite-mode-dark"),se.getInstance().getAllJimuMapViewIds().forEach((t=>{var i;const r=null===(i=se.getInstance().getJimuMapViewById(t).view)||void 0===i?void 0:i.ui.container;r&&(e.variables.darkTheme&&!r.classList.contains("calcite-mode-dark")?(r.classList.remove("calcite-theme-light"),r.classList.add("calcite-mode-dark")):(r.classList.remove("calcite-mode-dark"),r.classList.add("calcite-theme-light")))}))))}removeApiThemeStyle(e){var t;n.moduleLoader.deleteModule(e),null===(t=document.querySelector(`link[href="${e}"]`))||void 0===t||t.remove()}getAPIThemeUrl(e,t){return t?`${e}esri/themes/dark/main.css`:`${e}esri/css/main.css`}checkAPITheme(e){return!!document.querySelector(`link[href="${e}"]`)}checkApiUrl(e){return"development"===window.env||!/^\/\//.test(e)&&!/^https?:\/\//.test(e)||/(?:[\w\-\_]+\.)+(?:esri|arcgis)\.com/.test(e)}}class Me{constructor(){this.id="arcgis-ds-factory"}getFactoryUri(e){if(Object.keys(l).map((e=>l[e])).includes(e))return"jimu-arcgis/arcgis-data-source"}}function Ve(e,t){return/rest\/services\/(.+)\/(MapServer|FeatureServer|ImageServer)\/(\d+)\/?$/.test(e)}function be(e,t){return/sharing\/rest\/community\/self\/?$/.test(e)}function je(e,t){const i="sharing/rest/content/items/",r=e.indexOf(i);if(r>-1){const t=e.substring(r+i.length).split("/");if(t.length>0&&(1===t.length||"data"===t[t.length-1]))return!0}return!1}class Pe extends n.React.PureComponent{constructor(){super(...arguments),this.viewManager=se.getInstance(),this.onViewsCreate=e=>{this.props.onViewsCreate&&this.props.onViewsCreate(e)},this.onViewGroupCreate=()=>{if(this.props.onViewGroupCreate&&this.viewManager&&this.props.useMapWidgetId){const e=this.viewManager.getJimuMapViewGroup(this.props.useMapWidgetId);this.props.onViewGroupCreate(e)}},this.onActiveViewChange=e=>{if(!this.props.onActiveViewChange)return;const t=this.viewManager&&this.viewManager.getJimuMapViewById(this.getActiveViewId(this.props.useMapWidgetId,this.props.viewInfos))||null;this.props.onActiveViewChange(t,e)},this.getActiveViewId=(e,t)=>t&&Object.keys(t).find((i=>t[i].mapWidgetId===e&&t[i].isActive)),this.getWhetherAllViewsCreated=(e,t,i)=>!((null==e?void 0:e.length)<(null==i?void 0:i.length))&&(null==e?void 0:e.length)>0&&!e.some((e=>!this.getWhetherViewCreated(e,t))),this.getWhetherViewCreated=(e,t)=>!!(e&&t&&t[e]&&t[e].status&&t[e].status===n.JimuMapViewStatus.Loaded),this.getViewIdsFromMapWidgetId=(e,t)=>t?Object.keys(t).filter((i=>t[i].mapWidgetId===e)):[],this.getViews=e=>{if(!e)return null;const t={};return e.forEach((e=>{t[e]=this.viewManager.getJimuMapViewById(e)})),t}}componentDidMount(){const{useMapWidgetId:e,viewInfos:t,useDataSources:i}=this.props,r=this.getViewIdsFromMapWidgetId(e,t);if(r.length>0&&this.onViewGroupCreate(),this.getWhetherAllViewsCreated(r,t,i)){const e=this.getViews(r);this.onViewsCreate(e)}const s=this.getActiveViewId(e,t);s&&this.getWhetherViewCreated(s,t)&&this.onActiveViewChange(null)}componentDidUpdate(e){const t=this.getViewIdsFromMapWidgetId(e.useMapWidgetId,e.viewInfos),i=this.getViewIdsFromMapWidgetId(this.props.useMapWidgetId,this.props.viewInfos);if(0===t.length&&i.length>0&&this.onViewGroupCreate(),!this.getWhetherAllViewsCreated(t,e.viewInfos,e.useDataSources)&&this.getWhetherAllViewsCreated(i,this.props.viewInfos,this.props.useDataSources)){const e=this.getViews(i);this.onViewsCreate(e)}this.getActiveViewId(e.useMapWidgetId,e.viewInfos)!==this.getActiveViewId(this.props.useMapWidgetId,this.props.viewInfos)&&this.onActiveViewChange(null)}render(){if(!this.props.useMapWidgetId||!this.props.viewInfos||!this.props.children)return null;const e=this.getViewIdsFromMapWidgetId(this.props.useMapWidgetId,this.props.viewInfos),t=this.getViews(e);return"function"==typeof this.props.children?this.props.children(t):this.props.children}}const De=n.ReactRedux.connect(((e,t)=>{var i,r,s;const a=null!==(i=e.appStateInBuilder)&&void 0!==i?i:e;return{viewInfos:a.jimuMapViewsInfo,useDataSources:null===(s=null===(r=a.appConfig)||void 0===r?void 0:r.widgets[t.useMapWidgetId])||void 0===s?void 0:s.useDataSources}}))(Pe);class Fe extends n.React.PureComponent{constructor(){super(...arguments),this.getJimuMapViewIdsFromUseMapWidgetIds=(e,t,i)=>{let r=[];return e&&e.forEach((e=>{r=r.concat(this.getJimuMapViewIdsFromMapWidgetId(e,t,i))})),r},this.getJimuMapViewIdsFromMapWidgetId=(e,t,i)=>i&&t?Object.keys(t).filter((r=>t[r].mapWidgetId===e&&t[r].dataSourceId===i)):[]}componentDidMount(){const e=this.getJimuMapViewIdsFromUseMapWidgetIds(this.props.useMapWidgetIds,this.props.viewInfos,this.props.jimuLayerViewInfo&&this.props.jimuLayerViewInfo.rootDataSourceId);if(e[0]&&this.props.viewInfos[e[0]].status===n.JimuMapViewStatus.Loaded&&this.props.jimuLayerViewInfo&&this.props.jimuLayerViewInfo.jimuMapViewId&&this.props.jimuLayerViewInfo.jimuLayerId){const t=se.getInstance().getJimuMapViewById(e[0]).jimuLayerViews[this.props.jimuLayerViewInfo.jimuMapViewId+"-"+this.props.jimuLayerViewInfo.jimuLayerId];t?this.props.onLayerViewCreated&&this.props.onLayerViewCreated(t):this.props.onLayerViewCreated&&this.props.onLayerViewCreated(null)}e[0]&&this.props.viewInfos[e[0]].status===n.JimuMapViewStatus.Failed&&this.props.jimuLayerViewInfo&&this.props.jimuLayerViewInfo.jimuMapViewId&&this.props.jimuLayerViewInfo.jimuLayerId&&this.props.onLayerViewFailed&&this.props.onLayerViewFailed(null)}componentDidUpdate(e,t){const i=this.getJimuMapViewIdsFromUseMapWidgetIds(e.useMapWidgetIds,e.viewInfos,e.jimuLayerViewInfo&&e.jimuLayerViewInfo.rootDataSourceId),r=e.viewInfos[i[0]],s=r&&r.status,a=this.getJimuMapViewIdsFromUseMapWidgetIds(this.props.useMapWidgetIds,this.props.viewInfos,this.props.jimuLayerViewInfo&&this.props.jimuLayerViewInfo.rootDataSourceId),o=this.props.viewInfos[a[0]],l=o&&o.status;if(s!==l||s===l&&i.join("")===a.join(""))if(o){if(o.status===n.JimuMapViewStatus.Loaded){const e=se.getInstance().getJimuMapViewById(a[0]).jimuLayerViews[this.props.jimuLayerViewInfo.jimuMapViewId+"-"+this.props.jimuLayerViewInfo.jimuLayerId];e?this.props.onLayerViewCreated&&this.props.onLayerViewCreated(e):this.props.onLayerViewCreated&&this.props.onLayerViewCreated(null)}o.status===n.JimuMapViewStatus.Failed&&this.props.onLayerViewFailed&&this.props.onLayerViewFailed(null)}else this.props.onLayerViewCreated&&this.props.onLayerViewCreated(null)}render(){return null}}const Ae=n.ReactRedux.connect(((e,t)=>({viewInfos:e&&e.jimuMapViewsInfo})))(Fe);function Ce(){return e=this,t=void 0,r=function*(){return yield Promise.resolve()},new((i=void 0)||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}));var e,t,i,r}})(),a})())}}}));
System.register(["jimu-core","jimu-core/emotion","jimu-ui"],function(e,t){var i={},r={},s={};return{setters:[function(e){i.AppMode=e.AppMode,i.AppStateManager=e.AppStateManager,i.CONSTANTS=e.CONSTANTS,i.DataRecordsSelectionChangeMessage=e.DataRecordsSelectionChangeMessage,i.DataSourceManager=e.DataSourceManager,i.DataSourceSelectionMode=e.DataSourceSelectionMode,i.DataSourceStatus=e.DataSourceStatus,i.DataSourceTypes=e.DataSourceTypes,i.ExBAddedJSAPIProperties=e.ExBAddedJSAPIProperties,i.Immutable=e.Immutable,i.JSAPILayerTypes=e.JSAPILayerTypes,i.JimuMapViewStatus=e.JimuMapViewStatus,i.MessageManager=e.MessageManager,i.MutableStoreManager=e.MutableStoreManager,i.React=e.React,i.ReactRedux=e.ReactRedux,i.SupportedLayerServiceTypes=e.SupportedLayerServiceTypes,i.UrlManager=e.UrlManager,i.WidgetState=e.WidgetState,i.appActions=e.appActions,i.appConfigUtils=e.appConfigUtils,i.dataSourceUtils=e.dataSourceUtils,i.defaultMessages=e.defaultMessages,i.geometryUtils=e.geometryUtils,i.getAppStore=e.getAppStore,i.i18n=e.i18n,i.loadArcGISJSAPIModule=e.loadArcGISJSAPIModule,i.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules,i.lodash=e.lodash,i.observeStore=e.observeStore,i.portalUrlUtils=e.portalUrlUtils,i.requestUtils=e.requestUtils,i.urlUtils=e.urlUtils,i.useIntl=e.useIntl,i.utils=e.utils,i.uuidv1=e.uuidv1},function(e){r.jsx=e.jsx,r.jsxs=e.jsxs},function(e){s.defaultMessages=e.defaultMessages}],execute:function(){e((()=>{"use strict";var e={244:e=>{e.exports=i},321:e=>{e.exports=s},386:e=>{e.exports=r}},t={};function a(i){var r=t[i];if(void 0!==r)return r.exports;var s=t[i]={exports:{}};return e[i](s,s.exports,a),s.exports}a.d=(e,t)=>{for(var i in t)a.o(t,i)&&!a.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};a.r(n),a.d(n,{ActionType:()=>Kt,DataChangeStatus:()=>ei,DataChangeType:()=>Zt,JimuBuildingComponentSublayerView:()=>_e,JimuBuildingGroupSublayer:()=>He,JimuBuildingSceneLayerView:()=>We,JimuFeatureLayerView:()=>Re,JimuGroupLayerView:()=>Je,JimuImageryLayerView:()=>Qe,JimuImageryTileLayerView:()=>je,JimuLayerView:()=>Ae,JimuLayerViewComponent:()=>oi,JimuMapImageLayerView:()=>De,JimuMapServiceLayerView:()=>Ee,JimuMapView:()=>si,JimuMapViewComponent:()=>ni,JimuMapViewGroup:()=>_t,JimuOrientedImageryLayerView:()=>Ne,JimuQueriableLayerView:()=>Be,JimuSceneLayerView:()=>ke,JimuSubtypeGroupLayerView:()=>$e,JimuSubtypeSublayerView:()=>Xe,JimuTileLayerView:()=>xe,MapViewManager:()=>Nt,SnappingUtils:()=>h,basemapUtils:()=>c,defaultMessages:()=>Me,featureUtils:()=>u,geometryUtils:()=>y.geometryUtils,init:()=>ui,loadArcGISJSAPIModules:()=>C,mapViewUtils:()=>d,portalUtils:()=>l,zoomToUtils:()=>o});var o={};a.r(o),a.d(o,{getExtentFromScale:()=>D,layerExtent:()=>Y,projectToSpatialReference:()=>X,zoomTo:()=>E});var l={};a.r(l),a.d(l,{checkDefaultBaseMapIsExist:()=>ee,getDefaultWebMap:()=>te,getDefaultWebMapWithoutCache:()=>ie,getItemQueryStringByTypes:()=>re});var u={};a.r(u),a.d(u,{convertDataRecordSetToFeatureSet:()=>se,getDefaultSymbol:()=>ae});var c={};a.r(c),a.d(c,{BasemapGroupType:()=>ne,getBasemapGroup:()=>de,getBasemapItemsByGroup:()=>ue,getBasemapItemsByGroupId:()=>he,getLoadedBasemapList:()=>pe,getOrgBasemaps:()=>ce,isBasemap3D:()=>le,loadBasemap:()=>ye});var d={};a.r(d),a.d(d,{getCopiedJimuLayerViewId:()=>fe,getCopiedJimuMapViewId:()=>ge});var h={};a.r(h),a.d(h,{getAllSnappingLayerItems:()=>Se,getSnappingFeatureSourcesCollection:()=>be,useGetTipsForSnappingOptions:()=>Ve});var y=a(244),p=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};function g(e,t){var i;const r={};if(e.type!==y.DataSourceTypes.SubtypeGroupLayer)return r;const s={},a=e.getSubtypeField();t.forEach(e=>{const t=e.getFieldValue(a);null!=t&&(s[t]||(s[t]=[]),s[t].push(e))});let n=null===(i=e.getChildDataSources)||void 0===i?void 0:i.call(e);return n||(n=[]),n.forEach(e=>{if(e.type!==y.DataSourceTypes.SubtypeSublayer)return;const t=e.getSubtypeCode(),i=(s[t]||[]).map(t=>{const i=t.clone();return i.dataSource=e,i});r[e.id]=i}),r}function f(e,t){const i=e.getMapWidgetId(),r=new y.DataRecordsSelectionChangeMessage(i,t,[e.layerDataSourceId]);y.MessageManager.getInstance().publishMessage(r),e.type===y.JSAPILayerTypes.SubtypeGroupLayer?function(e,t,i){const r=t.getLayerDataSource();if(!r)return;const s=g(r,i),a=y.MessageManager.getInstance();Object.keys(s).forEach(t=>{const i=s[t];if(i.length>0){const r=new y.DataRecordsSelectionChangeMessage(e,i,[t]);a.publishMessage(r)}})}(i,e,t):e.type===y.JSAPILayerTypes.SubtypeSublayer&&function(e,t,i){const r=t.getLayerDataSource();if(!r)return;const s=r.parentDataSource;if(!s)return;const a=m(t.layer),n=t.layer.subtypeCode,o=s.getSelectedRecords().filter(e=>e.getFieldValue(a)!==n),l=function(e,t){return t.map(t=>{const i=t.clone();return i.dataSource=e,i})}(s,i);o.push(...l);const u=new y.DataRecordsSelectionChangeMessage(e,o,[s.id]);y.MessageManager.getInstance().publishMessage(u)}(i,e,t)}function m(e){if(!e)return null;const t=e.subtypeField;if(t){const i=e.getField(t);if(i&&i.name)return i.name}return t}function v(e){return(e=(e=e||[]).slice()).length>=2&&e.sort((e,t)=>{const i=null==e?void 0:e.hierarchyLevel,r=null==t?void 0:t.hierarchyLevel;return i&&r?function(e,t){const i=e.split(".").map(e=>parseInt(e)),r=t.split(".").map(e=>parseInt(e));for(;i.length>0&&r.length>0;){const e=i.shift(),t=r.shift();if(e<t)return-1;if(e>t)return 1}if(i.length>0)return 1;if(r.length>0)return-1;return 0}(i,r):0}),e}function w(e){return p(this,void 0,void 0,function*(){var t,i,r,s;const a=e.getJimuMapView(),n=e.layer;if(e.fromRuntime&&"hide-children"===(null==n?void 0:n.listMode))return e;if(a&&n){n.type!==y.JSAPILayerTypes.MapImageLayer&&n.type!==y.JSAPILayerTypes.TileLayer&&n.type!==y.JSAPILayerTypes.BuildingSceneLayer&&n.type!==y.JSAPILayerTypes.BuildingGroupSublayer||(n.loadAll?yield n.loadAll():n.load&&(yield n.load()));const o=null===(i=null===(t=n.sublayers)||void 0===t?void 0:t.toArray())||void 0===i?void 0:i.reverse(),l=null===(s=null===(r=n.layers)||void 0===r?void 0:r.toArray())||void 0===s?void 0:s.reverse();let u=null;(null==o?void 0:o.length)>0?u=o:(null==l?void 0:l.length)>0&&(u=l),u&&u.length>0&&u.forEach((t,i)=>{n.type!==y.JSAPILayerTypes.BuildingSceneLayer&&n.type!==y.JSAPILayerTypes.BuildingGroupSublayer||t.parent||(t.parent=n),a.createJimuLayerView(t,e.jimuLayerId,i,null,e.fromRuntime,!1)})}return e})}const S=y.ExBAddedJSAPIProperties.EXB_LAYER_REMOVED_BEFORE;function L(e,t){let i=!1;const r=null==e?void 0:e.item;return r&&(r[S]||(r[y.ExBAddedJSAPIProperties.EXB_LAYER_FROM_RUNTIME]=!0,i=!0,t&&I(r,e=>{e[S]||(e[y.ExBAddedJSAPIProperties.EXB_LAYER_FROM_RUNTIME]=!0);return!e[S]}))),i}function b(e){const t=null==e?void 0:e.item;t&&(t[S]=!0,I(t,e=>{e[S]=!0;return!0}))}function I(e,t){var i,r;if(!e)return;if(t(e)){const s=null===(i=e.sublayers)||void 0===i?void 0:i.toArray(),a=null===(r=e.layers)||void 0===r?void 0:r.toArray(),n=[];(null==s?void 0:s.length)>0&&n.push(...s),(null==a?void 0:a.length)>0&&n.push(...a),n.forEach(e=>{e&&I(e,t)})}}function V(e,t,i){return p(this,void 0,void 0,function*(){var r,s;let a=!1;try{if(e&&t&&t.url&&i.length>0){const n=e.spatialReference,o=null===(r=i[0].geometry)||void 0===r?void 0:r.spatialReference;if(o){let e;const r=null===(s=t.getLayerDefinition)||void 0===s?void 0:s.call(t),l=null==r?void 0:r.extent;if(l){const[t]=yield(0,y.loadArcGISJSAPIModules)(["esri/geometry/Extent"]);e=new t(l)}const u=yield P(o,n,t.id,e);if(a=!u,!u){console.warn(`data source ${t.id} query features from server because projection engine cannot convert feature spatial reference to map spatial reference correctly`);const e=[];if(i.forEach(t=>{const i=null==t?void 0:t.getObjectId();("string"==typeof i&&i||"number"==typeof i)&&e.push(i)}),e.length>0){const r={objectIds:e,outFields:[t.getIdField()],returnGeometry:!0,outSR:n.toJSON()},s=yield t.queryAll(r),a=null==s?void 0:s.records;if((null==a?void 0:a.length)>0){const e=yield y.dataSourceUtils.changeJimuRecordsToJSAPIGraphics(a);if((null==e?void 0:e.length)>0){const t={};e.forEach(e=>{const i=e.getObjectId();("string"==typeof i&&i||"number"==typeof i)&&(t[i]=e)}),i.forEach(e=>{const i=null==e?void 0:e.getObjectId();if("string"==typeof i&&i||"number"==typeof i){const r=t[i],s=null==r?void 0:r.geometry;s&&(e.geometry=s)}})}}}}}}}catch(e){console.error("cannot get features for rendering",e)}return{spatialReferenceChanged:a,features:i}})}const M={};function P(e,t,i,r){return p(this,void 0,void 0,function*(){let s=!0;try{const s=e.isWebMercator||e.isWGS84,a=t.isWebMercator||t.isWGS84;if(e.equals(t)||s&&a)return!0;const n=e.wkid||e.wkt,o=`${n}-${t.wkid||t.wkt}-${i}`;return M[o]||(M[o]=function(e,t,i,r){return p(this,void 0,void 0,function*(){let s=!0;try{const a=e.wkid||e.wkt,n=t.wkid||t.wkt;console.warn(`check if projection engine can convert spatial reference from ${a} to ${n} correctly for data source ${i}`);const[o,l]=yield(0,y.loadArcGISJSAPIModules)(["esri/geometry/operators/support/geographicTransformationUtils","esri/request"]);function u(){return p(this,void 0,void 0,function*(){o.isLoaded()||(yield o.load());return(o.getTransformations(e,t,r)||[]).map(e=>e.steps.map(({wkid:e})=>({wkid:e})))})}function c(){return p(this,void 0,void 0,function*(){var i;const s=y.utils.getGeometryService()+"/findTransformations",a={inSR:JSON.stringify(e.toJSON()),outSR:JSON.stringify(t.toJSON()),numOfResults:100,f:"json"},n=null==r?void 0:r.toJSON();n&&(a.extentOfInterest=JSON.stringify(n));const o=yield l(s,{query:a,responseType:"json"});return((null===(i=null==o?void 0:o.data)||void 0===i?void 0:i.transformations)||[]).map(e=>"geoTransforms"in e?e.geoTransforms.map(({wkid:e})=>({wkid:e})):[{wkid:e.wkid}])})}const[d,h]=yield Promise.all([u(),c()]);h.length=d.length;const g=new Set(h.map(e=>JSON.stringify(e))),f=new Set(d.map(e=>JSON.stringify(e)));for(const m of g)if(!f.has(m)){console.warn(`transformation not supported by PE: ${m}`),console.warn("gsTransformSet:",g),console.warn("peTransformSet:",f),s=!1;break}}catch(v){s=!0,console.error("isProjectionSupportedByProjectionEngineWithoutCache error",v)}return s})}(e,t,i,r)),M[o]}catch(e){s=!0,console.error("isProjectionSupportedByProjectionEngine error",e)}return s})}var A=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};function C(e){return A(this,void 0,void 0,function*(){return yield(0,y.loadArcGISJSAPIModules)(e)})}var J=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};let F=null;function E(e,t,i){return J(this,void 0,void 0,function*(){if(!e)return yield Promise.reject(new Error("Invalid target."));if(!t)return yield Promise.reject(new Error("Invalid target."));let r,s,a;i||(i={});const n=yield C(["esri/Graphic","esri/geometry/Extent","esri/layers/Layer","esri/layers/support/TileInfo"]);[r,s,a,F]=n;const o=i.padding;o&&e.padding&&(e.padding.left=o.left||0,e.padding.right=o.right||0,e.padding.top=o.top||0,e.padding.bottom=o.bottom||0);let l=null;try{function u(e){return!!e&&(e instanceof a||"esri.layers.buildingSublayers.BuildingComponentSublayer"===e.declaredClass||"esri.layers.support.SubtypeSublayer"===e.declaredClass)}t instanceof s?yield T(e,t,i.scale):Array.isArray(t)&&t.length&&t[0]instanceof r?yield x(e,t,i.scale):Array.isArray(t)&&t.length&&t[0]instanceof Array&&t[0][0]instanceof r?yield function(e,t,i){return J(this,void 0,void 0,function*(){if(0===t.length)return Promise.resolve();if(1===t.length)return x(e,t[0],i);{const r=[];t.forEach(t=>{r.push(W(e,t).catch(()=>null))});let s=null;return Promise.all(r).then(t=>(t.forEach(e=>{e&&(s=s?s.union(e):e)}),T(e,s,i)))}})}(e,t,i.scale):u(t)?yield j(e,t,null,null,i):t.layer&&u(t.layer)&&t.extent&&t.extent instanceof s?yield j(e,t.layer,null,t.extent,i):t.layer&&u(t.layer)&&Array.isArray(t.graphics)?0===t.graphics.length?yield j(e,t.layer,null,null,i):t.graphics.length&&t.graphics[0]instanceof r&&(yield j(e,t.layer,t.graphics,null,i)):Array.isArray(t)&&t.length&&u(t[0])?yield function(e,t,i){return J(this,void 0,void 0,function*(){if(1===(null==t?void 0:t.length))return j(e,t[0],null,null,i);{let r=null;const s=[];return t.forEach(t=>s.push(Y(e,t,null==i?void 0:i.queryParams))),Promise.all(s).then(t=>(t.forEach(e=>{e&&(r=r?r.union(e):e)}),O(e,r)))}})}(e,t,i):l=new Error("Invalid target.")}catch(c){l=c}return e.padding&&(e.padding.left=0,e.padding.right=0,e.padding.top=0,e.padding.bottom=0),l?(console.warn("zoomTo warning",l),Promise.reject(l)):Promise.resolve()})}function D(e,t,i){return J(this,arguments,void 0,function*(e,t,i,r=!0){return $(e,t,i,r)})}function x(e,t,i){return J(this,void 0,void 0,function*(){return"3d"!==e.type||i?W(e,t).then(t=>J(this,void 0,void 0,function*(){return T(e,t,i)})).catch(e=>J(this,void 0,void 0,function*(){return Promise.reject(new Error(e))})):e.goTo(t)})}function j(e,t,i,r,s){return J(this,void 0,void 0,function*(){let a,n=null==s?void 0:s.scale;if(a=r&&B(r)?r:i&&i.length>0?yield W(e,i):yield Y(e,t,null==s?void 0:s.queryParams),!B(a))return Promise.reject(new Error("Invalid extent."));const o=yield X([a],e.spatialReference);if(a=o[0],n)return q(e,a,n).then(t=>O(e,t));if("3d"===e.type)return e.goTo(a);{let i=t.minScale||0,r=t.maxScale||0;if(G(a)){let t=_(e,i,r,3);return t?(a=N(e,a),q(e,a,t).then(t=>O(e,t))):O(e,a)}return a=N(e,a),function(e,t){return J(this,void 0,void 0,function*(){return yield C(["esri/config","esri/geometry/support/WKIDUnitConversion"]).then(i=>{let r,s,a;[r,s]=i;const n=e.size[0],o=39.37,l=20015077/180,u=s;let c,d,h=t.spatialReference;h&&(c=h.wkid,d=h.wkt);let y=null;if(c)y=u.values[u[c]];else if(d&&-1!==d.search(/^PROJCS/i)){const e=/UNIT\[([^\]]+)\]\]$/i.exec(d);e&&e[1]&&(y=parseFloat(e[1].split(",")[1]))}return a=t.width/n*(y||l)*o*(r.screenDPI||96),a}).catch(e=>J(this,void 0,void 0,function*(){return yield Promise.reject(new Error(null))}))})}(e,a).then(t=>i>0&&t>i?(i=Q(e,i,!0),q(e,a,i).then(t=>O(e,t))):t<r?(r=Q(e,r,!1),q(e,a,r).then(t=>O(e,t))):O(e,a))}})}function T(e,t,i){return J(this,void 0,void 0,function*(){return B(t=t.clone())?X([t],e.spatialReference).then(i=>{let r=i&&i[0];return r||(r=t),G(r)?function(e,t){return J(this,void 0,void 0,function*(){const i=_(e,0,0,3);return i?yield q(e,t,i):yield Promise.reject(new Error(null))})}(e,r):r}).then(t=>i?q(e,t,i,!1):t).then(t=>O(e,t)).catch(e=>J(this,void 0,void 0,function*(){return Promise.reject(new Error(e))})):Promise.reject(new Error("Invalid extent."))})}function O(e,t){return new Promise((i,r)=>{setTimeout(()=>{e.goTo(t).then(()=>{i()}).catch(()=>{r(new Error(null))})},400)})}function B(e){return e&&R(e.xmin)&&R(e.ymin)&&R(e.xmax)&&R(e.ymax)}function R(e){return 0===e||!!e}var k;function G(e){return e.xmin+k.X===e.xmax-k.X&&e.ymin+k.Y===e.ymax-k.Y}function W(e,t){return J(this,arguments,void 0,function*(e,t,i={}){let r=t&&t[0]&&t[0].layer;return r&&"scene"===r.type?yield function(e,t){return J(this,void 0,void 0,function*(){return yield C(["esri/rest/support/Query"]).then(i=>J(this,void 0,void 0,function*(){const[r]=i;if(t){const i=new r;return i.objectIds=e.map(e=>e.attributes[t.objectIdField]),i.returnGeometry=!0,t.queryExtent(i).then(e=>1===e.count?e.extent.expand(3.5):e.extent.expand(2))}return Promise.reject(new Error(null))})).catch(e=>J(this,void 0,void 0,function*(){return yield Promise.reject(new Error(e))}))})}(t,r,i.factor):"3d"===e.type?yield U(t,3):yield U(t)})}function U(e,t){return J(this,void 0,void 0,function*(){return yield C(["esri/Graphic","esri/geometry/Extent","esri/geometry/Point"]).then(i=>{let r,s,a,n=null,o=e;[r,s,a]=i;try{if(o&&1===o.length&&o[0].geometry&&"esri.geometry.Multipoint"===o[0].geometry.declaredClass&&1===o[0].geometry.points.length){const e=o[0].geometry.points[0];o=[new r({geometry:new a({x:e[0],y:e[1],spatialReference:o[0].geometry.spatialReference})})]}if(o&&1===o.length&&o[0].geometry&&"esri.geometry.Point"===o[0].geometry.declaredClass){const e=o[0].geometry;n=new s({xmin:e.x-k.X,ymin:e.y-k.Y,xmax:e.x+k.X,ymax:e.y+k.Y,spatialReference:e.spatialReference})}else o&&o.length>0&&(n=function(e,t){if(!e||!e.length)return null;let i,r=null,s=e.length;for(i=0;i<s;i++){const s=e[i].geometry;if(!s)continue;let a=s.extent;a||"point"!==s.type||null==s.x||null==s.y||(a=new t({xmin:s.x,ymin:s.y,xmax:s.x,ymax:s.y,spatialReference:s.spatialReference})),a&&(r=r?r.union(a):a)}if(!r||r.width<0||r.height<0)return null;return r}(o,s),n&&t&&t>0&&(n=n.expand(t)));return n}catch(e){return Promise.reject(new Error(e))}}).catch(e=>J(this,void 0,void 0,function*(){return yield Promise.reject(new Error(e))}))})}function H(e){var t;let i=[];const r=null===(t=e.map.basemap)||void 0===t?void 0:t.baseLayers;return null==r||r.forEach(e=>{e&&e.tileInfo&&e.tileInfo.lods&&i.length<e.tileInfo.lods.length&&(i=e.tileInfo.lods)}),i&&0!==i.length?i:F.create().lods}function _(e,t,i,r){const s=H(e);let a,n=1;if(s){const e=[],o=[];let l;s.forEach(r=>{t>0&&r.scale>t||(r.scale<i?o.push(r.scale):e.push(r.scale))}),e.reverse(),e.length>=1?(n=o.length?o.length/s.length:1,l=Math.floor((e.length-1)/(r/n)),a=e[l]):a=null}else a=0===t?null:(t-i)/r;return a}function Q(e,t,i){let r;const s=H(e);if(s){if(i){for(r=0;r<s.length;r++)if(s[r].scale<t)return s[r].scale-1;return s[s.length-1].scale-1}for(r=s.length-1;r>=0;r--)if(s[r].scale>t)return s[r].scale+1;return s[0].scale+1}return i?t-1:t+1}function N(e,t){const i=e.size[0]/e.size[1],r=t.width/t.height,s=t.center.x,a=t.center.y;if(r>i){const e=t.width/i/2;t.ymin=a-e,t.ymax=a+e}else if(r<i){const e=t.height*i/2;t.xmin=s-e,t.xmax=s+e}return t}function q(e,t,i){return J(this,arguments,void 0,function*(e,t,i,r=!0){return $({width:e.size[0],height:e.size[1]},t,i,r)})}function $(e,t,i){return J(this,arguments,void 0,function*(e,t,i,r=!0){return r&&(t=function(e,t){const i=t.width*(e.height/e.width)/5,r=t.center.y;return t.ymin=r-i,t.ymax=r+i,t}(e,t.clone())),yield C(["esri/config","esri/geometry/support/WKIDUnitConversion"]).then(r=>{let s,a;[s,a]=r;const n=e.width,o=a;let l,u,c=t.spatialReference;c&&(l=c.wkid,u=c.wkt);let d=null;if(l)d=o.values[o[l]];else if(u&&-1!==u.search(/^PROJCS/i)){const e=/UNIT\[([^\]]+)\]\]$/i.exec(u);e&&e[1]&&(d=parseFloat(e[1].split(",")[1]))}return t.expand(i*n/(39.37*(d||20015077/180)*(s.screenDPI||96))/t.width)}).catch(e=>J(this,void 0,void 0,function*(){return yield Promise.reject(new Error(null))}))})}function Y(e,t,i){return J(this,void 0,void 0,function*(){var r,s;!t.loaded&&t.load&&(yield t.load());const a="esri.layers.SubtypeGroupLayer"===t.declaredClass;let n=t.fullExtent||t.initialExtent;if(t.sublayers&&!a||t.type===y.JSAPILayerTypes.GroupLayer){if(n)return Promise.resolve(null==n?void 0:n.clone());{const r=[];return(t.type===y.JSAPILayerTypes.GroupLayer?t.layers:t.sublayers).forEach(t=>r.push(Y(e,t,i))),Promise.all(r).then(e=>{var i;return e.forEach(e=>{e&&(n=n?n.union(e):e)}),n||(null===(i=t.fullExtent)||void 0===i?void 0:i.clone())})}}if(null===(r=t.capabilities)||void 0===r?void 0:r.query)return yield function(e,t,i){return J(this,void 0,void 0,function*(){var r,s;const a=(null===(r=t.fullExtent)||void 0===r?void 0:r.clone())||(null===(s=t.initialExtent)||void 0===s?void 0:s.clone()),n=t.capabilities.query;return n?yield C(["esri/rest/support/Query","esri/geometry/Extent"]).then(r=>{let s,o;[s,o]=r;const l=new s;if(l.where=(null==i?void 0:i.where)||(null==t?void 0:t.definitionExpression)||"1=1",l.outSpatialReference=e.spatialReference,l.returnGeometry=!0,n.supportsExtent){const i="esri.layers.support.SubtypeSublayer"===t.declaredClass;return!t.queryExtent&&i?function(e,t){return J(this,void 0,void 0,function*(){const i=e.parent;if(i){const r=t.clone(),s=`${m(e)} = ${e.subtypeCode}`;r.where?r.where=`(${r.where}) AND (${s})`:r.where=s;const a=yield i.queryExtent(r);if(a)return a.extent}return null})}(t,l):t.queryExtent(l).then(i=>{var r,s;if("3d"===e.type)return i.extent;if(1===i.count&&"point"===t.geometryType&&(null===(r=null==i?void 0:i.extent)||void 0===r?void 0:r.center)){const t=null===(s=null==i?void 0:i.extent)||void 0===s?void 0:s.center;return new o({xmin:t.x-k.X,ymin:t.y-k.Y,xmax:t.x+k.X,ymax:t.y+k.Y,spatialReference:e.spatialReference})}return i.extent}).catch(e=>J(this,void 0,void 0,function*(){return yield Promise.resolve(a)}))}return a?Promise.resolve(a):t.queryFeatures?t.queryFeatures(l).then(t=>J(this,void 0,void 0,function*(){return W(e,t.features)})).catch(e=>J(this,void 0,void 0,function*(){return yield Promise.resolve(a)})):void 0}).catch(e=>J(this,void 0,void 0,function*(){return yield Promise.resolve(a)})):Promise.resolve(a)})}(e,t,i);{const i=yield W(e,null===(s=t.graphics)||void 0===s?void 0:s.items);return Promise.resolve(i||(null==n?void 0:n.clone()))}})}function X(e,t){return J(this,void 0,void 0,function*(){return yield C(["esri/geometry/Extent"]).then(i=>{let r;return[r]=i,y.geometryUtils.projectToSpatialReference(e,t).then(e=>e.map(e=>{if("extent"!==e.type||0!==e.width&&0!==e.height)return e;return new r({xmin:e.xmin-k.X,ymin:e.ymin-k.Y,xmax:e.xmax+k.X,ymax:e.ymax+k.Y,spatialReference:e.spatialReference})}))}).catch(e=>J(this,void 0,void 0,function*(){return yield Promise.reject(new Error(null))}))})}!function(e){e[e.X=1e-4]="X",e[e.Y=1e-4]="Y"}(k||(k={}));var z=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};const K=" "+re(["Web Map"])+" ";let Z=null;function ee(){const e=(0,y.getAppStore)().getState().portalSelf;return!!(e&&e.defaultBasemap&&e.defaultBasemap.baseMapLayers&&e.defaultBasemap.baseMapLayers[0]&&e.defaultBasemap.baseMapLayers[0].url)}function te(e){return z(this,void 0,void 0,function*(){return Z||(Z=ie(e),Promise.resolve(Z))})}function ie(e){return z(this,void 0,void 0,function*(){const t=new(0,(yield C(["esri/portal/Portal"]))[0])({url:e});yield t.load();const i=t.sourceJSON,r=i.defaultBasemap&&i.defaultBasemap.id,s=i.defaultExtent;if(r)return{defaultMapId:r,defaultExtent:s};const a=yield function(e,t,i){return z(this,void 0,void 0,function*(){const e=t.defaultBasemap&&t.defaultBasemap.title,r=t.useVectorBasemaps&&t.vectorBasemapGalleryGroupQuery?t.vectorBasemapGalleryGroupQuery:t.basemapGalleryGroupQuery;return yield i.queryGroups({f:"json",query:r}).then(t=>z(this,void 0,void 0,function*(){const r=t.results;if(r.length>0){const t=r[0],s=K+" AND group:"+t.id;return yield i.queryItems({start:1,num:1,f:"json",query:s}).then(t=>z(this,void 0,void 0,function*(){let r=t.results;r=r.filter(e=>e.type&&"web map"===e.type.toLowerCase());let s=null;if(r.length>0&&(s=r.find(t=>{var i;return null===(i=t.title)||void 0===i?void 0:i.toLowerCase().includes(null==e?void 0:e.toLowerCase())})),s)return Promise.resolve(s.id);{const t=`${K} AND owner:esri AND title:"${e}"`;return i.queryItems({start:1,num:1,f:"json",query:t}).then(e=>z(this,void 0,void 0,function*(){let t=e.results;if(t=t.filter(e=>e.type&&"web map"===e.type.toLowerCase()),t.length>0){const e=t[0];return Promise.resolve(e.id)}return Promise.resolve(null)}))}}))}}))})}(0,i,t);if(a){const e=yield function(e,t){return z(this,void 0,void 0,function*(){try{const i=yield C(["esri/portal/PortalItem"]),r=new(0,i[0])({portal:e,id:t}),s=yield r.fetchData();if(s&&s.version&&"string"==typeof s.version){return parseFloat(s.version.split(".")[0])>=2}}catch(e){return console.error("validate web map version error",t,e),!1}return!1})}(t,a);if(e)return{defaultMapId:a,defaultExtent:s}}const n=yield function(e){return z(this,void 0,void 0,function*(){const t={start:1,num:1,f:"json",query:K+" AND access:public AND owner:esri_en",sortField:"num-views",sortOrder:"desc",disableExtraQuery:!0};return yield e.queryItems(t).then(e=>z(this,void 0,void 0,function*(){let t=e.results;if(t=t.filter(e=>e.type&&"web map"===e.type.toLowerCase()),t.length>0){const e=t[0];return Promise.resolve(e.id)}return Promise.resolve(null)}))})}(t);return{defaultMapId:n,defaultExtent:s}})}function re(e){let t="";const i=function(){let e=[];const t=["Web Map","Web Scene","CityEngine Web Scene"],i=["Feature Service","Map Service","Image Service","KML","WMS","Feature Collection","Feature Collection Template","Geodata Service","Globe Service"],r=["Geometry Service","Geocoding Service","Network Analysis Service","Geoprocessing Service"],s=["Web Mapping Application","Mobile Application","Code Attachment","Operations Dashboard Add In","Operation View"],a=["Symbol Set","Color Set","Shapefile","CSV","Service Definition","Document Link","Microsoft Word","Microsoft PowerPoint","Microsoft Excel","PDF","Image","Visio Document"],n=["Map Document","Map Package","Tile Package","ArcPad Package","Explorer Map","Globe Document","Scene Document","Published Map","Map Template","Windows Mobile Package"],o=["Layer","Layer Package","Explorer Layer"],l=["Geoprocessing Package","Geoprocessing Sample","Locator Package","Rule Package"],u=["Workflow Manager Package","Desktop Application","Desktop Application Template","Code Sample","Desktop Add In","Explorer Add In"];return e=e.concat(t).concat(i).concat(r).concat(s).concat(a),e=e.concat(n).concat(o).concat(l).concat(u),e}();if(e&&e.length>0&&e.length>0){let r="";for(let t=0;t<e.length;t++){r+=' type:"'+e[t]+'" ',t!==e.length-1&&(r+=" OR ")}t=" ( "+r+" ) ";const s=e.concat(i).filter(t=>e.every(e=>!e.toLowerCase().includes(t.toLowerCase())));for(let e=0;e<s.length;e++){t+=' -type:"'+s[e]+'" '}}return t}function se(e){return(0,y.loadArcGISJSAPIModules)(["esri/Graphic","esri/rest/support/FeatureSet"]).then(t=>{const[i,r]=t,s=new r,a=y.dataSourceUtils.changeRestAPIGeometryTypeToJSAPIGeometryType(e.dataSource.getGeometryType());return s.geometryType=a,s.features=e.records.map(e=>{let t;const r=e.feature;return"esri.Graphic"===(null==r?void 0:r.declaredClass)?(t=r.clone(),t.layer=r.layer):(r.geometry&&(r.geometry.type=a),t=new i({geometry:r.geometry,attributes:r.attributes})),t}),s}).catch(e=>(console.warn(e),null))}function ae(e){let t=null;switch(e){case"point":t={type:"esriSMS",color:[255,255,0,150],outline:{color:[255,255,0,150],width:1}};break;case"polyline":t={type:"esriSLS",color:[255,255,0,150],width:.75};break;case"polygon":t={type:"esriSFS",color:[255,255,0,150],outline:{color:[255,255,0,150],width:1}}}return t}var ne,oe=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};function le(e){var t;return"Web Scene"===(null===(t=e.portalItem)||void 0===t?void 0:t.type)||e.referenceLayers.some(e=>"scene"===e.type)}function ue(e,t,i){return oe(this,void 0,void 0,function*(){try{const r=yield e.queryItems({query:t?'type:"Web Scene"':'type:"Web Map" -type:"Web Application"',sortField:e.sortField||"name",sortOrder:e.sortOrder||"desc",num:100,disableExtraQuery:!0});if(!r.total)return[];return(r.results?r.results.filter(e=>e.type===t?"Web Scene":"Web Map"):[]).map(e=>{const t=y.portalUrlUtils.getItemUrl(i,e.id)+"/info/"+e.thumbnail;return{id:e.id,title:e.title,thumbnailUrl:t,type:e.type}})}catch(e){return console.log("Failed to get basemap items by  group id",e),[]}})}function ce(){return oe(this,void 0,void 0,function*(){const e=yield C(["esri/portal/Portal","esri/Basemap"]),[t,i]=e,r=(0,y.getAppStore)().getState().portalUrl,s=new t({url:r});yield s.load();const a=s.sourceJSON,n=yield de(s,a);if(!(null==n?void 0:n.id))return[];let o=[...yield ue(n,!1,r)];if(a.use3dBasemaps){const e=yield de(s,a,ne.EsriDefault3d);if(null==e?void 0:e.id){o=[...yield ue(e,!0,r),...o]}}return yield pe(i,o)})}function de(e,t){return oe(this,arguments,void 0,function*(e,t,i=ne.OrgDefault){try{const r=function(e,t){switch(t){case ne.EsriDefault:return'title:"ArcGIS Online Basemaps" AND owner:esri_en';case ne.EsriDefault3d:return e["3DBasemapGalleryGroupQuery"];case ne.OrgDefault:return e.useVectorBasemaps&&e.vectorBasemapGalleryGroupQuery?e.vectorBasemapGalleryGroupQuery:e.basemapGalleryGroupQuery}}(t,i),s=yield e.queryGroups({query:r,disableExtraQuery:!0});return s.results.length>0?s.results[0]:null}catch(e){return console.log("Failed to get basemap groups",e),null}})}function he(e){return oe(this,void 0,void 0,function*(){const{portal:t,portalUrl:i,groupId:r,sortField:s,sortOrder:a,is3D:n=!1,disableExtraQuery:o=!0}=e;try{const e=`group:${r} AND ${re([n?"Web Scene":"Web Map"])}`,l=yield t.queryItems({start:1,num:100,sortField:"title"!==s&&s?`${s},title`:s,sortOrder:a,query:e,disableExtraQuery:o});return((null==l?void 0:l.results)?l.results:[]).map(e=>{const t=y.portalUrlUtils.getItemUrl(i,e.id)+"/info/"+e.thumbnail;return{id:e.id,title:e.title,thumbnailUrl:t,type:e.type}})}catch(e){return console.log("Failed to get basemap items by  group id",e),[]}})}!function(e){e.EsriDefault="ESRI_DEFAULT",e.EsriDefault3d="ESRI_DEFAULT_3D",e.OrgDefault="ORG_DEFAULT"}(ne||(ne={}));const ye=e=>oe(void 0,void 0,void 0,function*(){try{yield e.load()}catch(e){console.error("basemap load error",e)}return e}),pe=(e,t)=>Promise.all(t.map(t=>oe(void 0,void 0,void 0,function*(){const i=new e({portalItem:{id:t.id}});return ye(i)})));function ge(e,t){let i=t;if(e&&t){const r=t.split("-");if(r.length>0){const s=r[0];if(s){const r=e[s];r&&(i=t.replace(`${s}-`,`${r}-`))}}}return i||(i=t),i}function fe(e,t){let i=t;if(e&&t){const r=t.split("-");if(r.length>0){const s=r[0];if(s){const r=e[s];r&&(i=t.replace(`${s}-`,`${r}-`))}}}return i||(i=t),i}var me=a(386),ve=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};const we=[y.JSAPILayerTypes.BuildingSceneLayer,y.JSAPILayerTypes.CSVLayer,y.JSAPILayerTypes.FeatureLayer,y.JSAPILayerTypes.GeoJSONLayer,y.JSAPILayerTypes.GraphicsLayer,y.JSAPILayerTypes.MapNotesLayer,y.JSAPILayerTypes.SceneLayer,y.JSAPILayerTypes.SubtypeSublayer];function Se(e){var t,i;const r=[];for(const s of e){const e=s.getAllJimuLayerViews(),a=Le(s.dataSourceId);for(const s of e){const e=s.layer,n=y.dataSourceUtils.getDataSourceIdByJSAPILayer(a,e),o=we.includes(null===(t=s.layer)||void 0===t?void 0:t.type);n&&o&&r.push({value:n,label:e.title||(null===(i=e.sourceJSON)||void 0===i?void 0:i.name)})}}return r}const Le=e=>y.DataSourceManager.getInstance().getDataSource(e),be=(e,t)=>ve(void 0,void 0,void 0,function*(){const i=yield C(["esri/views/interactive/snapping/FeatureSnappingLayerSource","esri/core/Collection"]),[r,s]=i;return new s(Ie(e,t).map(e=>new r(e)))}),Ie=(e,t)=>{if(!e)return[];if(!(null==e?void 0:e.jimuLayerViews))return[];return Object.keys(e.jimuLayerViews).filter(i=>t&&t.includes(e.jimuLayerViews[i].layerDataSourceId)).map(t=>({layer:e.jimuLayerViews[t].layer,enabled:!0}))},Ve=(e,t)=>{const i=(0,y.useIntl)().formatMessage({id:"geometryGuides",defaultMessage:e.geometryGuides}),r=(0,y.useIntl)().formatMessage({id:"tipsForGeometryGuides",defaultMessage:e.tipsForGeometryGuides}),s=(0,y.useIntl)().formatMessage({id:"featureToFeature",defaultMessage:e.featureToFeature}),a=(0,y.useIntl)().formatMessage({id:"tipsForFeatureToFeature",defaultMessage:e.tipsForFeatureToFeature}),n=(0,y.useIntl)().formatMessage({id:"grid",defaultMessage:t.grid}),o=(0,y.useIntl)().formatMessage({id:"tipsForGrid",defaultMessage:e.tipsForGrid});return(0,me.jsx)(y.React.Fragment,{children:(0,me.jsxs)("div",{className:"plain-tooltip",style:{maxWidth:260},children:[(0,me.jsxs)("div",{className:"mt-1",style:{fontWeight:700},children:[" ",i," "]}),(0,me.jsxs)("div",{className:"mb-3",children:[" ",r]}),(0,me.jsxs)("div",{className:"mt-2",style:{fontWeight:700},children:[" ",s," "]}),(0,me.jsxs)("div",{className:"mb-3",children:[" ",a]}),(0,me.jsxs)("div",{className:"mt-2",style:{fontWeight:700},children:[" ",n," "]}),(0,me.jsxs)("div",{className:"mb-3",children:[" ",o]})]})})},Me={layerIsNotSupported:"This layer type is not supported."};var Pe=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class Ae{constructor(e){var t;this.runTimeIsHidden=!1,this.removeableByMapTool=!1,this.id=e.id,this.mapViewManager=e.mapViewManager,this.type=e.type,this.layerDataSourceId=e.layerDataSourceId,this.jimuMapViewId=e.jimuMapViewId,this.jimuLayerId=e.jimuLayerId,this.layer=e.layer,this.parentJimuLayerViewId=e.parentJimuLayerViewId,this.index=e.index,this.fromRuntime=e.fromRuntime,this.isLoaded=!1;let i="";if(this.parentJimuLayerViewId){const e=this.getParentJimuLayerView();e&&(i=e.hierarchyLevel)}this.hierarchyLevel=i?`${i}.${this.index}`:null===(t=this.index)||void 0===t?void 0:t.toString(),this.layer&&(this.layer[y.ExBAddedJSAPIProperties.EXB_JIMU_LAYER_VIEW_ID]=this.id,this.originalLayerVisible=this.layer.visible,this.updateUrlHashLayersVisibility(e.urlHashLayersVisibility));const r=y.appConfigUtils.getDataSourceJsonById(this.getAppConfig(),this.layerDataSourceId);if(r){const e=r.isHidden,t=r.label;t&&t!==this.layer.title&&(this.layer.title=t),this.runTimeIsHidden=e,e&&(this.layer.visible=!e)}this.initListenToDataSourceJsonChange(),this.initListenToDataSourceInfoChange(),(this.isLayerUsedByFilter()||this.isLayerUsedBySelection())&&this.createLayerDataSource(),this.watchLayerVisibleChange()}ready(){return Pe(this,void 0,void 0,function*(){return Promise.resolve(this)})}updateUrlHashLayersVisibility(e){if(e&&!this.fromRuntime){const t=e[this.id];if("boolean"==typeof t&&this.layer.visible!==t)return this.layer.visible=t,!0}return!1}getReactiveUtils(){return Pe(this,void 0,void 0,function*(){return this.reactiveUtils||(this.reactiveUtils=yield(0,y.loadArcGISJSAPIModule)("esri/core/reactiveUtils")),this.reactiveUtils})}whenViewLoaded(){return Pe(this,void 0,void 0,function*(){if(!this.view&&!this.isLoaded)try{const e=this.getJimuMapView();yield e.whenJimuLayerViewLoaded(this.id)}catch(e){console.error(`whenViewLoaded error, jimuLayerViewId: ${this.id}`,e)}})}validateDataSource(e){return!0}getLayerDataSource(){let e=y.DataSourceManager.getInstance().getDataSource(this.layerDataSourceId);return e&&!this.validateDataSource(e)&&(console.error(`JimuLayerView ${this.id} gets wrong data source type ${e.type}, data source id: ${this.layerDataSourceId}`),e=null),e}createLayerDataSource(){return Pe(this,void 0,void 0,function*(){let e=y.DataSourceManager.getInstance().getDataSource(this.layerDataSourceId);if(!e)try{if(this.runtimeRootDataSource)this.layerDataSourceId&&(this.layerDataSourceId===this.runtimeRootDataSource.id?e=this.runtimeRootDataSource:this.runtimeRootDataSource.isDataSourceSet()&&this.runtimeRootDataSource.createDataSourceById&&(e=yield this.runtimeRootDataSource.createDataSourceById(this.layerDataSourceId)));else{const t=this.getMapDataSource();t&&(e=yield t.createDataSourceByLayer(this.layer))}}catch(t){console.error(`JimuLayerView ${this.id} create layer data source failed:`,t),e=null}return e&&!this.validateDataSource(e)&&(console.error(`JimuLayerView ${this.id} gets wrong data source type ${e.type}, data source id: ${this.layerDataSourceId}`),e=null),e})}getOrCreateLayerDataSource(){return Pe(this,void 0,void 0,function*(){let e=this.getLayerDataSource();if(!e)try{e=yield this.createLayerDataSource()}catch(t){e=null,console.error(`JimuLayerView ${this.id} createLayerDataSource error`,t)}return e})}getParentJimuLayerView(){const e=this.getJimuMapView();return e&&this.parentJimuLayerViewId?e.jimuLayerViews[this.parentJimuLayerViewId]:null}getAllAncestorJimuLayerViews(){let e=[];const t=this.getJimuMapView();return t&&(e=t.getParentJimuLayerViews(this.id)),e}isLayerUsedByFilter(){const e=(0,y.getAppStore)().getState().appConfig.dataSources||{},t=Object.values(e);for(;t.length>0;){const e=t.shift();if(e.id===this.layerDataSourceId)return!!e.query;if(this.layerDataSourceId.startsWith(e.id)&&e.childDataSourceJsons){const i=Object.values(e.childDataSourceJsons);t.push(...i)}}return!1}isLayerUsedBySelection(){if(this.layerDataSourceId){if(this.isLayerDataSourceUsedBySelection(this.layerDataSourceId))return!0;const e=this.layerDataSourceId+"-associated_data_source";if(this.isLayerDataSourceUsedBySelection(e))return!0}return!1}isLayerDataSourceUsedBySelection(e){var t,i;if(e){let r=null===(t=(0,y.getAppStore)().getState().dataSourcesInfo)||void 0===t?void 0:t[e];if(!r){const t=y.urlUtils.getDataSourceInfosFromUrlParams(y.UrlManager.getInstance().getQueryObject(),y.UrlManager.getInstance().getHashObject()),i=null==t?void 0:t[e];Array.isArray(null==i?void 0:i.selection)?r={selectedIds:null==i?void 0:i.selection}:(null==i?void 0:i.selection)&&(r={selectOptions:null==i?void 0:i.selection})}if(r&&(r.selectOptions||(null===(i=r.selectedIds)||void 0===i?void 0:i.length)>0))return!0}return!1}isLayerVisible(){return[this,...this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).getParentJimuLayerViews(this.id)].every(e=>e.layer.visible)}isLayerVisibleForRendering(){if(!this.isLayerVisible())return!1;const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId),t=[this,...e.getParentJimuLayerViews(this.id)],i=e.view.scale;return t.every(e=>{const t=e.layer;if(t){const e=t.minScale,r=t.maxScale;return("number"!=typeof r||0===r||i>=r)&&("number"!=typeof e||0===e||i<=e)}return!1})}getMapSceneView(){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId);return e&&e.view}getMapDataSource(){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).dataSourceId;return y.DataSourceManager.getInstance().getDataSource(e)}onLayerDataSourceInfoChange(e,t){var i;const r=null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getLabel();if(r&&r!==this.layer.title){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId),t=y.i18n.getIntl().formatMessage({id:"action_addedData",defaultMessage:y.defaultMessages.action_addedData},{label:r});this.layer.title=r,y.MutableStoreManager.getInstance().updateStateValue(e.mapWidgetId,`addToMapDatas.${this.layer.id}.title`,t)}}getJimuMapView(){return this.mapViewManager.getJimuMapViewById(this.jimuMapViewId)}destroy(){this.watchLayerVisibleChangeHandle&&(this.watchLayerVisibleChangeHandle.remove(),this.watchLayerVisibleChangeHandle=null),this.dataSourceInfoObserver&&this.dataSourceInfoObserver(),this.dataSourceJsonObserver&&this.dataSourceJsonObserver()}getAppConfig(){var e;return window.jimuConfig.isBuilder?null===(e=(0,y.getAppStore)().getState().appStateInBuilder)||void 0===e?void 0:e.appConfig:(0,y.getAppStore)().getState().appConfig}initListenToDataSourceJsonChange(){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).dataSourceId;this.dataSourceJsonObserver=(0,y.observeStore)(this.onLayerDatasourceJsonChange.bind(this),["appConfig","dataSources",e])}initListenToDataSourceInfoChange(){this.dataSourceInfoObserver=(0,y.observeStore)(this.onLayerDataSourceInfoChange.bind(this),["dataSourcesInfo",this.layerDataSourceId])}onLayerDatasourceJsonChange(e,t){if(!y.appConfigUtils.getDataSourceJsonById(this.getAppConfig(),this.layerDataSourceId))return;const i=y.appConfigUtils.getDataSourceJsonById(this.getAppConfig(),this.layerDataSourceId).isHidden;this.runTimeIsHidden!==i&&(this.runTimeIsHidden=i,this.layer.visible=!i)}watchLayerVisibleChange(){return Pe(this,void 0,void 0,function*(){const e=this.layer;if(!e)return;const t=yield this.getReactiveUtils();this.watchLayerVisibleChangeHandle&&(this.watchLayerVisibleChangeHandle.remove(),this.watchLayerVisibleChangeHandle=null),this.watchLayerVisibleChangeHandle=t.watch(()=>e.visible,e=>{const t=this.getJimuMapView();if(!t)return;this.fromRuntime||t&&(t.updateUrlHashLayerVisibility(),t.updatePersistentMapState(!1,!0));t.getAllChildJimuLayerViews(this.id).forEach(t=>{t.onParentLayerVisibleChange(e)}),t.onJimuLayerViewSelfVisibleChange(this)})})}onParentLayerVisibleChange(e){}getMapWidgetId(){const e=this.getJimuMapView();return(null==e?void 0:e.mapWidgetId)||""}setRemoveableByMapTool(e){var t;this.removeableByMapTool=e;const i=this.getMapWidgetId(),r=null===(t=this.layer)||void 0===t?void 0:t.id,s=this.getJimuMapView();if(i&&r&&s){const e=s.id,t=(y.MutableStoreManager.getInstance().getStateValue([i])||{}).removeableLayerIdsInfo||{},r=[];Object.values(s.jimuLayerViews).forEach(e=>{e.removeableByMapTool&&e.layer&&r.push(e.layer.id)}),t[e]=r,y.MutableStoreManager.getInstance().updateStateValue(i,"removeableLayerIdsInfo",t)}}supportTime(){return this.layer&&y.dataSourceUtils.doesJSAPILayerSupportTime(this.layer)}}var Ce=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class Je extends Ae{constructor(e){super(e),this.url=null,this.url=e.url}ready(){return Ce(this,void 0,void 0,function*(){var e;yield w(this);const t=null===(e=this.layer)||void 0===e?void 0:e.layers;return t&&(this.watchAddLayerHandle=t.on("before-add",e=>{L(e,!1)}),this.watchRemoveLayerHandle=t.on("after-remove",e=>{b(e)})),this})}destroy(){this.watchAddLayerHandle&&(this.watchAddLayerHandle.remove(),this.watchAddLayerHandle=null),this.watchRemoveLayerHandle&&(this.watchRemoveLayerHandle.remove(),this.watchRemoveLayerHandle=null),super.destroy()}}var Fe=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class Ee extends Ae{constructor(e){super(e),this.url=null,this.url=e.url}ready(){return Fe(this,void 0,void 0,function*(){return yield w(this),this})}}class De extends Ee{constructor(e){super(e),this.url=null,this.originalGdbVersion=null,this.originalGdbVersion=this.layer.gdbVersion}onLayerDataSourceInfoChange(e,t){const i=this.layer,r=this.getLayerDataSource();if(r){const e=r.getTimeExtent();i.useViewTime=null==e,i.timeExtent=y.dataSourceUtils.changeJimuTimeToJSAPITimeExtent(e)}(null==t?void 0:t.gdbVersion)&&(i.gdbVersion=t.gdbVersion),!(null==t?void 0:t.gdbVersion)&&this.originalGdbVersion&&(i.gdbVersion=this.originalGdbVersion)}validateDataSource(e){return(null==e?void 0:e.type)===y.DataSourceTypes.MapService}getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}class xe extends Ee{}class je extends Ae{constructor(e){super(e)}onLayerDataSourceInfoChange(e,t){super.onLayerDataSourceInfoChange(e,t);const i=this.getLayerDataSource();if(i&&i.getCurrentQueryParams){let e=null;const t=i.getCurrentQueryParams();(null==t?void 0:t.time)&&(e=y.dataSourceUtils.changeJimuTimeToJSAPITimeExtent(t.time)),this.layer.timeExtent=e}}getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}var Te=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};const Oe=y.ExBAddedJSAPIProperties.EXB_OID;class Be extends Ae{constructor(e){super(e),this.highlightFeatureLayer=null,this.highlightFeatureLayerView=null,this.isHighlightFeatureLayerDirty=!1,this.localDefinitionExpression="",this.originalGdbVersion=null,this.selectByQueryAbortController=null,this.selectByQueryProgress=1,this.onMapViewRestore=()=>{var e;if(this.isHighlightFeatureLayerDirty){this.isHighlightFeatureLayerDirty=!1;let t=null;const i=(0,y.getAppStore)().getState().dataSourcesInfo;if(i){const e=i[this.layerDataSourceId];t=null==e?void 0:e.selectedIds}const r=this.highlightFeatureLayer;if(this.highLightLayerCreationPromise=null,this.highlightFeatureLayer=null,this.highlightFeatureLayerView=null,r){const t=this.getJimuMapView(),i=null===(e=null==t?void 0:t.view)||void 0===e?void 0:e.map;i&&i.remove(r)}this.updateHighlightBySelectedIds(t)}},this.latestHighlightIds||(this.latestHighlightIds=[]),this.originalGdbVersion=this.layer.gdbVersion}ready(){return Te(this,void 0,void 0,function*(){return this.watchHighlightOptions(),this.watchLayerVisible(),this.watchPopupSelectFeature(),this.watchPopupVisible(),this.watchMapViewRestore(),Promise.resolve(this)})}destroy(){this.popupSelectFeatureWatchHandle&&(this.popupSelectFeatureWatchHandle.remove(),this.popupSelectFeatureWatchHandle=null),this.releasePopupVisibleWatchHandle(),this.layerVisibleWatchHandle&&(this.layerVisibleWatchHandle.remove(),this.layerVisibleWatchHandle=null),this.highlightOptionsWatchHandle&&(this.highlightOptionsWatchHandle.remove(),this.highlightOptionsWatchHandle=null);const e=this.getJimuMapView();e&&e.removeRestoreListener(this.onMapViewRestore),super.destroy()}isFeatureLayer(){var e;return"esri.layers.FeatureLayer"===(null===(e=this.layer)||void 0===e?void 0:e.declaredClass)}isSceneLayer(){var e;return"esri.layers.SceneLayer"===(null===(e=this.layer)||void 0===e?void 0:e.declaredClass)}isBuildingComponentSublayer(){var e;return"esri.layers.buildingSublayers.BuildingComponentSublayer"===(null===(e=this.layer)||void 0===e?void 0:e.declaredClass)}isImageryLayer(){var e;return"esri.layers.ImageryLayer"===(null===(e=this.layer)||void 0===e?void 0:e.declaredClass)}isOrientedImageryLayer(){var e;return"esri.layers.OrientedImageryLayer"===(null===(e=this.layer)||void 0===e?void 0:e.declaredClass)}isSubtypeGroupLayer(){var e;return"esri.layers.SubtypeGroupLayer"===(null===(e=this.layer)||void 0===e?void 0:e.declaredClass)}getSelectedFeatureCount(){var e;let t=0;const i=this.getLayerDataSource();return i&&(t=i.getSelectedRecordIds().length),0===t&&(null===(e=this.latestHighlightIds)||void 0===e?void 0:e.length)>0&&(t=this.latestHighlightIds.length),t}getSelectedFeatures(){return Te(this,void 0,void 0,function*(){var e;let t=[];const i=this.getLayerDataSource();let r=[];if(i&&(r=i.getSelectedRecords()),r.length>0){const e=r.map(e=>null==e?void 0:e.feature),i=!1;t=yield this.getApiGraphicsByRecordFeatures(e,i)}else(null===(e=this.latestHighlightIds)||void 0===e?void 0:e.length)>0&&(t=yield this.querySelectedFeaturesFromClient());return t.forEach(e=>{e.jimuLayerViewId=this.id}),t})}getApiGraphicsByRecordFeatures(e,t){return Te(this,void 0,void 0,function*(){const[i]=yield(0,y.loadArcGISJSAPIModules)(["esri/Graphic"]),r=[];return e.forEach(e=>{let s=null;e&&(s="esri.Graphic"===e.declaredClass?t?e.clone():e:i.fromJSON(e)),s&&r.push(s)}),r})}querySelectedFeaturesFromClient(){return Te(this,void 0,void 0,function*(){var e;let t=[];if((null===(e=this.latestHighlightIds)||void 0===e?void 0:e.length)>0){const e={objectIds:this.latestHighlightIds,returnGeometry:!0};t=this.highlightFeatureLayer?yield this.queryFeaturesFromClientHighlightLayer(this.latestHighlightIds):yield this.queryFeaturesFromClient(e)}return t})}queryFeaturesFromClient(e){return Te(this,void 0,void 0,function*(){return new Promise(t=>Te(this,void 0,void 0,function*(){const i=this.view;if(!i||!i.queryFeatures)return void t([]);yield this.whenCurrentLayerViewNotUpdating();let r=null,s=null;try{const t=yield i.queryFeatures(e);r=null==t?void 0:t.features}catch(e){console.error("Query feature from view error.",this.id,e),s=e,r=[]}const a="esri.views.3d.layers.SceneLayerView3D"===this.view.declaredClass||"esri.views.3d.layers.BuildingComponentSublayerView3D"===this.view.declaredClass;if(s&&a&&e.returnGeometry){const t=Object.assign({},e,{returnGeometry:!1});try{const e=yield i.queryFeatures(t);r=null==e?void 0:e.features}catch(e){console.error("Query feature from view error.",this.id,e),r=[]}}r||(r=[]),t(r)}))})}queryFeaturesFromClientHighlightLayer(e){return Te(this,void 0,void 0,function*(){return new Promise(t=>Te(this,void 0,void 0,function*(){const i=this.highlightFeatureLayerView;if(e||(e=[]),!i||0===e.length)return void t([]);yield this.whenHighlightLayerViewNotUpdating();this.highlightFeatureLayer.queryFeatures({where:"1=1",returnGeometry:!0}).then(i=>{var r;const s={},a=[];(null===(r=i.features)||void 0===r?void 0:r.length)>0&&(i.features.forEach(e=>{const t=e.getAttribute(Oe);s[t]=e}),e.forEach(e=>{const t=s[e];t&&a.push(t)})),t(a)},e=>{console.error("Query feature from highlightFeatureLayer error.",e),t([])})}))})}selectFeatureById(e,t){return Te(this,void 0,void 0,function*(){const i=yield this.getOrCreateLayerDataSource();if(i){if(!e&&0===i.getSelectedRecordIds().length)return;if(e){let r=null;r=t&&"esri.Graphic"===t.declaredClass?i.buildRecord(t):t,i.selectRecordById(e+"",r)}else i.selectRecordById(null)}else null!=e?this.highLightFeatures([e]):this.clearHighLight()})}selectFeaturesByIds(e,t){return Te(this,void 0,void 0,function*(){let i=null;if(i=e.length>0?yield this.getOrCreateLayerDataSource():this.getLayerDataSource(),i){if(0===e.length&&0===i.getSelectedRecordIds().length)return;i.selectRecordsByIds(e.map(e=>e+""),t)}else if(e.length>0){const t=e.map(e=>Number(e));this.highLightFeatures(t)}else this.clearHighLight()})}beforeSelectFeaturesByQuery(e){return e}selectFeaturesByQuery(e,t){t!==y.DataSourceSelectionMode.AddToCurrent&&t!==y.DataSourceSelectionMode.RemoveFromCurrent&&t!==y.DataSourceSelectionMode.SelectFromCurrent&&(t=y.DataSourceSelectionMode.New),e.geometry=e.geometry.toJSON?e.geometry.toJSON():e.geometry,e=y.lodash.cloneDeep(e);const i=this.beforeSelectFeaturesByQuery(e);i&&(e=i);const r=new AbortController;this.cancelSelectByQuery(!1),this.selectByQueryAbortController=r;const s=this.selectQueryPromise||Promise.resolve([]);return this.selectByQueryProgress=0,this.selectQueryPromise=new Promise(i=>{s.finally(()=>Te(this,void 0,void 0,function*(){let s=null,a=[];const n=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).mapWidgetId;try{if(s=yield this.getOrCreateLayerDataSource(),s){const i=r.signal,o=yield y.dataSourceUtils.selectBySelectionMode({widgetId:n,ds:s,query:e,selectionMode:t,signal:i,checkLayerVisibility:!0,jimuLayerView:this,progressCallback:e=>{this.setSelectQueryProgress(r,e)},updateSelectionIfAborted:()=>{let e=!1;return r&&(e=this.isFreshAbortController(r)&&!r.notUpdateSelection),e}});(null==o?void 0:o.records)&&(a=o.records)}}catch(e){a=[]}const o=a.map(e=>e.feature);f(this,a),this.setSelectQueryProgress(r,1),this.isFreshAbortController(r)&&(this.selectQueryPromise=null,this.selectByQueryAbortController=null),i(o)}))}),this.selectQueryPromise}cancelSelectByQuery(e){return Te(this,void 0,void 0,function*(){this.selectByQueryAbortController&&(this.selectByQueryAbortController.notUpdateSelection=!e,this.selectByQueryAbortController.abort()),this.selectQueryPromise&&(yield this.selectQueryPromise)})}isFreshAbortController(e){return e&&e===this.selectByQueryAbortController}getOrCreateLocalDataSource(e){return Te(this,void 0,void 0,function*(){const t=yield this.getOrCreateLayerDataSource();return t?t.dataSourceManager.createLocalDataSource(t,e):null})}getSelectQueryProgress(){if(this.selectQueryPromise){const e=this.selectByQueryProgress,t=.01;return"number"==typeof e?Math.max(e,t):t}return 1}setSelectQueryProgress(e,t){if(this.isFreshAbortController(e)){const e=0,i=1;this.selectByQueryProgress=Math.max(e,Math.min(t,i));const r=this.getJimuMapView();r&&r.onSelectByQueryProgressChange()}}whenClientQueryReady(e,t){return Te(this,void 0,void 0,function*(){var i;if(!e)throw new Error(`query param is null, ${this.id} not ready for client query`);if(e.disableClientQuery)return console.debug(`disableClientQuery is true, ${this.id} not ready for client query`),null;const r=yield this.getApiQueryForClientQuery(e,t);if(!r)throw new Error(`can't convert queryParams to API query instance, ${this.id} not ready for client query`);if("esri.layers.FeatureLayer"!==(null===(i=this.layer)||void 0===i?void 0:i.declaredClass))return console.debug(`layer is not a real FeatureLayer, ${this.id} not ready for client query`),null;const s=this.getJimuMapView();if(s.isDestroyed())return console.debug(`JimuMapView is destroyed, ${this.id} not ready for client query`),null;if(s.isCached())return console.debug(`JimuMapView is cached, ${this.id} not ready for client query`),null;if(yield s.whenJimuMapViewLoaded(),this.view||(yield s.whenJimuLayerViewLoaded(this.id)),!this.view)return console.debug(`layerView is not available, ${this.id} not ready for client query`),null;const a=this.view,n=yield this.getOrCreateLayerDataSource();if(!n)throw new Error(`layer data source is not available, ${this.id} not ready for client query`);const o=n.getCurrentQueryParams&&n.getCurrentQueryParams(),l=(null==o?void 0:o.where)||"",u=e.where||"",c=this.layer.definitionExpression||"";if(u&&l&&u.includes(l)){if(c!==l)return console.debug(`layer.definitionExpression is not same with data source runtime where, ${this.id} not ready for client query`),null}else{if(!this.isSqlEmpty(c))return console.debug(`query data from global data scope but layer.definitionExpression is not empty, ${this.id} not ready for client query`),null}let d=yield this.checkGeometryForClientQuery(r);if(!d)return null;if(!this.updateLayerOutFieldsForClientQuery(e,r,t,n))return null;if(yield this.whenCurrentLayerViewNotUpdating(),d=yield this.checkGeometryForClientQuery(r),!d)return null;if(this.view.updating)throw new Error(`layerView.updating is still true after pass all checks, ${this.id} not ready for client query`);if("feature"===t){if(e.returnGeometry&&e.returnFullGeometry&&!a.hasFullGeometries)return console.debug(`layerView.hasFullGeometries is false, ${this.id} not ready for client query`),null}return r})}checkGeometryForClientQuery(e){return Te(this,void 0,void 0,function*(){try{const t=this.view;if(t.hasAllFeatures)return!0;const i=this.getJimuMapView().view,r=e.geometry;let s=null;return r&&(r.extent?s=r.extent:"point"===r.type&&(s=r)),s?i.extent.contains(s)?(yield this.whenCurrentLayerViewNotUpdating(),i.extent.contains(s)?(t.hasAllFeaturesInView||console.debug(`layerView.hasAllFeaturesInView is false, ${this.id} not ready for client query`),t.hasAllFeaturesInView):(console.debug(`current map extent does not contain geometry, ${this.id} not ready for client query`),!1)):(console.debug(`current map extent does not contain geometry, ${this.id} not ready for client query`),!1):(yield this.whenCurrentLayerViewNotUpdating(),t.hasAllFeatures||console.debug(`layerView.hasAllFeatures is false, ${this.id} not ready for client query`),t.hasAllFeatures)}catch(e){console.error("check geometry error for client query",e)}return!1})}updateLayerOutFieldsForClientQuery(e,t,i,r){if(!(this.layer.outFields&&this.layer.outFields.includes("*"))){const s=y.dataSourceUtils.getUsedFieldsFromFeatureLayerQueryParams(e.asMutable({deep:!0}),r,i)||[],a=t.outFields||[],n=Array.from(new Set([...s,...a]));let{added:o}=y.utils.diffArrays(!0,this.view.availableFields,n);if(o.includes("*")&&(o=["*"]),o.length>0){if(e.notAddFieldsToClient)return console.debug(`don't add new fields to layer.outFields for client query because notAddFieldsToClient is true: ${o}, view id: ${this.id}, query type:${i}`),!1;if(!this.isLayerVisibleForRendering())return console.debug(`layer is not visible for rendering, so can't add new fields to layer.outFields for client query: ${o}, view id: ${this.id}, query type:${i}`),!1;if(console.debug(`add new fields to layer.outFields for client query: ${o}, view id: ${this.id}, query type:${i}`),o.includes("*"))this.layer.outFields=["*"];else{const e=(this.layer.outFields||[]).concat(o);this.layer.outFields=e}}}return!0}whenCurrentLayerViewNotUpdating(){return this.view?this.whenLayerViewNotUpdating(this.view):Promise.resolve()}whenHighlightLayerViewNotUpdating(){return this.highlightFeatureLayerView?this.whenLayerViewNotUpdating(this.highlightFeatureLayerView):Promise.resolve()}whenLayerViewNotUpdating(e){return new Promise(t=>{setTimeout(()=>Te(this,void 0,void 0,function*(){if(e.updating){let i=(yield this.getReactiveUtils()).watch(()=>e.updating,e=>{e||i&&(i.remove(),i=null,t())})}else t()}),0)})}clientQueryFeatures(e){return Te(this,void 0,void 0,function*(){let t=null;try{const i=yield this.whenClientQueryReady(e,"feature");if(i){const e=yield this.view.queryFeatures(i);console.debug(`Query from client-side. view id: ${this.id}`),t={success:!0,data:e,hasFullGeometry:!!this.view.hasFullGeometries}}}catch(e){t=null,console.error(`clientQueryFeatures err for ${this.id}`,e)}return t||(t={success:!1,data:null,hasFullGeometry:!1}),t})}clientQueryObjectIds(e){return Te(this,void 0,void 0,function*(){let t=null;try{const i=yield this.whenClientQueryReady(e,"id");if(i){let e=yield this.view.queryObjectIds(i);e||(e=[]),console.debug(`Query objectIds from client-side. view id: ${this.id}`),t={success:!0,data:e}}}catch(e){t=null,console.error(`clientQueryObjectIds err for ${this.id}`,e)}return t||(t={success:!1,data:null}),t})}clientQueryFeatureCount(e){return Te(this,void 0,void 0,function*(){let t=null;try{const i=yield this.whenClientQueryReady(e,"count");if(i){const e=yield this.view.queryFeatureCount(i);console.debug(`Query feature count from client-side. view id: ${this.id}`),t={success:!0,data:e}}}catch(e){t=null,console.error(`clientQueryFeatureCount err for ${this.id}`,e)}return t||(t={success:!1,data:null}),t})}clientQueryExtent(e){return Te(this,void 0,void 0,function*(){let t=null;try{const i=yield this.whenClientQueryReady(e,"extent");if(i){const e=yield this.view.queryExtent(i);console.debug(`Query extent from client-side. view id: ${this.id}`),t={success:!0,data:e}}}catch(e){t=null,console.error(`clientQueryExtent err for ${this.id}`,e)}return t||(t={success:!1,data:null}),t})}getApiQueryForClientQuery(e,t){return Te(this,void 0,void 0,function*(){let i=null;const r=yield this.getOrCreateLayerDataSource(),s=yield y.dataSourceUtils.changeJimuArcGISQueryToJSAPIQuery(r,e);if("esri.rest.support.Query"===s.declaredClass)i=s;else{i=new(yield(0,y.loadArcGISJSAPIModule)("esri/rest/support/Query"))(s)}if(!r.isSqlCaseSensitive){const t=this.isSqlEmpty(e.where),s=r.getMainDataSource().getDataView(y.CONSTANTS.SELECTION_DATA_VIEW_ID),a=y.dataSourceUtils.getArcGISSQL(e.sqlExpression,s),n=(null==a?void 0:a.sql)||"",o=this.isSqlEmpty(n);if(!t&&o)return null;i.where=n}return"id"!==t&&"count"!==t&&"extent"!==t||(i.outFields=[]),i})}isSqlEmpty(e){return e&&(e=e.replace(/[()\s]/g,"")),!e||"1=1"===e}setDefinitionExpression(e){this.localDefinitionExpression=e,this.setDefinitionExpressionToLayer()}validateDataSource(e){const t=null==e?void 0:e.type,i=[y.DataSourceTypes.FeatureLayer,y.DataSourceTypes.SceneLayer,y.DataSourceTypes.BuildingComponentSubLayer,y.DataSourceTypes.ImageryLayer,y.DataSourceTypes.OrientedImageryLayer,y.DataSourceTypes.SubtypeGroupLayer,y.DataSourceTypes.SubtypeSublayer];return t&&i.includes(t)}getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}getOrCreateLayerDataSource(){return super.getOrCreateLayerDataSource()}getHighlightLayerLayer(){return this.highlightFeatureLayer}getExcludePairsForBuildingExplorer(){var e;const t=[],i=null===(e=(0,y.getAppStore)().getState().appConfig)||void 0===e?void 0:e.widgets;return i&&Object.values(i).forEach(e=>{if("widgets/arcgis/building-explorer/"===e.uri){const i={dataSourceId:this.layerDataSourceId,widgetId:e.id};t.push(i)}}),t}getCurrentQueryParamsWithoutBuildingExplorer(){const e=this.getLayerDataSource();if(e&&e.getCurrentQueryParams){const t=this.getExcludePairsForBuildingExplorer();return e.getCurrentQueryParams({exclude:t})}return null}shouldWatchMapViewRestore(){return!0}watchMapViewRestore(){if(!this.shouldWatchMapViewRestore())return;const e=this.getJimuMapView();e&&e.addRestoreListener(this.onMapViewRestore)}onLayerDataSourceInfoChange(e,t){var i;super.onLayerDataSourceInfoChange(e,t);const r=(null==e?void 0:e.selectedIds)||null,s=(null==t?void 0:t.selectedIds)||null;if(r!==s){if(this.highlightFeatureLayer){const e=this.getJimuMapView();(null==e?void 0:e.isCached())&&(this.isHighlightFeatureLayerDirty=!0)}this.updateHighlightBySelectedIds(s)}const a=this.getLayerDataSource();a?this.setDefinitionExpressionToLayer():(null===(i=null==t?void 0:t.widgetQueries)||void 0===i?void 0:i._filterInUrl)&&this.createLayerDataSource().then(()=>{this.setDefinitionExpressionToLayer()}),this.view&&((null==t?void 0:t.gdbVersion)&&(this.layer.gdbVersion=t.gdbVersion),!(null==t?void 0:t.gdbVersion)&&this.originalGdbVersion&&(this.layer.gdbVersion=this.originalGdbVersion)),a&&a.getAutoRefreshInterval&&this.setRefreshIntervalForLayer(a.getAutoRefreshInterval()),(null==e?void 0:e.sourceVersion)!==(null==t?void 0:t.sourceVersion)&&this.refreshLayer()}shouldWatchPopupSelectFeature(){return!0}watchPopupSelectFeature(){return Te(this,void 0,void 0,function*(){if(!this.shouldWatchPopupSelectFeature())return;const e=yield this.getReactiveUtils();this.popupSelectFeatureWatchHandle&&(this.popupSelectFeatureWatchHandle.remove(),this.popupSelectFeatureWatchHandle=null),this.popupSelectFeatureWatchHandle=e.watch(()=>{var e,t;return null===(t=null===(e=this.getMapSceneView())||void 0===e?void 0:e.popup)||void 0===t?void 0:t.selectedFeature},e=>Te(this,void 0,void 0,function*(){var t,i;const r=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId);if(r&&r.isPopupFeaturesFromSelection())return;if(!e)return;if(this.shouldUsePopupSelectedFeatureToUpdateSelection()){if(!e)return;const s=e.getObjectId();if(null==s)return;const a=yield this.getOrCreateLayerDataSource();if((null===(i=null===(t=r.view)||void 0===t?void 0:t.popup)||void 0===i?void 0:i.selectedFeature)!==e)return;if(!a)return void this.selectFeatureById(s);if(a.getSelectedRecordIds().includes(s+""))return;a.queryById(s+"").then(t=>{var i,a;(null===(a=null===(i=r.view)||void 0===i?void 0:i.popup)||void 0===a?void 0:a.selectedFeature)===e&&(this.selectFeatureById(Number(s),t),f(this,[t]))})}else{this.getSelectedFeatureCount()>0&&(this.selectFeatureById(null),f(this,[]))}}))})}releasePopupVisibleWatchHandle(){this.popupVisibleWatchHandle&&(this.popupVisibleWatchHandle.remove(),this.popupVisibleWatchHandle=null)}watchPopupVisible(){return Te(this,void 0,void 0,function*(){this.releasePopupVisibleWatchHandle();const e=yield this.getReactiveUtils();this.releasePopupVisibleWatchHandle(),this.popupVisibleWatchHandle=e.watch(()=>{var e,t;return null===(t=null===(e=this.getMapSceneView())||void 0===e?void 0:e.popup)||void 0===t?void 0:t.visible},e=>{var t;const i=null===(t=this.getMapSceneView())||void 0===t?void 0:t.popup;!e&&i&&this.isPopupSelectCurrentLayerFeature()&&(i.features=[],f(this,[]),this.selectFeatureById(null))})})}isPopupSelectCurrentLayerFeature(){var e;const t=null===(e=this.getMapSceneView())||void 0===e?void 0:e.popup;return t&&t.selectedFeature&&this.getLayerFromFeature(t.selectedFeature)===this.layer}shouldUsePopupSelectedFeatureToUpdateSelection(){return this.isPopupSelectCurrentLayerFeature()}onParentLayerVisibleChange(e){this.onLayerFinalVisibleChange()}watchLayerVisible(){return Te(this,void 0,void 0,function*(){this.layerVisibleWatchHandle&&(this.layerVisibleWatchHandle.remove(),this.layerVisibleWatchHandle=null);const e=yield this.getReactiveUtils();this.layerVisibleWatchHandle=e.watch(()=>{var e;return null===(e=this.layer)||void 0===e?void 0:e.visible},()=>{this.onLayerFinalVisibleChange()})})}onLayerFinalVisibleChange(){var e;const t=this.isLayerVisible();this.highlightFeatureLayer&&(this.highlightFeatureLayer.visible=t);const i=null===(e=this.getMapSceneView())||void 0===e?void 0:e.popup;i&&this.isPopupSelectCurrentLayerFeature()&&i.visible!==t&&(this.releasePopupVisibleWatchHandle(),i.visible=t,this.watchPopupVisible())}watchHighlightOptions(){return Te(this,void 0,void 0,function*(){this.highlightOptionsWatchHandle&&(this.highlightOptionsWatchHandle.remove(),this.highlightOptionsWatchHandle=null);const e=yield this.getReactiveUtils();this.highlightOptionsWatchHandle=e.watch(()=>{const e=this.getHighlightOptions();return[null==e?void 0:e.color,null==e?void 0:e.haloColor]},e=>{this.highlightFeatureLayer&&(this.highlightFeatureLayer.renderer=this.getRendererForHighlightLayer(this.highlightFeatureLayer.geometryType))})})}getLayerFromFeature(e){const t=e.layer,i=e.sourceLayer;let r=t||i;return"esri.layers.BuildingSceneLayer"===(null==t?void 0:t.declaredClass)&&"esri.layers.buildingSublayers.BuildingComponentSublayer"===(null==i?void 0:i.declaredClass)&&(r=i),r}setRefreshIntervalForLayer(e){if(!this.view||null==e)return;(0,y.getAppStore)().getState().appRuntimeInfo.appMode===y.AppMode.Design?this.layer.refreshInterval=0:this.layer.refreshInterval=e/60}getLocalDefinitionExpressionToMerge(){return this.localDefinitionExpression||""}setDefinitionExpressionToLayer(){return Te(this,void 0,void 0,function*(){var e,t,i,r;const s=this.getCurrentQueryParamsWithoutBuildingExplorer();if(s&&this.layer){const a=this.isFeatureLayer(),n=this.isSceneLayer(),o=this.isBuildingComponentSublayer(),l=this.isImageryLayer(),u=this.isOrientedImageryLayer(),c=this.isSubtypeGroupLayer(),d=this.getLayerDataSource(),h={outFields:["*"],where:this.getLocalDefinitionExpressionToMerge(),returnGeometry:!0};let p=null;if(d&&d.getRealQueryParams){const e={excludeQuery:this.getExcludePairsForBuildingExplorer()};p=d.getRealQueryParams(h,"query",e)}const g=p||s,f="esri.layers.support.Sublayer"===this.layer.declaredClass&&(null===(i=null===(t=null===(e=this.layer.layer)||void 0===e?void 0:e.capabilities)||void 0===t?void 0:t.exportMap)||void 0===i?void 0:i.supportsSublayerDefinitionExpression)||a||n||o||l||u||c||this.view,m=this.isSqlEmpty(this.layer.definitionExpression)&&this.isSqlEmpty(null==g?void 0:g.where);if(g&&f&&g.where!==this.layer.definitionExpression&&!m&&(this.layer.definitionExpression=g.where),a||l||c||n){const e=this.layer;null!=(null==g?void 0:g.time)?(e.useViewTime=!1,e.timeExtent=y.dataSourceUtils.changeJimuTimeToJSAPITimeExtent(null==g?void 0:g.time)||null):(e.useViewTime=!0,e.timeExtent=null)}yield this.whenViewLoaded();const v=null===(r=this.layer)||void 0===r?void 0:r[y.ExBAddedJSAPIProperties.EXB_LAYER_VIEW_IGNORE_SPATIAL_FILTER];if(this.view&&!l&&!v){const e=this.view;if(s.geometry){if(e.filter&&e.filter.geometry===s.geometry)return;(0,y.loadArcGISJSAPIModules)(["esri/geometry/support/jsonUtils"]).then(t=>{const i=t[0];e.filter={geometry:i.fromJSON(s.geometry)}})}else e.filter&&(e.filter=null)}}})}refreshLayer(){var e,t;(this.isFeatureLayer()||this.isSubtypeGroupLayer())&&(y.requestUtils.deleteSettledRequestCacheByPartialKeys([y.dataSourceUtils.getUrlByLayer(this.layer),"f=json"]),null===(t=(e=this.layer).refresh)||void 0===t||t.call(e))}updateHighlightBySelectedIds(e){if((null==e?void 0:e.length)>0){if(this.getLayerDataSource())this.highLightSelectedRecords();else{const t=[];e.forEach(e=>{t.push(Number(e))}),this.highLightFeatures(t)}}else this.clearHighLight()}highLightSelectedRecords(){if(0===this.getSelectedRecordIds().length)return;const e=this.getSelectedRecordIds().map(e=>parseInt(e));this.highLightFeatures(e)}tryCreateHighLightFeatureLayer(){return Te(this,void 0,void 0,function*(){if(yield this.whenViewLoaded(),this.view||this.type!==y.JSAPILayerTypes.FeatureLayer||!this.isLoaded)return;yield this.getJimuMapView().whenJimuLayerViewLoaded(this.id);if(!(this.getLayerDataSource()||(yield this.createLayerDataSource())))return;if(this.highLightLayerCreationPromise)return this.highLightLayerCreationPromise;const e=this.layer,t=this.getObjectIdField(e.fields,e.objectIdField),i={name:Oe,type:"integer",alias:Oe,description:""},r=t?[t,i]:[i];return this.highLightLayerCreationPromise=(0,y.loadArcGISJSAPIModules)(["esri/layers/FeatureLayer"]).then(t=>Te(this,void 0,void 0,function*(){var i,s;const a=t[0],n=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).view,o=(null===(s=null===(i=this.layer)||void 0===i?void 0:i.sourceJSON)||void 0===s?void 0:s.hasZ)||!1,l=e.fullExtent||e.extent,u=(yield P(e.spatialReference,n.spatialReference,this.layerDataSourceId,l))?e.spatialReference:n.spatialReference;return this.highlightFeatureLayer=new a({title:`${e.title}-highlight`,geometryType:e.geometryType,spatialReference:u,source:[],fields:r,objectIdField:e.objectIdField,renderer:this.getRendererForHighlightLayer(e.geometryType),listMode:"hide",legendEnabled:!1,popupEnabled:!1,visible:this.isLayerVisible(),hasZ:o}),n.map.add(this.highlightFeatureLayer),new Promise((e,t)=>{this.highlightFeatureLayer.on("layerview-create",t=>{this.highlightFeatureLayerView=t.layerView,e()})})})),this.highLightLayerCreationPromise})}addFeaturesToHighlightFeatureLayer(e){return Te(this,void 0,void 0,function*(){const t=this.getLayerDataSource(),i=t.getIdField(),r=t.getSelectedRecords(),s={};r.forEach(e=>{if(e){const t=e.getId(),i=e.feature;null!=t&&""!==t&&i&&(s[t]=i)}});const a=[];if(e.forEach(e=>{const t=s[e+""];t&&a.push(t)}),0===a.length)return;let n=yield this.getApiGraphicsByRecordFeatures(a,!0);if(0===n.length)return;const o=this.getMapSceneView(),l=yield this.getOrCreateLayerDataSource(),u=yield V(o,l,n);u.features&&(n=u.features),n.forEach(e=>{const t=e.attributes&&e.attributes[i];e.attributes={},e.attributes[i]=t,e.attributes[Oe]=t}),this.latestHighlightIds===e&&(yield this.highlightFeatureLayer.applyEdits({addFeatures:n}))})}removeFeaturesFromHighlightFeatureLayer(){return Te(this,void 0,void 0,function*(){const e=(yield this.highlightFeatureLayer.queryFeatures({where:"1=1"})).features||[];e.length>0&&(yield this.highlightFeatureLayer.applyEdits({deleteFeatures:e}))})}highlightFeatureById(e){"number"==typeof e&&this.highLightFeatures([e])}highLightFeatures(e){return Te(this,void 0,void 0,function*(){if(this.latestHighlightIds=e,this.releaseHighLightHandle(),yield this.tryCreateHighLightFeatureLayer(),this.view){const t=this.view;let i=[];const r=this.isImageryLayer();r&&(i=yield this.queryRasterFeatures(e)),t.when(()=>Te(this,void 0,void 0,function*(){if(yield this.whenLayerViewNotUpdating(t),r)this.latestHighlightIds===e&&(this.releaseHighLightHandle(),this.highLightHandle=t.highlight(i),this.onSelectedFeaturesChange(!1));else{this.releaseHighLightHandle();const e=this.latestHighlightIds||[];this.highLightHandle=t.highlight(e),this.onSelectedFeaturesChange(!1)}}))}else this.highlightFeatureLayerView?(yield this.removeFeaturesFromHighlightFeatureLayer(),yield this.addFeaturesToHighlightFeatureLayer(e),this.onSelectedFeaturesChange(!1)):this.onSelectedFeaturesChange(!1)})}queryRasterFeatures(e){return Te(this,void 0,void 0,function*(){let t=[];if(this.isImageryLayer()&&e.length>0){const i=this.layer;try{const r=yield i.queryRasters({objectIds:e,returnGeometry:!0,outFields:[]});t=null==r?void 0:r.features}catch(e){console.error(`JimuImageryLayerView ${this.id} can not query rasters`,e)}}return t||(t=[]),t})}clearHighLight(){var e,t;this.latestHighlightIds=[],this.releaseHighLightHandle(),this.highlightFeatureLayerView&&this.removeFeaturesFromHighlightFeatureLayer();const i=this.getMapSceneView();if(i){if(this.shouldClosePopupWhenClearHighlight()){(null===(t=null===(e=i.popup)||void 0===e?void 0:e.selectedFeature)||void 0===t?void 0:t.isAggregate)||i.closePopup()}}this.onSelectedFeaturesChange(!0)}shouldClosePopupWhenClearHighlight(){return this.isPopupSelectCurrentLayerFeature()}releaseHighLightHandle(){this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null)}onSelectedFeaturesChange(e){const t=this.getJimuMapView();t&&t.onJimuLayerViewSelectedFeaturesChange(this,e)}getSelectedRecordIds(){return this.getLayerDataSource()?this.getLayerDataSource().getSelectedRecordIds().filter(e=>!!e):[]}getObjectIdField(e,t){let i=null;for(let r=0;r<e.length;r++)if(e[r].name===t)return i=e[r],i;return i}getHighlightOptions(){var e;let t=null;const i=this.getJimuMapView(),r=null==i?void 0:i.view;return(null===(e=r.highlights)||void 0===e?void 0:e.length)>0&&(t=r.highlights.find(e=>"default"===e.name)),t}getRendererForHighlightLayer(e){var t,i;const r=this.getHighlightOptions(),s=(null===(t=null==r?void 0:r.color)||void 0===t?void 0:t.clone())||"#00FFFF",a=(null===(i=null==r?void 0:r.haloColor)||void 0===i?void 0:i.clone())||"#00FFFF";return["point","multipoint"].includes(e)?{type:"simple",symbol:{type:"simple-marker",style:"circle",color:s,size:"16px",outline:{color:a,width:1}}}:["polyline"].includes(e)?{type:"simple",symbol:{type:"simple-line",color:s,width:1,style:"solid"}}:["polygon","extent"].includes(e)?{type:"simple",symbol:{type:"simple-fill",color:[0,255,255,0],style:"solid",outline:{color:a,width:1}}}:["mesh"].includes(e)?{type:"simple",symbol:{type:"mesh-3d",symbolLayers:[{type:"fill",material:{color:s}}]}}:null}}class Re extends Be{getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}class ke extends Be{getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}var Ge=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class We extends Ae{constructor(e){super(e)}ready(){return Ge(this,void 0,void 0,function*(){return yield w(this),this})}}var Ue=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class He extends Ae{constructor(e){super(e)}ready(){return Ue(this,void 0,void 0,function*(){return yield w(this),this})}}class _e extends Be{getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}class Qe extends Be{getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}class Ne extends Be{getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}var qe=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class $e extends Be{ready(){const e=Object.create(null,{ready:{get:()=>super.ready}});return qe(this,void 0,void 0,function*(){return yield e.ready.call(this),yield w(this),this})}getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}shouldClosePopupWhenClearHighlight(){const e=this.isPopupSelectCurrentLayerFeature(),t=this.isPopupSelectChildSubtypeSublayerFeature();return e||t}shouldUsePopupSelectedFeatureToUpdateSelection(){const e=this.isPopupSelectCurrentLayerFeature(),t=this.isPopupSelectChildSubtypeSublayerFeature();return e||t}isPopupSelectChildSubtypeSublayerFeature(){var e;const t=null===(e=this.getMapSceneView())||void 0===e?void 0:e.popup;if(t&&t.selectedFeature){const e=this.getLayerFromFeature(t.selectedFeature);if(e&&"esri.layers.support.SubtypeSublayer"===e.declaredClass&&e.parent===this.layer)return!0}return!1}getLocalDefinitionExpressionToMerge(){const e=this.getJimuMapView(),t=m(this.layer),i=this.localDefinitionExpression||"",r={};if(e){e.getChildJimuLayerViews(this.id).filter(e=>e.type===y.JSAPILayerTypes.SubtypeSublayer&&e.getLocalDefinitionExpressionToMerge).forEach(e=>{var t;const i=e.getLocalDefinitionExpressionToMerge(),s=null===(t=e.layer)||void 0===t?void 0:t.subtypeCode;i&&"number"==typeof s&&(r[s]=i)})}let s="";return(i||Object.keys(r).length>0)&&(s=y.dataSourceUtils.mergeSubtypeSublayerWhereClausesToSubtypeGroupLayer(t,i,r)),s||(s=""),s}beforeSelectFeaturesByQuery(e){var t;let i=e;if(this.layer){const r=m(this.layer),s=null===(t=this.layer.sublayers)||void 0===t?void 0:t.toArray();if(r&&(null==s?void 0:s.length)>0){const t=[];if(s.forEach(e=>{e.visible||t.push(e.subtypeCode)}),t.length>0){const s=`${r} NOT IN (${t.join(",")})`,a=e.where;let n=e.where;n=a?`((${a}) AND (${s}))`:`(${s})`,i=Object.assign({},e),i.where=n}}}return i}}var Ye=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class Xe extends Be{constructor(e){super(e)}getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}onLayerDataSourceInfoChange(e,t){Ae.prototype.onLayerDataSourceInfoChange.apply(this,[e,t])}shouldWatchPopupSelectFeature(){return!1}shouldWatchMapViewRestore(){return!1}getLocalDefinitionExpressionToMerge(){return this.localDefinitionExpression||""}setDefinitionExpression(e){this.localDefinitionExpression=e;const t=this.getParentJimuLayerView();t&&t.type===y.JSAPILayerTypes.SubtypeGroupLayer&&t.setDefinitionExpressionToLayer&&t.setDefinitionExpressionToLayer()}setDefinitionExpressionToLayer(){return Ye(this,void 0,void 0,function*(){console.warn("JimuSubtypeSublayerView.setDefinitionExpressionToLayer() doesn't work because SubtypeSublayer doesn't support layer.definitionExpression")})}}class ze extends Ae{constructor(e){super(e)}}var Ke=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class Ze extends Ae{constructor(e){super(e)}ready(){return Ke(this,void 0,void 0,function*(){return yield w(this),this})}}var et=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class tt extends Ae{constructor(e){super(e)}ready(){return et(this,void 0,void 0,function*(){return yield w(this),this})}}class it extends Ae{constructor(e){super(e)}}class rt extends Ae{constructor(e){super(e)}}class st extends Ae{constructor(e){super(e)}}class at extends Ae{constructor(e){super(e)}}class nt extends Ae{constructor(e){super(e)}}class ot extends Ae{constructor(e){super(e)}}class lt extends Ae{constructor(e){super(e)}}class ut extends Ae{constructor(e){super(e)}}var ct=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class dt extends Ae{constructor(e){super(e)}ready(){return ct(this,void 0,void 0,function*(){return yield w(this),this})}}var ht=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class yt extends Ae{constructor(e){super(e)}ready(){return ht(this,void 0,void 0,function*(){return yield w(this),this})}}var pt=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class gt extends Ae{constructor(e){super(e)}ready(){return pt(this,void 0,void 0,function*(){return yield w(this),this})}}class ft extends Ae{constructor(e){super(e)}}class mt extends Ae{constructor(e){super(e)}}var vt=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class wt extends Ae{constructor(e){super(e)}ready(){return vt(this,void 0,void 0,function*(){return yield w(this),this})}}class St extends Ae{constructor(e){super(e)}}class Lt extends Ae{constructor(e){super(e)}}class bt extends Ae{constructor(e){super(e)}}class It extends Ae{constructor(e){super(e)}}class Vt extends Ae{constructor(e){super(e)}}class Mt extends Ae{constructor(e){super(e)}}class Pt extends Ae{constructor(e){super(e)}}class At extends Ae{constructor(e){super(e)}}class Ct extends Ae{constructor(e){super(e)}}class Jt extends Ae{constructor(e){super(e)}}class Ft extends Ae{constructor(e){super(e)}}class Et extends Ae{constructor(e){super(e)}}class Dt extends Ae{constructor(e){super(e)}}class xt extends Ae{constructor(e){super(e)}}var jt=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class Tt extends Ae{constructor(e){super(e)}ready(){return jt(this,void 0,void 0,function*(){return yield w(this),this})}}class Ot extends Ae{constructor(e){super(e)}}class Bt extends Ae{constructor(e){super(e)}}var Rt=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class kt extends Ae{constructor(e){super(e)}ready(){return Rt(this,void 0,void 0,function*(){return yield w(this),this})}}class Gt extends Ae{constructor(e){super(e)}}var Wt=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class Ut extends Ae{constructor(e){super(e)}ready(){return Wt(this,void 0,void 0,function*(){return yield w(this),this})}}var Ht=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class _t{constructor(e){this.switchMap=(...e)=>Ht(this,[...e],void 0,function*(e=!1){if(this.mapWidgetInstance)return yield this.mapWidgetInstance.switchMap(e);yield Promise.resolve()}),this.fullScreenMap=()=>{this.mapWidgetInstance&&this.mapWidgetInstance.fullScreenMap()},this.mapWidgetId=e,this.jimuMapViews={}}setMapWidgetInstance(e){this.mapWidgetInstance=e}addJimuMapView(e){this.jimuMapViews[e.id]=e,e.jimuMapViewGroup=this}setJimuMapView(e){this.jimuMapViews[e.id]=e,e.jimuMapViewGroup=this}removeJimuMapView(e){delete this.jimuMapViews[e.id],e.jimuMapViewGroup===this&&(e.jimuMapViewGroup=null)}getActiveJimuMapView(){const e=Object.keys(this.jimuMapViews);for(let t=0;t<e.length;t++)if(this.jimuMapViews[e[t]].isActive)return this.jimuMapViews[e[t]];return null}showMapTools(){this.getAllJimuMapViews().forEach(e=>{const t=e.view;t&&t.showMapTools&&t.showMapTools()})}hideMapTools(){this.getAllJimuMapViews().forEach(e=>{const t=e.view;t&&t.hideMapTools&&t.hideMapTools()})}getAllJimuMapViews(){return Object.keys(this.jimuMapViews).map(e=>this.jimuMapViews[e])}}var Qt=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};class Nt{constructor(){this.jimuMapViewGroups={}}static getInstance(){return window.jimuConfig.isBuilder?window._appWindow&&window._appWindow._mapViewManager:(Nt._instance||(Nt._instance=new Nt,window._mapViewManager=Nt._instance),Nt._instance)}getJimuMapViewById(e){const t=Object.keys(this.jimuMapViewGroups);if(0===t.length)return null;for(let i=0;i<t.length;i++){const r=t[i];if(Object.keys(this.jimuMapViewGroups[r].jimuMapViews).includes(e))return this.jimuMapViewGroups[r].jimuMapViews[e]}return null}getJimuMapViewGroup(e){return this.jimuMapViewGroups[e]?this.jimuMapViewGroups[e]:null}createJimuMapView(e){return Qt(this,void 0,void 0,function*(){const t=e.mapWidgetId+"-"+e.dataSourceId;if(this.getJimuMapViewById(t))return yield Promise.resolve(this.getJimuMapViewById(t));const i=new si(e);return this.addJimuMapView(i),yield i.whenJimuMapViewLoaded()})}addJimuMapView(e){if(this.jimuMapViewGroups[e.mapWidgetId])this.jimuMapViewGroups[e.mapWidgetId].addJimuMapView(e);else{const t=new _t(e.mapWidgetId);t.addJimuMapView(e),this.jimuMapViewGroups[e.mapWidgetId]=t}(0,y.getAppStore)().dispatch(y.appActions.jimuMapViewAdded(e.id,(0,y.Immutable)({id:e.id,mapWidgetId:e.mapWidgetId,dataSourceId:e.dataSourceId,status:e.status})))}setJimuMapView(e){if(this.jimuMapViewGroups[e.mapWidgetId])this.jimuMapViewGroups[e.mapWidgetId].setJimuMapView(e);else{const t=new _t(e.mapWidgetId);t.addJimuMapView(e),this.jimuMapViewGroups[e.mapWidgetId]=t}(0,y.getAppStore)().dispatch(y.appActions.jimuMapViewUpdated(e.id,(0,y.Immutable)({id:e.id,mapWidgetId:e.mapWidgetId,dataSourceId:e.dataSourceId,isActive:e.isActive,status:e.status})))}destroyJimuMapView(e){const t=this.getJimuMapViewById(e);t&&t.destroy();const i=Object.keys(this.jimuMapViewGroups);if(0===i.length);else for(let t=0;t<i.length;t++){const r=i[t];if(Object.keys(this.jimuMapViewGroups[r].jimuMapViews).includes(e)){delete this.jimuMapViewGroups[r].jimuMapViews[e],0===Object.keys(this.jimuMapViewGroups[r].jimuMapViews).length&&delete this.jimuMapViewGroups[r],(0,y.getAppStore)().dispatch(y.appActions.jimuMapViewRemoved(e));break}}}getAllJimuMapViewIds(){const e=[];return Object.keys(this.jimuMapViewGroups).forEach(t=>{Object.keys(this.jimuMapViewGroups[t].jimuMapViews).forEach(t=>{e.push(t)})}),e}getAllJimuMapViews(){const e=[];return Object.keys(this.jimuMapViewGroups).forEach(t=>{const i=Object.values(this.jimuMapViewGroups[t].jimuMapViews);e.push(...i)}),e}destroyAllJimuMapViews(){this.getAllJimuMapViewIds().forEach(e=>{this.destroyJimuMapView(e)})}getJimuLayerViewForClientQuery(e){var t,i,r;if(!e||![y.DataSourceTypes.FeatureLayer,y.DataSourceTypes.SceneLayer].includes(e.type))return null;const s=e.id,a=null===(t=e.getRootDataSource())||void 0===t?void 0:t.id;if(!a)return null;const n=null===(r=null===(i=(0,y.getAppStore)().getState())||void 0===i?void 0:i.appConfig)||void 0===r?void 0:r.widgets;if(!n)return null;const o=this.getAllJimuMapViews().filter(e=>{var t;return"2d"===(null===(t=e.view)||void 0===t?void 0:t.type)&&e.dataSourceId===a});for(const e of o){const t=n[e.mapWidgetId];if(t){const i=t.config||{},r=(null==i?void 0:i.clientQueryDataSourceIds)||[],n=t.useDataSources,o=[];if(n&&n.length>0&&n.forEach(e=>{const t=null==e?void 0:e.dataSourceId;t&&o.push(t)}),r.includes(a)&&o.includes(a)){const t=e.getJimuLayerViewByDataSourceId(s);return t&&t.clientQueryFeatures&&(t.type===y.JSAPILayerTypes.FeatureLayer||t.type===y.JSAPILayerTypes.SceneLayer)?t:null}}}return null}}var qt=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};function $t(e){return qt(this,void 0,void 0,function*(){let t=null;const i=yield C(["esri/renderers/SimpleRenderer"]),[r]=i;return e&&(t=new r({symbol:e})),t})}function Yt(e,t){return qt(this,void 0,void 0,function*(){let i=null;const r=Xt(e,t);if(r){if("esri.symbols.SimpleLineSymbol"===r.declaredClass){r.width=2}i=yield $t(r)}return i})}function Xt(e,t){let i=null;const r=ae(t);return r&&(i=e.fromJSON(r)),i}function zt(e,t,i,r,s,a,n,o,l,u,c){return qt(this,void 0,void 0,function*(){let d=null;try{if(i){const h=function(e,t){let i=null;if(t){let e=t;for(;e&&e.parent;)e=e.parent;e&&("esri.WebMap"===e.declaredClass?i="2d":"esri.WebScene"===e.declaredClass&&(i="3d"))}if(i)return i;if(e){let t=e.getRootDataSource();if(!t&&e.getOriginDataSources){const i=e.getOriginDataSources();if((null==i?void 0:i.length)>0){const e=i[0];e&&(t=e.getRootDataSource())}}t&&(t.type===y.DataSourceTypes.WebMap?i="2d":t.type===y.DataSourceTypes.WebScene&&(i="3d"))}return i}(e,t),p=r.type===h&&function(e){if(e)return["esri.layers.FeatureLayer","esri.layers.OrientedImageryLayer","esri.layers.support.SubtypeSublayer"].includes(e.declaredClass);return!1}(t)||function(e,t){if(e){const i=[];if("esri.renderers.SimpleRenderer"===e.declaredClass){const t=e;t.symbol&&i.push(t.symbol)}else if("esri.renderers.ClassBreaksRenderer"===e.declaredClass){const t=e;t.defaultSymbol&&i.push(t.defaultSymbol),t.backgroundFillSymbol&&i.push(t.backgroundFillSymbol);const r=t.classBreakInfos;if(r&&r.length>0)for(let e=0;e<r.length;e++){const t=r[e];t&&t.symbol&&i.push(t.symbol)}}else{if("esri.renderers.UniqueValueRenderer"!==e.declaredClass)return!1;{const t=e;t.defaultSymbol&&i.push(t.defaultSymbol),t.backgroundFillSymbol&&i.push(t.backgroundFillSymbol);const r=t.uniqueValueGroups;if(r&&r.length>0)for(let e=0;e<r.length;e++){const t=r[e];if(t){const e=t.classes;if(e&&e.length>0)for(let t=0;t<e.length;t++){const r=e[t];r&&r.symbol&&i.push(r.symbol)}}}const s=t.uniqueValueInfos;if(s&&s.length>0)for(let e=0;e<s.length;e++){const t=s[e];t&&t.symbol&&i.push(t.symbol)}}}const r=function(e){const t=["esri.symbols.SimpleMarkerSymbol","esri.symbols.PictureMarkerSymbol","esri.symbols.SimpleLineSymbol","esri.symbols.SimpleFillSymbol"],i=["esri.symbols.PictureFillSymbol"],r=["esri.symbols.LineSymbol3D","esri.symbols.PointSymbol3D","esri.symbols.PolygonSymbol3D"],s=e?t.concat(i):t.concat(r);return s}(t);return!(i.length>0&&i.some(e=>e&&e.declaredClass&&!r.includes(e.declaredClass)))}return!1}(i,"2d"===r.type);if(p){if(d=u.fromJSON(i.toJSON()),d){const e=Xt(l,n);if("esri.renderers.ClassBreaksRenderer"===d.declaredClass){const t=d;t.defaultSymbol||(t.defaultSymbol=e)}else if("esri.renderers.SimpleRenderer"===d.declaredClass){const t=d;t.symbol||(t.symbol=e)}else if("esri.renderers.UniqueValueRenderer"===d.declaredClass){const t=d;t.defaultSymbol||(t.defaultSymbol=e)}}}else d=yield function(e,t,i,r,s,a,n){return qt(this,void 0,void 0,function*(){const o=Xt(a,r),l=new n({valueExpression:`$feature.${i}`,valueExpressionTitle:i,defaultSymbol:o}),u=null==t?void 0:t.features,c={};if((null==u?void 0:u.length)>0){const t=u.map(t=>qt(this,void 0,void 0,function*(){var r;if(t)try{const n=t.getObjectId()||(null===(r=t.attributes)||void 0===r?void 0:r[i]);if(null!=n){const i=yield function(e,t,i,r){return qt(this,void 0,void 0,function*(){var s,a,n,o,l,u,c,d,h,y,p;let g=null,f=null;try{f=yield i.getDisplayedSymbol(t)}catch(e){f=null,g=null}if(f){g=f;if(e&&"esri.views.MapView"===e.declaredClass)if("esri.symbols.PointSymbol3D"===f.declaredClass){const e={type:"esriSMS",color:[255,255,0,150],outline:{color:[255,255,0,150],width:1}},t=f.symbolLayers.toArray();if(t.length>0){const i=null===(a=null===(s=t[0].material)||void 0===s?void 0:s.color)||void 0===a?void 0:a.toJSON();i&&(e.color=i,e.outline.color=i)}g=r.fromJSON(e)}else if("esri.symbols.LineSymbol3D"===f.declaredClass){const e={type:"esriSLS",color:[255,255,0,150],width:1},t=f.symbolLayers.toArray();if(t.length>0){const i=t.find(e=>"esri.symbols.LineSymbol3DLayer"===e.declaredClass);if(i){const t=null===(o=null===(n=i.material)||void 0===n?void 0:n.color)||void 0===o?void 0:o.toJSON();t&&(e.color=t),i.size>0&&(e.width=i.size)}else{const i=null===(u=null===(l=t[0].material)||void 0===l?void 0:l.color)||void 0===u?void 0:u.toJSON();i&&(e.color=i)}}g=r.fromJSON(e)}else if("esri.symbols.PolygonSymbol3D"===f.declaredClass){const e={type:"esriSFS",color:[255,255,0,150],outline:{color:[255,255,0,150],width:1}},t=f.symbolLayers.toArray();if(t.length>0){const i=t.find(e=>"esri.symbols.FillSymbol3DLayer"===e.declaredClass),r=t.find(e=>"esri.symbols.ExtrudeSymbol3DLayer"===e.declaredClass);if(i){const t=null===(d=null===(c=i.material)||void 0===c?void 0:c.color)||void 0===d?void 0:d.toJSON();if(t&&(e.color=t,e.outline.color=t),i.outline){const t=null===(h=i.outline.color)||void 0===h?void 0:h.toJSON();t&&(e.outline.color=t),i.outline.size>0&&(e.outline.width=i.outline.size)}}else if(r){const t=null===(p=null===(y=r.material)||void 0===y?void 0:y.color)||void 0===p?void 0:p.toJSON();t&&(e.color=t,e.outline.color=t)}}g=r.fromJSON(e)}}return g})}(e,t,s,a);i&&(c[n]=i)}}catch(e){console.error("getGraphicDisplaySymbolByRenderer error",e)}}));yield Promise.all(t)}return Object.keys(c).forEach(e=>{const t=Number(e),i=c[t];i&&l.addUniqueValueInfo(t,i)}),l})}(r,s,a,n,o,l,c)}}catch(e){d=null,console.error("createRendererByUserDefinedSymbol error",e)}return d})}var Kt,Zt,ei,ti=a(321),ii=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};!function(e){e.DataAction="DATA_ACTION",e.MessageAction="MESSAGE_ACTION"}(Kt||(Kt={})),function(e){e.Create="CREATE",e.Creating="CREATING",e.Created="CREATED",e.Remove="REMOVE"}(Zt||(Zt={})),function(e){e.Fulfilled="FULFILLED",e.Pending="PENDING",e.Rejected="REJECTED",e.RejectedAndKnown="REJECTEDANDKNOWN"}(ei||(ei={}));const ri=[y.JSAPILayerTypes.FeatureLayer,y.JSAPILayerTypes.SceneLayer,y.JSAPILayerTypes.BuildingComponentSublayer,y.JSAPILayerTypes.OrientedImageryLayer,y.JSAPILayerTypes.ImageryLayer,y.JSAPILayerTypes.SubtypeGroupLayer];class si{constructor(e){this.clickHighlightEnabled=!0,this.cacheListeners=[],this.restoreListeners=[],this.selectedFeaturesChangeListeners=[],this.jimuLayerViewCreatedListeners=[],this.jimuLayerViewRemovedListeners=[],this.jimuLayerViewsVisibleChangedListeners=[],this.selectByQueryProgressChangeListeners=[],this.watchHandles=[],this.popupFeaturesFromSelection=!1,this.showPopupUponSelection=!1,this.forcePopupEnabledLayers=[],this.mapClickCount=0,this.ignoreUpdatePersistentMapState=!1,this.getJimuLayerViewIdByJimuLayerId=e=>`${this.id}-${e}`,this.getJimuLayerViewIdByAPILayer=e=>{const t=e[y.ExBAddedJSAPIProperties.EXB_JIMU_LAYER_VIEW_ID];return t||this.getJimuLayerViewIdByJimuLayerId(y.dataSourceUtils.getJimuLayerIdByJSAPILayer(e))},this.id=e.mapWidgetId+"-"+e.dataSourceId,this.mapWidgetId=e.mapWidgetId,this.isActive=e.isActive,this.dataSourceId=e.dataSourceId,this.view=e.view,this.mapViewManager=e.mapViewManager,this.jimuLayerViews={},this.jimuTables={},this.jimuTableArray=[],this.finalLayerVisibles={},this.status=y.JimuMapViewStatus.Loading,this.view&&(this.view.popupEnabled=void 0===e.isEnablePopup||null===e.isEnablePopup||e.isEnablePopup),this.showOnMapDatas={},this.jimuMapTools=[],this.jimuLayerViewLoadPromises={},this.storeUnsubscribes=[],e.useUrlHashLayersVisibility&&(this.urlHashLayersVisibility=this.parseLayersVisibilityFromUrlHash()),this.initView(this.view);const t=(0,y.observeStore)(this.onStoreChange.bind(this),["dataSourcesInfo"]);this.storeUnsubscribes.push(t),this.view&&this.view.when(()=>{this.watchLayersChange()}),this.watchPopup(),this.watchPopupFeaturesAndSelectedFeature()}watchLayersChange(){var e,t;const i=null===(t=null===(e=this.view)||void 0===e?void 0:e.map)||void 0===t?void 0:t.layers;i&&(this.releaseWatchLayerChangeHandles(),this.watchBeforeAddLayerHandle=i.on("before-add",e=>{L(e,!0)}),this.watchAfterAddLayerHandle=i.on("after-add",e=>{var t,i,r;const s=null==e?void 0:e.item;if(s&&"esri.layers.GraphicsLayer"!==s.declaredClass&&!s[y.ExBAddedJSAPIProperties.EXB_LAYER_CREATED_BY_DATA_SOURCE]&&s[y.ExBAddedJSAPIProperties.EXB_LAYER_FROM_RUNTIME]&&!s[y.ExBAddedJSAPIProperties.EXB_LAYER_REMOVED_BEFORE]&&"hide"!==s.listMode){let e;const a=null===(r=null===(i=null===(t=this.view)||void 0===t?void 0:t.map)||void 0===i?void 0:i.layers)||void 0===r?void 0:r.toArray();if((null==a?void 0:a.length)>0){const t=a.length,i=a.find((e,i)=>{const r=i+1;if(r>=0&&r<=t-1){if(a[r]===s)return!0}return!1}),r=i?this.getJimuLayerViewByAPILayer(i):null;r&&(e=r.index-1)}"number"!=typeof e&&(e=0);const n=null,o=null,l=!0,u=!0;this.createJimuLayerView(s,n,e,o,l,u)}}),this.watchAfterRemoveLayerHandle=i.on("after-remove",e=>{const t=null==e?void 0:e.item;b(e),setTimeout(()=>{if(!this.isDestroyed()&&t){if(i.find(e=>e===t))return;const e=this.getRootAncestorLayer(t);if(e&&i.find(t=>t===e))return;const r=this.getJimuLayerViewByAPILayer(t);r&&this.removeJimuLayerView(r)}},50)}))}releaseWatchLayerChangeHandles(){this.watchBeforeAddLayerHandle&&(this.watchBeforeAddLayerHandle.remove(),this.watchBeforeAddLayerHandle=null),this.watchAfterAddLayerHandle&&(this.watchAfterAddLayerHandle.remove(),this.watchAfterAddLayerHandle=null),this.watchAfterRemoveLayerHandle&&(this.watchAfterRemoveLayerHandle.remove(),this.watchAfterRemoveLayerHandle=null)}getRootAncestorLayer(e){let t=e;const i=["esri.WebMap","esri.WebScene"];for(;t&&t.parent&&!i.includes(t.parent.declaredClass);)t=t.parent;return t}watchPopup(){return ii(this,void 0,void 0,function*(){const e=yield(0,y.loadArcGISJSAPIModule)("esri/core/reactiveUtils");this.watchPopupHandle&&(this.watchPopupHandle.remove(),this.watchPopupHandle=null),this.watchPopupHandle=e.watch(()=>{var e;return null===(e=this.view)||void 0===e?void 0:e.popup},()=>{var e;this.watchPopupActionHandle&&(this.watchPopupActionHandle.remove(),this.watchPopupActionHandle=null);const t=null===(e=this.view)||void 0===e?void 0:e.popup;"esri.widgets.Popup"===(null==t?void 0:t.declaredClass)&&(this.watchPopupActionHandle=t.on("trigger-action",e=>{var i;if("remove-marker"===(null===(i=null==e?void 0:e.action)||void 0===i?void 0:i.id)){const e=t.selectedFeature;e&&this.markerLayer&&e.layer===this.markerLayer&&(this.removeMarker(e),this.updateMarkerUrlParamIfActive(),this.closePopup())}}))})})}watchPopupFeaturesAndSelectedFeature(){return ii(this,void 0,void 0,function*(){const e=yield(0,y.loadArcGISJSAPIModule)("esri/core/reactiveUtils");this.watchPopupFeaturesHandle&&(this.watchPopupFeaturesHandle.remove(),this.watchPopupFeaturesHandle=null),this.watchPopupSelectedHandle&&(this.watchPopupSelectedHandle.remove(),this.watchPopupSelectedHandle=null),this.watchPopupFeaturesHandle=e.watch(()=>{var e,t;return null===(t=null===(e=this.view)||void 0===e?void 0:e.popup)||void 0===t?void 0:t.features},e=>{this.popupFeaturesFromSelection=null==e?void 0:e.fromSelection}),this.watchPopupSelectedHandle=e.watch(()=>{var e,t;return null===(t=null===(e=this.view)||void 0===e?void 0:e.popup)||void 0===t?void 0:t.selectedFeature},()=>{var e,t;if(!this.popupFeaturesFromSelection)return;const i=null===(e=this.view)||void 0===e?void 0:e.popup;if(i&&i.selectedFeature){const e=i.selectedFeature.geometry;let r=null;e&&(r="esri.geometry.Point"===e.declaredClass?e.clone():null===(t=e.extent)||void 0===t?void 0:t.center),r&&(i.location=r)}})})}handlePopupOnSelectionChange(e,t){return ii(this,void 0,void 0,function*(){var i;const r=null===(i=this.view)||void 0===i?void 0:i.popup;if(!r)return;const s=this.isMapWidgetActive();if(this.isAutoShowPopupWhenSelectFeatures()&&!s)yield this.updatePopupFeaturesWhenSelectionChange(r,e,t);else if(r.visible&&!s){const t=r.selectedFeature;if(t){const i=t.getObjectId();if(null!=i){const r=String(i);if(e.layer&&t.layer===e.layer||e.layer&&t.sourceLayer===e.layer||e.id&&t.jimuLayerViewId===e.id){const t=e.getLayerDataSource();if(t){t.getSelectedRecordIds().some(e=>e===r)||this.closePopup()}}}}}})}isFeaturePopupEnabledByCurrentMapPopupSetting(e){var t;let i=null;const r=e.jimuLayerViewId;if(r&&(i=null===(t=this.jimuLayerViews)||void 0===t?void 0:t[r]),!i){const t=e.layer||e.sourceLayer;t&&(i=this.getJimuLayerViewByThisOrOtherMapAPILayer(t))}if(i&&i.layer){return!1!==i.layer.popupEnabled}return!0}updatePopupFeaturesWhenSelectionChange(e,t,i){return ii(this,void 0,void 0,function*(){if(!e)return;if(!e.visible&&i)return void(this.popupFeaturesFromSelection&&this.closePopup());let r=yield this.getSelectedFeatures();r=r.filter(e=>this.isFeaturePopupEnabledByCurrentMapPopupSetting(e));const s=e.selectedFeature,a=s&&s.jimuLayerViewId;let n=null;if(i?a&&(n=a):n=t.id,n){const e=[],t=[];r.forEach(i=>{i.jimuLayerViewId===n?e.push(i):t.push(i)}),r=[...e,...t]}if(s&&r.length>0&&(a&&a===n||!n)){let e=r.indexOf(s);if(e<0){const t=s.getObjectId();if(null!=t){const i=r.length;for(let s=0;s<i;s++){if(r[s].getObjectId()===t){e=s;break}}}}e>=0&&(r.splice(e,1),r.unshift(s))}r.length>0?this.openPopup(r):this.closePopup()})}openPopup(e){this.view&&(e.fromSelection=!0,this.view.openPopup({features:e}))}closePopup(){if(this.view){const e=this.view.popup;e&&(e.features=[]),this.view.closePopup()}}isAutoShowPopupWhenSelectFeatures(){return this.view.popupEnabled&&this.showPopupUponSelection}setShowPopupUponSelection(e){this.showPopupUponSelection=!!e}isPopupFeaturesFromSelection(){return this.popupFeaturesFromSelection}getSelectedFeatures(){return ii(this,void 0,void 0,function*(){const e=[],t=Object.values(this.jimuLayerViews),i=[];if(t.forEach(e=>{const t=e;if(t.getSelectedFeatures&&t.type!==y.JSAPILayerTypes.SubtypeSublayer){const e=t.getSelectedFeatures();i.push(e)}}),i.length>0){const t=yield Promise.all(i);t.length>0&&t.forEach(t=>{t&&t.length>0&&t.forEach(t=>{e.push(t)})})}return e})}getSelectedFeatureCount(){let e=0;return Object.values(this.jimuLayerViews).forEach(t=>{const i=t;i.getSelectedFeatureCount&&i.type!==y.JSAPILayerTypes.SubtypeSublayer&&(e+=i.getSelectedFeatureCount())}),e}addJimuMapTool(e){this.jimuMapTools.find(t=>t.name===e.name)||this.jimuMapTools.push(e)}deleteJimuMapTool(e){this.jimuMapTools.find(t=>t.name===e)&&(this.jimuMapTools=this.jimuMapTools.filter(t=>t.name!==e))}enableClickOpenPopup(){this.view.popupEnabled=!0}disableClickOpenPopup(){this.view.popupEnabled=!1}isClickOpenPopupEnabled(){return this.view.popupEnabled}enableClickHighlight(){this.clickHighlightEnabled=!0}disableClickHighlight(){this.clickHighlightEnabled=!1}isClickHighlightEnabled(){return this.clickHighlightEnabled}setIsActive(e){this.isActive=e,this.mapViewManager.setJimuMapView(this)}setMapWidgetState(e){this.mapWidgetState=e}isMapWidgetActive(){return this.mapWidgetState===y.WidgetState.Active}initView(e){e&&e.when(()=>{e.on("click",this.onClick.bind(this))})}onClick(e){const t={x:e.x,y:e.y},i=this.view.toMap(t);i&&this.view.hitTest(t).then(e=>{if(!this.isClickHighlightEnabled())return;const t=e.results.filter(e=>"graphic"===e.type);this.selectDataSourceOrFeatureByFeatures(this.isClickOpenPopupEnabled(),t.map(e=>e.graphic),i)},()=>{this.isClickOpenPopupEnabled()||this.clearAllJimuLayerViewsSelectRecord()})}getLayerDataSourceIdsWithSelection(){var e,t;const i=[],r=this.getAllJimuLayerViews(),s=null===(t=null===(e=this.view)||void 0===e?void 0:e.popup)||void 0===t?void 0:t.visible;return r.forEach(e=>{if(e&&e.layerDataSourceId&&e instanceof Be&&e.getSelectedFeatureCount){if(e.getSelectedFeatureCount()>0){s&&e.isPopupSelectCurrentLayerFeature()||i.push(e.layerDataSourceId)}}}),i}publishEmptySelectionChangeMessage(e){if(e.length>0){const t=y.MessageManager.getInstance(),i=new y.DataRecordsSelectionChangeMessage(this.mapWidgetId,[],e);t.publishMessage(i)}}selectDataSourceOrFeatureByFeatures(e,t,i){return ii(this,void 0,void 0,function*(){var r;const s=this.getLayerDataSourceIdsWithSelection();if(yield this.clearAllJimuLayerViewsSelectRecord(),this.publishEmptySelectionChangeMessage(s),e)return;const a=t.find(e=>{var t;const i=e.layer;return!(!i||i.type!==y.JSAPILayerTypes.FeatureLayer&&i.type!==y.JSAPILayerTypes.SceneLayer&&i.type!==y.JSAPILayerTypes.OrientedImageryLayer)&&(i.popupEnabled||(null===(t=this.forcePopupEnabledLayers)||void 0===t?void 0:t.includes(i)))});if(!a)return void this.tryIdentifyClickedFeature(i);const n=this.getJimuLayerViewIdByAPILayer(a.layer),o=this.jimuLayerViews[n];if(!o)return;const l=a.getObjectId();if("number"==typeof l){o.highlightFeatureById(l),this.mapClickCount++;const e=this.mapClickCount,t=yield o.getOrCreateLayerDataSource();let i;t&&(i=yield t.queryById(l+""));e===this.mapClickCount&&(i&&f(o,[i]),yield o.selectFeatureById(l,i))}a.layer&&(null===(r=this.forcePopupEnabledLayers)||void 0===r?void 0:r.includes(a.layer))&&this.view.openPopup({features:[a],location:i})})}isMapServiceLayerPopupEnabled(e){var t;if(e.popupEnabled){const i=null===(t=e.sublayers)||void 0===t?void 0:t.toArray();if(i&&i.length>0){return i.some(e=>e.popupEnabled)}}return!1}tryIdentifyClickedFeature(e){var t,i;let r=null;const s=this.view.map.layers.toArray().reverse(),a=Object.values(this.jimuLayerViews);for(let e=0;e<s.length;e++){const n=s[e];if(n.type===y.JSAPILayerTypes.MapImageLayer||n.type===y.JSAPILayerTypes.TileLayer){const e=n;if((null===(i=null===(t=e.capabilities)||void 0===t?void 0:t.operations)||void 0===i?void 0:i.supportsIdentify)&&this.isMapServiceLayerPopupEnabled(e)){const e=a.find(e=>e.layer===n);if(e){r=e;break}}}}if(r)return C(["esri/rest/identify","esri/rest/support/IdentifyParameters"]).then(([t,i])=>{const s=this.getAllChildJimuLayerViews(r.id).filter(e=>e.layer.popupEnabled).map(e=>e.layer.id),a=new i;a.tolerance=3,a.layerIds=s,a.layerOption="top",a.width=this.view.width,a.height=this.view.height,a.geometry=e,a.mapExtent=this.view.extent,a.returnFieldName=!0,a.returnGeometry=!0,a.returnUnformattedValues=!0,t.identify(r.layer.url,a).then(e=>ii(this,void 0,void 0,function*(){const t=e.results[0];if(!t)return;const i=`${r.id}-${t.layerId}`,s=this.jimuLayerViews[i];if(!s)return;const a=yield s.getOrCreateLayerDataSource();if(a){const e=a.buildRecord(t.feature);s.selectFeatureById(Number(e.getId()),e),f(s,[e])}else s.selectFeatureById(t.feature.attributes[s.layer.objectIdField],t.feature)}))})}getMapDataSource(){let e=null;return this.dataSourceId&&(e=y.DataSourceManager.getInstance().getDataSource(this.dataSourceId)),e}getJimuLayerViewByThisOrOtherMapAPILayer(e){let t=this.getJimuLayerViewByAPILayer(e);if(t)return t;const i=this.getAllJimuLayerViews(),r=this.getMapDataSource();if(r){const s=y.dataSourceUtils.getDataSourceIdByJSAPILayer(r,e);s&&(t=i.find(e=>e.layerDataSourceId===s))}return t}getJimuLayerViewByAPILayer(e){return Object.values(this.jimuLayerViews).find(t=>t.layer===e)}getJimuLayerViewByDataSourceId(e){const t=this.getAllJimuLayerViews();let i=t.filter(e=>!e.fromRuntime).find(t=>t.layerDataSourceId===e);if(i)return i;if(!i){i=t.filter(e=>e.fromRuntime).find(t=>t.layerDataSourceId===e)}return i}getDataSourceIdByAPILayer(e){const t=this.getJimuLayerViewByAPILayer(e);if(t)return t.layerDataSourceId;const i=this.getMapDataSource();return i?y.dataSourceUtils.getDataSourceIdByJSAPILayer(i,e):null}clearAllJimuLayerViewsSelectRecord(){return ii(this,void 0,void 0,function*(){const e=this.jimuLayerViews,t=Object.keys(e),i=[];for(let r=0;r<t.length;r++){const s=e[t[r]];if(ri.includes(s.type)&&s.selectFeaturesByIds){const e=s.selectFeaturesByIds([]);i.push(e)}}i.length>0&&(yield Promise.all(i))})}addJimuLayerView(e){this.jimuLayerViews[e.id]=e}whenJimuMapViewLoaded(){return ii(this,void 0,void 0,function*(){return this.jimuMapViewLoadPromise?this.jimuMapViewLoadPromise:this.view?(this.jimuMapViewLoadPromise=this.view.when().then(()=>ii(this,void 0,void 0,function*(){setTimeout(()=>{this.handlePersistentMapStateAfterViewReady()},500),this.startCreateJimuLayerViews(),this.createJimuTablesAndWatchTableDataSourcesInfoChange();const e=this.view.initUrlHashMapOptions,t=e&&Object.keys(e).length>0;return this.tryGoToSelectionsByUrlHash(t).then(e=>ii(this,void 0,void 0,function*(){yield y.utils.wait(10),this.isActive&&this.tryAddMarkerByUrParam(t,e)})),this.status=y.JimuMapViewStatus.Loaded,this.mapViewManager.setJimuMapView(this),Promise.resolve(this)}),e=>ii(this,void 0,void 0,function*(){return console.error(e),this.status=y.JimuMapViewStatus.Failed,this.mapViewManager.setJimuMapView(this),Promise.reject(this)})),this.jimuMapViewLoadPromise):(this.status=y.JimuMapViewStatus.Failed,this.mapViewManager.setJimuMapView(this),this.jimuMapViewLoadPromise=Promise.reject(this),this.jimuMapViewLoadPromise)})}whenJimuLayerViewLoaded(e){return ii(this,void 0,void 0,function*(){if(this.jimuLayerViewLoadPromises[e])return this.jimuLayerViewLoadPromises[e];try{yield this.makeSureParentLayerViewsLoaded(e)}catch(e){console.log(e)}return this.jimuLayerViewLoadPromises[e]?this.jimuLayerViewLoadPromises[e]:Promise.reject(Error("Bad jimuLayerViewId:"+e))})}whenJimuLayerViewLoadedByDataSource(e){return ii(this,void 0,void 0,function*(){let t="";if(e.type===y.DataSourceTypes.BuildingComponentSubLayer||e.type===y.DataSourceTypes.BuildingGroupSubLayer)t=`${this.mapWidgetId}-${e.id}`;else{const i=e.jimuLayerId;if(!i)return console.error("Can not find jimuLayerId in data source.",e.id),Promise.resolve(null);t=this.getJimuLayerViewIdByJimuLayerId(i)}return this.whenJimuLayerViewLoaded(t)})}makeSureParentLayerViewsLoaded(e){return ii(this,void 0,void 0,function*(){const t=Object.keys(this.jimuLayerViewLoadPromises).length,i=[];Object.keys(this.jimuLayerViewLoadPromises).forEach(t=>{const r=this.jimuLayerViewLoadPromises[t];r&&e.startsWith(t)&&i.push(r)}),yield Promise.all(i),Object.keys(this.jimuLayerViewLoadPromises).length>t&&(yield this.makeSureParentLayerViewsLoaded(e))})}whenAllJimuLayerViewLoaded(){return ii(this,void 0,void 0,function*(){const e={};return yield this.whenChildJimuLayerViewLoaded(null,e),e})}whenChildJimuLayerViewLoaded(e,t){return ii(this,void 0,void 0,function*(){const i=yield Promise.all(this.getChildJimuLayerViewIds(e).map(e=>this.whenJimuLayerViewLoaded(e).then(i=>(t[e]=i,i)).catch(t=>(console.error("JimuLayerView fails.",e,t),null))));yield Promise.all(i.filter(e=>e).map(e=>this.whenChildJimuLayerViewLoaded(e.id,t)))})}getAllJimuLayerViews(){let e=Object.values(this.jimuLayerViews);return e=this.sortJimuLayerViewsByLayerOrder(e),e}getParentJimuLayerViews(e){const t=[];let i=this.jimuLayerViews[e];for(;null==i?void 0:i.parentJimuLayerViewId;){const e=this.jimuLayerViews[i.parentJimuLayerViewId];e&&t.push(e),i=e}return t}getAllChildJimuLayerViews(e){const t=[];return this.findChildLayerView(e,t),t}getChildJimuLayerViews(e){const t=[];return Object.values(this.jimuLayerViews).forEach(i=>{i&&i.parentJimuLayerViewId===e&&t.push(i)}),t}getChildJimuLayerViewIds(e){return Object.keys(this.jimuLayerViews).filter(t=>this.jimuLayerViews[t].parentJimuLayerViewId===e)}findChildLayerView(e,t){const i=this.jimuLayerViews,r=Object.keys(i);for(let s=0;s<r.length;s++){if(i[r[s]].parentJimuLayerViewId===e){const e=i[r[s]];t.push(e),this.findChildLayerView(e.id,t)}}}sortJimuLayerViewsByLayerOrder(e){return v(e)}startCreateJimuLayerViews(){Object.keys(this.jimuLayerViewLoadPromises).length>0||this.view.map.layers.toArray().reverse().forEach((e,t)=>{try{this.createJimuLayerView(e,null,t)}catch(e){console.log("Create JimuLayerViews error.",e)}})}createJimuLayerView(e,t,i,r,s,a){return ii(this,void 0,void 0,function*(){var n,o,l;if("esri.layers.GraphicsLayer"===e.declaredClass)return null;const u=e.parent;u&&u[y.ExBAddedJSAPIProperties.EXB_LAYER_CREATED_BY_DATA_SOURCE]&&(e[y.ExBAddedJSAPIProperties.EXB_LAYER_CREATED_BY_DATA_SOURCE]=!0);let c=null;const d=y.DataSourceManager.getInstance(),h=d.getDataSource(this.dataSourceId),p=e.id+"",g=y.dataSourceUtils.getJimuLayerIdByJSAPILayer(e),f=this.getJimuLayerViewIdByJimuLayerId(g),m=t?this.getJimuLayerViewIdByJimuLayerId(t):null,v=m?this.jimuLayerViews[m]:null;let w,S=null;if(s){if(!e[y.ExBAddedJSAPIProperties.EXB_LAYER_CREATED_BY_DATA_SOURCE]&&"hide"===e.listMode)return null;if(a)if(e[y.ExBAddedJSAPIProperties.EXB_LAYER_CREATED_BY_DATA_SOURCE])r&&(S=r,w=r.id);else{const t=`auto-created-data-source-${Math.random().toString().slice(2)}`,i=y.dataSourceUtils.dataSourceJsonCreator.createDataSourceJsonByJSAPILayer(t,e);if(i)try{const r={id:t,dataSourceJson:i,layer:e},s=yield d.createDataSource(r);s&&(S=s,w=s.id)}catch(t){console.error("can not create data source for layer",e.title,t)}}else v&&(S=v.runtimeRootDataSource,S&&(w=y.dataSourceUtils.getDataSourceIdByJSAPILayer(S,e)))}else w=y.dataSourceUtils.getDataSourceIdByJSAPILayer(h,e);w||(w="");const L={id:f,jimuLayerId:g,layerDataSourceId:w,jimuMapViewId:this.id,parentJimuLayerViewId:m,mapViewManager:this.mapViewManager,index:i,fromRuntime:s,urlHashLayersVisibility:this.urlHashLayersVisibility};if("esri.layers.support.Sublayer"===e.declaredClass){const t=e,i=(null===(n=t.sourceJSON)||void 0===n?void 0:n.layerType)||(null===(o=t.sourceJSON)||void 0===o?void 0:o.type);i===y.SupportedLayerServiceTypes.GroupLayer?(null===(l=t.sublayers)||void 0===l?void 0:l.length)>0&&(Object.assign(L,{type:y.JSAPILayerTypes.GroupLayer,layer:t}),c=new Je(L)):i===y.SupportedLayerServiceTypes.FeatureLayer?(Object.assign(L,{type:y.JSAPILayerTypes.FeatureLayer,layer:t}),c=new Re(L)):"Raster Layer"===i?(Object.assign(L,{type:t.type,layer:t}),c=new Ae(L)):"Annotation Layer"===i?(Object.assign(L,{type:t.type,layer:t}),c=new kt(L)):"Annotation SubLayer"===i?(Object.assign(L,{type:t.type,layer:t}),c=new Gt(L)):"Mosaic Layer"===i?(Object.assign(L,{type:t.type,layer:t}),c=new Ut(L)):console.log("Unsupported sub layer type.",p)}else{const t=e;switch(t.type){case y.JSAPILayerTypes.SceneLayer:Object.assign(L,{type:t.type,layer:t}),c=new ke(L);break;case y.JSAPILayerTypes.FeatureLayer:Object.assign(L,{type:t.type,layer:t}),c=new Re(L);break;case y.JSAPILayerTypes.MapImageLayer:case y.JSAPILayerTypes.TileLayer:Object.assign(L,{type:t.type,layer:t}),t.type===y.JSAPILayerTypes.MapImageLayer&&(c=new De(L)),t.type===y.JSAPILayerTypes.TileLayer&&(c=new xe(L));break;case y.JSAPILayerTypes.GroupLayer:Object.assign(L,{view:null,type:t.type,layer:t}),c=new Je(L);break;case y.JSAPILayerTypes.SubtypeGroupLayer:Object.assign(L,{type:t.type,layer:t}),c=new $e(L);break;case y.JSAPILayerTypes.SubtypeSublayer:Object.assign(L,{type:t.type,layer:t}),c=new Xe(L);break;case y.JSAPILayerTypes.BuildingSceneLayer:Object.assign(L,{type:t.type,layer:t}),c=new We(L);break;case y.JSAPILayerTypes.BuildingGroupSublayer:Object.assign(L,{type:t.type,layer:t}),c=new He(L);break;case y.JSAPILayerTypes.BuildingComponentSublayer:Object.assign(L,{type:t.type,layer:t}),c=new _e(L);break;case y.JSAPILayerTypes.ImageryLayer:Object.assign(L,{type:t.type,layer:t}),c=new Qe(L);break;case y.JSAPILayerTypes.ImageryTileLayer:Object.assign(L,{type:t.type,layer:t}),c=new je(L);break;case y.JSAPILayerTypes.OrientedImageryLayer:Object.assign(L,{type:t.type,layer:t}),c=new Ne(L);break;case y.JSAPILayerTypes.BingMapsLayer:Object.assign(L,{type:t.type,layer:t}),c=new ze(L);break;case y.JSAPILayerTypes.CatalogLayer:Object.assign(L,{type:t.type,layer:t}),c=new Ze(L);break;case y.JSAPILayerTypes.CatalogDynamicGroupLayer:Object.assign(L,{type:t.type,layer:t}),c=new tt(L);break;case y.JSAPILayerTypes.CatalogFootprintLayer:Object.assign(L,{type:t.type,layer:t}),c=new it(L);break;case y.JSAPILayerTypes.CSVLayer:Object.assign(L,{type:t.type,layer:t}),c=new rt(L);break;case y.JSAPILayerTypes.DimensionLayer:Object.assign(L,{type:t.type,layer:t}),c=new st(L);break;case y.JSAPILayerTypes.ElevationLayer:Object.assign(L,{type:t.type,layer:t}),c=new at(L);break;case y.JSAPILayerTypes.GeoJSONLayer:Object.assign(L,{type:t.type,layer:t}),c=new nt(L);break;case y.JSAPILayerTypes.GeoRSSLayer:Object.assign(L,{type:t.type,layer:t}),c=new ot(L);break;case y.JSAPILayerTypes.IntegratedMesh3DTilesLayer:Object.assign(L,{type:t.type,layer:t}),c=new lt(L);break;case y.JSAPILayerTypes.IntegratedMeshLayer:Object.assign(L,{type:t.type,layer:t}),c=new ut(L);break;case y.JSAPILayerTypes.KMLLayer:Object.assign(L,{type:t.type,layer:t}),c=new dt(L);break;case y.JSAPILayerTypes.KnowledgeGraphLayer:Object.assign(L,{type:t.type,layer:t}),c=new gt(L);break;case y.JSAPILayerTypes.KnowledgeGraphSublayer:Object.assign(L,{type:t.type,layer:t}),c=new ft(L);break;case y.JSAPILayerTypes.LineOfSightLayer:Object.assign(L,{type:t.type,layer:t}),c=new mt(L);break;case y.JSAPILayerTypes.MapNotesLayer:Object.assign(L,{type:t.type,layer:t}),c=new St(L);break;case y.JSAPILayerTypes.MediaLayer:Object.assign(L,{type:t.type,layer:t}),c=new Lt(L);break;case y.JSAPILayerTypes.OGCFeatureLayer:Object.assign(L,{type:t.type,layer:t}),c=new bt(L);break;case y.JSAPILayerTypes.OpenStreetMapLayer:Object.assign(L,{type:t.type,layer:t}),c=new It(L);break;case y.JSAPILayerTypes.PointCloudLayer:Object.assign(L,{type:t.type,layer:t}),c=new Vt(L);break;case y.JSAPILayerTypes.RouteLayer:Object.assign(L,{type:t.type,layer:t}),c=new Mt(L);break;case y.JSAPILayerTypes.StreamLayer:Object.assign(L,{type:t.type,layer:t}),c=new Pt(L);break;case y.JSAPILayerTypes.VectorTileLayer:Object.assign(L,{type:t.type,layer:t}),c=new At(L);break;case y.JSAPILayerTypes.VideoLayer:Object.assign(L,{type:t.type,layer:t}),c=new Ct(L);break;case y.JSAPILayerTypes.ViewshedLayer:Object.assign(L,{type:t.type,layer:t}),c=new Jt(L);break;case y.JSAPILayerTypes.VoxelLayer:Object.assign(L,{type:t.type,layer:t}),c=new Ft(L);break;case y.JSAPILayerTypes.WCSLayer:Object.assign(L,{type:t.type,layer:t}),c=new Et(L);break;case y.JSAPILayerTypes.WebTileLayer:Object.assign(L,{type:t.type,layer:t}),c=new Dt(L);break;case y.JSAPILayerTypes.WFSLayer:Object.assign(L,{type:t.type,layer:t}),c=new xt(L);break;case y.JSAPILayerTypes.WMSLayer:Object.assign(L,{type:t.type,layer:t}),c=new Tt(L);break;case y.JSAPILayerTypes.WMTSLayer:Object.assign(L,{type:t.type,layer:t}),c=new Bt(L);break;default:switch(Object.assign(L,{type:t.type,layer:t}),t.declaredClass){case"esri.layers.LinkChartLayer":c=new wt(L);break;case"esri.layers.support.KMLSublayer":c=new yt(L);break;case"esri.layers.support.WMSSublayer":c=new Ot(L);break;default:c=new Ae(L)}}}return c?(s&&(c.runtimeRootDataSource=S),this.addJimuLayerView(c),this.finalLayerVisibles[c.id]=c.isLayerVisible(),this.jimuLayerViewLoadPromises[f]=this.whenLayerView(c).then(e=>(c.view=e,c.ready())).then(e=>(e.isLoaded=!0,setTimeout(()=>{this.onJimuLayerViewCreated(e)},0),e)),c):Promise.resolve(null)})}whenLayerView(e){return ii(this,void 0,void 0,function*(){var t,i;const r=e.layer;if("esri.layers.support.Sublayer"===r.declaredClass||e.type===y.JSAPILayerTypes.GroupLayer||"esri.layers.support.SubtypeSublayer"===r.declaredClass||"esri.layers.buildingSublayers.BuildingGroupSublayer"===r.declaredClass||"esri.layers.support.WMSSublayer"===r.declaredClass||"esri.layers.support.KMLSublayer"===r.declaredClass)return null;if("esri.layers.buildingSublayers.BuildingComponentSublayer"===r.declaredClass){const s=r;let a=null,n=null;if("esri.layers.BuildingSceneLayer"===(null===(t=s.layer)||void 0===t?void 0:t.declaredClass))a=s.layer;else{const t=this.getParentJimuLayerViews(e.id);for(let e=0;e<t.length;e++){const i=t[e].layer;if("esri.layers.BuildingSceneLayer"===i.declaredClass){a=i;break}}}if(a){const e=yield this.view.whenLayerView(a);(null===(i=null==e?void 0:e.sublayerViews)||void 0===i?void 0:i.length)>0&&(n=e.sublayerViews.find(e=>e.sublayer===s))}else console.error(`BuildingComponentSublayer ${e.id} can not get the related BuildingSceneLayer`);return n}return this.view.whenLayerView(r)})}onStoreChange(e,t){Object.keys(t||{}).forEach(i=>{if(t[i].instanceStatus===y.DataSourceStatus.Created&&(!(null==e?void 0:e[i])||e[i].instanceStatus!==y.DataSourceStatus.Created)){const e=y.DataSourceManager.getInstance().getDataSource(i),t=Object.keys(this.jimuLayerViews).find(t=>!this.jimuLayerViews[t].layerDataSourceId&&this.jimuLayerViews[t].jimuLayerId===(null==e?void 0:e.jimuLayerId));t&&(this.jimuLayerViews[t].layerDataSourceId=e.id)}})}getJimuTables(){return(this.jimuTableArray||[]).slice()}createJimuTablesAndWatchTableDataSourcesInfoChange(){var e,t,i,r;const s=this.getMapDataSource(),a=null===(r=null===(i=null===(t=null===(e=this.view)||void 0===e?void 0:e.map)||void 0===t?void 0:t.tables)||void 0===i?void 0:i.toArray())||void 0===r?void 0:r.reverse();a&&a.length>0&&a.forEach(e=>{const t=y.dataSourceUtils.getJimuLayerIdByJSAPILayer(e),i=this.getJimuLayerViewIdByJimuLayerId(t);this.jimuTables[i]=e;const r={jimuTableId:i,table:e};if(this.jimuTableArray.push(r),!s)return;if("esri.layers.FeatureLayer"!==e.declaredClass)return;const a=y.dataSourceUtils.getDataSourceIdByJSAPILayer(s,e);if(a){const t=(0,y.observeStore)((t,i)=>{this.onTableDataSourceInfoChange(e,a)},["dataSourcesInfo",a]);this.storeUnsubscribes.push(t)}})}onTableDataSourceInfoChange(e,t){const i=y.DataSourceManager.getInstance().getDataSource(t);if(i&&i.getRealQueryParams){const t={outFields:["*"],where:"",returnGeometry:!0},r=i.getRealQueryParams(t,"query");r&&e.definitionExpression!==r.where&&(e.definitionExpression=r.where)}}clearSelectedFeatures(){const e=this.getLayerDataSourceIdsWithSelection();this.clearAllJimuLayerViewsSelectRecord(),this.publishEmptySelectionChangeMessage(e)}selectFeaturesByGraphic(e,t,i,r){return ii(this,void 0,void 0,function*(){let s=e.geometry;if("point"===s.type||"polyline"===s.type){const e=10*this.view.resolution;s=yield y.geometryUtils.createBuffer(s,[e],"meters")}const a={geometry:s,returnGeometry:!0,outFields:[],returnZ:!0};a.spatialRelationship=t;let n=null;r&&(r.returnAllFields&&(a.outFields=["*"]),r.returnFullGeometry&&(a.returnFullGeometry=!0),r.outSR&&(a.outSR=r.outSR),"function"==typeof r.filterJimuLayerView&&(n=r.filterJimuLayerView));const o=this.jimuLayerViews,l=Object.keys(o),u=[],c={},d=e=>ii(this,void 0,void 0,function*(){const t=yield e.selectFeaturesByQuery(a,i);if(c[e.id]=t,e.type===y.JSAPILayerTypes.SubtypeGroupLayer){const t=e.getLayerDataSource();if(t){const e=t.getSelectedRecords(),i=g(t,e);Object.keys(i).forEach(e=>{const t=this.getJimuLayerViewByDataSourceId(e),r=null==t?void 0:t.id;if(r){const t=i[e].map(e=>e.feature);c[r]=t}})}}});for(let e=0;e<l.length;e++){const t=o[l[e]];if(ri.includes(t.type)&&t.selectFeaturesByQuery){if(n&&n(t)||!n){const e=d(t);u.push(e)}}}return this.onSelectByQueryProgressChange(),yield Promise.all(u),c})}cancelSelectByQuery(e){return ii(this,void 0,void 0,function*(){const t=this.jimuLayerViews,i=Object.keys(t),r=[];for(let s=0;s<i.length;s++){const a=t[i[s]];if(ri.includes(a.type)&&a.cancelSelectByQuery){const t=a.cancelSelectByQuery(e);r.push(t)}}yield Promise.all(r)})}getSelectByQueryProgress(){const e=[],t=this.jimuLayerViews,i=Object.keys(t);for(let r=0;r<i.length;r++){const s=t[i[r]];if(ri.includes(s.type)&&s.getSelectQueryProgress){const t=s.getSelectQueryProgress();e.push(t)}}if(0===e.length)return 1;{let t=e.reduce((e,t)=>e+t);return t/=e.length,t=Math.max(0,Math.min(t,1)),t}}destroy(){var e,t;this.cacheListeners=[],this.restoreListeners=[],this.selectedFeaturesChangeListeners=[],this.jimuLayerViewCreatedListeners=[],this.jimuLayerViewRemovedListeners=[],this.jimuLayerViewsVisibleChangedListeners=[],this.selectByQueryProgressChangeListeners=[],this.forcePopupEnabledLayers=[],(null===(e=this.watchHandles)||void 0===e?void 0:e.length)>0&&(this.watchHandles.forEach(e=>{e&&e.remove()}),this.watchHandles=[]),this.releaseWatchLayerChangeHandles(),this.watchPopupHandle&&(this.watchPopupHandle.remove(),this.watchPopupHandle=null),this.watchPopupActionHandle&&(this.watchPopupActionHandle.remove(),this.watchPopupActionHandle=null),this.watchPopupFeaturesHandle&&(this.watchPopupFeaturesHandle.remove(),this.watchPopupFeaturesHandle=null),this.watchPopupSelectedHandle&&(this.watchPopupSelectedHandle.remove(),this.watchPopupSelectedHandle=null),(null===(t=this.storeUnsubscribes)||void 0===t?void 0:t.length)>0&&this.storeUnsubscribes.forEach(e=>{e()}),this.storeUnsubscribes=[];const i=this.id,r=y.MutableStoreManager.getInstance().getStateValue([this.mapWidgetId])||{},s=r.addToMapDatas,a=r.showOnMapDatas;if(s){Object.keys(s).forEach(e=>{const t=s[e];t&&t.mapWidgetId===this.mapWidgetId&&t.jimuMapViewId===i&&delete s[e]})}if(a){Object.keys(a).forEach(e=>{const t=a[e];t&&t.mapWidgetId===this.mapWidgetId&&t.jimuMapViewId===i&&delete a[e]})}const n=this.jimuLayerViews,o=Object.keys(n);for(let e=0;e<o.length;e++){n[o[e]].destroy()}this.view&&(this.view.destroyed||(this.view.graphics&&this.view.graphics.destroyed&&this.view.graphics.destroy(),this.view.container=null,this.view.allLayerViews&&this.view.allLayerViews.destroyed&&this.view.allLayerViews.destroy(),this.view.layerViews&&this.view.layerViews.destroyed&&this.view.layerViews.destroy(),this.jimuMapTools=[],this.view.destroy(),this.view=null))}_getDefaultJimuMapViewId(){const e=(0,y.getAppStore)().getState().jimuMapViewsInfo;return Object.keys(e||{}).find(t=>e[t].mapWidgetId===this.mapWidgetId)}handleShowOnMapAction(e){const t=[];Object.entries(e).forEach(e=>{const i=e[0],r=e[1]||null;let s=r.jimuMapViewId;if(s||r.mapWidgetId!==this.mapWidgetId||(s=this._getDefaultJimuMapViewId()),s===this.id){let e=null;const s=this.showOnMapDatas[i]||null;if(r&&r===s)return;this.showOnMapDatas[i]=r,e=s?this.tryUpdateFeatureLayerForShowOnMapAction(i,r,s):this.createFeatureLayerForShowOnMapAction(i,r,null),r.type===Kt.DataAction&&t.push(e)}}),Object.entries(this.showOnMapDatas).forEach(t=>{const i=t[0];if(!e[i]){const e=this.view.map.findLayerById(i);delete this.showOnMapDatas[i],e&&this.view.map.remove(e)}}),t.length>0&&Promise.all(t).then(e=>{const t=e.flat();t.length>0&&E(this.view,t,{padding:{left:50,right:50,top:50,bottom:50}})})}createFeatureLayerForShowOnMapAction(e,t,i){return ii(this,void 0,void 0,function*(){var r,s,a,n,o;let l=[];try{const{dataSet:u,title:c,symbolOption:d}=t,h=yield C(["esri/symbols/support/jsonUtils","esri/symbols/support/symbolUtils","esri/renderers/support/jsonUtils","esri/renderers/UniqueValueRenderer"]),[p,g,f,m]=h,v=u.dataSource;let w=u.records||[];w=w.filter(e=>e&&e.getGeometry());const S=v.getIdField(),L=yield se(u);(null===(r=null==L?void 0:L.features)||void 0===r?void 0:r.length)>0&&(l=L.features.filter(e=>!!e.geometry));let b=null,I=null;if(w.length>0){const J=w[0].getFeature();J&&(b=J.layer||J.sourceLayer)}b&&b.renderer&&"function"==typeof(null===(s=b.renderer)||void 0===s?void 0:s.clone)&&(I=null===(a=b.renderer)||void 0===a?void 0:a.clone());let M=!0;if(t.type===Kt.DataAction)M=!0;else if(t.type===Kt.MessageAction){M=!!this.getJimuLayerViewByDataSourceId(v.id)}let P=null,A=null;if(M){const F=(0,y.uuidv1)(),E=null===(n=v.getSchema())||void 0===n?void 0:n.asMutable({deep:!0}),D={id:`${this.mapWidgetId}_show_on_map_${F}`,type:y.DataSourceTypes.FeatureLayer,label:c||v.getLabel(),isOutputFromWidget:!0,originDataSources:null,url:null,itemId:null,portalUrl:null,schema:E,geometryType:v.getGeometryType()},x=y.DataSourceManager.getInstance(),j=yield x.createDataSource((0,y.Immutable)(D));let T=yield y.dataSourceUtils.changeJimuRecordsToJSAPIGraphics(w);T||(T=[]),T=T.filter(e=>!!e);const O=yield V(this.view,v,T);(null==O?void 0:O.features)&&(T=O.features),yield j.setSourceFeatures(T),j.setStatus(y.DataSourceStatus.Unloaded),j.setCountStatus(y.DataSourceStatus.Unloaded),P=j,A=j.layer}else{P=v;const B=this.view;function R(e){return ii(this,void 0,void 0,function*(){var t,i,r;if(e){let s=e.source;if(Array.isArray(s)&&s.length>0&&"esri.Graphic"===s[0].declaredClass){const a=yield V(B,v,s);if(a&&a.features&&(s=a.features,a.features.length>0&&a.spatialReferenceChanged)){const s=null===(r=null===(i=null===(t=a.features[0])||void 0===t?void 0:t.geometry)||void 0===i?void 0:i.spatialReference)||void 0===r?void 0:r.clone();s&&(e.spatialReference=s)}e.source=s}}return e})}const k=yield y.dataSourceUtils.createJSAPIFeatureLayerByRecords(P,w,void 0,void 0,R);A=null==k?void 0:k.layer}if(A){if(A[y.ExBAddedJSAPIProperties.EXB_DATA_SOURCE]=P,A[y.ExBAddedJSAPIProperties.EXB_DATA_SET]=u,A[y.ExBAddedJSAPIProperties.EXB_LAYER_VIEW_IGNORE_SPATIAL_FILTER]=!0,A.id=e,!A.geometryType&&w.length>0){const q=w[0],$=null===(o=null==q?void 0:q.feature)||void 0===o?void 0:o.geometry;if($&&$.declaredClass){let Y=$.type;Y&&("extent"===Y&&(Y="polygon"),A.geometryType=Y)}}c&&(A.title=c);const G=A.fields;G&&G.forEach(e=>{e.editable=!1}),t.isOperationalLayer?(A.listMode="show",A.legendEnabled=!0,A.popupEnabled=!0):(A.listMode="hide",A.legendEnabled=!1,A.popupEnabled=!1),A.editingEnabled=!0;const W=yield A.queryObjectIds({where:"1=1"}),U={};W.forEach(e=>{U[e]=!0});const H=w.filter(e=>{const t=e.getId();return t&&!U[t]});if(H.length>0){let X=yield y.dataSourceUtils.changeJimuRecordsToJSAPIGraphics(H);X||(X=[]),X=X.filter(e=>!!e),yield A.applyEdits({addFeatures:X})}const _=A.geometryType;let Q;if("point"===_||"polyline"===_||"polygon"===_?Q=_:"multipoint"===_&&(Q="point"),!Q)throw new Error(`invalid geometry type ${_}`);let N=null;d?N=yield function(e,t,i){return qt(this,void 0,void 0,function*(){let r=null,s=null;return t&&(t.pointSymbol&&"point"===i?s=e.fromJSON(t.pointSymbol):t.polylineSymbol&&"polyline"===i?s=e.fromJSON(t.polylineSymbol):t.polygonSymbol&&"polygon"===i&&(s=e.fromJSON(t.polygonSymbol))),s&&(r=yield $t(s)),r})}(p,d,Q):void 0===d?N=yield Yt(p,Q):null===d&&I&&(N=yield zt(v,b,I,this.view,L,S,Q,g,p,f,m)),N||(N=yield Yt(p,Q)),i?(A.renderer=i,A[y.ExBAddedJSAPIProperties.EXB_PREDEFINED_RENDERER]=N):A.renderer=N;this.showOnMapDatas[e]===t?yield this.addLayerAndCreateJimuLayerView(A,P):console.warn("showOnMapData is not fresh, don't create layer for it")}}catch(z){console.warn("drawDataRecordSet error",z),l=[]}return l||(l=[]),l})}tryUpdateFeatureLayerForShowOnMapAction(e,t,i){return ii(this,void 0,void 0,function*(){let r=[];if(t!==i){let i=null;const s=this.view.map.findLayerById(e);if(s){const e=this.getJimuLayerViewByAPILayer(s);s[y.ExBAddedJSAPIProperties.EXB_PREDEFINED_RENDERER]&&(i=s.renderer),e?this.removeJimuLayerView(e):this.view.map.remove(s)}r=yield this.createFeatureLayerForShowOnMapAction(e,t,i)}return r})}addMarkers(e){return ii(this,void 0,void 0,function*(){const t=this.view,i=null==t?void 0:t.map;if(!i)return;if(e||(e=[]),0===(e=e.filter(e=>{var t;return(null===(t=null==e?void 0:e.graphics)||void 0===t?void 0:t.length)>0})).length)return;const r=y.i18n.getIntl(),s=r.formatMessage({id:"remove",defaultMessage:ti.defaultMessages.remove}),a="3d"===(null==t?void 0:t.type),[n,o,l]=yield C(["esri/layers/GraphicsLayer","esri/Graphic","esri/symbols/TextSymbol"]),u=[],c=[];e.forEach(e=>{const{symbol:t,graphics:i}=e;i.forEach(e=>{var i,r;e.symbol=t,e.attributes||(e.attributes={});const n=e.attributes,d=e.geometry;if(n&&d)if("point"===d.type)n.x=d.x,n.y=d.y;else if("multipoint"===d.type){const e=d.getPoint(0);e&&(n.x=e.x,n.y=e.y)}e.popupTemplate={title:"{title}",content:[{type:"fields",fieldInfos:[{fieldName:"x",label:"x",format:{digitSeparator:!1,places:6}},{fieldName:"y",label:"y",format:{digitSeparator:!1,places:6}}]}],actions:[{type:"button",title:s,id:"remove-marker",className:"esri-icon-trash"}]},u.push(e);const h=null===(i=e.attributes)||void 0===i?void 0:i.label;if(h){const t=null===(r=e.geometry)||void 0===r?void 0:r.clone();if(t){let i=h;a&&(i="            "+h);const r=new l({text:i,color:"black",haloColor:"white",haloSize:"1px",xoffset:0,yoffset:-20,font:{size:10,style:"normal",weight:"normal",family:"Arial, Helvetica, sans-serif"}}),s=new o({geometry:t,symbol:r});e.__exbMarkerLabelGraphic=s,c.push(s)}}})});const d=u.concat(c);if(0!==d.length){if(!this.markerLayer){let e=r.formatMessage({id:"marker",defaultMessage:ti.defaultMessages.marker});e||(e=ti.defaultMessages.marker||""),this.markerLayer=new n({id:y.CONSTANTS.ADD_MARKER_LAYER_ID,title:e,elevationInfo:{mode:"relative-to-scene",offset:0,unit:"meters"}}),i.add(this.markerLayer)}this.markerLayer.__exbMarkerGroups||(this.markerLayer.__exbMarkerGroups=[]),this.markerLayer.__exbMarkerGroups.push(...e),this.markerLayer.addMany(d)}})}removeMarker(e){var t,i,r;if(!(null===(t=this.view)||void 0===t?void 0:t.map))return;if(!e||!this.markerLayer)return;const s=[e],a=e.__exbMarkerLabelGraphic;a&&s.push(a),this.markerLayer.removeMany(s),(null===(i=this.markerLayer.__exbMarkerGroups)||void 0===i?void 0:i.length)>0&&(this.markerLayer.__exbMarkerGroups.forEach(t=>{const i=t.graphics;if((null==i?void 0:i.length)>0){const t=i.indexOf(e);t>=0&&i.splice(t,1)}}),this.markerLayer.__exbMarkerGroups=this.markerLayer.__exbMarkerGroups.filter(e=>{var t;return(null===(t=null==e?void 0:e.graphics)||void 0===t?void 0:t.length)>0}));(null===(r=this.markerLayer.graphics)||void 0===r?void 0:r.length)>0||this.removeMarkerLayer()}removeMarkerLayer(){var e,t,i;const r=null===(e=this.view)||void 0===e?void 0:e.map;if(r&&this.markerLayer){const e=null===(i=null===(t=this.view)||void 0===t?void 0:t.popup)||void 0===i?void 0:i.selectedFeature;e&&e.layer===this.markerLayer&&this.closePopup(),r.remove(this.markerLayer),this.markerLayer=null}}updateMarkerUrlParamIfActive(){var e;if(!this.isActive)return;const t=[],i=null===(e=this.markerLayer)||void 0===e?void 0:e.__exbMarkerGroups;(null==i?void 0:i.length)>0&&i.forEach(e=>{var i;if(e){const{configSymbolJson:r,graphics:s}=e;if(s.length>0){const e=[];if(s.forEach(t=>{var i;const r=[],s=t.geometry;if("point"===s.type?(r.push(s.x),r.push(s.y)):"multipoint"===s.type&&(null===(i=s.points)||void 0===i||i.forEach(e=>{e&&(r.push(e[0]),r.push(e[1]))})),r.length>0){const i={coordinates:r},s=t.attributes;if(s){const e=s.title,t=s.label;e&&(i.title=e),t&&(i.label=t)}e.push(i)}}),e.length>0){const a=s[0],n=null===(i=null==a?void 0:a.geometry)||void 0===i?void 0:i.spatialReference,o={wkid:"number"==typeof(null==n?void 0:n.wkid)?null==n?void 0:n.wkid:null==n?void 0:n.wkt,points:e};r&&(o.symbol=r),t.push(o)}}}});let r=null;if(0===t.length)r=null;else if(1===t.length&&1===t[0].points.length){const s=t[0],{symbol:a,wkid:n,points:o}=s,l=o[0],u=l.coordinates.join(",");let c="";"number"==typeof n?c=String(n):"string"==typeof n&&(c=encodeURIComponent(n));function d(e){for(;e.length>0&&!e[e.length-1];)e.pop();return e}r=d([u,c,encodeURIComponent(l.title||""),encodeURIComponent(l.label||""),a?encodeURIComponent(JSON.stringify(a)):""]).join(";")}else r=JSON.stringify(t);y.UrlManager.getInstance().setWidgetUrlParams(this.mapWidgetId,{marker:r})}handleAddToMapAction(e){Object.entries(e).forEach(t=>{const i=t[0],r=t[1];let s=r.jimuMapViewId;if(s||r.mapWidgetId!==this.mapWidgetId||(s=this._getDefaultJimuMapViewId()),s===this.id&&r.dataChangeType===Zt.Create){if(r.dataChangeType===Zt.Create){r.dataChangeType=Zt.Creating;const e=i;this.addLayerToMap(r.dataSourceId,i).then(()=>{const t=y.MutableStoreManager.getInstance().getStateValue([this.mapWidgetId,"addToMapDatas",`${e}`]);y.MutableStoreManager.getInstance().updateStateValue(this.mapWidgetId,`addToMapDatas.${e}`,Object.assign(Object.assign({},t),{dataChangeType:Zt.Created,dataChangeStatus:ei.Fulfilled}))}).catch(t=>{y.MutableStoreManager.getInstance().updateStateValue(this.mapWidgetId,`addToMapDatas.${e}.dataChangeStatus`,ei.Rejected),setTimeout(()=>{y.MutableStoreManager.getInstance().updateStateValue(this.mapWidgetId,`addToMapDatas.${e}.dataChangeStatus`,ei.RejectedAndKnown)},3e3)})}}else s===this.id&&r.dataChangeType===Zt.Remove&&(this.removeLayerFromMap(i),delete e[i])})}addLayerToMap(e,t){return ii(this,void 0,void 0,function*(){const i=y.DataSourceManager.getInstance().getDataSource(e);if(!i)throw new Error(`can't get data source for ${e}`);const r=yield null==i?void 0:i.createJSAPILayerByDataSource();if(!r)throw new Error(`data source ${e} can't create layer`);r.id=t;return yield this.addLayerAndCreateJimuLayerView(r,i)})}addLayerAndCreateJimuLayerView(e,t){return ii(this,void 0,void 0,function*(){e[y.ExBAddedJSAPIProperties.EXB_LAYER_FROM_RUNTIME]=!0,e[y.ExBAddedJSAPIProperties.EXB_LAYER_CREATED_BY_DATA_SOURCE]=!0,this.view.map.add(e);const i=this.getNewMinLayerIndexOfRootLayers();return yield this.createJimuLayerView(e,null,i,t,!0,!0)})}getNewMinLayerIndexOfRootLayers(){let e=null;return Object.values(this.jimuLayerViews).forEach(t=>{t&&!t.parentJimuLayerViewId&&(e="number"==typeof e?Math.min(e,t.index):t.index)}),"number"==typeof e?e-1:0}removeJimuLayerView(e){if(!e)return;if(e.getJimuMapView()===this&&this.jimuLayerViews[e.id]===e&&e.fromRuntime){const t=this.getChildJimuLayerViewIds(e.id).map(e=>this.jimuLayerViews[e]);delete this.jimuLayerViews[e.id],this.jimuLayerViewLoadPromises&&delete this.jimuLayerViewLoadPromises[e.id];const i=e.layer;if(this.onJimuLayerViewRemoved(e),i){const e=this.view.map;e.layers.toArray().includes(i)&&e.remove(i)}e.destroy(),t.forEach(e=>{this.removeJimuLayerView(e)})}}removeLayerFromMap(e){console.warn("jimuMapView.removeLayerFromMap() is deprecated, please use jimuMapView.removeJimuLayerView() instead.");const t=this.view.map.findLayerById(e);t&&this.view.map.remove(t)}parseLayersVisibilityFromUrlHash(){var e;let t=null;try{const i=null===(e=this.view)||void 0===e?void 0:e.runtimeUrlHashParams;if(i&&i.layer_visibility){const e=JSON.parse(i.layer_visibility);if(e){const i=e[this.id];i&&"object"==typeof i&&(t=i)}}}catch(e){t=null,console.error("parse layers visibility from url hash error",e)}return t}getCurrentLayersVisibilityForUrlHash(){const e={};return Object.values(this.jimuLayerViews).forEach(t=>{t.layer&&!t.fromRuntime&&t.layer.visible!==t.originalLayerVisible&&(e[t.id]=t.layer.visible)}),e}updateUrlHashLayerVisibility(){const e=this.getMapWidgetUnParsedUrlHashLayersVisibility();y.UrlManager.getInstance().setWidgetUrlParams(this.mapWidgetId,{layer_visibility:e})}getMapWidgetUnParsedUrlHashLayersVisibility(){const e={};this.getJimuMapViewsOfMapWidget().forEach(t=>{const i=t.id;e[i]=t.getCurrentLayersVisibilityForUrlHash()}),Object.keys(e).forEach(t=>{const i=e[t];i&&0!==Object.keys(i).length||delete e[t]});let t=null;return Object.keys(e).length>0&&(t=JSON.stringify(e)),t}getJimuMapViewsOfMapWidget(){const e=[this];if(this.jimuMapViewGroup){this.jimuMapViewGroup.getAllJimuMapViews().forEach(t=>{t!==this&&e.push(t)})}return e}updatePersistentMapState(e,t){return ii(this,void 0,void 0,function*(){var i,r,s;if(this.ignoreUpdatePersistentMapState)return;if(null===(i=window.jimuConfig)||void 0===i?void 0:i.isInBuilder)return;if(!e&&!t)return;const a=y.AppStateManager.getInstance(),n=this.getJimuMapViewsOfMapWidget().find(e=>e.isActive),o=(null==n?void 0:n.dataSourceId)||"",l=(null===(s=null===(r=null==n?void 0:n.view)||void 0===r?void 0:r.viewpoint)||void 0===s?void 0:s.toJSON())||null,u=l?JSON.stringify(l):null,c=this.getMapWidgetUnParsedUrlHashLayersVisibility();let d=null;try{d=yield a.getLocalState(this.mapWidgetId)}catch(e){d=null}const h={center:null,scale:null,level:null,rotation:null,layer_visibility:c};e?(h.active_datasource_id=o,h.viewpoint=u):(h.active_datasource_id=(null==d?void 0:d.active_datasource_id)||null,h.viewpoint=(null==d?void 0:d.viewpoint)||null),yield a.putLocalState(this.mapWidgetId,h)})}isPersistentViewpointUsed(){var e;const t=y.AppStateManager.getInstance(),i=t.isLocalStateRestored(),r=t.getLastLocalState(this.mapWidgetId),s=i&&(null==r?void 0:r.viewpoint);return(null===(e=this.view)||void 0===e?void 0:e.isPersistentMapStateUsed)||!!s}handlePersistentMapStateAfterViewReady(){if(!this.view||this.isDestroyed())return;if(this.view.isPersistentMapStateUsed)return;const e=y.AppStateManager.getInstance(),t=()=>ii(this,void 0,void 0,function*(){if(this.view&&!this.isDestroyed()){const t=e.isLocalStateRestored(),i=e.getLastLocalState(this.mapWidgetId);if(t&&i){this.view.isPersistentMapStateUsed=!0;let e=null;const t=i.active_datasource_id;let r=null;try{const t=i.layer_visibility;if(t){const i=JSON.parse(t);i&&(e=i[this.id])}}catch(e){}try{const e=i.viewpoint;if(e){const t=JSON.parse(e);if(t){r=(yield(0,y.loadArcGISJSAPIModule)("esri/Viewpoint")).fromJSON(t)}}}catch(e){}this.ignoreUpdatePersistentMapState=!0;try{if(this.urlHashLayersVisibility=e,e){this.getAllJimuLayerViews().forEach(t=>{t.updateUrlHashLayersVisibility(e)})}if(t&&this.dataSourceId===t&&!this.isActive){const e=Nt.getInstance().getJimuMapViewGroup(this.mapWidgetId);e&&(yield e.switchMap(!0))}r&&this.view&&!this.isDestroyed()&&(yield this.view.goTo(r),this.publishExtentChangeMessageAfterViewpointChangedBySelf()),yield y.utils.wait(1e3)}catch(e){}this.ignoreUpdatePersistentMapState=!1}}});e.isLocalStateRestored()?t():e.registerRestoreFunction(()=>{t()})}tryGoToSelectionsByUrlHash(e){return ii(this,void 0,void 0,function*(){var t,i,r;if(!this.view)return!1;const s=this.view;if(e||this.isPersistentViewpointUsed())return!1;yield this.whenJimuMapViewLoaded();const a=y.UrlManager.getInstance(),n=a.getQueryObject(),o=a.getHashObject(),l=(0,y.getAppStore)().getState(),u=null===(r=null===(i=null===(t=null==l?void 0:l.appConfig)||void 0===t?void 0:t.urlParams)||void 0===i?void 0:i.general)||void 0===r?void 0:r.dataSelection,c=u&&u.isEnable&&u.zoomToSelection,d="true"===(null==o?void 0:o.zoom_to_selection)||c,h=y.urlUtils.getDataSourceInfosFromUrlParams(n,o),p=this.getMapDataSource(),g=[];if(h&&p&&Object.keys(h).forEach(e=>{if(e.startsWith(`${this.dataSourceId}-`)){const t=h[e];if(t){const i=t.selection;if(i){let t=null;if(Array.isArray(i))i.length>0&&(t={objectIds:i});else{const e=i.ids;Array.isArray(e)&&e.length>0?t={objectIds:e}:i.queryParams&&(t=i.queryParams)}if(t){t.disableClientQuery=!0;const i=this.queryExtentByDataSource(p,e,t);g.push(i)}}}}}),g.length>0){const e=(yield Promise.all(g)).filter(e=>!!e);if(e.length>0){const t=yield this.unionExtents(e);if(t&&!this.isPersistentViewpointUsed()){const e=t.center;if(d||!d&&e){if(s.extentChangeRelatedWidgetIds=[],s.receiveMessageTimeOfLastViewUpdate=Date.now(),d){const e={padding:{left:50,right:50,top:50,bottom:50}},[i,r]=yield C(["esri/geometry/Polygon","esri/Graphic"]),s=new r({geometry:i.fromExtent(t)});yield E(this.view,[s],e)}else e&&(yield this.view.goTo(e,{animate:!1}));return this.publishExtentChangeMessageAfterViewpointChangedBySelf(),!0}}}}return!1})}publishExtentChangeMessageAfterViewpointChangedBySelf(){const e=this.view;if(e&&e.publishExtentChangeMessage){e.extentChangeRelatedWidgetIds=[],e.receiveMessageTimeOfLastViewUpdate=Date.now();const t=!0,i=!0;e.publishExtentChangeMessage(t,i)}}queryExtentByDataSource(e,t,i){return ii(this,void 0,void 0,function*(){var r,s,a;let n=null;try{const o=yield e.createDataSourceById(t);let l=!1,u=null;(null===(r=i.objectIds)||void 0===r?void 0:r.length)>0&&(l=1===(null===(s=i.objectIds)||void 0===s?void 0:s.length),u=i.objectIds[0]);try{const e=yield o.queryExtent(i);if(e){const t=e.extent;if(t)if("esri.geometry.Extent"===t.declaredClass)n=t;else{n=(yield(0,y.loadArcGISJSAPIModule)("esri/geometry/Extent")).fromJSON(t)}try{if("number"==typeof e.count&&!l&&(l=1===e.count,l&&null==u)){const e=Object.assign({},i),t=yield o.queryIds(e);t&&1===(null===(a=t.ids)||void 0===a?void 0:a.length)&&(u=t.ids[0])}}catch(e){console.error("ds.queryIds() error",e)}}}catch(e){n=null,console.warn(`ds.queryExtent() error for ${o.id}`,e)}if((!n||l)&&null!=u){const e=yield o.queryById(u,[]),t=null==e?void 0:e.feature;if(t){let e=null;if("esri.Graphic"===t.declaredClass)e=t;else{e=new(yield(0,y.loadArcGISJSAPIModule)("esri/Graphic"))({geometry:t.geometry,attributes:t.attributes})}const i=null==e?void 0:e.geometry;if(i&&(n=i.extent,!n&&"esri.geometry.Point"===i.declaredClass)){const e=i;if("number"==typeof e.x&&"number"==typeof e.y){n=new(yield(0,y.loadArcGISJSAPIModule)("esri/geometry/Extent"))({xmin:e.x,xmax:e.x,ymin:e.y,ymax:e.y,spatialReference:e.spatialReference})}}}}}catch(e){console.error("dataSourceQueryExtent error",e),n=null}return n})}unionExtents(e){return ii(this,void 0,void 0,function*(){if(0===e.length)return null;const t=e.map(e=>ii(this,void 0,void 0,function*(){let t=null;try{const i=yield y.geometryUtils.projectToSpatialReference([e],this.view.spatialReference);i&&i.length>0&&(t=i[0])}catch(e){console.error("projectToSpatialReference error",e),t=null}return t}));let i=yield Promise.all(t);i=i.filter(e=>!!e);let r=null;return i&&i.length>0&&i.forEach(e=>{r?r.union(e):r=e.clone()}),r})}tryAddMarkerByUrParam(e,t){return ii(this,void 0,void 0,function*(){var i,r;if(!this.view)return;if(!this.isActive)return;yield this.whenJimuMapViewLoaded();const s=this.view;if(s.parseMarkerGroupUrlParam){const a=yield s.parseMarkerGroupUrlParam();if((null==a?void 0:a.length)>0){const s=null===(i=a[0])||void 0===i?void 0:i.graphics,n=null===(r=null==s?void 0:s[0])||void 0===r?void 0:r.geometry,o=1===a.length&&1===(null==s?void 0:s.length)&&"point"===(null==n?void 0:n.type);if(this.addMarkers(a),e||t||this.isPersistentViewpointUsed())return;if(o)return yield this.view.goTo(n),void this.publishExtentChangeMessageAfterViewpointChangedBySelf();const l=a.map(e=>this.queryExtentForMarkerGroup(e)),u=(yield Promise.all(l)).filter(e=>!!e);if(u.length>0){const e=yield this.unionExtents(u);if(e){const[t,i]=yield C(["esri/geometry/Polygon","esri/Graphic"]);if(this.isPersistentViewpointUsed())return;const r=new i({geometry:t.fromExtent(e)}),s={padding:{left:50,right:50,top:50,bottom:50}};yield E(this.view,[r],s),this.publishExtentChangeMessageAfterViewpointChangedBySelf()}}}}})}queryExtentForMarkerGroup(e){return ii(this,void 0,void 0,function*(){var t;const i=[];if((null===(t=null==e?void 0:e.graphics)||void 0===t?void 0:t.length)>0&&(null==e||e.graphics.forEach(e=>{const t=null==e?void 0:e.geometry;t&&("point"!==t.type&&"multipoint"!==t.type||i.push(t))})),0===i.length)return null;const r=yield(0,y.loadArcGISJSAPIModule)("esri/geometry/Extent"),s=i[0].spatialReference;let a=1/0,n=1/0,o=-1/0,l=-1/0;const u=(e,t)=>{a=Math.min(a,e),n=Math.min(n,t),o=Math.max(o,e),l=Math.max(l,t)};for(const e of i)if("point"===e.type)u(e.x,e.y);else if("multipoint"===e.type&&Array.isArray(e.points))for(const t of e.points)u(t[0],t[1]);return new r({xmin:a,ymin:n,xmax:o,ymax:l,spatialReference:s})})}isDestroyed(){return!this.view||this.view.destroyed}isCached(){var e;const t=null===(e=this.view)||void 0===e?void 0:e.container;return t&&!document.body.contains(t)}addCacheListener(e){this.cacheListeners.includes(e)||this.cacheListeners.push(e)}removeCacheListener(e){const t=this.cacheListeners.indexOf(e);t>=0&&this.cacheListeners.splice(t,1)}onCache(){this.cacheListeners.forEach(e=>{try{e(this)}catch(t){console.error("JimuMapView onCache listener error",this.id,e,t)}})}addRestoreListener(e){this.restoreListeners.includes(e)||this.restoreListeners.push(e)}removeRestoreListener(e){const t=this.restoreListeners.indexOf(e);t>=0&&this.restoreListeners.splice(t,1)}onRestore(){this.restoreListeners.forEach(e=>{try{e(this)}catch(t){console.error("JimuMapView onRestore listener error",this.id,e,t)}})}addJimuLayerViewSelectedFeaturesChangeListener(e){this.selectedFeaturesChangeListeners.includes(e)||this.selectedFeaturesChangeListeners.push(e)}removeJimuLayerViewSelectedFeaturesChangeListener(e){const t=this.selectedFeaturesChangeListeners.indexOf(e);t>=0&&this.selectedFeaturesChangeListeners.splice(t,1)}onJimuLayerViewSelectedFeaturesChange(e,t){return ii(this,void 0,void 0,function*(){this.selectedFeaturesChangeListeners.forEach(t=>{try{t(e)}catch(e){console.error("onJimuLayerViewSelectedFeaturesChange listener error",this.id,t,e)}}),yield this.handlePopupOnSelectionChange(e,t)})}addSelectByQueryProgressChangeListener(e){this.selectByQueryProgressChangeListeners.includes(e)||this.selectByQueryProgressChangeListeners.push(e)}removeSelectByQueryProgressChangeListener(e){const t=this.selectByQueryProgressChangeListeners.indexOf(e);t>=0&&this.selectByQueryProgressChangeListeners.splice(t,1)}onSelectByQueryProgressChange(){const e=this.getSelectByQueryProgress();this.selectByQueryProgressChangeListeners.forEach(t=>{try{t(e)}catch(e){console.error("onSelectByQueryProgressChange listener error",this.id,t,e)}})}addJimuLayerViewCreatedListener(e){this.jimuLayerViewCreatedListeners.includes(e)||this.jimuLayerViewCreatedListeners.push(e)}removeJimuLayerViewCreatedListener(e){const t=this.jimuLayerViewCreatedListeners.indexOf(e);t>=0&&this.jimuLayerViewCreatedListeners.splice(t,1)}onJimuLayerViewCreated(e){this.jimuLayerViewCreatedListeners.forEach(t=>{try{t(e)}catch(e){console.error("onJimuLayerViewCreated listener error",this.id,t,e)}})}addJimuLayerViewRemovedListener(e){this.jimuLayerViewRemovedListeners.includes(e)||this.jimuLayerViewRemovedListeners.push(e)}removeJimuLayerViewRemovedListener(e){const t=this.jimuLayerViewRemovedListeners.indexOf(e);t>=0&&this.jimuLayerViewRemovedListeners.splice(t,1)}onJimuLayerViewRemoved(e){this.jimuLayerViewRemovedListeners.forEach(t=>{try{t(e)}catch(e){console.error("onJimuLayerViewRemoved listener error",this.id,t,e)}})}addJimuLayerViewsVisibleChangeListener(e){this.jimuLayerViewsVisibleChangedListeners.includes(e)||this.jimuLayerViewsVisibleChangedListeners.push(e)}removeJimuLayerViewsVisibleChangeListener(e){const t=this.jimuLayerViewsVisibleChangedListeners.indexOf(e);t>=0&&this.jimuLayerViewsVisibleChangedListeners.splice(t,1)}onJimuLayerViewSelfVisibleChange(e){const t=[e,...this.getAllChildJimuLayerViews(e.id)].filter(e=>{const t=e.id,i=this.finalLayerVisibles[t],r=e.isLayerVisible();return this.finalLayerVisibles[t]=r,i!==r});t.length>0&&this.jimuLayerViewsVisibleChangedListeners.forEach(e=>{try{e(t.slice())}catch(e){console.error("onJimuLayerViewSelfVisibleChange listener error",e)}})}watch(e,t,i){return ii(this,void 0,void 0,function*(){const r=(yield(0,y.loadArcGISJSAPIModule)("esri/core/reactiveUtils")).watch(e,t,i);return this.watchHandles.push(r),r})}enableLayerPopup(e,t){e&&(e.popupEnabled=!0,t&&(this.forcePopupEnabledLayers||(this.forcePopupEnabledLayers=[]),this.forcePopupEnabledLayers.includes(e)||this.forcePopupEnabledLayers.push(e)))}disableLayerPopup(e){var t,i;if(!e)return;e.popupEnabled=!1,(null===(t=this.forcePopupEnabledLayers)||void 0===t?void 0:t.includes(e))&&(this.forcePopupEnabledLayers=this.forcePopupEnabledLayers.filter(t=>t!==e));const r=null===(i=this.view)||void 0===i?void 0:i.popup;if(!r)return;const s=(null==r?void 0:r.features)||[];if(s.length>0){const t=s.filter(t=>(t.layer||t.sourceLayer)!==e&&this.isFeaturePopupEnabledByCurrentMapPopupSetting(t));t.length<s.length&&(0===t.length?this.closePopup():r.features=t)}}getSnappingLayers(){var e,t;const i=[],r=this.view;if(!r)return i;const s=["esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.WFSLayer","esri.layers.CSVLayer"],a=["esri.layers.support.SubtypeSublayer","esri.layers.MapNotesLayer"],n=["esri.layers.SceneLayer","esri.layers.BuildingSceneLayer"];let o=s;"2d"===r.type?o=s.concat(a):"3d"===r.type&&(o=s.concat(n));this.getAllJimuLayerViews().forEach(e=>{const t=null==e?void 0:e.layer;t&&o.includes(t.declaredClass)&&i.push(t)});const l=null===(t=null===(e=r.map)||void 0===e?void 0:e.allLayers)||void 0===t?void 0:t.toArray();return(null==l?void 0:l.length)>0&&l.forEach(e=>{var t;if("esri.layers.GraphicsLayer"===(null==e?void 0:e.declaredClass)){const r=e;(null===(t=r.graphics)||void 0===t?void 0:t.length)>0&&i.push(r)}}),i}}class ai extends y.React.PureComponent{constructor(){super(...arguments),this.viewManager=Nt.getInstance(),this.onViewsCreate=e=>{this.props.onViewsCreate&&this.props.onViewsCreate(e)},this.onViewGroupCreate=()=>{if(this.props.onViewGroupCreate&&this.viewManager&&this.props.useMapWidgetId){const e=this.viewManager.getJimuMapViewGroup(this.props.useMapWidgetId);this.props.onViewGroupCreate(e)}},this.onViewsChange=e=>{if(this.props.onViewsChange){const t=this.getViews(e);this.props.onViewsChange(t)}},this.onActiveViewChange=e=>{if(!this.props.onActiveViewChange)return;let t=null;if(this.viewManager){const e=this.getActiveViewId(this.props.useMapWidgetId,this.props.viewInfos);e&&(t=this.viewManager.getJimuMapViewById(e))}this.props.onActiveViewChange(t,e)},this.getActiveViewId=(e,t)=>{let i="";return e&&t&&(i=t&&Object.keys(t).find(i=>t[i].mapWidgetId===e&&t[i].isActive&&t[i].status===y.JimuMapViewStatus.Loaded)),i||(i=""),i},this.getWhetherAllViewsCreated=(e,t,i)=>!((null==e?void 0:e.length)<(null==i?void 0:i.length))&&((null==e?void 0:e.length)>0&&!e.some(e=>!this.getWhetherViewCreated(e,t))),this.getWhetherViewCreated=(e,t)=>!!(e&&t&&t[e]&&t[e].status&&t[e].status===y.JimuMapViewStatus.Loaded),this.getViewIdsFromMapWidgetId=(e,t)=>t?Object.keys(t).filter(i=>t[i].mapWidgetId===e):[],this.getCreatedViewIdsFromMapWidgetId=(e,t)=>this.getViewIdsFromMapWidgetId(e,t).filter(e=>this.getWhetherViewCreated(e,t)),this.getViews=e=>{if(!e)return null;const t={};return this.viewManager&&e.forEach(e=>{t[e]=this.viewManager.getJimuMapViewById(e)}),t}}componentDidMount(){this.checkPropCallbacksForCurrentMapWidgetId([],"")}componentDidUpdate(e){const t=e.useMapWidgetId||"",i=this.props.useMapWidgetId||"",r=this.getViewIdsFromMapWidgetId(e.useMapWidgetId,e.viewInfos),s=this.getCreatedViewIdsFromMapWidgetId(e.useMapWidgetId,e.viewInfos),a=this.getActiveViewId(e.useMapWidgetId,e.viewInfos);if(i===t){const t=this.getViewIdsFromMapWidgetId(this.props.useMapWidgetId,this.props.viewInfos);if(0===r.length&&t.length>0&&this.onViewGroupCreate(),!this.getWhetherAllViewsCreated(r,e.viewInfos,e.useDataSources)&&this.getWhetherAllViewsCreated(t,this.props.viewInfos,this.props.useDataSources)){const e=this.getViews(t);this.onViewsCreate(e)}const i=this.getCreatedViewIdsFromMapWidgetId(this.props.useMapWidgetId,this.props.viewInfos),{isEqual:n}=y.utils.diffArrays(!0,s,i);n||this.onViewsChange(t);a!==this.getActiveViewId(this.props.useMapWidgetId,this.props.viewInfos)&&this.onActiveViewChange(a)}else this.checkPropCallbacksForCurrentMapWidgetId(s,a)}checkPropCallbacksForCurrentMapWidgetId(e,t){const{useMapWidgetId:i,viewInfos:r,useDataSources:s}=this.props,a=this.getViewIdsFromMapWidgetId(i,r);if(a.length>0&&this.onViewGroupCreate(),this.getWhetherAllViewsCreated(a,r,s)){const e=this.getViews(a);this.onViewsCreate(e)}const n=this.getCreatedViewIdsFromMapWidgetId(i,r),{isEqual:o}=y.utils.diffArrays(!0,e,n);o||this.onViewsChange(a);t!==this.getActiveViewId(i,r)&&this.onActiveViewChange(t)}render(){if(!this.props.useMapWidgetId||!this.props.viewInfos||!this.props.children)return null;const e=this.getViewIdsFromMapWidgetId(this.props.useMapWidgetId,this.props.viewInfos),t=this.getViews(e);return"function"==typeof this.props.children?this.props.children(t):this.props.children}}const ni=y.ReactRedux.connect((e,t)=>{var i,r,s;const a=null!==(i=e.appStateInBuilder)&&void 0!==i?i:e;return{viewInfos:a.jimuMapViewsInfo,useDataSources:null===(s=null===(r=a.appConfig)||void 0===r?void 0:r.widgets[t.useMapWidgetId])||void 0===s?void 0:s.useDataSources}})(ai);function oi(e){const[,t]=y.React.useState(!1);if(y.React.useEffect(()=>{if(this.getJimuLayerView())t(!0);else{Nt.getInstance().getJimuMapViewById(this.props.jimuMapViewId).whenJimuLayerViewLoaded(this.props.jimuLayerViewId).then(()=>{t(!0)})}},[]),!e.jimuLayerViewId||!e.children)return null;const i=(()=>{const t=Nt.getInstance().getJimuMapViewById(e.jimuMapViewId);return null==t?void 0:t.jimuLayerViews[e.jimuLayerViewId]})();return i?"function"==typeof e.children?e.children(i):e.children:null}var li=function(e,t,i,r){return new(i||(i=Promise))(function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};function ui(){return li(this,void 0,void 0,function*(){return Nt.getInstance(),yield Promise.resolve(null)})}return n})())}}});
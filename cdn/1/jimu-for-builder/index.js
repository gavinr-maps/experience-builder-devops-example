System.register(["jimu-core","jimu-core/react","jimu-theme","jimu-layouts/layout-runtime","jimu-for-builder/templates","jimu-ui","jimu-for-builder","jimu-ui/advanced/setting-components"],(function(e,t){var o={},i={},n={},s={},a={},r={},l={},u={};return{setters:[function(e){o.AjaxState=e.AjaxState,o.AllDataSourceTypes=e.AllDataSourceTypes,o.AppMode=e.AppMode,o.AppType=e.AppType,o.BrowserSizeMode=e.BrowserSizeMode,o.ContainerType=e.ContainerType,o.DataSourceComponent=e.DataSourceComponent,o.DataSourceManager=e.DataSourceManager,o.ExtensionManager=e.ExtensionManager,o.Immutable=e.Immutable,o.IntlProvider=e.IntlProvider,o.Keyboard=e.Keyboard,o.LayoutItemType=e.LayoutItemType,o.LayoutParentType=e.LayoutParentType,o.LayoutType=e.LayoutType,o.MessageActionConnectionType=e.MessageActionConnectionType,o.MessageCarryData=e.MessageCarryData,o.MessageType=e.MessageType,o.MutableStoreManager=e.MutableStoreManager,o.PageType=e.PageType,o.React=e.React,o.ReactRedux=e.ReactRedux,o.ResourceType=e.ResourceType,o.ScreenTransitionType=e.ScreenTransitionType,o.SessionManager=e.SessionManager,o.SqlExpressionMode=e.SqlExpressionMode,o.WidgetManager=e.WidgetManager,o.WidgetType=e.WidgetType,o.appActions=e.appActions,o.appConfigUtils=e.appConfigUtils,o.classNames=e.classNames,o.css=e.css,o.dataSourceUtils=e.dataSourceUtils,o.defaultMessages=e.defaultMessages,o.esri=e.esri,o.extensionSpec=e.extensionSpec,o.getAppStore=e.getAppStore,o.hooks=e.hooks,o.i18n=e.i18n,o.injectIntl=e.injectIntl,o.jimuHistory=e.jimuHistory,o.jsx=e.jsx,o.keyboardUtils=e.keyboardUtils,o.loadDependencies=e.loadDependencies,o.lodash=e.lodash,o.moduleLoader=e.moduleLoader,o.observeStore=e.observeStore,o.polished=e.polished,o.portalUrlUtils=e.portalUrlUtils,o.portalUtils=e.portalUtils,o.translatedLocales=e.translatedLocales,o.urlManagerUtils=e.urlManagerUtils,o.urlUtils=e.urlUtils,o.utils=e.utils,o.uuidv1=e.uuidv1},function(e){i.PureComponent=e.PureComponent,i.createElement=e.createElement},function(e){n.withTheme=e.withTheme},function(e){s.searchUtils=e.searchUtils,s.utils=e.utils},function(e){a.getTemplateConfig=e.getTemplateConfig},function(e){r.Button=e.Button,r.Checkbox=e.Checkbox,r.Label=e.Label,r.Loading=e.Loading,r.LoadingType=e.LoadingType,r.MultiSelect=e.MultiSelect,r.Popper=e.Popper,r.Radio=e.Radio,r.defaultMessages=e.defaultMessages,r.imageUtils=e.imageUtils},function(e){l.getAppConfigAction=e.getAppConfigAction},function(e){u.SettingRow=e.SettingRow}],execute:function(){e((()=>{var e={499:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="m6.036 12.157 8.01-8.01a.5.5 0 1 1 .707.707l-8.01 8.01a1 1 0 0 1-1.415 0L1.146 8.682a.5.5 0 1 1 .708-.707z"></path></svg>'},617:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 12 12"><path fill="#000" fill-rule="evenodd" d="M.007.883A1 1 0 0 1 1 0h10l.117.007A1 1 0 0 1 12 1v7l-.007.117A1 1 0 0 1 11 9H4l-4 3V1zM11 1H1v9l2.667-2H11zM3 3.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5M3.5 5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1z" clip-rule="evenodd"></path></svg>'},153:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M1.333 0h4c.737 0 1.334.597 1.334 1.333v1.334h8C15.403 2.667 16 3.264 16 4v10.667c0 .736-.597 1.333-1.333 1.333H1.333A1.333 1.333 0 0 1 0 14.667V1.333C0 .597.597 0 1.333 0m0 7.333v7.334h13.334V7.333zm0-1.333h13.334V4H5.334V1.335h-4z" clip-rule="evenodd"></path></svg>'},528:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M2 2h12v4H2zM1 7V1h14v6zm1 3h12v4H2zm-1 5V9h14v6z" clip-rule="evenodd"></path></svg>'},218:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M2 2h12v12H2zM1 15V1h14v14zm4-9h6v4H5zm-1 5V5h8v6z" clip-rule="evenodd"></path></svg>'},201:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path fill="#000" fill-rule="evenodd" d="M17 2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2zM5 1h10a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1m2 2h6v6H7zm0 8h1v2H7zm2 0h1v1H9zm4 2h-1v1h1zm-6 1h1v1H7zm4 2h-1v1h1zm1-1h1v2h-1zm-3 2v-1H7v1zm2-6h2v1h-2z" clip-rule="evenodd"></path></svg>'},850:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path fill="#000" d="M3 3h7v7H3zM11 11h1v2h-1zM13 11h1v1h-1zM17 13h-1v1h1zM11 14h1v1h-1zM15 16h-1v1h1zM16 15h1v2h-1zM13 17v-1h-2v1zM15 11h2v1h-2z"></path><path fill="#000" fill-rule="evenodd" d="M20 2a2 2 0 0 0-2-2H2a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2zM2 1h16a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1" clip-rule="evenodd"></path></svg>'},859:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path fill="#000" d="M4 4h2v1H4zM8 4h2v1H8zM14 4h-2v1h2zM15 4h1v2h-1zM16 8h-1v2h1zM4 14h1v2H4zM5 6H4v2h1zM4 10h1v2H4zM16 12h-1v2h1zM16 15v1h-2v-1zM12 15h-2v1h2zM6 15h2v1H6z"></path><path fill="#000" fill-rule="evenodd" d="M18 0a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zm0 1H2a1 1 0 0 0-1 1v16a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1" clip-rule="evenodd"></path></svg>'},341:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path fill="#000" d="M3 7h6v6H3zM11 7h1v2h-1zM13 7h1v1h-1zM17 9h-1v1h1zM11 10h1v1h-1zM15 12h-1v1h1zM16 11h1v2h-1zM13 13v-1h-2v1zM15 7h2v1h-2z"></path><path fill="#000" fill-rule="evenodd" d="M20 5a2 2 0 0 0-2-2H2a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2zM2 4h16a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1" clip-rule="evenodd"></path></svg>'},606:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path fill="#000" fill-rule="evenodd" d="M1.25 2.5h17.5v11.25H1.25zM0 2.5c0-.69.56-1.25 1.25-1.25h17.5c.69 0 1.25.56 1.25 1.25v11.25c0 .69-.56 1.25-1.25 1.25H1.25C.56 15 0 14.44 0 13.75zm3.75 16.25h2.5V17.5h-2.5zm7.5 0h-2.5V17.5h2.5zm2.5 0h2.5V17.5h-2.5z" clip-rule="evenodd"></path></svg>'},736:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path fill="#000" fill-rule="evenodd" d="M14 2a2 2 0 0 0-2-2H2a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2zM2 1h10a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1" clip-rule="evenodd"></path><path fill="#000" fill-rule="evenodd" d="M20 8a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2zM8 7h10a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1" clip-rule="evenodd"></path></svg>'},37:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 40"><path fill="#A8A8A8" fill-rule="evenodd" d="M6 30v10H0v-1h5v-9zM3.162 18.582a.5.5 0 0 1 0 .71l-1.416 1.421a2.497 2.497 0 0 0-.003 3.545c.983.983 2.56.98 3.544-.003l1.42-1.42a.504.504 0 0 1 .712.713L6 24.968a3.5 3.5 0 0 1-4.967 0 3.5 3.5 0 0 1 0-4.967l1.416-1.422a.504.504 0 0 1 .713.003m4.967-.71a.5.5 0 0 1 0 .71L4.58 22.129a.504.504 0 0 1-.713-.712l3.548-3.548a.504.504 0 0 1 .713.003m2.838-2.838a3.5 3.5 0 0 1 0 4.967l-1.42 1.419a.504.504 0 0 1-.713-.712l1.423-1.417a2.5 2.5 0 0 0 0-3.547 2.5 2.5 0 0 0-3.547 0l-1.42 1.419a.504.504 0 0 1-.713-.712l1.42-1.42a3.506 3.506 0 0 1 4.97.003M6 0v10H5V1H0V0z"></path></svg>'},490:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="m1.373 8 2.07-2.071.83.828L2.2 8.828a3.515 3.515 0 0 0 4.97 4.971l2.072-2.071.828.828L8 14.627A4.686 4.686 0 1 1 1.373 8M13.799 7.172l-2.071 2.07.828.83L14.627 8A4.686 4.686 0 1 0 8 1.373l-2.071 2.07.828.83L8.828 2.2a3.515 3.515 0 0 1 4.971 4.97"></path><path fill="#000" d="M5.515 9.657a.586.586 0 0 0 .828.828l4.142-4.142a.586.586 0 0 0-.828-.828z"></path></svg>'},886:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 12 12"><path fill="#000" fill-rule="evenodd" d="M10.167 0H1.833A.845.845 0 0 0 1 .857v10.286c0 .473.373.857.833.857h8.334c.46 0 .833-.384.833-.857V.857A.845.845 0 0 0 10.167 0M2 11V1h8v10zm1.6-8h4.8c.331 0 .6.224.6.5s-.269.5-.6.5H3.6c-.331 0-.6-.224-.6-.5s.269-.5.6-.5m4.8 3H3.6c-.331 0-.6.224-.6.5s.269.5.6.5h4.8c.331 0 .6-.224.6-.5S8.731 6 8.4 6" clip-rule="evenodd"></path></svg>'},996:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M8 2.125 14.334 14H1.667zm-.882-.47a1 1 0 0 1 1.765 0l6.333 11.874A1 1 0 0 1 14.334 15H1.667a1 1 0 0 1-.882-1.47zM8 4.874a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0L8.9 5.87a.905.905 0 0 0-.9-.995m1 7a1 1 0 1 1-2 0 1 1 0 0 1 2 0" clip-rule="evenodd"></path></svg>'},244:e=>{"use strict";e.exports=o},972:e=>{"use strict";e.exports=i},108:e=>{"use strict";e.exports=l},884:e=>{"use strict";e.exports=a},496:e=>{"use strict";e.exports=s},888:e=>{"use strict";e.exports=n},321:e=>{"use strict";e.exports=r},298:e=>{"use strict";e.exports=u},546:e=>{"use strict";e.exports=JSON.parse('{"online":{"home":"#","get-started":{"prefix":"get-started/","what-is-arcgis-experience-builder":"what-is-arcgis-experience-builder.htm","whats-new":"whats-new.htm"},"build-apps":{"prefix":"build-apps/","add-a-page":"add-a-page.htm","add-a-dialog":"add-windows.htm","add-utility-services":"add-utility-services.htm","add-custom-widgets":"getting-started-widget.htm","add-screen-groups":"add-screen-groups.htm","select-data":"select-data.htm","change-app-theme":"change-app-theme.htm","general-settings":"general-settings.htm"},"widgets":{"prefix":"configure-widgets/","overview":"widgets-overview.htm","3d-toolbox":"3d-toolbox-widget.htm","add-data":"add-data-widget.htm","analysis":"analysis-widget.htm","arcgis-map":"map-widget.htm","basemap-gallery":"basemap-gallery-widget.htm","ba-infographic":"business-analyst-infographic-widget.htm","bookmark":"bookmark-widget.htm","branch-version-management":"branch-version-management-widget.htm","button":"button-widget.htm","building-explorer":"building-explorer-widget.htm","card":"card-widget.htm","chart":"chart-widget.htm","column":"column-widget.htm","controller":"widget-controller-widget.htm","coordinates":"coordinates-widget.htm","coordinate-conversion":"coordinate-conversion-widget.htm","divider":"divider-widget.htm","draw":"draw-widget.htm","directions":"directions-widget.htm","edit":"edit-widget.htm","elevation-profile":"elevation-profile-widget.htm","embed":"embed-widget.htm","feature-info":"feature-info-widget.htm","feature-report":"feature-report-widget.htm","filter":"filter-widget.htm","fixed":"fixed-panel-widget.htm","floor-filter":"floor-filter-widget.htm","fly-controller":"fly-controller-widget.htm","grid":"grid-widget.htm","image":"image-widget.htm","legend":"legend-widget.htm","list":"list-widget.htm","map-layers":"map-layers-widget.htm","measurement":"measurement-widget.htm","menu":"menu-widget.htm","navigator":"view-navigation-widget.htm","near-me":"near-me-widget.htm","oriented-imagery":"oriented-imagery-widget.htm","placeholder":"placeholder-widget.htm","print":"print-widget.htm","query":"query-widget.htm","row":"row-widget.htm","search":"search-widget.htm","section":"section-widget.htm","select":"select-widget.htm","share":"share-widget.htm","sidebar":"sidebar-widget.htm","suitability-modeler":"suitability-modeler-widget.htm","survey123":"survey-widget.htm","swipe":"swipe-widget.htm","table":"table-widget.htm","text":"text-widget.htm","timeline":"timeline-widget.htm","my-location":"my-location-widget.htm","utility-network-trace":"utility-network-trace-widget.htm"}},"portal":{"home":"120001864","get-started":{"what-is-arcgis-experience-builder":"120001877","whats-new":"120002535"},"build-apps":{"add-a-page":"120001863","add-a-dialog":"120002539","add-utility-services":"120003733","add-custom-widgets":"120003728","add-screen-groups":"120002592","select-data":"120002590","change-app-theme":"120004139","general-settings":"120004779"},"widgets":{"overview":"#","3d-toolbox":"120003734","add-data":"120004128","analysis":"120004647","arcgis-map":"120001851","basemap-gallery":"120004168","bookmark":"120002536","button":"120001841","building-explorer":"120004868","branch-version-management":"120002654","ba-infographic":"120003631","card":"120002537","chart":"120002727","column":"120001842","controller":"120001862","coordinates":"120003879","coordinate-conversion":"120002728","divider":"120002538","draw":"120003632","directions":"120003635","edit":"120002844","elevation-profile":"120002905","embed":"120001843","feature-info":"120001844","feature-report":"120004895","filter":"120001845","fixed":"120001846","floor-filter":"120003634","fly-controller":"120001847","grid":"120003880","image":"120001848","legend":"120001849","list":"120001850","map-layers":"120001852","measurement":"120004869","menu":"120001853","navigator":"120001861","near-me":"120004170","oriented-imagery":"120002843","placeholder":"120001854","print":"120003716","query":"120002729","row":"120001855","search":"120002845","section":"120001856","select":"120004732","share":"120001857","sidebar":"120001858","suitability-modeler":"120002906","survey123":"120001859","swipe":"120004169","table":"120002591","text":"120001860","timeline":"120003717","my-location":"120004870","utility-network-trace":"120003633","add-line-event":"120004827","add-point-event":"120004828","identify":"120004829","merge-events":"120004830","search-by-route":"120004831","split-event":"120004832"}},"dev":{"home":"#","get-started":{"prefix":"guide/","what-is-arcgis-experience-builder":"getting-started-widget","whats-new":"whats-new"},"build-apps":{"prefix":"guide/","add-a-page":"add-a-page","add-a-dialog":"add-windows","add-utility-services":"add-utility-services","add-custom-widgets":"getting-started-widget","add-screen-groups":"add-screen-groups","select-data":"select-data","change-app-theme":"change-app-theme","general-settings":"general-settings"},"widgets":{"prefix":"guide/","overview":"widgets-overview","3d-toolbox":"3d-toolbox-widget","add-data":"add-data-widget","analysis":"analysis-widget","arcgis-map":"map-widget","basemap-gallery":"basemap-gallery-widget","ba-infographic":"business-analyst-infographic-widget","bookmark":"bookmark-widget","branch-version-management":"branch-version-management-widget","button":"button-widget","building-explorer":"building-explorer-widget","card":"card-widget","chart":"chart-widget","column":"column-widget","controller":"widget-controller-widget","coordinates":"coordinates-widget","coordinate-conversion":"coordinate-conversion-widget","divider":"divider-widget","draw":"draw-widget","directions":"directions-widget","edit":"edit-widget","elevation-profile":"elevation-profile-widget","embed":"embed-widget","feature-info":"feature-info-widget","feature-report":"feature-report-widget","filter":"filter-widget","fixed":"fixed-panel-widget","floor-filter":"floor-filter-widget","fly-controller":"fly-controller-widget","grid":"grid-widget","image":"image-widget","legend":"legend-widget","list":"list-widget","map-layers":"map-layers-widget","measurement":"measurement-widget","menu":"menu-widget","navigator":"view-navigation-widget","near-me":"near-me-widget","oriented-imagery":"oriented-imagery-widget","placeholder":"placeholder-widget","print":"print-widget","query":"query-widget","row":"row-widget","search":"search-widget","section":"section-widget","select":"select-widget","share":"share-widget","sidebar":"sidebar-widget","suitability-modeler":"suitability-modeler-widget","survey123":"survey-widget","swipe":"swipe-widget","table":"table-widget","text":"text-widget","timeline":"timeline-widget","my-location":"my-location-widget","utility-network-trace":"utility-network-trace-widget"}}}')}},t={};function d(o){var i=t[o];if(void 0!==i)return i.exports;var n=t[o]={exports:{}};return e[o](n,n.exports,d),n.exports}d.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return d.d(t,{a:t}),t},d.d=(e,t)=>{for(var o in t)d.o(t,o)&&!d.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},d.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),d.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var c={};return(()=>{"use strict";d.r(c),d.d(c,{AppConfigAction:()=>Ro,AppDataActionManager:()=>_o,AppMessageManager:()=>A,AppResourceFilePath:()=>Fe,AppResourceManager:()=>Ge,AppStateHistoryActionKeys:()=>N,AppStateHistoryExtension:()=>H,AppStateReduxStoreExtension:()=>$,AppWidgetManager:()=>Bt,BaseLayoutService:()=>To,BaseWidgetSetting:()=>u,BuilderKeyboardComponent:()=>wi,BuilderStateActionTypes:()=>p,BuilderStateReduxStoreExtension:()=>y,BuilderStateResourceActionKeys:()=>K,BuilderStateResourceExtension:()=>Q,ContentServiceWrapper:()=>Do,DownloadAppModal:()=>tn,ExtActionKeys:()=>W,LayoutServiceProvider:()=>Ft,ToBuilderMessage:()=>V,UrlConfigManager:()=>Bo,WidgetSettingManager:()=>w,appBuilderSync:()=>i,appConfigUtils:()=>e,appStateActions:()=>F,appStateHistoryActions:()=>G,builderActionKeys:()=>p,builderActions:()=>f,builderAppSync:()=>o,builderStateResourceActions:()=>J,dataSourceService:()=>Vt,defaultMessages:()=>_e,emptyContentService:()=>Co,getAppConfigAction:()=>Uo,helpUtils:()=>s,init:()=>Wi,loadI18nMessage:()=>Bi,makeSureTemplateConfig:()=>Gt,placeholderService:()=>Lo,screenGroupService:()=>wo,sectionService:()=>fo,templateService:()=>Ao,templateUtils:()=>a,utils:()=>n,widgetService:()=>lo});var e={};d.r(e),d.d(e,{cleanAppStructure:()=>E,getCleanAppConfig:()=>B,getRealPageCount:()=>R,getRealPageCountExcludeOnePage:()=>_,getSizeModeOfALayout:()=>T,getSubRealPageCount:()=>O,getUniqueId:()=>M,getUniqueLabel:()=>D,isFirstLevelPage:()=>j,isLabelDuplicated:()=>z,isPageHasSubPage:()=>U,isRealPage:()=>k,parseUniqueLabel:()=>x});var t={};d.r(t),d.d(t,{addItemResource:()=>Te,checkItemVersion:()=>ye,createItem:()=>he,getItem:()=>Se,getItemData:()=>ve,getItemResource:()=>we,getItemResources:()=>Ie,getOriginUrl:()=>re,getRequestMethod:()=>ce,getUserContentUrl:()=>ue,getUserName:()=>de,importItem:()=>fe,removeItem:()=>Ae,removeItemResource:()=>Pe,request:()=>ae,searchItems:()=>te,searchItemsByPortalUrl:()=>ie,updateItem:()=>Me,updateItemResource:()=>De});var o={};d.r(o),d.d(o,{listenAppEvents:()=>vt,publichActivePagePartChangeToApp:()=>rt,publichChangeZoomScaleToApp:()=>at,publichUtilityStateChangeToApp:()=>et,publishAnimationPreviewToApp:()=>lt,publishAppConfigChangeToApp:()=>qe,publishAppInfoChangeToApp:()=>Ve,publishAppModeChangeToApp:()=>Je,publishChangeBrowserSizeModeToApp:()=>it,publishChangeSelectionToApp:()=>Ye,publishChangeSessionToApp:()=>nt,publishChangeWidgetMutableStatePropToApp:()=>tt,publishChangeWidgetStatePropToApp:()=>Xe,publishDialogChangeToApp:()=>Ze,publishDialogInfosChangeToApp:()=>Ke,publishHoverPreviewToApp:()=>ut,publishKeyboardToApp:()=>ot,publishNoPermissionResourceInfoListChangeToApp:()=>st,publishOpenCookieBannerByPrivacyPanelToApp:()=>ft,publishOpenCookieBannerToApp:()=>ht,publishOpenCookieSettingsWindowToApp:()=>yt,publishPageChangeToApp:()=>Qe,publishScreenGroupNavInfoToApp:()=>ct,publishSectionNavInfoToApp:()=>dt,publishSetClientIdAlertIsCancelled:()=>gt,publishTocHoverInfoToApp:()=>pt});var i={};d.r(i),d.d(i,{clearLastAppConfigFromHistory:()=>jt,letBuilderAddResource:()=>Mt,letBuilderClearResource:()=>Dt,letBuilderPopupChooseWidget:()=>Lt,letBuilderResponseToKeyboard:()=>xt,letBuilderShowLayoutToolbar:()=>Tt,listenBuilderEvents:()=>It,publishAppIsLoadedToBuilder:()=>Pt,publishAppSessionChangeToBuilder:()=>wt,publishAppStateChangeToBuilder:()=>At,publishCheck498ErrorToBuilder:()=>bt,publishCloseBannerToBuilder:()=>kt,publishConfirmDeleteToApp:()=>Rt,publishIsBusyToBuilder:()=>Ut,publishNoPermissionResourceInfoListChangeToBuilder:()=>Ct,publishPortalUrlNeedToRegisterClientId:()=>Ot,publishSidePanelToApp:()=>_t});var n={};d.r(n),d.d(n,{CUSTOM_GROUP:()=>ui,fetchCommonWidgetList:()=>Xo,fetchRemoteCustomWidgetList:()=>ti,getBuilderUrl:()=>ri,getDefaultSectionIcon:()=>Qo,getDefaultTocDialogIcon:()=>Jo,getDefaultTocPageIcon:()=>Ko,getHomePageUrl:()=>li,getPageListByDialogId:()=>Zo,getPlaceholderItemForWidgetsList:()=>ni,getSectionItemForWidgetsList:()=>ii,getWidgetsGroupLabel:()=>oi,showCustomWidgets:()=>ai,showRemoteCustomWidgets:()=>si});var s={};d.r(s),d.d(s,{getBuildAppsHelpLink:()=>hi,getHomeHelpLink:()=>fi,getWhatsNewLink:()=>yi,getWidgetHelpLink:()=>mi,isSupportLanguage:()=>gi});var a={};d.r(a),d.d(a,{processForTemplate:()=>Si});var r=d(244);class l extends r.React.PureComponent{}const u=l;var p,g=d(972),h=d(888);!function(e){e.SelectTemplate="SELECT_TEMPLATE",e.OpenChooseWidgetPopup="OPEN_CHOOSE_WIDGET_POPUP",e.CloseChooseWidgetPopup="CLOSE_CHOOSE_WIDGET_POPUP",e.WidgetSettingClassLoaded="WIDGET_SETTING_CLASS_LOADED",e.WidgetsRemoved="WIDGETS_REMOVED",e.WidgetsAdded="WIDGETS_ADDED",e.ChangeCurrentApp="CHANGE_CURRENT_APP",e.RefreshAppList="REFRSH_APPLIST",e.SetLayoutTools="SET_LAYOUT_TOOLS",e.StartGuide="START_GUIDE",e.StopGuide="STOP_GUIDE",e.WidgetSettingI18nMessageLoaded="WIDGET_SETTING_I18N_MESSAGE_LOADED",e.ConfirmDeleteContentChanged="CONFIRM_DELETE_CONTENT_CHANGED"}(p||(p={}));const f={selectTemplate:e=>({type:p.SelectTemplate,templateName:e}),refreshAppListAction:e=>({type:p.RefreshAppList,isRefresh:e}),openChooseWidgetPopup:(e,t)=>({type:p.OpenChooseWidgetPopup,layoutId:e,layoutItemId:t}),closeChooseWidgetPopup:()=>({type:p.CloseChooseWidgetPopup}),widgetSettingClassLoaded:e=>({type:p.WidgetSettingClassLoaded,wigetUri:e}),widgetsAdded:e=>({type:p.WidgetsAdded,widgets:e}),widgetsRemoved:e=>({type:p.WidgetsRemoved,widgetIds:e}),changeCurrentApp:e=>({type:p.ChangeCurrentApp,appId:e}),setLayoutTools:e=>({type:p.SetLayoutTools,tools:e}),startGuide:e=>({type:p.StartGuide,guideId:e}),stopGuide:()=>({type:p.StopGuide}),widgetSettingI18nMessageLoaded:(e,t)=>({type:p.WidgetSettingI18nMessageLoaded,widgetName:e,i18nMessages:t}),confirmDeleteContentChanged:e=>({type:p.ConfirmDeleteContentChanged,itemToDelete:e})};class y{constructor(){this.id="builder-state-redux-store-extension"}getActions(){return Object.keys(p).map((e=>p[e]))}getInitLocalState(){return(0,r.Immutable)({templateName:null,showChooseWidgetPopup:!1,currentAppId:null,refreshAppList:!1,isMobile:!1,currentGuideId:null,widgetSettingI18nMessages:(0,r.Immutable)({}),widgetsSettingClassStatus:(0,r.Immutable)({})})}getReducer(){return(e,t,o)=>{switch(t.type){case p.SelectTemplate:return e.set("templateName",t.templateName);case p.OpenChooseWidgetPopup:return e.set("showChooseWidgetPopup",!0).set("currentLayout",(0,r.Immutable)({layoutId:t.layoutId,layoutItemId:t.layoutItemId}));case p.CloseChooseWidgetPopup:return e.set("showChooseWidgetPopup",!1);case p.WidgetSettingClassLoaded:return e=e.setIn(["widgetsSettingClassStatus",t.wigetUri],!0),function(e,t){var o,i;const n=(null===(i=null===(o=e.appStateInBuilder)||void 0===o?void 0:o.appConfig)||void 0===i?void 0:i.widgets)||{};return Object.keys(n).filter((e=>n[e].uri===t))}(o,t.wigetUri).forEach((t=>{e=e.setIn(["widgetsSettingRuntimeInfo",t,"isClassLoaded"],!0)})),e;case p.WidgetsAdded:return t.widgets.forEach((t=>{e.widgetsSettingClassStatus[t.widgetUri]&&(e=e.setIn(["widgetsSettingRuntimeInfo",t.widgetId,"isClassLoaded"],!0))})),e;case p.WidgetsRemoved:return e.set("widgetsSettingRuntimeInfo",e.widgetsSettingRuntimeInfo.without(...t.widgetIds));case p.ChangeCurrentApp:return(e=this.getInitLocalState()).set("currentAppId",t.appId).set("widgetsSettingRuntimeInfo",{});case p.RefreshAppList:return e.set("refreshAppList",t.isRefresh);case p.SetLayoutTools:return e.set("toolbarConfig",t.tools);case p.StartGuide:return e.set("currentGuideId",t.guideId);case p.StopGuide:return e.set("currentGuideId",null);case p.WidgetSettingI18nMessageLoaded:return e.setIn(["widgetSettingI18nMessages",t.widgetName],t.i18nMessages);case p.ConfirmDeleteContentChanged:{const{itemToDelete:o}=t;return e.set("contentToDelete",o)}default:return e}}}getStoreKey(){return"builder"}}var m=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};const{getLocaleToLoad:v,loadLocaleMessages:S}=r.i18n;class I{static getInstance(){return I.instance||(I.instance=new I,window._widgetSettingManager=I.instance),I.instance}constructor(){this.settings={},(0,r.observeStore)(this.onStoreChange.bind(this),["appStateInBuilder","appConfig","widgets"])}getWidgetUri(e){var t,o,i;const n=null===(t=(0,r.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig;return null===(i=null===(o=null==n?void 0:n.widgets)||void 0===o?void 0:o[e])||void 0===i?void 0:i.uri}getWidgetManifestByUri(e){var t,o,i;const n=null===(o=null===(t=(0,r.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig)||void 0===o?void 0:o.widgets,s=Object.keys(n||{}).find((t=>n[t].uri===e));return null===(i=n[s])||void 0===i?void 0:i.manifest}updateWidgetCache(e,t){this.settings[e]||(this.settings[e]={});for(const o in t)this.settings[e][o]=t[o]}getWidgetSettingClass(e){var t;return null===(t=this.settings[this.getWidgetUri(e)])||void 0===t?void 0:t.settingClazz}destroyWidgetSettingClass(e){const t=this.getWidgetUri(e);t&&delete this.settings[t]}destroyWidgetSettingClassByUri(e){this.checkWidgetUriInConfig(e)||delete this.settings[e]}getItemSettingClass(e){var t;return null===(t=this.settings[this.getWidgetUri(e)])||void 0===t?void 0:t.itemSettingClazz}getSettingI18nMessagesByUri(e){var t;return null===(t=this.settings[e])||void 0===t?void 0:t.settingI18nMessage}destroyAllWidgetSettingClasses(){this.settings={}}loadWidgetSettingClass(e){return m(this,void 0,void 0,(function*(){var t,o,i;const n=null===(i=null===(o=null===(t=(0,r.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig)||void 0===o?void 0:o.widgets)||void 0===i?void 0:i[e];if(!n)return yield Promise.resolve(null);if(!n.manifest)return yield Promise.resolve(null);const s=this.getWidgetUri(e);return this.loadWidgetSettingClassByUri(s)}))}checkWidgetUriInConfig(e){var t,o;const i=(null===(o=null===(t=(0,r.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig)||void 0===o?void 0:o.widgets)||{};return!!Object.keys(i).find((t=>i[t].uri===e))}loadWidgetSettingClassByUri(e){return this.settings[e]||(this.settings[e]={}),this.settings[e].settingClazzPromise||(this.settings[e].settingClazzPromise=this.loadRawSettingClass(e).then((()=>m(this,void 0,void 0,(function*(){return yield this.loadI18nMessagesForSetting(e)})))).then((()=>{const t=this.injectWidgetSettingProps(e);return t?(this.settings[e].settingClazz=t,(0,r.getAppStore)().dispatch(f.widgetSettingClassLoaded(e)),t):(delete this.settings[e],null)}))),this.settings[e].settingClazzPromise}loadRawSettingClass(e){return m(this,void 0,void 0,(function*(){const t=this.getWidgetManifestByUri(e);let o=`${e}dist/setting/setting`;return t.properties.hasSettingPage||(o="jimu-for-builder/json-editor-setting"),yield this.loadWidgetSettingDependency(e).then((()=>m(this,void 0,void 0,(function*(){return yield r.moduleLoader.loadModule(o)})))).then((t=>{const o=t.default?t.default:t;return this.settings[e].rawSettingClazz=o,o}))}))}loadI18nMessagesForSetting(e){return m(this,void 0,void 0,(function*(){if(this.settings[e]||(this.settings[e]={}),this.settings[e].settingI18nMessagePromise)return yield this.settings[e].settingI18nMessagePromise;const t=this.getWidgetManifestByUri(e);if(!t)return yield Promise.resolve({});if(t.translatedLocales){let o=(0,r.getAppStore)().getState().appContext.locale;o=v(o,t.translatedLocales),this.settings[e].settingI18nMessagePromise=o?S(`${e}dist/setting/translations`,o):Promise.resolve({})}else this.settings[e].settingI18nMessagePromise=Promise.resolve({});return yield this.settings[e].settingI18nMessagePromise.then(((o={})=>((0,r.getAppStore)().dispatch(f.widgetSettingI18nMessageLoaded(t.name,o)),this.settings[e].settingI18nMessage=o,o)))}))}loadWidgetSettingDependency(e){return m(this,void 0,void 0,(function*(){const t=this.getWidgetManifestByUri(e);if(!t.settingDependency)return void(yield Promise.resolve());const o="string"==typeof t.settingDependency?[t.settingDependency]:t.settingDependency;yield(0,r.loadDependencies)(o)}))}loadItemSettingClass(e){return m(this,void 0,void 0,(function*(){var t,o,i;const n=null===(i=null===(o=null===(t=(0,r.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig)||void 0===o?void 0:o.widgets)||void 0===i?void 0:i[e];return n&&n.manifest?yield this.loadItemSettingClassByUri(this.getWidgetUri(e)):yield Promise.resolve(null)}))}loadItemSettingClassByUri(e){return m(this,void 0,void 0,(function*(){return this.settings[e]||(this.settings[e]={}),this.settings[e].itemSettingClazzPromise||(this.settings[e].itemSettingClazzPromise=this.loadRawItemSettingClass(e).then((t=>(this.settings[e].itemSettingClazz=t,t)))),this.settings[e].itemSettingClazzPromise}))}loadRawItemSettingClass(e){return m(this,void 0,void 0,(function*(){const t=`${e}dist/setting/item-setting`;return yield r.moduleLoader.loadModule(t).then((e=>e.default?e.default:e))}))}injectWidgetSettingProps(e){if(!this.checkWidgetUriInConfig(e))return null;const t=this.settings[e].rawSettingClazz,o=(0,r.injectIntl)(t),i=(0,h.withTheme)(o,!0),n=this.getWidgetManifestByUri(e),s=n.name,a=this.settings[e].settingI18nMessage;class l extends g.PureComponent{render(){if(n.version!==this.props.version)return null;const e={messages:a};const t=Object.assign({},a,this.props.appI18nMessages);return g.createElement(r.IntlProvider,{locale:this.props.locale,defaultLocale:this.props.locale,messages:t},g.createElement(i,Object.assign({},this.props,e)))}}l.displayName=`WidgetSettingWrapper(${s})`;return r.ReactRedux.connect(((e,o)=>{const i={queryObject:e.queryObject,user:e.user,token:e.token,portalUrl:e.portalUrl,portalSelf:e.portalSelf,locale:e.appContext.locale,appI18nMessages:e.appI18nMessages},n=o.widgetId,s=e.appStateInBuilder.appConfig.widgets[n];if(!s)return{};const a=Object.assign(i,s,o);return Object.assign(a,t.mapExtraStateProps?t.mapExtraStateProps(e,a):{})}))(l)}onStoreChange(e,t){e&&t&&Object.keys(e).forEach((e=>{t[e]}))}}const w=I;var C=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};const{getTranslatedLocale:b}=r.i18n;class A{constructor(){this.actionSettings={}}static getInstance(){return A.instance||(A.instance=new A),A.instance}getAllActions(){const e=this.getAppMessageManager();return e?e.getActions():[]}getAction(e,t){const o=this.getAppMessageManager();return o?o.getAction(e,t):null}getAppMessageManager(){if(window.jimuConfig.isBuilder){if(window._appWindow._messageManager)return window._appWindow._messageManager}else if(window._messageManager)return window._messageManager;return null}getActionSettingComponentUri(e,t,o){if(e.getSettingComponentUri)return e.getSettingComponentUri(t,o);if(e.widgetId){const t=(0,r.getAppStore)().getState().appStateInBuilder.appConfig.widgets[e.widgetId].manifest.messageActions.find((t=>t.name===e.name));return t?t.settingUri:null}return null}getFilteredActions(e,t){if(window._appWindow._messageManager){const o=window._appWindow._messageManager.getActions(),i=[],n={messageType:e,widgetId:t},s=(window.jimuConfig.isBuilder?(0,r.getAppStore)().getState().appStateInBuilder:(0,r.getAppStore)().getState()).appConfig.widgets[t].manifest.publishMessages.find((t=>"string"==typeof t?t===e:t.messageType===e));s&&"string"!=typeof s&&(n.messageCarryData=s.messageCarryData);for(let e=0;e<o.length;e++)o[e].filterMessageDescription(n)&&i.push(o[e]);return i}return[]}getConvertedSettingUri(e,t){const o=this.getAllActions();let i=null;for(let n=0;n<o.length;n++)if(e.includes(o[n].id)){const e=o[n].widgetId;if(e){const s=(0,r.getAppStore)().getState().appStateInBuilder.appConfig.widgets[e],a=s.manifest.messageActions;let l=null;if(a)for(let e=0;e<a.length;e++)a[e].name===o[n].name&&(l=a[e]);return l&&t?(i=s.uri+"dist/"+t,i):null}return t}return i}loadActionSettingClass(e,t){return C(this,void 0,void 0,(function*(){var o;const i=t?this.getConvertedSettingUri(e.actionId,t):null;if(i||Promise.resolve(null),this.actionSettings[i]||(this.actionSettings[i]={}),null===(o=this.actionSettings[i])||void 0===o?void 0:o.clazzPromise)return yield this.actionSettings[i].clazzPromise;const n=e.widgetId,s=(0,r.getAppStore)().getState().appStateInBuilder.appConfig.widgets[n];return this.actionSettings[i].clazzPromise=this.loadRawSettingClass(i).then((e=>C(this,void 0,void 0,(function*(){return w.getInstance().loadI18nMessagesForSetting(s&&s.uri).then((t=>this.injectActionSettingProps(e,t,s&&s.id)))})))).then((e=>(this.actionSettings[i].clazz=e,e))),this.actionSettings[i].clazzPromise}))}loadRawSettingClass(e){return C(this,void 0,void 0,(function*(){return this.actionSettings[e].rawClazzPromise?yield this.actionSettings[e].rawClazzPromise:(this.actionSettings[e].rawClazzPromise=r.moduleLoader.loadModule(e).then((t=>(t=t.default?t.default:t,this.actionSettings[e].rawClazz=t,this.actionSettings[e].rawClazz))),this.actionSettings[e].rawClazzPromise)}))}injectActionSettingProps(e,t,o){const i=(0,r.injectIntl)(e),n=(0,r.getAppStore)().getState().appStateInBuilder.appConfig.widgets[o];let s=null;s=o&&n?(0,r.getAppStore)().getState().appStateInBuilder.appConfig.widgets[o].manifest.name:"Framework";class a extends r.React.PureComponent{render(){const e={messages:t},s=(0,r.getAppStore)().getState().appI18nMessages;let a=null;o&&n?(a=b((0,r.getAppStore)().getState().appContext.locale,n.manifest.translatedLocales.asMutable()),a||(a=n.manifest.translatedLocales&&n.manifest.translatedLocales[0]),a||(a=(0,r.getAppStore)().getState().appContext.locale)):a=(0,r.getAppStore)().getState().appContext.locale;const l=Object.assign({},t,s);return r.React.createElement(r.IntlProvider,{locale:a,messages:l},r.React.createElement(i,Object.assign({},this.props,e)))}}a.displayName=`ActionSettingWrapper(${s})`;for(const t in e)a[t]||(a[t]=e[t]);return a}registerActionRawSettingClass(e,t){this.actionSettings[e]||(this.actionSettings[e]={}),this.actionSettings[e].rawClazz=t,this.actionSettings[e].rawClazzPromise=Promise.resolve(t),this.actionSettings[e].settingI18nMessages={},this.actionSettings[e].settingI18nMessagesPromise=Promise.resolve({})}getActionRawSettingClass(e){return this.actionSettings[e].rawClazz}}var P=d(496);function L(e,t){return Object.values(null!=t?t:{}).forEach((t=>{e=function(e,t){var o;const i=e.layouts[t];return i?(delete i.parent,Object.keys(null!==(o=i.content)&&void 0!==o?o:{}).forEach((t=>{const o=i.content[t];switch(o.type){case r.LayoutItemType.Widget:{const t=e.widgets[o.widgetId];t&&(delete t.parent,t.layouts&&Object.values(t.layouts).forEach((t=>{e=L(e,t)})));break}case r.LayoutItemType.Section:{const t=e.sections[o.sectionId];delete t.parent,t.views.forEach((t=>{const o=e.views[t];delete o.parent,e=L(e,o.layout)}));break}case r.LayoutItemType.ScreenGroup:{const t=e.screenGroups[o.screenGroupId];delete t.parent,t.screens.forEach((t=>{var o;const i=e.screens[t];delete i.parent,e=L(e,i.main.layout),(null===(o=i.panel)||void 0===o?void 0:o.layout)&&(e=L(e,i.panel.layout))}));break}}})),e):e}(e,t)})),e}const{getUniqueId:M,getUniqueLabel:D,parseUniqueLabel:x,getSizeModeOfALayout:T}=r.appConfigUtils;function j(e,t){return!!e.pageStructure.find((e=>!!e[t]))}function U(e,t){const o=e.pageStructure.find((e=>!!e[t]));return o&&o[t].length>0}function R(e){let t=0;return Object.keys(e.pages).forEach(((o,i)=>{k(e,o)&&t++})),t}function O(e,t){if(!j(e,t))return 0;let o=0;return e.pageStructure.forEach(((i,n)=>{const s=Object.keys(i)[0];s===t&&i[s].forEach((t=>{k(e,t)&&o++}))})),o}function _(e,t){let o=0;return k(e,t)&&(o=1),R(e)-O(e,t)-o}function k(e,t){const o=e.pages[t];return!!o&&o.type===r.PageType.Normal}function E(e){var t,o,i,n;return Object.values(null!==(t=e.pages)&&void 0!==t?t:{}).forEach((t=>{e=L(e,t.layout)})),Object.values(null!==(o=e.dialogs)&&void 0!==o?o:{}).forEach((t=>{e=L(e,t.layout)})),(null===(i=e.header)||void 0===i?void 0:i.layout)&&(e=L(e,e.header.layout)),(null===(n=e.footer)||void 0===n?void 0:n.layout)&&(e=L(e,e.footer.layout)),e}function B(e){let t=e.asMutable({deep:!0});var o;return Object.keys(t.widgets).forEach((e=>{var o,i,n;const s=t.widgets[e];s.label===(null===(o=s.manifest)||void 0===o?void 0:o.name)&&delete s.label,s.icon===s.context.folderUrl+"icon.svg"&&delete s.icon,"object"==typeof s.icon&&(s.icon.svg!==s.context.folderUrl+"icon.svg"||"#fff"!==(null===(i=s.icon.properties)||void 0===i?void 0:i.color)&&(null===(n=s.icon.properties)||void 0===n?void 0:n.color)||delete s.icon),delete s.context,delete s.manifest,delete s._originManifest})),t.layouts=(o=t.layouts,Object.keys(o).forEach((e=>{const t=o[e];delete t.id,t.content&&Object.keys(t.content).forEach((e=>{delete t.content[e].id}))})),o),t=r.appConfigUtils.cleanPortalInfoFromResource(t),t=E(t),t}function z(e,t,o,i){let n;return"page"===t?n=e.pages:"view"===t?n=e.views:"dialog"===t&&(n=e.dialogs),!!n&&Object.keys(n).some((e=>e!==o&&n[e].label===i))}var W;window._getCleanAppConfig=B,function(e){e.InAppAppStateChanged="IN_APP_APP_STATE_CHANGED",e.InBuilderAppConfigChanged="IN_BUILDER_APP_CONFIG_CHANGED"}(W||(W={}));const F={inAppAppStateChanged:e=>({type:W.InAppAppStateChanged,appState:e}),inBuilderAppConfigChanged:e=>({type:W.InBuilderAppConfigChanged,appConfig:e})};class ${constructor(){this.id="builder-app-state-redux-store-extension"}getActions(){return Object.keys(W).map((e=>W[e]))}getInitLocalState(){return null}getReducer(){return(e,t,o)=>{switch(t.type){case W.InAppAppStateChanged:return t.appState;case W.InBuilderAppConfigChanged:return r.appConfigUtils.updateStateWhenAppConfigChange(e,t.appConfig);default:return e}}}getStoreKey(){return"appStateInBuilder"}}var N;!function(e){e.InBuilderPutAppConfigIntoHistory="IN_BUILDER_PUT_APPCONFIG_INTO_HISTORY",e.InBuilderRemoveLastAppConfigFromHistory="IN_BUILDER_REMOVE_LAST_APPCONFIG_FROM_HISTORY",e.InBuilderReplaceLastAppConfigInHistory="IN_BUILDER_REPLACE_LAST_APPCONFIG_IN_HISTORY",e.InBuilderAppConfigUndo="IN_BUILDER_APPCONFIG_UNDO",e.InBuilderAppConfigRedo="IN_BUILDER_APPCONFIG_REDO",e.InBuilderAppConfigRedoClear="IN_BUILDER_APPCONFIG_REDOCLEAR",e.InBuilderAppConfigClear="IN_BUILDER_APPCONFIG_CLEAR"}(N||(N={}));const G={InBuilderAppConfigUndo:()=>({type:N.InBuilderAppConfigUndo}),InBuilderAppConfigRedo:()=>({type:N.InBuilderAppConfigRedo}),InBuilderPutAppConfigIntoHistory:e=>({type:N.InBuilderPutAppConfigIntoHistory,appState:e}),InBuilderRemoveLastAppConfigFromHistory:()=>({type:N.InBuilderRemoveLastAppConfigFromHistory}),InBuilderReplaceLastAppConfigInHistory:e=>({type:N.InBuilderReplaceLastAppConfigInHistory,appState:e}),InBuilderAppConfigRedoClear:()=>({type:N.InBuilderAppConfigRedoClear}),InBuilderAppConfigClear:()=>({type:N.InBuilderAppConfigClear})};class H{constructor(){this.id="app-state-history-extension"}getActions(){return[N.InBuilderPutAppConfigIntoHistory,N.InBuilderRemoveLastAppConfigFromHistory,N.InBuilderReplaceLastAppConfigInHistory,N.InBuilderAppConfigUndo,N.InBuilderAppConfigRedo,N.InBuilderAppConfigRedoClear,N.InBuilderAppConfigClear]}getInitLocalState(){return{past:[],future:[]}}getReducer(){return(e,t,o)=>{switch(t.type){case N.InBuilderAppConfigUndo:return this.handleAppStateUndo(e);case N.InBuilderAppConfigRedo:return this.handleAppStateRedo(e);case N.InBuilderPutAppConfigIntoHistory:return this.handleAppStateAdd(e,t.appState);case N.InBuilderRemoveLastAppConfigFromHistory:return this.handleAppStateRemoveLast(e);case N.InBuilderReplaceLastAppConfigInHistory:return this.handleAppStateReplaceLast(e,t.appState);case N.InBuilderAppConfigRedoClear:return this.handleAppStateRedoClear(e);case N.InBuilderAppConfigClear:return this.handleAppStateClear(e);default:return e}}}handleAppStateUndo(e){if(e.past.length<2)return console.warn("Can not undo since no history there"),e;const t=e.past[e.past.length-2],o=e.past[e.past.length-1],i=e.past.slice(0,e.past.length-1),n=[o].concat(e.future);return r.lodash.defer((()=>{qe(t.appConfig),Ve(t.appInfo)})),e.merge({past:i,future:n})}handleAppStateRedo(e){if(e.future.length<1)return console.warn("Can not redo since no history there"),e;const t=e.future[0],o=e.future.slice(1),i=e.past.concat([t]);return r.lodash.defer((()=>{qe(t.appConfig),Ve(t.appInfo)})),e.merge({past:i,future:o})}handleAppStateAdd(e,t){const o=e.past[e.past.length-1];if(null!==t&&(e.past.length>0&&(o.appConfig!==t.appConfig||o.appInfo!==t.appInfo)||0===e.past.length)){const o=e.past.concat([t]);return e.set("past",o).set("future",[])}return e}handleAppStateRemoveLast(e){if(e.past.length>0){const t=e.past.slice(0,e.past.length-1);return e.set("past",t)}return e}handleAppStateReplaceLast(e,t){let o=e.past;return e.past.length>0?(o=o.slice(0,e.past.length-1).concat(t),e.set("past",o)):e}handleAppStateRedoClear(e){return e.set("future",[])}handleAppStateClear(e){return e.set("future",[]).set("past",[])}getStoreKey(){return"appStateHistory"}}var q,V,K;!function(e){e.AppConfigChanged="app_config_changed",e.AppInfoChanged="app_info_changed",e.PortalSelfChanged="portal_self_changed",e.DialogInfosChanged="dialog_infos_changed",e.UserSignIn="user_sign_in",e.SetMainPortal="set_main_portal",e.ChangeAppMode="change_app_mode",e.ChangePage="change_page",e.ChangeDialog="change_dialog",e.ChangeSelection="change_selection",e.ChangeWidgetStateProp="change_widget_state_prop",e.ChangeWidgetMutableStateProp="change_widget_mutable_state_prop",e.ChangeZoomScale="change_zoom_scale",e.BuilderTriggerKeyboard="builder_trigger_keyboard",e.ChangeBrowserSizeMode="change_browser_size_mode",e.BuilderSessionChanged="builder_session_changed",e.BuilderNoPermissionResourceInfoListChanged="builder_no_permission_resource_info_list_changed",e.ActivePagePartChanged="active_page_part_changed",e.AnimationPreview="animation_preview",e.HoverPreview="hover_preview",e.SectionNavInfoChanged="section_navinfo_changed",e.ScreenGroupNavInfoChanged="screengroup_navinfo_changed",e.TocHoverInfoChanged="toc_hover_info_changed",e.SetClientIdAlertIsCancelled="set_client_id_alert_is_cancelled",e.UtilityStateChanged="utility_state_changed",e.OpenCookieBanner="open_cookie_banner",e.OpenCookieBannerByPrivacyPanel="open_cookie_banner_by_privacy_panel",e.OpenCookieSettingsWindow="open_cookie_settings_window"}(q||(q={})),function(e){e.AppStateChanged="app_state_changed",e.AppSessionChanged="app_session_changed",e.AppNoPermissionResourceInfoListChanged="app_no_permission_resource_info_list_changed",e.NeedToCheck498Error="need_to_check_498_error",e.PopupChooseWidget="popup_choose_widget",e.AppAddResource="app_add_resource",e.AppClearResources="app_clear_resources",e.AppTriggerKeyboard="app_trigger_keyboard",e.SetLayoutTools="app_set_layout_tools",e.ClearLastAppConfigFromHistory="clear_last_app_config_from_history",e.SetIsBusy="app_set_isbusy",e.AppIsLoaded="app_is_loaded",e.ConfirmDelete="confirm_delete",e.NeedToRegisterClinetId="need_to_register_client_id",e.SetSidePanel="app_side_panel",e.CloseBannerInLiveView="close_banner_in_live_view"}(V||(V={})),function(e){e.AddResource="ADD_RESOURCE",e.UpdateResource="UPDATE_RESOURCE",e.ClearResources="CLEAR_RESOURCES"}(K||(K={}));const J={AddResource:(e,t)=>({type:K.AddResource,resourceKey:e,resourceItemInfo:t}),UpdateResource:(e,t)=>({type:K.UpdateResource,resourceKey:e,resourceItemInfo:t}),ClearResources:()=>({type:K.ClearResources})};class Q{constructor(){this.id="builder-state-resource-extension"}getActions(){return Object.keys(K).map((e=>K[e]))}getInitLocalState(){return(0,r.Immutable)({})}getReducer(){return(e,t,o)=>{switch(t.type){case K.AddResource:case K.UpdateResource:return e.set(t.resourceKey,t.resourceItemInfo);case K.ClearResources:return(0,r.Immutable)({});default:return e}}}getStoreKey(){return"resourcesInfo"}}var Z,Y,X;!function(e){e.AGOL="AGOL",e.Portal="Portal",e.Other="Other"}(Z||(Z={})),function(e){e.TemplateType="Web Experience Template",e.ExperienceType="Web Experience"}(Y||(Y={})),function(e){e.Published="Published",e.Draft="Draft",e.Changed="Changed"}(X||(X={}));var ee=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};function te(e){return ee(this,arguments,void 0,(function*(e,t=Z.Other){return yield oe(e,"item",t)}))}function oe(e,t){return ee(this,arguments,void 0,(function*(e,t,o=Z.Other){let i,n;return i=`${o===Z.AGOL?"https://www.arcgis.com/":`${window.location.origin}${window.jimuConfig.mountPath}`}sharing/rest/search`,n="string"==typeof e||e instanceof r.esri.restPortal.SearchQueryBuilder?{params:{q:e}}:r.esri.restRequest.appendCustomParams(Object.assign(Object.assign({},e),{f:"json"}),["q","num","start","sortField","sortOrder","portalUrl","f","categories"]),ae(i,n,"GET").then((o=>(o.nextStart&&-1!==o.nextStart&&(o.nextPage=function(){return ee(this,void 0,void 0,(function*(){let i;return"string"==typeof e||e instanceof r.esri.restPortal.SearchQueryBuilder?i={q:e,start:o.nextStart}:(i=e,i.start=o.nextStart),yield oe(i,t)}))}),o)))}))}function ie(e,t){return ee(this,void 0,void 0,(function*(){return yield ne(e,t)}))}function ne(e,t){return ee(this,void 0,void 0,(function*(){let o,i;o||Promise.resolve(null),o=`${t}/sharing/rest/search`,i="string"==typeof e||e instanceof r.esri.restPortal.SearchQueryBuilder?{params:{q:e}}:r.esri.restRequest.appendCustomParams(Object.assign(Object.assign({},e),{f:"json"}),["q","num","start","sortField","sortOrder","portalUrl","f"]);const n=null==i?void 0:i.authentication,s={params:null==i?void 0:i.params,httpMethod:"GET"};return n&&(s.authentication=n),r.esri.restRequest.request(o,s).then((t=>(t.nextStart&&-1!==t.nextStart&&(t.nextPage=function(){return ee(this,void 0,void 0,(function*(){let o;return"string"==typeof e||e instanceof r.esri.restPortal.SearchQueryBuilder?o={q:e,start:t.nextStart}:(o=e,o.start=t.nextStart),yield ne(o,"item")}))}),t)))}))}var se=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};function ae(e){return se(this,arguments,void 0,(function*(e,t={params:{f:"json"}},o="POST"){if("GET"===o){const o=e+function(e){if(!e)return"";const t=Object.keys(e);return t.length?"?"+t.map((t=>encodeURIComponent(t)+"="+encodeURIComponent(e[t]))).join("&"):""}(t.params);return yield fetch(o,{method:"GET",headers:{"Content-Type":"application/json"}}).then((e=>se(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>se(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))}return"POST"===o?t.params&&"FormData"===t.params.constructor.name?yield fetch(e,{method:"POST",body:t.params}).then((e=>se(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>se(this,void 0,void 0,(function*(){return yield Promise.resolve(e)})))):yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.params)}).then((e=>se(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>se(this,void 0,void 0,(function*(){return yield Promise.resolve(e)})))):yield Promise.reject(null)}))}function re(e=!1){var t;if(e)return r.urlUtils.getArcgisOnlineUrl();{const e=(null===(t=window.jimuConfig.mountPath)||void 0===t?void 0:t.slice(0,-1))||"";return`${window.location.origin}${e}`}}const le=r.esri.restRequest.request;function ue(e=!1){return e?"/sharing/rest/content/":"/sharing/rest/content/users/"}function de(){var e;return null===(e=(0,r.getAppStore)().getState().user)||void 0===e?void 0:e.username}function ce(e=!1){return e?le:ae}function pe(e){const t=JSON.parse(JSON.stringify(e));return t.data&&("undefined"!=typeof Blob&&e.data instanceof Blob||"ReadStream"===e.data.constructor.name?t.file=e.data:t.text=e.data,delete t.data),t}var ge=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};function he(e){return ge(this,void 0,void 0,(function*(){const t=Object.assign({folderId:null},e);return yield function(e){return ge(this,void 0,void 0,(function*(){var t,o;if(e.file&&!e.multipart)return yield Promise.reject(new Error("The request must be a multipart request for file uploading."));if(e.multipart&&!e.filename)return yield Promise.reject(new Error("The file name is required for a multipart request."));const i=de(),n=`${re()}${ue()}addItem`;e.params=Object.assign(Object.assign(Object.assign({},e.params),pe(e.item)),{portalUrl:null===(o=null===(t=(0,r.getAppStore)())||void 0===t?void 0:t.getState())||void 0===o?void 0:o.portalUrl});const s=r.esri.restRequest.appendCustomParams(e,["owner","folderId","file","dataUrl","text","async","multipart","filename","overwrite"],{params:Object.assign({},e.params)});return s.params.username=i,yield ae(n,s)}))}(t)}))}function fe(e,t){return ge(this,void 0,void 0,(function*(){const o=`${re()}${ue()}importItem`;if(!(null==e?void 0:e.appZip))return Promise.reject("No app files");t.params=Object.assign(Object.assign({},t.params),e);const i=Object.keys(t.params),n=new FormData;for(let e=0;e<i.length;e++)n.append(i[e],t.params[i[e]]);return t.params=n,yield ae(o,t)}))}function ye(e,t){return ge(this,void 0,void 0,(function*(){const o=`${re()}${ue()}checkItemVersion`;if(!(null==e?void 0:e.appZip))return Promise.reject("No app files");t.params=Object.assign(Object.assign({},t.params),e);const i=Object.keys(t.params),n=new FormData;for(let e=0;e<i.length;e++)n.append(i[e],t.params[i[e]]);return t.params=n,yield ae(o,t)}))}var me=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};function ve(e,t){return me(this,arguments,void 0,(function*(e,t,o=!1){const i=`${re(o)}${ue(o)}items/${e}/data`,n=Object.assign({params:{}},t);n.file&&(n.params.f=null),o&&!Ce()&&delete n.authentication;const s=ce(o);return yield s(i,n).catch((e=>{if(!/Unexpected end of (JSON input|data at line 1 column 1)/i.test(e.message))throw e}))}))}function Se(e,t){return me(this,arguments,void 0,(function*(e,t,o=!1){const i=`${re(o)}${ue(o)}items/${e}`,n=Object.assign({},t);o&&!Ce()&&delete n.authentication;const s=ce(o);return yield s(i,n)}))}function Ie(e,t){return me(this,arguments,void 0,(function*(e,t,o=!1){const i=`${re(o)}${ue(o)}items/${e}/resources`;t.params=Object.assign(Object.assign({},t.params),{num:1e3}),o&&!Ce()&&delete t.authentication;const n=ce(o);return yield n(i,t,"GET")}))}function we(e,t){return me(this,arguments,void 0,(function*(e,t,o=!1){const i=t.fileName,n=`${re(o)}${ue(o)}items/${e}/resources/${i}`;o&&!Ce()&&delete t.authentication;const s=ce(o);return yield s(n,t,"GET")}))}function Ce(){const e=(0,r.getAppStore)().getState().portalUrl;return r.portalUrlUtils.isAGOLDomain(e)}var be=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};function Ae(e){return be(this,void 0,void 0,(function*(){const t=de(),o=re();e.userName=t;const i=`${o}${ue()}items/${e.id}/delete`;return yield ae(i,e)}))}function Pe(e){return be(this,void 0,void 0,(function*(){const t=`${re()}${ue()}items/${e.id}/removeResources`;return e.params=Object.assign(Object.assign({},e.params),{resource:e.resource}),yield ae(t,e)}))}var Le=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};function Me(e){return Le(this,void 0,void 0,(function*(){const t=de(),o=re();e.userName=t;const i=`${o}${ue()}items/${e.item.id}/update`;if(e.params=Object.assign(Object.assign({},e.params),pe(e.item)),e.item.thumbnail&&"string"!=typeof e.item.thumbnail){e.params=Object.assign(Object.assign({},e.params),e.item);const t=Object.keys(e.params),o=new FormData;for(let i=0;i<t.length;i++)o.append(t[i],e.params[t[i]]);e.params=o}return yield ae(i,e)}))}function De(e){return Le(this,void 0,void 0,(function*(){const t=`${re()}${ue()}items/${e.id}/updateResources`;e.params=Object.assign(Object.assign({fileName:e.name,text:e.content},e.params),{file:e.resource}),delete e.params.file,e.params.file=e.resource,void 0!==e.private&&(e.params.access=e.private?"private":"inherit");const o=Object.keys(e.params),i=new FormData;for(let t=0;t<o.length;t++)i.append(o[t],e.params[o[t]]);return e.params=i,yield ae(t,e)}))}var xe=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};function Te(e){return xe(this,void 0,void 0,(function*(){const t=`${re()}${ue()}items/${e.id}/addResources`;e.params=Object.assign(Object.assign({fileName:e.name,text:e.content,access:e.private?"private":"inherit"},e.params),{file:e.resource}),delete e.params.file,e.params.file=e.resource;const o=Object.keys(e.params),i=new FormData;for(let t=0;t<o.length;t++)i.append(o[t],e.params[o[t]]);return e.params=i,yield ae(t,e)}))}r.SessionManager.getInstance().isTrustedServer((0,r.getAppStore)().getState().portalUrl);var je=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};const{importItem:Ue,checkItemVersion:Re}=t;function Oe(e,o,i){const n=i?t[i]:t[e],s=r.esri.restPortal[e];return o?Ee(o)?s:n:window.jimuConfig.isDevEdition?n:s}const _e={frameworkAction_TriggerLayer:"Trigger data",frameworkAction_SetData:"Select data",frameworkAction_ActionLayer:"Action data",frameworkAction_Conditions:"Conditions",frameworkAction_RelateMessage:"Trigger / action connection",frameworkAction_UseRelationship:"Use layer's relationship",frameworkAction_CustomFields:"Set custom connection fields",frameworkAction_TriggerLayerField:"Select a trigger field",frameworkAction_None:"none",frameworkAction_Equals:"equals",frameworkAction_ActionLayerField:"Select an action field",frameworkAction_MoreConditions:"More conditions",frameworkAction_SetExpression:"Please set your expression first.",frameworkAction_ChooseLayer:"Select data",frameworkAction_AutoBind:"Auto bound.",frameworkAction_NoLayer:"No data.",frameworkAction_QueryByExtent:"Query by current extent",defaultTextPlaceholder:"Double click to edit text",titlePlaceholder:"Here is the title",subTitlePlaceholder:"Here is the subtitle",shortTitlePlaceholder:"Title",shortSubTitlePlaceholder:"Subtitle",copyrightPlaceholder:"Copyright info",cardTitle:"Card title",bookmark:"Bookmark",number:"Number",templateSearchResult:"Search result",logo:"Logo",appItemCopy:"Copy"};var ke=d(884);r.esri.restRequest.request;function Ee(e){var t,o;if(!(null==e?void 0:e.portalUrl))return!window.jimuConfig.isDevEdition;const i=(null==e?void 0:e.portalUrl)||"",n=(null===(o=null===(t=(0,r.getAppStore)())||void 0===t?void 0:t.getState())||void 0===o?void 0:o.portalUrl)||"",s=(null==n?void 0:n.includes(i))||(null==i?void 0:i.includes(n));return(r.portalUrlUtils.isAGOLDomain(i)&&r.portalUrlUtils.isAGOLDomain(n)||s)&&!ze(e)}function Be(e){if(!(null==e?void 0:e.portalUrl))return!1;const t=(null==e?void 0:e.portalUrl)||"",o=r.portalUrlUtils.isAGOLDomain(t),i=!Ee(e),n=!ze(e);return i&&n&&o}function ze(e){return!!((null==e?void 0:e.portalUrl)||"").endsWith("localhost:")||e.isLocalApp}function We(e){if(ze(e))return{};const t=r.SessionManager.getInstance().getMainSession();return Ee(e)?t:{}}var Fe,$e=d(321),Ne=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};!function(e){e.Config="config/config.json",e.Image="images/image-resources-list.json",e.Icon="images/icon-resources-list.json"}(Fe||(Fe={}));class Ge{constructor(){this.resourceMap={},this.blobToResourceMap={},this.resources={},this.getResourcesInDraft=()=>this.resources,this.setResourcesInDraft=e=>{this.resources=Object.assign(Object.assign({},this.getResourcesInDraft()),e)},this.getImageResourceListFromDraft=e=>Ne(this,void 0,void 0,(function*(){const t=this.getResourcesInDraft();if(t.imageResources)return yield Promise.resolve(t.imageResources);{const t=this.getSession(),o=this.getPortalUrlWithFull(e),{resources:i}=yield this.fetchAppResourceInfoList(e);if((null==i?void 0:i.some((({resource:e})=>e===Fe.Image)))||!1){const i=(yield this.fetchAppResource(e,{fileName:Fe.Image,readAs:"json"}))||{};return Object.values(i).forEach((e=>{e.url.includes("?token=")&&(e.url=e.url.slice(0,e.url.indexOf("?token="))),e.url=e.url.replace("${appResourceUrl}",o)+"?token="+(null==t?void 0:t.token)})),yield Promise.resolve(i)}return yield this.upLoadImageResourceList({})}})),this.getIconResourceListFromDraft=e=>Ne(this,void 0,void 0,(function*(){const{iconResources:t}=this.getResourcesInDraft();if(t)return yield Promise.resolve(t);const o=this.getSession(),i=this.getPortalUrlWithFull(e),{resources:n}=yield this.fetchAppResourceInfoList(e);if((null==n?void 0:n.some((({resource:e})=>e===Fe.Icon)))||!1){const t=yield this.fetchAppResource(e,{fileName:Fe.Icon,readAs:"json"});if(t)return Object.values(t).forEach((e=>{e.svg=e.svg.replace("${appResourceUrl}",i)+"?token="+(null==o?void 0:o.token),"string"==typeof e.properties.path&&(e.properties.path=e.properties.path.replace("${appResourceUrl}",i)+"?token="+(null==o?void 0:o.token))})),yield Promise.resolve(t)}return yield this.upLoadIconResourceList({})})),this.getInUseImageResources=e=>{var t;let o=B(null===(t=(0,r.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig);o=r.utils.replaceStringInObject(Object.assign({},o),{matcher:e=>/^blob:\http(s?):\/\/(.)/.test(e),handler:e=>{var t;return(null===(t=this.blobToResourceMap[e])||void 0===t?void 0:t.resourceUrl)||e}});const i={};r.utils.replaceStringInObject(Object.assign({},o),{matcher:e=>/^\$\{appResourceUrl\}+(.)/.test(e),handler:e=>i[e]=e});const n=[];Object.values(e).forEach((e=>{const t=`\${appResourceUrl}/${e.resourcesPrefix}/${e.fileName}`;i[t]&&n.push(e)}));return this.formatRelatedImageResources(e,n)},this.getInUseIconResources=e=>{var t;let o=B(null===(t=(0,r.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig);o=r.utils.replaceStringInObject(Object.assign({},o),{matcher:e=>/^blob:\http(s?):\/\/(.)/.test(e),handler:e=>{var t;return(null===(t=this.blobToResourceMap[e])||void 0===t?void 0:t.resourceUrl)||e}});const i={};r.utils.replaceStringInObject(Object.assign({},o),{matcher:e=>/^\$\{appResourceUrl\}+(.)/.test(e),handler:e=>i[e]=e});const n=[];return Object.values(e).forEach((e=>{const t=`\${appResourceUrl}/images/icon_picker_in_setting/${e.properties.filename}`;i[t]&&n.push(e)})),n},this.upLoadAppConfig=(e,t,o)=>Ne(this,void 0,void 0,(function*(){const i=yield this.upLoadLocalResource(t),n=new Blob([JSON.stringify(i)],{type:"application/json"}),s={appId:e,file:n,fileName:"config.json",type:r.ResourceType.Config,owner:o};return yield this.upLoadAppResource(s).then((()=>Ne(this,void 0,void 0,(function*(){return yield Promise.resolve(t)})))).catch((e=>Ne(this,void 0,void 0,(function*(){return yield Promise.reject(e)}))))})),this.upLoadImageResourceList=(e,t)=>Ne(this,void 0,void 0,(function*(){const o=Object.assign({},e);return yield this.upLoadResourceList(Fe.Image,o,t)})),this.upLoadIconResourceList=(e,t)=>Ne(this,void 0,void 0,(function*(){return yield this.upLoadResourceList(Fe.Icon,e,t)})),this.upLoadAppResource=e=>Ne(this,void 0,void 0,(function*(){e.resourcesPrefix=Ge.getResourcePrefix(e);const{appId:t=this.getAppId(),fileName:o,originalName:i,resourcesPrefix:n}=e,s=(n?n+"/":"")+o,a="${appResourceUrl}/"+s,l=(0,r.uuidv1)(),u={id:l,appId:t,fileName:o,originalName:i,resourcesPrefix:n,url:e.url,blobUrl:e.blobUrl,resourceUrl:a,type:e.type,status:r.AjaxState.Fetching,widgetId:e.widgetId,owner:e.owner},d=Object.assign({},u);d.file=e.file;const c=this.fetchAppResourceInfoList(t).then((e=>Ne(this,[e],void 0,(function*({resources:e}){if(0===(null==e?void 0:e.length))return yield this.addAppResource(d);if((null==e?void 0:e.length)>0)return e.some((({resource:e})=>e===s))?yield this.updateAppResource(d):yield this.addAppResource(d);throw new Error("return value from fetchAppResourceInfoList is not right")})))).catch((e=>Ne(this,void 0,void 0,(function*(){return console.error(e),this.setResourceItemInfoStatus(d,r.AjaxState.Error),yield Promise.reject(e)}))));return d.promise=c,this.setResourceMap(l,u),yield c})),this.upLoadLocalResource=e=>Ne(this,void 0,void 0,(function*(){const t=this.blobToResourceMap,o=new RegExp("^blob:http(s?)://(.)"),i=[];const n={matcher:function(e){return o.test(e)},handler:function(e){let o=e;return o=t[e],!i.includes(o.id)&&i.push(o.id),o.resourceUrl}},s=r.utils.replaceStringInObject(e,n);return yield this.checkResourcesUploadStatus(i).then((e=>Ne(this,void 0,void 0,(function*(){return e===r.AjaxState.Success?yield Promise.resolve(s):yield Promise.reject()}))))})),this.fetchAppResourceInfoList=(e,t)=>Ne(this,void 0,void 0,(function*(){const o=this.getSession();return yield function(e,t){return je(this,void 0,void 0,(function*(){return Oe("getItemResources",e)(e.id,t,Be(e))}))}({id:e,isLocalApp:window.jimuConfig.isDevEdition},Object.assign({authentication:o},t)).catch((e=>Ne(this,void 0,void 0,(function*(){return console.log(e),yield Promise.reject(e)}))))})),this.fetchAppResource=(e,t)=>Ne(this,void 0,void 0,(function*(){const o=this.getSession();return yield function(e,t){return je(this,void 0,void 0,(function*(){return Oe("getItemResource",e)(e.id,t,Be(e))}))}({id:e,isLocalApp:window.jimuConfig.isDevEdition},Object.assign({authentication:o},t)).catch((e=>Ne(this,void 0,void 0,(function*(){return console.log(e),yield Promise.reject(null)}))))})),this.clearResources=e=>{this.clearResourceMap(),this.clearResourcesWithoutSaved(e),(0,r.getAppStore)().dispatch(J.ClearResources())},this.updateImageResourceItemInfo=e=>{const t=this.getAppId();this.getImageResourceListFromDraft(t).then((t=>{const o=Object.assign({},e);delete o.blobUrl,delete o.type,t[o.fileName.split(".")[0]]=o,this.setResourcesInDraft({imageResources:t})}))}}static getInstance(){return Ge._instance||(Ge._instance=new Ge,window._appResourceManager=Ge._instance),window._appResourceManager}static assignBlobUrlToResourceItem(e){return Ne(this,void 0,void 0,(function*(){try{const t=window.URL.createObjectURL(e.file),{width:o,height:i}=yield $e.imageUtils.getImageOriginalSizeByUrl(t).catch((()=>({width:0,height:0})));return e.url=t,e.blobUrl=t,e.originalWidth=o,e.originalHeight=i,yield Promise.resolve(e)}catch(e){return yield Promise.reject(e)}}))}static getBlobByBlobUrl(e){return Ne(this,void 0,void 0,(function*(){return yield new Promise(((t,o)=>{const i=new XMLHttpRequest;i.responseType="blob",i.open("GET",e,!0),i.onerror=o,i.onload=()=>{200===i.status?t(i.response):o()},i.send()}))}))}static getResourcePrefix({resourcesPrefix:e,widgetId:t,type:o}){if(e)return e;return new Map([[r.ResourceType.Config,"config"],[r.ResourceType.Image,t?`images/${t}`:"images/templates"]]).get(o)||"templates"}addAppResource(e){return Ne(this,void 0,void 0,(function*(){const t=this.getSession();return yield this.getAppInfo({id:e.appId,isLocalApp:window.jimuConfig.isDevEdition}).then((o=>Ne(this,void 0,void 0,(function*(){return yield function(e){return je(this,void 0,void 0,(function*(){return Oe("addItemResource")(e)}))}({id:e.appId,resource:e.file,name:e.fileName,owner:o.owner,params:{resourcesPrefix:e.resourcesPrefix},authentication:t}).then((t=>Ne(this,void 0,void 0,(function*(){return this.setResourceItemInfoStatus(e,r.AjaxState.Success),yield Promise.resolve(t)}))),(t=>Ne(this,void 0,void 0,(function*(){return this.setResourceItemInfoStatus(e,r.AjaxState.Error),yield Promise.reject(t)}))))}))))}))}updateAppResource(e){return Ne(this,void 0,void 0,(function*(){const t=this.getSession();return yield this.getAppInfo({id:e.appId,isLocalApp:window.jimuConfig.isDevEdition}).then((o=>Ne(this,void 0,void 0,(function*(){return yield function(e){return je(this,void 0,void 0,(function*(){return Oe("updateItemResource")(e)}))}({id:e.appId,resource:e.file,name:e.fileName,owner:o.owner,params:{resourcesPrefix:e.resourcesPrefix},authentication:t}).then((t=>Ne(this,void 0,void 0,(function*(){return this.setResourceItemInfoStatus(e,r.AjaxState.Success),yield Promise.resolve(t)}))),(t=>Ne(this,void 0,void 0,(function*(){return this.setResourceItemInfoStatus(e,r.AjaxState.Error),yield Promise.reject(t)}))))}))))}))}removeAppResource(e){return Ne(this,void 0,void 0,(function*(){const t=this.getSession(),o=e.appId?e.appId:this.getAppId();return yield this.getAppInfo({id:o,isLocalApp:window.jimuConfig.isDevEdition}).then((i=>Ne(this,void 0,void 0,(function*(){return yield function(e){return je(this,void 0,void 0,(function*(){return Oe("removeItemResource")(e)}))}({id:o,owner:i.owner,resource:e.fileName,authentication:t}).then((e=>Ne(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))),(e=>Ne(this,void 0,void 0,(function*(){return yield Promise.reject(e)}))))}))))}))}getAppId(){var e;return null===(e=(0,r.getAppStore)().getState().appStateInBuilder)||void 0===e?void 0:e.appId}getSession(){return r.SessionManager.getInstance().getMainSession()}getPortalUrlWithTemplate(){return"${appResourceUrl}/"}getPortalUrlWithFull(e){return function(e){const t=Be(e)?r.urlUtils.getArcgisOnlineUrl():(0,r.getAppStore)().getState().portalUrl;return(null==e?void 0:e.isLocalApp)?re()+"/apps/":r.portalUrlUtils.getPlatformUrlByOrgUrl(t)+"/sharing/rest/content/items/"}({isLocalApp:window.jimuConfig.isDevEdition})+e+"/resources"}setResourceMap(e,t){const{id:o,resourceUrl:i}=t;this.resourceMap[e]=Object.assign(Object.assign({},this.resourceMap[e]),t),this.blobToResourceMap[t.blobUrl]={id:o,resourceUrl:i},(0,r.getAppStore)().dispatch(J.AddResource(e,this.resourceMap[e]))}setResourceItemInfoStatus(e,t){this.resourceMap&&this.resourceMap[e.id]&&(e.status=t,delete e.file,this.setResourceMap(e.id,e))}clearResourceMap(){for(const e in this.resourceMap)this.resourceMap[e]&&window.URL.revokeObjectURL(this.resourceMap[e].blobUrl);this.resourceMap={},this.blobToResourceMap={}}clearValueWithoutInResourcesInDraft(e,t){return Ne(this,void 0,void 0,(function*(){if(this.getAppId()!==e&&Object.keys(this.resources).forEach((e=>{this.resources[e]=null})),t.length>0){const o=yield this.getImageResourceListFromDraft(e),i=yield this.getIconResourceListFromDraft(e),n=[...Object.values(o).map((({resourcesPrefix:e,fileName:t})=>`${e}/${t}`)),...Object.values(i).map((({properties:{filename:e}})=>`images/icon_picker_in_setting/${e}`))],s=t.filter((e=>!n.includes(e)));return yield Promise.resolve(s)}return yield Promise.resolve(t)}))}clearResourcesWithoutSaved(e){return Ne(this,void 0,void 0,(function*(){if(e)try{const t=this.getPortalUrlWithFull(e),o=this.getPortalUrlWithTemplate(),{resources:i}=yield this.fetchAppResourceInfoList(e,{httpMethod:"GET"}),n=(null==i?void 0:i.some((({resource:e})=>e===Fe.Config)))||!1?yield this.fetchAppResource(e,{fileName:Fe.Config,readAs:"json"}):{},s=new RegExp("^\\$\\{appResourceUrl\\}+(.)"),a=new RegExp("^"+t),l={};r.utils.replaceStringInObject(n,{matcher:e=>s.test(e)||a.test(e),handler:e=>l[e]=e});const u=[];null==i||i.forEach((({resource:e})=>{e===Fe.Config||e===Fe.Image||e===Fe.Icon||l[o+e.replace("_compress","")]||l[t+e.replace("_compress","")]||u.push(e)}));const d=(yield this.clearValueWithoutInResourcesInDraft(e,u)).map((t=>this.removeAppResource({appId:e,fileName:t})));Promise.all(d)}catch(e){console.error(e)}}))}formatRelatedImageResources(e,t){const o={},i={},n=[];for(let e=0;e<t.length;e++){const o=t[e].fileName.split(".")[0];n.push(o)}return Object.keys(e).forEach((t=>{e[t].referedIds=[];const o=e[t].originId;(n.includes(o)||n.includes(t))&&(i[t]=e[t],i[o]=e[o])})),Object.keys(i).forEach((e=>{i[e].referedIds=[];const t=i[e].originId;t!==e&&(o[t]?o[t].referedIds.push(e):(o[t]=Object.assign({},i[t]),o[t].referedIds=[e]))})),Object.keys(o).forEach((e=>{i[e]&&(i[e].referedIds=o[e].referedIds)})),i}checkResourcesUploadStatus(e){return Ne(this,void 0,void 0,(function*(){if(e.length>0){const t=e.map((e=>this.resourceMap[e].promise));return yield Promise.all(t).then((()=>Ne(this,void 0,void 0,(function*(){return yield Promise.resolve(r.AjaxState.Success)}))),(()=>Ne(this,void 0,void 0,(function*(){return yield Promise.resolve(r.AjaxState.Error)})))).catch((e=>Ne(this,void 0,void 0,(function*(){return console.error(e),yield Promise.reject()}))))}return yield Promise.resolve(r.AjaxState.Success)}))}upLoadResourceList(e){return Ne(this,arguments,void 0,(function*(e,t={},o){const i=o||this.getAppId(),n=yield this.upLoadLocalResource(t),s=r.appConfigUtils.cleanPortalInfoFromResource(n),a=new Blob([JSON.stringify(s)],{type:"application/json"}),[l,u]=e.split("/"),d={appId:i,file:a,resourcesPrefix:l,fileName:u,type:r.ResourceType.Image};return yield this.upLoadAppResource(d).then((()=>Ne(this,void 0,void 0,(function*(){return yield Promise.resolve(s)})))).catch((e=>Ne(this,void 0,void 0,(function*(){return yield Promise.reject(e)}))))}))}getAppInfo(e){return Ne(this,void 0,void 0,(function*(){const t=We(e);return yield function(e,t){return je(this,void 0,void 0,(function*(){return Oe("getItem",e)(e.id,t,Be(e))}))}(e,{authentication:t}).then((e=>Ne(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))}))}}var He=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};function qe(e){mt(`to_app.${q.AppConfigChanged}`,e)}function Ve(e){mt(`to_app.${q.AppInfoChanged}`,e)}function Ke(e){mt(`to_app.${q.DialogInfosChanged}`,e)}function Je(e){mt(`to_app.${q.ChangeAppMode}`,e)}function Qe(e){mt(`to_app.${q.ChangePage}`,e)}function Ze(e){mt(`to_app.${q.ChangeDialog}`,e)}function Ye(e){mt(`to_app.${q.ChangeSelection}`,e)}function Xe(e){mt(`to_app.${q.ChangeWidgetStateProp}`,e)}function et(e,t,o){mt(`to_app.${q.UtilityStateChanged}`,{utilityId:e,state:t,isSignInError:o})}function tt(e){mt(`to_app.${q.ChangeWidgetMutableStateProp}`,e)}function ot(e){mt(`to_app.${q.BuilderTriggerKeyboard}`,e)}function it(e){mt(`to_app.${q.ChangeBrowserSizeMode}`,e)}function nt(){mt(`to_app.${q.BuilderSessionChanged}`,r.SessionManager.getInstance().getSessions())}function st(){mt(`to_app.${q.BuilderNoPermissionResourceInfoListChanged}`,r.SessionManager.getInstance().getNoPermissionResourceInfoList())}function at(e){mt(`to_app.${q.ChangeZoomScale}`,e)}function rt(e){mt(`to_app.${q.ActivePagePartChanged}`,e)}function lt(e){mt(`to_app.${q.AnimationPreview}`,e)}function ut(e){mt(`to_app.${q.HoverPreview}`,e)}function dt(e,t){mt(`to_app.${q.SectionNavInfoChanged}`,{sectionId:e,navInfo:t})}function ct(e,t){mt(`to_app.${q.ScreenGroupNavInfoChanged}`,{screenGroupId:e,activeIndex:t})}function pt(e,t){mt(`to_app.${q.TocHoverInfoChanged}`,{layoutInfo:e,hovered:t})}function gt(e){mt(`to_app.${q.SetClientIdAlertIsCancelled}`,{portalUrl:e})}function ht(e){mt(`to_app.${q.OpenCookieBanner}`,{isOpen:e})}function ft(e){mt(`to_app.${q.OpenCookieBannerByPrivacyPanel}`,{isOpen:e})}function yt(e){mt(`to_app.${q.OpenCookieSettingsWindow}`,{isOpen:e})}function mt(e,t){window._builderPubsub.publishSync(e,t)}function vt(){window._builderPubsub.subscribe(`to_builder.${V.AppSessionChanged}`,((e,t)=>{r.SessionManager.getInstance().syncSessionsFromOtherWindow(t)})),window._builderPubsub.subscribe(`to_builder.${V.AppNoPermissionResourceInfoListChanged}`,((e,t)=>{r.SessionManager.getInstance().syncNoPermissionResourceInfoListFromOtherWindow(t)})),window._builderPubsub.subscribe(`to_builder.${V.NeedToCheck498Error}`,((e,t)=>{r.SessionManager.getInstance().handleInvalidToken(t)})),window._builderPubsub.subscribe("to_builder",(function(e,t){console.debug(e,t)})),window._builderPubsub.subscribe(`to_builder.${V.AppStateChanged}`,((e,t)=>{var o;if((0,r.getAppStore)().getState().builder.currentAppId!==t.appId&&((0,r.getAppStore)().dispatch(f.changeCurrentApp(t.appId)),(0,r.getAppStore)().dispatch(G.InBuilderAppConfigClear()),(0,r.getAppStore)().getState().queryObject.id!==t.appId&&r.jimuHistory.changeQueryObject({id:t.appId})),!(0,r.getAppStore)().getState().appStateInBuilder||(0,r.getAppStore)().getState().appStateInBuilder.appConfig!==t.appConfig){const e=t.appConfig,i=null===(o=(0,r.getAppStore)().getState().appStateInBuilder)||void 0===o?void 0:o.appConfig;if(e&&i){if(Object.keys(e.widgets||{}).find((t=>e.widgets[t]&&i.widgets[t]&&e.widgets[t].version!==i.widgets[t].version)))return void(0,r.getAppStore)().dispatch(F.inAppAppStateChanged(t));const o=Object.keys(i.widgets).filter((t=>!e.widgets[t]));(0,r.getAppStore)().dispatch(f.widgetsRemoved(o));const n=Object.keys(e.widgets).filter((e=>!i.widgets[e])).map((t=>({widgetId:t,widgetUri:e.widgets[t].uri})));(0,r.getAppStore)().dispatch(f.widgetsAdded(n))}t.appConfig&&(0,r.getAppStore)().dispatch(G.InBuilderPutAppConfigIntoHistory({appConfig:t.appConfig,appInfo:t.appInfo}))}(0,r.getAppStore)().dispatch(F.inAppAppStateChanged(t))})),window._builderPubsub.subscribe(`to_builder.${V.PopupChooseWidget}`,((e,t)=>{(0,r.getAppStore)().dispatch(f.openChooseWidgetPopup(t.layoutId,t.layoutItemId))})),window._builderPubsub.subscribe(`to_builder.${V.AppAddResource}`,((e,t)=>{const o=Ge.getInstance();Ge.getBlobByBlobUrl(t.file).then((e=>He(this,void 0,void 0,(function*(){t.file=e,o.upLoadAppResource(t),t.type===r.ResourceType.Image&&t.originId&&Ge.getInstance().updateImageResourceItemInfo(t)}))))})),window._builderPubsub.subscribe(`to_builder.${V.AppClearResources}`,((e,t)=>{Ge.getInstance().clearResources(t)})),window._builderPubsub.subscribe(`to_builder.${V.AppTriggerKeyboard}`,((e,t)=>{r.keyboardUtils.triggerEvent(t)})),window._builderPubsub.subscribe(`to_builder.${V.SetLayoutTools}`,((e,t)=>{(0,r.getAppStore)().dispatch(f.setLayoutTools(t))})),window._builderPubsub.subscribe(`to_builder.${V.ClearLastAppConfigFromHistory}`,(e=>{(0,r.getAppStore)().dispatch(G.InBuilderRemoveLastAppConfigFromHistory())})),window._builderPubsub.subscribe(`to_builder.${V.SetIsBusy}`,((e,t)=>{(0,r.getAppStore)().dispatch(r.appActions.setIsBusy(t))})),window._builderPubsub.subscribe(`to_builder.${V.ConfirmDelete}`,((e,t)=>{(0,r.getAppStore)().dispatch(f.confirmDeleteContentChanged(t))})),window._builderPubsub.subscribe(`to_builder.${V.NeedToRegisterClinetId}`,((e,t)=>{(0,r.getAppStore)().dispatch(r.appActions.addToRegisterClientIdList(t.portalUrl,t.needToSignIn,t.serviceUrl,t.forceLogin))})),window._builderPubsub.subscribe(`to_builder.${V.AppIsLoaded}`,((e,t)=>{var o;const i=(0,r.getAppStore)().getState(),n={portalUrl:i.portalUrl,clientId:i.clientId,isWebTier:i.isWebTier};mt(`to_app.${q.SetMainPortal}`,n),(0,r.observeStore)(((e,t)=>{mt(`to_app.${q.SetMainPortal}`,{portalUrl:t})}),["portalUrl"]),(0,r.getAppStore)().getState().portalSelf&&mt(`to_app.${q.PortalSelfChanged}`,(0,r.getAppStore)().getState().portalSelf),(0,r.observeStore)(((e,t)=>{mt(`to_app.${q.PortalSelfChanged}`,t)}),["portalSelf"]),r.portalUtils.getAppInfo(null===(o=(0,r.getAppStore)().getState().queryObject)||void 0===o?void 0:o.id).then((e=>{mt(`to_app.${q.AppInfoChanged}`,e)})),(0,r.getAppStore)().getState().user&&mt(`to_app.${q.UserSignIn}`,(0,r.getAppStore)().getState().user),nt()}))}let St;try{St=window.parent&&window.parent._builderPubsub}catch(e){console.error("Can access parent.")}function It(){if(!St)return;St.unsubscribe("to_app");const e=(0,r.getAppStore)();St.subscribe("to_app",(function(e,t){console.debug(e,t)})),St.subscribe(`to_app.${q.AppConfigChanged}`,(function(t,o){const i=e.getState();if(i.appRuntimeInfo.currentPageId&&!o.pages[i.appRuntimeInfo.currentPageId]){const e=Object.keys(o.pages).find((e=>o.pages[e].isDefault));r.jimuHistory.changePage(e)}e.dispatch(r.appActions.appConfigChanged(o))})),St.subscribe(`to_app.${q.AppInfoChanged}`,(function(t,o){e.dispatch(r.appActions.appInfoChanged(o))})),St.subscribe(`to_app.${q.PortalSelfChanged}`,(function(t,o){if(e.dispatch(r.appActions.setPortalSelf(o)),o&&!o.isPortal){const t=`https://${o.urlKey}.${o.customBaseUrl}`;o.urlKey&&!r.portalUrlUtils.isSamePortalUrl(e.getState().portalUrl,t)&&e.dispatch(r.appActions.setPortalInfo({portalUrl:t}))}})),St.subscribe(`to_app.${q.UserSignIn}`,(function(t,o){e.dispatch(r.appActions.userSignIn(o))})),St.subscribe(`to_app.${q.SetMainPortal}`,(function(t,o){const i=Object.assign({portalUrl:e.getState().portalUrl,clientId:e.getState().clientId,isWebTier:e.getState().isWebTier},o);e.dispatch(r.appActions.setPortalInfo(i))})),St.subscribe(`to_app.${q.DialogInfosChanged}`,(function(t,o){e.dispatch(r.appActions.dialogInfosChanged(o))})),St.subscribe(`to_app.${q.ChangeAppMode}`,(function(t,o){e.dispatch(r.appActions.appModeChanged(o))})),St.subscribe(`to_app.${q.ChangeWidgetStateProp}`,(function(t,o){e.dispatch(r.appActions.widgetStatePropChange(o.widgetId,o.propKey,o.value))})),St.subscribe(`to_app.${q.ChangeWidgetMutableStateProp}`,(function(e,t){r.MutableStoreManager.getInstance().updateStateValue(t.widgetId,t.propKey,t.value)})),St.subscribe(`to_app.${q.ChangePage}`,(function(e,t){const o=(0,r.getAppStore)().getState().appConfig.pages[t];o.type===r.PageType.Link||o.type===r.PageType.Folder||r.urlUtils.parseAppPath(location.pathname,(0,r.getAppStore)().getState().appConfig).pageId===t?(0,r.getAppStore)().dispatch(r.appActions.currentPageChanged(t)):r.jimuHistory.changePage(t)})),St.subscribe(`to_app.${q.ChangeDialog}`,(function(t,o){r.jimuHistory.changeDialog(o),e.dispatch(r.appActions.currentDialogChanged(o))})),St.subscribe(`to_app.${q.ChangeSelection}`,(function(t,o){e.dispatch(r.appActions.selectionChanged(o))})),St.subscribe(`to_app.${q.BuilderTriggerKeyboard}`,(function(e,t){r.keyboardUtils.triggerEvent(t)})),St.subscribe(`to_app.${q.ChangeBrowserSizeMode}`,(function(t,o){e.dispatch(r.appActions.browserSizeModeChanged(o))})),St.subscribe(`to_app.${q.BuilderSessionChanged}`,(function(e,t){r.SessionManager.getInstance().syncSessionsFromOtherWindow(t)})),St.subscribe(`to_app.${q.BuilderNoPermissionResourceInfoListChanged}`,(function(e,t){r.SessionManager.getInstance().syncNoPermissionResourceInfoListFromOtherWindow(t)})),St.subscribe(`to_app.${q.ChangeZoomScale}`,(function(t,o){e.dispatch(r.appActions.zoomScaleChange(o))})),St.subscribe(`to_app.${q.ActivePagePartChanged}`,(function(t,o){e.dispatch(r.appActions.activePagePartChanged(o))})),St.subscribe(`to_app.${q.AnimationPreview}`,(function(t,o){e.dispatch(r.appActions.setupAnimationPreview(o))})),St.subscribe(`to_app.${q.HoverPreview}`,(function(t,o){e.dispatch(r.appActions.setupHoverPreview(o))})),St.subscribe(`to_app.${q.SectionNavInfoChanged}`,(function(t,o){e.dispatch(r.appActions.sectionNavInfoChanged(o.sectionId,o.navInfo)),r.jimuHistory.changeViewBySectionNavInfo(o.sectionId,o.navInfo)})),St.subscribe(`to_app.${q.ScreenGroupNavInfoChanged}`,(function(t,o){e.dispatch(r.appActions.screenGroupNavInfoChanged(o.screenGroupId,o.activeIndex))})),St.subscribe(`to_app.${q.TocHoverInfoChanged}`,(function(e,t){const{layoutInfo:o,hovered:i}=t,{layoutId:n,layoutItemId:s}=o,a=document.querySelector(`div.builder-layout-item[data-layoutid="${n}"][data-layoutitemid="${s}"]`);a&&(i?a.classList.add("hovered"):a.classList.remove("hovered"))})),St.subscribe(`to_app.${q.SetClientIdAlertIsCancelled}`,(function(e,t){r.SessionManager.getInstance().onClientIdDialogFinished(null==t?void 0:t.portalUrl,null,new Error("setting clientId is cancelled."))})),St.subscribe(`to_app.${q.UtilityStateChanged}`,(function(t,o){e.dispatch(r.appActions.utilityStateChange(o.utilityId,o.state,o.isSignInError))})),St.subscribe(`to_app.${q.OpenCookieBannerByPrivacyPanel}`,(function(t,o){const{isOpen:i}=o;e.dispatch(r.appActions.OpenCookieBannerByPrivacyPanel(i))})),St.subscribe(`to_app.${q.OpenCookieSettingsWindow}`,(function(t,o){const{isOpen:i}=o;e.dispatch(r.appActions.OpenCookieSettingsWindow(i))}))}function wt(){Et(`to_builder.${V.AppSessionChanged}`,r.SessionManager.getInstance().getSessions())}function Ct(){Et(`to_builder.${V.AppNoPermissionResourceInfoListChanged}`,r.SessionManager.getInstance().getNoPermissionResourceInfoList())}function bt(e){Et(`to_builder.${V.NeedToCheck498Error}`,e)}function At(){Et(`to_builder.${V.AppStateChanged}`,(0,r.getAppStore)().getState())}function Pt(){Et(`to_builder.${V.AppIsLoaded}`)}function Lt(e,t){Et(`to_builder.${V.PopupChooseWidget}`,{layoutId:e,layoutItemId:t})}function Mt(e){Et(`to_builder.${V.AppAddResource}`,e)}function Dt(e){Et(`to_builder.${V.AppClearResources}`,e)}function xt(e){Et(`to_builder.${V.AppTriggerKeyboard}`,e)}function Tt(e){Et(`to_builder.${V.SetLayoutTools}`,e)}function jt(){Et(`to_builder.${V.ClearLastAppConfigFromHistory}`)}function Ut(e){Et(`to_builder.${V.SetIsBusy}`,e)}function Rt(e){Et(`to_builder.${V.ConfirmDelete}`,e)}function Ot(e,t,o,i){Et(`to_builder.${V.NeedToRegisterClinetId}`,{portalUrl:e,needToSignIn:t,serviceUrl:o,forceLogin:i})}function _t(e){Et(`to_builder.${V.SetSidePanel}`,e)}function kt(){Et(`to_builder.${V.CloseBannerInLiveView}`)}function Et(e,t){St&&St.publishSync(e,t)}class Bt extends r.WidgetManager{static getInstance(){return window.jimuConfig.isBuilder?window._appWindow&&window._appWindow._widgetManager:r.WidgetManager.getInstance()}}class zt{addParentToList(e,t,o){if(!t||0===t.length)return[o];if(!t.some((e=>e.layoutId===o.layoutId&&e.layoutItemId===o.layoutItemId))){const i=t[0].layoutId,n=e.layouts[i],s=e.layouts[o.layoutId];if(i===o.layoutId||s.parent.id!==n.parent.id||s.parent.type!==n.parent.type)return[o];return[].concat(t,o)}return t}removeParentFromList(e,t){return e&&0!==e.length?e.filter((e=>e.layoutId!==t.layoutId||e.layoutItemId!==t.layoutItemId)):[]}}const Wt=r.LayoutType.FixedLayout;class Ft{static getInstance(){return Ft.instance||(Ft.instance=new Ft),Ft.instance}static getService(e,t){var o;const i=e.layouts[t];return Ft.getInstance().getServiceByType(null!==(o=null==i?void 0:i.type)&&void 0!==o?o:Wt)}static getServiceFromSizeModeLayout(e,t){var o;const i=Object.values(t)[0],n=t[e.mainSizeMode];return null!==(o=Ft.getService(e,i))&&void 0!==o?o:Ft.getService(e,n)}constructor(){this.serviceMap=new Map}registerService(e,t){this.serviceMap.set(e,t)}getServiceByType(e){return this.serviceMap.get(null!=e?e:Wt)}}var $t=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};function Nt(e,t,o){const[i]=r.appConfigUtils.parseUniqueLabel(o);let n=r.appConfigUtils.getUniqueLabel(e,t,i);return n===i&&(n=`${i} 1`),n}function Gt(e){return $t(this,void 0,void 0,(function*(){if(!e.config){const t=yield(0,ke.getTemplateConfig)(e.type,e.name);r.appConfigUtils.fixLayoutIds(t),r.utils.replaceI18nPlaceholdersInObject(t,r.i18n.getIntl(),_e),e.config=t}}))}function Ht(e){return qt().find((t=>t.widgetId===e))}function qt(){let e;e=window.jimuConfig.isBuilder?window._appWindow._extensionManager:window._extensionManager;return(null==e?void 0:e.getExtensions(r.extensionSpec.ExtensionPoints.AppConfigOperations))||[]}const Vt=new class{removeDataSource(e,t){var o,i;if(!e.dataSources||!e.dataSources[t])return e;console.debug("removeDataSource",t);let n=e;const s=qt();try{s.forEach((e=>{if(!e.dataSourceWillRemove)return;const o=n.widgets[e.widgetId];o&&o.useDataSources&&o.useDataSources.find((e=>e.dataSourceId===t||e.mainDataSourceId===t))&&(n=e.dataSourceWillRemove(n,t))}))}catch(e){console.error("Error when calling dataSourceWillRemove",e)}return n=n.set("dataSources",n.dataSources.without(t)),Object.entries(null!==(o=n.widgets)&&void 0!==o?o:{}).forEach((([e,o])=>{o.useDataSources&&o.useDataSources.find((e=>this.shouldBeRemoved(e,t)))&&(n=n.setIn(["widgets",e,"useDataSources"],o.useDataSources.filter((e=>!this.shouldBeRemoved(e,t))))),o.outputDataSources&&o.outputDataSources.find((e=>e===t))&&(n=n.setIn(["widgets",e,"outputDataSources"],o.outputDataSources.filter((e=>e!==t))))})),Object.keys(null!==(i=n.messageConfigs)&&void 0!==i?i:{}).forEach((e=>{var o;const i=null===(o=n.messageConfigs[e].actions)||void 0===o?void 0:o.asMutable({deep:!0});null==i||i.forEach(((o,s)=>{var a;(null===(a=null==o?void 0:o.useDataSources)||void 0===a?void 0:a.find((e=>this.shouldBeRemoved(e,t))))&&(i[s].useDataSources=o.useDataSources.filter((e=>!this.shouldBeRemoved(e,t))),n=n.setIn(["messageConfigs",e,"actions"],i))}))})),Object.entries(n.dataSources).forEach((([e,o])=>{o.originDataSources&&o.originDataSources.find((e=>this.shouldBeRemoved(e,t)))&&(n=this.removeDataSource(n,e))})),n}duplicateDataSource(e,t){if(!e.dataSources||!e.dataSources[t])return null;console.debug("duplicate data source",t);const o=e.dataSources[t],i=o.set("id",M(e,"dataSource")).set("label",Nt(e,"dataSource",o.label));return[this.addDataSource(e,i),i]}addDataSource(e,t){return e.dataSources&&e.dataSources[t.id]?e:e.setIn(["dataSources",t.id],t)}updateAfterChangingLayout(e,t,o){if(!e.widgets[t])return e;console.debug(t,"update data source after move to",o);let i=e.widgets[t],n=e;const s=P.searchUtils.getWidgetIdThatUseTheLayoutId(n,o);if(s){const e=n.widgets[s];e.manifest.properties.passDataSourceToChildren&&(i=this.mergeUseDataSource(e,i),n=n.setIn(["widgets",i.id],i))}return n}mergeUseDataSource(e,t){if(!e.useDataSources)return t;const o=e.useDataSources.map((e=>e.without("fields")));return t.useDataSources?(o.forEach((e=>{e.dataViewId?t.useDataSources.find((t=>t.dataSourceId===e.dataSourceId&&t.dataViewId===e.dataViewId))||(t=t.set("useDataSources",t.useDataSources.concat([e]))):t.useDataSources.find((t=>t.dataSourceId===e.dataSourceId))||(t=t.set("useDataSources",t.useDataSources.concat([e])))})),t.set("useDataSourcesEnabled",!0)):t.set("useDataSources",o).set("useDataSourcesEnabled",!0)}shouldBeRemoved(e,t){return!e||e.dataSourceId===t||e.mainDataSourceId===t||e.rootDataSourceId===t}};const Kt=new class{duplicate(e,t,o){const i=e.messageConfigs;if(!i)return[e,null];console.debug("duplicate message configs from",t,"to",o);let n=e,s=null;return Object.keys(i).forEach((e=>{if(i[e].widgetId===t){const t=i[e].set("id",M(n,"messageConfig")).set("widgetId",o);s=t.id,n=n.setIn(["messageConfigs",t.id],t)}if(i[e].actions){const s=[];i[e].actions.forEach((e=>{if(e.widgetId===t){const t=e.set("widgetId",o);s.push(t)}})),s.length>0&&(n=n.setIn(["messageConfigs",i[e].id,"actions"],i[e].actions.concat(s)))}})),[n,s]}removeFromWidget(e,t){const o=e.messageConfigs;if(!o)return e;console.debug("remove message and action in",t);const i=Object.keys(o);let n=(0,r.Immutable)({});for(let e=0;e<i.length;e++)o[i[e]].widgetId!==t&&(n=n.setIn([o[i[e]].id],o[i[e]]));const s=Object.keys(n);for(let e=0;e<s.length;e++){const i=n[s[e]].actions;if(0===i.length)continue;const a=i.filter((e=>e.widgetId!==t)),r=Object.assign([],a);n=n.setIn([o[s[e]].id,"actions"],r)}return e.set("messageConfigs",n)}};const Jt=new class{removeFromWidget(e,t){var o;const i=e.widgets[t];if(!(null===(o=i.manifest)||void 0===o?void 0:o.dataActions)||0===i.manifest.dataActions.length)return e;console.debug("remove data action in",t);const n=i.manifest.dataActions.map((e=>e.name));let s=e;return Object.keys(e.widgets).forEach((o=>{let i=e.widgets[o];i.dataActions&&n.forEach((e=>{var n,a;const r=null===(n=i.dataActions)||void 0===n?void 0:n[e];if(r){const n=null===(a=r.actions)||void 0===a?void 0:a.without(t);0===Object.keys(n||{}).length?(i=i.set("dataActions",i.dataActions.without(e)),0===Object.keys(i.dataActions).length&&(i=i.without("dataActions"))):i=i.setIn(["dataActions",e,"actions"],n),s=s.setIn(["widgets",o],i)}}))})),s}};const Qt=new class{remove(e,t){let o=e;return console.debug("remove used map widgets",t),Object.keys(o.widgets).forEach((e=>{var i;const n=o.widgets[e];if(null===(i=n.useMapWidgetIds)||void 0===i?void 0:i.includes(t)){const i=n.useMapWidgetIds.filter((e=>e!==t));o=o.setIn(["widgets",e,"useMapWidgetIds"],i)}})),o}};var Zt=d(859),Yt=d.n(Zt),Xt=d(850),eo=d.n(Xt),to=d(341),oo=d.n(to),io=d(201),no=d.n(io),so=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};function ao(e){var t,o;return(null==e?void 0:e.widgetType)===r.WidgetType.Layout||null!==(o=null===(t=null==e?void 0:e.properties)||void 0===t?void 0:t.hasEmbeddedLayout)&&void 0!==o&&o}function ro(e){switch(e){case r.LayoutType.FixedLayout:return eo();case r.LayoutType.RowLayout:return oo();case r.LayoutType.ColumnLayout:return no();default:return null}}const lo=new class extends zt{constructor(){super(),this.dsService=Vt,this.messageActionService=Kt,this.dataActionService=Jt,this.useMapService=Qt}createFromTemplate(e,t,o,i,n,s){return so(this,void 0,void 0,(function*(){var a,l;if(n[o]){const s=e.widgets[n[o]];if(!s.layouts)return[e,n[o]];let a=e;const l=t.config.widgets[o];for(let e=0;e<i.length;e++){const u=i[e],d=Object.keys(l.layouts).filter((e=>{var t;return Object.keys(null!==(t=l.layouts[e])&&void 0!==t?t:{}).length>0}));for(let e=0;e<d.length;e++){const i=d[e];if(s.layouts[i][u])continue;const c=l.layouts[i][u],p=Ft.getService(t.config,c),g=yield p.createLayoutFromTemplate(a,t,c,u,r.LayoutParentType.Widget,n[o],n);a=g[0];const h=g[1];null!=h&&(a=a.setIn(["widgets",n[o],"layouts",i,u],h))}}return[a,n[o]]}const u=null!==(a=null==s?void 0:s.isBlock)&&void 0!==a&&a;yield Gt(t);const d=t.config,c=Object.keys(d.widgets).find((e=>"widgets/layout/row/"===d.widgets[e].uri));o=null!=o?o:c;const p=d.widgets[o],g=[],h=yield Bt.getInstance().handleNewWidgetJson({uri:p.uri});h.label=D(e,"widget",h.manifest?h.manifest.i18nMessages._widgetLabel||h.manifest.label||h.manifest.name:"");const f=this.createWidget(e,h,i,!1);let y=f[0];const m=f[1];if(yield Bt.getInstance().registerManifestProps(y.widgets[m]),u){const e=r.i18n.getIntl().formatMessage({id:"block"}),t=D(y,"widget",e);y=y.setIn(["widgets",m,"label"],t)}if(n[o]=m,(null===(l=p.useMapWidgetIds)||void 0===l?void 0:l.length)>0)for(let e=0;e<p.useMapWidgetIds.length;e++){const o=yield this.createFromTemplate(y,t,p.useMapWidgetIds[e],i,n,s);y=o[0],g.push(o[1])}return g.length>0&&(y=y.setIn(["widgets",m,"useMapWidgetIds"],g)),y=yield this.updateWidgetByTemplate(y,t,m,o,i,n),[y,m]}))}updateWidgetByTemplate(e,t,o,i,n,s){return so(this,void 0,void 0,(function*(){var a,l,u;const d=null===(a=null==e?void 0:e.widgets)||void 0===a?void 0:a[o];if(!d)return e;yield Gt(t);let c=e;d.layouts&&Object.keys(d.layouts).forEach((e=>{const t=d.layouts[e];Object.keys(t).forEach((e=>{const o=t[e],i=Ft.getService(c,o);c=i.removeLayout(c,o,e)}))})),c=c.setIn(["widgets",o],d.without("layouts"));const p=null==t?void 0:t.config,g=null===(l=null==p?void 0:p.widgets)||void 0===l?void 0:l[i],h=[];if(g&&(g.config&&(c=c.setIn(["widgets",o,"config"],g.config)),g.style&&(c=c.setIn(["widgets",o,"style"],g.style)),g.layouts)){const o=g.layouts,i=[];Object.keys(o).forEach((t=>{var s,a;const r=o[t]||{},l=(null!==(a=null===(s=d.manifest)||void 0===s?void 0:s.layouts)&&void 0!==a?a:[]).find((e=>e.name===t));n.forEach((o=>{var n;const s=null!==(n=r[o])&&void 0!==n?n:r[e.mainSizeMode];s&&i.push({layoutName:t,sizeMode:o,layoutId:s,layoutLabel:null==l?void 0:l.label})}))}));for(let e=0;e<i.length;e+=1){const{layoutName:o,sizeMode:n,layoutId:a,layoutLabel:l}=i[e],g=Ft.getService(p,a),f=yield g.createLayoutFromTemplate(c,t,a,n,r.LayoutParentType.Widget,d.id,s);c=f[0];const y=f[1];h.push(y),c=c.setIn(["widgets",d.id,"layouts",o,n],y).setIn(["layouts",y,"label"],(null===(u=null==d?void 0:d.manifest)||void 0===u?void 0:u.i18nMessages[`_layout_${o}_label`])||l||o)}}return c}))}createWidget(e,t,o,i=!0){let n=e;const s=M(e,"widget");if(console.debug("createWidget",t),n=n.setIn(["widgets",s],t).setIn(["widgets",s,"id"],s),i&&ao(t.manifest)){(t.manifest.layouts||[]).forEach((e=>{o.forEach((o=>{const i=Ft.getInstance().getServiceByType(e.type).createBlankLayout(n,e.type);n=i[0];const a=i[1];console.debug("embed layout",e.name,a,e.type,"created in",o),n=n.setIn(["layouts",a,"label"],t.manifest.i18nMessages[`_layout_${e.name}_label`]||e.label).setIn(["layouts",a,"parent"],{id:s,type:r.LayoutParentType.Widget}).setIn(["widgets",s,"layouts",e.name,o],a)}))}))}return[n,s]}duplicateEmbedLayout(e,t,o,i){var n;const s=e.widgets[t];if(!s||!s.layouts)return[e,null];let a=e;if(console.debug("duplicate layout of widget",t),(null===(n=s.manifest)||void 0===n?void 0:n.widgetType)===r.WidgetType.Layout&&o!==i){console.debug("deuplicate layout widget and its layout from",o,"to",i);const t=s.set("id",M(e,"widget")).without("layouts").without("parent");return a=a.setIn(["widgets",t.id],t),Object.keys(s.layouts).forEach((e=>{const n=s.layouts[e];if(n[o]){const s=Ft.getService(a,n[o]).duplicateLayout(a,n[o],o,i,null,!1);a=s[0];const l=s[1];null!=l&&(a=a.setIn(["layouts",l,"parent"],{type:r.LayoutParentType.Widget,id:t.id}).setIn(["widgets",t.id,"layouts",e,i],l))}})),[a,t.id]}return console.debug("duplicate widget layout only from",o,"to",i),Object.keys(s.layouts).forEach((e=>{const n=s.layouts[e];if(n[o]&&o!==i){const s=Ft.getService(a,n[o]);n[i]&&(a=s.removeLayout(a,n[i],i));const l=s.duplicateLayout(a,n[o],o,i,null,!1);a=l[0];const u=l[1];null!=u&&(a=a.setIn(["layouts",u,"parent"],{type:r.LayoutParentType.Widget,id:t}).setIn(["widgets",t,"layouts",e,i],u))}})),[a,null]}duplicate(e,t,o,i){console.debug("duplicate a widget",t);const n=e.widgets[t];if(!n)return[e,null];if(null==i?void 0:i[t]){const n=e.widgets[i[t]];if(!n.layouts)return[e,i[t]];const s=Object.keys(n.layouts)[0];if(n.layouts[s][o])return[e,i[t]];const a=e.widgets[t];let l=e;return Object.keys(a.layouts).forEach((e=>{const n=a.layouts[e][o],s=Ft.getService(l,n).duplicateLayout(l,n,o,o,i,!0);l=s[0];const u=s[1];null!=u&&(l=l.setIn(["widgets",i[t],"layouts",e,o],u).setIn(["layouts",u,"parent"],{type:r.LayoutParentType.Widget,id:i[t]}))})),[l,i[t]]}const s=n.set("id",M(e,"widget")).set("label",Nt(e,"widget",n.label)),a=this.beforeDuplicated(e,t,s,o,i);return i&&(i[t]=s.id),[a,s.id]}tryRemove(e,t,o,i){var n,s,a;const l=null===(n=e.widgets)||void 0===n?void 0:n[t];if(!l)return e;const u=[r.BrowserSizeMode.Large,r.BrowserSizeMode.Medium,r.BrowserSizeMode.Small].filter((e=>e!==i)).some((e=>{var t,o;return(null===(o=null===(t=l.parent)||void 0===t?void 0:t[e])||void 0===o?void 0:o.length)>0})),d=(null===(a=null===(s=l.parent)||void 0===s?void 0:s[i])||void 0===a?void 0:a.length)>1;if(u||d){let n=this.removeParent(e,t,o,i);return l.layouts&&Object.keys(l.layouts).forEach((e=>{const o=l.layouts[e];if(o[i]){const s=Ft.getServiceFromSizeModeLayout(n,o);n=s.removeSizeModeLayouts(n,{[i]:o[i]}),n=n.setIn(["widgets",t,"layouts",e],o.without(i))}})),n}return this.remove(e,t)}remove(e,t){var o;if(!(null===(o=e.widgets)||void 0===o?void 0:o[t]))return e;console.debug("remove a widget",t);const i=this.beforeRemoved(e,t);return i.set("widgets",i.widgets.without(t))}toTocNode(e,t,o,i){var n,s,a,l;const{layoutId:u,layoutItemId:d}=o,c={label:"",layoutId:u,layoutItemId:d,type:"widget",id:t},p=null===(n=e.widgets)||void 0===n?void 0:n[t];if(!p)return null==t&&(c.label=r.i18n.getIntl().formatMessage({id:"placeholder"}),c.icon=Yt(),c.flipIcon=!1,c.isLabelReadOnly=!0),c;if(c.label=p.label,c.icon=p.icon,c.flipIcon=null!==(l=null===(a=null===(s=p.manifest)||void 0===s?void 0:s.properties)||void 0===a?void 0:a.flipIcon)&&void 0!==l&&l,!(null==p?void 0:p.layouts))return c;const g=[],h=1===Object.keys(p.layouts).length;return Object.keys(p.layouts).forEach((t=>{var o,n,s,a;const r=null!==(o=p.layouts[t][i])&&void 0!==o?o:p.layouts[t][e.mainSizeMode],l=Ft.getService(e,r).getTocStructure(e,r);if(l.length>0){const o=e.layouts[r].type,i=null===(s=null===(n=p.manifest)||void 0===n?void 0:n.layouts)||void 0===s?void 0:s.find((e=>e.name===t));g.push({label:h?"":null!=i?null!==(a=p.manifest.i18nMessages[`_layout_${t}_label`])&&void 0!==a?a:i.label:t,icon:ro(o),type:"layout",id:r,isLabelReadOnly:!0,children:l})}})),1===g.length?c.children=g[0].children:g.length>1&&(c.children=g),c}afterMoved(e,t,o,i){return e.widgets[t]?(console.debug("update widget",t,"ds after moved to a new layout",i),this.dsService.updateAfterChangingLayout(e,t,i)):e}afterAdded(e,t,o,i,n){var s;const a=e.widgets[t];if(!a)return e;console.debug("after added, update widget",t,"added to a new layout",o,"from",i,"to",n);let l=this.dsService.updateAfterChangingLayout(e,t,o);return Object.keys(null!==(s=a.layouts)&&void 0!==s?s:{}).forEach((e=>{const o=a.layouts[e];if(o[i]&&!o[n]){const s=l.layouts[o[i]],a=Ft.getService(l,o[i]).duplicateLayout(l,s.id,i,n,null);l=a[0];const u=a[1];null!=u&&(l=l.setIn(["layouts",u,"parent"],{type:r.LayoutParentType.Widget,id:t}).setIn(["widgets",t,"layouts",e,n],u))}})),l}beforeRemoved(e,t){var o,i,n;const s=e.widgets[t];let a=e;if(console.debug("clear widget resource before removing",t),Object.keys(null!==(o=s.parent)&&void 0!==o?o:{}).forEach((e=>{s.parent[e].length>0&&s.parent[e].forEach((t=>{if(a.layouts[t.layoutId]){const o=Ft.getService(a,t.layoutId);a=o.removeItem(a,t,e,!1)}}))})),s.outputDataSources&&s.outputDataSources.forEach((e=>{a=this.dsService.removeDataSource(a,e)})),a=this.messageActionService.removeFromWidget(a,t),a=this.dataActionService.removeFromWidget(a,t),s.layouts&&Object.keys(s.layouts).forEach((e=>{const t=s.layouts[e],o=Ft.getServiceFromSizeModeLayout(a,t);a=o.removeSizeModeLayouts(a,t)})),null===(n=null===(i=s.manifest)||void 0===i?void 0:i.properties)||void 0===n?void 0:n.canCreateMapView){const e=qt();try{e.forEach((e=>{if(!e.mapWidgetWillRemove)return;if(e.widgetId===t)return;const o=a.widgets[e.widgetId];o&&o.useMapWidgetIds&&o.useMapWidgetIds.find((e=>e===t))&&(a=e.mapWidgetWillRemove(a,t))}))}catch(e){console.error("Error when calling mapWidgetWillRemove",e)}a=this.useMapService.remove(a,s.id)}const r=Ht(t);if(r&&r.widgetWillRemove)try{a=r.widgetWillRemove(a)}catch(e){console.error("Error when calling widgetWillRemove",e)}return a}beforeDuplicated(e,t,o,i,n){var s,a,l;let u=e;if(console.debug("process before duplicate widget",t),ao(o.manifest)&&(u=u.setIn(["widgets",o.id],o),Object.keys(null!==(s=o.layouts)&&void 0!==s?s:{}).forEach((t=>{var s;const a=o.layouts[t],l=null!=n?n:{},d=Ft.getServiceFromSizeModeLayout(u,a).duplicateSizeModeLayouts(u,{[i]:null!==(s=a[i])&&void 0!==s?s:a[e.mainSizeMode]},r.LayoutParentType.Widget,o.id,l);u=d[0],o=o.setIn(["layouts",t],d[1])}))),u=this.messageActionService.duplicate(u,t,o.id)[0],(null===(a=o.outputDataSources)||void 0===a?void 0:a.length)>0){const e=o.outputDataSources.map((e=>{const t=this.dsService.duplicateDataSource(u,e);u=t[0];return t[1].id}));o=o.set("outputDataSources",e);let t=JSON.stringify(o.config);e.forEach(((e,i)=>{const n=o.outputDataSources[i],s=new RegExp(n,"g");t=t.replace(s,e)}));try{const e=JSON.parse(t);o=o.set("config",e)}catch(e){console.error("JSON format error",o)}}return(null===(l=o.useMapWidgetIds)||void 0===l?void 0:l.length)>0&&o.useMapWidgetIds.forEach(((e,t)=>{(null==n?void 0:n[e])&&(o=o.setIn(["useMapWidgetIds",t],n[e]))})),u=u.setIn(["widgets",o.id],o),u}afterBatchCopied(e,t,o){let i=e;return Object.keys(null!=o?o:{}).forEach((n=>{const s=o[n];if(t.widgets[n]&&i.widgets[s]){let a;if(e===t){if(a=Ht(n),a&&a.afterWidgetCopied)try{i=a.afterWidgetCopied(n,t,s,i,o)}catch(e){console.error("Error when calling afterWidgetCopied",e)}}else if(a=Ht(s),a&&a.afterWidgetCopied)try{i=a.afterWidgetCopied(n,t,s,i,o)}catch(e){console.error("Error when calling afterWidgetCopied",e)}}})),i}addParent(e,t,o,i){var n;const s=e.widgets[t];if(!s)return e;console.debug("add parent",o.layoutId,o.layoutItemId,"to widget",t,"in",i);const a=this.addParentToList(e,null===(n=s.parent)||void 0===n?void 0:n[i],o);return e.setIn(["widgets",t,"parent",i],a)}removeParent(e,t,o,i){const n=e.widgets[t];if(!n||null==n.parent)return e;if(console.debug("remove parent",o.layoutId,o.layoutItemId,"from widget",t,"in",i),i){const s=n.parent[i],a=this.removeParentFromList(s,o);return 0===a.length?e.setIn(["widgets",t,"parent"],n.parent.without(i)):e.setIn(["widgets",t,"parent",i],a)}let s=e;return Object.keys(n.parent).forEach((e=>{const i=n.parent[e],a=this.removeParentFromList(i,o);s=0===a.length?s.setIn(["widgets",t,"parent"],n.parent.without(e)):s.setIn(["widgets",t,"parent",e],a)})),s}clearParent(e,t){const o=e.widgets[t];return o&&null!=o.parent?e.setIn(["widgets",t],o.without("parent")):e}removeSizeModeParent(e,t,o){var i;const n=e.widgets[t];return n&&null!=(null===(i=n.parent)||void 0===i?void 0:i[o])?e.setIn(["widgets",t,"parent"],n.parent.without(o)):e}findParent(e,t,o){var i,n;const s=e.widgets[t];if(!s||!s.parent)return null;const a=null!==(i=s.parent[o])&&void 0!==i?i:s.parent[e.mainSizeMode];if(!a)return null;if(1===a.length)return a[0];const r=a[0].layoutId,l=e.layouts[r];return this.findParent(e,null===(n=l.parent)||void 0===n?void 0:n.id,o)}hasParent(e,t,o){var i,n;const s=e.widgets[t];return!(!s||!s.parent)&&(null===(n=null===(i=s.parent)||void 0===i?void 0:i[o])||void 0===n?void 0:n.length)>0}hasMultipleParents(e,t,o){var i,n;const s=e.widgets[t];return!(!s||!s.parent)&&(null===(n=null===(i=s.parent)||void 0===i?void 0:i[o])||void 0===n?void 0:n.length)>1}};var uo=d(736),co=d.n(uo),po=d(606),go=d.n(po),ho=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};const fo=new class extends zt{createFromTemplate(e,t,o,i,n){return ho(this,void 0,void 0,(function*(){if(n[o]){const s=e.sections[n[o]],a=e.views[s.views[0]],l=t.config.sections[o];let u=e;for(let e=0;e<i.length;e++){const o=i[e];if(!a.layout[o])for(let e=0;e<l.views.length;e++){const i=l.views[e],s=t.config.views[i].layout[o],a=Ft.getService(t.config,s),d=yield a.createLayoutFromTemplate(u,t,s,o,r.LayoutParentType.View,n[i],n);u=d[0];const c=d[1];null!=c&&(u=u.setIn(["views",n[i],"layout",o],c))}}return[u,n[o]]}yield Gt(t);let s=e;const a=t.config.sections[o],l=M(e,"section");s=s.setIn(["sections",l],a).setIn(["sections",l,"id"],l).setIn(["sections",l,"label"],D(e,"section",r.i18n.getIntl().formatMessage({id:"section"})));const u=[];for(let e=0;e<a.views.length;e+=1){const o=a.views[e],r=yield this.createViewFromTemplate(s,t,o,i,n);s=r[0],u.push(r[1]),s=s.setIn(["views",r[1],"parent"],l)}return s=s.setIn(["sections",l,"views"],u),n[o]=l,[s,l]}))}createViewFromTemplate(e,t,o,i,n){return ho(this,void 0,void 0,(function*(){let i=e;yield Gt(t);const s=t.config,a=s.views[o],l=M(e,"view");i=i.setIn(["views",l],a).setIn(["views",l,"id"],l).setIn(["views",l,"label"],D(e,"view",r.i18n.getIntl().formatMessage({id:"view"})));const u=[];Object.keys(a.layout||{}).forEach((e=>{u.push({sizeMode:e,layoutId:a.layout[e]})}));for(let e=0;e<u.length;e+=1){const{sizeMode:o,layoutId:a}=u[e],d=Ft.getService(s,a),c=yield d.createLayoutFromTemplate(i,t,a,o,r.LayoutParentType.View,l,n);i=c[0];const p=c[1];i=i.setIn(["views",l,"layout",o],p)}return n&&(n[o]=l),[i,l]}))}duplicateEmbedLayout(e,t,o,i){var n;const s=null===(n=e.sections)||void 0===n?void 0:n[t];if(!s)return[e,null];let a=e;return console.debug(`duplicate section ${t} from ${o} to ${i}`),s.views.forEach((e=>{const t=a.views[e].layout;if(t[o]&&!t[i]){const n=Ft.getService(a,t[o]).duplicateLayout(a,t[o],o,i,null,!1);a=n[0];const s=n[1];null!=s&&(a=a.setIn(["layouts",s,"parent"],{type:r.LayoutParentType.View,id:e}).setIn(["views",e,"layout",i],s))}})),[a,null]}duplicate(e,t,o,i){var n;console.debug("dplicate section",t,"in",o);const s=null===(n=e.sections)||void 0===n?void 0:n[t];if(!s)return[e,null];if(null==i?void 0:i[t]){const n=e.sections[i[t]];if(e.views[n.views[0]].layout[o])return[e,i[t]];const s=e.sections[t];let a=e;return s.views.forEach((e=>{const t=a.views[e].layout[o],n=Ft.getService(a,t).duplicateLayout(a,t,o,o,i,!0);a=n[0];const s=n[1];null!=s&&(a=a.setIn(["views",i[e],"layout",o],s).setIn(["layouts",s,"parent"],{type:r.LayoutParentType.View,id:i[e]}))})),[a,i[t]]}let a=s.set("id",M(e,"section")).set("label",Nt(e,"section",s.label)),l=e.setIn(["sections",a.id],a);const u=s.views.map((e=>{const t=this.duplicateView(l,s.id,e,[o],!1,i);l=t[0];const n=t[1];return l=l.setIn(["views",n,"parent"],a.id),n}));return a=a.set("views",u),l=l.setIn(["sections",a.id],a),i&&(i[t]=a.id),[l,a.id]}removeDirectly(e,t){var o;const i=null===(o=e.sections)||void 0===o?void 0:o[t];let n=e;return i.views.forEach((e=>{const t=n.views[e],o=Ft.getServiceFromSizeModeLayout(n,t.layout);n=o.removeSizeModeLayouts(n,t.layout),n=n.set("views",n.views.without(e))})),n=n.set("sections",n.sections.without(t)),n}tryRemove(e,t,o,i){var n;const s=null===(n=e.sections)||void 0===n?void 0:n[t];if(!s)return e;console.debug(`remove section ${t} from ${o.layoutId} ${o.layoutItemId}`,i);const a=[r.BrowserSizeMode.Large,r.BrowserSizeMode.Medium,r.BrowserSizeMode.Small].filter((e=>e!==i)).some((e=>{var t,o;return(null===(o=null===(t=s.parent)||void 0===t?void 0:t[e])||void 0===o?void 0:o.length)>0}));if(a){let n=this.removeParent(e,t,o,i);return s.views.forEach((e=>{const t=n.views[e];if(t.layout[i]){const o=Ft.getServiceFromSizeModeLayout(n,t.layout);n=o.removeSizeModeLayouts(n,{[i]:t.layout[i]}),n=n.setIn(["views",e,"layout"],t.layout.without(i))}})),n}return this.remove(e,t)}remove(e,t){var o,i;const n=null===(o=e.sections)||void 0===o?void 0:o[t];if(!n)return e;console.debug("remove section",t);let s=e;return Object.keys(null!==(i=n.parent)&&void 0!==i?i:{}).forEach((e=>{n.parent[e].length>0&&n.parent[e].forEach((t=>{if(s.layouts[t.layoutId]){const o=Ft.getService(s,t.layoutId);s=o.removeItem(s,t,e,!1)}}))})),this.removeDirectly(s,t)}toTocNode(e,t,o,i){var n,s;const{layoutId:a,layoutItemId:r}=o,l={label:"",layoutId:a,layoutItemId:r,type:"section",id:t,children:[]},u=null===(n=e.sections)||void 0===n?void 0:n[t];return u?(l.label=u.label,l.icon=null!==(s=u.icon)&&void 0!==s?s:co(),l.flipIcon=!0,u.views.forEach((t=>{var o,n;const s=e.views[t],a=null!==(o=s.layout[i])&&void 0!==o?o:s.layout[e.mainSizeMode],r=Ft.getService(e,a).getTocStructure(e,a);l.children.push({label:s.label,icon:null!==(n=s.icon)&&void 0!==n?n:go(),flipIcon:!1,type:"view",id:t,children:r})})),l):l}afterMoved(e,t,o,i){return e}afterAdded(e,t,o,i,n){var s;const a=null===(s=e.sections)||void 0===s?void 0:s[t];if(!a)return e;let l=e;return a.views.forEach((e=>{const t=l.views[e];if(t.layout[i]&&!t.layout[n]){const o=l.layouts[t.layout[i]],s=Ft.getService(l,t.layout[i]).duplicateLayout(l,o.id,i,n,null);l=s[0];const a=s[1];null!=a&&(l=l.setIn(["layouts",a,"parent"],{type:r.LayoutParentType.View,id:e}).setIn(["views",e,"layout",n],a))}})),l}addParent(e,t,o,i){var n;const s=e.sections[t];if(!s)return e;console.debug("add parent",o.layoutId,o.layoutItemId,"to section",t,"in",i);const a=this.addParentToList(e,null===(n=s.parent)||void 0===n?void 0:n[i],o);return e.setIn(["sections",t,"parent",i],a)}removeParent(e,t,o,i){const n=e.sections[t];if(!n||null==n.parent)return e;if(console.debug("remove parent",o.layoutId,o.layoutItemId,"from section",t,"in",i),i){const s=n.parent[i],a=this.removeParentFromList(s,o);return 0===a.length?e.setIn(["sections",t,"parent"],n.parent.without(i)):e.setIn(["sections",t,"parent",i],a)}let s=e;return Object.keys(n.parent).forEach((e=>{const i=n.parent[e],a=this.removeParentFromList(i,o);s=0===a.length?s.setIn(["sections",t,"parent"],n.parent.without(e)):s.setIn(["sections",t,"parent",e],a)})),s}clearParent(e,t){const o=e.sections[t];return o&&null!=o.parent?e.setIn(["sections",t],o.without("parent")):e}removeSizeModeParent(e,t,o){var i;const n=e.sections[t];return n&&null!=(null===(i=n.parent)||void 0===i?void 0:i[o])?e.setIn(["sections",t,"parent"],n.parent.without(o)):e}findParent(e,t,o){var i,n;const s=e.sections[t];if(!s.parent)return null;const a=null!==(i=s.parent[o])&&void 0!==i?i:s.parent[e.mainSizeMode];if(!a)return null;if(1===a.length)return a[0];const r=a[0].layoutId,l=e.layouts[r];return lo.findParent(e,null===(n=l.parent)||void 0===n?void 0:n.id,o)}hasParent(e,t,o){var i;const n=e.sections[t];return!!n.parent&&(null===(i=n.parent[o])||void 0===i?void 0:i.length)>0}hasMultipleParents(e,t,o){var i;const n=e.sections[t];return!!n.parent&&(null===(i=n.parent[o])||void 0===i?void 0:i.length)>0}createSection(e,t){console.debug("create a blank section",t);const o=M(e,"section"),i={id:o,label:D(e,"section",r.i18n.getIntl().formatMessage({id:"section"})),views:[]};let n=e.setIn(["sections",i.id],i);return n=this.addView(n,o,t)[0],[n,o]}createBlankView(e,t){return{id:M(e,"view"),parent:t,label:D(e,"view",r.i18n.getIntl().formatMessage({id:"view"}))}}addView(e,t,o){var i;const n=null===(i=e.sections)||void 0===i?void 0:i[t];if(!n)return[e,null];let s;const a=this.createBlankView(e,t);n.views?(s=n.views.asMutable(),s.push(a.id)):s=[a.id];let l=e.setIn(["views",a.id],a).setIn(["sections",t,"views"],s);return o.forEach((e=>{const t={id:M(l,"layout"),type:r.LayoutType.FixedLayout,content:{},parent:{id:a.id,type:r.LayoutParentType.View}};l=l.setIn(["layouts",t.id],t).setIn(["views",a.id,"layout",e],t.id)})),[l,a.id]}duplicateView(e,t,o,i,n,s){if(!e.views||!e.views[o])return[e,null];console.debug("duplicate a view",o,"in",i);let a=e.views[o].set("id",M(e,"view"));a=a.set("label",Nt(e,"view",a.label)),n||(a=a.without("parent"));let l=e.setIn(["views",a.id],a);const u={};i.forEach((e=>{u[e]=a.layout[e]}));const d=null!=s?s:{},c=Ft.getServiceFromSizeModeLayout(l,u).duplicateSizeModeLayouts(l,u,r.LayoutParentType.View,a.id,d);if(l=c[0],a=a.set("layout",c[1]),l=l.setIn(["views",a.id],a),n){const e=l.sections[t].views.asMutable(),i=e.indexOf(o);e.splice(i,1,o,a.id),l=l.setIn(["sections",t,"views"],e)}return s&&(s[o]=a.id),[l,a.id]}removeView(e,t,o){var i,n;const s=null===(i=e.sections)||void 0===i?void 0:i[t],a=null===(n=e.views)||void 0===n?void 0:n[o];if(!a||!s||1===s.views.length||!s.views.includes(o))return e;console.debug("remove a view",o,"from",t);const r=s.views.filter((e=>e!==o));let l=e.setIn(["sections",t,"views"],r);return l=Ft.getServiceFromSizeModeLayout(l,a.layout).removeSizeModeLayouts(l,a.layout),l=l.set("views",l.views.without(o)),l}};var yo=d(218),mo=d.n(yo),vo=d(528),So=d.n(vo),Io=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};const wo=new class extends zt{createFromTemplate(e,t,o,i,n){return Io(this,void 0,void 0,(function*(){if(n[o])return[e,n[o]];let s=e;console.debug("create screen group",o,"from template in",i),yield Gt(t);const a=t.config;o=null!=o?o:Object.keys(a.screenGroups)[0];const l=a.screenGroups[o],u=M(e,"screenGroup");s=s.setIn(["screenGroups",u],l).setIn(["screenGroups",u,"id"],u).setIn(["screenGroups",u,"label"],D(e,"screenGroup",r.i18n.getIntl().formatMessage({id:"screenGroup"})));const d=[];for(let e=0;e<l.screens.length;e+=1){const o=l.screens[e],a=yield this.createScreenFromTemplate(s,t,o,i,n);s=a[0],d.push(a[1]),s=s.setIn(["screens",a[1],"parent"],u)}return s=s.setIn(["screenGroups",u,"screens"],d),n[o]=u,[s,u]}))}createScreenFromTemplate(e,t,o,i,n){return Io(this,void 0,void 0,(function*(){var s,a,l;let u=e;console.debug("create screen",o,"from template in",i),yield Gt(t);const d=t.config;o=null!=o?o:Object.keys(d.screens)[0];const c=d.screens[o],p=M(e,"screen");u=u.setIn(["screens",p],c).setIn(["screens",p,"id"],p).setIn(["screens",p,"label"],D(e,"screen",r.i18n.getIntl().formatMessage({id:"screen"})));const g=[];Object.keys(null!==(a=null===(s=c.panel)||void 0===s?void 0:s.layout)&&void 0!==a?a:{}).forEach((e=>{g.push({sizeMode:e,isSide:!0,layoutId:c.panel.layout[e]})})),Object.keys(null!==(l=c.main.layout)&&void 0!==l?l:{}).forEach((e=>{g.push({sizeMode:e,isSide:!1,layoutId:c.main.layout[e]})}));for(let e=0;e<g.length;e+=1){const{sizeMode:o,layoutId:i,isSide:s}=g[e],a=Ft.getService(d,i),l=yield a.createLayoutFromTemplate(u,t,i,o,r.LayoutParentType.Screen,p,n);u=l[0];const c=l[1];u=u.setIn(["layouts",c,"parent"],{type:r.LayoutParentType.Screen,id:p}),u=s?u.setIn(["screens",p,"panel","layout",o],c):u.setIn(["screens",p,"main","layout",o],c)}return[u,p]}))}duplicateEmbedLayout(e,t,o,i){var n;const s=null===(n=e.screenGroups)||void 0===n?void 0:n[t];if(!s)return[e,null];let a=e;return s.screens.forEach((e=>{var t;const n=a.screens[e],s=n.main.layout;if(s[o]&&!s[i]){const t=Ft.getService(a,s[o]).duplicateLayout(a,s[o],o,i,null,!1);a=t[0];const n=t[1];null!=t[1]&&(a=a.setIn(["layouts",n,"parent"],{type:r.LayoutParentType.Screen,id:e}).setIn(["screens",e,"main","layout",i],n))}const l=null===(t=n.panel)||void 0===t?void 0:t.layout;if(l&&l[o]&&!l[i]){const t=Ft.getService(a,l[o]).duplicateLayout(a,l[o],o,i,null,!1);a=t[0];const n=t[1];null!=t[1]&&(a=a.setIn(["layouts",n,"parent"],{type:r.LayoutParentType.Screen,id:e}).setIn(["screens",e,"panel","layout",i],n))}})),[a,null]}duplicate(e,t,o,i){var n;const s=null===(n=e.screenGroups)||void 0===n?void 0:n[t];if(!s)return[e,null];if(null==i?void 0:i[t]){const n=e.screenGroups[i[t]];if(e.screens[n.screens[0]].main.layout[o])return[e,i[t]];{const n=e.screenGroups[t];let s=e;return n.screens.forEach((e=>{var t;const n=s.screens[e],a=n.main.layout[o],l=Ft.getService(s,a).duplicateLayout(s,a,o,o,i,!0);s=l[0];const u=l[1];if(null!=u&&(s=s.setIn(["screens",i[e],"main","layout",o],u).setIn(["layouts",u,"parent"],{type:r.LayoutParentType.Screen,id:i[e]})),null===(t=n.panel)||void 0===t?void 0:t.layout){const t=n.panel.layout[o],a=Ft.getService(s,t).duplicateLayout(s,t,o,o,i,!0);s=a[0];const l=a[1];null!=l&&(s=s.setIn(["screens",i[e],"panel","layout",o],l).setIn(["layouts",l,"parent"],{type:r.LayoutParentType.Screen,id:i[e]}))}})),[s,i[t]]}}console.debug("duplicate screen group",t,"to",o);let a=s.set("id",M(e,"screenGroup")).set("label",Nt(e,"screenGroup",s.label)),l=e.setIn(["screenGroups",a.id],a);const u=s.screens.map((e=>{const t=this.duplicateScreen(l,s.id,e,[o],!1,i);l=t[0];const n=t[1];return l=l.setIn(["screens",n,"parent"],a.id),n}));return a=a.set("screens",u),l=l.setIn(["screenGroups",a.id],a),i&&(i[t]=a.id),[l,a.id]}tryRemove(e,t,o,i){var n;const s=null===(n=e.screenGroups)||void 0===n?void 0:n[t];if(!s)return e;console.debug(`try remove screenGroup ${t} from ${o.layoutId} ${o.layoutItemId}`,i);const a=[r.BrowserSizeMode.Large,r.BrowserSizeMode.Medium,r.BrowserSizeMode.Small].filter((e=>e!==i)).some((e=>{var t;return null!=(null===(t=s.parent)||void 0===t?void 0:t[e])}));if(a){let n=this.removeParent(e,t,o,i);return s.screens.forEach((e=>{var t;const o=n.screens[e];if(o.main.layout[i]){const t=Ft.getServiceFromSizeModeLayout(n,o.main.layout);n=t.removeSizeModeLayouts(n,{[i]:o.main.layout[i]}),n=n.setIn(["screens",e,"main","layout"],o.main.layout.without(i))}if(null===(t=o.panel)||void 0===t?void 0:t.layout[i]){const t=Ft.getServiceFromSizeModeLayout(n,o.panel.layout);n=t.removeSizeModeLayouts(n,{[i]:o.panel.layout[i]}),n=n.setIn(["screens",e,"panel","layout"],o.panel.layout.without(i))}})),n}return this.remove(e,t)}remove(e,t){var o,i;const n=null===(o=e.screenGroups)||void 0===o?void 0:o[t];if(!n)return e;let s=e;return console.debug("remove screen group",t),Object.keys(null!==(i=n.parent)&&void 0!==i?i:{}).forEach((e=>{const{layoutId:t}=n.parent[e];if(s.layouts[t]){const o=Ft.getService(s,t);s=o.removeItem(s,n.parent[e],e,!1)}})),n.screens.forEach((e=>{var t;const o=s.screens[e],i=Ft.getServiceFromSizeModeLayout(s,o.main.layout);if(s=i.removeSizeModeLayouts(s,o.main.layout),null===(t=o.panel)||void 0===t?void 0:t.layout){const e=Ft.getServiceFromSizeModeLayout(s,o.panel.layout);s=e.removeSizeModeLayouts(s,o.panel.layout)}s=s.set("screens",s.screens.without(e))})),s=s.set("screenGroups",s.screenGroups.without(t)),s}toTocNode(e,t,o,i){var n,s;const{layoutId:a,layoutItemId:l}=o,u={label:"",layoutId:a,layoutItemId:l,type:"screenGroup",id:t,children:[]},d=null===(n=e.screenGroups)||void 0===n?void 0:n[t];return d?(u.label=d.label,u.icon=null!==(s=d.icon)&&void 0!==s?s:So(),u.flipIcon=!1,d.screens.forEach((t=>{var o,n,s;const a=e.screens[t],l={label:a.label,icon:mo(),flipIcon:!1,type:"screen",id:t,children:[]},d=null!==(o=a.main.layout[i])&&void 0!==o?o:a.main.layout[e.mainSizeMode],c=Ft.getService(e,d).getTocStructure(e,d);if(l.children.push({label:r.i18n.getIntl().formatMessage({id:"mainStage"}),isLabelReadOnly:!0,type:"layout",id:d,children:c}),null===(n=a.panel)||void 0===n?void 0:n.layout){const t=null!==(s=a.panel.layout[i])&&void 0!==s?s:a.panel.layout[e.mainSizeMode],o=Ft.getService(e,t).getTocStructure(e,t);l.children.push({label:r.i18n.getIntl().formatMessage({id:"scrollingPanel"}),isLabelReadOnly:!0,type:"layout",id:t,children:o})}u.children.push(l)})),u):u}afterMoved(e,t,o,i){return e}afterAdded(e,t,o,i,n){var s;const a=null===(s=e.screenGroups)||void 0===s?void 0:s[t];if(!a)return e;let l=e;return a.screens.forEach((e=>{var t,o;const s=l.screens[e];if(s.main.layout[i]&&!s.main.layout[n]){const t=l.layouts[s.main.layout[i]],o=Ft.getService(l,s.main.layout[i]).duplicateLayout(l,t.id,i,n,null);l=o[0];const a=o[1];null!=a&&(l=l.setIn(["layouts",a,"parent"],{type:r.LayoutParentType.Screen,id:e}).setIn(["screens",e,"main","layout",n],a))}if((null===(o=null===(t=s.panel)||void 0===t?void 0:t.layout)||void 0===o?void 0:o[i])&&!s.panel.layout[n]){const t=l.layouts[s.panel.layout[i]],o=Ft.getService(l,s.panel.layout[i]).duplicateLayout(l,t.id,i,n,null);l=o[0];const a=o[1];null!=a&&(l=l.setIn(["layouts",a,"parent"],{type:r.LayoutParentType.Screen,id:e}).setIn(["screens",e,"panel","layout",n],a))}})),l}addParent(e,t,o,i){return e.screenGroups[t]?(console.debug("add parent",o.layoutId,o.layoutItemId,"to",t,"in",i),e.setIn(["screenGroups",t,"parent",i],o)):e}removeParent(e,t,o,i){const n=e.screenGroups[t];if(!n||!n.parent)return e;if(console.debug("remove parent",o.layoutId,o.layoutItemId,"from",t),i){const s=n.parent[i];return(null==s?void 0:s.layoutId)===o.layoutId&&(null==s?void 0:s.layoutItemId)===o.layoutItemId?e.setIn(["screenGroups",t,"parent"],n.parent.without(i)):e}let s=e;return Object.keys(n.parent).forEach((i=>{const a=n.parent[i];a.layoutId===o.layoutId&&a.layoutItemId===o.layoutItemId&&(s=e.setIn(["screenGroups",t,"parent"],n.parent.without(i)))})),s}clearParent(e,t){const o=e.screenGroups[t];return o?e.setIn(["screenGroups",t],o.without("parent")):e}removeSizeModeParent(e,t,o){var i;const n=e.screenGroups[t];return n&&(null===(i=n.parent)||void 0===i?void 0:i[o])?e.setIn(["screenGroups",t,"parent"],n.parent.without(o)):e}findParent(e,t,o){var i;const n=e.screenGroups[t];if(!n||!n.parent)return null;return null!==(i=n.parent[o])&&void 0!==i?i:n.parent[e.mainSizeMode]}hasParent(e,t,o){const i=e.screenGroups[t];return!(!i||!i.parent)&&null!=i.parent[o]}hasMultipleParents(){return!1}duplicateScreen(e,t,o,i,n,s){var a,l,u;const d=null===(a=e.screenGroups)||void 0===a?void 0:a[t],c=null===(l=e.screens)||void 0===l?void 0:l[o];if(!c||!d||!d.screens.includes(o))return[e,null];console.debug("duplicate screen",o,"in",i,"to",t);let p=c.set("id",M(e,"screen")).set("label",Nt(e,"screen",c.label));n||(p=p.without("parent"));let g=e.setIn(["screens",p.id],p);const h={};i.forEach((e=>{h[e]=p.main.layout[e]}));const f=null!=s?s:{},y=Ft.getServiceFromSizeModeLayout(g,h).duplicateSizeModeLayouts(g,h,r.LayoutParentType.Screen,p.id,f);if(g=y[0],p=p.setIn(["main","layout"],y[1]),null===(u=p.panel)||void 0===u?void 0:u.layout){const e={};i.forEach((t=>{e[t]=p.panel.layout[t]}));const t=Ft.getServiceFromSizeModeLayout(g,e).duplicateSizeModeLayouts(g,e,r.LayoutParentType.Screen,p.id,f);g=t[0],p=p.setIn(["panel","layout"],t[1])}if(g=g.setIn(["screens",p.id],p),n){const e=d.screens.asMutable(),i=e.indexOf(o);e.splice(i,1,o,p.id),g=g.setIn(["screenGroups",t,"screens"],e)}return s&&(s[o]=p.id),[g,p.id]}removeScreen(e,t,o){var i,n;const s=null===(i=e.screenGroups)||void 0===i?void 0:i[t],a=null===(n=e.screens)||void 0===n?void 0:n[o];if(!a||!s||1===s.screens.length||!s.screens.includes(o))return e;console.debug("remove screen",o,"in",t);const r=s.screens.filter((e=>e!==o));let l=e.setIn(["screenGroups",t,"screens"],r);if(l=Ft.getServiceFromSizeModeLayout(l,a.main.layout).removeSizeModeLayouts(l,a.main.layout),a.panel){l=Ft.getServiceFromSizeModeLayout(l,a.panel.layout).removeSizeModeLayouts(l,a.panel.layout)}return l=l.set("screens",l.screens.without(o)),l}};const Co=new class{setContentId(e,t,o,i){if(!o)return e;const{layoutId:n,layoutItemId:s}=t,a=P.searchUtils.findLayoutItem(e,t);if(a){let l=e;switch(a.type){case r.LayoutItemType.Widget:l=l.setIn(["layouts",n,"content",s,"widgetId"],o),l=lo.addParent(l,o,t,i);break;case r.LayoutItemType.Section:l=l.setIn(["layouts",n,"content",s,"sectionId"],o),l=fo.addParent(l,o,t,i);break;case r.LayoutItemType.ScreenGroup:l=l.setIn(["layouts",n,"content",s,"screenGroupId"],o),l=wo.addParent(l,o,t,i)}return l}return e}};var bo=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};const Ao=new class{createPageFromTemplate(e,t,o){return bo(this,void 0,void 0,(function*(){var i;let n=e;yield Gt(t);const s=t.config,a=Object.keys(s.pages)[0],l=s.pages[a],u=r.appConfigUtils.getUniqueId(e,"page"),d=r.appConfigUtils.getUniqueLabel(e,"page",r.i18n.getIntl().formatMessage({id:"page"})),c=Object.keys(null!==(i=l.layout)&&void 0!==i?i:{});n=n.setIn(["pages",u],l).setIn(["pages",u,"id"],u).setIn(["pages",u,"isVisible"],!0).setIn(["pages",u,"isDefault"],!1).setIn(["pages",u,"label"],d).setIn(["pages",u,"header"],!1).setIn(["pages",u,"footer"],!1);for(let e=0;e<c.length;e+=1){const i=c[e],a=l.layout[i],d=Ft.getService(s,a),p=yield d.createLayoutFromTemplate(n,t,a,i,r.LayoutParentType.Page,u,o);n=p[0];const g=p[1];n=n.setIn(["pages",u,"layout",i],g).setIn(["layouts",g,"parent"],{id:u,type:r.LayoutParentType.Page})}return[n,u]}))}createDialogFromTemplate(e,t,o){return bo(this,void 0,void 0,(function*(){var i;let n=e;yield Gt(t);const s=t.config,a=Object.keys(s.dialogs)[0],l=s.dialogs[a],u=r.appConfigUtils.getUniqueId(e,"dialog"),d=r.appConfigUtils.getUniqueLabel(e,"dialog",r.i18n.getIntl().formatMessage({id:"dialog"})),c=Object.keys(null!==(i=l.layout)&&void 0!==i?i:{}),p=Object.keys(Object.keys(n.dialogs).filter((e=>n.dialogs[e].mode===l.mode))).length;n=n.setIn(["dialogs",u],l).setIn(["dialogs",u,"id"],u).setIn(["dialogs",u,"label"],d).setIn(["dialogs",u,"index"],p).setIn(["dialogs",u,"isSplash"],!1).setIn(["dialogs",u,"closeWhenClickOverlay"],l.closeWhenClickOverlay).setIn(["dialogs",u,"sizeMode"],l.sizeMode);for(let e=0;e<c.length;e+=1){const i=c[e],a=l.layout[i],d=Ft.getService(s,a),p=yield d.createLayoutFromTemplate(n,t,a,i,r.LayoutParentType.Dialog,u,o);n=p[0];const g=p[1];n=n.setIn(["dialogs",u,"layout",i],g).setIn(["layouts",g,"parent"],{id:u,type:r.LayoutParentType.Dialog})}return[n,u]}))}applyTemplateToHeader(e,t,o,i){return bo(this,void 0,void 0,(function*(){var n,s,a,l;if(yield Gt(t),!(null===(n=null==t?void 0:t.config)||void 0===n?void 0:n.header))return e;const u=t.config.header.layout,d=Object.values(u)[0],c=null===(s=null==e?void 0:e.header)||void 0===s?void 0:s.layout;if(c){const n=Ft.getService(t.config,d),s=yield n.replaceSizeModeLayout(e,c,t,(0,r.Immutable)(null===(l=null===(a=null==t?void 0:t.config)||void 0===a?void 0:a.header)||void 0===l?void 0:l.layout),o,r.LayoutParentType.Header,"header",i);let u=s[0];return Object.keys(s[1]).forEach((e=>{const t=s[1][e];u=u.setIn(["header","layout",e],t).setIn(["layouts",t,"parent"],{id:"header",type:r.LayoutParentType.Header})})),Object.keys(t.config.header).forEach((e=>{"layout"!==e&&null!=t.config.header[e]&&(u=u.setIn(["header",e],t.config.header[e]))})),u}return e}))}applyTemplateToFooter(e,t,o,i){return bo(this,void 0,void 0,(function*(){var n,s,a,l;if(yield Gt(t),!(null===(n=null==t?void 0:t.config)||void 0===n?void 0:n.footer))return e;const u=t.config.footer.layout,d=Object.values(u)[0],c=null===(s=null==e?void 0:e.footer)||void 0===s?void 0:s.layout;if(c){const n=Ft.getService(t.config,d),s=yield n.replaceSizeModeLayout(e,c,t,(0,r.Immutable)(null===(l=null===(a=null==t?void 0:t.config)||void 0===a?void 0:a.footer)||void 0===l?void 0:l.layout),o,r.LayoutParentType.Footer,"footer",i);let u=s[0];return Object.keys(s[1]).forEach((e=>{const t=s[1][e];u=u.setIn(["footer","layout",e],t).setIn(["layouts",t,"parent"],{id:"footer",type:r.LayoutParentType.Footer})})),Object.keys(t.config.footer).forEach((e=>{"layout"!==e&&null!=t.config.footer[e]&&(u=u.setIn(["footer",e],t.config.footer[e]))})),u}return e}))}applyTemplateToBody(e,t,o,i,n){return bo(this,void 0,void 0,(function*(){var s,a;if(yield Gt(o),!o.config){const t=yield(0,ke.getTemplateConfig)(o.type,o.name);if(o.config=t,!o.config)return e;r.appConfigUtils.fixLayoutIds(o.config),r.utils.replaceI18nPlaceholdersInObject(o.config,r.i18n.getIntl(),_e)}const l=Object.keys(o.config.pages)[0],u=o.config.pages[l].layout,d=Object.values(u)[0],c=null===(a=null===(s=null==e?void 0:e.pages)||void 0===s?void 0:s[t])||void 0===a?void 0:a.layout;if(c){const s=Ft.getService(o.config,d),a=yield s.replaceSizeModeLayout(e,c,o,(0,r.Immutable)(u),i,r.LayoutParentType.Page,t,n);let p=a[0];Object.keys(a[1]).forEach((e=>{const o=a[1][e];p=p.setIn(["pages",t,"layout",e],o).setIn(["layouts",o,"parent"],{id:t,type:r.LayoutParentType.Page})}));return["mode","maxWidth","bodyBackgroundColor","bodyBackgroundIMage","bodyBackgroundPosition"].forEach((e=>{const i=o.config.pages[l][e];"layout"!==e&&null!=i&&(p=p.setIn(["pages",t,e],i))})),p}return e}))}applyTemplateToDialog(e,t,o,i,n){return bo(this,void 0,void 0,(function*(){var s,a,l;yield Gt(o);const u=Object.keys(o.config.dialogs)[0],d=null===(s=null==e?void 0:e.dialogs)||void 0===s?void 0:s[t],c=null==d?void 0:d.layout,p=null===(l=null===(a=null==o?void 0:o.config)||void 0===a?void 0:a.dialogs)||void 0===l?void 0:l[u];if(c&&(null==p?void 0:p.layout)){const s=p.layout,a=Object.values(s)[0],l=Ft.getService(o.config,a),u=yield l.replaceSizeModeLayout(e,c,o,(0,r.Immutable)(s),i,r.LayoutParentType.Dialog,t,n);let g=u[0];const h=d.mode===p.mode,f=h?d.index:Object.keys(Object.keys(g.dialogs).filter((e=>g.dialogs[e].mode===p.mode))).length;g=g.setIn(["dialogs",t,"index"],f),Object.keys(u[1]).forEach((e=>{const o=u[1][e];g=g.setIn(["dialogs",t,"layout",e],o).setIn(["dialogs",t,"sizeMode",i],p.sizeMode[i]||p.sizeMode[r.BrowserSizeMode.Large]).setIn(["layouts",o,"parent"],{id:t,type:r.LayoutParentType.Dialog})}));return["mode","overlayColor","dialogBackground","interactionType","interactionStyles","confirmBeforeClose","alwaysShowConfirmation","closeWhenClickOverlay"].forEach((e=>{g=g.setIn(["dialogs",t,e],p[e])})),h||Object.keys(g.dialogs).forEach((e=>{const t=g.dialogs[e];t.mode===d.mode&&t.index>d.index&&(g=g.setIn(["dialogs",t.id,"index"],t.index-1))})),g}return e}))}applyGridTemplate(e,t,o,i,n){return bo(this,void 0,void 0,(function*(){var s,a;yield Gt(o);const l=null===(a=null===(s=null==e?void 0:e.widgets)||void 0===s?void 0:s[t])||void 0===a?void 0:a.layouts,u=Object.values(o.config.widgets).find((e=>"widgets/layout/grid/"===e.uri)),d="DEFAULT",c=l[d],p=Ft.getInstance().getServiceByType(r.LayoutType.GridLayout),g=yield p.replaceSizeModeLayout(e,c,o,(0,r.Immutable)(u.layouts[d]),i,r.LayoutParentType.Widget,t,n);let h=g[0];return Object.keys(g[1]).forEach((e=>{const o=g[1][e];h=h.setIn(["widgets",t,"layouts",d,e],o).setIn(["layouts",o,"parent"],{id:t,type:r.LayoutParentType.Widget})})),h}))}};function Po(e,t){return e.layoutId===t.layoutId&&e.layoutItemId===t.layoutItemId}const Lo=new class{isSupported(){var e,t,o;let i;window.jimuConfig.isInBuilder?i=(0,r.getAppStore)().getState():window.jimuConfig.isBuilder&&(i=(0,r.getAppStore)().getState().appStateInBuilder);const n=(null===(e=null==i?void 0:i.appInfo)||void 0===e?void 0:e.type)===r.AppType.Template,s=(null===(t=null==i?void 0:i.appRuntimeInfo)||void 0===t?void 0:t.appMode)===r.AppMode.Design,a=(null===(o=null==i?void 0:i.appRuntimeInfo)||void 0===o?void 0:o.appMode)===r.AppMode.Express;return n&&s||a}getNextPlaceholderId(e){var t;const o=Object.keys(null!==(t=e.placeholderInfos)&&void 0!==t?t:{}).map((e=>+e)).sort(((e,t)=>e-t));let i=1;for(let e=0;e<o.length&&i===o[e];e++)i++;return i}addAsSyncablePlaceholder(e,t){if(!this.isSupported())return e;const o=(0,r.getAppStore)().getState().browserSizeMode;if(o!==e.mainSizeMode)return e;const i=P.searchUtils.getRootContainerInfoOfLayout(e,t.layoutId,o),n=this.getNextPlaceholderId(e);return e.setIn(["placeholderInfos",`${n}`,"id"],n).setIn(["placeholderInfos",`${n}`,"rootContainer"],i).setIn(["placeholderInfos",`${n}`,"layoutInfo"],t)}getPlaceholderInfo(e,t){var o;if(!this.isSupported())return null;let i=null;return Object.keys(null!==(o=e.placeholderInfos)&&void 0!==o?o:{}).some((o=>{var n;const s=e.placeholderInfos[o];return Po(s.layoutInfo,t)?(i=s,!0):Object.keys(null!==(n=s.syncs)&&void 0!==n?n:{}).some((e=>!!Po(s.syncs[e],t)&&(i=s,!0)))})),i}afterLayoutItemMoved(e,t,o){var i;if(!this.isSupported())return e;let n=e;const s=this.getPlaceholderInfo(e,t);if(s){if(Po(s.layoutInfo,t))return n=n.setIn(["placeholderInfos",s.id,"layoutInfo"],o),n;const e=Object.keys(null!==(i=s.syncs)&&void 0!==i?i:{});for(let i=0;i<e.length;i++){const a=e[i];if(Po(s.syncs[a],t))return n=n.setIn(["placeholderInfos",s.id,"syncs",a],o),n}}return n}afterLayoutItemCopied(e,t,o){if(!this.isSupported())return e;const i=P.searchUtils.findLayoutItem(e,t);if(i.widgetId||i.sectionId)return e;const n=this.getPlaceholderInfo(e,t);return n&&Po(n.layoutInfo,t)?this.addAsSyncablePlaceholder(e,o):e}afterLayoutItemRemoved(e,t){var o;if(!this.isSupported())return e;const i=this.getPlaceholderInfo(e,t);if(i){const n=e.placeholderInfos;if(Po(i.layoutInfo,t))return e.set("placeholderInfos",n.without(i.id));const s=Object.keys(null!==(o=i.syncs)&&void 0!==o?o:{});for(let o=0;o<s.length;o++){const n=s[o];if(Po(i.syncs[n],t))return 1===s.length?e.setIn(["placeholderInfos",i.id],i.without("syncs")):e.setIn(["placeholderInfos",i.id,"syncs"],i.syncs.without(n))}}return e}};var Mo=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};class Do{constructor(e,t){switch(this.appConfig=e,this.layoutItem=t,t.type){case r.LayoutItemType.Widget:this.service=lo,this.contentId=t.widgetId;break;case r.LayoutItemType.Section:this.service=fo,this.contentId=t.sectionId;break;case r.LayoutItemType.ScreenGroup:this.service=wo,this.contentId=t.screenGroupId}}getConfig(){return this.appConfig}getContentId(){return this.contentId}createFromTemplate(e,t,o,i){return Mo(this,void 0,void 0,(function*(){if(this.contentId&&this.service){const n=yield this.service.createFromTemplate(this.appConfig,e,this.contentId,t,o,i);return this.appConfig=n[0],n}return[this.appConfig,null]}))}duplicateEmbedLayout(e,t){if(this.service){const o=this.service.duplicateEmbedLayout(this.appConfig,this.contentId,e,t);return this.appConfig=o[0],o}return[this.appConfig,null]}duplicate(e,t){if(this.service){const o=this.service.duplicate(this.appConfig,this.contentId,e,t);return this.appConfig=o[0],o}return[this.appConfig,null]}tryRemove(e,t){return this.service&&(this.appConfig=this.service.tryRemove(this.appConfig,this.contentId,e,t)),this.appConfig}remove(){return this.service&&(this.appConfig=this.service.remove(this.appConfig,this.contentId)),this.appConfig}toTocNode(e,t){return this.service?this.service.toTocNode(this.appConfig,this.contentId,e,t):null}afterMoved(e,t){return this.service&&(this.appConfig=this.service.afterMoved(this.appConfig,this.contentId,e,t)),this.appConfig}afterAdded(e,t,o){return this.service&&(this.appConfig=this.service.afterAdded(this.appConfig,this.contentId,e,t,o)),this.appConfig}addParent(e,t){return this.service&&(this.appConfig=this.service.addParent(this.appConfig,this.contentId,e,t)),this.appConfig}removeParent(e,t){return this.service&&(this.appConfig=this.service.removeParent(this.appConfig,this.contentId,e,t)),this.appConfig}clearParent(){return this.service&&(this.appConfig=this.service.clearParent(this.appConfig,this.contentId)),this.appConfig}removeSizeModeParent(e){return this.service&&(this.appConfig=this.service.removeSizeModeParent(this.appConfig,this.contentId,e)),this.appConfig}findParent(e){var t;return null===(t=this.service)||void 0===t?void 0:t.findParent(this.appConfig,this.contentId,e)}hasParent(e){var t,o;return null!==(o=null===(t=this.service)||void 0===t?void 0:t.hasParent(this.appConfig,this.contentId,e))&&void 0!==o&&o}hasMultipleParents(e){var t,o;return null!==(o=null===(t=this.service)||void 0===t?void 0:t.hasMultipleParents(this.appConfig,this.contentId,e))&&void 0!==o&&o}}var xo=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};class To{createBlankLayout(e,t){const o=M(e,"layout"),i={id:o,content:{},type:t};console.debug("create a blank layout with type",t);return[e.setIn(["layouts",o],i),o]}duplicateLayout(e,t,o,i,n,s){var a;const l=e.layouts[t];if(!l)return[e,null];const u=l.set("id",M(e,"layout"));let d=e.setIn(["layouts",u.id],u);if(console.debug("duplicate layout",t,", from size mode",o,", to size mode",i),Object.keys(null!==(a=u.content)&&void 0!==a?a:{}).forEach((e=>{var a;const l=u.content[e];if(l.isPending){const t=d.layouts[u.id];if(d=d.setIn(["layouts",t.id,"content"],t.content.without(e)),null===(a=t.order)||void 0===a?void 0:a.includes(e)){const o=t.order.filter((t=>t!==e));d=d.setIn(["layouts",t.id,"order"],o)}}else if(s)d=this.duplicateAndReplaceContent(d,{layoutId:t,layoutItemId:e},{layoutId:u.id,layoutItemId:e},o,i,n);else{const t=new Do(d,l);if(o!==i&&!t.hasMultipleParents(o)&&t.hasParent(i)){const t=l.set("type",r.LayoutItemType.Widget).without("widgetId");d=d.setIn(["layouts",u.id,"content",e],t)}else{const n=t.duplicateEmbedLayout(o,i);if(d=n[0],n[1]){const t=l.set("widgetId",n[1]);d=d.setIn(["layouts",u.id,"content",e],t);const o=new Do(d,t);d=o.addParent({layoutId:u.id,layoutItemId:e},i)}else d=t.addParent({layoutId:u.id,layoutItemId:e},i)}}})),o!==i){const e=this.transformLayout(d,d.layouts[u.id],o,i);d=d.setIn(["layouts",u.id],e)}return[d,u.id]}duplicateSizeModeLayouts(e,t,o,i,n){let s=e;const a={};return Object.keys(null!=t?t:{}).forEach((e=>{const r=t[e],l=this.duplicateLayout(s,r,e,e,n,!0);s=l[0],a[e]=l[1],null!=l[1]&&(s=s.setIn(["layouts",l[1],"parent"],{type:o,id:i}))})),[s,a]}duplicateAndReplaceContent(e,t,o,i,n,s){const{layoutId:a,layoutItemId:r}=t,{layoutId:l,layoutItemId:u}=o;if(!e.layouts||!e.layouts[a]||!e.layouts[l])return e;const d=P.searchUtils.findLayoutItem(e,{layoutId:a,layoutItemId:r}),c=new Do(e,d).duplicate(n,s);let p=c[0];const g=c[1];p=p.setIn(["layouts",l,"content",u,"type"],d.type),p=Co.setContentId(p,{layoutId:l,layoutItemId:u},g,n);const h=P.searchUtils.findLayoutItem(p,o),f=new Do(p,h);return f.removeParent({layoutId:a,layoutItemId:r},i),p=f.getConfig(),i===n&&n===e.mainSizeMode&&(p=Lo.afterLayoutItemCopied(p,t,o)),p}addContent(e,t,o,i,n){const s=this.createBlankItem(e,t);let a=s[0];const r=s[1];console.debug(`add ${o} to ${t}`),a=a.setIn(["layouts",t,"content",r,"type"],i);const l={layoutId:t,layoutItemId:r};return a=Co.setContentId(a,l,o,n),a=this.afterItemAdded(a,l,n,n),[a,r]}removeLayout(e,t,o){var i;const n=e.layouts[t];if(!n)return e;let s=e;return console.debug("remove layout",t,"in size mode",o),Object.keys(null!==(i=n.content)&&void 0!==i?i:{}).forEach((e=>{s=this.removeItem(s,{layoutId:t,layoutItemId:e},o,!0,!1)})),s=this.removeLayoutIdFromParent(s,t,o),s=s.setIn(["layouts"],s.layouts.without(t)),s}removeSizeModeLayouts(e,t){let o=e;return Object.keys(t).forEach((e=>{const i=t[e];o=this.removeLayout(o,i,e)})),o}removeLayoutIdFromParent(e,t,o){var i,n,s;const a=e.layouts[t];if(!a)return e;let l=e;const u=null===(i=a.parent)||void 0===i?void 0:i.id;switch(null===(n=a.parent)||void 0===n?void 0:n.type){case r.LayoutParentType.Header:l.header.layout[o]===t&&(console.debug("remove layout",t,"from header, in size mode",o),l=l.setIn(["header","layout"],l.header.layout.without(o)));break;case r.LayoutParentType.Footer:l.footer.layout[o]===t&&(console.debug("remove layout",t,"from footer, in size mode",o),l=l.setIn(["footer","layout"],l.footer.layout.without(o)));break;case r.LayoutParentType.Dialog:l.dialogs[u].layout[o]===t&&(console.debug("remove layout",t,"from dialog",u,", in size mode",o),l=l.setIn(["dialogs",u,"layout"],l.dialogs[u].layout.without(o)));break;case r.LayoutParentType.Page:l.pages[u].layout[o]===t&&(console.debug("remove layout",t,"from page",u,", in size mode",o),l=l.setIn(["pages",u,"layout"],l.pages[u].layout.without(o)));break;case r.LayoutParentType.View:l.views[u].layout[o]===t&&(console.debug("remove layout",t,"from view",u,", in size mode",o),l=l.setIn(["views",u,"layout"],l.views[u].layout.without(o)));break;case r.LayoutParentType.Screen:l.screens[u].main.layout[o]===t&&(console.debug("remove layout",t,"from screen main",u,", in size mode",o),l=l.setIn(["screens",u,"main","layout"],l.screens[u].main.layout.without(o))),(null===(s=l.screens[u].panel)||void 0===s?void 0:s.layout)&&l.screens[u].panel.layout[o]===t&&(console.debug("remove layout",t,"from screen panel",u,", in size mode",o),l=l.setIn(["screens",u,"panel","layout"],l.screens[u].panel.layout.without(o)));break;case r.LayoutParentType.Widget:const e=l.widgets[u];Object.keys(e.layouts).forEach((i=>{const n=e.layouts[i];n[o]===t&&(console.debug("remove layout",t,"from widget",u,", in size mode",o),l=l.setIn(["widgets",u,"layouts",i],n.without(o)))}))}return l}replaceLayoutIdInParent(e,t,o,i,n){let s=e;switch(console.debug("replace layout",o,"with new one",i,"in parent",t.id,n),t.type){case r.LayoutParentType.Header:s.header.layout[n]===o&&(s=s.setIn(["header","layout",n],i));break;case r.LayoutParentType.Footer:s.footer.layout[n]===o&&(s=s.setIn(["footer","layout",n],i));break;case r.LayoutParentType.Dialog:s.dialogs[t.id].layout[n]===o&&(s=s.setIn(["dialogs",t.id,"layout",n],i));break;case r.LayoutParentType.Page:s.pages[t.id].layout[n]===o&&(s=s.setIn(["pages",t.id,"layout",n],i));break;case r.LayoutParentType.Widget:const e=s.widgets[t.id];e&&Object.keys(e.layouts).some((a=>e.layouts[a][n]===o&&(s=s.setIn(["widgets",t.id,"layouts",a,n],i),!0)))}return s}transformLayout(e,t,o,i){let n;n=window.jimuConfig.isBuilder?window._appWindow&&window._appWindow._extensionManager:r.ExtensionManager.getInstance();const s=n.getExtensions(r.extensionSpec.ExtensionPoints.LayoutTransformer);if(s.length>0){const n=s.find((e=>e.layoutType===t.type));n&&n.transformLayout&&(t=n.transformLayout(t,o,i,e))}return t}createBlankItem(e,t){const o=`${P.utils.getMaximumId(e.layouts[t])+1}`,i={id:o};return[e.setIn(["layouts",t,"content",o],i),o]}duplicateItemInSameLayout(e,t,o,i){const{layoutId:n,layoutItemId:s}=t;if(!e.layouts||!e.layouts[n])return[e,null];console.debug("duplicate layout item",n,s,"in size mode",o);const a=P.searchUtils.findLayoutItem(e,t),r=`${P.utils.getMaximumId(e.layouts[n])+1}`,l=a.set("id",r);let u=e.setIn(["layouts",n,"content",l.id],l);u=this.duplicateAndReplaceContent(u,{layoutId:n,layoutItemId:s},{layoutId:n,layoutItemId:l.id},o,o,i);const d=P.searchUtils.findLayoutItem(u,{layoutId:n,layoutItemId:l.id}),c=new Do(u,d);return c.hasMultipleParents(o)&&(c.removeSizeModeParent(o),c.addParent({layoutId:n,layoutItemId:l.id},o),u=c.getConfig()),[u,l.id]}pendItem(e,t){const o=P.searchUtils.findLayoutItem(e,t),{layoutId:i,layoutItemId:n}=t;let s=e;return o&&(s=e.setIn(["layouts",i,"content",n,"isPending"],!0)),s}removeItem(e,t,o,i,n,s){var a,l;const{layoutId:u,layoutItemId:d}=t,c=P.searchUtils.findLayoutItem(e,t);if(!c)return e;console.debug(`remove layout item, ${u} ${d}, removeContent=${i}, force=${n}`);const p=Lo.getPlaceholderInfo(e,t);let g=this.beforeItemRemoved(e,t);const h=new Do(g,c);i?n?h.remove():h.tryRemove(t,o):h.removeParent(t,o),g=h.getConfig();if(null!==(l=null===(a=e.forBuilderAttributes)||void 0===a?void 0:a.lockLayout)&&void 0!==l&&l||p&&!s&&(c.widgetId||c.sectionId))c.type===r.LayoutItemType.Widget&&c.widgetId?g=g.setIn(["layouts",u,"content",d],c.without("widgetId")):c.type===r.LayoutItemType.Section&&c.sectionId&&(g=g.setIn(["layouts",u,"content",d],c.without("sectionId").set("type",r.LayoutItemType.Widget)));else{const e=g.layouts[u];e&&(g=g.setIn(["layouts",u,"content"],e.content.without(d))),s||(g=Lo.afterLayoutItemRemoved(g,t)),g=this.afterItemRemoved(g,t)}return g}replaceSizeModeLayout(e,t,o,i,n,s,a,r){return xo(this,void 0,void 0,(function*(){if(!i)return[e,t];const l=n===e.mainSizeMode;let u,d=e,c=t;u=l?Object.keys(i).filter((e=>e===n||null==t[e])):[n];for(let e=0;e<u.length;e+=1){const t=u[e],n=yield this.replaceLayout(d,c[t],o,i[t],t,s,a,r);n[1]&&(d=n[0],c=c.set(t,n[1]))}if(null==i[n]){const e=yield this.replaceLayout(d,c[n],o,i[d.mainSizeMode],n,s,a,r);d=e[0],c=c.set(n,e[1])}return[d,c]}))}replaceLayout(e,t,o,i,n,s,a,r){return xo(this,void 0,void 0,(function*(){var l,u,d;if(null==(null===(u=null===(l=o.config)||void 0===l?void 0:l.layouts)||void 0===u?void 0:u[i]))return[e,null];console.debug(`replace ${t} with template ${i} in ${n}`);let c=e;if(null===(d=e.layouts)||void 0===d?void 0:d[t]){const o=e.layouts[t];if((null==o?void 0:o.content)&&Object.keys(o.content).length>0)return[e,null];c=c.set("layouts",c.layouts.without(t))}const p=yield this.createLayoutFromTemplate(c,o,i,n,s,a,r);c=p[0];const g=p[1];return c=this.replaceLayoutIdInParent(c,{type:s,id:a},t,g,n),[c,g]}))}createLayoutFromTemplate(e,t,o,i,n,s,a){return xo(this,void 0,void 0,(function*(){var l;let u=e;yield Gt(t),console.debug("create layout",o,"from template");const d=t.config.layouts[o],c=M(e,"layout");u=u.setIn(["layouts",c],d).setIn(["layouts",c,"id"],c).setIn(["layouts",c,"parent"],{type:n,id:s});const p=d.type===r.LayoutType.GridLayout?Object.keys(d.content||{}):null!==(l=d.order)&&void 0!==l?l:[];for(let e=0;e<p.length;e++){const o=p[e],n=d.content[o],s=new Do(u,n),l=yield s.createFromTemplate(t,[i],a,{isBlock:d.type===r.LayoutType.FlowLayout});u=l[0];const g=l[1];u=Co.setContentId(u,{layoutId:c,layoutItemId:o},g,i)}return[u,c]}))}getTocStructure(e,t){return null}moveLayoutItem(e,t,o,i,n){var s,a,l,u;const d=P.searchUtils.findLayoutItem(e,t);if(!d)return[e,null];let c=e;const p=e.layouts[t.layoutId],g=P.searchUtils.findLayoutItem(c,t);if(p.type===r.LayoutType.GridLayout&&!g.isPending&&i===n){const e=Ft.getInstance().getServiceByType(r.LayoutType.GridLayout);c=e.beforeItemRemoved(c,t)}if(console.debug("move layout item from",t.layoutId,t.layoutItemId,"to",o,n),g.isPending&&i===n&&(c=c.setIn(["layouts",t.layoutId,"content",t.layoutItemId],g.without("isPending"))),t.layoutId!==o){const e=Ft.getService(c,t.layoutId);if(i===n){let o=[t];if(g.type===r.LayoutItemType.Widget){const e=c.widgets[g.widgetId];e&&(null===(a=null===(s=e.parent)||void 0===s?void 0:s[i])||void 0===a?void 0:a.length)>1&&(o=e.parent[i])}else if(g.type===r.LayoutItemType.Section){const e=c.sections[g.sectionId];(null===(u=null===(l=e.parent)||void 0===l?void 0:l[i])||void 0===u?void 0:u.length)>1&&(o=e.parent[i])}o.forEach((t=>{c=e.removeItem(c,t,i,!1,!1,!0)}))}const p=this.createBlankItem(c,o);c=p[0];const h=p[1];c=c.setIn(["layouts",o,"content",h,"type"],d.type),d.type===r.LayoutItemType.Widget?c=c.setIn(["layouts",o,"content",h,"widgetId"],d.widgetId):d.type===r.LayoutItemType.Section&&(c=c.setIn(["layouts",o,"content",h,"sectionId"],d.sectionId));const f={layoutId:o,layoutItemId:h},y=P.searchUtils.findLayoutItem(c,f),m=new Do(c,y);return m.addParent(f,n),i===n?m.afterMoved(t.layoutId,o):m.afterAdded(o,i,n),c=m.getConfig(),c=Lo.afterLayoutItemMoved(c,t,f),[c,f]}return[c,t]}afterItemAdded(e,t,o,i,n){const s=P.searchUtils.findLayoutItem(e,t),a=new Do(e,s);return a.afterAdded(t.layoutId,o,i),a.getConfig()}afterItemMoved(e,t,o){return e}beforeItemRemoved(e,t){return e}afterItemRemoved(e,t){return e}}var jo=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};function Uo(e=void 0){return e||(e=function(){const e=(0,r.getAppStore)().getState();return window.jimuConfig.isBuilder?e&&e.appStateInBuilder&&e.appStateInBuilder.appConfig:e&&e.appConfig}()),new Ro(e)}class Ro{constructor(e){this.clearDeletedWidgetMessageAction=(e,t)=>{this.getDeletedWidgetsMessageConfigs(e,t).forEach((e=>{this.removeMessageAction(e)}))},this.getDeletedWidgetsMessageConfigs=(e,t)=>{const o=e.messageConfigs,i=t.messageConfigs,n=[];if(!o)return n;const s=Object.keys(o),a=Object.keys(i);for(let e=0;e<s.length;e++)a.includes(s[e])||n.push(o[s[e]]);return n},this.removeMessageAction=e=>{var t;null===(t=null==e?void 0:e.actions)||void 0===t||t.forEach((t=>{const o=A.getInstance().getAction(t.widgetId,t.actionName);o&&o.onRemoveListen(e.messageType,e.widgetId)}))},this.appConfig=e}exec(e=!1){if(window.jimuConfig.isBuilder){(0,r.getAppStore)().dispatch({type:"IN_BUILDER_APPCONFIG_REDOCLEAR"}),e&&(0,r.getAppStore)().dispatch(G.InBuilderRemoveLastAppConfigFromHistory()),qe(this.appConfig);const t=(0,r.getAppStore)().getState().appStateInBuilder.appConfig,o=this.appConfig,i=Object.keys(t.widgets).filter((e=>!o.widgets[e]));(0,r.getAppStore)().dispatch(f.widgetsRemoved(i)),this.clearDeletedWidgetMessageAction(t,o);const n=Object.keys(o.widgets).filter((e=>!t.widgets[e])).map((e=>({widgetId:e,widgetUri:o.widgets[e].uri})));(0,r.getAppStore)().dispatch(f.widgetsAdded(n));const s=(0,r.getAppStore)().getState().appStateInBuilder.appInfo;(0,r.getAppStore)().dispatch(F.inBuilderAppConfigChanged(this.appConfig)),(0,r.getAppStore)().dispatch(G.InBuilderPutAppConfigIntoHistory({appConfig:this.appConfig,appInfo:s}))}else{e&&jt();const t=(0,r.getAppStore)().getState().appConfig,o=this.appConfig;this.clearDeletedWidgetMessageAction(t,o),(0,r.getAppStore)().dispatch(r.appActions.appConfigChanged(this.appConfig))}return this}editWidgetConfig(e,t){return this.appConfig.widgets[e]?(this.appConfig=this.appConfig.setIn(["widgets",e,"config"],t),this):this}editWidget(e,t){if(!this.appConfig.widgets[e.id])return this;const o=this.appConfig.widgets[e.id];let i=o;return t&&(t.forEach((e=>{e.isOutputFromWidget||(e.isOutputFromWidget=!0)})),i=i.set("outputDataSources",t.map((e=>e.id)))),Object.keys(e).forEach((t=>{null===e[t]&&("outputDataSourcesJson"===t&&e.outputDataSources&&e.outputDataSources.forEach((e=>this.removeDataSource(e))),i=i.without(t),delete e[t])})),o.outputDataSources&&o.outputDataSources.forEach((e=>{i.outputDataSources&&i.outputDataSources.includes(e)||this.removeDataSource(e)})),i.outputDataSources&&i.outputDataSources.forEach((e=>{const i=t&&t.find((t=>t.id===e));if(i)if(o.outputDataSources&&o.outputDataSources.includes(e)){let t=this.appConfig.dataSources[e];if(!t)return void console.error("Unknown error. Widget output data source is not in data source json.",e);Object.keys(i).forEach((e=>{null===i[e]&&(t=t.without(e),delete i[e])})),this.editDataSource(t.merge(i))}else this.addDataSource((0,r.Immutable)(i))})),i=i.merge(e),e.useDataSources&&i.layouts&&i.manifest.properties.passDataSourceToChildren&&this.copyUseDataSourceToAllChildWidgets(o,i),this.appConfig=this.appConfig.setIn(["widgets",e.id],i),this}editWidgetProperty(e,t,o){if(!this.appConfig.widgets||!this.appConfig.widgets[e])return this;if("outputDataSources"===t)return console.error("Please use editWidget to update outputDataSources."),this;const i=this.appConfig.widgets[e],n=this.editJsonProperty(i,t,o);return i===n?this:(this.appConfig=this.appConfig.setIn(["widgets",e],n),t.includes(".")?this:this.editWidget({id:e,[t]:o}))}createWidget(e){return jo(this,arguments,void 0,(function*(e,t=!0){try{const o=yield Bt.getInstance().handleNewWidgetJson(e),i=lo.createWidget(this.appConfig,o,[P.utils.getCurrentSizeMode()],t);this.appConfig=i[0];const n=i[1];return this.appConfig.widgets[n]}catch(e){console.error(e)}return null}))}removeWidget(e){return this.appConfig=lo.remove(this.appConfig,e),this}editControllerPanel(e,t){return this.appConfig=this.appConfig.setIn(["controllerPanels",e],t),this}removeControllerPanel(e){var t;return(null===(t=this.appConfig.controllerPanels)||void 0===t?void 0:t[e])&&(this.appConfig=this.appConfig.set("controllerPanels",this.appConfig.controllerPanels.without(e))),this}removeLayoutFromWidget(e,t){var o,i,n;return(null===(o=this.appConfig.widgets[e])||void 0===o?void 0:o.layouts)&&(null===(i=this.appConfig.widgets[e])||void 0===i?void 0:i.layouts[t])?(Object.keys(null===(n=this.appConfig.widgets[e])||void 0===n?void 0:n.layouts[t]).forEach((o=>{var i;const n=null===(i=this.appConfig.widgets[e])||void 0===i?void 0:i.layouts[t][o];this.removeLayout(n)})),this.appConfig=this.appConfig.setIn(["widgets",e,"layouts"],this.appConfig.widgets[e].layouts.without(t)),this):this}createSection(){const e=fo.createSection(this.appConfig,[P.utils.getCurrentSizeMode()]);this.appConfig=e[0];const t=e[1];return this.appConfig.sections[t]}editSectionProperty(e,t,o){let i=this.appConfig.sections[e];return i?(i=this.editJsonProperty(i,t,o),this.appConfig=this.appConfig.setIn(["sections",e],i),this):this}editViewProperty(e,t,o){let i=this.appConfig.views[e];return i?(i=this.editJsonProperty(i,t,o),this.appConfig=this.appConfig.setIn(["views",e],i),this):this}addView(e){var t;let o;const i=this.appConfig.sections[e];if((null===(t=i.views)||void 0===t?void 0:t.length)>0){const e=i.views[0],t=this.appConfig.views[e];o=Object.keys(t.layout)}else{const{type:t,id:i}=P.searchUtils.getContentRootContainerInfo(this.appConfig,e,r.LayoutItemType.Section,P.utils.getCurrentSizeMode());t===r.ContainerType.Header||t===r.ContainerType.Footer?o=Object.keys(this.appConfig[i].layout):t===r.ContainerType.Page?o=Object.keys(this.appConfig.pages[i].layout):t===r.ContainerType.Dialog&&(o=Object.keys(this.appConfig.dialogs[i].layout))}const n=fo.addView(this.appConfig,e,o);return this.appConfig=n[0],n[1]}duplicateView(e,t,o){const i=this.appConfig.sections[t],n=this.appConfig.views[i.views[0]],s=Object.keys(n.layout),a=fo.duplicateView(this.appConfig,t,e,s,o,null);this.appConfig=a[0];const r=a[1];return this.appConfig.views[r]}removeView(e,t){return this.appConfig=fo.removeView(this.appConfig,t,e),this}moveViewInSection(e,t,o,i){if(!(this.appConfig.sections&&this.appConfig.sections[e]&&this.appConfig.views&&this.appConfig.views[t]&&this.appConfig.views[o]))return this;if(o===t)return console.error("viewId is same to targetViewId."),this;let n=this.appConfig.sections[e].views.asMutable();n=n.filter((e=>e!==t));let s=n.indexOf(o);return"below"===i&&s++,n=n.slice(0,s).concat(t).concat(n.slice(s)),this.appConfig=this.appConfig.setIn(["sections",e,"views"],n),this}createScreenGroup(){const e=M(this.appConfig,"screenGroup"),t=D(this.appConfig,"screenGroup",r.i18n.getIntl().formatMessage({id:"screenGroup"})),o=(0,r.Immutable)({id:e,label:t,screens:[],transitionType:r.ScreenTransitionType.Fade});return this.appConfig=this.appConfig.setIn(["screenGroups",o.id],o),o}editScreenGroupProperty(e,t,o){let i=this.appConfig.screenGroups[e];return i?(i=this.editJsonProperty(i,t,o),this.appConfig=this.appConfig.setIn(["screenGroups",e],i),this):this}editScreenProperty(e,t,o){let i=this.appConfig.screens[e];return i?(i=this.editJsonProperty(i,t,o),this.appConfig=this.appConfig.setIn(["screens",e],i),this):this}moveScreenInGroup(e,t,o,i){var n;if(!(null===(n=this.appConfig.screenGroups)||void 0===n?void 0:n[e])||t===o)return this;const s=this.appConfig.screenGroups[e].screens.asMutable(),a=s[t],r=s[o];s.splice(t,1);const l=s.indexOf(r);return"below"===i?s.splice(l,1,r,a):s.splice(l,1,a,r),this.appConfig=this.appConfig.setIn(["screenGroups",e,"screens"],s),this}removeScreenByIndex(e,t){var o,i;const n=null===(i=null===(o=this.appConfig.screenGroups)||void 0===o?void 0:o[t])||void 0===i?void 0:i.screens,s=null==n?void 0:n[e];return this.removeScreen(s,t)}removeScreen(e,t,o=!1){return this.appConfig=wo.removeScreen(this.appConfig,t,e),this}duplicateScreenByIndex(e,t,o=!0){var i,n;const s=null===(n=null===(i=this.appConfig.screenGroups)||void 0===i?void 0:i[t])||void 0===n?void 0:n.screens,a=null==s?void 0:s[e];return this.duplicateScreen(a,t,o)}duplicateScreen(e,t,o=!0){const i=this.appConfig.screenGroups[t],n=this.appConfig.screens[i.screens[0]],s=Object.keys(n.main.layout),a=wo.duplicateScreen(this.appConfig,t,e,s,o,null);this.appConfig=a[0];const r=a[1];return this.appConfig.screens[r]}editPageProperty(e,t,o){if(!this.appConfig.pages||!this.appConfig.pages[e])return this;let i=this.appConfig.pages[e];return i=this.editJsonProperty(i,t,o),this.appConfig=this.appConfig.setIn(["pages",e],i),this}addPage(e){return this.appConfig.pages&&this.appConfig.pages[e.id]||(this.appConfig=this.appConfig.setIn(["pages",e.id],e),this.appConfig=this.appConfig.set("pageStructure",this.appConfig.pageStructure.concat([{[e.id]:[]}]))),this}duplicatePage(e,t=!1){if(!this.appConfig.pages||!this.appConfig.pages[e])return null;let o=this.appConfig.pages[e].set("id",M(this.appConfig,"page"));if(o=o.set("label",this.getDuplicateLabel("page",o.label)),this.appConfig=this.appConfig.setIn(["pages",o.id],o),o.isDefault&&(o=o.set("isDefault",!1)),o.type!==r.PageType.Link&&o.type!==r.PageType.Folder){const e={},t=Ft.getServiceFromSizeModeLayout(this.appConfig,o.layout).duplicateSizeModeLayouts(this.appConfig,o.layout,r.LayoutParentType.Page,o.id,e);this.appConfig=t[0],o=o.set("layout",t[1]),this.appConfig=lo.afterBatchCopied(this.appConfig,this.appConfig,e)}const i=this.appConfig.pageStructure.find((t=>!!t[e])),n=[];if(i&&i[e].forEach((e=>{const t=this.duplicatePage(e,!0);n.push(t.id)})),!t)if(i){if(this.appConfig=this.appConfig.set("pageStructure",this.appConfig.pageStructure.concat([{[o.id]:[]}])),n.length>0){const e=o.id;let t=this.appConfig.pageStructure.length-1;t<0&&(t=0),this.appConfig=this.appConfig.setIn(["pageStructure",t+"",e],n)}}else this.appConfig.pageStructure.some(((t,i)=>{const n=Object.keys(t).find((o=>t[o].includes(e)));if(n)return this.appConfig=this.appConfig.setIn(["pageStructure",i+"",n],this.appConfig.pageStructure[i][n].concat(o.id)),!0}));return this.appConfig=this.appConfig.setIn(["pages",o.id],o),o}movePageIntoPage(e,t){return this.appConfig.pages&&this.appConfig.pages[e]&&this.appConfig.pages[t]?e===t?(console.error("SubPage is same to ParentPage."),this):j(this.appConfig,t)?U(this.appConfig,e)?(console.error("SubPage has sub page(s)."),this):(this.removePageFromPageStructure(e),this.movePageIntoPageForPageStructure(e,t),this):(console.error("ParentPage is not on the first aspect."),this):this}orderPageToPage(e,t,o){if(!this.appConfig.pages||!this.appConfig.pages[t]||!this.appConfig.pages[e])return this;if(t===e)return console.error("pageId is same to targetPageId."),this;const i=!j(this.appConfig,t);if((U(this.appConfig,e)||this.appConfig.pages[e].type===r.PageType.Folder)&&i)return console.error("page structure allow two aspects only"),this;const n=this.appConfig.pageStructure.find((t=>!!t[e]));return this.removePageFromPageStructure(e),i?this.appConfig.pageStructure.some(((i,n)=>{const s=Object.keys(i)[0];let a=i[s].indexOf(t);if(a>-1){let t=this.appConfig.pageStructure[n][s];return"bottom"===o&&(a+=1),t=t.slice(0,a).concat([e]).concat(t.slice(a)),this.appConfig=this.appConfig.setIn(["pageStructure",n+"",s],t),!0}})):this.appConfig.pageStructure.some(((i,s)=>{if(Object.keys(i)[0]===t){"bottom"===o&&(s+=1);const t=this.appConfig.pageStructure.slice(0,s).concat([n||{[e]:[]}]).concat(this.appConfig.pageStructure.slice(s));return this.appConfig=this.appConfig.set("pageStructure",t),!0}})),this}removePage(e,t){if(!this.appConfig.pages||!this.appConfig.pages[e])return this;const o=this.appConfig.pages[e];if(o.type!==r.PageType.Folder&&o.type!==r.PageType.Link){const e=Ft.getServiceFromSizeModeLayout(this.appConfig,o.layout);this.appConfig=e.removeSizeModeLayouts(this.appConfig,o.layout)}const{pageStructure:i}=this.appConfig,n=i&&i.find((t=>!!t[e]));return n&&n[e].length>0&&n[e].forEach((e=>{this.removePage(e)})),this.removePageFromPageStructure(e),this.appConfig=this.appConfig.set("pages",this.appConfig.pages.without(e)),t&&this.setHomePage(t),this}setHomePage(e){return this.editPageProperty(e,"isDefault",!0)}setUseAutoSortInFixedLayout(e){return this.appConfig=this.appConfig.set("useAutoSortInFixedLayout",e),this}replaceHomePage(e){return Object.keys(this.appConfig.pages).some(((e,t)=>{const o=this.appConfig.pages[e];if(o.isDefault)return this.editPageProperty(o.id,"isDefault",!1),!0})),this.editPageProperty(e,"isDefault",!0)}editDialog(e){const t=this.appConfig.dialogs[e.id].mode;if(t!==e.mode){const o=this.appConfig.dialogs.asMutable({deep:!0});Object.keys(o).forEach((i=>{const n=o[i];n.id===e.id?o[i]=Object.assign({},e.asMutable({deep:!0}),{index:Object.keys(o).filter((e=>o[e].mode!==t)).length}):n.mode===t&&n.index>e.index&&(n.index=n.index-1)})),this.appConfig=this.appConfig.set("dialogs",(0,r.Immutable)(o))}else this.appConfig=this.appConfig.setIn(["dialogs",e.id],e);return this}editDialogProperty(e,t,o){if(!this.appConfig.dialogs||!this.appConfig.dialogs[e])return this;let i=this.appConfig.dialogs[e];return i=this.editJsonProperty(i,t,o),this.editDialog(i)}removeDialog(e){var t;const o=null===(t=this.appConfig.dialogs)||void 0===t?void 0:t[e];if(!o)return this;const i=Ft.getServiceFromSizeModeLayout(this.appConfig,o.layout);this.appConfig=i.removeSizeModeLayouts(this.appConfig,o.layout);const n=o.mode,s=o.index,a=this.appConfig.dialogs.without(e).asMutable({deep:!0});return Object.keys(a).forEach((e=>{const t=a[e];t.mode===n&&t.index>s&&(t.index=t.index-1)})),this.appConfig=this.appConfig.set("dialogs",(0,r.Immutable)(a)),this}duplicateDialog(e){const t=this.appConfig.dialogs;let o=t[e];if(!t||!o)return null;const i=M(this.appConfig,"dialog"),n={},s=Ft.getServiceFromSizeModeLayout(this.appConfig,o.layout).duplicateSizeModeLayouts(this.appConfig,o.layout,r.LayoutParentType.Dialog,i,n);this.appConfig=s[0];const a=s[1];this.appConfig=lo.afterBatchCopied(this.appConfig,this.appConfig,n);const l=Object.keys(Object.keys(t).filter((e=>t[e].mode===o.mode))).length;return o=o.set("id",i).set("index",l).set("isSplash",!1).set("label",this.getDuplicateLabel("dialog",o.label)).set("layout",a),this.appConfig=this.appConfig.setIn(["dialogs",o.id],o),o}orderDialogToDialog(e,t,o){const i=this.appConfig.dialogs.asMutable({deep:!0}),n=i[e],s=i[t];if(!i||!n||!s)return this;if(t===e)return console.error("dialogId is same to targetDialogId."),this;let a;return s.index>n.index?(a="top"===o?s.index-1:s.index,Object.keys(i).forEach((t=>{const o=i[t];o.mode===s.mode&&o.id!==e&&o.index>n.index&&o.index<=a&&(o.index=o.index-1)}))):(a="top"===o?s.index:s.index+1,Object.keys(i).forEach((t=>{const o=i[t];o.mode===s.mode&&o.id!==e&&o.index>=a&&o.index<n.index&&(o.index=o.index+1)}))),i[e]=Object.assign({},n,{index:a,mode:s.mode}),this.appConfig=this.appConfig.set("dialogs",(0,r.Immutable)(i)),this}replaceSplashDialog(e,t){return t&&this.editDialogProperty(t,"isSplash",!1),e!==t?this.editDialogProperty(e,"isSplash",!0):this}createLayoutForSizeMode(e,t,o,i,n,s){var a;if(!o||!o[t]||o[e])return null;const l=o[t],u=Ft.getService(this.appConfig,l).duplicateLayout(this.appConfig,o[t],t,e,null,!1);if(u[1]){this.appConfig=u[0];const t=u[1];this.appConfig=this.appConfig.setIn(["layouts",t,"parent"],{id:n,type:i});const l=o.set(e,t);switch(i){case r.LayoutParentType.Dialog:this.appConfig=this.appConfig.setIn(["dialogs",n,"layout"],l);break;case r.LayoutParentType.Page:this.appConfig=this.appConfig.setIn(["pages",n,"layout"],l);break;case r.LayoutParentType.Header:this.appConfig=this.appConfig.setIn(["header","layout"],l);break;case r.LayoutParentType.Footer:this.appConfig=this.appConfig.setIn(["footer","layout"],l);break;case r.LayoutParentType.Screen:this.appConfig=this.appConfig.setIn(["screens",n,"layout"],l);break;case r.LayoutParentType.View:this.appConfig=this.appConfig.setIn(["views",n,"layout"],l);break;case r.LayoutParentType.Widget:{const e=this.appConfig.widgets[n];(null===(a=null==e?void 0:e.layouts)||void 0===a?void 0:a[s])&&(this.appConfig=this.appConfig.setIn(["widgets",n,"layouts",s],l));break}}return l}return null}removeSizeModeLayout(e,t){const o=Ft.getService(this.appConfig,e);return this.appConfig=o.removeLayout(this.appConfig,e,t),this}addNewSectionToLayout(e){const t=this.createSection(),o=Ft.getService(this.appConfig,e).createBlankItem(this.appConfig,e);this.appConfig=o[0];const i=o[1],n={layoutId:e,layoutItemId:i};return this.editLayoutItemProperty(n,"type",r.LayoutItemType.Section).editLayoutItemProperty(n,"sectionId",t.id),this.appConfig=fo.addParent(this.appConfig,t.id,n,P.utils.getCurrentSizeMode()),i}addPlaceholderToLayout(e){const t=Ft.getService(this.appConfig,e).createBlankItem(this.appConfig,e);this.appConfig=t[0];const o=t[1],i={layoutId:e,layoutItemId:o};return this.editLayoutItemProperty(i,"type",r.LayoutItemType.Widget),this.appConfig=Lo.addAsSyncablePlaceholder(this.appConfig,i),o}addNewWidgetToLayout(e,t){return jo(this,void 0,void 0,(function*(){const o=yield this.createWidget(t,!0);if(o){const t=Ft.getService(this.appConfig,e).createBlankItem(this.appConfig,e);this.appConfig=t[0];const i=t[1],n={layoutId:e,layoutItemId:i};this.editLayoutItemProperty(n,"type",r.LayoutItemType.Widget).editLayoutItemProperty(n,"widgetId",o.id);const s=P.utils.getCurrentSizeMode();return this.appConfig=lo.addParent(this.appConfig,o.id,n,s),this.appConfig=lo.afterAdded(this.appConfig,o.id,e,s,s),i}return null}))}addTemplateContentToLayout(e,t,o){const i=Ft.getService(this.appConfig,e).addContent(this.appConfig,e,o,t,P.utils.getCurrentSizeMode());return this.appConfig=i[0],{layoutId:e,layoutItemId:i[1]}}addContentToPlaceholder(e,t,o){var i;let n=[{layoutInfo:e,sizeMode:P.utils.getCurrentSizeMode()}];const s=Lo.getPlaceholderInfo(this.appConfig,e);return s&&(n=[{layoutInfo:s.layoutInfo,sizeMode:this.appConfig.mainSizeMode}],Object.keys(null!==(i=s.syncs)&&void 0!==i?i:{}).forEach((e=>{n.push({layoutInfo:s.syncs[e],sizeMode:e})}))),n.forEach((i=>{var n;const{layoutInfo:s,sizeMode:a}=i,{layoutId:r}=s;this.editLayoutItemProperty(s,"type",t),this.appConfig=Co.setContentId(this.appConfig,s,o,a);const l=P.searchUtils.findLayoutItem(this.appConfig,s),u=new Do(this.appConfig,l);this.appConfig=u.afterAdded(r,a,a),(null===(n=l.setting)||void 0===n?void 0:n.placeholderStyle)&&this.editLayoutItemProperty(e,"setting",l.setting.without("placeholderStyle"))})),this}removeParentsOfOtherSizeModes(e,t,o){const i=P.searchUtils.findLayoutItem(this.appConfig,e);let n=[];const s=[];if(i.type===r.LayoutItemType.Widget){const e=i.widgetId,t=this.appConfig.widgets[e];(null==t?void 0:t.layouts)&&Object.keys(t.layouts).forEach((e=>{const i=t.layouts[e][o];s.push(i)}))}else if(i.type===r.LayoutItemType.Section){const e=i.sectionId;this.appConfig.sections[e].views.forEach((e=>{const t=this.appConfig.views[e];s.push(t.layout[o])}))}else if(i.type===r.LayoutItemType.ScreenGroup){const e=i.screenGroupId;this.appConfig.screenGroups[e].screens.forEach((e=>{const t=this.appConfig.screens[e];s.push(t.main.layout[o]),t.panel&&s.push(t.panel.layout[o])}))}s.length>0&&s.forEach((e=>{const t=P.searchUtils.getContentsInLayoutRecursive(this.appConfig,e,r.LayoutItemType.Widget,o);n=n.concat(t)})),n.length>0&&n.forEach((e=>{t.forEach((t=>{t!==o&&(this.appConfig=lo.removeSizeModeParent(this.appConfig,e,t))}))}))}duplicateLayoutItemInSameLayout(e){const{layoutId:t}=e,o=Ft.getService(this.appConfig,t),i={},n=P.utils.getCurrentSizeMode(),s=o.duplicateItemInSameLayout(this.appConfig,e,n,i);this.appConfig=s[0];const a=s[1];this.appConfig=lo.afterBatchCopied(this.appConfig,this.appConfig,i);const l=P.searchUtils.findLayoutItem(this.appConfig,{layoutId:t,layoutItemId:a}),u=new Do(this.appConfig,l),d=[r.BrowserSizeMode.Large,r.BrowserSizeMode.Medium,r.BrowserSizeMode.Small];return d.forEach((e=>{e!==n&&u.removeSizeModeParent(e)})),this.appConfig=u.getConfig(),this.removeParentsOfOtherSizeModes({layoutId:t,layoutItemId:a},d,n),s[1]}duplicateLayoutItemToOtherLayout(e,t){const o=P.searchUtils.findLayoutItem(this.appConfig,e),i=new Do(this.appConfig,o),n={},s=P.utils.getCurrentSizeMode(),a=i.duplicate(s,n);this.appConfig=a[0];const l=a[1];this.appConfig=lo.afterBatchCopied(this.appConfig,this.appConfig,n),this.appConfig=lo.removeParent(this.appConfig,l,e);const u=Ft.getService(this.appConfig,t).createBlankItem(this.appConfig,t);this.appConfig=u[0];const d=u[1],c={layoutId:t,layoutItemId:d};switch(this.editLayoutItemProperty(c,"type",o.type),o.type){case r.LayoutItemType.Widget:this.editLayoutItemProperty(c,"widgetId",l);break;case r.LayoutItemType.Section:this.editLayoutItemProperty(c,"sectionId",l);break;case r.LayoutItemType.ScreenGroup:this.editLayoutItemProperty(c,"screenGroupId",l)}const p=P.searchUtils.findLayoutItem(this.appConfig,c),g=new Do(this.appConfig,p);g.addParent(c,s);const h=[r.BrowserSizeMode.Large,r.BrowserSizeMode.Medium,r.BrowserSizeMode.Small];h.forEach((e=>{e!==s&&g.removeSizeModeParent(e)})),this.appConfig=g.getConfig(),this.removeParentsOfOtherSizeModes(c,h,s);return T(this.appConfig,e.layoutId)===s&&s===this.appConfig.mainSizeMode&&(this.appConfig=Lo.afterLayoutItemCopied(this.appConfig,e,c)),d}syncPlaceholder(e,t,o){var i;const n=Lo.getPlaceholderInfo(this.appConfig,e);if(null===(i=null==n?void 0:n.syncs)||void 0===i?void 0:i[o]){const{layoutId:t,layoutItemId:i}=n.syncs[o];t===e.layoutId&&i===e.layoutItemId&&(this.appConfig=this.appConfig.setIn(["placeholderInfos",n.id,"syncs"],n.syncs.without(o)))}return this.appConfig=this.appConfig.setIn(["placeholderInfos",t,"syncs",o],e),this}moveLayoutItem(e,t,o,i){const n=Ft.getService(this.appConfig,t).moveLayoutItem(this.appConfig,e,t,o,i);return this.appConfig=n[0],n[1]}setLayoutItemToPending(e,t){if(!P.searchUtils.findLayoutItem(this.appConfig,e))return this;if(t){const t=Ft.getService(this.appConfig,e.layoutId);this.appConfig=t.pendItem(this.appConfig,e)}else this.appConfig=this.appConfig.setIn(["layouts",e.layoutId,"content",e.layoutItemId,"isPending"],t);return this}removeLayoutItem(e,t,o){const i=Ft.getService(this.appConfig,e.layoutId);return this.appConfig=i.removeItem(this.appConfig,e,P.utils.getCurrentSizeMode(),t,o),this}removeLayout(e){return this.removeSizeModeLayout(e,P.utils.getCurrentSizeMode())}clearLayoutContent(e){var t;const o=this.appConfig.layouts[e];return o?(Object.keys(null!==(t=o.content)&&void 0!==t?t:{}).forEach((t=>{this.removeLayoutItem({layoutId:e,layoutItemId:t},!0,!1)})),this):this}duplicateLayout(e,t){if(!this.appConfig.layouts[e])return null;const o=Ft.getService(this.appConfig,e),i=P.utils.getCurrentSizeMode(),n=o.duplicateLayout(this.appConfig,e,i,i,null,t);this.appConfig=n[0];const s=n[1];return this.appConfig.layouts[s]}editLayoutProperty(e,t,o){let i=this.appConfig.layouts[e];return i?(i=this.editJsonProperty(i,t,o),this.appConfig=this.appConfig.setIn(["layouts",e],i),this):this}editLayoutItemProperty(e,t,o){const{layoutId:i,layoutItemId:n}=e;let s=P.searchUtils.findLayoutItem(this.appConfig,e);return s?(s=this.editJsonProperty(s,t,o),this.appConfig=this.appConfig.setIn(["layouts",i,"content",n],s),this):this}editLabelOfTocNode(e,t){switch(e.type){case"view":return this.editViewProperty(e.id,"label",t);case"screen":return this.editScreenProperty(e.id,"label",t);case"widget":return this.editWidgetProperty(e.id,"label",t);case"section":return this.editSectionProperty(e.id,"label",t);case"screenGroup":return this.editScreenGroupProperty(e.id,"label",t);case"layoutItem":return this.editLayoutItemProperty({layoutId:e.layoutId,layoutItemId:e.layoutItemId},"label",t);default:return this}}editLayoutItemSize(e,t,o){var i;if(0===t||0===o)return this;const{layoutId:n,layoutItemId:s}=e,a=this.appConfig.layouts[n],l=null===(i=null==a?void 0:a.content)||void 0===i?void 0:i[s];if(!a||!l)return this;let u=l.setting||(0,r.Immutable)({});if(a.type===r.LayoutType.FixedLayout){const i=l.bbox.set("width",`${t}px`).set("height",`${o}px`);return u=u.setIn(["autoProps","width"],!1).setIn(["autoProps","height"],!1),this.editLayoutItemProperty(e,"bbox",i).editLayoutItemProperty(e,"setting",u)}return u=u.setIn(["autoProps","width"],!1).setIn(["autoProps","height"],!1).set("heightMode","ratio").set("aspectRatio",Number((o/t).toFixed(2))),this.editLayoutItemProperty(e,"setting",u)}exchangeWidthAndHeight(){var e,t,o,i,n;let s;const a=(0,r.getAppStore)().getState();if(s=window.jimuConfig.isBuilder?null===(t=null===(e=null==a?void 0:a.appStateInBuilder)||void 0===e?void 0:e.appRuntimeInfo)||void 0===t?void 0:t.selection:null===(o=null==a?void 0:a.appRuntimeInfo)||void 0===o?void 0:o.selection,!s)return this;const{layoutId:l}=s,u=this.appConfig.layouts[l];if((null==u?void 0:u.type)===r.LayoutType.FixedLayout){const e=P.searchUtils.findLayoutItem(this.appConfig,s);if(e){let t=e.bbox,o=!1,a=null!==(i=e.setting)&&void 0!==i?i:(0,r.Immutable)({});const l=null!==(n=a.autoProps)&&void 0!==n?n:{right:!0,bottom:!0};t=t.set("width",t.height).set("height",t.width),["left","right","top","bottom"].forEach((e=>{l[e]&&(t=t.without(e))})),this.editLayoutItemProperty(s,"bbox",t),null==l.width&&null==l.height||(a=a.setIn(["autoProps","width"],l.height).setIn(["autoProps","height"],l.width),o=!0),"ratio"===a.heightMode&&(a=a.set("heightMode","fixed"),o=!0),o&&this.editLayoutItemProperty(s,"setting",a)}}return this}adjustOrderOfItem(e,t){const{layoutId:o,layoutItemId:i}=e,n=this.appConfig.layouts[o];let s=[].concat(n.order||[]);return s.includes(i)&&(s=s.filter((e=>e!==i))),null!=t&&t>=0&&t<=s.length?s.splice(t,0,i):s.push(i),this.appConfig=this.appConfig.setIn(["layouts",o,"order"],s),this}createLayout(e){const t=Ft.getInstance().getServiceByType(e).createBlankLayout(this.appConfig,e);return this.appConfig=t[0],t[1]}createPageFromTemplate(e){return jo(this,void 0,void 0,(function*(){const t={},o=yield Ao.createPageFromTemplate(this.appConfig,e,t);this.appConfig=o[0];const i=o[1];return this.appConfig=lo.afterBatchCopied(this.appConfig,e.config,t),i}))}createDialogFromTemplate(e){return jo(this,void 0,void 0,(function*(){const t={},o=yield Ao.createDialogFromTemplate(this.appConfig,e,t);this.appConfig=o[0];const i=o[1];return this.appConfig=lo.afterBatchCopied(this.appConfig,e.config,t),i}))}applyHeaderTemplate(e){return jo(this,void 0,void 0,(function*(){const t={};this.appConfig=yield Ao.applyTemplateToHeader(this.appConfig,e,P.utils.getCurrentSizeMode(),t),this.appConfig=lo.afterBatchCopied(this.appConfig,e.config,t)}))}applyFooterTemplate(e){return jo(this,void 0,void 0,(function*(){const t={};this.appConfig=yield Ao.applyTemplateToFooter(this.appConfig,e,P.utils.getCurrentSizeMode(),t),this.appConfig=lo.afterBatchCopied(this.appConfig,e.config,t)}))}applyPageBodyTemplate(e,t){return jo(this,void 0,void 0,(function*(){const o={};this.appConfig=yield Ao.applyTemplateToBody(this.appConfig,e,t,P.utils.getCurrentSizeMode(),o),this.appConfig=lo.afterBatchCopied(this.appConfig,t.config,o)}))}applyDialogTemplate(e,t){return jo(this,void 0,void 0,(function*(){const o={};this.appConfig=yield Ao.applyTemplateToDialog(this.appConfig,e,t,P.utils.getCurrentSizeMode(),o),this.appConfig=lo.afterBatchCopied(this.appConfig,t.config,o)}))}applyGridTemplate(e,t){return jo(this,void 0,void 0,(function*(){const o={};this.appConfig=yield Ao.applyGridTemplate(this.appConfig,e,t,P.utils.getCurrentSizeMode(),o),this.appConfig=lo.afterBatchCopied(this.appConfig,t.config,o)}))}createScreenFromTemplate(e,t){return jo(this,void 0,void 0,(function*(){const o={},i=yield wo.createScreenFromTemplate(this.appConfig,t,e,[P.utils.getCurrentSizeMode()],o);return this.appConfig=i[0],this.appConfig=lo.afterBatchCopied(this.appConfig,t.config,o),i[1]}))}copyUseDataSourceToAllChildWidgets(e,t){const o=P.searchUtils.getChildrenContents(this.appConfig,t.id,r.LayoutItemType.Widget,!0),i=t.useDataSources&&t.useDataSources.map((e=>e.set("fields",[])))[0],n=e.useDataSources&&e.useDataSources.map((e=>e.set("fields",[])))[0];return i&&n&&i.dataSourceId===n.dataSourceId||o.forEach((e=>{let t=this.appConfig.widgets[e];t.useDataSources&&n&&t.useDataSources.find((e=>e.dataSourceId===n.dataSourceId))&&(t=t.set("useDataSources",t.useDataSources.filter((e=>e.dataSourceId!==n.dataSourceId)))),i&&(t=t.set("useDataSources",t.useDataSources?t.useDataSources.concat(i):[i]).set("useDataSourcesEnabled",!0)),this.appConfig=this.appConfig.setIn(["widgets",e],t)})),this}addDataSource(e){return this.appConfig=Vt.addDataSource(this.appConfig,e),this}addDataSources(e){return e.forEach((e=>{this.appConfig.dataSources&&this.appConfig.dataSources[e.id]||(this.appConfig=this.appConfig.setIn(["dataSources",e.id],e))})),this}addUtility(e){var t;let o=null!==(t=this.appConfig.utilities)&&void 0!==t?t:(0,r.Immutable)({});return o=o.set(e.id,e),this.appConfig=this.appConfig.set("utilities",o),this}removeUtility(e){var t;let o=null!==(t=this.appConfig.utilities)&&void 0!==t?t:(0,r.Immutable)({});const i=qt();try{i.forEach((t=>{if(!t.utilityWillRemove)return;const o=this.appConfig.widgets[t.widgetId];o&&o.useUtilities&&o.useUtilities.find((t=>t.utilityId===e))&&(this.appConfig=t.utilityWillRemove(this.appConfig,e))}))}catch(e){console.error("Error when calling utilityWillRemove",e)}return o=o.without(e),this.appConfig=this.appConfig.set("utilities",o),this}updateUtilities(e){return this.appConfig=this.appConfig.set("utilities",e),this}removeDataSource(e){return this.appConfig=Vt.removeDataSource(this.appConfig,e),this}editDataSource(e){return this.appConfig=this.appConfig.setIn(["dataSources",e.id],e),this}duplicateDataSource(e){const t=Vt.duplicateDataSource(this.appConfig,e);return this.appConfig=t[0],t[1]}addAppProxy(e){return this.appConfig.appProxies&&this.appConfig.appProxies[e.id]||(this.appConfig=this.appConfig.setIn(["appProxies",e.id],e)),this}editAppProxy(e){return this.appConfig=this.appConfig.setIn(["appProxies",e.id],e),this}removeAppProxy(e){return this.appConfig.appProxies&&this.appConfig.appProxies[e]?(this.appConfig=this.appConfig.set("appProxies",this.appConfig.appProxies.without(e)),this):this}addMessage(e){return this.appConfig=this.appConfig.setIn(["messageConfigs",e.id],e),this}editMessage(e){return this.appConfig=this.appConfig.setIn(["messageConfigs",e.id],e),this}removeMessage(e){return this.appConfig.messageConfigs&&this.appConfig.messageConfigs[e.id]?(this.appConfig=this.appConfig.set("messageConfigs",this.appConfig.messageConfigs.without(e.id)),this):this}editTheme(e){return this.appConfig=this.appConfig.set("theme",e),this}editCustomTheme(e){return this.appConfig=this.appConfig.set("customTheme",e),this}editCustomThemeOption(e){return this.appConfig=this.appConfig.set("customThemeOptions",e),this}initHeaderLayout(){const e=this.createLayout(r.LayoutType.FixedLayout);return this.editLayoutProperty(e,"setting.lockDescendants",!0),this.appConfig=this.appConfig.setIn(["layouts",e,"parent"],{id:"",type:r.LayoutParentType.Header}).setIn(["header","layout",this.appConfig.mainSizeMode],e),this}editHeaderProperty(e,t){let o=this.appConfig.header;return o?(o=this.editJsonProperty(o,e,t),this.appConfig=this.appConfig.set("header",o),this):this}initFooterLayout(){const e=this.createLayout(r.LayoutType.FixedLayout);return this.editLayoutProperty(e,"setting.lockDescendants",!0),this.appConfig=this.appConfig.setIn(["layouts",e,"parent"],{id:"",type:r.LayoutParentType.Footer}).setIn(["footer","layout",this.appConfig.mainSizeMode],e),this}editFooterProperty(e,t){let o=this.appConfig.footer;return o?(o=this.editJsonProperty(o,e,t),this.appConfig=this.appConfig.set("footer",o),this):this}setViewportSize(e,t){return this.appConfig=this.appConfig.setIn(["forBuilderAttributes","viewPortSize",e],t),this}setLockLayout(e){return this.appConfig=this.appConfig.setIn(["forBuilderAttributes","lockLayout"],e),this}editAttributes(e){return this.appConfig=this.appConfig.setIn(["attributes"],e),this}updateAnalyticsConfig(e){return this.appConfig=this.appConfig.setIn(["analytics"],e),this}updateCookieBannerConfig(e){return this.appConfig=this.appConfig.setIn(["cookieBanner"],e),this}editCookieBannerConfig(e,t){return this.appConfig="string"==typeof e?this.appConfig.setIn(["cookieBanner",e],t):this.appConfig.setIn(["cookieBanner",...e],t),this}removeCookieBannerConfig(){return this.appConfig=this.appConfig.without("cookieBanner"),this}updateUrlParamsConfig(e){this.appConfig.urlParams||(this.appConfig=this.appConfig.set("urlParams",{}));const t=this.appConfig.urlParams.merge(e);return this.appConfig=this.appConfig.set("urlParams",t),this}getDuplicateLabel(e,t){const[o]=x(t);let i=D(this.appConfig,e,o);return i===o&&(i=`${o} 1`),i}removePageFromPageStructure(e){if(!this.appConfig.pageStructure)return this;return this.appConfig.pageStructure.find((t=>!!t[e]))?this.appConfig=this.appConfig.set("pageStructure",this.appConfig.pageStructure.flatMap((t=>t[e]?[]:[t]))):this.appConfig.pageStructure.forEach(((t,o)=>{const i=Object.keys(t).find((o=>t[o].includes(e)));if(i)return this.appConfig=this.appConfig.setIn(["pageStructure",o+"",i],t[i].flatMap((t=>t===e?[]:[t]))),!0})),this}movePageIntoPageForPageStructure(e,t){return this.appConfig.pageStructure?(this.appConfig.pageStructure.some(((o,i)=>{const n=Object.keys(o).find((e=>e===t));if(n)return this.appConfig=this.appConfig.setIn(["pageStructure",i+"",n],this.appConfig.pageStructure[i][n].concat([e])),!0})),this):this}editJsonProperty(e,t,o){if(!e)return e;const i=t.split(".").filter((e=>""!==e));if(i.length>0){if(e.getIn(i)===o)return e;if(null==o){if(1===i.length)return e.without(i[0]);const t=i.pop(),o=e.getIn(i);return e.setIn(i,o.without(t))}return e.setIn(i,o)}return e}}const{getTranslatedLocale:Oo}=r.i18n;class _o{constructor(){this.actionSettings={}}static getInstance(){return _o.instance||(_o.instance=new _o),_o.instance}loadAllActionSettingClasses(){var e;const t=Uo();return Object.keys((null===(e=t.appConfig)||void 0===e?void 0:e.widgets)||{}).forEach((e=>{var o;const i=t.appConfig.widgets[e],n=[].concat(null===(o=i.manifest)||void 0===o?void 0:o.dataActions).filter((e=>e));n.length>0&&n.forEach((e=>{if(e.settingUri){const t=`${i.uri}dist/${e.settingUri}`;this.actionSettings[t]||(this.actionSettings[t]=r.moduleLoader.loadModule(t,["default"]).then((e=>{const t=e.default;return w.getInstance().loadI18nMessagesForSetting(i.uri).then((e=>this.injectActionSettingProps(t,e,i.id)))})))}}))})),this.actionSettings}injectActionSettingProps(e,t,o){const i=(0,r.injectIntl)(e),n=(0,r.getAppStore)().getState().appStateInBuilder.appConfig.widgets[o];let s=null;s=o&&n?(0,r.getAppStore)().getState().appStateInBuilder.appConfig.widgets[o].manifest.name:"Framework";class a extends r.React.PureComponent{render(){const e={messages:t},s=(0,r.getAppStore)().getState().appI18nMessages;let a=null;o&&n?(a=Oo((0,r.getAppStore)().getState().appContext.locale,n.manifest.translatedLocales.asMutable()),a||(a=n.manifest.translatedLocales&&n.manifest.translatedLocales[0]),a||(a=(0,r.getAppStore)().getState().appContext.locale)):a=(0,r.getAppStore)().getState().appContext.locale;const l=Object.assign({},t,s);return r.React.createElement(r.IntlProvider,{locale:a,messages:l},r.React.createElement(i,Object.assign({},this.props,e)))}}a.displayName=`ActionSettingWrapper(${s})`;for(const t in e)a[t]||(a[t]=e[t]);return a}}var ko=d(108);class Eo{constructor(){this.isGeneralUrlConfigEnable=e=>{var t;const o=r.urlManagerUtils.getAppConfig(),i=null===(t=null==o?void 0:o.urlParams)||void 0===t?void 0:t.getIn(["general",e]);let n=null==i?void 0:i.isEnable;return void 0===n&&(n=!0),n}}static getInstance(){return Eo.instance||(Eo.instance=new Eo),Eo.instance}getWidgetsUseUrlParamsInManifest(){const e=r.urlManagerUtils.getAppConfig();let t=null;if(null==e?void 0:e.widgets){t=r.Immutable.from({});for(const o of Object.keys(e.widgets)){const i=e.widgets[o],n=i.manifest.urlParameters;if((null==n?void 0:n.length)>0){t=t.set(o,i);const e=n.map((e=>{var t,o;const n=e.name,s=null!==(t=i.manifest.i18nMessages[`_url_params_${n}_label`])&&void 0!==t?t:e.label;if((e=e.set("label",s)).tooltip){const t=null!==(o=i.manifest.i18nMessages[`_url_params_${n}_tooltip`])&&void 0!==o?o:e.tooltip;e=e.set("tooltip",t)}return e}));t=t.setIn([o,"manifest","urlParameters"],e)}}}return t}updateGeneralUrlConfigEnable(e,t){var o,i;let n=r.urlManagerUtils.getAppConfig(),s=null===(o=n.urlParams)||void 0===o?void 0:o.getIn(["general",e]);s||(s=r.Immutable.from({isEnable:!1})),s=null==s?void 0:s.merge({isEnable:t}),n.urlParams||(n=n.setIn(["urlParams"],r.Immutable.from({general:{}})));const a=null===(i=n.urlParams)||void 0===i?void 0:i.setIn(["general",e],s);this.updateUrlParamsConfig(a)}isWidgetParamEnable(e,t,o){var i;let n=!0;const s=null===(i=r.urlManagerUtils.getAppConfig().urlParams)||void 0===i?void 0:i.getIn(["widgets",e]);return n=null==s?void 0:s.getIn(["params",t]),void 0===n&&(n=!0,o&&(n=!1)),n}updateWidgetEnable(e,t){let{appConfig:o,widgetUrlConfig:i}=this.getWidgetsUrlParamsConfig(e);i=null==i?void 0:i.merge({isEnable:t}),this._setWidgetUrlConfig(e,i,o,(0,ko.getAppConfigAction)())}updateWidgetParamEnable(e,t,o){let{appConfig:i,widgetUrlConfig:n}=this.getWidgetsUrlParamsConfig(e);n=n.setIn(["params",t],o),this._setWidgetUrlConfig(e,n,i,(0,ko.getAppConfigAction)())}getFlatPageInfos(e){let t=[];return null==e||e.forEach((e=>{var o;const i=Object.keys(e)[0];t.push(i),(null===(o=e[i])||void 0===o?void 0:o.length)>0&&(t=t.concat(e[i].flat()))})),t}getWidgetsInPages(e,t){const o=[],i=r.urlManagerUtils.getAppConfig(),n=this.getFlatPageInfos(null==i?void 0:i.pageStructure);return null==n||n.forEach((n=>{const s={type:r.ContainerType.Page,id:n},a=P.searchUtils.getContentsInContainerRecursive(i,s,r.LayoutItemType.Widget,e),l=this._findCommonWidgetsInManifest(a),u={id:n,label:this._getPageLabel(n)};let d=[];l.forEach((e=>{d.push({id:e,label:this._getWidgetLabel(e)})})),t&&(d=d.filter((e=>{var o;return null===(o=e.label)||void 0===o?void 0:o.toLowerCase().includes(t.toLowerCase())}))),o.push({pageInfo:u,widgetsInfo:d})})),o}_findCommonWidgetsInManifest(e){const t=this.getWidgetsUseUrlParamsInManifest(),o=Object.keys(t),i=[];return e.forEach((e=>{o.includes(e)&&i.push(e)})),i}_getWidgetLabel(e){const t=r.urlManagerUtils.getAppConfig().widgets.getIn([e]);return(null==t?void 0:t.label)||e}_getPageLabel(e){const t=r.urlManagerUtils.getAppConfig().pages.getIn([e]);return(null==t?void 0:t.label)||e}getWidgetsUrlParamsConfig(e){var t;const o=r.urlManagerUtils.getAppConfig();let i=null===(t=o.urlParams)||void 0===t?void 0:t.getIn(["widgets",e]);return i||(i=r.Immutable.from({isEnable:!0})),{appConfig:o,widgetUrlConfig:i}}_setWidgetUrlConfig(e,t,o,i){var n;o.urlParams||(o=o.setIn(["urlParams"],r.Immutable.from({widgets:{}})));const s=null===(n=o.urlParams)||void 0===n?void 0:n.setIn(["widgets",e],t);this.updateUrlParamsConfig(s)}updateUrlParamsConfig(e){(0,ko.getAppConfigAction)().updateUrlParamsConfig(e).exec()}}const Bo=Eo;var zo=d(886),Wo=d.n(zo),Fo=d(490),$o=d.n(Fo),No=d(153),Go=d.n(No),Ho=d(617),qo=d.n(Ho),Vo=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};function Ko(e,t,o){let i;return i=e.type===r.PageType.Folder?{svg:Go(),properties:{filename:"folder",originalName:"outlined/application/folder.svg",path:["general","folder"],color:"var(--dark-800)",inlineSvg:!0}}:e.type===r.PageType.Link?{svg:$o(),properties:{filename:"link",originalName:"outlined/data/link-tilted.svg",path:["general","link"],color:"var(--dark-800)",inlineSvg:!0}}:{svg:Wo(),properties:{filename:o||(null==t?void 0:t("page"))||"",originalName:"outlined/data/page.svg",color:"var(--dark-800)",inlineSvg:!0}},i}function Jo(){return qo()}function Qo(){return co()}function Zo(e,t){if(!e)return[];const o=[];return Object.keys(e).some((i=>{e[i].autoOpenDialogId===t&&o.push({id:i,label:e[i].label})})),o}let Yo=null;function Xo(){return Yo||(Yo=fetch(`${r.moduleLoader.resolveModuleFullPath("widgets/")}/widgets-info.json`).then((e=>Vo(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>e.filter((e=>{const t=(0,r.getAppStore)().getState().portalUrl;return!r.portalUrlUtils.isAGOLDomain(t)||!e.manifest.notSupportAGOL})).map((e=>{var t,o;e.manifest=r.appConfigUtils.addWidgetManifestProperties(e.manifest);const i=r.i18n.findLocale((0,r.getAppStore)().getState().appContext.locale,e.manifest.translatedLocales);return{itemType:r.LayoutItemType.Widget,name:e.name,label:(null===(t=e.i18nLabel)||void 0===t?void 0:t[i])||e.manifest.label||e.name,desription:(null===(o=e.i18nDescription)||void 0===o?void 0:o[i])||e.manifest.desription||e.name,uri:e.uri,manifest:e.manifest,icon:"../"+e.icon,group:e.group,order:e.order}})))).catch((e=>(console.error("Failed to fetch common widget list. ",e),[])))),Yo}let ei=null;function ti(){if(!si())return Promise.resolve([]);if(!ei){const e='type:"Experience Builder Widget" AND typekeywords:"Widget"';ei=r.esri.restPortal.searchItems({q:e,num:100,start:0,authentication:r.SessionManager.getInstance().getSessionByUrl((0,r.getAppStore)().getState().portalUrl)}).then((e=>e.results)).then((e=>{let t=[];return e.forEach(((e,o)=>{if(!e.url)return;const i=function(e){let t;t=/manifest\.json$/.test(e)?e.substring(0,e.length-13):/\/$/.test(e)?e:e+"/";return t=t.replace(/^http:\/\//,"https://"),t}(e.url),n=r.appConfigUtils.getWidgetContext(i),s={itemType:r.LayoutItemType.Widget,name:e.url,label:e.title,itemId:e.id,manifest:{},icon:`${n.folderUrl}icon.svg`,uri:n.folderUrl,group:ui,order:o};t=t.concat(s)})),Promise.allSettled(t.map((e=>fetch(`${e.uri}manifest.json`).then((e=>e.json()))))).then((e=>e.map((e=>"fulfilled"===e.status?e.value:null)))).then((e=>t.map(((t,o)=>Object.assign(Object.assign({},t),{manifest:e[o]||{defaultSize:{width:400,height:400}}})))))})).catch((e=>(console.error("Failed to fetch custom widget list. ",e),[])))}return ei}function oi(e,t){if(!e||!t)return"";switch(e){case 1:return t.formatMessage({id:"mapCentric",defaultMessage:$e.defaultMessages.mapCentric});case 2:return t.formatMessage({id:"dataCentric",defaultMessage:$e.defaultMessages.dataCentric});case 3:return t.formatMessage({id:"pageElements",defaultMessage:$e.defaultMessages.pageElements});case 4:return t.formatMessage({id:"menuAndTollbars",defaultMessage:$e.defaultMessages.menuAndTollbars});case 8:return t.formatMessage({id:"layout",defaultMessage:r.defaultMessages.layout});case 9:return t.formatMessage({id:"section",defaultMessage:r.defaultMessages.section});case 10:return t.formatMessage({id:"locationReferencing",defaultMessage:r.defaultMessages.locationReferencing});case ui:return t.formatMessage({id:"custom",defaultMessage:$e.defaultMessages.custom});default:return""}}function ii(e){return{itemType:r.LayoutItemType.Section,label:null==e?void 0:e.formatMessage({id:"section",defaultMessage:r.defaultMessages.section}),uri:"",manifest:{properties:{},defaultSize:{width:500,height:500}},icon:co(),name:"section",group:9,order:900}}function ni(e){return{itemType:r.LayoutItemType.Widget,label:null==e?void 0:e.formatMessage({id:"placeholder",defaultMessage:$e.defaultMessages.placeholder}),uri:null,manifest:{defaultSize:{width:300,height:300}},icon:Yt(),name:"placeholder",group:8,order:899}}function si(){var e,t;return null===(t=null===(e=(0,r.getAppStore)().getState().appContext)||void 0===e?void 0:e.jimuConfig)||void 0===t?void 0:t.isInPortal}function ai(e){return si()||(null==e?void 0:e.some((e=>e.group===ui)))}function ri(e,t=!1){const o=(0,r.getAppStore)().getState().queryObject;let i=`${window.jimuConfig.mountPath}builder/?id=${e}`;return o.locale&&(i=r.urlUtils.appendQueryParam(i,"locale",o.locale)),o.__env__&&(i=r.urlUtils.appendQueryParam(i,"__env__",o.__env__)),t&&(i=r.urlUtils.appendQueryParam(i,"mode","express")),i}function li(e,t){const o=(0,r.getAppStore)().getState().queryObject;let i=`${window.jimuConfig.mountPath}`;return o.locale&&(i=r.urlUtils.appendQueryParam(i,"locale",o.locale)),o.__env__&&(i=r.urlUtils.appendQueryParam(i,"__env__",o.__env__)),t&&(i=r.urlUtils.appendQueryParam(i,"views",t)),i}const ui=7;var di=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};const ci=d(546),pi=["en","de","es","fr","ja","ru","zh-cn"];function gi(){const e=window.locale.toLowerCase();let t=!1;if(pi.includes(e))t=!0;else{const o=e.split("-")[0];for(let e=0;e<pi.length;e++)if(o===pi[e].split("-")[0]){t=!0;break}}return t}function hi(e){return di(this,void 0,void 0,(function*(){return yield vi("build-apps",e)}))}function fi(){return di(this,void 0,void 0,(function*(){return window.jimuConfig.isDevEdition?yield vi(void 0,"home",!0):yield vi("get-started","what-is-arcgis-experience-builder",!0)}))}function yi(){return di(this,void 0,void 0,(function*(){return yield vi("get-started","whats-new",!0)}))}function mi(e){return di(this,void 0,void 0,(function*(){return yield vi("widgets",e)}))}function vi(e,t,o){return di(this,void 0,void 0,(function*(){let i,n=null;if(t=t.toLowerCase(),window.jimuConfig.isDevEdition){i="https://developers.arcgis.com/experience-builder/";const o=ci.dev;n=e?o[e][t]&&`${o[e].prefix}${o[e][t]}`:o[t]&&`${o[t]}`;let s=i+"#";return n?(s=i+n,yield Promise.resolve(s)):yield Promise.resolve(s)}{const s=(0,r.getAppStore)().getState().portalUrl;if(window.jimuConfig.isInPortal){const i=gi()?r.i18n.findLocale(window.locale,pi):"en",a=ci.portal;n=e?`${a[e][t]}`:`${a[t]}`;const l={"Content-Type":"text/json"},u=function(e,t){let o="";const i=(0,r.getAppStore)().getState().portalSelf,n=null==i?void 0:i.helpBase.split("/");o=(null==n?void 0:n.includes("https:"))?n.slice(0,3).join("/")+"/"+t:e+"/"+(null==n?void 0:n[2])+"/"+t;return o}(s,i),d=u.includes("https:")?u+"/experience-builder":u;return yield fetch(s+"/sharing/rest/portals/helpmap?f=json",{method:"get",headers:l}).then((e=>di(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>di(this,void 0,void 0,(function*(){if(e&&e.helpMap&&e.helpMap.m&&n&&e.helpMap.m[n]){const t=u+"/"+e.helpMap.m[n];return yield Promise.resolve(t)}return o?yield Promise.resolve(d):yield fi()})))).catch((e=>di(this,void 0,void 0,(function*(){return console.warn(e),o?yield Promise.resolve(d):yield fi()}))))}{const o=ci.online;n=e?o[e][t]&&`${o[e].prefix}${o[e][t]}`:o[t]&&`${o[t]}`;i="https://"+(s.includes("maps.arcgis.com")||s.includes("www.arcgis.com")?"doc":"docdev")+".arcgis.com/en/experience-builder/";let a=i+"#";if(!n)return yield Promise.resolve(a);if(a=i+n,gi()){r.portalUrlUtils.getPortalSelfInfoUrl(s);const e=function(e,t,o){let i;const n=(0,r.getAppStore)().getState().portalSelf;if(n&&n.helpBase){try{i=n.helpBase.split("/").slice(0,4).join("/")+"/experience-builder/"}catch(e){return o}return i?i+t:o}return o}(0,n,a);return yield Promise.resolve(e)}return yield Promise.resolve(a)}}}))}function Si(e,t,o){(null==e?void 0:e.config)&&r.appConfigUtils.fixLayoutIds(e.config);const i=t?r.i18n.getIntl(t,"setting"):r.i18n.getIntl();return e=r.utils.replaceI18nPlaceholdersInObject(e,i,o)}class Ii extends r.React.PureComponent{constructor(){super(...arguments),this.isSupportKeyboard=()=>{let e=!1;return window.jimuConfig.isBuilder&&"home"!==this.props.currentPageId&&"template"!==this.props.currentPageId?(e=!0,e):e},this.switchAppMode=()=>{var e,t;(null===(t=null===(e=(0,r.getAppStore)().getState().appStateInBuilder)||void 0===e?void 0:e.appRuntimeInfo)||void 0===t?void 0:t.appMode)===r.AppMode.Run?Je(r.AppMode.Design):Je(r.AppMode.Run)},this.undo=()=>{this.props.stateHistory.past.length<=1||(0,r.getAppStore)().dispatch(G.InBuilderAppConfigUndo())},this.redo=()=>{this.props.stateHistory.future.length<=0||(0,r.getAppStore)().dispatch(G.InBuilderAppConfigRedo())},this.onKeyboardTrigger=e=>{e.key.includes("-manual")||ot(e)},this.isMac=()=>{var e,t;return"macOS"===(null===(t=null===(e=window.jimuUA)||void 0===e?void 0:e.os)||void 0===t?void 0:t.name)}}render(){return this.isMac()?this.isSupportKeyboard()?r.React.createElement(r.Keyboard,{onKeyboardTrigger:this.onKeyboardTrigger,bindings:{"shift+alt+keyx":()=>{this.switchAppMode()},"command+keyz":()=>{this.undo()},"command+shift+keyz":()=>{this.redo()}}}):null:this.isSupportKeyboard()?r.React.createElement(r.Keyboard,{onKeyboardTrigger:this.onKeyboardTrigger,bindings:{"shift+alt+keyx":()=>{this.switchAppMode()},"ctrl+keyz":()=>{this.undo()},"ctrl+shift+keyz":()=>{this.redo()}}}):null}}const wi=r.ReactRedux.connect((e=>({currentPageId:e.appRuntimeInfo.currentPageId,stateHistory:e.appStateHistory})))(Ii);function Ci(e){var t,o,i;const{widgetId:n,useDataSource:s,messageType:a,arcGISDataSourceTypes:l}=e,u=null===(o=null===(t=(0,r.getAppStore)().getState())||void 0===t?void 0:t.appStateInBuilder)||void 0===o?void 0:o.appConfig,d=null===(i=null==u?void 0:u.widgets)||void 0===i?void 0:i[n],c=function(e,t){var o,i,n,s;const a=null===(i=null===(o=(0,r.getAppStore)().getState())||void 0===o?void 0:o.appStateInBuilder)||void 0===i?void 0:i.appConfig,l=null===(n=null==a?void 0:a.widgets)||void 0===n?void 0:n[e],u=[],d=r.DataSourceManager.getInstance();return null===(s=null==l?void 0:l.useDataSources)||void 0===s||s.forEach((e=>{const o=d.getDataSource(e.dataSourceId);(null==o?void 0:o.type)!==t.WebMap&&(null==o?void 0:o.type)!==t.WebScene||u.push(e.dataSourceId)})),u.length>0?(0,r.Immutable)(u):null}(n,l),p=function(e,t,o){const i=(null==e?void 0:e.outputDataSources)||[],n=(null==e?void 0:e.useDataSources)||[];if(o)return!1;switch(t){case r.MessageCarryData.OutputDataSource:return 1===(null==i?void 0:i.length);case r.MessageCarryData.UseDataSource:return 1===(null==n?void 0:n.length);case r.MessageCarryData.BothDataSource:return 1===i.length+n.length}}(d,Ai(n,a),c),g=s&&s.dataSourceId?(0,r.Immutable)([s.asMutable({deep:!0})]):null,h=c?null:function(e,t){var o;const i=bi(e,t);return(0,r.Immutable)(null!==(o=null==i?void 0:i.map((e=>null==e?void 0:e.mainDataSourceId)))&&void 0!==o?o:[])}(n,a);return{isReadOnly:p,useDataSources:g,fromRootDsIds:c,fromDsIds:h}}function bi(e,t){var o,i,n;const s=Ai(e,t),a=null===(i=null===(o=(0,r.getAppStore)().getState())||void 0===o?void 0:o.appStateInBuilder)||void 0===i?void 0:i.appConfig,l=null===(n=null==a?void 0:a.widgets)||void 0===n?void 0:n[e],u=(null==l?void 0:l.useDataSources)||(0,r.Immutable)([]),d=function(e){var t;const o=null!==(t=null==e?void 0:e.map((e=>({dataSourceId:e,mainDataSourceId:e,rootDataSourceId:null}))))&&void 0!==t?t:[];return(0,r.Immutable)(o)}(null==l?void 0:l.outputDataSources)||(0,r.Immutable)([]),c=null==u?void 0:u.asMutable({deep:!0}).concat(null==d?void 0:d.asMutable({deep:!0}));switch(s){case r.MessageCarryData.OutputDataSource:return d;case r.MessageCarryData.UseDataSource:return u;case r.MessageCarryData.BothDataSource:return(0,r.Immutable)(c)}}function Ai(e,t){const o=Pi(e,t);return o||r.MessageCarryData.UseDataSource}function Pi(e,t){var o,i,n,s;const a=null===(i=null===(o=(0,r.getAppStore)().getState())||void 0===o?void 0:o.appStateInBuilder)||void 0===i?void 0:i.appConfig,l=null===(n=null==a?void 0:a.widgets)||void 0===n?void 0:n[e],u=null===(s=null==l?void 0:l.manifest)||void 0===s?void 0:s.publishMessages;let d=null;return u.forEach((e=>{const o=e;(null==o?void 0:o.messageCarryData)&&(null==o?void 0:o.messageType)===t&&(d=null==o?void 0:o.messageCarryData)})),d}function Li(e){var t,o,i,n,s,a,l,u,d,c,p,g,h,f;const{widgetId:y,oldUseDataSource:m,messageType:v,arcGISDataSourceTypes:S}=e,I=(0,r.getAppStore)().getState().appStateInBuilder.appConfig,w=r.DataSourceManager.getInstance(),C=I.widgets[y];let b=null,A=!1;const P=null===(o=null===(t=w.getDataSource(m.dataSourceId))||void 0===t?void 0:t.getDataSourceJson())||void 0===o?void 0:o.isOutputFromWidget,L=bi(y,v),M=(null==L?void 0:L[0])&&(null===(i=null==L?void 0:L[0])||void 0===i?void 0:i.dataSourceId);if(!M)return null;const D=null===(n=w.getDataSource(M))||void 0===n?void 0:n.getDataSourceJson();if(!D||D.type!==S.WebMap&&D.type!==S.WebScene||(A=!0),A){let e=!1;if(C&&C.useDataSources)for(let t=0;t<C.useDataSources.length;t++)if(C.useDataSources[t].dataSourceId===m.rootDataSourceId){e=!0;break}b=e?m:null}else{let e=!1;if(L)for(let t=0;t<(null==L?void 0:L.length);t++){const o=P?null===(a=null===(s=w.getDataSource(m.dataSourceId))||void 0===s?void 0:s.getMainDataSource())||void 0===a?void 0:a.id:m.dataSourceId;if((P?null===(d=null===(u=w.getDataSource(null===(l=null==L?void 0:L[t])||void 0===l?void 0:l.dataSourceId))||void 0===u?void 0:u.getMainDataSource())||void 0===d?void 0:d.id:null===(c=null==L?void 0:L[t])||void 0===c?void 0:c.dataSourceId)===o){e=!0;break}}b=e?m:1===(null==L?void 0:L.length)?(0,r.Immutable)({dataSourceId:null===(p=null==L?void 0:L[0])||void 0===p?void 0:p.dataSourceId,mainDataSourceId:null===(g=null==L?void 0:L[0])||void 0===g?void 0:g.mainDataSourceId,dataViewId:null===(h=null==L?void 0:L[0])||void 0===h?void 0:h.dataViewId,rootDataSourceId:null===(f=null==L?void 0:L[0])||void 0===f?void 0:f.rootDataSourceId}):null}return b}function Mi(e){return!(!e.messageUseDataSource||!e.actionUseDataSource)&&!(e.messageUseDataSource.mainDataSourceId!==e.actionUseDataSource.mainDataSourceId||!function(e){return!e.messageUseDataSource.rootDataSourceId&&!e.actionUseDataSource.rootDataSourceId||e.messageUseDataSource.rootDataSourceId===e.actionUseDataSource.rootDataSourceId}(e))}var Di=d(37),xi=d.n(Di),Ti=function(e,t){var o={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(o[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(o[i[n]]=e[i[n]])}return o};const ji=e=>{const t=window.SVG,{className:o}=e,i=Ti(e,["className"]),n=(0,r.classNames)("jimu-icon jimu-icon-component",o);return t?r.React.createElement(t,Object.assign({className:n,src:xi()},i)):r.React.createElement("svg",Object.assign({className:n},i))},Ui=e=>{const{messageDataSource:t,actionDataSource:o,connectionType:i,onUseLayersRelationship:n,onSetCustomFields:s}=e,[a,l]=r.React.useState(!1);r.React.useEffect((()=>{if(!t||!o)return;const e=r.dataSourceUtils.getMainOriginDataSource(t),i=r.dataSourceUtils.getMainOriginDataSource(o);(null==e?void 0:e.createRelatedDataSources)?e.createRelatedDataSources().then(((e=[])=>{e.includes(i)?l(!0):l(!1)})):l(!1)}),[t,o]);const u=r.hooks.useLatest(i);r.React.useEffect((()=>{u.current||(a?n():s())}),[a,u,s,n]);const d=r.hooks.useTranslation(_e);return a?(0,r.jsx)(r.React.Fragment,null,(0,r.jsx)($e.Label,{className:"justify-content-start",onClick:n},(0,r.jsx)($e.Radio,{className:"mr-2",role:"radio",checked:i===r.MessageActionConnectionType.UseLayersRelationship}),d("frameworkAction_UseRelationship")),(0,r.jsx)($e.Label,{className:"mt-3 justify-content-start",onClick:s},(0,r.jsx)($e.Radio,{className:"mr-2",role:"radio",checked:!i||i===r.MessageActionConnectionType.SetCustomFields}),d("frameworkAction_CustomFields"))):null};class Ri extends r.React.PureComponent{constructor(e){super(e),this.modalStyle={position:"absolute",top:"0",bottom:"0",width:"259px",height:"auto",borderRight:"",borderBottom:"",paddingBottom:"1px"},this.getInitConfig=()=>{var e,t,o,i,n;const{messageWidgetId:s,messageType:a,config:l}=this.props,u=r.DataSourceManager.getInstance();let d=null,c=!0;const p=this.getMessageUseDataSource();if(p)d=Li({widgetId:s,oldUseDataSource:p,messageType:a,arcGISDataSourceTypes:this.state.ArcGISDataSourceTypes});else{const l=bi(s,a);if((null==l?void 0:l[0])&&1===(null==l?void 0:l.length)){const s=null===(e=u.getDataSource(null==l?void 0:l[0].dataSourceId))||void 0===e?void 0:e.getDataSourceJson();d=!s||s.type!==this.state.ArcGISDataSourceTypes.WebMap&&s.type!==this.state.ArcGISDataSourceTypes.WebScene?(0,r.Immutable)({dataSourceId:null===(t=null==l?void 0:l[0])||void 0===t?void 0:t.dataSourceId,mainDataSourceId:null===(o=null==l?void 0:l[0])||void 0===o?void 0:o.mainDataSourceId,dataViewId:null===(i=null==l?void 0:l[0])||void 0===i?void 0:i.dataViewId,rootDataSourceId:null===(n=null==l?void 0:l[0])||void 0===n?void 0:n.rootDataSourceId}):null}}if(void 0!==(null==l?void 0:l.enableQueryWithCurrentExtent)&&(c=this.props.config.enableQueryWithCurrentExtent),a===r.MessageType.ExtentChange){if(Array.isArray(l))return null==l?void 0:l.map((e=>this.getInitActionConfigItem(d,c,e)));return[l?this.getInitActionConfigItem(d,c,l):this.getInitActionConfigItem(d,c,null)]}return this.getInitActionConfigItem(d,c,l)},this.getInitActionConfigItem=(e,t,o)=>{var i,n,s,a;let l=null;const u=r.DataSourceManager.getInstance();if(null==o?void 0:o.actionUseDataSource){const e=null===(i=o.actionUseDataSource)||void 0===i?void 0:i.dataSourceId,t=null===(n=o.actionUseDataSource)||void 0===n?void 0:n.rootDataSourceId;l=(null===(s=u.getDataSource(e))||void 0===s?void 0:s.getDataSourceJson())||(null===(a=u.getDataSource(t))||void 0===a?void 0:a.getDataSourceJson())?o.actionUseDataSource:null}else l=null;return{messageUseDataSource:e,actionUseDataSource:l,sqlExprObj:(null==l?void 0:l.dataSourceId)?o.sqlExprObj:null,enableQueryWithCurrentExtent:t}},this.handleTriggerLayerChange=e=>{let t=this.props.config;t=Array.isArray(t)?null==t?void 0:t.map((t=>t=t.set("messageUseDataSource",(null==e?void 0:e[0])||null))):t.set("messageUseDataSource",(null==e?void 0:e[0])||null),this.props.onSettingChange({actionId:this.props.actionId,config:t})},this.handleActionLayerChange=e=>{let t=this.props.config;if(Array.isArray(t)){const o={messageUseDataSource:this.getMessageUseDataSource(),actionUseDataSource:null,sqlExprObj:null,enableQueryWithCurrentExtent:!0,enabledDataRelationShip:!0};t=0===(null==e?void 0:e.length)?[o]:null==e?void 0:e.map((e=>Object.assign(Object.assign({},o),{actionUseDataSource:e})))}else t=t.set("actionUseDataSource",(null==e?void 0:e[0])||null).set("sqlExprObj",null);this.props.onSettingChange({actionId:this.props.actionId,config:t})},this.showSqlExprPopup=()=>{this.setState({isSqlExprShow:!0})},this.toggleSqlExprPopup=()=>{this.setState({isSqlExprShow:!this.state.isSqlExprShow})},this.onSqlExprBuilderChange=e=>{this.handleActionConditionsChange("sqlExprObj",e)},this.handleActionConditionsChange=(e,t)=>{const{config:o,actionId:i,onSettingChange:n}=this.props;let s=o;if(Array.isArray(o)&&1===(null==o?void 0:o.length)){const o=s[0].set(e,t);s=(0,r.Immutable)([o])}else s=o.set(e,t);n({actionId:i,config:s})},this.onMessageFieldSelected=(e,t)=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",{dataSourceId:this.props.config.messageUseDataSource.dataSourceId,mainDataSourceId:this.props.config.messageUseDataSource.mainDataSourceId,dataViewId:this.props.config.messageUseDataSource.dataViewId,rootDataSourceId:this.props.config.messageUseDataSource.rootDataSourceId,fields:e.map((e=>e.jimuName))})})},this.onActionFieldSelected=(e,t)=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",{dataSourceId:this.props.config.actionUseDataSource.dataSourceId,mainDataSourceId:this.props.config.actionUseDataSource.mainDataSourceId,dataViewId:this.props.config.actionUseDataSource.dataViewId,rootDataSourceId:this.props.config.actionUseDataSource.rootDataSourceId,fields:e.map((e=>e.jimuName))})})},this.swicthEnabledDataRelationShip=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("enabledDataRelationShip",e)})},this.swicthEnabledQueryWithCurrentExtent=e=>{this.handleActionConditionsChange("enableQueryWithCurrentExtent",e)},this.checkIsDisableDataView=e=>{var t,o,i,n;if(this.props.messageType===r.MessageType.DataRecordsSelectionChange)return!0;const s=null===(o=null===(t=(0,r.getAppStore)().getState())||void 0===t?void 0:t.appStateInBuilder)||void 0===o?void 0:o.appConfig,a=null===(i=null==s?void 0:s.widgets)||void 0===i?void 0:i[e];if(a){return"Map"===(null===(n=null==a?void 0:a.manifest)||void 0===n?void 0:n.label)}return!1},this.onUseLayersRelationship=()=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.setIn(["messageUseDataSource","fields"],[]).setIn(["actionUseDataSource","fields"],[]).set("connectionType",r.MessageActionConnectionType.UseLayersRelationship)})},this.onSetCustomFields=()=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.setIn(["messageUseDataSource","fields"],[]).setIn(["actionUseDataSource","fields"],[]).set("connectionType",r.MessageActionConnectionType.SetCustomFields)})},this.checkIsShowFrameworkActionConditions=()=>{var e;return!(window.isExpressBuilder||!(null===(e=this.props.config)||void 0===e?void 0:e.actionUseDataSource)||!this.props.config.messageUseDataSource||Array.isArray(this.props.config))},this.getMessageUseDataSource=()=>{var e;const{config:t}=this.props;return Array.isArray(t)?null===(e=t[0])||void 0===e?void 0:e.messageUseDataSource:null==t?void 0:t.messageUseDataSource},this.checkIsNotRenderActionSetting=()=>{const{Button:e,Icon:t,Switch:o,Collapse:i,SettingSection:n,SettingRow:s,FieldSelector:a,DataSourceSelector:r,ArcGISDataSourceTypes:l,SqlExpressionBuilderPopup:u}=this.state;return!(e&&t&&o&&i&&n&&s&&a&&r&&l&&u)},this.renderFrameworkActionConditions=()=>{var e,t;const{Button:o,Switch:i,Collapse:n,SettingSection:s,SettingRow:a,FieldSelector:l,SqlExpressionBuilderPopup:u}=this.state,{config:d,theme:c}=this.props,p=d.messageUseDataSource&&r.DataSourceManager.getInstance().getDataSource(this.props.config.messageUseDataSource.dataSourceId),g=d.actionUseDataSource&&r.DataSourceManager.getInstance().getDataSource(d.actionUseDataSource.dataSourceId),h=Mi(d),f=!d.connectionType||d.connectionType===r.MessageActionConnectionType.SetCustomFields;return(0,r.jsx)(s,{title:this.props.intl.formatMessage({id:"frameworkAction_Conditions",defaultMessage:_e.frameworkAction_Conditions})},(0,r.jsx)(a,{label:this.props.intl.formatMessage({id:"frameworkAction_RelateMessage",defaultMessage:_e.frameworkAction_RelateMessage})},(0,r.jsx)(i,{checked:this.props.config.enabledDataRelationShip,onChange:e=>{this.swicthEnabledDataRelationShip(e.target.checked)}})),(0,r.jsx)(a,null,(0,r.jsx)(n,{isOpen:this.props.config.enabledDataRelationShip,className:"w-100"},(0,r.jsx)(Ui,{messageDataSource:p,actionDataSource:g,connectionType:d.connectionType,onUseLayersRelationship:this.onUseLayersRelationship,onSetCustomFields:this.onSetCustomFields}),h&&(0,r.jsx)("div",{className:"w-100 border p-1 mr-2"},this.props.intl.formatMessage({id:"frameworkAction_AutoBind",defaultMessage:_e.frameworkAction_AutoBind})),!h&&f&&(0,r.jsx)("div",{className:"w-100 d-flex align-items-center mt-3"},(0,r.jsx)("div",{className:"d-flex flex-column relate-panel-left"},(0,r.jsx)(l,{className:"w-100",useDataSources:(0,r.Immutable)([null===(e=this.props.config.messageUseDataSource)||void 0===e?void 0:e.asMutable({deep:!0})]),isDataSourceDropDownHidden:!0,placeholder:this.props.intl.formatMessage({id:"frameworkAction_TriggerLayerField",defaultMessage:_e.frameworkAction_TriggerLayerField}),onChange:this.onMessageFieldSelected,useDropdown:!0,selectedFields:this.props.config.messageUseDataSource&&this.props.config.messageUseDataSource.fields?this.props.config.messageUseDataSource.fields:(0,r.Immutable)([])}),(0,r.jsx)(l,{className:"w-100 action-select-chooser",placeholder:this.props.intl.formatMessage({id:"frameworkAction_ActionLayerField",defaultMessage:_e.frameworkAction_ActionLayerField}),useDataSources:(0,r.Immutable)([null===(t=this.props.config.actionUseDataSource)||void 0===t?void 0:t.asMutable({deep:!0})]),isDataSourceDropDownHidden:!0,onChange:this.onActionFieldSelected,useDropdown:!0,selectedFields:this.props.config.actionUseDataSource&&this.props.config.actionUseDataSource.fields?this.props.config.actionUseDataSource.fields:(0,r.Immutable)([])})),(0,r.jsx)(ji,{autoFlip:!0,className:"flex-none",width:12,height:40,color:c.ref.palette.neutral[900]})))),(0,r.jsx)(a,null,(0,r.jsx)(o,{type:"link",disabled:!this.props.config.actionUseDataSource,className:"w-100 d-flex justify-content-start",onClick:this.showSqlExprPopup},(0,r.jsx)("div",{className:"w-100 text-truncate",style:{textAlign:"start"}},this.props.intl.formatMessage({id:"frameworkAction_MoreConditions",defaultMessage:_e.frameworkAction_MoreConditions}))),this.props.config.actionUseDataSource&&(0,r.jsx)(r.DataSourceComponent,{useDataSource:this.props.config.actionUseDataSource},(e=>(0,r.jsx)(u,{dataSource:e,mode:r.SqlExpressionMode.Simple,isOpen:this.state.isSqlExprShow,toggle:this.toggleSqlExprPopup,expression:this.props.config.sqlExprObj,onChange:e=>{this.onSqlExprBuilderChange(e)},id:"filter-widget-sql-expression-builder-popup"})))),(0,r.jsx)(a,null,(0,r.jsx)("div",{className:"sql-expr-display"},this.props.config.sqlExprObj&&g?r.dataSourceUtils.getArcGISSQL(this.props.config.sqlExprObj,g).displaySQL:this.props.intl.formatMessage({id:"frameworkAction_SetExpression",defaultMessage:_e.frameworkAction_SetExpression}))))},this.renderFrameworkConditionsWhenQueryByExtent=()=>{const{Button:e,Switch:t,SettingSection:o,SettingRow:i,SqlExpressionBuilderPopup:n}=this.state,s=this.props.config;let a,l;Array.isArray(s)?(a=null==s?void 0:s[0],l=s.length>1||a.enableQueryWithCurrentExtent):(a=s,l=a.enableQueryWithCurrentExtent);const u=a.actionUseDataSource&&r.DataSourceManager.getInstance().getDataSource(a.actionUseDataSource.dataSourceId);return(0,r.jsx)(o,{title:this.props.intl.formatMessage({id:"frameworkAction_Conditions",defaultMessage:_e.frameworkAction_Conditions})},(0,r.jsx)(i,{label:this.props.intl.formatMessage({id:"frameworkAction_QueryByExtent",defaultMessage:_e.frameworkAction_QueryByExtent})},(0,r.jsx)(t,{checked:l,onChange:e=>{this.swicthEnabledQueryWithCurrentExtent(e.target.checked)}})),(0,r.jsx)(i,null,(0,r.jsx)(e,{className:"p-0 text-left",type:"link",disabled:!a.actionUseDataSource,onClick:this.showSqlExprPopup,title:this.props.intl.formatMessage({id:"frameworkAction_MoreConditions",defaultMessage:_e.frameworkAction_MoreConditions})},this.props.intl.formatMessage({id:"frameworkAction_MoreConditions",defaultMessage:_e.frameworkAction_MoreConditions}))),(0,r.jsx)(i,null,a.actionUseDataSource&&(0,r.jsx)(r.DataSourceComponent,{useDataSource:a.actionUseDataSource},(e=>(0,r.jsx)(n,{dataSource:e,mode:r.SqlExpressionMode.Simple,isOpen:this.state.isSqlExprShow,toggle:this.toggleSqlExprPopup,expression:a.sqlExprObj,onChange:e=>{this.onSqlExprBuilderChange(e)},id:"filter-widget-sql-expression-builder-popup"}))),(0,r.jsx)("div",{className:"sql-expr-display body-1"},a.sqlExprObj&&u?r.dataSourceUtils.getArcGISSQL(a.sqlExprObj,u).displaySQL:this.props.intl.formatMessage({id:"frameworkAction_SetExpression",defaultMessage:_e.frameworkAction_SetExpression}))))},this.getActionbactionUseDataSource=()=>{const{config:e}=this.props,t=[];return Array.isArray(e)?e.forEach((e=>{(null==e?void 0:e.actionUseDataSource)&&t.push(null==e?void 0:e.actionUseDataSource)})):(null==e?void 0:e.actionUseDataSource)&&t.push(null==e?void 0:e.actionUseDataSource),t},this.checkIsShowConditions=()=>{let e;return e=!Array.isArray(this.props.config)||1===this.props.config.length,!window.isExpressBuilder&&e},this.modalStyle.borderRight="1px solid black",this.modalStyle.borderBottom="1px solid black",this.state={isShowLayerList:!1,currentLayerType:null,isSqlExprShow:!1}}componentDidMount(){r.moduleLoader.loadModules(["jimu-ui","jimu-ui/advanced/setting-components","jimu-ui/advanced/data-source-selector","jimu-arcgis","jimu-ui/advanced/sql-expression-builder"]).then((e=>{this.setState({Button:e[0].Button,Icon:e[0].Icon,Switch:e[0].Switch,Collapse:e[0].Collapse,SettingSection:e[1].SettingSection,SettingRow:e[1].SettingRow,FieldSelector:e[2].FieldSelector,DataSourceSelector:e[2].DataSourceSelector,ArcGISDataSourceTypes:e[3].ArcGISDataSourceTypes,SqlExpressionBuilderPopup:e[4].SqlExpressionBuilderPopup,DSSelectorTypes:(0,r.Immutable)([r.AllDataSourceTypes.FeatureLayer,r.AllDataSourceTypes.SceneLayer,r.AllDataSourceTypes.OrientedImageryLayer,r.AllDataSourceTypes.ImageryLayer,r.AllDataSourceTypes.BuildingComponentSubLayer])},(()=>{let e=this.getInitConfig(),t=this.props.config;t=this.props.messageType===r.MessageType.ExtentChange?(0,r.Immutable)(e):t.set("messageUseDataSource",e.messageUseDataSource).set("actionUseDataSource",e.actionUseDataSource).set("sqlExprObj",e.sqlExprObj),this.props.onSettingChange({actionId:this.props.actionId,config:t})}))}))}getStyle(e){return r.css`
      .setting-header {
        padding: ${r.polished.rem(10)} ${r.polished.rem(16)} ${r.polished.rem(0)} ${r.polished.rem(16)}
      }

      .deleteIcon {
        cursor: pointer;
        opacity: .8;
      }

      .deleteIcon:hover {
        opacity: 1;
      }

      .sql-expr-display {
        width: 100%;
        height: auto;
        min-height: 60px;
        line-height: 25px;
        padding: 3px 5px;
        color: ${e.ref.palette.neutral[900]};
        border: 1px solid ${e.ref.palette.neutral[500]};
      }

      .relate-panel-left {
        flex: auto;
        overflow: hidden;
        .action-select-chooser {
          margin-top: ${r.polished.rem(12)};
        }
      }
    `}render(){const{SettingSection:e,DataSourceSelector:t,ArcGISDataSourceTypes:o}=this.state,{messageWidgetId:i,messageType:n}=this.props;if(this.checkIsNotRenderActionSetting())return null;const s=Ci({widgetId:i,useDataSource:this.getMessageUseDataSource(),messageType:n,arcGISDataSourceTypes:o}),a=this.getActionbactionUseDataSource();return this.props.messageType===r.MessageType.ExtentChange?(0,r.jsx)("div",{css:this.getStyle(this.props.theme)},(0,r.jsx)(e,{title:this.props.intl.formatMessage({id:"frameworkAction_ActionLayer",defaultMessage:_e.frameworkAction_ActionLayer})},(0,r.jsx)(t,{isMultiple:!0,types:this.state.DSSelectorTypes,useDataSources:(0,r.Immutable)(a),hideAddDataButton:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleActionLayerChange,widgetId:this.props.widgetId,enableToSelectOutputDsFromSelf:!0})),this.checkIsShowConditions()&&this.renderFrameworkConditionsWhenQueryByExtent()):(0,r.jsx)("div",{css:this.getStyle(this.props.theme)},(0,r.jsx)(e,{title:this.props.intl.formatMessage({id:"frameworkAction_TriggerLayer",defaultMessage:_e.frameworkAction_TriggerLayer})},(0,r.jsx)(t,{types:this.state.DSSelectorTypes,useDataSources:s.useDataSources,fromRootDsIds:s.fromRootDsIds,fromDsIds:s.fromDsIds,closeDataSourceListOnChange:!0,disableRemove:()=>s.isReadOnly,disableDataSourceList:s.isReadOnly,hideAddDataButton:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleTriggerLayerChange,widgetId:this.props.messageWidgetId,disableDataView:!0,hideDataView:this.checkIsDisableDataView(this.props.messageWidgetId),enableToSelectOutputDsFromSelf:!0})),(0,r.jsx)(e,{title:this.props.intl.formatMessage({id:"frameworkAction_ActionLayer",defaultMessage:_e.frameworkAction_ActionLayer})},(0,r.jsx)(t,{isMultiple:Array.isArray(this.props.config),types:this.state.DSSelectorTypes,useDataSources:(0,r.Immutable)(a),closeDataSourceListOnChange:!0,hideAddDataButton:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleActionLayerChange,widgetId:this.props.widgetId,enableToSelectOutputDsFromSelf:!0})),this.checkIsShowFrameworkActionConditions()&&this.renderFrameworkActionConditions())}}Ri.defaultProps={config:(0,r.Immutable)({messageUseDataSource:null,actionUseDataSource:null,sqlExprObj:null,enabledDataRelationShip:!0,enableQueryWithCurrentExtent:!0})};const Oi=r.ReactRedux.connect((e=>({dataSources:e.appStateInBuilder&&e.appStateInBuilder.appConfig&&e.appStateInBuilder.appConfig.dataSources,dataSourcesInfo:e.appStateInBuilder&&e.appStateInBuilder.dataSourcesInfo})))((0,h.withTheme)(Ri));class _i extends r.React.PureComponent{constructor(e){super(e),this.modalStyle={position:"absolute",top:"0",bottom:"0",width:"259px",height:"auto",borderRight:"",borderBottom:"",paddingBottom:"1px"},this.getInitConfig=()=>{var e,t,o,i,n,s,a,l,u,d,c;const{messageWidgetId:p,messageType:g}=this.props,h=r.DataSourceManager.getInstance();let f=null,y=null;if(this.props.config.messageUseDataSource)f=Li({widgetId:p,oldUseDataSource:this.props.config.messageUseDataSource,messageType:g,arcGISDataSourceTypes:this.state.ArcGISDataSourceTypes});else{const s=bi(p,g);if((null==s?void 0:s[0])&&1===(null==s?void 0:s.length)){const a=null===(e=h.getDataSource(null==s?void 0:s[0].dataSourceId))||void 0===e?void 0:e.getDataSourceJson();f=!a||a.type!==this.state.ArcGISDataSourceTypes.WebMap&&a.type!==this.state.ArcGISDataSourceTypes.WebScene?(0,r.Immutable)({dataSourceId:null===(t=null==s?void 0:s[0])||void 0===t?void 0:t.dataSourceId,mainDataSourceId:null===(o=null==s?void 0:s[0])||void 0===o?void 0:o.mainDataSourceId,dataViewId:null===(i=null==s?void 0:s[0])||void 0===i?void 0:i.dataViewId,rootDataSourceId:null===(n=null==s?void 0:s[0])||void 0===n?void 0:n.rootDataSourceId}):null}}if(this.props.config.actionUseDataSource){const e=null===(a=null===(s=this.props.config)||void 0===s?void 0:s.actionUseDataSource)||void 0===a?void 0:a.dataSourceId,t=null===(u=null===(l=this.props.config)||void 0===l?void 0:l.actionUseDataSource)||void 0===u?void 0:u.rootDataSourceId;y=(null===(d=h.getDataSource(e))||void 0===d?void 0:d.getDataSourceJson())||(null===(c=h.getDataSource(t))||void 0===c?void 0:c.getDataSourceJson())?this.props.config.actionUseDataSource:null}else y=null;return y&&y.dataSourceId?{messageUseDataSource:f,actionUseDataSource:y,sqlExprObj:this.props.config.sqlExprObj}:{messageUseDataSource:f,actionUseDataSource:y,sqlExprObj:null}},this.handleTriggerLayerChange=e=>{e&&e.length>0?this.handleTriggerLayerSelected(e[0]):this.handleRemoveLayerForTriggerLayer()},this.handleActionLayerChange=e=>{e&&e.length>0?this.handleActionLayerSelected(e[0]):this.handleRemoveLayerForActionLayer()},this.handleTriggerLayerSelected=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",e)})},this.handleActionLayerSelected=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",e).set("sqlExprObj",null)})},this.handleRemoveLayerForTriggerLayer=()=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",null)})},this.handleRemoveLayerForActionLayer=()=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",null).set("sqlExprObj",null)})},this.showSqlExprPopup=()=>{this.setState({isSqlExprShow:!0})},this.toggleSqlExprPopup=()=>{this.setState({isSqlExprShow:!this.state.isSqlExprShow})},this.onSqlExprBuilderChange=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("sqlExprObj",e)})},this.onMessageFieldSelected=(e,t)=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",{dataSourceId:this.props.config.messageUseDataSource.dataSourceId,mainDataSourceId:this.props.config.messageUseDataSource.mainDataSourceId,dataViewId:this.props.config.messageUseDataSource.dataViewId,rootDataSourceId:this.props.config.messageUseDataSource.rootDataSourceId,fields:e.map((e=>e.jimuName))})})},this.onActionFieldSelected=(e,t)=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",{dataSourceId:this.props.config.actionUseDataSource.dataSourceId,mainDataSourceId:this.props.config.actionUseDataSource.mainDataSourceId,dataViewId:this.props.config.actionUseDataSource.dataViewId,rootDataSourceId:this.props.config.actionUseDataSource.rootDataSourceId,fields:e.map((e=>e.jimuName))})})},this.swicthEnabledDataRelationShip=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("enabledDataRelationShip",e)})},this.onUseLayersRelationship=()=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.setIn(["messageUseDataSource","fields"],[]).setIn(["actionUseDataSource","fields"],[]).set("connectionType",r.MessageActionConnectionType.UseLayersRelationship)})},this.onSetCustomFields=()=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.setIn(["messageUseDataSource","fields"],[]).setIn(["actionUseDataSource","fields"],[]).set("connectionType",r.MessageActionConnectionType.SetCustomFields)})},this.modalStyle.borderRight="1px solid black",this.modalStyle.borderBottom="1px solid black",this.state={isShowLayerList:!1,currentLayerType:null,isSqlExprShow:!1}}componentDidMount(){r.moduleLoader.loadModules(["jimu-ui","jimu-ui/advanced/setting-components","jimu-ui/advanced/data-source-selector","jimu-arcgis","jimu-ui/advanced/sql-expression-builder"]).then((e=>{this.setState({Button:e[0].Button,Icon:e[0].Icon,Switch:e[0].Switch,Collapse:e[0].Collapse,SettingSection:e[1].SettingSection,SettingRow:e[1].SettingRow,FieldSelector:e[2].FieldSelector,DataSourceSelector:e[2].DataSourceSelector,ArcGISDataSourceTypes:e[3].ArcGISDataSourceTypes,SqlExpressionBuilderPopup:e[4].SqlExpressionBuilderPopup,DSSelectorTypes:(0,r.Immutable)([r.AllDataSourceTypes.FeatureLayer,r.AllDataSourceTypes.SceneLayer,r.AllDataSourceTypes.OrientedImageryLayer,r.AllDataSourceTypes.ImageryLayer,r.AllDataSourceTypes.BuildingComponentSubLayer])},(()=>{const e=this.getInitConfig();this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",e.messageUseDataSource).set("actionUseDataSource",e.actionUseDataSource).set("sqlExprObj",e.sqlExprObj)})}))}))}getStyle(e){return r.css`
      .setting-header {
        padding: ${r.polished.rem(10)} ${r.polished.rem(16)} ${r.polished.rem(0)} ${r.polished.rem(16)}
      }

      .deleteIcon {
        cursor: pointer;
        opacity: .8;
      }

      .deleteIcon:hover {
        opacity: 1;
      }

      .sql-expr-display {
        width: 100%;
        height: auto;
        min-height: 60px;
        line-height: 25px;
        padding: 3px 5px;
        color: ${e.ref.palette.neutral[900]};
        border: 1px solid ${e.ref.palette.neutral[500]};
      }

      .relate-panel-left {
        flex: auto;
        overflow: hidden;
        .action-select-chooser {
          margin-top: ${r.polished.rem(12)};
        }
      }
    `}render(){var e,t;const{Button:o,Icon:i,Switch:n,Collapse:s,SettingSection:a,SettingRow:l,FieldSelector:u,DataSourceSelector:d,ArcGISDataSourceTypes:c,SqlExpressionBuilderPopup:p}=this.state,{messageWidgetId:g,messageType:h,config:f,theme:y}=this.props;if(!(o&&i&&n&&s&&a&&l&&u&&d&&c&&p))return null;const m=Ci({widgetId:g,useDataSource:f.messageUseDataSource,messageType:h,arcGISDataSourceTypes:c}),v=this.props.config.messageUseDataSource&&r.DataSourceManager.getInstance().getDataSource(this.props.config.messageUseDataSource.dataSourceId),S=this.props.config.actionUseDataSource&&r.DataSourceManager.getInstance().getDataSource(this.props.config.actionUseDataSource.dataSourceId),I=Mi(f),w=!f.connectionType||f.connectionType===r.MessageActionConnectionType.SetCustomFields;return(0,r.jsx)("div",{css:this.getStyle(this.props.theme)},(0,r.jsx)(a,{title:this.props.intl.formatMessage({id:"frameworkAction_TriggerLayer",defaultMessage:_e.frameworkAction_TriggerLayer})},(0,r.jsx)(d,{types:this.state.DSSelectorTypes,useDataSources:m.useDataSources,fromRootDsIds:m.fromRootDsIds,fromDsIds:m.fromDsIds,closeDataSourceListOnChange:!0,disableRemove:()=>m.isReadOnly,disableDataSourceList:m.isReadOnly,hideAddDataButton:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleTriggerLayerChange,widgetId:this.props.messageWidgetId,hideDataView:!0,enableToSelectOutputDsFromSelf:!0})),(0,r.jsx)(a,{title:this.props.intl.formatMessage({id:"frameworkAction_ActionLayer",defaultMessage:_e.frameworkAction_ActionLayer})},(0,r.jsx)(d,{types:this.state.DSSelectorTypes,useDataSources:this.props.config.actionUseDataSource?(0,r.Immutable)([this.props.config.actionUseDataSource]):(0,r.Immutable)([]),closeDataSourceListOnChange:!0,hideAddDataButton:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleActionLayerChange,widgetId:this.props.widgetId,hideDataView:!0,enableToSelectOutputDsFromSelf:!0})),this.props.config&&this.props.config.actionUseDataSource&&this.props.config.messageUseDataSource&&(0,r.jsx)(a,{title:this.props.intl.formatMessage({id:"frameworkAction_Conditions",defaultMessage:_e.frameworkAction_Conditions})},(0,r.jsx)(l,{label:this.props.intl.formatMessage({id:"frameworkAction_RelateMessage",defaultMessage:_e.frameworkAction_RelateMessage})},(0,r.jsx)(n,{checked:this.props.config.enabledDataRelationShip,onChange:e=>{this.swicthEnabledDataRelationShip(e.target.checked)}})),(0,r.jsx)(l,null,(0,r.jsx)(s,{isOpen:this.props.config.enabledDataRelationShip,className:"w-100"},(0,r.jsx)(Ui,{messageDataSource:v,actionDataSource:S,connectionType:f.connectionType,onUseLayersRelationship:this.onUseLayersRelationship,onSetCustomFields:this.onSetCustomFields}),I&&(0,r.jsx)("div",{className:"w-100 border p-1 mr-2"},this.props.intl.formatMessage({id:"frameworkAction_AutoBind",defaultMessage:_e.frameworkAction_AutoBind})),!I&&w&&(0,r.jsx)("div",{className:"w-100 d-flex align-items-center mt-3"},(0,r.jsx)("div",{className:"d-flex flex-column relate-panel-left"},(0,r.jsx)(u,{className:"w-100",useDataSources:(0,r.Immutable)([null===(e=this.props.config.messageUseDataSource)||void 0===e?void 0:e.asMutable({deep:!0})]),isDataSourceDropDownHidden:!0,placeholder:this.props.intl.formatMessage({id:"frameworkAction_TriggerLayerField",defaultMessage:_e.frameworkAction_TriggerLayerField}),onChange:this.onMessageFieldSelected,useDropdown:!0,selectedFields:this.props.config.messageUseDataSource&&this.props.config.messageUseDataSource.fields?this.props.config.messageUseDataSource.fields:(0,r.Immutable)([])}),(0,r.jsx)(u,{className:"w-100 action-select-chooser",placeholder:this.props.intl.formatMessage({id:"frameworkAction_ActionLayerField",defaultMessage:_e.frameworkAction_ActionLayerField}),useDataSources:(0,r.Immutable)([null===(t=this.props.config.actionUseDataSource)||void 0===t?void 0:t.asMutable({deep:!0})]),isDataSourceDropDownHidden:!0,onChange:this.onActionFieldSelected,useDropdown:!0,selectedFields:this.props.config.actionUseDataSource&&this.props.config.actionUseDataSource.fields?this.props.config.actionUseDataSource.fields:(0,r.Immutable)([])})),(0,r.jsx)(ji,{autoFlip:!0,className:"flex-none",width:12,height:40,color:y.ref.palette.neutral[900]})))),(0,r.jsx)(l,null,(0,r.jsx)(o,{type:"link",disabled:!this.props.config.actionUseDataSource,className:"w-100 d-flex justify-content-start",onClick:this.showSqlExprPopup},(0,r.jsx)("div",{className:"w-100 text-truncate",style:{textAlign:"start"}},this.props.intl.formatMessage({id:"frameworkAction_MoreConditions",defaultMessage:_e.frameworkAction_MoreConditions}))),this.props.config.actionUseDataSource&&(0,r.jsx)(r.DataSourceComponent,{useDataSource:this.props.config.actionUseDataSource},(e=>(0,r.jsx)(p,{dataSource:e,mode:r.SqlExpressionMode.Simple,isOpen:this.state.isSqlExprShow,toggle:this.toggleSqlExprPopup,expression:this.props.config.sqlExprObj,onChange:e=>{this.onSqlExprBuilderChange(e)},id:"filter-widget-sql-expression-builder-popup"})))),(0,r.jsx)(l,null,(0,r.jsx)("div",{className:"sql-expr-display"},this.props.config.sqlExprObj&&S?r.dataSourceUtils.getArcGISSQL(this.props.config.sqlExprObj,S).displaySQL:this.props.intl.formatMessage({id:"frameworkAction_SetExpression",defaultMessage:_e.frameworkAction_SetExpression})))))}}_i.defaultProps={config:(0,r.Immutable)({messageUseDataSource:null,actionUseDataSource:null,sqlExprObj:null,enabledDataRelationShip:!0})};const ki=r.ReactRedux.connect((e=>({dataSources:e.appStateInBuilder&&e.appStateInBuilder.appConfig&&e.appStateInBuilder.appConfig.dataSources,dataSourcesInfo:e.appStateInBuilder&&e.appStateInBuilder.dataSourcesInfo})))((0,h.withTheme)(_i));var Ei=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};function Bi(){return Ei(this,void 0,void 0,(function*(){const e=(0,r.getAppStore)().getState().appContext.locale;return yield function(e,t){return Ei(this,void 0,void 0,(function*(){return(e=r.i18n.getLocaleToLoad(e,t))?yield r.i18n.loadLocaleMessages("jimu-for-builder/lib/translations",e).then((e=>e)):Promise.resolve(_e)}))}(e,r.translatedLocales).then((e=>(e&&(0,r.getAppStore)().dispatch(r.appActions.i18nMessagesLoaded("jimu-for-builder",e)),r.i18n.resetIntls(),e)))}))}var zi=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};function Wi(){return zi(this,void 0,void 0,(function*(){return A.getInstance().registerActionRawSettingClass("filter-data-record-action",Oi),A.getInstance().registerActionRawSettingClass("select-data-record-action",ki),yield Bi(),yield Promise.resolve({})}))}var Fi=d(298),$i=d(499),Ni=d.n($i),Gi=function(e,t){var o={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(o[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(o[i[n]]=e[i[n]])}return o};const Hi=e=>{const t=window.SVG,{className:o}=e,i=Gi(e,["className"]),n=(0,r.classNames)("jimu-icon jimu-icon-component",o);return t?r.React.createElement(t,Object.assign({className:n,src:Ni()},i)):r.React.createElement("svg",Object.assign({className:n},i))};var qi=d(996),Vi=d.n(qi),Ki=function(e,t){var o={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(o[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(o[i[n]]=e[i[n]])}return o};const Ji=e=>{const t=window.SVG,{className:o}=e,i=Ki(e,["className"]),n=(0,r.classNames)("jimu-icon jimu-icon-component",o);return t?r.React.createElement(t,Object.assign({className:n,src:Vi()},i)):r.React.createElement("svg",Object.assign({className:n},i))};var Qi=function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};const Zi=r.css`
  width: 360px !important;
  height: auto !important;
  visibility: visible !important;
  background: var(--ref-palette-custom1-300);
  >.floating-header {
    background: var(--ref-palette-custom1-300);
    color: var(--ref-palette-custom2-600);
    height: 55px;
    border-bottom: 1px solid var(--ref-palette-custom1-500);
    >.actions>.jimu-btn {
      color: var(--ref-palette-custom2-600)
    }
  }
  .floating-content {
    padding: 16px 20px 20px;
  }
  .jimu-widget-setting--row >.jimu-widget-setting--row-label {
    margin-bottom: 12px;
  }
  .jimu-multi-select .jimu-dropdown {
    width: 100%;
  }
  .message-container {
    .message-line {
      position: relative;
      padding-left: 24px;
      margin-top: 8px;
      line-height: 26px;
      .donut-loading, .icon {
        position: absolute;
        left: 0;
        top: calc(50% - 8px);
        width: 16px;
        height: 16px;
      }
    }
  }
  .error-msg {
    display: flex;
    font-weight: 500;
    color: var(--sys-color-error-dark)
  }
  .popper-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    >.btn {
      min-width: 100px;
    }
  }
`;var Yi;!function(e){e.Start="001",e.CopyingCode="002",e.CompilingWidget="003",e.GeneratingZip="004",e.Completed="005",e.Fail="006"}(Yi||(Yi={}));const Xi=new Map([[Yi.Start,1],[Yi.CopyingCode,2],[Yi.CompilingWidget,3],[Yi.GeneratingZip,4],[Yi.Completed,5],[Yi.Fail,6]]),en=[{code:Yi.CopyingCode,key:"copingCode"},{code:Yi.CompilingWidget,key:"compilingCustomWidgets"},{code:Yi.GeneratingZip,key:"generateZipFile"}],tn=e=>{const{appId:t,isOpen:o,onClose:i}=e,n=r.hooks.useTranslation($e.defaultMessages),s=r.React.useRef(o),a=r.React.useRef("");r.React.useEffect((()=>{s.current=o}),[o]);const l=()=>{i(),s.current=!1};r.hooks.useUpdateEffect((()=>{o||(p(!1),h(0),d(["en"]),y(-1),a.current="")}),[o]);const[u,d]=r.React.useState(["en"]),[c,p]=r.React.useState(!1),[g,h]=r.React.useState(0),[f,y]=r.React.useState(-1),m=e=>new Promise((t=>{setTimeout((()=>{t()}),e)})),[v,S]=r.React.useState(!1),I=()=>u.length?`${u.length} ${n("SelectionSeleted")}`:"",w=r.ReactRedux.useSelector((e=>e.appContext.isRTL));return(0,r.jsx)($e.Popper,{floating:!0,reference:"body",open:o,placement:"left",css:Zi,headerTitle:n("download"),dragBounds:"body",disableResize:!0,"data-test":o,onHeaderClose:l,offset:[0,-(document.documentElement.clientWidth/2+180)],toggle:(e,t)=>{"clickOutside"!==t&&l()}},(0,r.jsx)("div",null,(0,r.jsx)(Fi.SettingRow,{label:n("selectRequiredLanguage"),flow:"wrap"},(0,r.jsx)($e.MultiSelect,{className:"w-100",buttonProps:{title:I()},displayByValues:()=>I(),items:r.translatedLocales.map((e=>{const t={label:n(e),value:e};return"en"===e&&(t.render=()=>(0,r.jsx)("div",{className:"d-flex w-100 align-items-center mb-0"},(0,r.jsx)($e.Checkbox,{checked:!0,disabled:!0}),(0,r.jsx)("div",{style:w?{marginRight:"8px"}:{marginLeft:"8px"},className:"item-text"},t.label))),t})),onClickItem:(e,t,o)=>{"en"!==t&&d([...o])},values:(0,r.Immutable)(u)})),c&&(0,r.jsx)("div",{className:"message-container mt-4"},f>-1&&null!==f&&(0,r.jsx)("div",null,n("indexNumber",{cdnNumber:f})),(v?en:en.filter((e=>e.code!==Yi.CompilingWidget))).map((e=>{const t=Xi.get(e.code);return t-1<=g?(0,r.jsx)("div",{className:"message-line",key:e.key},g>t?(0,r.jsx)(Hi,{color:"var(--primary-600)",className:"icon"}):(0,r.jsx)($e.Loading,{type:$e.LoadingType.Donut}),n(e.key)):null}))),g===Xi.get(Yi.Fail)&&(0,r.jsx)("div",{className:"error-msg mt-4"},(0,r.jsx)(Ji,{className:"mr-1"}),n("failedToLoad"))),(0,r.jsx)("div",{className:"mt-5 popper-footer"},(0,r.jsx)($e.Button,{type:"primary",disabled:!u.length||c,onClick:()=>Qi(void 0,void 0,void 0,(function*(){h(0);const e=u.join(","),o=r.SessionManager.getInstance().getMainSession(),i=null==o?void 0:o.token,n=`${window.jimuConfig.mountPath}download/${t}?locale=${e}&token=${i}`;try{p(!0);const e=(yield fetch(n).then((e=>e.json()))).uuid;a.current=e;const o=`${window.jimuConfig.mountPath}download/${t}/status?token=${i}&uuid=${e}`;let r,u=!1;for(;!u&&a.current===e&&s.current;){r=yield fetch(o).then((e=>e.json()));const{status:{code:n,hasCustomWidget:d},cdnNumber:c}=r;if(S(d),h((()=>Xi.get(n))),y((()=>c)),!s.current||a.current!==e)break;if(n===Yi.Fail||n===Yi.Completed?u=!0:yield m(2e3),!s.current||a.current!==e)break;if(n===Yi.Completed){l();const o=`${window.jimuConfig.mountPath}download/${t}/getZip?token=${i}&uuid=${e}`;window.open(o)}}}catch(e){h((()=>Xi.get(Yi.Fail)))}}))},n("ok")),(0,r.jsx)($e.Button,{className:"ml-2",onClick:l},n("cancel"))))}})(),c})())}}}));
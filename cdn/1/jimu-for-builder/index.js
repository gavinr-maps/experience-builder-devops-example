System.register(["jimu-core","jimu-core/react","jimu-theme","jimu-layouts/layout-runtime","jimu-for-builder/service","jimu-ui","jimu-for-builder/templates"],(function(e,t){var i={},o={},s={},n={},a={},r={},p={};return{setters:[function(e){i.AjaxState=e.AjaxState,i.AllDataSourceTypes=e.AllDataSourceTypes,i.AppMode=e.AppMode,i.ContainerType=e.ContainerType,i.DataSourceComponent=e.DataSourceComponent,i.DataSourceManager=e.DataSourceManager,i.ExtensionManager=e.ExtensionManager,i.Immutable=e.Immutable,i.IntlProvider=e.IntlProvider,i.Keyboard=e.Keyboard,i.LayoutItemType=e.LayoutItemType,i.LayoutParentType=e.LayoutParentType,i.LayoutType=e.LayoutType,i.MessageCarryData=e.MessageCarryData,i.MessageType=e.MessageType,i.MutableStoreManager=e.MutableStoreManager,i.PageType=e.PageType,i.React=e.React,i.ReactRedux=e.ReactRedux,i.ResourceType=e.ResourceType,i.ScreenTransitionType=e.ScreenTransitionType,i.SessionManager=e.SessionManager,i.SqlExpressionMode=e.SqlExpressionMode,i.WidgetManager=e.WidgetManager,i.WidgetType=e.WidgetType,i.appActions=e.appActions,i.appConfigUtils=e.appConfigUtils,i.classNames=e.classNames,i.css=e.css,i.dataSourceUtils=e.dataSourceUtils,i.esri=e.esri,i.extensionSpec=e.extensionSpec,i.getAppStore=e.getAppStore,i.i18n=e.i18n,i.injectIntl=e.injectIntl,i.invariant=e.invariant,i.jimuHistory=e.jimuHistory,i.jsx=e.jsx,i.keyboardUtils=e.keyboardUtils,i.loadDependencies=e.loadDependencies,i.lodash=e.lodash,i.moduleLoader=e.moduleLoader,i.observeStore=e.observeStore,i.polished=e.polished,i.portalUrlUtils=e.portalUrlUtils,i.portalUtils=e.portalUtils,i.translatedLocales=e.translatedLocales,i.urlUtils=e.urlUtils,i.utils=e.utils,i.uuidv1=e.uuidv1},function(e){o.PureComponent=e.PureComponent,o.createElement=e.createElement},function(e){s.withTheme=e.withTheme},function(e){n.searchUtils=e.searchUtils,n.utils=e.utils},function(e){a.appServices=e.appServices,a.getResourceOrigin=e.getResourceOrigin},function(e){r.imageUtils=e.imageUtils},function(e){p.getTemplateConfig=e.getTemplateConfig}],execute:function(){e((()=>{var e={982:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 12 12"><path fill="#000" fill-rule="evenodd" d="M.007.883A1 1 0 0 1 1 0h10l.117.007A1 1 0 0 1 12 1v7l-.007.117A1 1 0 0 1 11 9H4l-4 3V1L.007.883ZM11 1H1v9l2.667-2H11V1ZM3 3.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5ZM3.5 5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5Z" clip-rule="evenodd"></path></svg>'},179:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M1.333 0h4c.737 0 1.334.597 1.334 1.333v1.334h8C15.403 2.667 16 3.264 16 4v10.667c0 .736-.597 1.333-1.333 1.333H1.333A1.333 1.333 0 0 1 0 14.667V1.333C0 .597.597 0 1.333 0Zm0 7.333v7.334h13.334V7.333H1.334Zm0-1.333h13.334V4H5.334V1.335h-4V6Z" clip-rule="evenodd"></path></svg>'},543:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path fill="#000" fill-rule="evenodd" d="M14 2a2 2 0 0 0-2-2H2a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V2ZM2 1h10a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1Z" clip-rule="evenodd"></path><path fill="#000" fill-rule="evenodd" d="M20 8a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8ZM8 7h10a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1Z" clip-rule="evenodd"></path></svg>'},556:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 40"><path fill="#A8A8A8" fill-rule="evenodd" d="M6 30v10H0v-1h5v-9h1ZM3.162 18.582a.5.5 0 0 1 0 .71l-1.416 1.421a2.497 2.497 0 0 0-.003 3.545c.983.983 2.56.98 3.544-.003l1.42-1.42a.504.504 0 0 1 .712.713L6 24.968a3.502 3.502 0 0 1-4.967 0 3.501 3.501 0 0 1 0-4.967l1.416-1.422a.504.504 0 0 1 .713.003Zm4.967-.71a.5.5 0 0 1 0 .71L4.58 22.129a.504.504 0 0 1-.713-.712l3.548-3.548a.504.504 0 0 1 .713.003Zm2.838-2.838a3.501 3.501 0 0 1 0 4.967l-1.42 1.419a.504.504 0 0 1-.713-.712l1.423-1.417a2.5 2.5 0 0 0 0-3.547 2.502 2.502 0 0 0-3.547 0l-1.42 1.419a.504.504 0 0 1-.713-.712l1.42-1.42a3.506 3.506 0 0 1 4.97.003ZM6 0v10H5V1H0V0h6Z"></path></svg>'},786:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="m1.373 8 2.07-2.071.83.828L2.2 8.828a3.515 3.515 0 0 0 4.97 4.971l2.072-2.071.828.828L8 14.627A4.686 4.686 0 1 1 1.373 8ZM13.799 7.172l-2.071 2.07.828.83L14.627 8A4.686 4.686 0 1 0 8 1.373l-2.071 2.07.828.83L8.828 2.2a3.515 3.515 0 0 1 4.971 4.97Z"></path><path fill="#000" d="M5.515 9.657a.586.586 0 0 0 .828.828l4.142-4.142a.586.586 0 0 0-.828-.828L5.515 9.657Z"></path></svg>'},513:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 12 12"><path fill="#000" fill-rule="evenodd" d="M10.167 0H1.833A.845.845 0 0 0 1 .857v10.286c0 .473.373.857.833.857h8.334c.46 0 .833-.384.833-.857V.857A.845.845 0 0 0 10.167 0ZM2 11V1h8v10H2Zm1.6-8h4.8c.331 0 .6.224.6.5s-.269.5-.6.5H3.6c-.331 0-.6-.224-.6-.5s.269-.5.6-.5Zm4.8 3H3.6c-.331 0-.6.224-.6.5s.269.5.6.5h4.8c.331 0 .6-.224.6-.5S8.731 6 8.4 6Z" clip-rule="evenodd"></path></svg>'},891:e=>{"use strict";e.exports=i},315:e=>{"use strict";e.exports=o},325:e=>{"use strict";e.exports=a},262:e=>{"use strict";e.exports=p},758:e=>{"use strict";e.exports=n},796:e=>{"use strict";e.exports=s},726:e=>{"use strict";e.exports=r},774:e=>{"use strict";e.exports=JSON.parse('{"online":{"home":"#","get-started":{"prefix":"get-started/","what-is-arcgis-experience-builder":"what-is-arcgis-experience-builder.htm","whats-new":"whats-new.htm"},"build-apps":{"prefix":"build-apps/","add-a-page":"add-a-page.htm","add-a-dialog":"add-windows.htm","add-utility-services":"add-utility-services.htm","add-custom-widgets":"getting-started-widget.htm","add-screen-groups":"add-screen-groups.htm","select-data":"select-data.htm","change-app-theme":"change-app-theme.htm"},"widgets":{"prefix":"configure-widgets/","overview":"widgets-overview.htm","3d-toolbox":"3d-toolbox-widget.htm","add-data":"add-data-widget.htm","arcgis-map":"map-widget.htm","basemap-gallery":"basemap-gallery-widget.htm","ba-infographic":"business-analyst-infographic-widget.htm","bookmark":"bookmark-widget.htm","branch-version-management":"branch-version-management-widget.htm","button":"button-widget.htm","card":"card-widget.htm","chart":"chart-widget.htm","column":"column-widget.htm","controller":"widget-controller-widget.htm","coordinates":"coordinates-widget.htm","coordinate-conversion":"coordinate-conversion-widget.htm","divider":"divider-widget.htm","draw":"draw-widget.htm","directions":"directions-widget.htm","edit":"edit-widget.htm","elevation-profile":"elevation-profile-widget.htm","embed":"embed-widget.htm","feature-info":"feature-info-widget.htm","filter":"filter-widget.htm","fixed":"fixed-panel-widget.htm","floor-filter":"floor-filter-widget.htm","fly-controller":"fly-controller-widget.htm","grid":"grid-widget.htm","image":"image-widget.htm","legend":"legend-widget.htm","list":"list-widget.htm","map-layers":"map-layers-widget.htm","menu":"menu-widget.htm","navigator":"view-navigation-widget.htm","near-me":"near-me-widget.htm","oriented-imagery":"oriented-imagery-widget.htm","placeholder":"placeholder-widget.htm","print":"print-widget.htm","query":"query-widget.htm","row":"row-widget.htm","search":"search-widget.htm","section":"section-widget.htm","share":"share-widget.htm","sidebar":"sidebar-widget.htm","suitability-modeler":"suitability-modeler-widget.htm","survey123":"survey-widget.htm","swipe":"swipe-widget.htm","table":"table-widget.htm","text":"text-widget.htm","timeline":"timeline-widget.htm","utility-network-trace":"utility-network-trace-widget.htm"}},"portal":{"home":"120001864","get-started":{"what-is-arcgis-experience-builder":"120001877","whats-new":"120002535"},"build-apps":{"add-a-page":"120001863","add-a-dialog":"120002539","add-utility-services":"120003733","add-custom-widgets":"120003728","add-screen-groups":"120002592","select-data":"120002590","change-app-theme":"120004139"},"widgets":{"overview":"#","3d-toolbox":"120003734","add-data":"120004128","arcgis-map":"120001851","basemap-gallery":"120004168","bookmark":"120002536","button":"120001841","branch-version-management":"120002654","ba-infographic":"120003631","card":"120002537","chart":"120002727","column":"120001842","controller":"120001862","coordinates":"120003879","coordinate-conversion":"120002728","divider":"120002538","draw":"120003632","directions":"120003635","edit":"120002844","elevation-profile":"120002905","embed":"120001843","feature-info":"120001844","filter":"120001845","fixed":"120001846","floor-filter":"120003634","fly-controller":"120001847","grid":"120003880","image":"120001848","legend":"120001849","list":"120001850","map-layers":"120001852","menu":"120001853","navigator":"120001861","near-me":"120004170","oriented-imagery":"120002843","placeholder":"120001854","print":"120003716","query":"120002729","row":"120001855","search":"120002845","section":"120001856","share":"120001857","sidebar":"120001858","suitability-modeler":"120002906","survey123":"120001859","swipe":"120004169","table":"120002591","text":"120001860","timeline":"120003717","utility-network-trace":"120003633"}},"dev":{"home":"#","get-started":{"prefix":"guide/","what-is-arcgis-experience-builder":"getting-started-widget","whats-new":"whats-new"},"build-apps":{"prefix":"guide/","add-a-page":"add-a-page","add-a-dialog":"add-windows","add-utility-services":"add-utility-services","add-custom-widgets":"getting-started-widget","add-screen-groups":"add-screen-groups","select-data":"select-data","change-app-theme":"change-app-theme"},"widgets":{"prefix":"guide/","overview":"widgets-overview","3d-toolbox":"3d-toolbox-widget","add-data":"add-data-widget","arcgis-map":"map-widget","basemap-gallery":"basemap-gallery-widget","ba-infographic":"business-analyst-infographic-widget","bookmark":"bookmark-widget","branch-version-management":"branch-version-management-widget","button":"button-widget","card":"card-widget","chart":"chart-widget","column":"column-widget","controller":"widget-controller-widget","coordinates":"coordinates-widget","coordinate-conversion":"coordinate-conversion-widget","divider":"divider-widget","draw":"draw-widget","directions":"directions-widget","edit":"edit-widget","elevation-profile":"elevation-profile-widget","embed":"embed-widget","feature-info":"feature-info-widget","filter":"filter-widget","fixed":"fixed-panel-widget","floor-filter":"floor-filter-widget","fly-controller":"fly-controller-widget","grid":"grid-widget","image":"image-widget","legend":"legend-widget","list":"list-widget","map-layers":"map-layers-widget","menu":"menu-widget","navigator":"view-navigation-widget","near-me":"near-me-widget","oriented-imagery":"oriented-imagery-widget","placeholder":"placeholder-widget","print":"print-widget","query":"query-widget","row":"row-widget","search":"search-widget","section":"section-widget","share":"share-widget","sidebar":"sidebar-widget","suitability-modeler":"suitability-modeler-widget","survey123":"survey-widget","swipe":"swipe-widget","table":"table-widget","text":"text-widget","timeline":"timeline-widget","utility-network-trace":"utility-network-trace-widget"}}}')}},t={};function l(i){var o=t[i];if(void 0!==o)return o.exports;var s=t[i]={exports:{}};return e[i](s,s.exports,l),s.exports}l.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return l.d(t,{a:t}),t},l.d=(e,t)=>{for(var i in t)l.o(t,i)&&!l.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),l.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var d={};return(()=>{"use strict";l.r(d),l.d(d,{AppConfigAction:()=>Ve,AppDataActionManager:()=>Ze,AppMessageManager:()=>b,AppResourceFilePath:()=>Q,AppResourceManager:()=>te,AppStateHistoryActionKeys:()=>z,AppStateHistoryExtension:()=>q,AppStateReduxStoreExtension:()=>$,AppWidgetManager:()=>Je,BaseWidgetSetting:()=>p,BuilderKeyboardComponent:()=>Jt,BuilderStateActionTypes:()=>u,BuilderStateReduxStoreExtension:()=>f,BuilderStateResourceActionKeys:()=>K,BuilderStateResourceExtension:()=>J,ExtActionKeys:()=>F,ToBuilderMessage:()=>V,WidgetSettingManager:()=>S,appBuilderSync:()=>i,appConfigUtils:()=>e,appStateActions:()=>G,appStateHistoryActions:()=>N,builderActionKeys:()=>u,builderActions:()=>h,builderAppSync:()=>t,builderStateResourceActions:()=>Z,defaultMessages:()=>Qe,getAppConfigAction:()=>He,helpUtils:()=>s,init:()=>ci,loadI18nMessage:()=>di,templateUtils:()=>n,utils:()=>o});var e={};l.r(e),l.d(e,{cleanAppStructure:()=>k,getCleanAppConfig:()=>W,getRealPageCount:()=>E,getRealPageCountExcludeOnePage:()=>_,getSizeModeOfALayout:()=>T,getSubRealPageCount:()=>R,getUniqueId:()=>P,getUniqueLabel:()=>x,isFirstLevelPage:()=>j,isLabelDuplicated:()=>B,isPageHasSubPage:()=>U,isRealPage:()=>O,parseUniqueLabel:()=>M});var t={};l.r(t),l.d(t,{listenAppEvents:()=>Ae,publichActivePagePartChangeToApp:()=>me,publichChangeZoomScaleToApp:()=>ye,publishAnimationPreviewToApp:()=>Ie,publishAppConfigChangeToApp:()=>oe,publishAppInfoChangeToApp:()=>se,publishAppModeChangeToApp:()=>ae,publishChangeBrowserSizeModeToApp:()=>ge,publishChangeResignInFlagsToApp:()=>fe,publishChangeSelectionToApp:()=>le,publishChangeSessionToApp:()=>he,publishChangeWidgetMutableStatePropToApp:()=>ue,publishChangeWidgetStatePropToApp:()=>de,publishDialogChangeToApp:()=>pe,publishDialogInfosChangeToApp:()=>ne,publishHoverPreviewToApp:()=>Ce,publishKeyboardToApp:()=>ce,publishPageChangeToApp:()=>re,publishScreenGroupNavInfoToApp:()=>ve,publishSectionNavInfoToApp:()=>Se,publishSetClientIdAlertIsCancelled:()=>be,publishTocHoverInfoToApp:()=>we});var i={};l.r(i),l.d(i,{clearLastAppConfigFromHistory:()=>ke,letBuilderAddResource:()=>Ee,letBuilderClearResource:()=>Re,letBuilderPopupChooseWidget:()=>Ue,letBuilderResponseToKeyboard:()=>_e,letBuilderShowLayoutToolbar:()=>Oe,letBuilderShowPopperSelector:()=>Ge,listenBuilderEvents:()=>Pe,publishAppIsLoadedToBuilder:()=>je,publishAppSessionChangeToBuilder:()=>xe,publishAppStateChangeToBuilder:()=>Te,publishConfirmDeleteToApp:()=>Be,publishIsBusyToBuilder:()=>We,publishPortalUrlNeedToRegisterClientId:()=>Fe,publishResignInFlagsChangeToBuilder:()=>Me});var o={};l.r(o),l.d(o,{CUSTOM_GROUP:()=>Ct,fetchCommonWidgetList:()=>ht,fetchRemoteCustomWidgetList:()=>yt,getDefaultSectionIcon:()=>ut,getDefaultTocDialogIcon:()=>dt,getDefaultTocPageIcon:()=>lt,getPageListByDialogId:()=>ct,showCustomWidgets:()=>It,showRemoteCustomWidgets:()=>mt});var s={};l.r(s),l.d(s,{getBuildAppsHelpLink:()=>Lt,getHomeHelpLink:()=>At,getWhatsNewLink:()=>Dt,getWidgetHelpLink:()=>Pt,isSupportLanguage:()=>bt});var n={};l.r(n),l.d(n,{applyGridTemplate:()=>qt,applyPageTemplateToBody:()=>zt,applyPageTemplateToFooter:()=>$t,applyPageTemplateToHeader:()=>Gt,applyTemplateToDialog:()=>Nt,createDialogFromTemplate:()=>Ft,createLayoutFromTemplate:()=>_t,createPageFromTemplate:()=>kt,createScreenFromTemplate:()=>Bt,createScreenGroupFromTemplate:()=>Wt,createSectionFromTemplate:()=>Rt,createViewFromTemplate:()=>Ot,createWidgetFromTemplate:()=>Et,processForTemplate:()=>jt,updateWidgetByTemplate:()=>Ut});var a=l(891);class r extends a.React.PureComponent{}const p=r;var u,c=l(315),g=l(796);!function(e){e.SelectTemplate="SELECT_TEMPLATE",e.OpenChooseWidgetPopup="OPEN_CHOOSE_WIDGET_POPUP",e.CloseChooseWidgetPopup="CLOSE_CHOOSE_WIDGET_POPUP",e.WidgetSettingClassLoaded="WIDGET_SETTING_CLASS_LOADED",e.WidgetsRemoved="WIDGETS_REMOVED",e.WidgetsAdded="WIDGETS_ADDED",e.ChangeCurrentApp="CHANGE_CURRENT_APP",e.RefreshAppList="REFRSH_APPLIST",e.SetLayoutTools="SET_LAYOUT_TOOLS",e.StartGuide="START_GUIDE",e.StopGuide="STOP_GUIDE",e.WidgetSettingI18nMessageLoaded="WIDGET_SETTING_I18N_MESSAGE_LOADED",e.ConfirmDeleteContentChanged="CONFIRM_DELETE_CONTENT_CHANGED"}(u||(u={}));const h={selectTemplate:e=>({type:u.SelectTemplate,templateName:e}),refreshAppListAction:e=>({type:u.RefreshAppList,isRefresh:e}),openChooseWidgetPopup:(e,t)=>({type:u.OpenChooseWidgetPopup,layoutId:e,layoutItemId:t}),closeChooseWidgetPopup:()=>({type:u.CloseChooseWidgetPopup}),widgetSettingClassLoaded:e=>({type:u.WidgetSettingClassLoaded,wigetUri:e}),widgetsAdded:e=>({type:u.WidgetsAdded,widgets:e}),widgetsRemoved:e=>({type:u.WidgetsRemoved,widgetIds:e}),changeCurrentApp:e=>({type:u.ChangeCurrentApp,appId:e}),setLayoutTools:e=>({type:u.SetLayoutTools,tools:e}),startGuide:e=>({type:u.StartGuide,guideId:e}),stopGuide:()=>({type:u.StopGuide}),widgetSettingI18nMessageLoaded:(e,t)=>({type:u.WidgetSettingI18nMessageLoaded,widgetName:e,i18nMessages:t}),confirmDeleteContentChanged:e=>({type:u.ConfirmDeleteContentChanged,itemToDelete:e})};class f{constructor(){this.id="builder-state-redux-store-extension"}getActions(){return Object.keys(u).map((e=>u[e]))}getInitLocalState(){return(0,a.Immutable)({templateName:null,showChooseWidgetPopup:!1,currentAppId:null,refreshAppList:!1,isMobile:!1,currentGuideId:null,widgetSettingI18nMessages:(0,a.Immutable)({}),widgetsSettingClassStatus:(0,a.Immutable)({})})}getReducer(){return(e,t,i)=>{switch(t.type){case u.SelectTemplate:return e.set("templateName",t.templateName);case u.OpenChooseWidgetPopup:return e.set("showChooseWidgetPopup",!0).set("currentLayout",(0,a.Immutable)({layoutId:t.layoutId,layoutItemId:t.layoutItemId}));case u.CloseChooseWidgetPopup:return e.set("showChooseWidgetPopup",!1);case u.WidgetSettingClassLoaded:return e=e.setIn(["widgetsSettingClassStatus",t.wigetUri],!0),function(e,t){var i,o;const s=(null===(o=null===(i=e.appStateInBuilder)||void 0===i?void 0:i.appConfig)||void 0===o?void 0:o.widgets)||{};return Object.keys(s).filter((e=>s[e].uri===t))}(i,t.wigetUri).forEach((t=>{e=e.setIn(["widgetsSettingRuntimeInfo",t,"isClassLoaded"],!0)})),e;case u.WidgetsAdded:return t.widgets.forEach((t=>{e.widgetsSettingClassStatus[t.widgetUri]&&(e=e.setIn(["widgetsSettingRuntimeInfo",t.widgetId,"isClassLoaded"],!0))})),e;case u.WidgetsRemoved:return e.set("widgetsSettingRuntimeInfo",e.widgetsSettingRuntimeInfo.without(...t.widgetIds));case u.ChangeCurrentApp:return(e=this.getInitLocalState()).set("currentAppId",t.appId).set("widgetsSettingRuntimeInfo",{});case u.RefreshAppList:return e.set("refreshAppList",t.isRefresh);case u.SetLayoutTools:return e.set("toolbarConfig",t.tools);case u.StartGuide:return e.set("currentGuideId",t.guideId);case u.StopGuide:return e.set("currentGuideId",null);case u.WidgetSettingI18nMessageLoaded:return e.setIn(["widgetSettingI18nMessages",t.widgetName],t.i18nMessages);case u.ConfirmDeleteContentChanged:{const{itemToDelete:i}=t;return e.set("contentToDelete",i)}default:return e}}}getStoreKey(){return"builder"}}var y=function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function a(e){try{p(o.next(e))}catch(e){n(e)}}function r(e){try{p(o.throw(e))}catch(e){n(e)}}function p(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};const{getLocaleToLoad:m,loadLocaleMessages:I}=a.i18n;class C{static getInstance(){return C.instance||(C.instance=new C,window._widgetSettingManager=C.instance),C.instance}constructor(){this.settings={},(0,a.observeStore)(this.onStoreChange.bind(this),["appStateInBuilder","appConfig","widgets"])}getWidgetUri(e){var t,i,o;const s=null===(t=(0,a.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig;return null===(o=null===(i=null==s?void 0:s.widgets)||void 0===i?void 0:i[e])||void 0===o?void 0:o.uri}getWidgetManifestByUri(e){var t,i,o;const s=null===(i=null===(t=(0,a.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig)||void 0===i?void 0:i.widgets,n=Object.keys(s||{}).find((t=>s[t].uri===e));return null===(o=s[n])||void 0===o?void 0:o.manifest}updateWidgetCache(e,t){this.settings[e]||(this.settings[e]={});for(const i in t)this.settings[e][i]=t[i]}getWidgetSettingClass(e){var t;return null===(t=this.settings[this.getWidgetUri(e)])||void 0===t?void 0:t.settingClazz}destroyWidgetSettingClass(e){const t=this.getWidgetUri(e);t&&delete this.settings[t]}destroyWidgetSettingClassByUri(e){this.checkWidgetUriInConfig(e)||delete this.settings[e]}getItemSettingClass(e){var t;return null===(t=this.settings[this.getWidgetUri(e)])||void 0===t?void 0:t.itemSettingClazz}getSettingI18nMessagesByUri(e){var t;return null===(t=this.settings[e])||void 0===t?void 0:t.settingI18nMessage}destoryAllWidgetSettingClasses(){this.settings={}}loadWidgetSettingClass(e){var t,i,o;return y(this,void 0,void 0,(function*(){const s=null===(o=null===(i=null===(t=(0,a.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig)||void 0===i?void 0:i.widgets)||void 0===o?void 0:o[e];if(!s)return yield Promise.resolve(null);if(!s.manifest)return yield Promise.resolve(null);const n=this.getWidgetUri(e);return this.loadWidgetSettingClassByUri(n)}))}checkWidgetUriInConfig(e){var t,i;const o=(null===(i=null===(t=(0,a.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig)||void 0===i?void 0:i.widgets)||{};return!!Object.keys(o).find((t=>o[t].uri===e))}loadWidgetSettingClassByUri(e){return this.settings[e]||(this.settings[e]={}),this.settings[e].settingClazzPromise||(this.settings[e].settingClazzPromise=this.loadRawSettingClass(e).then((()=>y(this,void 0,void 0,(function*(){return yield this.loadI18nMessagesForSetting(e)})))).then((()=>{const t=this.injectWidgetSettingProps(e);return t?(this.settings[e].settingClazz=t,(0,a.getAppStore)().dispatch(h.widgetSettingClassLoaded(e)),t):(delete this.settings[e],null)}))),this.settings[e].settingClazzPromise}loadRawSettingClass(e){return y(this,void 0,void 0,(function*(){const t=this.getWidgetManifestByUri(e);let i=`${e}dist/setting/setting`;return t.properties.hasSettingPage||(i="jimu-for-builder/json-editor-setting"),yield this.loadWidgetSettingDependency(e).then((()=>y(this,void 0,void 0,(function*(){return yield a.moduleLoader.loadModule(i)})))).then((t=>{const i=t.default?t.default:t;return this.settings[e].rawSettingClazz=i,i}))}))}loadI18nMessagesForSetting(e){return y(this,void 0,void 0,(function*(){if(this.settings[e]||(this.settings[e]={}),this.settings[e].settingI18nMessagePromise)return yield this.settings[e].settingI18nMessagePromise;const t=this.getWidgetManifestByUri(e);if(!t)return yield Promise.resolve({});if(t.translatedLocales){let i=(0,a.getAppStore)().getState().appContext.locale;i=m(i,t.translatedLocales),this.settings[e].settingI18nMessagePromise=i?I(`${e}dist/setting/translations`,i):Promise.resolve({})}else this.settings[e].settingI18nMessagePromise=Promise.resolve({});return yield this.settings[e].settingI18nMessagePromise.then(((i={})=>((0,a.getAppStore)().dispatch(h.widgetSettingI18nMessageLoaded(t.name,i)),this.settings[e].settingI18nMessage=i,i)))}))}loadWidgetSettingDependency(e){return y(this,void 0,void 0,(function*(){const t=this.getWidgetManifestByUri(e);if(!t.settingDependency)return void(yield Promise.resolve());const i="string"==typeof t.settingDependency?[t.settingDependency]:t.settingDependency;yield(0,a.loadDependencies)(i)}))}loadItemSettingClass(e){var t,i,o;return y(this,void 0,void 0,(function*(){const s=null===(o=null===(i=null===(t=(0,a.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig)||void 0===i?void 0:i.widgets)||void 0===o?void 0:o[e];return s&&s.manifest?yield this.loadItemSettingClassByUri(this.getWidgetUri(e)):yield Promise.resolve(null)}))}loadItemSettingClassByUri(e){return y(this,void 0,void 0,(function*(){return this.settings[e]||(this.settings[e]={}),this.settings[e].itemSettingClazzPromise||(this.settings[e].itemSettingClazzPromise=this.loadRawItemSettingClass(e).then((t=>(this.settings[e].itemSettingClazz=t,t)))),this.settings[e].itemSettingClazzPromise}))}loadRawItemSettingClass(e){return y(this,void 0,void 0,(function*(){const t=`${e}dist/setting/item-setting`;return yield a.moduleLoader.loadModule(t).then((e=>e.default?e.default:e))}))}injectWidgetSettingProps(e){if(!this.checkWidgetUriInConfig(e))return null;const t=this.settings[e].rawSettingClazz,i=(0,a.injectIntl)(t),o=(0,g.withTheme)(i,!0),s=this.getWidgetManifestByUri(e),n=s.name,r=this.settings[e].settingI18nMessage;class p extends c.PureComponent{render(){if(s.version!==this.props.version)return null;const e={messages:r},t=Object.assign({},r,this.props.appI18nMessages);return c.createElement(a.IntlProvider,{locale:this.props.locale,defaultLocale:this.props.locale,messages:t},c.createElement(o,Object.assign({},this.props,e)))}}return p.displayName=`WidgetSettingWrapper(${n})`,a.ReactRedux.connect(((e,i)=>{const o={queryObject:e.queryObject,user:e.user,token:e.token,portalUrl:e.portalUrl,portalSelf:e.portalSelf,locale:e.appContext.locale,appI18nMessages:e.appI18nMessages},s=i.widgetId,n=e.appStateInBuilder.appConfig.widgets[s];if(!n)return{};const a=Object.assign(o,n,i);return Object.assign(a,t.mapExtraStateProps?t.mapExtraStateProps(e,a):{})}))(p)}onStoreChange(e,t){e&&t&&Object.keys(e).forEach((e=>{t[e]}))}}const S=C;var v=function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function a(e){try{p(o.next(e))}catch(e){n(e)}}function r(e){try{p(o.throw(e))}catch(e){n(e)}}function p(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};const{getTranslatedLocale:w}=a.i18n;class b{constructor(){this.actionSettings={}}static getInstance(){return b.instance||(b.instance=new b),b.instance}getAllActions(){const e=this.getAppMessageManager();return e?e.getActions():[]}getAction(e,t){const i=this.getAppMessageManager();return i?i.getAction(e,t):null}getAppMessageManager(){return window._appWindow._messageManager?window._appWindow._messageManager:null}getActionSettingComponentUri(e,t,i){if(e.getSettingComponentUri)return e.getSettingComponentUri(t,i);if(e.widgetId){const t=(0,a.getAppStore)().getState().appStateInBuilder.appConfig.widgets[e.widgetId].manifest.messageActions.find((t=>t.name===e.name));return t?t.settingUri:null}return null}getFilteredActions(e,t){if(window._appWindow._messageManager){const i=window._appWindow._messageManager.getActions(),o=[],s={messageType:e,widgetId:t},n=(window.jimuConfig.isBuilder?(0,a.getAppStore)().getState().appStateInBuilder:(0,a.getAppStore)().getState()).appConfig.widgets[t].manifest.publishMessages.find((t=>"string"==typeof t?t===e:t.messageType===e));n&&"string"!=typeof n&&(s.messageCarryData=n.messageCarryData);for(let e=0;e<i.length;e++)i[e].filterMessageDescription(s)&&o.push(i[e]);return o}return[]}getConvertedSettingUri(e,t){const i=this.getAllActions();let o=null;for(let s=0;s<i.length;s++)if(e.includes(i[s].id)){const e=i[s].widgetId;if(e){const n=(0,a.getAppStore)().getState().appStateInBuilder.appConfig.widgets[e],r=n.manifest.messageActions;let p=null;if(r)for(let e=0;e<r.length;e++)r[e].name===i[s].name&&(p=r[e]);return p&&t?(o=n.uri+"dist/"+t,o):null}return t}return o}loadActionSettingClass(e,t){var i;return v(this,void 0,void 0,(function*(){const o=t?this.getConvertedSettingUri(e.actionId,t):null;if(o||Promise.resolve(null),this.actionSettings[o]||(this.actionSettings[o]={}),null===(i=this.actionSettings[o])||void 0===i?void 0:i.clazzPromise)return yield this.actionSettings[o].clazzPromise;const s=e.widgetId,n=(0,a.getAppStore)().getState().appStateInBuilder.appConfig.widgets[s];return this.actionSettings[o].clazzPromise=this.loadRawSettingClass(o).then((e=>v(this,void 0,void 0,(function*(){return S.getInstance().loadI18nMessagesForSetting(n&&n.uri).then((t=>this.injectActionSettingProps(e,t,n&&n.id)))})))).then((e=>(this.actionSettings[o].clazz=e,e))),this.actionSettings[o].clazzPromise}))}loadRawSettingClass(e){return v(this,void 0,void 0,(function*(){return this.actionSettings[e].rawClazzPromise?yield this.actionSettings[e].rawClazzPromise:(this.actionSettings[e].rawClazzPromise=a.moduleLoader.loadModule(e).then((t=>(t=t.default?t.default:t,this.actionSettings[e].rawClazz=t,this.actionSettings[e].rawClazz))),this.actionSettings[e].rawClazzPromise)}))}injectActionSettingProps(e,t,i){const o=(0,a.injectIntl)(e),s=(0,a.getAppStore)().getState().appStateInBuilder.appConfig.widgets[i];let n=null;n=i&&s?(0,a.getAppStore)().getState().appStateInBuilder.appConfig.widgets[i].manifest.name:"Framework";class r extends a.React.PureComponent{render(){const e={messages:t},n=(0,a.getAppStore)().getState().appI18nMessages;let r=null;i&&s?(r=w((0,a.getAppStore)().getState().appContext.locale,s.manifest.translatedLocales.asMutable()),r||(r=s.manifest.translatedLocales&&s.manifest.translatedLocales[0]),r||(r=(0,a.getAppStore)().getState().appContext.locale)):r=(0,a.getAppStore)().getState().appContext.locale;const p=Object.assign({},t,n);return a.React.createElement(a.IntlProvider,{locale:r,messages:p},a.React.createElement(o,Object.assign({},this.props,e)))}}r.displayName=`ActionSettingWrapper(${n})`;for(const t in e)r[t]||(r[t]=e[t]);return r}registerActionRawSettingClass(e,t){this.actionSettings[e]||(this.actionSettings[e]={}),this.actionSettings[e].rawClazz=t,this.actionSettings[e].rawClazzPromise=Promise.resolve(t),this.actionSettings[e].settingI18nMessages={},this.actionSettings[e].settingI18nMessagesPromise=Promise.resolve({})}getActionRawSettingClass(e){return this.actionSettings[e].rawClazz}}var L=l(758);function A(e,t,i){const{layoutId:o,layoutItemId:s}=e;if(!i[o])return i;if(!i[o].content[s])return i;const n=i[o];let r=(0,a.Immutable)(i);if(n.order&&n.order.includes(s)){const e=[];n.order.forEach((t=>{t!==s&&e.push(t)})),r=r.setIn([o,"order"],e)}return t&&(r=r.setIn([o,"content"],r[o].content.without(s))),r}function D(e,t){return Object.values(null!=t?t:{}).forEach((t=>{e=function(e,t){var i;const o=e.layouts[t];return o?(delete o.parent,Object.keys(null!==(i=o.content)&&void 0!==i?i:{}).forEach((t=>{const i=o.content[t];switch(i.type){case a.LayoutItemType.Widget:{const t=e.widgets[i.widgetId];t&&(delete t.parent,t.layouts&&Object.values(t.layouts).forEach((t=>{e=D(e,t)})));break}case a.LayoutItemType.Section:{const t=e.sections[i.sectionId];delete t.parent,t.views.forEach((t=>{const i=e.views[t];delete i.parent,e=D(e,i.layout)}));break}case a.LayoutItemType.ScreenGroup:{const t=e.screenGroups[i.screenGroupId];delete t.parent,t.screens.forEach((t=>{var i;const o=e.screens[t];delete o.parent,e=D(e,o.main.layout),(null===(i=o.panel)||void 0===i?void 0:i.layout)&&(e=D(e,o.panel.layout))}));break}}})),e):e}(e,t)})),e}const{getUniqueId:P,getUniqueLabel:x,parseUniqueLabel:M,getSizeModeOfALayout:T}=a.appConfigUtils;function j(e,t){return!!e.pageStructure.find((e=>!!e[t]))}function U(e,t){const i=e.pageStructure.find((e=>!!e[t]));return i&&i[t].length>0}function E(e){let t=0;return Object.keys(e.pages).forEach(((i,o)=>{O(e,i)&&t++})),t}function R(e,t){if(!j(e,t))return 0;let i=0;return e.pageStructure.forEach(((o,s)=>{const n=Object.keys(o)[0];n===t&&o[n].forEach((t=>{O(e,t)&&i++}))})),i}function _(e,t){let i=0;return O(e,t)&&(i=1),E(e)-R(e,t)-i}function O(e,t){const i=e.pages[t];return!!i&&i.type===a.PageType.Normal}function k(e){var t,i,o,s;return Object.values(null!==(t=e.pages)&&void 0!==t?t:{}).forEach((t=>{e=D(e,t.layout)})),Object.values(null!==(i=e.dialogs)&&void 0!==i?i:{}).forEach((t=>{e=D(e,t.layout)})),(null===(o=e.header)||void 0===o?void 0:o.layout)&&(e=D(e,e.header.layout)),(null===(s=e.footer)||void 0===s?void 0:s.layout)&&(e=D(e,e.footer.layout)),e}function W(e){let t=e.asMutable({deep:!0});var i;return Object.keys(t.widgets).forEach((e=>{var i,o,s;const n=t.widgets[e];n.label===(null===(i=n.manifest)||void 0===i?void 0:i.name)&&delete n.label,n.icon===n.context.folderUrl+"icon.svg"&&delete n.icon,"object"==typeof n.icon&&(n.icon.svg!==n.context.folderUrl+"icon.svg"||"#fff"!==(null===(o=n.icon.properties)||void 0===o?void 0:o.color)&&(null===(s=n.icon.properties)||void 0===s?void 0:s.color)||delete n.icon),delete n.context,delete n.manifest,delete n._originManifest})),t.layouts=(i=t.layouts,Object.keys(i).forEach((e=>{const t=i[e];delete t.id,t.content&&Object.keys(t.content).forEach((e=>{delete t.content[e].id}))})),i),t=a.appConfigUtils.cleanPortalInfoFromResource(t),t=k(t),t}function B(e,t,i,o){let s;return"page"===t?s=e.pages:"view"===t?s=e.views:"dialog"===t&&(s=e.dialogs),!!s&&Object.keys(s).some((e=>e!==i&&s[e].label===o))}var F;window._getCleanAppConfig=W,function(e){e.InAppAppStateChanged="IN_APP_APP_STATE_CHANGED",e.InBuilderAppConfigChanged="IN_BUILDER_APP_CONFIG_CHANGED"}(F||(F={}));const G={inAppAppStateChanged:e=>({type:F.InAppAppStateChanged,appState:e}),inBuilderAppConfigChanged:e=>({type:F.InBuilderAppConfigChanged,appConfig:e})};class ${constructor(){this.id="builder-app-state-redux-store-extension"}getActions(){return Object.keys(F).map((e=>F[e]))}getInitLocalState(){return null}getReducer(){return(e,t,i)=>{switch(t.type){case F.InAppAppStateChanged:return t.appState;case F.InBuilderAppConfigChanged:return a.appConfigUtils.updateStateWhenAppConfigChange(e,t.appConfig);default:return e}}}getStoreKey(){return"appStateInBuilder"}}var z;!function(e){e.InBuilderPutAppConfigIntoHistory="IN_BUILDER_PUT_APPCONFIG_INTO_HISTORY",e.InBuilderRemoveLastAppConfigFromHistory="IN_BUILDER_REMOVE_LAST_APPCONFIG_FROM_HISTORY",e.InBuilderAppConfigUndo="IN_BUILDER_APPCONFIG_UNDO",e.InBuilderAppConfigRedo="IN_BUILDER_APPCONFIG_REDO",e.InBuilderAppConfigRedoClear="IN_BUILDER_APPCONFIG_REDOCLEAR",e.InBuilderAppConfigClear="IN_BUILDER_APPCONFIG_CLEAR"}(z||(z={}));const N={InBuilderAppConfigUndo:()=>({type:z.InBuilderAppConfigUndo}),InBuilderAppConfigRedo:()=>({type:z.InBuilderAppConfigRedo}),InBuilderPutAppConfigIntoHistory:e=>({type:z.InBuilderPutAppConfigIntoHistory,appState:e}),InBuilderRemoveLastAppConfigFromHistory:()=>({type:z.InBuilderRemoveLastAppConfigFromHistory}),InBuilderAppConfigRedoClear:()=>({type:z.InBuilderAppConfigRedoClear}),InBuilderAppConfigClear:()=>({type:z.InBuilderAppConfigClear})};class q{constructor(){this.id="app-state-history-extension"}getActions(){return[z.InBuilderPutAppConfigIntoHistory,z.InBuilderRemoveLastAppConfigFromHistory,z.InBuilderAppConfigUndo,z.InBuilderAppConfigRedo,z.InBuilderAppConfigRedoClear,z.InBuilderAppConfigClear]}getInitLocalState(){return{past:[],future:[]}}getReducer(){return(e,t,i)=>{switch(t.type){case z.InBuilderAppConfigUndo:return this.handleAppStateUndo(e);case z.InBuilderAppConfigRedo:return this.handleAppStateRedo(e);case z.InBuilderPutAppConfigIntoHistory:return this.handleAppStateAdd(e,t.appState);case z.InBuilderRemoveLastAppConfigFromHistory:return this.handleAppStateRemoveLast(e);case z.InBuilderAppConfigRedoClear:return this.handleAppStateRedoClear(e);case z.InBuilderAppConfigClear:return this.handleAppStateClear(e);default:return e}}}handleAppStateUndo(e){if(e.past.length<2)return console.warn("Can not undo since no history there"),e;const t=e.past[e.past.length-2],i=e.past[e.past.length-1],o=e.past.slice(0,e.past.length-1),s=[i].concat(e.future);return a.lodash.defer((()=>{oe(t)})),e.merge({past:o,future:s})}handleAppStateRedo(e){if(e.future.length<1)return console.warn("Can not redo since no history there"),e;const t=e.future[0],i=e.future.slice(1),o=e.past.concat([t]);return a.lodash.defer((()=>{oe(t)})),e.merge({past:o,future:i})}handleAppStateAdd(e,t){if(null!==t&&(e.past.length>0&&e.past[e.past.length-1]!==t||0===e.past.length)){const i=e.past.concat([t]);return e.set("past",i).set("future",[])}return e}handleAppStateRemoveLast(e){if(e.past.length>1){const t=e.past.slice(0,e.past.length-1);return e.set("past",t)}return e}handleAppStateRedoClear(e){return e.set("future",[])}handleAppStateClear(e){return e.set("future",[]).set("past",[])}getStoreKey(){return"appStateHistory"}}var H,V,K;!function(e){e.AppConfigChanged="app_config_changed",e.AppInfoChanged="app_info_changed",e.PortalSelfChanged="portal_self_changed",e.DialogInfosChanged="dialog_infos_changed",e.UserSignIn="user_sign_in",e.SetMainPortal="set_main_portal",e.ChangeAppMode="change_app_mode",e.ChangePage="change_page",e.ChangeDialog="change_dialog",e.ChangeSelection="change_selection",e.ChangeWidgetStateProp="change_widget_state_prop",e.ChangeWidgetMutableStateProp="change_widget_mutable_state_prop",e.ChangeZoomScale="change_zoom_scale",e.BuilderTriggerKeyboard="builder_trigger_keyboard",e.ChangeBrowserSizeMode="change_browser_size_mode",e.BuilderSessionChanged="builder_session_changed",e.BuilderResignInFlagsChanged="builder_resign_in_flags_changed",e.ActivePagePartChanged="active_page_part_changed",e.AnimationPreview="animation_preview",e.HoverPreview="hover_preview",e.SectionNavInfoChanged="section_navinfo_changed",e.ScreenGroupNavInfoChanged="screengroup_navinfo_changed",e.TocHoverInfoChanged="toc_hover_info_changed",e.SetClientIdAlertIsCancelled="set_client_id_alert_is_cancelled"}(H||(H={})),function(e){e.AppStateChanged="app_state_changed",e.AppSessionChanged="app_session_changed",e.AppResignInFlagsChanged="app_resign_in_flags_changed",e.PopupChooseWidget="popup_choose_widget",e.AppAddResource="app_add_resource",e.AppClearResources="app_clear_resources",e.AppTriggerKeyboard="app_trigger_keyboard",e.SetLayoutTools="app_set_layout_tools",e.ClearLastAppConfigFromHistory="clear_last_app_config_from_history",e.SetIsBusy="app_set_isbusy",e.AppIsLoaded="app_is_loaded",e.ConfirmDelete="confirm_delete",e.NeedToRegisterClinetId="need_to_register_client_id",e.PopperSelector="popper_selector"}(V||(V={})),function(e){e.AddResource="ADD_RESOURCE",e.UpdateResource="UPDATE_RESOURCE",e.ClearResources="CLEAR_RESOURCES"}(K||(K={}));const Z={AddResource:(e,t)=>({type:K.AddResource,resourceKey:e,resourceItemInfo:t}),UpdateResource:(e,t)=>({type:K.UpdateResource,resourceKey:e,resourceItemInfo:t}),ClearResources:()=>({type:K.ClearResources})};class J{constructor(){this.id="builder-state-resource-extension"}getActions(){return Object.keys(K).map((e=>K[e]))}getInitLocalState(){return(0,a.Immutable)({})}getReducer(){return(e,t,i)=>{switch(t.type){case K.AddResource:case K.UpdateResource:return e.set(t.resourceKey,t.resourceItemInfo);case K.ClearResources:return(0,a.Immutable)({});default:return e}}}getStoreKey(){return"resourcesInfo"}}var Q,Y=l(325),X=l(726),ee=function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function a(e){try{p(o.next(e))}catch(e){n(e)}}function r(e){try{p(o.throw(e))}catch(e){n(e)}}function p(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};!function(e){e.Config="config/config.json",e.Image="images/image-resources-list.json",e.Icon="images/icon-resources-list.json"}(Q||(Q={}));class te{constructor(){this.resourceMap={},this.blobToResourceMap={},this.resourcesInDraft={},this.getResourcesInDraft=()=>this.resourcesInDraft,this.setResourcesInDraft=e=>{this.resourcesInDraft=Object.assign(Object.assign({},this.getResourcesInDraft()),e)},this.getImageResourceListFromDraft=e=>ee(this,void 0,void 0,(function*(){const t=this.getResourcesInDraft();if(t.imageResources)return yield Promise.resolve(t.imageResources);{const t=this.getSession(),i=this.getPortalUrlWithFull(e),{resources:o}=yield this.fetchAppResourceInfoList(e);if(null==o?void 0:o.some((({resource:e})=>e===Q.Image))){const o=yield this.fetchAppResource(e,{fileName:Q.Image,readAs:"json"});if(o)return Object.values(o).forEach((e=>{e.url.includes("?token=")&&(e.url=e.url.slice(0,e.url.indexOf("?token="))),e.url=e.url.replace("${appResourceUrl}",i)+"?token="+(null==t?void 0:t.token)})),yield Promise.resolve(o)}return yield this.upLoadImageResourceList({})}})),this.getIconResourceListFromDraft=()=>ee(this,void 0,void 0,(function*(){const{iconResources:e}=this.getResourcesInDraft();if(e)return yield Promise.resolve(e);const t=this.getAppId(),i=this.getSession(),o=this.getPortalUrlWithFull(t),{resources:s}=yield this.fetchAppResourceInfoList(t);if(null==s?void 0:s.some((({resource:e})=>e===Q.Icon))){const e=yield this.fetchAppResource(t,{fileName:Q.Icon,readAs:"json"});if(e)return Object.values(e).forEach((e=>{e.svg=e.svg.replace("${appResourceUrl}",o)+"?token="+(null==i?void 0:i.token),"string"==typeof e.properties.path&&(e.properties.path=e.properties.path.replace("${appResourceUrl}",o)+"?token="+(null==i?void 0:i.token))})),yield Promise.resolve(e)}return yield this.upLoadIconResourceList({})})),this.getInUseImageResources=e=>{var t;let i=W(null===(t=(0,a.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig);i=a.utils.replaceStringInObject(Object.assign({},i),{matcher:e=>/^blob:\http(s?):\/\/(.)/.test(e),handler:e=>{var t;return(null===(t=this.blobToResourceMap[e])||void 0===t?void 0:t.resourceUrl)||e}});const o={};a.utils.replaceStringInObject(Object.assign({},i),{matcher:e=>/^\$\{appResourceUrl\}+(.)/.test(e),handler:e=>o[e]=e});const s=[];return Object.values(e).forEach((e=>{const t=`\${appResourceUrl}/${e.resourcesPrefix}/${e.fileName}`;o[t]&&s.push(e)})),this.formatRelatedImageResources(e,s)},this.getInUseIconResources=e=>{var t;let i=W(null===(t=(0,a.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig);i=a.utils.replaceStringInObject(Object.assign({},i),{matcher:e=>/^blob:\http(s?):\/\/(.)/.test(e),handler:e=>{var t;return(null===(t=this.blobToResourceMap[e])||void 0===t?void 0:t.resourceUrl)||e}});const o={};a.utils.replaceStringInObject(Object.assign({},i),{matcher:e=>/^\$\{appResourceUrl\}+(.)/.test(e),handler:e=>o[e]=e});const s=[];return Object.values(e).forEach((e=>{const t=`\${appResourceUrl}/images/icon_picker_in_setting/${e.properties.filename}`;o[t]&&s.push(e)})),s},this.upLoadAppConfig=(e,t,i)=>ee(this,void 0,void 0,(function*(){const o=yield this.upLoadLocalResource(t),s=new Blob([JSON.stringify(o)],{type:"application/json"}),n={appId:e,file:s,fileName:"config.json",type:a.ResourceType.Config,owner:i};return yield this.upLoadAppResource(n).then((()=>ee(this,void 0,void 0,(function*(){return yield Promise.resolve(t)})))).catch((()=>ee(this,void 0,void 0,(function*(){return yield Promise.reject(null)}))))})),this.upLoadImageResourceList=e=>ee(this,void 0,void 0,(function*(){return yield this.upLoadResourceList(Q.Image,e)})),this.upLoadIconResourceList=e=>ee(this,void 0,void 0,(function*(){return yield this.upLoadResourceList(Q.Icon,e)})),this.upLoadAppResource=e=>ee(this,void 0,void 0,(function*(){e.resourcesPrefix=te.getResourcePrefix(e);const{appId:t=this.getAppId(),fileName:i,originalName:o,resourcesPrefix:s}=e,n=(s?s+"/":"")+i,r="${appResourceUrl}/"+n,p=(0,a.uuidv1)(),l={id:p,appId:t,fileName:i,originalName:o,resourcesPrefix:s,url:e.url,blobUrl:e.blobUrl,resourceUrl:r,type:e.type,status:a.AjaxState.Fetching,widgetId:e.widgetId,owner:e.owner},d=Object.assign({},l);d.file=e.file;const u=this.fetchAppResourceInfoList(t).then((({resources:e})=>ee(this,void 0,void 0,(function*(){if(0===(null==e?void 0:e.length))return yield this.addAppResource(d);if((null==e?void 0:e.length)>0)return e.some((({resource:e})=>e===n))?yield this.updateAppResource(d):yield this.addAppResource(d);throw new Error("return value from fetchAppResourceInfoList is not right")})))).catch((e=>ee(this,void 0,void 0,(function*(){return console.error(e),this.setResourceItemInfoStatus(d,a.AjaxState.Error),yield Promise.reject()}))));return d.promise=u,this.setResourceMap(p,l),yield u})),this.upLoadLocalResource=e=>ee(this,void 0,void 0,(function*(){const t=this.blobToResourceMap,i=new RegExp("^blob:http(s?)://(.)"),o=[],s={matcher:function(e){return i.test(e)},handler:function(e){let i=e;return i=t[e],!o.includes(i.id)&&o.push(i.id),i.resourceUrl}},n=a.utils.replaceStringInObject(e,s);return yield this.checkResourcesUploadStatus(o).then((e=>ee(this,void 0,void 0,(function*(){return e===a.AjaxState.Success?yield Promise.resolve(n):yield Promise.reject()}))))})),this.fetchAppResourceInfoList=(e,t)=>ee(this,void 0,void 0,(function*(){return yield Y.appServices.getAppResources({id:e,isLocalApp:window.jimuConfig.isDevEdition},t).catch((e=>ee(this,void 0,void 0,(function*(){return console.log(e),yield Promise.reject(null)}))))})),this.fetchAppResource=(e,t)=>ee(this,void 0,void 0,(function*(){return yield Y.appServices.getAppResource({id:e,isLocalApp:window.jimuConfig.isDevEdition},t).catch((e=>ee(this,void 0,void 0,(function*(){return console.log(e),yield Promise.reject(null)}))))})),this.clearResources=e=>{this.clearResourceMap(),this.clearResourcesWithoutSaved(e),(0,a.getAppStore)().dispatch(Z.ClearResources())},this.updateImageResourceItemInfo=e=>{const t=this.getAppId();this.getImageResourceListFromDraft(t).then((t=>{const i=Object.assign({},e);delete i.blobUrl,delete i.type,t[i.fileName.split(".")[0]]=i,this.setResourcesInDraft({imageResources:t})}))}}static getInstance(){return te._instance||(te._instance=new te,window._appResourceManager=te._instance),window._appResourceManager}static assignBlobUrlToResourceItem(e){return ee(this,void 0,void 0,(function*(){try{const t=window.URL.createObjectURL(e.file),{width:i,height:o}=yield X.imageUtils.getImageOriginalSizeByUrl(t).catch((()=>({width:0,height:0})));return e.url=t,e.blobUrl=t,e.originalWidth=i,e.originalHeight=o,yield Promise.resolve(e)}catch(e){return yield Promise.reject(e)}}))}static getBlobByBlobUrl(e){return ee(this,void 0,void 0,(function*(){return yield new Promise(((t,i)=>{const o=new XMLHttpRequest;o.responseType="blob",o.open("GET",e,!0),o.onerror=i,o.onload=()=>{200===o.status?t(o.response):i()},o.send()}))}))}static getResourcePrefix({resourcesPrefix:e,widgetId:t,type:i}){return e||(new Map([[a.ResourceType.Config,"config"],[a.ResourceType.Image,t?`images/${t}`:"images/templates"]]).get(i)||"templates")}addAppResource(e){return ee(this,void 0,void 0,(function*(){const t=this.getSession();return yield Y.appServices.getAppInfo({id:e.appId,isLocalApp:window.jimuConfig.isDevEdition}).then((i=>ee(this,void 0,void 0,(function*(){return yield Y.appServices.addAppResource({id:e.appId,resource:e.file,name:e.fileName,owner:i.owner,params:{resourcesPrefix:e.resourcesPrefix},authentication:t}).then((t=>ee(this,void 0,void 0,(function*(){return this.setResourceItemInfoStatus(e,a.AjaxState.Success),yield Promise.resolve(t)}))),(t=>ee(this,void 0,void 0,(function*(){return this.setResourceItemInfoStatus(e,a.AjaxState.Error),yield Promise.reject(t)}))))}))))}))}updateAppResource(e){return ee(this,void 0,void 0,(function*(){const t=this.getSession();return yield Y.appServices.getAppInfo({id:e.appId,isLocalApp:window.jimuConfig.isDevEdition}).then((i=>ee(this,void 0,void 0,(function*(){return yield Y.appServices.updateAppResource({id:e.appId,resource:e.file,name:e.fileName,owner:i.owner,params:{resourcesPrefix:e.resourcesPrefix},authentication:t}).then((t=>ee(this,void 0,void 0,(function*(){return this.setResourceItemInfoStatus(e,a.AjaxState.Success),yield Promise.resolve(t)}))),(t=>ee(this,void 0,void 0,(function*(){return this.setResourceItemInfoStatus(e,a.AjaxState.Error),yield Promise.reject(t)}))))}))))}))}removeAppResource(e){return ee(this,void 0,void 0,(function*(){const t=this.getSession(),i=e.appId?e.appId:this.getAppId();return yield Y.appServices.getAppInfo({id:i,isLocalApp:window.jimuConfig.isDevEdition}).then((o=>ee(this,void 0,void 0,(function*(){return yield Y.appServices.removeAppResource({id:i,owner:o.owner,resource:e.fileName,authentication:t}).then((e=>ee(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))),(e=>ee(this,void 0,void 0,(function*(){return yield Promise.reject(e)}))))}))))}))}getAppId(){var e;return null===(e=(0,a.getAppStore)().getState().appStateInBuilder)||void 0===e?void 0:e.appId}getSession(){return a.SessionManager.getInstance().getMainSession()}getPortalUrlWithTemplate(){return"${appResourceUrl}/"}getPortalUrlWithFull(e){return(0,Y.getResourceOrigin)({isLocalApp:window.jimuConfig.isDevEdition})+e+"/resources"}setResourceMap(e,t){const{id:i,resourceUrl:o}=t;this.resourceMap[e]=Object.assign(Object.assign({},this.resourceMap[e]),t),this.blobToResourceMap[t.blobUrl]={id:i,resourceUrl:o},(0,a.getAppStore)().dispatch(Z.AddResource(e,this.resourceMap[e]))}setResourceItemInfoStatus(e,t){this.resourceMap&&this.resourceMap[e.id]&&(e.status=t,delete e.file,this.setResourceMap(e.id,e))}clearResourceMap(){for(const e in this.resourceMap)this.resourceMap[e]&&window.URL.revokeObjectURL(this.resourceMap[e].blobUrl);this.resourceMap={},this.blobToResourceMap={}}clearValueWithoutInResourcesInDraft(e,t){return ee(this,void 0,void 0,(function*(){if(this.getAppId()!==e&&Object.keys(this.resourcesInDraft).forEach((e=>{this.resourcesInDraft[e]=null})),t.length>0){const i=yield this.getImageResourceListFromDraft(e),o=yield this.getIconResourceListFromDraft(),s=[...Object.values(i).map((({resourcesPrefix:e,fileName:t})=>`${e}/${t}`)),...Object.values(o).map((({properties:{filename:e}})=>`images/icon_picker_in_setting/${e}`))],n=t.filter((e=>!s.includes(e)));return yield Promise.resolve(n)}return yield Promise.resolve(t)}))}clearResourcesWithoutSaved(e){return ee(this,void 0,void 0,(function*(){if(e)try{const t=this.getPortalUrlWithFull(e),i=this.getPortalUrlWithTemplate(),{resources:o}=yield this.fetchAppResourceInfoList(e,{httpMethod:"GET"}),s=(null==o?void 0:o.some((({resource:e})=>e===Q.Config)))?yield this.fetchAppResource(e,{fileName:Q.Config,readAs:"json"}):{},n=new RegExp("^\\$\\{appResourceUrl\\}+(.)"),r=new RegExp("^"+t),p={};a.utils.replaceStringInObject(s,{matcher:e=>n.test(e)||r.test(e),handler:e=>p[e]=e});const l=[];null==o||o.forEach((({resource:e})=>{e===Q.Config||e===Q.Image||e===Q.Icon||p[i+e.replace("_compress","")]||p[t+e.replace("_compress","")]||l.push(e)}));const d=(yield this.clearValueWithoutInResourcesInDraft(e,l)).map((t=>this.removeAppResource({appId:e,fileName:t})));Promise.all(d)}catch(e){console.error(e)}}))}formatRelatedImageResources(e,t){const i={},o={},s=[];for(let e=0;e<t.length;e++){const i=t[e].fileName.split(".")[0];s.push(i)}return Object.keys(e).forEach((t=>{e[t].referedIds=[];const i=e[t].originId;(s.includes(i)||s.includes(t))&&(o[t]=e[t],o[i]=e[i])})),Object.keys(o).forEach((e=>{o[e].referedIds=[];const t=o[e].originId;t!==e&&(i[t]?i[t].referedIds.push(e):(i[t]=Object.assign({},o[t]),i[t].referedIds=[e]))})),Object.keys(i).forEach((e=>{o[e]&&(o[e].referedIds=i[e].referedIds)})),o}checkResourcesUploadStatus(e){return ee(this,void 0,void 0,(function*(){if(e.length>0){const t=e.map((e=>this.resourceMap[e].promise));return yield Promise.all(t).then((()=>ee(this,void 0,void 0,(function*(){return yield Promise.resolve(a.AjaxState.Success)}))),(()=>ee(this,void 0,void 0,(function*(){return yield Promise.resolve(a.AjaxState.Error)})))).catch((e=>ee(this,void 0,void 0,(function*(){return console.error(e),yield Promise.reject()}))))}return yield Promise.resolve(a.AjaxState.Success)}))}upLoadResourceList(e,t={}){return ee(this,void 0,void 0,(function*(){const i=this.getAppId(),o=yield this.upLoadLocalResource(t),s=a.appConfigUtils.cleanPortalInfoFromResource(o),n=new Blob([JSON.stringify(s)],{type:"application/json"}),[r,p]=e.split("/"),l={appId:i,file:n,resourcesPrefix:r,fileName:p,type:a.ResourceType.Image};return yield this.upLoadAppResource(l).then((()=>ee(this,void 0,void 0,(function*(){return yield Promise.resolve(s)})))).catch((()=>ee(this,void 0,void 0,(function*(){return yield Promise.reject(null)}))))}))}}var ie=function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function a(e){try{p(o.next(e))}catch(e){n(e)}}function r(e){try{p(o.throw(e))}catch(e){n(e)}}function p(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};function oe(e){Le(`to_app.${H.AppConfigChanged}`,e)}function se(e){Le(`to_app.${H.AppInfoChanged}`,e)}function ne(e){Le(`to_app.${H.DialogInfosChanged}`,e)}function ae(e){Le(`to_app.${H.ChangeAppMode}`,e)}function re(e){Le(`to_app.${H.ChangePage}`,e)}function pe(e){Le(`to_app.${H.ChangeDialog}`,e)}function le(e){Le(`to_app.${H.ChangeSelection}`,e)}function de(e){Le(`to_app.${H.ChangeWidgetStateProp}`,e)}function ue(e){Le(`to_app.${H.ChangeWidgetMutableStateProp}`,e)}function ce(e){Le(`to_app.${H.BuilderTriggerKeyboard}`,e)}function ge(e){Le(`to_app.${H.ChangeBrowserSizeMode}`,e)}function he(){Le(`to_app.${H.BuilderSessionChanged}`,a.SessionManager.getInstance().getSessions())}function fe(){Le(`to_app.${H.BuilderResignInFlagsChanged}`,a.SessionManager.getInstance().getResignInFlagsWhen403Error())}function ye(e){Le(`to_app.${H.ChangeZoomScale}`,e)}function me(e){Le(`to_app.${H.ActivePagePartChanged}`,e)}function Ie(e){Le(`to_app.${H.AnimationPreview}`,e)}function Ce(e){Le(`to_app.${H.HoverPreview}`,e)}function Se(e,t){Le(`to_app.${H.SectionNavInfoChanged}`,{sectionId:e,navInfo:t})}function ve(e,t){Le(`to_app.${H.ScreenGroupNavInfoChanged}`,{screenGroupId:e,activeIndex:t})}function we(e,t){Le(`to_app.${H.TocHoverInfoChanged}`,{layoutInfo:e,hovered:t})}function be(e){Le(`to_app.${H.SetClientIdAlertIsCancelled}`,{portalUrl:e})}function Le(e,t){window._builderPubsub.publishSync(e,t)}function Ae(){window._builderPubsub.subscribe(`to_builder.${V.AppSessionChanged}`,((e,t)=>{a.SessionManager.getInstance().syncSessionsFromOtherWindow(t)})),window._builderPubsub.subscribe(`to_builder.${V.AppResignInFlagsChanged}`,((e,t)=>{a.SessionManager.getInstance().syncResignInFlagsFromOtherWindow(t)})),window._builderPubsub.subscribe("to_builder",(function(e,t){console.debug(e,t)})),window._builderPubsub.subscribe(`to_builder.${V.AppStateChanged}`,((e,t)=>{var i;if((0,a.getAppStore)().getState().builder.currentAppId!==t.appId&&((0,a.getAppStore)().dispatch(h.changeCurrentApp(t.appId)),(0,a.getAppStore)().dispatch(N.InBuilderAppConfigClear()),(0,a.getAppStore)().getState().queryObject.id!==t.appId&&a.jimuHistory.changeQueryObject({id:t.appId})),!(0,a.getAppStore)().getState().appStateInBuilder||(0,a.getAppStore)().getState().appStateInBuilder.appConfig!==t.appConfig){const e=t.appConfig,o=null===(i=(0,a.getAppStore)().getState().appStateInBuilder)||void 0===i?void 0:i.appConfig;if(e&&o){if(Object.keys(e.widgets||{}).find((t=>e.widgets[t]&&o.widgets[t]&&e.widgets[t].version!==o.widgets[t].version)))return void(0,a.getAppStore)().dispatch(G.inAppAppStateChanged(t));const i=Object.keys(o.widgets).filter((t=>!e.widgets[t]));(0,a.getAppStore)().dispatch(h.widgetsRemoved(i));const s=Object.keys(e.widgets).filter((e=>!o.widgets[e])).map((t=>({widgetId:t,widgetUri:e.widgets[t].uri})));(0,a.getAppStore)().dispatch(h.widgetsAdded(s))}(0,a.getAppStore)().dispatch(N.InBuilderPutAppConfigIntoHistory(t.appConfig))}(0,a.getAppStore)().dispatch(G.inAppAppStateChanged(t))})),window._builderPubsub.subscribe(`to_builder.${V.PopupChooseWidget}`,((e,t)=>{(0,a.getAppStore)().dispatch(h.openChooseWidgetPopup(t.layoutId,t.layoutItemId))})),window._builderPubsub.subscribe(`to_builder.${V.AppAddResource}`,((e,t)=>{const i=te.getInstance();te.getBlobByBlobUrl(t.file).then((e=>ie(this,void 0,void 0,(function*(){t.file=e,i.upLoadAppResource(t),t.type===a.ResourceType.Image&&t.originId&&te.getInstance().updateImageResourceItemInfo(t)}))))})),window._builderPubsub.subscribe(`to_builder.${V.AppClearResources}`,((e,t)=>{te.getInstance().clearResources(t)})),window._builderPubsub.subscribe(`to_builder.${V.AppTriggerKeyboard}`,((e,t)=>{a.keyboardUtils.triggerEvent(t)})),window._builderPubsub.subscribe(`to_builder.${V.SetLayoutTools}`,((e,t)=>{(0,a.getAppStore)().dispatch(h.setLayoutTools(t))})),window._builderPubsub.subscribe(`to_builder.${V.ClearLastAppConfigFromHistory}`,(e=>{(0,a.getAppStore)().dispatch(N.InBuilderRemoveLastAppConfigFromHistory())})),window._builderPubsub.subscribe(`to_builder.${V.SetIsBusy}`,((e,t)=>{(0,a.getAppStore)().dispatch(a.appActions.setIsBusy(t))})),window._builderPubsub.subscribe(`to_builder.${V.ConfirmDelete}`,((e,t)=>{(0,a.getAppStore)().dispatch(h.confirmDeleteContentChanged(t))})),window._builderPubsub.subscribe(`to_builder.${V.NeedToRegisterClinetId}`,((e,t)=>{(0,a.getAppStore)().dispatch(a.appActions.addToRegisterClientIdList(t.portalUrl,t.needToSignIn,t.serviceUrl))})),window._builderPubsub.subscribe(`to_builder.${V.AppIsLoaded}`,((e,t)=>{var i;const o=(0,a.getAppStore)().getState(),s={portalUrl:o.portalUrl,clientId:o.clientId,isWebTier:o.isWebTier};Le(`to_app.${H.SetMainPortal}`,s),(0,a.observeStore)(((e,t)=>{Le(`to_app.${H.SetMainPortal}`,{portalUrl:t})}),["portalUrl"]),(0,a.getAppStore)().getState().portalSelf&&Le(`to_app.${H.PortalSelfChanged}`,(0,a.getAppStore)().getState().portalSelf),(0,a.observeStore)(((e,t)=>{Le(`to_app.${H.PortalSelfChanged}`,t)}),["portalSelf"]),a.portalUtils.getAppInfo(null===(i=(0,a.getAppStore)().getState().queryObject)||void 0===i?void 0:i.id).then((e=>{Le(`to_app.${H.AppInfoChanged}`,e)})),(0,a.getAppStore)().getState().user&&Le(`to_app.${H.UserSignIn}`,(0,a.getAppStore)().getState().user),he()}))}let De;try{De=window.parent&&window.parent._builderPubsub}catch(e){console.error("Can access parent.")}function Pe(){if(!De)return;De.unsubscribe("to_app");const e=(0,a.getAppStore)();De.subscribe("to_app",(function(e,t){console.debug(e,t)})),De.subscribe(`to_app.${H.AppConfigChanged}`,(function(t,i){const o=e.getState();if(o.appRuntimeInfo.currentPageId&&!i.pages[o.appRuntimeInfo.currentPageId]){const e=Object.keys(i.pages).find((e=>i.pages[e].isDefault));a.jimuHistory.changePage(e)}e.dispatch(a.appActions.appConfigChanged(i))})),De.subscribe(`to_app.${H.AppInfoChanged}`,(function(t,i){e.dispatch(a.appActions.appInfoChanged(i))})),De.subscribe(`to_app.${H.PortalSelfChanged}`,(function(t,i){if(e.dispatch(a.appActions.setPortalSelf(i)),i&&!i.isPortal){const t=`https://${i.urlKey}.${i.customBaseUrl}`;i.urlKey&&!a.portalUrlUtils.isSamePortalUrl(e.getState().portalUrl,t)&&e.dispatch(a.appActions.setPortalInfo({portalUrl:t}))}})),De.subscribe(`to_app.${H.UserSignIn}`,(function(t,i){e.dispatch(a.appActions.userSignIn(i))})),De.subscribe(`to_app.${H.SetMainPortal}`,(function(t,i){const o=Object.assign({portalUrl:e.getState().portalUrl,clientId:e.getState().clientId,isWebTier:e.getState().isWebTier},i);e.dispatch(a.appActions.setPortalInfo(o))})),De.subscribe(`to_app.${H.DialogInfosChanged}`,(function(t,i){e.dispatch(a.appActions.dialogInfosChanged(i))})),De.subscribe(`to_app.${H.ChangeAppMode}`,(function(t,i){e.dispatch(a.appActions.appModeChanged(i))})),De.subscribe(`to_app.${H.ChangeWidgetStateProp}`,(function(t,i){e.dispatch(a.appActions.widgetStatePropChange(i.widgetId,i.propKey,i.value))})),De.subscribe(`to_app.${H.ChangeWidgetMutableStateProp}`,(function(e,t){a.MutableStoreManager.getInstance().updateStateValue(t.widgetId,t.propKey,t.value)})),De.subscribe(`to_app.${H.ChangePage}`,(function(e,t){const i=(0,a.getAppStore)().getState().appConfig.pages[t];i.type===a.PageType.Link||i.type===a.PageType.Folder||a.urlUtils.parseAppPath(location.pathname,(0,a.getAppStore)().getState().appConfig).pageId===t?(0,a.getAppStore)().dispatch(a.appActions.currentPageChanged(t)):a.jimuHistory.changePage(t)})),De.subscribe(`to_app.${H.ChangeDialog}`,(function(t,i){a.jimuHistory.changeDialog(i),e.dispatch(a.appActions.currentDialogChanged(i))})),De.subscribe(`to_app.${H.ChangeSelection}`,(function(t,i){e.dispatch(a.appActions.selectionChanged(i))})),De.subscribe(`to_app.${H.BuilderTriggerKeyboard}`,(function(e,t){a.keyboardUtils.triggerEvent(t)})),De.subscribe(`to_app.${H.ChangeBrowserSizeMode}`,(function(t,i){e.dispatch(a.appActions.browserSizeModeChanged(i))})),De.subscribe(`to_app.${H.BuilderSessionChanged}`,(function(e,t){a.SessionManager.getInstance().syncSessionsFromOtherWindow(t)})),De.subscribe(`to_app.${H.BuilderResignInFlagsChanged}`,(function(e,t){a.SessionManager.getInstance().syncResignInFlagsFromOtherWindow(t)})),De.subscribe(`to_app.${H.ChangeZoomScale}`,(function(t,i){e.dispatch(a.appActions.zoomScaleChange(i))})),De.subscribe(`to_app.${H.ActivePagePartChanged}`,(function(t,i){e.dispatch(a.appActions.activePagePartChanged(i))})),De.subscribe(`to_app.${H.AnimationPreview}`,(function(t,i){e.dispatch(a.appActions.setupAnimationPreview(i))})),De.subscribe(`to_app.${H.HoverPreview}`,(function(t,i){e.dispatch(a.appActions.setupHoverPreview(i))})),De.subscribe(`to_app.${H.SectionNavInfoChanged}`,(function(t,i){e.dispatch(a.appActions.sectionNavInfoChanged(i.sectionId,i.navInfo)),a.jimuHistory.changeViewBySectionNavInfo(i.sectionId,i.navInfo)})),De.subscribe(`to_app.${H.ScreenGroupNavInfoChanged}`,(function(t,i){e.dispatch(a.appActions.screenGroupNavInfoChanged(i.screenGroupId,i.activeIndex))})),De.subscribe(`to_app.${H.TocHoverInfoChanged}`,(function(e,t){const{layoutInfo:i,hovered:o}=t,{layoutId:s,layoutItemId:n}=i,a=document.querySelector(`div.builder-layout-item[data-layoutid="${s}"][data-layoutitemid="${n}"]`);a&&(o?a.classList.add("hovered"):a.classList.remove("hovered"))})),De.subscribe(`to_app.${H.SetClientIdAlertIsCancelled}`,(function(e,t){a.SessionManager.getInstance().onClientIdDialogFinished(null==t?void 0:t.portalUrl,null,new Error("setting clientId is cancelled."))}))}function xe(){$e(`to_builder.${V.AppSessionChanged}`,a.SessionManager.getInstance().getSessions())}function Me(){$e(`to_builder.${V.AppResignInFlagsChanged}`,a.SessionManager.getInstance().getResignInFlagsWhen403Error())}function Te(){$e(`to_builder.${V.AppStateChanged}`,(0,a.getAppStore)().getState())}function je(){$e(`to_builder.${V.AppIsLoaded}`)}function Ue(e,t){$e(`to_builder.${V.PopupChooseWidget}`,{layoutId:e,layoutItemId:t})}function Ee(e){$e(`to_builder.${V.AppAddResource}`,e)}function Re(e){$e(`to_builder.${V.AppClearResources}`,e)}function _e(e){$e(`to_builder.${V.AppTriggerKeyboard}`,e)}function Oe(e){$e(`to_builder.${V.SetLayoutTools}`,e)}function ke(){$e(`to_builder.${V.ClearLastAppConfigFromHistory}`)}function We(e){$e(`to_builder.${V.SetIsBusy}`,e)}function Be(e){$e(`to_builder.${V.ConfirmDelete}`,e)}function Fe(e,t,i){$e(`to_builder.${V.NeedToRegisterClinetId}`,{portalUrl:e,needToSignIn:t,serviceUrl:i})}function Ge(e,t){$e(`to_builder.${V.PopperSelector}`,Object.assign({},t,{type:e}))}function $e(e,t){De&&De.publishSync(e,t)}function ze(e){let t;t=window.jimuConfig.isBuilder?window._appWindow._extensionManager:window._extensionManager;const i=t.getExtensions(`${a.extensionSpec.ExtensionPoints.AppConfigOperations}`);return null==i?void 0:i.find((t=>t.widgetId===e))}function Ne(){return window.jimuConfig.isBuilder?(0,a.getAppStore)().getState().appStateInBuilder.browserSizeMode:(0,a.getAppStore)().getState().browserSizeMode}function qe(e){var t,i;return(null==e?void 0:e.widgetType)===a.WidgetType.Layout||null!==(i=null===(t=null==e?void 0:e.properties)||void 0===t?void 0:t.hasEmbeddedLayout)&&void 0!==i&&i}function He(e=undefined){return e||(e=function(){const e=(0,a.getAppStore)().getState();return window.jimuConfig.isBuilder?e&&e.appStateInBuilder&&e.appStateInBuilder.appConfig:e&&e.appConfig}()),new Ve(e)}class Ve{constructor(e){this.duplicatedContentMaps={},this.clearDeletedWidgetMessageAction=(e,t)=>{this.getDeletedWidgetsMessageConfigs(e,t).forEach((e=>{this.removeMessageAction(e)}))},this.getDeletedWidgetsMessageConfigs=(e,t)=>{const i=e.messageConfigs,o=t.messageConfigs,s=[];if(!i)return s;const n=Object.keys(i),a=Object.keys(o);for(let e=0;e<n.length;e++)a.includes(n[e])||s.push(i[n[e]]);return s},this.removeMessageAction=e=>{var t;null===(t=null==e?void 0:e.actions)||void 0===t||t.forEach((t=>{const i=b.getInstance().getAction(t.widgetId,t.actionName);i&&i.onRemoveListen(e.messageType,e.widgetId)}))},this.appConfig=e}exec(e=!1){if(this.duplicatedContentMaps={},this.isDuplicatingPage=!1,window.jimuConfig.isBuilder){(0,a.getAppStore)().dispatch({type:"IN_BUILDER_APPCONFIG_REDOCLEAR"}),e&&(0,a.getAppStore)().dispatch(N.InBuilderRemoveLastAppConfigFromHistory()),oe(this.appConfig);const t=(0,a.getAppStore)().getState().appStateInBuilder.appConfig,i=this.appConfig,o=Object.keys(t.widgets).filter((e=>!i.widgets[e]));(0,a.getAppStore)().dispatch(h.widgetsRemoved(o)),this.clearDeletedWidgetMessageAction(t,i);const s=Object.keys(i.widgets).filter((e=>!t.widgets[e])).map((e=>({widgetId:e,widgetUri:i.widgets[e].uri})));(0,a.getAppStore)().dispatch(h.widgetsAdded(s)),(0,a.getAppStore)().dispatch(G.inBuilderAppConfigChanged(this.appConfig)),(0,a.getAppStore)().dispatch(N.InBuilderPutAppConfigIntoHistory(this.appConfig))}else{e&&ke();const t=(0,a.getAppStore)().getState().appConfig,i=this.appConfig;this.clearDeletedWidgetMessageAction(t,i),(0,a.getAppStore)().dispatch(a.appActions.appConfigChanged(this.appConfig))}return this}editWidgetConfig(e,t){return this.appConfig.widgets[e]?(this.appConfig=this.appConfig.setIn(["widgets",e,"config"],t),this):this}editWidget(e,t){if(!this.appConfig.widgets[e.id])return this;const i=this.appConfig.widgets[e.id];let o=i;return t&&(t.forEach((e=>{e.isOutputFromWidget||(e.isOutputFromWidget=!0)})),o=o.set("outputDataSources",t.map((e=>e.id)))),Object.keys(e).forEach((t=>{null===e[t]&&("outputDataSourcesJson"===t&&e.outputDataSources&&e.outputDataSources.forEach((e=>this.removeDataSource(e))),o=o.without(t),delete e[t])})),i.outputDataSources&&i.outputDataSources.forEach((e=>{o.outputDataSources&&o.outputDataSources.includes(e)||this.removeDataSource(e)})),o.outputDataSources&&o.outputDataSources.forEach((e=>{const o=t&&t.find((t=>t.id===e));if(o)if(i.outputDataSources&&i.outputDataSources.includes(e)){let t=this.appConfig.dataSources[e];if(!t)return void console.error("Unknown error. Widget output data source is not in data source json.",e);Object.keys(o).forEach((e=>{null===o[e]&&(t=t.without(e),delete o[e])})),this.editDataSource(t.merge(o))}else this.addDataSource((0,a.Immutable)(o))})),o=o.merge(e),e.useDataSources&&o.layouts&&o.manifest.properties.passDataSourceToChildren&&this.copyUseDataSourceToAllChildWidgets(i,o),this.appConfig=this.appConfig.setIn(["widgets",e.id],o),this}editWidgetProperty(e,t,i){return this.appConfig.widgets&&this.appConfig.widgets[e]?"outputDataSources"===t?(console.error("Please use editWidget to update outputDataSources."),this):this.appConfig.widgets[e].getIn([t])===i?this:this.editWidget({id:e,[t]:i}):this}createWidget(e,t=!0){return this.appConfig=this.appConfig.setIn(["widgets",e.id],e),t&&qe(e.manifest)&&(this.createLayoutsForWidget(e,Ne()),e=this.appConfig.widgets[e.id]),this.appConfig=this.appConfig.setIn(["widgets",e.id],e),e}removeWidget(e){var t,i;if(!this.appConfig.widgets||!this.appConfig.widgets[e])return this;const o=this.appConfig.widgets[e];L.searchUtils.getLayoutInfosHoldcontent(this.appConfig,a.LayoutItemType.Widget,e).forEach((e=>{this.removeLayoutItem(e,!1)})),o.outputDataSources&&o.outputDataSources.forEach((e=>this.removeDataSource(e))),this.appConfig=this.removeWidgetMessageAndAction(this.appConfig,e),this.appConfig=this.removeDataActionProvidedByWidget(this.appConfig,e),o.layouts&&Object.keys(o.layouts).forEach((e=>{const t=o.layouts[e];Object.keys(t).forEach((e=>{this.removeLayout(t[e],!0)}))})),(null===(i=null===(t=o.manifest)||void 0===t?void 0:t.properties)||void 0===i?void 0:i.canCreateMapView)&&(this.appConfig=this.removeUseMapWidgetId(o.id));const s=ze(e);return s&&(this.appConfig=s.widgetWillRemove(this.appConfig)),this.appConfig=this.appConfig.set("widgets",this.appConfig.widgets.without(e)),this.removeControllerPanel(e),this}duplicateWidget(e){var t,i,o;if(!e||!this.appConfig.widgets[e])return null;const s=this.appConfig.widgets[e];let n=s.set("id",P(this.appConfig,"widget")).set("label",this.getDuplicateLabel("widget",s.label));if(qe(n.manifest)&&(this.appConfig=this.appConfig.setIn(["widgets",n.id],n),n=this.doDuplicateEmbedWidgetContent(n)),this.duplicateWidgetMessageConfig(e,n.id),(null===(t=n.outputDataSources)||void 0===t?void 0:t.length)>0){const e=n.outputDataSources.map((e=>this.duplicateDataSource(e).id));n=n.set("outputDataSources",e);let t=JSON.stringify(n.config);e.forEach(((e,i)=>{const o=s.outputDataSources[i],n=new RegExp(o,"g");t=t.replace(n,e)}));try{const e=JSON.parse(t);n=n.set("config",e)}catch(e){console.error("JSON format error",n)}}if((null===(i=n.useMapWidgetIds)||void 0===i?void 0:i.length)>0&&n.useMapWidgetIds.forEach(((e,t)=>{this.duplicatedContentMaps[e]&&(n=n.setIn(["useMapWidgetIds",t],this.duplicatedContentMaps[e]))})),this.appConfig=this.appConfig.setIn(["widgets",n.id],n),!this.isDuplicatingPage){const t=ze(e);t&&(this.appConfig=t.afterWidgetCopied(n.id,this.appConfig))}return(null===(o=this.appConfig.controllerPanels)||void 0===o?void 0:o[e])&&(this.appConfig=this.appConfig.setIn(["controllerPanels",n.id],this.appConfig.controllerPanels[e])),n}editControllerPanel(e,t){return this.appConfig=this.appConfig.setIn(["controllerPanels",e],t),this}removeControllerPanel(e){var t;return(null===(t=this.appConfig.controllerPanels)||void 0===t?void 0:t[e])&&(this.appConfig=this.appConfig.set("controllerPanels",this.appConfig.controllerPanels.without(e))),this}createSection(){const e=this.createEmptyLayoutJson(this.appConfig).set("type",a.LayoutType.FixedLayout);this.appConfig=this.appConfig.setIn(["layouts",e.id],e);const t=(0,a.Immutable)({id:P(this.appConfig,"view"),label:x(this.appConfig,"view",a.i18n.getIntl().formatMessage({id:"view"}))}).setIn(["layout",(0,a.getAppStore)().getState().browserSizeMode],e.id);this.appConfig=this.appConfig.setIn(["views",t.id],t);const i=P(this.appConfig,"section"),o=x(this.appConfig,"section",a.i18n.getIntl().formatMessage({id:"section"})),s=(0,a.Immutable)({id:i,label:o,views:[t.id]});return this.appConfig=this.appConfig.setIn(["sections",s.id],s).setIn(["views",t.id,"parent"],i).setIn(["layouts",e.id,"parent"],{id:t.id,type:a.LayoutParentType.View}),s}removeSection(e){return this.appConfig.sections&&this.appConfig.sections[e]?(L.searchUtils.getLayoutInfosHoldcontent(this.appConfig,a.LayoutItemType.Section,e).forEach((e=>{this.removeLayoutItem(e,!1)})),this.removeSectionContent(e),this.appConfig=this.appConfig.set("sections",this.appConfig.sections.without(e)),this):this}editSection(e){if(!this.appConfig.sections[e.id])return this;const t=this.appConfig.sections[e.id];return e.views.length!==t.views.length?(console.error("Can not add/remove view."),this):(this.appConfig=this.appConfig.setIn(["sections",e.id],e),this)}editSectionProperty(e,t,i){if(!this.appConfig.sections||!this.appConfig.sections[e])return this;const o=this.appConfig.sections[e];return o.getIn([t])===i?this:this.editSection(o.set(t,i))}editScreenGroupProperty(e,t,i){return this.appConfig.screenGroups&&this.appConfig.screenGroups[e]?(this.appConfig.screenGroups[e].getIn([t])===i||(this.appConfig=this.appConfig.setIn(["screenGroups",e,t],i)),this):this}duplicateSection(e){if(!e||!this.appConfig.sections[e])return null;const t=this.appConfig.sections[e];let i=t.set("id",P(this.appConfig,"section")).set("label",this.getDuplicateLabel("section",t.label));this.appConfig=this.appConfig.setIn(["sections",i.id],i);const o=t.views&&t.views.map((e=>this.duplicateView(e,i.id,!1).id));return i=i.set("views",o),this.appConfig=this.appConfig.setIn(["sections",i.id],i),i}editView(e){return this.appConfig=this.appConfig.setIn(["views",e.id],e),this}addView(e,t){if(this.appConfig.views&&this.appConfig.views[e.id])return this;if(!this.appConfig.sections[t])return this;let i;this.appConfig.sections&&this.appConfig.sections[t]&&this.appConfig.sections[t].views?(i=this.appConfig.sections[t].views.asMutable(),i.push(e.id)):i=[e.id],this.appConfig=this.appConfig.setIn(["views",e.id,"parent"],t);const{type:o,id:s}=L.searchUtils.getContentRootContainerInfo(this.appConfig,t,a.LayoutItemType.Section,Ne()),n={},r=t=>{const i=(0,a.Immutable)({}).merge({id:P(this.appConfig,"layout"),type:a.LayoutType.FixedLayout,parent:{id:e.id,type:a.LayoutParentType.View}});n[t]=i,this.addLayout(n[t])};return o===a.ContainerType.Header||o===a.ContainerType.Footer?Object.keys(this.appConfig[s].layout).forEach((e=>{r(e)})):o===a.ContainerType.Page?Object.keys(this.appConfig.pages[s].layout).forEach((e=>{r(e)})):o===a.ContainerType.Dialog&&Object.keys(this.appConfig.dialogs[s].layout).forEach((e=>{r(e)})),Object.keys(n).forEach((t=>{e=e.setIn(["layout",t],n[t].id)})),e=e.set("parent",t),this.appConfig=this.appConfig.setIn(["views",e.id],e).setIn(["sections",t,"views"],(0,a.Immutable)(i)),this}duplicateView(e,t,i){var o;if(!this.appConfig.views||!this.appConfig.views[e])return null;let s=this.appConfig.views[e].set("id",P(this.appConfig,"view"));if(s=s.set("label",this.getDuplicateLabel("view",s.label)),this.appConfig=this.appConfig.setIn(["views",s.id],s),s=s.set("layout",this.doDuplicateContainerContent(a.ContainerType.View,e)),this.appConfig=this.appConfig.setIn(["views",s.id],s),i){let e=this.appConfig.sections[t];e=e.set("views",e.views.concat(s.id)),this.appConfig=this.appConfig.setIn(["sections",e.id],e)}return Object.keys(null!==(o=s.layout)&&void 0!==o?o:{}).forEach((e=>{const t=s.layout[e];this.clearLayoutStructure(t,e,!0),this.buildLayoutStructure(t,e,!0),this.appConfig=this.appConfig.setIn(["layouts",t,"parent"],{id:s.id,type:a.LayoutParentType.View})})),s}removeView(e,t){if(!(this.appConfig.views&&this.appConfig.views[e]&&this.appConfig.sections[t]&&this.appConfig.sections[t].views))return this;if(!this.appConfig.sections||!this.appConfig.sections[t]||1===this.appConfig.sections[t].views.length||!this.appConfig.sections[t].views.includes(e))return this;const i=this.appConfig.sections[t].views.flatMap((t=>t===e?[]:[t]));return this.appConfig=this.appConfig.setIn(["sections",t,"views"],i),this.removeContainerContent(a.ContainerType.View,e),this.appConfig=this.appConfig.set("views",this.appConfig.views.without(e)),this}moveViewInSection(e,t,i,o){if(!(this.appConfig.sections&&this.appConfig.sections[e]&&this.appConfig.views&&this.appConfig.views[t]&&this.appConfig.views[i]))return this;if(i===t)return console.error("viewId is same to targetViewId."),this;let s=this.appConfig.sections[e].views.asMutable();s=s.filter((e=>e!==t));let n=s.indexOf(i);return"below"===o&&n++,s=s.slice(0,n).concat(t).concat(s.slice(n)),this.appConfig=this.appConfig.setIn(["sections",e,"views"],s),this}createScreenGroup(){const e=P(this.appConfig,"screenGroup"),t=x(this.appConfig,"screenGroup",a.i18n.getIntl().formatMessage({id:"screenGroup"})),i=(0,a.Immutable)({id:e,label:t,screens:[],transitionType:a.ScreenTransitionType.Fade});return this.appConfig=this.appConfig.setIn(["screenGroups",i.id],i),i}editScreen(e){return this.appConfig=this.appConfig.setIn(["screens",e.id],e),this}moveScreenInGroup(e,t,i,o){var s;if(!(null===(s=this.appConfig.screenGroups)||void 0===s?void 0:s[e])||t===i)return this;const n=this.appConfig.screenGroups[e].screens.asMutable(),a=n[t],r=n[i];n.splice(t,1);const p=n.indexOf(r);return"below"===o?n.splice(p,1,r,a):n.splice(p,1,a,r),this.appConfig=this.appConfig.setIn(["screenGroups",e,"screens"],n),this}removeScreenByIndex(e,t){var i,o;const s=null===(o=null===(i=this.appConfig.screenGroups)||void 0===i?void 0:i[t])||void 0===o?void 0:o.screens,n=null==s?void 0:s[e];return this.removeScreen(n,t)}removeScreenGroup(e){var t;return(null===(t=this.appConfig.screenGroups)||void 0===t?void 0:t[e])?(this.appConfig.screenGroups[e].screens&&this.appConfig.screenGroups[e].screens.forEach((t=>{this.removeScreen(t,e,!0)})),L.searchUtils.getLayoutInfosHoldcontent(this.appConfig,a.LayoutItemType.ScreenGroup,e).forEach((e=>{this.removeLayoutItem(e,!1)})),this.appConfig=this.appConfig.set("screenGroups",this.appConfig.screenGroups.without(e)),this):this}removeScreen(e,t,i=!1){var o,s,n,a;if(!(null===(o=this.appConfig.screens)||void 0===o?void 0:o[e])||!(null===(n=null===(s=this.appConfig.screenGroups)||void 0===s?void 0:s[t])||void 0===n?void 0:n.screens))return this;if(1===this.appConfig.screenGroups[t].screens.length&&!i||!this.appConfig.screenGroups[t].screens.includes(e))return this;const r=this.appConfig.screenGroups[t].screens.flatMap((t=>t===e?[]:[t]));this.appConfig=this.appConfig.setIn(["screenGroups",t,"screens"],r);const p=this.appConfig.screens[e];return Object.keys((null===(a=p.panel)||void 0===a?void 0:a.layout)||{}).forEach((e=>{const t=p.panel.layout[e];this.removeLayout(t,!0)})),Object.keys(p.main.layout).forEach((e=>{const t=p.main.layout[e];this.removeLayout(t,!0)})),this.appConfig=this.appConfig.set("screens",this.appConfig.screens.without(e)),this}duplicateScreenByIndex(e,t,i=!0){var o,s;const n=null===(s=null===(o=this.appConfig.screenGroups)||void 0===o?void 0:o[t])||void 0===s?void 0:s.screens,a=null==n?void 0:n[e];return this.duplicateScreen(a,t,i)}duplicateScreen(e,t,i=!0){var o,s;if(!this.appConfig.screens[e])return null;let n=this.appConfig.screens[e].set("id",P(this.appConfig,"screen"));if(n=n.set("label",this.getDuplicateLabel("screen",n.label)),this.appConfig=this.appConfig.setIn(["screens",n.id],n),(null===(o=n.panel)||void 0===o?void 0:o.layout)&&Object.keys(n.panel.layout).forEach((e=>{const t=this.duplicateLayout(n.panel.layout[e],!0);this.appConfig=this.appConfig.setIn(["layouts",t.id],t),n=n.setIn(["panel","layout",e],t.id)})),Object.keys(n.main.layout).forEach((e=>{const t=this.duplicateLayout(n.main.layout[e],!0);this.appConfig=this.appConfig.setIn(["layouts",t.id],t),n=n.setIn(["main","layout",e],t.id)})),this.appConfig=this.appConfig.setIn(["screens",n.id],n),i){let i=this.appConfig.screenGroups[t];const o=i.screens.asMutable(),s=o.indexOf(e);o.splice(s,1,e,n.id),i=i.set("screens",o),this.appConfig=this.appConfig.setIn(["screenGroups",i.id],i)}return(null===(s=n.panel)||void 0===s?void 0:s.layout)&&Object.keys(n.panel.layout).forEach((e=>{const t=n.panel.layout[e];this.appConfig=this.appConfig.setIn(["layouts",t,"parent"],{id:n.id,type:a.LayoutParentType.Screen}),this.clearLayoutStructure(t,e,!0),this.buildLayoutStructure(t,e,!0)})),Object.keys(n.main.layout).forEach((e=>{const t=n.main.layout[e];this.appConfig=this.appConfig.setIn(["layouts",t,"parent"],{id:n.id,type:a.LayoutParentType.Screen}),this.clearLayoutStructure(t,e,!0),this.buildLayoutStructure(t,e,!0)})),n}duplicateScreenGroup(e){if(!this.appConfig.screenGroups[e])return null;const t=this.appConfig.screenGroups[e];let i=t.set("id",P(this.appConfig,"screenGroup")).set("label",this.getDuplicateLabel("screenGroup",t.label));this.appConfig=this.appConfig.setIn(["screenGroups",i.id],i);const o=t.screens.map((e=>this.duplicateScreen(e,i.id,!1).id));return i=i.set("screens",o),this.appConfig=this.appConfig.setIn(["screenGroups",i.id],i),i}editPage(e){return this.appConfig=this.appConfig.setIn(["pages",e.id],e),this}editPageProperty(e,t,i){if(!this.appConfig.pages||!this.appConfig.pages[e])return this;const o=this.appConfig.pages[e];return o.getIn([t])===i?this:this.editPage(o.setIn([t],i))}addPage(e){return this.appConfig.pages&&this.appConfig.pages[e.id]||(this.appConfig=this.appConfig.setIn(["pages",e.id],e),this.appConfig=this.appConfig.set("pageStructure",this.appConfig.pageStructure.concat([{[e.id]:[]}]))),this}duplicatePage(e,t=!1){if(!this.appConfig.pages||!this.appConfig.pages[e])return null;this.isDuplicatingPage=!0;let i=this.appConfig.pages[e].set("id",P(this.appConfig,"page"));i=i.set("label",this.getDuplicateLabel("page",i.label)),this.appConfig=this.appConfig.setIn(["pages",i.id],i),i.isDefault&&(i=i.set("isDefault",!1)),i.type!==a.PageType.Link&&i.type!==a.PageType.Folder&&(i=i.set("layout",this.doDuplicateContainerContent(a.ContainerType.Page,i.id)),this.isDuplicatingPage=!1,Object.keys(this.duplicatedContentMaps).forEach((e=>{if(this.appConfig.widgets[e]){const t=ze(e);t&&(this.appConfig=t.afterWidgetCopied(this.duplicatedContentMaps[e],this.appConfig,this.duplicatedContentMaps))}})),Object.keys(i.layout).forEach((e=>{const t=i.layout[e];this.appConfig=this.appConfig.setIn(["layouts",t,"parent"],{id:i.id,type:a.LayoutParentType.Page}),this.clearLayoutStructure(t,e,!0),this.buildLayoutStructure(t,e,!0)})));const o=this.appConfig.pageStructure.find((t=>!!t[e])),s=[];if(o&&o[e].forEach((e=>{const t=this.duplicatePage(e,!0);s.push(t.id)})),!t)if(o){if(this.appConfig=this.appConfig.set("pageStructure",this.appConfig.pageStructure.concat([{[i.id]:[]}])),s.length>0){const e=i.id;let t=this.appConfig.pageStructure.length-1;t<0&&(t=0),this.appConfig=this.appConfig.setIn(["pageStructure",t+"",e],s)}}else this.appConfig.pageStructure.some(((t,o)=>{const s=Object.keys(t).find((i=>t[i].includes(e)));if(s)return this.appConfig=this.appConfig.setIn(["pageStructure",o+"",s],this.appConfig.pageStructure[o][s].concat(i.id)),!0}));return this.appConfig=this.appConfig.setIn(["pages",i.id],i),i}movePageIntoPage(e,t){return this.appConfig.pages&&this.appConfig.pages[e]&&this.appConfig.pages[t]?e===t?(console.error("SubPage is same to ParentPage."),this):j(this.appConfig,t)?U(this.appConfig,e)?(console.error("SubPage has sub page(s)."),this):(this.removePageFromPageStructure(e),this.movePageIntoPageForPageStructure(e,t),this):(console.error("ParentPage is not on the first aspect."),this):this}orderPageToPage(e,t,i){if(!this.appConfig.pages||!this.appConfig.pages[t]||!this.appConfig.pages[e])return this;if(t===e)return console.error("pageId is same to targetPageId."),this;const o=!j(this.appConfig,t);if((U(this.appConfig,e)||this.appConfig.pages[e].type===a.PageType.Folder)&&o)return console.error("page structure allow two aspects only"),this;const s=this.appConfig.pageStructure.find((t=>!!t[e]));return this.removePageFromPageStructure(e),o?this.appConfig.pageStructure.some(((o,s)=>{const n=Object.keys(o)[0];let a=o[n].indexOf(t);if(a>-1){let t=this.appConfig.pageStructure[s][n];return"bottom"===i&&(a+=1),t=t.slice(0,a).concat([e]).concat(t.slice(a)),this.appConfig=this.appConfig.setIn(["pageStructure",s+"",n],t),!0}})):this.appConfig.pageStructure.some(((o,n)=>{if(Object.keys(o)[0]===t){"bottom"===i&&(n+=1);const t=this.appConfig.pageStructure.slice(0,n).concat([s||{[e]:[]}]).concat(this.appConfig.pageStructure.slice(n));return this.appConfig=this.appConfig.set("pageStructure",t),!0}})),this}removePage(e,t){if(!this.appConfig.pages||!this.appConfig.pages[e])return this;const i=this.appConfig.pages[e];i.type!==a.PageType.Folder&&i.type!==a.PageType.Link&&this.removeContainerContent(a.ContainerType.Page,e);const{pageStructure:o}=this.appConfig,s=o&&o.find((t=>!!t[e]));return s&&s[e].length>0&&s[e].forEach((e=>{this.removePage(e)})),this.removePageFromPageStructure(e),this.appConfig=this.appConfig.set("pages",this.appConfig.pages.without(e)),t&&this.setHomePage(t),this}setHomePage(e){return this.editPageProperty(e,"isDefault",!0)}setUseAutoSortInFixedLayout(e){return this.appConfig=this.appConfig.set("useAutoSortInFixedLayout",e),this}replaceHomePage(e){return Object.keys(this.appConfig.pages).some(((e,t)=>{const i=this.appConfig.pages[e];if(i.isDefault)return this.editPageProperty(i.id,"isDefault",!1),!0})),this.editPageProperty(e,"isDefault",!0)}editDialog(e){const t=this.appConfig.dialogs[e.id].mode;if(t!==e.mode){const i=this.appConfig.dialogs.asMutable({deep:!0});Object.keys(i).forEach((o=>{const s=i[o];s.id===e.id?i[o]=Object.assign({},e.asMutable({deep:!0}),{index:Object.keys(i).filter((e=>i[e].mode!==t)).length}):s.mode===t&&s.index>e.index&&(s.index=s.index-1)})),this.appConfig=this.appConfig.set("dialogs",(0,a.Immutable)(i))}else this.appConfig=this.appConfig.setIn(["dialogs",e.id],e);return this}editDialogProperty(e,t,i){if(!this.appConfig.dialogs||!this.appConfig.dialogs[e])return this;const o=this.appConfig.dialogs[e];return o.getIn([t])===i?this:this.editDialog(o.setIn([t],i))}removeDialog(e){const t=this.appConfig.dialogs;if(!t||!t[e])return this;this.removeContainerContent(a.ContainerType.Dialog,e);const i=t[e].mode,o=t[e].index,s=t.without(e).asMutable({deep:!0});return Object.keys(s).forEach((e=>{const t=s[e];t.mode===i&&t.index>o&&(t.index=t.index-1)})),this.appConfig=this.appConfig.set("dialogs",(0,a.Immutable)(s)),this}duplicateDialog(e){const t=this.appConfig.dialogs;let i=t[e];if(!t||!i)return null;const o=Object.keys(Object.keys(t).filter((e=>t[e].mode===i.mode))).length;return i=i.set("id",P(this.appConfig,"dialog")).set("index",o).set("isSplash",!1).set("label",this.getDuplicateLabel("dialog",i.label)).set("layout",this.doDuplicateContainerContent(a.ContainerType.Dialog,i.id)),this.appConfig=this.appConfig.setIn(["dialogs",i.id],i),Object.keys(i.layout).forEach((e=>{const t=i.layout[e];this.appConfig=this.appConfig.setIn(["layouts",t,"parent"],{id:i.id,type:a.LayoutParentType.Dialog}),this.clearLayoutStructure(t,e,!0),this.buildLayoutStructure(t,e,!0)})),i}orderDialogToDialog(e,t,i){const o=this.appConfig.dialogs.asMutable({deep:!0}),s=o[e],n=o[t];if(!o||!s||!n)return this;if(t===e)return console.error("dialogId is same to targetDialogId."),this;let r;return n.index>s.index?(r="top"===i?n.index-1:n.index,Object.keys(o).forEach((t=>{const i=o[t];i.mode===n.mode&&i.id!==e&&i.index>s.index&&i.index<=r&&(i.index=i.index-1)}))):(r="top"===i?n.index:n.index+1,Object.keys(o).forEach((t=>{const i=o[t];i.mode===n.mode&&i.id!==e&&i.index>=r&&i.index<s.index&&(i.index=i.index+1)}))),o[e]=Object.assign({},s,{index:r,mode:n.mode}),this.appConfig=this.appConfig.set("dialogs",(0,a.Immutable)(o)),this}replaceSplashDialog(e,t){return t&&this.editDialogProperty(t,"isSplash",!1),e!==t?this.editDialogProperty(e,"isSplash",!0):this}createLayoutForSizeModeForHeader(e,t){if(!this.appConfig.header)return this;const i=this.createLayoutForSizeModeForOneLayout(e,t,this.appConfig.header.layout);return i&&(this.appConfig=this.appConfig.setIn(["header","layout",e],i.id).setIn(["layouts",i.id,"parent"],{id:"header",type:a.LayoutParentType.Header}),this.buildLayoutStructure(i.id,e,!0)),this}removeSizeModeLayoutFromHeader(e){return this.appConfig.header.layout?(this.removeSizeModeLayout(this.appConfig.header.layout[e],e),this.appConfig=this.appConfig.setIn(["header","layout"],this.appConfig.header.layout.without(e)),this):this}createLayoutForSizeModeForFooter(e,t){if(!this.appConfig.footer)return this;const i=this.createLayoutForSizeModeForOneLayout(e,t,this.appConfig.footer.layout);return i&&(this.appConfig=this.appConfig.setIn(["footer","layout",e],i.id).setIn(["layouts",i.id,"parent"],{id:"footer",type:a.LayoutParentType.Footer}),this.buildLayoutStructure(i.id,e,!0)),this}removeSizeModeLayoutFromFooter(e){return this.appConfig.footer.layout?(this.removeSizeModeLayout(this.appConfig.footer.layout[e],e),this.appConfig=this.appConfig.setIn(["footer","layout"],this.appConfig.footer.layout.without(e)),this):this}copyLayoutContent(e,t){const i=this.appConfig.layouts[e];return i?(this.appConfig=this.appConfig.setIn(["layouts",t],i.set("id",t)),this):this}createLayoutForSizeModeForPageBody(e,t,i){if(!this.appConfig.pages[i])return this;const o=this.appConfig.pages[i],s=this.createLayoutForSizeModeForOneLayout(e,t,o.layout);return s&&(this.appConfig=this.appConfig.setIn(["pages",i,"layout",e],s.id).setIn(["layouts",s.id,"parent"],{id:i,type:a.LayoutParentType.Page}),this.buildLayoutStructure(s.id,e,!0)),this}removeSizeModeLayoutFromPageBody(e,t){if(!this.appConfig.pages[e]||!this.appConfig.pages[e].layout)return this;const i=this.appConfig.pages[e];return this.removeSizeModeLayout(i.layout[t],t),this.appConfig=this.appConfig.setIn(["pages",e,"layout"],i.layout.without(t)),this}createLayoutForSizeModeForDialog(e,t,i){if(!this.appConfig.dialogs[i])return this;const o=this.appConfig.dialogs[i],s=this.createLayoutForSizeModeForOneLayout(e,t,o.layout);return s&&(this.appConfig=this.appConfig.setIn(["dialogs",i,"layout",e],s.id).setIn(["dialogs",i,"sizeMode",e],o.sizeMode.LARGE).setIn(["layouts",s.id,"parent"],{id:i,type:a.LayoutParentType.Dialog}),this.buildLayoutStructure(s.id,e,!0)),this}removeSizeModeLayoutFromDialog(e,t){if(!this.appConfig.dialogs[e]||!this.appConfig.dialogs[e].layout)return this;const i=this.appConfig.dialogs[e];return this.removeSizeModeLayout(i.layout[t],t),this.appConfig=this.appConfig.setIn(["dialogs",e,"layout"],i.layout.without(t)).setIn(["dialogs",e,"sizeMode"],i.sizeMode.without(t)),this}createLayoutForSizeModeForOneLayout(e,t,i){if(!i||!i[t]||i[e])return;let o=this.duplicateLayout(i[t],!1);o=this.transformLayout(o,t,e);const s=L.searchUtils.getContentsInLayout(this.appConfig.layouts[o.id],a.LayoutItemType.Widget),n=L.searchUtils.getContentsInLayout(this.appConfig.layouts[o.id],a.LayoutItemType.Section),r=L.searchUtils.getContentsInLayout(this.appConfig.layouts[o.id],a.LayoutItemType.ScreenGroup);return s.filter((e=>this.appConfig.widgets&&this.appConfig.widgets[e]&&this.appConfig.widgets[e].manifest.properties.hasEmbeddedLayout)).forEach((i=>{var o;Object.keys(null!==(o=this.appConfig.widgets[i].layouts)&&void 0!==o?o:{}).forEach((o=>{const s=this.createLayoutForSizeModeForOneLayout(e,t,this.appConfig.widgets[i].layouts[o]);s&&(this.appConfig=this.appConfig.setIn(["widgets",i,"layouts",o,e],s.id))}))})),s.filter((e=>this.appConfig.widgets&&this.appConfig.widgets[e]&&this.appConfig.widgets[e].manifest.widgetType===a.WidgetType.Layout)).forEach((i=>{const s=P(this.appConfig,"widget");let n=this.appConfig.widgets[i].set("id",s);this.appConfig=this.appConfig.setIn(["widgets",s],n);let r=L.searchUtils.getContentLayoutItem(o,i,a.LayoutItemType.Widget);r=r.set("widgetId",s),o=o.setIn(["content",r.id],r),Object.keys(n.layouts).forEach((i=>{const o=this.createLayoutForSizeModeForOneLayout(e,t,n.layouts[i]);o&&(n=n.setIn(["layouts",i],n.layouts[i].without(t).set(e,o.id)))})),this.appConfig=this.appConfig.setIn(["widgets",s],n)})),n.forEach((i=>{this.appConfig.sections[i]&&this.appConfig.sections[i].views.forEach((i=>{if(this.appConfig.views[i]&&this.appConfig.views[i].layout[t]){const o=this.createLayoutForSizeModeForOneLayout(e,t,this.appConfig.views[i].layout);o&&(this.appConfig=this.appConfig.setIn(["views",i,"layout",e],o.id))}}))})),r.forEach((i=>{this.appConfig.screenGroups[i]&&this.appConfig.screenGroups[i].screens.forEach((i=>{var o,s,n;const a=this.appConfig.screens[i];if(null===(s=null===(o=a.panel)||void 0===o?void 0:o.layout)||void 0===s?void 0:s[t]){const o=this.createLayoutForSizeModeForOneLayout(e,t,a.panel.layout);o&&(this.appConfig=this.appConfig.setIn(["screens",i,"panel","layout",e],o.id))}if(null===(n=a.main.layout)||void 0===n?void 0:n[t]){const o=this.createLayoutForSizeModeForOneLayout(e,t,a.main.layout);o&&(this.appConfig=this.appConfig.setIn(["screens",i,"main","layout",e],o.id))}}))})),this.appConfig=this.appConfig.setIn(["layouts",o.id],o),o}removeSizeModeLayout(e,t){const i=L.searchUtils.getContentsInLayoutRecursive(this.appConfig,e,a.LayoutItemType.Widget,t,!0),o=L.searchUtils.getContentsInLayoutRecursive(this.appConfig,e,a.LayoutItemType.Section,t,!0),s=L.searchUtils.getContentsInLayoutRecursive(this.appConfig,e,a.LayoutItemType.ScreenGroup,t,!0);return i.forEach((e=>{const i=this.appConfig.widgets[e];(null==i?void 0:i.layouts)&&Object.keys(i.layouts).forEach((o=>{i.layouts[o][t]&&(this.removeLayout(i.layouts[o][t],!0),this.appConfig.widgets[e]&&(this.appConfig=this.appConfig.setIn(["widgets",e,"layouts",o],i.layouts[o].without(t))))}))})),o.forEach((e=>{var i;const o=this.appConfig.sections[e];(null===(i=null==o?void 0:o.views)||void 0===i?void 0:i.length)>0&&o.views.forEach((e=>{const i=this.appConfig.views[e];i&&i.layout[t]&&(this.removeLayout(i.layout[t],!0),this.appConfig=this.appConfig.setIn(["views",e,"layout"],i.layout.without(t)))}))})),s.forEach((e=>{var i;const o=this.appConfig.screenGroups[e];(null===(i=null==o?void 0:o.screens)||void 0===i?void 0:i.length)>0&&o.screens.forEach((e=>{var i,o,s,n;const a=this.appConfig.screens[e];(null===(o=null===(i=null==a?void 0:a.panel)||void 0===i?void 0:i.layout)||void 0===o?void 0:o[t])&&(this.removeLayout(a.panel.layout[t],!0),this.appConfig=this.appConfig.setIn(["screens",e,"panel","layout"],a.panel.layout.without(t))),(null===(n=null===(s=null==a?void 0:a.main)||void 0===s?void 0:s.layout)||void 0===n?void 0:n[t])&&(this.removeLayout(a.main.layout[t],!0),this.appConfig=this.appConfig.setIn(["screens",e,"main","layout"],a.main.layout.without(t)))}))})),this.removeLayout(e,!0),this}createEmptyLayoutForWidgetOnCurrentSizeMode(e,t,i,o){let s=this.createEmptyLayoutJson(this.appConfig);return s=s.set("label",i),o&&(s=s.set("type",o)),this.appConfig=this.appConfig.setIn(["layouts",s.id],s).setIn(["widgets",e,"layouts",t,Ne()],s.id),s.id}removeLayoutFromWidget(e,t){var i,o,s;return(null===(i=this.appConfig.widgets[e])||void 0===i?void 0:i.layouts)&&(null===(o=this.appConfig.widgets[e])||void 0===o?void 0:o.layouts[t])?(Object.keys(null===(s=this.appConfig.widgets[e])||void 0===s?void 0:s.layouts[t]).forEach((i=>{var o;const s=null===(o=this.appConfig.widgets[e])||void 0===o?void 0:o.layouts[t][i];this.removeLayout(s,!0)})),this.appConfig=this.appConfig.setIn(["widgets",e,"layouts"],this.appConfig.widgets[e].layouts.without(t)),this):this}addItemIntoLayout(e,t,i,o){var s,n,r,p,l;const d=this.appConfig.layouts[e],u=[].concat(d.order||[]);i>=0&&i<=u.length?u.splice(i,0,t.id):u.push(t.id),this.updateLayout(e,"order",u),this.appConfig=this.appConfig.setIn(["layouts",e,"content",t.id],t),o=o||this.appConfig.mainSizeMode,t.type===a.LayoutItemType.Widget&&this.updateWidgetDataSourceBeforeChangingLayout(t.widgetId,e);const c={layoutId:e,layoutItemId:t.id},g=Ne();return t.type===a.LayoutItemType.Widget&&this.appConfig.widgets[t.widgetId]?(this.appConfig=this.appConfig.setIn(["widgets",t.widgetId,"parent",g],[c]),Object.keys(null!==(n=null===(s=this.appConfig.widgets[t.widgetId])||void 0===s?void 0:s.layouts)&&void 0!==n?n:{}).forEach((e=>{const i=this.createLayoutForSizeModeForOneLayout(g,o,this.appConfig.widgets[t.widgetId].layouts[e]);i&&(this.appConfig=this.appConfig.setIn(["widgets",t.widgetId,"layouts",e,g],i.id),this.clearLayoutStructure(i.id,g,!0),this.buildLayoutStructure(i.id,g,!0))}))):t.type===a.LayoutItemType.Section&&this.appConfig.sections[t.sectionId]?(this.appConfig=this.appConfig.setIn(["sections",t.sectionId,"parent",g],[c]),null===(r=this.appConfig.sections[t.sectionId])||void 0===r||r.views.forEach((e=>{this.appConfig=this.appConfig.setIn(["views",e,"parent"],t.sectionId);const i=this.createLayoutForSizeModeForOneLayout(g,o,this.appConfig.views[e].layout);i&&(this.appConfig=this.appConfig.setIn(["views",e,"layout",g],i.id),this.clearLayoutStructure(i.id,g,!0),this.buildLayoutStructure(i.id,g,!0))}))):t.type===a.LayoutItemType.ScreenGroup&&(null===(p=this.appConfig.screenGroups)||void 0===p?void 0:p[t.screenGroupId])&&(this.appConfig=this.appConfig.setIn(["screenGroups",t.screenGroupId,"parent",g],c),null===(l=this.appConfig.screenGroups[t.screenGroupId])||void 0===l||l.screens.forEach((e=>{const i=this.appConfig.screens[e];this.appConfig=this.appConfig.setIn(["screens",e,"parent"],t.screenGroupId);const s=this.createLayoutForSizeModeForOneLayout(g,o,i.main.layout);if(s&&(this.appConfig=this.appConfig.setIn(["screens",e,"main","layout",g],s.id),this.clearLayoutStructure(s.id,g,!0),this.buildLayoutStructure(s.id,g,!0)),i.panel){const t=this.createLayoutForSizeModeForOneLayout(g,o,i.panel.layout);t&&(this.appConfig=this.appConfig.setIn(["screens",e,"panel","layout",g],t.id),this.clearLayoutStructure(t.id,g,!0),this.buildLayoutStructure(t.id,g,!0))}}))),c}moveLayoutItemToAnotherLayout(e,t,i,o){var s,n;const{layoutId:r}=e;(0,a.invariant)(r!==t.layoutId,"move item to another layout should have different layoutId");const p=L.searchUtils.findLayoutItem(this.appConfig,e);if(!p)return e;const l=this.appConfig.layouts[t.layoutId];p.type===a.LayoutItemType.Widget&&p.widgetId&&this.updateWidgetDataSourceBeforeChangingLayout(p.widgetId,t.layoutId);let d=this.appConfig.layouts;if(this.clearParentOfContent(e,!1),p.type===a.LayoutItemType.Widget||p.type===a.LayoutItemType.Section){const t=L.searchUtils.getWidgetIdThatUseTheLayoutId(this.appConfig,e.layoutId);if(t){const i=L.searchUtils.getBrowserSizeModeByLayoutIdAndWidgetId(this.appConfig,e.layoutId,t);L.searchUtils.getRelatedLayoutInfosInWidgetByLayoutInfo(this.appConfig,e,t,i).forEach((e=>{d=A(e,!0,d)})),this.appConfig=this.appConfig.set("layouts",d)}else this.appConfig=this.appConfig.set("layouts",A(e,!0,d))}else this.appConfig=this.appConfig.set("layouts",A(e,!0,d));const u=function(e,t){const i=L.utils.getMaximumId(t[e])+1;let o=(0,a.Immutable)(t);const s={id:`${i}`};return o=o.setIn([e,"content",s.id],s),{layoutInfo:{layoutId:e,layoutItemId:s.id},layouts:o}}(t.layoutId,this.appConfig.layouts),c=u.layoutInfo;this.appConfig=this.appConfig.set("layouts",u.layouts),this.updateLayoutItem(c,"type",p.type).updateLayoutItem(c,"setting",{style:{transform:null===(n=null===(s=p.setting)||void 0===s?void 0:s.style)||void 0===n?void 0:n.transform}}).updateLayoutItem(c,"bbox",i);const g=[].concat(l.order||[]);return o>=0&&o<=g.length?g.splice(o,0,c.layoutItemId):g.push(c.layoutItemId),this.updateLayout(t.layoutId,"order",g),p.type===a.LayoutItemType.Widget?this.updateLayoutItem(c,"widgetId",p.widgetId):p.type===a.LayoutItemType.Section&&this.updateLayoutItem(c,"sectionId",p.sectionId),this.setParentOfContent(c,!1),c}setLayoutItemToPending(e,t){return L.searchUtils.findLayoutItem(this.appConfig,e)?(this.appConfig=this.appConfig.setIn(["layouts",e.layoutId,"content",e.layoutItemId,"isPending"],t),this):this}clearParentOfContent(e,t,i){var o,s,n;const{layoutId:r,layoutItemId:p}=e;let l=i;if(l||(l=T(this.appConfig,r)),null==l)return;const d=this.appConfig.layouts[r].content[p];switch(d.type){case a.LayoutItemType.Widget:{const e=this.appConfig.widgets[d.widgetId];if(null===(o=null==e?void 0:e.parent)||void 0===o?void 0:o[l]){const t=e.parent[l].filter((e=>e.layoutId!==r||e.layoutItemId!==p));t.length>0?this.appConfig=this.appConfig.setIn(["widgets",d.widgetId,"parent",l],t):this.appConfig=this.appConfig.setIn(["widgets",d.widgetId,"parent"],e.parent.without(l))}t&&(null==e?void 0:e.layouts)&&Object.values(e.layouts).forEach((e=>{this.appConfig=this.appConfig.setIn(["layouts",e[l],"parent"],null),this.clearLayoutStructure(e[l],l,!0)}));break}case a.LayoutItemType.Section:{const e=this.appConfig.sections[d.sectionId];if(null===(s=e.parent)||void 0===s?void 0:s[l]){const t=e.parent[l].filter((e=>e.layoutId!==r||e.layoutItemId!==p));t.length>0?this.appConfig=this.appConfig.setIn(["sections",d.sectionId,"parent",l],t):this.appConfig=this.appConfig.setIn(["sections",d.sectionId,"parent"],e.parent.without(l))}t&&e.views.forEach((e=>{const t=this.appConfig.views[e];this.appConfig=this.appConfig.setIn(["views",e,"parent"],null),this.appConfig=this.appConfig.setIn(["layouts",t.layout[l],"parent"],null),this.clearLayoutStructure(t.layout[l],l,!0)}));break}case a.LayoutItemType.ScreenGroup:{const e=this.appConfig.screenGroups[d.screenGroupId];(null===(n=e.parent)||void 0===n?void 0:n[l])&&(this.appConfig=this.appConfig.setIn(["screenGroups",d.screenGroupId,"parent"],e.parent.without(l))),t&&e.screens.forEach((e=>{var t;const i=this.appConfig.screens[e];this.appConfig=this.appConfig.setIn(["screens",e,"parent"],null),this.appConfig=this.appConfig.setIn(["layouts",i.main.layout[l],"parent"],null),this.clearLayoutStructure(i.main.layout[l],l,!0),(null===(t=i.panel)||void 0===t?void 0:t.layout)&&(this.appConfig=this.appConfig.setIn(["layouts",i.panel.layout[l],"parent"],null),this.clearLayoutStructure(i.panel.layout[l],l,!0))}));break}}}setParentOfContent(e,t,i){var o,s,n,r;const{layoutId:p,layoutItemId:l}=e;let d=i;if(d||(d=T(this.appConfig,p)),null==d)return;const u=this.appConfig.layouts[p],c=u.content[l];switch(c.type){case a.LayoutItemType.Widget:{const i=this.appConfig.widgets[c.widgetId];if((null===(s=null===(o=null==i?void 0:i.parent)||void 0===o?void 0:o[d])||void 0===s?void 0:s.length)>0){const t=i.parent[d].filter((e=>{var t,i;const o=this.appConfig.layouts[e.layoutId];return(null===(t=o.parent)||void 0===t?void 0:t.id)===(null===(i=u.parent)||void 0===i?void 0:i.id)&&o.parent.type===u.parent.type}));if(this.appConfig=this.appConfig.setIn(["widgets",c.widgetId,"parent",d],t),!t.some((e=>e.layoutId===p&&e.layoutItemId===l))){const i=[].concat(t);i.push(e),this.appConfig=this.appConfig.setIn(["widgets",c.widgetId,"parent",d],i)}}else c.widgetId&&(this.appConfig=this.appConfig.setIn(["widgets",c.widgetId,"parent",d],[e]));t&&(null==i?void 0:i.layouts)&&Object.values(i.layouts).forEach((e=>{e[d]&&(this.appConfig=this.appConfig.setIn(["layouts",e[d],"parent"],{id:c.widgetId,type:a.LayoutParentType.Widget}),this.buildLayoutStructure(e[d],d,!0))}));break}case a.LayoutItemType.Section:{const i=this.appConfig.sections[c.sectionId];if((null===(r=null===(n=i.parent)||void 0===n?void 0:n[d])||void 0===r?void 0:r.length)>0){const t=i.parent[d].filter((e=>{var t,i;const o=this.appConfig.layouts[e.layoutId];return(null===(t=o.parent)||void 0===t?void 0:t.id)===(null===(i=u.parent)||void 0===i?void 0:i.id)&&o.parent.type===u.parent.type}));if(this.appConfig=this.appConfig.setIn(["sections",c.sectionId,"parent",d],t),!i.parent[d].some((e=>e.layoutId===p&&e.layoutItemId===l))){const t=[].concat(i.parent[d]);t.push(e),this.appConfig=this.appConfig.setIn(["sections",c.sectionId,"parent",d],t)}}else this.appConfig=this.appConfig.setIn(["sections",c.sectionId,"parent",d],[e]);t&&i.views.forEach((e=>{const t=this.appConfig.views[e];this.appConfig=this.appConfig.setIn(["views",e,"parent"],c.sectionId),t.layout[d]&&(this.appConfig=this.appConfig.setIn(["layouts",t.layout[d],"parent"],{id:t.id,type:a.LayoutParentType.View}),this.buildLayoutStructure(t.layout[d],d,!0))}));break}case a.LayoutItemType.ScreenGroup:this.appConfig=this.appConfig.setIn(["screenGroups",c.screenGroupId,"parent",d],e),t&&this.appConfig.screenGroups[c.screenGroupId].screens.forEach((e=>{var t,i;const o=this.appConfig.screens[e];this.appConfig=this.appConfig.setIn(["screens",e,"parent"],c.screenGroupId),o.main.layout[d]&&(this.appConfig=this.appConfig.setIn(["layouts",o.main.layout[d],"parent"],{id:o.id,type:a.LayoutParentType.Screen}),this.buildLayoutStructure(o.main.layout[d],d,!0)),(null===(i=null===(t=o.panel)||void 0===t?void 0:t.layout)||void 0===i?void 0:i[d])&&(this.appConfig=this.appConfig.setIn(["layouts",o.panel.layout[d],"parent"],{id:o.id,type:a.LayoutParentType.Screen}),this.buildLayoutStructure(o.panel.layout[d],d,!0))}))}}clearLayoutStructure(e,t,i){var o;const s=this.appConfig.layouts[e];Object.keys(null!==(o=null==s?void 0:s.content)&&void 0!==o?o:{}).forEach((o=>{const s={layoutId:e,layoutItemId:o};this.clearParentOfContent(s,i,t)}))}buildLayoutStructure(e,t,i){var o;const s=this.appConfig.layouts[e];Object.keys(null!==(o=null==s?void 0:s.content)&&void 0!==o?o:{}).forEach((o=>{const s={layoutId:e,layoutItemId:o};this.setParentOfContent(s,i,t)}))}duplicateLayoutItem(e,t,i,o,s=!1,n=!1){var r,p,l;if(!this.appConfig.layouts||!this.appConfig.layouts[e])return null;if(!this.appConfig.layouts||!this.appConfig.layouts[t])return null;const d=L.searchUtils.findLayoutItem(this.appConfig,{layoutId:e,layoutItemId:i}),u=n?i:L.utils.getMaximumId(this.appConfig.layouts[t])+1+"";let c=d.set("id",u);if(this.appConfig.layouts[e].type!==a.LayoutType.GridLayout){let o=this.appConfig.layouts[t].order;o||(o=s?this.appConfig.layouts[e].order.filter((t=>!this.appConfig.layouts[e].content[t].isPending)):(0,a.Immutable)([]));const r=[].concat(o);if(s){if(!n){o=this.appConfig.layouts[e].order.filter((t=>!this.appConfig.layouts[e].content[t].isPending));const t=o.findIndex((e=>e===i));r.splice(t,1,c.id)}}else r.push(c.id);this.updateLayout(t,"order",r)}if(this.appConfig=this.appConfig.setIn(["layouts",t,"content",c.id],c),!o)return{layoutId:t,layoutItemId:c.id};const g=d.widgetId||d.sectionId||d.screenGroupId,h=!this.duplicatedContentMaps[g];if(d.type===a.LayoutItemType.Widget&&d.widgetId){if(h){const e=this.duplicateWidget(d.widgetId);c=c.set("widgetId",e.id),this.duplicatedContentMaps[d.widgetId]=e.id}else c=c.set("widgetId",this.duplicatedContentMaps[d.widgetId]);const t=this.appConfig.widgets[c.widgetId];Object.keys(null!==(r=t.parent)&&void 0!==r?r:{}).forEach((o=>{const s=t.parent[o].filter((t=>t.layoutId!==e||t.layoutItemId!==i));s.length>0?this.appConfig=this.appConfig.setIn(["widgets",c.widgetId,"parent",o],s):this.appConfig=this.appConfig.setIn(["widgets",c.widgetId,"parent"],t.parent.without(o))}))}else if(d.type===a.LayoutItemType.Section&&d.sectionId){if(h){const e=this.duplicateSection(d.sectionId);c=c.set("sectionId",e.id),this.duplicatedContentMaps[d.sectionId]=e.id}else c=c.set("sectionId",this.duplicatedContentMaps[d.sectionId]);const t=this.appConfig.sections[c.sectionId];Object.keys(null!==(p=t.parent)&&void 0!==p?p:{}).forEach((o=>{const s=t.parent[o].filter((t=>t.layoutId!==e||t.layoutItemId!==i));s.length>0?this.appConfig=this.appConfig.setIn(["sections",c.sectionId,"parent",o],s):this.appConfig=this.appConfig.setIn(["sections",c.sectionId,"parent"],t.parent.without(o))}))}else if(d.type===a.LayoutItemType.ScreenGroup&&d.screenGroupId){if(h){const e=this.duplicateScreenGroup(d.screenGroupId);c=c.set("screenGroupId",e.id),this.duplicatedContentMaps[d.screenGroupId]=e.id}else c=c.set("screenGroupId",this.duplicatedContentMaps[d.screenGroupId]);const t=this.appConfig.screenGroups[c.screenGroupId];Object.keys(null!==(l=t.parent)&&void 0!==l?l:{}).forEach((o=>{t.parent[o].layoutId===e&&t.parent[o].layoutItemId===i&&(this.appConfig=this.appConfig.setIn(["screenGroups",c.screenGroupId,"parent"],t.parent.without(o)))}))}return this.appConfig=this.appConfig.setIn(["layouts",t,"content",c.id],c),{layoutId:t,layoutItemId:c.id}}removeLayoutItem(e,t,i=!1){const o=L.searchUtils.findLayoutItem(this.appConfig,e);if(!o)return this;const s=this.appConfig.layouts[e.layoutId];if(s.type===a.LayoutType.GridLayout){const t=this.detachGridItem(s,e.layoutItemId);this.appConfig=this.appConfig.setIn(["layouts",e.layoutId],t)}t&&this.checkWhetherRemoveContent(e)?o.type===a.LayoutItemType.Widget?this.removeWidget(o.widgetId):o.type===a.LayoutItemType.Section?this.removeSection(o.sectionId):o.type===a.LayoutItemType.ScreenGroup&&this.removeScreenGroup(o.screenGroupId):this.clearParentOfContent(e,!1);const n=A(e,!0,this.appConfig.layouts);return this.appConfig=this.appConfig.set("layouts",n),this.clearRedundantLayout(e)}checkWhetherRemoveContent(e){const t=L.searchUtils.findLayoutItem(this.appConfig,e);if(!t)return!1;let i;return t.type===a.LayoutItemType.Widget?i=t.widgetId:t.type===a.LayoutItemType.Section?i=t.sectionId:t.type===a.LayoutItemType.ScreenGroup&&(i=t.screenGroupId),!(L.searchUtils.getLayoutInfosHoldcontent(this.appConfig,t.type,i).length>1)}clearRedundantLayout(e){return this.clearEmptyRowInFlowLayout(e),this.clearMaintainedColumnInRowWidget(e),this}removeLayout(e,t){return this.appConfig.layouts[e]?(L.searchUtils.getLayoutItemIds(this.appConfig,e,!0).forEach((i=>{const o={layoutId:e,layoutItemId:i};this.removeLayoutItem(o,t,!0)})),this.appConfig=this.appConfig.set("layouts",this.appConfig.layouts.without(e)),this):this}replaceLayout(e,t){const i=this.appConfig.layouts;return this.appConfig=this.appConfig.set("layouts",i.set(e,i[t]).setIn([e,"id"],e).without(t)),this}resetLayout(e,t){return this.appConfig.layouts[e]?(L.searchUtils.getLayoutItemIds(this.appConfig,e,!0).forEach((i=>{const o={layoutId:e,layoutItemId:i};this.removeLayoutItem(o,t,!0)})),this):this}duplicateLayoutItems(e,t,i){var o;const s=this.appConfig.layouts[e];if(!s)return this;const n=Object.keys(null!==(o=s.content)&&void 0!==o?o:{}),r=[],p=[];return n.forEach((e=>{var t;const i=s.content[e];i.type===a.LayoutItemType.Widget&&(null===(t=this.appConfig.widgets[i.widgetId])||void 0===t?void 0:t.manifest.properties.canCreateMapView)?r.push(e):p.push(e)})),r.forEach((e=>{s.content[e].isPending||this.duplicateLayoutItem(s.id,t,e,i,!0,!0)})),p.forEach((e=>{s.content[e].isPending||this.duplicateLayoutItem(s.id,t,e,i,!0,!0)})),this}duplicateLayout(e,t){const i=this.appConfig.layouts[e];if(!i)return null;const o=i.set("id",P(this.appConfig,"layout"));return this.appConfig=this.appConfig.setIn(["layouts",o.id],o.without("content","order")),i.content&&this.duplicateLayoutItems(e,o.id,t),this.appConfig.layouts[o.id]}detachGridItem(e,t){const i=e.content[t],{parent:o}=i;if(!o)return e;let s=e.setIn(["content",t],i.without("parent"));const n=e.content[o];if(!n||null==(null==n?void 0:n.children))return e;const a=n.children.indexOf(t),r=n.children.filter((e=>e!==t));if(1===r.length){const t=r[0];if(s=s.setIn(["content",t,"bbox","width"],n.bbox.width),null!=n.parent){s=s.setIn(["content",t,"parent"],n.parent);const i=e.content[n.parent];if(i){const e=[...i.children],a=e.indexOf(o);e.splice(a,1,t),s=s.setIn(["content",n.parent,"children"],e)}}else s=s.setIn(["content",t],s.content[t].without("parent")),s=s.setIn(["setting","rootItem"],t);s=s.set("content",s.content.without(o))}else{if(a<r.length){const e=s.content[r[a]];s=s.setIn(["content",r[a],"bbox","width"],e.bbox.width+i.bbox.width)}else{const e=s.content[r[r.length-1]];s=s.setIn(["content",r[r.length-1],"bbox","width"],e.bbox.width+i.bbox.width)}s=s.setIn(["content",o,"children"],r)}return s}editLayoutSetting(e,t){return t=(this.appConfig.layouts[e.layoutId].setting||(0,a.Immutable)({})).merge(t),this.updateLayout(e.layoutId,"setting",t)}editLayoutType(e,t){return this.updateLayout(e.layoutId,"type",t)}editLayoutLabel(e,t){return this.updateLayout(e.layoutId,"label",t)}editLayoutItemSetting(e,t){if(t){const i=L.searchUtils.findLayoutItem(this.appConfig,e);if(i)return t=(i.setting||(0,a.Immutable)({})).merge(t),this.updateLayoutItem(e,"setting",t)}return this}editLayoutItemSize(e,t,i){var o;if(0===t||0===i)return this;const{layoutId:s,layoutItemId:n}=e,r=this.appConfig.layouts[s],p=null===(o=null==r?void 0:r.content)||void 0===o?void 0:o[n];if(!r||!p)return this;let l=p.setting||(0,a.Immutable)({});if(r.type===a.LayoutType.FixedLayout){const o=p.bbox.set("width",`${t}px`).set("height",`${i}px`);return l=l.setIn(["autoProps","width"],!1).setIn(["autoProps","height"],!1),this.editLayoutItemBBox(e,o).editLayoutItemSetting(e,l)}return l=l.setIn(["autoProps","width"],!1).setIn(["autoProps","height"],!1).set("heightMode","ratio").set("aspectRatio",Number((i/t).toFixed(2))),this.editLayoutItemSetting(e,l)}editLayoutItemBBox(e,t){return this.updateLayoutItem(e,"bbox",t)}exchangeWidthAndHeight(){var e,t,i,o,s;let n;const r=(0,a.getAppStore)().getState();if(n=window.jimuConfig.isBuilder?null===(t=null===(e=null==r?void 0:r.appStateInBuilder)||void 0===e?void 0:e.appRuntimeInfo)||void 0===t?void 0:t.selection:null===(i=null==r?void 0:r.appRuntimeInfo)||void 0===i?void 0:i.selection,!n)return this;const{layoutId:p}=n,l=this.appConfig.layouts[p];if((null==l?void 0:l.type)===a.LayoutType.FixedLayout){const e=L.searchUtils.findLayoutItem(this.appConfig,n);if(e){let t=e.bbox,i=!1,r=null!==(o=e.setting)&&void 0!==o?o:(0,a.Immutable)({});const p=null!==(s=r.autoProps)&&void 0!==s?s:{right:!0,bottom:!0};t=t.set("width",t.height).set("height",t.width),["left","right","top","bottom"].forEach((e=>{p[e]&&(t=t.without(e))})),this.editLayoutItemBBox(n,t),null==p.width&&null==p.height||(r=r.setIn(["autoProps","width"],p.height).setIn(["autoProps","height"],p.width),i=!0),"ratio"===r.heightMode&&(r=r.set("heightMode","fixed"),i=!0),i&&this.editLayoutItemSetting(n,r)}}return this}updateLayoutItem(e,t,i){if(L.searchUtils.findLayoutItem(this.appConfig,e)){const{layoutId:o,layoutItemId:s}=e;this.appConfig=this.appConfig.setIn(["layouts",o,"content",s,t],i)}return this}editLayoutItemIndex(e,t,i){const{layoutId:o}=e,s=this.appConfig.layouts[o].order;return!s||i<0||i>s.length||this.adjustIndexOfLayoutItem(e,t,i),this}editLayoutOrder(e,t){return this.updateLayout(e.layoutId,"order",t)}addLayout(e){return this.appConfig.layouts&&this.appConfig.layouts[e.id]||(this.appConfig=this.appConfig.setIn(["layouts",e.id],e)),this}copyUseDataSourceToAllChildWidgets(e,t){const i=L.searchUtils.getChildrenContents(this.appConfig,t.id,a.LayoutItemType.Widget,!0),o=t.useDataSources&&t.useDataSources.map((e=>e.without("fields")))[0],s=e.useDataSources&&e.useDataSources.map((e=>e.without("fields")))[0];return o&&s&&o.dataSourceId===s.dataSourceId||i.forEach((e=>{let t=this.appConfig.widgets[e];t.useDataSources&&s&&t.useDataSources.find((e=>e.dataSourceId===s.dataSourceId))&&(t=t.set("useDataSources",t.useDataSources.filter((e=>e.dataSourceId!==s.dataSourceId)))),o&&(t=t.set("useDataSources",t.useDataSources?t.useDataSources.concat(o):[o]).set("useDataSourcesEnabled",!0)),this.appConfig=this.appConfig.setIn(["widgets",e],t)})),this}clearEmptyRowInFlowLayout(e){var t,i,o;const s=this.appConfig.layouts[e.layoutId];if((null!==(i=null===(t=null==s?void 0:s.order)||void 0===t?void 0:t.length)&&void 0!==i?i:0)>0)return this;const n=L.searchUtils.getWidgetIdThatUseTheLayoutId(this.appConfig,e.layoutId);if(n){const e=this.appConfig.widgets[n];if("row"===(null===(o=null==e?void 0:e.manifest)||void 0===o?void 0:o.name)){let e;Object.keys(this.appConfig.layouts).some((t=>{var i,o;if((null===(o=null===(i=this.appConfig.layouts)||void 0===i?void 0:i[t])||void 0===o?void 0:o.type)===a.LayoutType.FlowLayout){const i=L.searchUtils.getContentLayoutItem(this.appConfig.layouts[t],n,a.LayoutItemType.Widget);if(i)return e={layoutId:t,layoutItemId:i.id},!0}})),e&&this.removeLayoutItem(e,!0)}}return this}clearMaintainedColumnInRowWidget(e){var t,i,o,s;const n=this.appConfig.layouts[e.layoutId],r=null!==(i=null===(t=null==n?void 0:n.order)||void 0===t?void 0:t.length)&&void 0!==i?i:0;if(r>1)return this;const p=L.searchUtils.getWidgetIdThatUseTheLayoutId(this.appConfig,e.layoutId);if(p){const t=this.appConfig.widgets[p];if("column"===(null===(o=null==t?void 0:t.manifest)||void 0===o?void 0:o.name)){const t=L.searchUtils.getLayoutInfosHoldcontent(this.appConfig,a.LayoutItemType.Widget,p);if(t&&t.length>0){const i=t[0];if(!this.appConfig.layouts[i.layoutId])return this;const o=this.appConfig.layouts[i.layoutId].content[i.layoutItemId];if((null===(s=null==o?void 0:o.setting)||void 0===s?void 0:s.maintainedByLayout)&&1===r)return this.extractWidgetFromMaintainedColumn(i,p,{layoutId:e.layoutId,layoutItemId:n.order[0]})}}}return this}addDataSource(e){return this.appConfig.dataSources&&this.appConfig.dataSources[e.id]||(this.appConfig=this.appConfig.setIn(["dataSources",e.id],e)),this}addDataSources(e){return e.forEach((e=>{this.appConfig.dataSources&&this.appConfig.dataSources[e.id]||(this.appConfig=this.appConfig.setIn(["dataSources",e.id],e))})),this}addUtility(e){var t;let i=null!==(t=this.appConfig.utilities)&&void 0!==t?t:(0,a.Immutable)({});return i=i.set(e.id,e),this.appConfig=this.appConfig.set("utilities",i),this}removeUtility(e){var t;let i=null!==(t=this.appConfig.utilities)&&void 0!==t?t:(0,a.Immutable)({});return i=i.without(e),this.appConfig=this.appConfig.set("utilities",i),this}updateUtilities(e){return this.appConfig=this.appConfig.set("utilities",e),this}removeUseMapWidgetId(e){return Object.keys(this.appConfig.widgets).forEach((t=>{var i;const o=this.appConfig.widgets[t];if(null===(i=o.useMapWidgetIds)||void 0===i?void 0:i.includes(e)){const i=o.useMapWidgetIds.filter((t=>t!==e));this.appConfig=this.appConfig.setIn(["widgets",t,"useMapWidgetIds"],i)}})),this.appConfig}removeDataSource(e){return this.appConfig.dataSources&&this.appConfig.dataSources[e]?(this.appConfig=this.appConfig.set("dataSources",this.appConfig.dataSources.without(e)),this.appConfig.widgets&&Object.entries(this.appConfig.widgets).forEach((([t,i])=>{i.useDataSources&&i.useDataSources.find((t=>this.isUseDataSourceShouldBeRemoved(t,e)))&&(this.appConfig=this.appConfig.setIn(["widgets",t,"useDataSources"],i.useDataSources.filter((t=>!this.isUseDataSourceShouldBeRemoved(t,e)))))})),this.appConfig.widgets&&Object.entries(this.appConfig.widgets).forEach((([t,i])=>{i.outputDataSources&&i.outputDataSources.find((t=>t===e))&&(this.appConfig=this.appConfig.setIn(["widgets",t,"outputDataSources"],i.outputDataSources.filter((t=>t!==e))))})),this.appConfig.messageConfigs&&Object.keys(this.appConfig.messageConfigs).forEach((t=>{var i;const o=null===(i=this.appConfig.messageConfigs[t].actions)||void 0===i?void 0:i.asMutable({deep:!0});null==o||o.forEach(((i,s)=>{var n;(null===(n=null==i?void 0:i.useDataSources)||void 0===n?void 0:n.find((t=>this.isUseDataSourceShouldBeRemoved(t,e))))&&(o[s].useDataSources=i.useDataSources.filter((t=>!this.isUseDataSourceShouldBeRemoved(t,e))),this.appConfig=this.appConfig.setIn(["messageConfigs",t,"actions"],o))}))})),Object.entries(this.appConfig.dataSources).forEach((([t,i])=>{i.originDataSources&&i.originDataSources.find((t=>this.isUseDataSourceShouldBeRemoved(t,e)))&&this.removeDataSource(t)})),this):this}isUseDataSourceShouldBeRemoved(e,t){return!e||e.dataSourceId===t||e.mainDataSourceId===t||e.rootDataSourceId===t}editDataSource(e){return this.appConfig=this.appConfig.setIn(["dataSources",e.id],e),this}duplicateDataSource(e){if(!this.appConfig.dataSources||!this.appConfig.dataSources[e])return null;const t=this.appConfig.dataSources[e],i=t.set("id",P(this.appConfig,"dataSource")).set("label",this.getDuplicateLabel("dataSource",t.label));return this.addDataSource(i),i}addAppProxy(e){return this.appConfig.appProxies&&this.appConfig.appProxies[e.id]||(this.appConfig=this.appConfig.setIn(["appProxies",e.id],e)),this}editAppProxy(e){return this.appConfig=this.appConfig.setIn(["appProxies",e.id],e),this}removeAppProxy(e){return this.appConfig.appProxies&&this.appConfig.appProxies[e]?(this.appConfig=this.appConfig.set("appProxies",this.appConfig.appProxies.without(e)),this):this}addMessage(e){return this.appConfig=this.appConfig.setIn(["messageConfigs",e.id],e),this}editMessage(e){return this.appConfig=this.appConfig.setIn(["messageConfigs",e.id],e),this}removeMessage(e){return this.appConfig.messageConfigs&&this.appConfig.messageConfigs[e.id]?(this.appConfig=this.appConfig.set("messageConfigs",this.appConfig.messageConfigs.without(e.id)),this):this}duplicateWidgetMessageConfig(e,t){const i=this.appConfig.messageConfigs;if(!i)return this;Object.keys(i).forEach((o=>{if(i[o].widgetId===e){const e=i[o].set("id",P(this.appConfig,"messageConfig")).set("widgetId",t);this.appConfig=this.appConfig.setIn(["messageConfigs",e.id],e)}})),Object.keys(i).forEach((o=>{if(i[o].actions){const s=[];i[o].actions.forEach((i=>{if(i.widgetId===e){const e=i.set("widgetId",t);s.push(e)}})),s.length>0&&(this.appConfig=this.appConfig.setIn(["messageConfigs",i[o].id,"actions"],i[o].actions.concat(s)))}}))}removeDataActionProvidedByWidget(e,t){var i;const o=e.widgets[t];if(!(null===(i=o.manifest)||void 0===i?void 0:i.dataActions)||0===o.manifest.dataActions.length)return e;const s=o.manifest.dataActions.map((e=>e.name));let n=e;return Object.keys(e.widgets).forEach((i=>{let o=e.widgets[i];o.dataActions&&s.forEach((e=>{var s,a;const r=null===(s=o.dataActions)||void 0===s?void 0:s[e];if(r){const s=null===(a=r.actions)||void 0===a?void 0:a.without(t);0===Object.keys(s||{}).length?(o=o.set("dataActions",o.dataActions.without(e)),0===Object.keys(o.dataActions).length&&(o=o.without("dataActions"))):o=o.setIn(["dataActions","actions"],s),n=n.setIn(["widgets",i],o)}}))})),n}removeWidgetMessageAndAction(e,t){const i=e.messageConfigs;if(!i)return e;const o=Object.keys(i);let s=(0,a.Immutable)({});for(let e=0;e<o.length;e++)i[o[e]].widgetId!==t&&(s=s.setIn([i[o[e]].id],i[o[e]]));const n=Object.keys(s);for(let e=0;e<n.length;e++){const o=s[n[e]].actions;if(0!==o.length){const a=o.filter((e=>e.widgetId!==t)),r=Object.assign([],a);s=s.setIn([i[n[e]].id,"actions"],r)}}return e.set("messageConfigs",s)}editTheme(e){return this.appConfig=this.appConfig.set("theme",e),this}editCustomTheme(e){return this.appConfig=this.appConfig.set("customTheme",e),this}editHeader(e,t){return this.appConfig=this.appConfig.set("header",e),t&&t.forEach((e=>{this.addLayout(e),this.appConfig=this.appConfig.setIn(["layouts",e.id,"parent"],{id:"",type:a.LayoutParentType.Header})})),this}editFooter(e,t){return this.appConfig=this.appConfig.set("footer",e),t&&t.forEach((e=>{this.addLayout(e),this.appConfig=this.appConfig.setIn(["layouts",e.id,"parent"],{id:"",type:a.LayoutParentType.Footer})})),this}setViewportSize(e,t){return this.appConfig=this.appConfig.setIn(["forBuilderAttributes","viewPortSize",e],t),this}setLockLayout(e){return this.appConfig=this.appConfig.setIn(["forBuilderAttributes","lockLayout"],e),this}editAttributes(e){return this.appConfig=this.appConfig.setIn(["attributes"],e),this}mergeUseDataSource(e,t){if(!e.useDataSources)return t;const i=e.useDataSources.map((e=>e.without("fields")));return t.useDataSources?(i.forEach((e=>{e.dataViewId?t.useDataSources.find((t=>t.dataSourceId===e.dataSourceId&&t.dataViewId===e.dataViewId))||(t=t.set("useDataSources",t.useDataSources.concat([e]))):t.useDataSources.find((t=>t.dataSourceId===e.dataSourceId))||(t=t.set("useDataSources",t.useDataSources.concat([e])))})),t.set("useDataSourcesEnabled",!0)):t.set("useDataSources",i).set("useDataSourcesEnabled",!0)}updateWidgetDataSourceBeforeChangingLayout(e,t){if(!this.appConfig.widgets[e])return this;let i=this.appConfig.widgets[e];const o=L.searchUtils.getWidgetIdThatUseTheLayoutId(this.appConfig,t);if(o){const e=this.appConfig.widgets[o];e.manifest.properties.passDataSourceToChildren&&(i=this.mergeUseDataSource(e,i),this.appConfig=this.appConfig.setIn(["widgets",i.id],i))}return this}getDuplicateLabel(e,t){const[i]=M(t);let o=x(this.appConfig,e,i);return o===i&&(o=`${i} 1`),o}extractWidgetFromMaintainedColumn(e,t,i){var o;const s=this.appConfig.layouts[i.layoutId].content[i.layoutItemId],n=this.appConfig.layouts[e.layoutId].content[e.layoutItemId],a=n.bbox;this.editLayoutItemSetting(e,n.setting.set("maintainedByLayout",!1)),this.updateLayoutItem(e,"type",s.type).updateLayoutItem(e,"widgetId",s.widgetId).updateLayoutItem(e,"sectionId",s.sectionId).editLayoutItemBBox(e,a.set("height",s.bbox.height)).editLayoutItemSetting(e,s.setting),this.updateLayoutItem(i,"widgetId",null).updateLayoutItem(i,"sectionId",null),this.clearParentOfContent(e,!1),this.setParentOfContent(e,!1);const r=this.appConfig.widgets[t];return Object.keys(null!==(o=r.parent)&&void 0!==o?o:{}).forEach((i=>{const o=r.parent[i],s=o.filter((t=>t.layoutId!==e.layoutId||t.layoutItemId!==e.layoutItemId));o.length!==s.length&&(this.appConfig=this.appConfig.setIn(["widgets",t,"parent",i],s))})),this.removeWidget(t)}adjustIndexOfLayoutItem(e,t,i){const{layoutId:o}=e;(0,a.invariant)(o===t.layoutId,"adjust index should happened in the same layout");const s=this.appConfig.layouts[o];let n=[].concat(s.order||[]);const r=n.indexOf(e.layoutItemId);return n[r]=null,n.splice(i,0,e.layoutItemId),n=n.filter((e=>null!==e)),this.appConfig=this.appConfig.setIn(["layouts",o,"order"],n),this}createLayoutsForWidget(e,t){return(e.manifest.layouts||[]).forEach((i=>{let o=this.createEmptyLayoutJson(this.appConfig);i.type&&(o=o.set("type",i.type)),o=o.set("label",e.manifest.i18nMessages[`_layout_${i.name}_label`]||i.label),this.appConfig=this.appConfig.setIn(["layouts",o.id],o).setIn(["layouts",o.id,"parent"],{id:e.id,type:a.LayoutParentType.Widget}).setIn(["widgets",e.id,"layouts",i.name,t],o.id)})),this}removePageFromPageStructure(e){return this.appConfig.pageStructure?(this.appConfig.pageStructure.find((t=>!!t[e]))?this.appConfig=this.appConfig.set("pageStructure",this.appConfig.pageStructure.flatMap((t=>t[e]?[]:[t]))):this.appConfig.pageStructure.forEach(((t,i)=>{const o=Object.keys(t).find((i=>t[i].includes(e)));if(o)return this.appConfig=this.appConfig.setIn(["pageStructure",i+"",o],t[o].flatMap((t=>t===e?[]:[t]))),!0})),this):this}doDuplicateContainerContent(e,t){const i=this.getContainerJson(e,t);if(!i.layout)return null;let o=i;return Object.keys(i.layout).forEach((e=>{const t=i.layout[e],s=this.duplicateLayout(t,!0);this.appConfig=this.appConfig.setIn(["layouts",s.id],s),o=o.setIn(["layout",e],s.id)})),o.layout}doDuplicateEmbedWidgetContent(e){let t=e;return e&&e.layouts&&Object.keys(e.layouts).forEach((i=>{const o=e.layouts[i];Object.keys(o).forEach((o=>{const s=this.duplicateLayout(e.layouts[i][o],!0);t=t.setIn(["layouts",i,o],s.id),this.appConfig=this.appConfig.setIn(["layouts",s.id],s)}))})),t}createEmptyLayoutJson(e){const t=P(e,"layout");return(0,a.Immutable)({id:t})}movePageIntoPageForPageStructure(e,t){return this.appConfig.pageStructure?(this.appConfig.pageStructure.some(((i,o)=>{const s=Object.keys(i).find((e=>e===t));if(s)return this.appConfig=this.appConfig.setIn(["pageStructure",o+"",s],this.appConfig.pageStructure[o][s].concat([e])),!0})),this):this}removeContainerContent(e,t){const i=this.getContainerJson(e,t).layout;return Object.keys(i).forEach((o=>{const s=i[o];this.removeLayout(s,!0),e===a.ContainerType.Header?this.appConfig=this.appConfig.setIn(["header","layout"],this.appConfig.header.layout.without(o)):e===a.ContainerType.Footer?this.appConfig=this.appConfig.setIn(["footer","layout"],this.appConfig.footer.layout.without(o)):e===a.ContainerType.ScreenMain?this.appConfig=this.appConfig.setIn(["screens",t,"main","layout"],this.appConfig.screens[t].main.layout.without(o)):e===a.ContainerType.ScreenPanel?this.appConfig=this.appConfig.setIn(["screens",t,"panel","layout"],this.appConfig.screens[t].panel.layout.without(o)):this.appConfig=this.appConfig.setIn([e,t,"layout"],this.appConfig[e][t].layout.without(o))})),this}getContainerJson(e,t){return e===a.ContainerType.Footer||e===a.ContainerType.Header?this.appConfig[e]:e===a.ContainerType.ScreenMain?this.appConfig.screens[t].main:e===a.ContainerType.ScreenPanel?this.appConfig.screens[t].panel:this.appConfig[e][t]}removeSectionContent(e){return this.appConfig.sections[e].views&&this.appConfig.sections[e].views.forEach((e=>{this.removeContainerContent(a.ContainerType.View,e),0===Object.keys(this.appConfig.views[e].layout).length&&(this.appConfig=this.appConfig.set("views",this.appConfig.views.without(e)))})),this}updateLayout(e,t,i){return this.appConfig.layouts[e]&&(this.appConfig=this.appConfig.setIn(["layouts",e,t],i)),this}transformLayout(e,t,i){let o;o=window.jimuConfig.isBuilder?window._appWindow&&window._appWindow._extensionManager:a.ExtensionManager.getInstance();const s=o.getExtensions(a.extensionSpec.ExtensionPoints.LayoutTransformer);if(s.length>0){const o=s.find((t=>t.layoutType===e.type));o&&o.transformLayout&&(e=o.transformLayout(e,t,i))}return e}}const{getTranslatedLocale:Ke}=a.i18n;class Ze{constructor(){this.actionSettings={}}static getInstance(){return Ze.instance||(Ze.instance=new Ze),Ze.instance}loadAllActionSettingClasses(){var e;const t=He();return Object.keys((null===(e=t.appConfig)||void 0===e?void 0:e.widgets)||{}).forEach((e=>{var i,o;const s=t.appConfig.widgets[e],n=[].concat(null===(i=s.manifest)||void 0===i?void 0:i.dataActions,null===(o=s.manifest)||void 0===o?void 0:o.batchDataActions).filter((e=>e));n.length>0&&n.forEach((e=>{if(e.settingUri){const t=`${s.uri}dist/${e.settingUri}`;this.actionSettings[t]||(this.actionSettings[t]=a.moduleLoader.loadModule(t,["default"]).then((e=>{const t=e.default;return S.getInstance().loadI18nMessagesForSetting(s.uri).then((e=>this.injectActionSettingProps(t,e,s.id)))})))}}))})),this.actionSettings}injectActionSettingProps(e,t,i){const o=(0,a.injectIntl)(e),s=(0,a.getAppStore)().getState().appStateInBuilder.appConfig.widgets[i];let n=null;n=i&&s?(0,a.getAppStore)().getState().appStateInBuilder.appConfig.widgets[i].manifest.name:"Framework";class r extends a.React.PureComponent{render(){const e={messages:t},n=(0,a.getAppStore)().getState().appI18nMessages;let r=null;i&&s?(r=Ke((0,a.getAppStore)().getState().appContext.locale,s.manifest.translatedLocales.asMutable()),r||(r=s.manifest.translatedLocales&&s.manifest.translatedLocales[0]),r||(r=(0,a.getAppStore)().getState().appContext.locale)):r=(0,a.getAppStore)().getState().appContext.locale;const p=Object.assign({},t,n);return a.React.createElement(a.IntlProvider,{locale:r,messages:p},a.React.createElement(o,Object.assign({},this.props,e)))}}r.displayName=`ActionSettingWrapper(${n})`;for(const t in e)r[t]||(r[t]=e[t]);return r}}class Je extends a.WidgetManager{static getInstance(){return window.jimuConfig.isBuilder?window._appWindow&&window._appWindow._widgetManager:a.WidgetManager.getInstance()}}const Qe={frameworkAction_TriggerLayer:"Trigger data",frameworkAction_SetData:"Select data",frameworkAction_ActionLayer:"Action data",frameworkAction_Conditions:"Conditions",frameworkAction_RelateMessage:"Trigger / action connection",frameworkAction_TriggerLayerField:"Select a trigger field",frameworkAction_None:"none",frameworkAction_Equals:"equals",frameworkAction_ActionLayerField:"Select an action field",frameworkAction_MoreConditions:"More conditions",frameworkAction_SetExpression:"Please set your expression first.",frameworkAction_ChooseLayer:"Select data",frameworkAction_AutoBind:"Auto bound.",frameworkAction_NoLayer:"No data.",frameworkAction_QueryByExtent:"Query by current extent",defaultTextPlaceholder:"Double click to edit text",titlePlaceholder:"Here is the title",subTitlePlaceholder:"Here is the subtitle",shortTitlePlaceholder:"Title",shortSubTitlePlaceholder:"Subtitle",copyrightPlaceholder:"Copyright info",cardTitle:"Card title",bookmark:"Bookmark",number:"Number",templateSearchResult:"Search result",logo:"Logo",appItemCopy:"Copy"};var Ye=l(513),Xe=l.n(Ye),et=l(786),tt=l.n(et),it=l(179),ot=l.n(it),st=l(982),nt=l.n(st),at=l(543),rt=l.n(at),pt=function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function a(e){try{p(o.next(e))}catch(e){n(e)}}function r(e){try{p(o.throw(e))}catch(e){n(e)}}function p(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};function lt(e,t,i){let o;return o=e.type===a.PageType.Folder?{svg:ot(),properties:{filename:"folder",originalName:"outlined/application/folder.svg",path:["general","folder"],color:"var(--dark-800)",inlineSvg:!0}}:e.type===a.PageType.Link?{svg:tt(),properties:{filename:"link",originalName:"outlined/data/link-tilted.svg",path:["general","link"],color:"var(--dark-800)",inlineSvg:!0}}:{svg:Xe(),properties:{filename:i||(null==t?void 0:t("page"))||"",originalName:"outlined/data/page.svg",color:"var(--dark-800)",inlineSvg:!0}},o}function dt(){return nt()}function ut(){return rt()}function ct(e,t){const i=[];return Object.keys(e).some((o=>{e[o].autoOpenDialogId===t&&i.push({id:o,label:e[o].label})})),i}let gt=null;function ht(){return gt||(gt=fetch(`${a.moduleLoader.resolveModuleFullPath("widgets/")}/widgets-info.json`).then((e=>pt(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>e.map((e=>{var t,i;e.manifest=a.appConfigUtils.addWidgetManifestProperties(e.manifest);const o=a.i18n.findLocale((0,a.getAppStore)().getState().appContext.locale,e.manifest.translatedLocales);return{itemType:a.LayoutItemType.Widget,name:e.name,label:(null===(t=e.i18nLabel)||void 0===t?void 0:t[o])||e.manifest.label||e.name,desription:(null===(i=e.i18nDescription)||void 0===i?void 0:i[o])||e.manifest.desription||e.name,uri:e.uri,manifest:e.manifest,icon:"../"+e.icon,group:e.group,order:e.order}})))).catch((e=>(console.error("Failed to fetch common widget list. ",e),[])))),gt}let ft=null;function yt(){if(!mt())return Promise.resolve([]);if(!ft){const e='type:"Experience Builder Widget" AND typekeywords:"Widget"';ft=a.esri.restPortal.searchItems({q:e,num:100,start:0,authentication:a.SessionManager.getInstance().getSessionByUrl((0,a.getAppStore)().getState().portalUrl)}).then((e=>e.results)).then((e=>{let t=[];return e.forEach(((e,i)=>{if(!e.url)return;const o=function(e){let t;return t=/manifest\.json$/.test(e)?e.substring(0,e.length-"manifest.json".length):/\/$/.test(e)?e:e+"/",t=t.replace(/^http:\/\//,"https://"),t}(e.url),s=a.appConfigUtils.getWidgetContext(o),n={itemType:a.LayoutItemType.Widget,name:e.url,label:e.title,itemId:e.id,manifest:{},icon:`${s.folderUrl}icon.svg`,uri:s.folderUrl,group:Ct,order:i};t=t.concat(n)})),Promise.allSettled(t.map((e=>fetch(`${e.uri}manifest.json`).then((e=>e.json()))))).then((e=>e.map((e=>"fulfilled"===e.status?e.value:null)))).then((e=>t.map(((t,i)=>Object.assign(Object.assign({},t),{manifest:e[i]||{defaultSize:{width:400,height:400}}})))))})).catch((e=>(console.error("Failed to fetch custom widget list. ",e),[])))}return ft}function mt(){var e,t;return null===(t=null===(e=(0,a.getAppStore)().getState().appContext)||void 0===e?void 0:e.jimuConfig)||void 0===t?void 0:t.isInPortal}function It(e){return mt()||(null==e?void 0:e.some((e=>e.group===Ct)))}const Ct=7;var St=function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function a(e){try{p(o.next(e))}catch(e){n(e)}}function r(e){try{p(o.throw(e))}catch(e){n(e)}}function p(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};const vt=l(774),wt=["en","de","es","fr","ja","ru","zh-cn"];function bt(){const e=window.locale.toLowerCase();let t=!1;if(wt.includes(e))t=!0;else{const i=e.split("-")[0];for(let e=0;e<wt.length;e++)if(i===wt[e].split("-")[0]){t=!0;break}}return t}function Lt(e){return St(this,void 0,void 0,(function*(){return yield xt("build-apps",e)}))}function At(){return St(this,void 0,void 0,(function*(){return window.jimuConfig.isDevEdition?yield xt(void 0,"home",!0):yield xt("get-started","what-is-arcgis-experience-builder",!0)}))}function Dt(){return St(this,void 0,void 0,(function*(){return yield xt("get-started","whats-new",!0)}))}function Pt(e){return St(this,void 0,void 0,(function*(){return yield xt("widgets",e)}))}function xt(e,t,i){return St(this,void 0,void 0,(function*(){let o,s=null;if(t=t.toLowerCase(),window.jimuConfig.isDevEdition){o="https://developers.arcgis.com/experience-builder/";const i=vt.dev;s=e?`${i[e].prefix}${i[e][t]}`:`${i[t]}`;let n=o+"#";return s?(n=o+s,yield Promise.resolve(n)):yield Promise.resolve(n)}{const n=(0,a.getAppStore)().getState().portalUrl;if(window.jimuConfig.isInPortal){const o=window.locale||"en",r=vt.portal;s=e?`${r[e][t]}`:`${r[t]}`;const p={"Content-Type":"text/json"},l=function(e,t){let i="";const o=(0,a.getAppStore)().getState().portalSelf,s=null==o?void 0:o.helpBase.split("/");if(null==s?void 0:s.includes("https:")){const e=bt()?window.locale:"en";i=s.slice(0,3).join("/")+"/"+e}else i=e+"/"+(null==s?void 0:s[2])+"/"+t;return i}(n,o),d=l.includes("https:")?l+"/experience-builder":l;return yield fetch(n+"/sharing/rest/portals/helpmap?f=json",{method:"get",headers:p}).then((e=>St(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>St(this,void 0,void 0,(function*(){if(e&&e.helpMap&&e.helpMap.m&&s&&e.helpMap.m[s]){const t=l+"/"+e.helpMap.m[s];return yield Promise.resolve(t)}return i?yield Promise.resolve(d):yield At()})))).catch((e=>St(this,void 0,void 0,(function*(){return console.warn(e),i?yield Promise.resolve(d):yield At()}))))}{const i=vt.online;s=e?`${i[e].prefix}${i[e][t]}`:`${i[t]}`,o="https://"+(n.includes("maps.arcgis.com")||n.includes("www.arcgis.com")?"doc":"docdev")+".arcgis.com/en/experience-builder/";let r=o+"#";if(!s)return yield Promise.resolve(r);if(r=o+s,bt()){a.portalUrlUtils.getPortalSelfInfoUrl(n);const e=function(e,t,i){let o;const s=(0,a.getAppStore)().getState().portalSelf;if(s&&s.helpBase){try{o=s.helpBase.split("/").slice(0,4).join("/")+"/experience-builder/"}catch(e){return i}return o?o+t:i}return i}(0,s,r);return yield Promise.resolve(e)}return yield Promise.resolve(r)}}}))}var Mt=l(262),Tt=function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function a(e){try{p(o.next(e))}catch(e){n(e)}}function r(e){try{p(o.throw(e))}catch(e){n(e)}}function p(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};function jt(e,t,i){(null==e?void 0:e.config)&&a.appConfigUtils.fixLayoutIds(e.config);const o=t?a.i18n.getIntl(t,"setting"):a.i18n.getIntl();return a.utils.replaceI18nPlaceholdersInObject(e,o,i)}function Ut(e,t,i,o,s,n){var r,p,l,d,u,c,g,h;return Tt(this,void 0,void 0,(function*(){const n=He(e);let f=null===(r=null==e?void 0:e.widgets)||void 0===r?void 0:r[i];if(!f)return yield Promise.resolve(e);yield Ht(t);const y=null==t?void 0:t.config,m=null===(p=null==y?void 0:y.widgets)||void 0===p?void 0:p[o],I=[];if(m){if(m.config&&n.editWidgetConfig(i,m.config),m.style&&n.editWidgetProperty(i,"style",m.style),e=n.appConfig,m.layouts){const i=m.layouts,o=[];Object.keys(i).forEach((e=>{var t,s;const n=i[e]||{},a=(null!==(s=null===(t=f.manifest)||void 0===t?void 0:t.layouts)&&void 0!==s?s:[]).find((t=>t.name===e));Object.keys(n).forEach((t=>{o.push({layoutName:e,sizeMode:t,layoutId:n[t],layoutLabel:null==a?void 0:a.label})}))}));for(let i=0;i<o.length;i+=1){const{layoutName:n,sizeMode:r,layoutId:p,layoutLabel:c}=o[i],g=yield _t(e,t,p,s);e=g.appConfig;const h=g.newLayoutId;I.push(h);const y=null===(d=null===(l=null==f?void 0:f.layouts)||void 0===l?void 0:l[n])||void 0===d?void 0:d[r];y&&(e=He(e).removeLayout(y,!0).appConfig),e=e.setIn(["widgets",f.id,"layouts",n,r],h).setIn(["layouts",h,"label"],(null===(u=null==f?void 0:f.manifest)||void 0===u?void 0:u.i18nMessages[`_layout_${n}_label`])||c||n).setIn(["layouts",h,"parent"],{id:f.id,type:a.LayoutParentType.Widget})}}if("widgets/common/controller/"===m.uri){const o=Object.keys(null!==(h=null===(g=null===(c=m.config)||void 0===c?void 0:c.behavior)||void 0===g?void 0:g.size)&&void 0!==h?h:{});if(o.length>0){for(let i=0;i<o.length;i++){const n=yield Et(e,t,o[i],s);e=n.appConfig}const n={};o.forEach((e=>{n[s[e]]=m.config.behavior.size[e]}));let a=e.widgets[i].config;a=a.setIn(["behavior","size"],n),e=e.setIn(["widgets",i,"config"],a)}}}return f=e.widgets[f.id],f.layouts&&Object.keys(f.layouts).forEach((t=>{const i=f.layouts[t];Object.keys(i).forEach((t=>{const o=i[t],s=He(e);if(s.buildLayoutStructure(o,t,!0),e=s.appConfig,I.includes(o))return;const n=e.layouts[o];n.content&&Object.keys(null==n?void 0:n.content).forEach((t=>{const i=n.content[t];e=He(e).removeLayoutItem({layoutId:n.id,layoutItemId:i.id},!0,!0).appConfig}))}))})),Promise.resolve(e)}))}function Et(e,t,i,o,s=!1){var n,r;return Tt(this,void 0,void 0,(function*(){if(o[i])return yield Promise.resolve({appConfig:e,newWidgetId:o[i]});yield Ht(t);let p=He(e);const l=t.config,d=Object.keys(l.widgets).find((e=>"widgets/layout/row/"===l.widgets[e].uri));i=null!=i?i:d;const u=l.widgets[i],c=[],g={uri:u.uri},h=yield Je.getInstance().handleNewWidgetJson(g),f=a.appConfigUtils.getUniqueId(p.appConfig,"widget");if(h.id=f,s){const e=a.i18n.getIntl().formatMessage({id:"block"});h.label=a.appConfigUtils.getUniqueLabel(p.appConfig,"widget",e)}else h.label=null,a.appConfigUtils.addWidgetDefaultLabelAndIcon(p.appConfig,h);p.createWidget((0,a.Immutable)(h),!1),o[i]=f;let y=p.appConfig;if((null===(n=u.useMapWidgetIds)||void 0===n?void 0:n.length)>0)for(let e=0;e<u.useMapWidgetIds.length;e++){const i=yield Et(y,t,u.useMapWidgetIds[e],o);y=i.appConfig,c.push(i.newWidgetId)}return p=He(y),c.length>0&&p.editWidgetProperty(f,"useMapWidgetIds",c),y=yield Ut(p.appConfig,t,f,i,o),(null===(r=l.controllerPanels)||void 0===r?void 0:r[i])&&(y=y.setIn(["controllerPanels",f],l.controllerPanels[i])),yield Promise.resolve({appConfig:y,newWidgetId:f})}))}function Rt(e,t,i,o){return Tt(this,void 0,void 0,(function*(){if(o[i])return yield Promise.resolve({appConfig:e,newSectionId:o[i]});yield Ht(t);let s=e;const n=t.config.sections[i],r=a.appConfigUtils.getUniqueId(e,"section");s=s.setIn(["sections",r],n).setIn(["sections",r,"id"],r).setIn(["sections",r,"label"],a.appConfigUtils.getUniqueLabel(e,"section",a.i18n.getIntl().formatMessage({id:"section"})));const p=[];for(let e=0;e<n.views.length;e+=1){const i=n.views[e],a=yield Ot(s,t,i,o);s=a.appConfig,p.push(a.newViewId)}return s=s.setIn(["sections",r,"views"],p),o[i]=r,yield Promise.resolve({appConfig:s,newSectionId:r})}))}function _t(e,t,i,o){return Tt(this,void 0,void 0,(function*(){let s=e;yield Ht(t);const n=t.config,r=n.layouts[i],p=a.appConfigUtils.getUniqueId(e,"layout");s=s.setIn(["layouts",p],r).setIn(["layouts",p,"id"],p);const l=[];Object.keys(r.content||{}).forEach((e=>{const t=r.content[e];t.type===a.LayoutItemType.Widget&&t.widgetId&&n.widgets[t.widgetId]?l.push({type:a.LayoutItemType.Widget,layoutItemId:e,widgetId:t.widgetId}):t.type===a.LayoutItemType.Section&&t.sectionId&&n.sections[t.sectionId]?l.push({type:a.LayoutItemType.Section,layoutItemId:e,sectionId:t.sectionId}):t.type===a.LayoutItemType.ScreenGroup&&t.screenGroupId&&n.screenGroups[t.screenGroupId]&&l.push({type:a.LayoutItemType.ScreenGroup,layoutItemId:e,screenGroupId:t.screenGroupId})}));for(let e=0;e<l.length;e+=1){const{type:i,layoutItemId:n,widgetId:d,sectionId:u,screenGroupId:c}=l[e];if(i===a.LayoutItemType.Widget){const e=yield Et(s,t,d,o,r.type===a.LayoutType.FlowLayout);s=e.appConfig;const i=e.newWidgetId;s=s.setIn(["layouts",p,"content",n,"widgetId"],i)}else if(i===a.LayoutItemType.Section){const e=yield Rt(s,t,u,o);s=e.appConfig;const i=e.newSectionId;s=s.setIn(["layouts",p,"content",n,"sectionId"],i)}else if(i===a.LayoutItemType.ScreenGroup){const e=yield Wt(s,t,c,o);s=e.appConfig;const i=e.newScreenGroupId;s=s.setIn(["layouts",p,"content",n,"screenGroupId"],i)}}return Promise.resolve({appConfig:s,newLayoutId:p})}))}function Ot(e,t,i,o){return Tt(this,void 0,void 0,(function*(){let s=e;yield Ht(t);const n=t.config.views[i],r=a.appConfigUtils.getUniqueId(e,"view");s=s.setIn(["views",r],n).setIn(["views",r,"id"],r).setIn(["views",r,"label"],a.appConfigUtils.getUniqueLabel(e,"view",a.i18n.getIntl().formatMessage({id:"view"})));const p=[];Object.keys(n.layout||{}).forEach((e=>{p.push({sizeMode:e,layoutId:n.layout[e]})}));for(let e=0;e<p.length;e+=1){const{sizeMode:i,layoutId:n}=p[e],a=yield _t(s,t,n,o);s=a.appConfig;const l=a.newLayoutId;s=s.setIn(["views",r,"layout",i],l)}return Promise.resolve({appConfig:s,newViewId:r})}))}function kt(e,t,i){return Tt(this,void 0,void 0,(function*(){let o=e;yield Ht(t);const s=t.config,n=Object.keys(s.pages)[0],r=s.pages[n],p=a.appConfigUtils.getUniqueId(e,"page"),l=a.appConfigUtils.getUniqueLabel(e,"page",a.i18n.getIntl().formatMessage({id:"page"}));o=o.setIn(["pages",p],r).setIn(["pages",p,"id"],p).setIn(["pages",p,"isVisible"],!0).setIn(["pages",p,"isDefault"],!1).setIn(["pages",p,"label"],l).setIn(["pages",p,"header"],!1).setIn(["pages",p,"footer"],!1);const d=[];Object.keys(r.layout||{}).forEach((e=>{d.push({sizeMode:e,layoutId:r.layout[e]})}));for(let e=0;e<d.length;e+=1){const{sizeMode:s,layoutId:n}=d[e],r=yield _t(o,t,n,i);o=r.appConfig;const l=r.newLayoutId;o=o.setIn(["pages",p,"layout",s],l).setIn(["layouts",l,"parent"],{id:p,type:a.LayoutParentType.Page})}const u=He(o),c=o.pages[p];return Object.keys(c.layout).forEach((e=>{const t=c.layout[e];u.buildLayoutStructure(t,e,!0)})),Promise.resolve({appConfig:u.appConfig,newPageId:p})}))}function Wt(e,t,i,o){return Tt(this,void 0,void 0,(function*(){if(o[i])return yield Promise.resolve({appConfig:e,newScreenGroupId:o[i]});let s=e;yield Ht(t);const n=t.config;i=null!=i?i:Object.keys(n.screenGroups)[0];const r=n.screenGroups[i],p=a.appConfigUtils.getUniqueId(e,"screenGroup");s=s.setIn(["screenGroups",p],r).setIn(["screenGroups",p,"id"],p).setIn(["screenGroups",p,"label"],a.appConfigUtils.getUniqueLabel(e,"screenGroup",a.i18n.getIntl().formatMessage({id:"screenGroup"})));const l=[];for(let e=0;e<r.screens.length;e+=1){const i=r.screens[e],n=yield Bt(s,t,i,o);s=n.appConfig,l.push(n.newScreenId)}return s=s.setIn(["screenGroups",p,"screens"],l),o[i]=p,yield Promise.resolve({appConfig:s,newScreenGroupId:p})}))}function Bt(e,t,i,o){var s;return Tt(this,void 0,void 0,(function*(){let n=e;yield Ht(t);const r=t.config;i=null!=i?i:Object.keys(r.screens)[0];const p=r.screens[i],l=a.appConfigUtils.getUniqueId(e,"screen");n=n.setIn(["screens",l],p).setIn(["screens",l,"id"],l).setIn(["screens",l,"label"],a.appConfigUtils.getUniqueLabel(e,"screen",a.i18n.getIntl().formatMessage({id:"screen"})));const d=[];Object.keys((null===(s=p.panel)||void 0===s?void 0:s.layout)||{}).forEach((e=>{d.push({sizeMode:e,isSide:!0,layoutId:p.panel.layout[e]})})),Object.keys(p.main.layout||{}).forEach((e=>{d.push({sizeMode:e,isSide:!1,layoutId:p.main.layout[e]})}));for(let e=0;e<d.length;e+=1){const{sizeMode:i,layoutId:s,isSide:r}=d[e],p=yield _t(n,t,s,o);n=p.appConfig;const u=p.newLayoutId;n=n.setIn(["layouts",u,"parent"],{type:a.LayoutParentType.Screen,id:l}),n=r?n.setIn(["screens",l,"panel","layout",i],u):n.setIn(["screens",l,"main","layout",i],u)}return Promise.resolve({appConfig:n,newScreenId:l})}))}function Ft(e,t,i){return Tt(this,void 0,void 0,(function*(){let o=e;yield Ht(t);const s=t.config,n=Object.keys(s.dialogs)[0],r=s.dialogs[n],p=a.appConfigUtils.getUniqueId(e,"dialog"),l=a.appConfigUtils.getUniqueLabel(e,"dialog",a.i18n.getIntl().formatMessage({id:"dialog"})),d=Object.keys(Object.keys(o.dialogs).filter((e=>o.dialogs[e].mode===r.mode))).length;o=o.setIn(["dialogs",p],r).setIn(["dialogs",p,"id"],p).setIn(["dialogs",p,"label"],l).setIn(["dialogs",p,"index"],d).setIn(["dialogs",p,"isSplash"],!1).setIn(["dialogs",p,"closeWhenClickOverlay"],r.closeWhenClickOverlay).setIn(["dialogs",p,"sizeMode"],r.sizeMode);const u=[];Object.keys(r.layout||{}).forEach((e=>{u.push({sizeMode:e,layoutId:r.layout[e]})}));for(let e=0;e<u.length;e+=1){const{sizeMode:s,layoutId:n}=u[e],r=yield _t(o,t,n,i);o=r.appConfig;const l=r.newLayoutId;o=o.setIn(["dialogs",p,"layout",s],l).setIn(["layouts",l,"parent"],{id:p,type:a.LayoutParentType.Dialog})}const c=He(o),g=o.dialogs[p];return Object.keys(g.layout).forEach((e=>{const t=g.layout[e];c.buildLayoutStructure(t,e,!0)})),Promise.resolve({appConfig:c.appConfig,newDialogId:p})}))}function Gt(e,t){var i,o,s,n;return Tt(this,void 0,void 0,(function*(){if(yield Ht(t),!(null===(i=null==t?void 0:t.config)||void 0===i?void 0:i.header))return yield Promise.resolve({appConfig:e});const r=null===(o=null==e?void 0:e.header)||void 0===o?void 0:o.layout;if(r){let{appConfig:i,updatedSizeModeLayout:o}=yield Vt(e,r,t,(0,a.Immutable)(null===(n=null===(s=null==t?void 0:t.config)||void 0===s?void 0:s.header)||void 0===n?void 0:n.layout));i=i.setIn(["header","layout"],o),Object.values(o).forEach((e=>{i=i.setIn(["layouts",e,"parent"],{id:"",type:a.LayoutParentType.Header})})),Object.keys(t.config.header).forEach((e=>{"layout"!==e&&null!=t.config.header[e]&&(i=i.setIn(["header",e],t.config.header[e]))}));const p=He(i);return Object.keys(o).forEach((e=>{p.buildLayoutStructure(o[e],e,!0)})),Promise.resolve({appConfig:p.appConfig})}return Promise.resolve({appConfig:e})}))}function $t(e,t){var i,o,s,n;return Tt(this,void 0,void 0,(function*(){if(yield Ht(t),!(null===(i=null==t?void 0:t.config)||void 0===i?void 0:i.footer))return yield Promise.resolve({appConfig:e});const r=null===(o=null==e?void 0:e.footer)||void 0===o?void 0:o.layout;if(r){let{appConfig:i,updatedSizeModeLayout:o}=yield Vt(e,r,t,(0,a.Immutable)(null===(n=null===(s=null==t?void 0:t.config)||void 0===s?void 0:s.footer)||void 0===n?void 0:n.layout));i=i.setIn(["footer","layout"],o),Object.values(o).forEach((e=>{i=i.setIn(["layouts",e,"parent"],{id:"",type:a.LayoutParentType.Footer})})),Object.keys(t.config.footer).forEach((e=>{"layout"!==e&&null!=t.config.footer[e]&&(i=i.setIn(["footer",e],t.config.footer[e]))}));const p=He(i);return Object.keys(o).forEach((e=>{p.buildLayoutStructure(o[e],e,!0)})),Promise.resolve({appConfig:p.appConfig})}return Promise.resolve({appConfig:e})}))}function zt(e,t,i){var o,s,n,r,p;return Tt(this,void 0,void 0,(function*(){if(yield Ht(i),!i.config){const t=yield(0,Mt.getTemplateConfig)(i.type,i.name);if(i.config=t,!i.config)return yield Promise.resolve({appConfig:e});a.appConfigUtils.fixLayoutIds(i.config),a.utils.replaceI18nPlaceholdersInObject(i.config,a.i18n.getIntl(),Qe)}const l=Object.keys(i.config.pages)[0],d=null===(s=null===(o=null==e?void 0:e.pages)||void 0===o?void 0:o[t])||void 0===s?void 0:s.layout;if(d){let{appConfig:o,updatedSizeModeLayout:s}=yield Vt(e,d,i,(0,a.Immutable)(null===(p=null===(r=null===(n=null==i?void 0:i.config)||void 0===n?void 0:n.pages)||void 0===r?void 0:r[l])||void 0===p?void 0:p.layout));o=o.setIn(["pages",t,"layout"],s),Object.values(s).forEach((e=>{o=o.setIn(["layouts",e,"parent"],{id:t,type:a.LayoutParentType.Page})})),["mode","maxWidth","bodyBackgroundColor","bodyBackgroundIMage","bodyBackgroundPosition"].forEach((e=>{const s=i.config.pages[l][e];"layout"!==e&&null!=s&&(o=o.setIn(["pages",t,e],s))}));const u=He(o);return Object.keys(s).forEach((e=>{u.buildLayoutStructure(s[e],e,!0)})),Promise.resolve({appConfig:u.appConfig})}return Promise.resolve({appConfig:e})}))}function Nt(e,t,i){var o,s,n;return Tt(this,void 0,void 0,(function*(){yield Ht(i);const r=Object.keys(i.config.dialogs)[0],p=null===(o=null==e?void 0:e.dialogs)||void 0===o?void 0:o[t],l=null==p?void 0:p.layout;if(l){const o=null===(n=null===(s=null==i?void 0:i.config)||void 0===s?void 0:s.dialogs)||void 0===n?void 0:n[r];let{appConfig:d,updatedSizeModeLayout:u}=yield Vt(e,l,i,(0,a.Immutable)(null==o?void 0:o.layout));const c=p.mode===o.mode,g=c?p.index:Object.keys(Object.keys(d.dialogs).filter((e=>d.dialogs[e].mode===o.mode))).length;d=d.setIn(["dialogs",t,"layout"],u).setIn(["dialogs",t,"index"],g),Object.values(u).forEach((e=>{d=d.setIn(["layouts",e,"parent"],{id:t,type:a.LayoutParentType.Dialog})})),["sizeMode","mode","overlayColor","dialogBackground","interactionType","interactionStyles","confirmBeforeClose","alwaysShowConfirmation","closeWhenClickOverlay"].forEach((e=>{d=d.setIn(["dialogs",t,e],o[e])})),c||Object.keys(d.dialogs).forEach((e=>{const t=d.dialogs[e];t.mode===p.mode&&t.index>p.index&&(d=d.setIn(["dialogs",t.id,"index"],t.index-1))}));const h=He(d);return Object.keys(u).forEach((e=>{h.buildLayoutStructure(u[e],e,!0)})),Promise.resolve({appConfig:h.appConfig})}return Promise.resolve({appConfig:e})}))}function qt(e,t,i){var o,s;return Tt(this,void 0,void 0,(function*(){yield Ht(i);const n=null===(s=null===(o=null==e?void 0:e.widgets)||void 0===o?void 0:o[t])||void 0===s?void 0:s.layouts,r=Object.values(i.config.widgets).find((e=>"widgets/layout/grid/"===e.uri)),p="DEFAULT",l=n[p];let{appConfig:d,updatedSizeModeLayout:u}=yield Vt(e,l,i,(0,a.Immutable)(r.layouts[p]));d=d.setIn(["widgets",t,"layouts",p],u),Object.values(u).forEach((e=>{d=d.setIn(["layouts",e,"parent"],{id:t,type:a.LayoutParentType.Widget})}));const c=He(d);return Object.keys(u).forEach((e=>{c.buildLayoutStructure(u[e],e,!0)})),{appConfig:c.appConfig}}))}function Ht(e){return Tt(this,void 0,void 0,(function*(){if(!e.config){const t=yield(0,Mt.getTemplateConfig)(e.type,e.name);a.appConfigUtils.fixLayoutIds(t),a.utils.replaceI18nPlaceholdersInObject(t,a.i18n.getIntl(),Qe),e.config=t}}))}function Vt(e,t,i,o){return Tt(this,void 0,void 0,(function*(){if(!o)return yield Promise.resolve({appConfig:e,updatedSizeModeLayout:t});const s={};let n=e,a=t;const r=Object.keys(o);for(let e=0;e<r.length;e+=1){const t=r[e],p=yield Kt(n,a[t],i,o[t],s);n=p.appConfig,a=a.set(t,p.newLayoutId)}const p=L.utils.getCurrentSizeMode();if(null==o[p]){const e=yield Kt(n,a[p],i,o[n.mainSizeMode],s);n=e.appConfig,a=a.set(p,e.newLayoutId)}return yield Promise.resolve({updatedSizeModeLayout:a,appConfig:n})}))}function Kt(e,t,i,o,s){var n,a;return Tt(this,void 0,void 0,(function*(){if(null==(null===(a=null===(n=i.config)||void 0===n?void 0:n.layouts)||void 0===a?void 0:a[o]))return{appConfig:e,newLayoutId:t};let r=e;if(t){const i=e.layouts[t];if((null==i?void 0:i.content)&&Object.keys(i.content).length>0)return{appConfig:e,newLayoutId:t};r=r.set("layouts",r.layouts.without(t))}const p=yield _t(r,i,o,s);return r=p.appConfig,{appConfig:r,newLayoutId:p.newLayoutId}}))}class Zt extends a.React.PureComponent{constructor(){super(...arguments),this.isSupportKeyboard=()=>{let e=!1;return window.jimuConfig.isBuilder&&"home"!==this.props.currentPageId&&"template"!==this.props.currentPageId?(e=!0,e):e},this.switchAppMode=()=>{var e,t;(null===(t=null===(e=(0,a.getAppStore)().getState().appStateInBuilder)||void 0===e?void 0:e.appRuntimeInfo)||void 0===t?void 0:t.appMode)===a.AppMode.Run?ae(a.AppMode.Design):ae(a.AppMode.Run)},this.undo=()=>{this.props.stateHistory.past.length<=1||(0,a.getAppStore)().dispatch(N.InBuilderAppConfigUndo())},this.redo=()=>{this.props.stateHistory.future.length<=0||(0,a.getAppStore)().dispatch(N.InBuilderAppConfigRedo())},this.onKeyboardTrigger=e=>{e.key.includes("-manual")||ce(e)},this.isMac=()=>{var e,t;return"macOS"===(null===(t=null===(e=window.jimuUA)||void 0===e?void 0:e.os)||void 0===t?void 0:t.name)}}render(){return this.isMac()?this.isSupportKeyboard()?a.React.createElement(a.Keyboard,{onKeyboardTrigger:this.onKeyboardTrigger,bindings:{"shift+alt+keyx":()=>{this.switchAppMode()},"command+keyz":()=>{this.undo()},"command+shift+keyz":()=>{this.redo()}}}):null:this.isSupportKeyboard()?a.React.createElement(a.Keyboard,{onKeyboardTrigger:this.onKeyboardTrigger,bindings:{"shift+alt+keyx":()=>{this.switchAppMode()},"ctrl+keyz":()=>{this.undo()},"ctrl+shift+keyz":()=>{this.redo()}}}):null}}const Jt=a.ReactRedux.connect((e=>({currentPageId:e.appRuntimeInfo.currentPageId,stateHistory:e.appStateHistory})))(Zt);function Qt(e){var t,i,o;const{widgetId:s,useDataSource:n,messageType:r,arcGISDataSourceTypes:p}=e,l=null===(i=null===(t=(0,a.getAppStore)().getState())||void 0===t?void 0:t.appStateInBuilder)||void 0===i?void 0:i.appConfig,d=null===(o=null==l?void 0:l.widgets)||void 0===o?void 0:o[s],u=function(e,t){var i,o,s,n;const r=null===(o=null===(i=(0,a.getAppStore)().getState())||void 0===i?void 0:i.appStateInBuilder)||void 0===o?void 0:o.appConfig,p=null===(s=null==r?void 0:r.widgets)||void 0===s?void 0:s[e],l=[],d=a.DataSourceManager.getInstance();return null===(n=null==p?void 0:p.useDataSources)||void 0===n||n.forEach((e=>{const i=d.getDataSource(e.dataSourceId);(null==i?void 0:i.type)!==t.WebMap&&(null==i?void 0:i.type)!==t.WebScene||l.push(e.dataSourceId)})),l.length>0?(0,a.Immutable)(l):null}(s,p),c=function(e,t,i){const o=(null==e?void 0:e.outputDataSources)||[],s=(null==e?void 0:e.useDataSources)||[];if(i)return!1;switch(t){case a.MessageCarryData.OutputDataSource:return 1===(null==o?void 0:o.length);case a.MessageCarryData.UseDataSource:return 1===(null==s?void 0:s.length);case a.MessageCarryData.BothDataSource:return 1===o.length+s.length}}(d,Xt(s,r),u),g=n&&n.dataSourceId?(0,a.Immutable)([n.asMutable({deep:!0})]):null,h=u?null:function(e,t){var i;const o=Yt(e,t);return(0,a.Immutable)(null!==(i=null==o?void 0:o.map((e=>null==e?void 0:e.mainDataSourceId)))&&void 0!==i?i:[])}(s,r);return{isReadOnly:c,useDataSources:g,fromRootDsIds:u,fromDsIds:h}}function Yt(e,t){var i,o,s;const n=Xt(e,t),r=null===(o=null===(i=(0,a.getAppStore)().getState())||void 0===i?void 0:i.appStateInBuilder)||void 0===o?void 0:o.appConfig,p=null===(s=null==r?void 0:r.widgets)||void 0===s?void 0:s[e],l=(null==p?void 0:p.useDataSources)||(0,a.Immutable)([]),d=function(e){var t;const i=null!==(t=null==e?void 0:e.map((e=>({dataSourceId:e,mainDataSourceId:e,rootDataSourceId:null}))))&&void 0!==t?t:[];return(0,a.Immutable)(i)}(null==p?void 0:p.outputDataSources)||(0,a.Immutable)([]),u=null==l?void 0:l.asMutable({deep:!0}).concat(null==d?void 0:d.asMutable({deep:!0}));switch(n){case a.MessageCarryData.OutputDataSource:return d;case a.MessageCarryData.UseDataSource:return l;case a.MessageCarryData.BothDataSource:return(0,a.Immutable)(u)}}function Xt(e,t){const i=function(e,t){var i,o,s,n;const r=null===(o=null===(i=(0,a.getAppStore)().getState())||void 0===i?void 0:i.appStateInBuilder)||void 0===o?void 0:o.appConfig,p=null===(s=null==r?void 0:r.widgets)||void 0===s?void 0:s[e],l=null===(n=null==p?void 0:p.manifest)||void 0===n?void 0:n.publishMessages;let d=null;return l.forEach((e=>{const i=e;(null==i?void 0:i.messageCarryData)&&(null==i?void 0:i.messageType)===t&&(d=null==i?void 0:i.messageCarryData)})),d}(e,t);return i||a.MessageCarryData.UseDataSource}function ei(e){var t,i,o,s,n,r,p,l,d,u,c,g,h,f;const{widgetId:y,oldUseDataSource:m,messageType:I,arcGISDataSourceTypes:C}=e,S=(0,a.getAppStore)().getState().appStateInBuilder.appConfig,v=a.DataSourceManager.getInstance(),w=S.widgets[y];let b=null,L=!1;const A=null===(i=null===(t=v.getDataSource(m.dataSourceId))||void 0===t?void 0:t.getDataSourceJson())||void 0===i?void 0:i.isOutputFromWidget,D=Yt(y,I),P=(null==D?void 0:D[0])&&(null===(o=null==D?void 0:D[0])||void 0===o?void 0:o.dataSourceId);if(!P)return null;const x=null===(s=v.getDataSource(P))||void 0===s?void 0:s.getDataSourceJson();if(!x||x.type!==C.WebMap&&x.type!==C.WebScene||(L=!0),L){let e=!1;if(w&&w.useDataSources)for(let t=0;t<w.useDataSources.length;t++)if(w.useDataSources[t].dataSourceId===m.rootDataSourceId){e=!0;break}b=e?m:null}else{let e=!1;if(D)for(let t=0;t<(null==D?void 0:D.length);t++){const i=A?null===(r=null===(n=v.getDataSource(m.dataSourceId))||void 0===n?void 0:n.getMainDataSource())||void 0===r?void 0:r.id:m.dataSourceId;if((A?null===(d=null===(l=v.getDataSource(null===(p=null==D?void 0:D[t])||void 0===p?void 0:p.dataSourceId))||void 0===l?void 0:l.getMainDataSource())||void 0===d?void 0:d.id:null===(u=null==D?void 0:D[t])||void 0===u?void 0:u.dataSourceId)===i){e=!0;break}}b=e?m:1===(null==D?void 0:D.length)?(0,a.Immutable)({dataSourceId:null===(c=null==D?void 0:D[0])||void 0===c?void 0:c.dataSourceId,mainDataSourceId:null===(g=null==D?void 0:D[0])||void 0===g?void 0:g.mainDataSourceId,dataViewId:null===(h=null==D?void 0:D[0])||void 0===h?void 0:h.dataViewId,rootDataSourceId:null===(f=null==D?void 0:D[0])||void 0===f?void 0:f.rootDataSourceId}):null}return b}function ti(e){return!(!e.messageUseDataSource||!e.actionUseDataSource||e.messageUseDataSource.mainDataSourceId!==e.actionUseDataSource.mainDataSourceId||!function(e){return!e.messageUseDataSource.rootDataSourceId&&!e.actionUseDataSource.rootDataSourceId||e.messageUseDataSource.rootDataSourceId===e.actionUseDataSource.rootDataSourceId}(e))}var ii=l(556),oi=l.n(ii);const si=e=>{const t=window.SVG,{className:i}=e,o=function(e,t){var i={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(i[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(o=Object.getOwnPropertySymbols(e);s<o.length;s++)t.indexOf(o[s])<0&&Object.prototype.propertyIsEnumerable.call(e,o[s])&&(i[o[s]]=e[o[s]])}return i}(e,["className"]),s=(0,a.classNames)("jimu-icon jimu-icon-component",i);return t?a.React.createElement(t,Object.assign({className:s,src:oi()},o)):a.React.createElement("svg",Object.assign({className:s},o))};class ni extends a.React.PureComponent{constructor(e){super(e),this.modalStyle={position:"absolute",top:"0",bottom:"0",width:"259px",height:"auto",borderRight:"",borderBottom:"",paddingBottom:"1px"},this.getInitConfig=()=>{var e,t,i,o,s,n,r,p,l,d,u;const{messageWidgetId:c,messageType:g}=this.props,h=a.DataSourceManager.getInstance();let f=null,y=null,m=!0;if(this.props.config.messageUseDataSource)f=ei({widgetId:c,oldUseDataSource:this.props.config.messageUseDataSource,messageType:g,arcGISDataSourceTypes:this.state.ArcGISDataSourceTypes});else{const n=Yt(c,g);if((null==n?void 0:n[0])&&1===(null==n?void 0:n.length)){const r=null===(e=h.getDataSource(null==n?void 0:n[0].dataSourceId))||void 0===e?void 0:e.getDataSourceJson();f=!r||r.type!==this.state.ArcGISDataSourceTypes.WebMap&&r.type!==this.state.ArcGISDataSourceTypes.WebScene?(0,a.Immutable)({dataSourceId:null===(t=null==n?void 0:n[0])||void 0===t?void 0:t.dataSourceId,mainDataSourceId:null===(i=null==n?void 0:n[0])||void 0===i?void 0:i.mainDataSourceId,dataViewId:null===(o=null==n?void 0:n[0])||void 0===o?void 0:o.dataViewId,rootDataSourceId:null===(s=null==n?void 0:n[0])||void 0===s?void 0:s.rootDataSourceId}):null}}if(void 0!==this.props.config.enableQueryWithCurrentExtent&&(m=this.props.config.enableQueryWithCurrentExtent),this.props.config.actionUseDataSource){const e=null===(r=null===(n=this.props.config)||void 0===n?void 0:n.actionUseDataSource)||void 0===r?void 0:r.dataSourceId,t=null===(l=null===(p=this.props.config)||void 0===p?void 0:p.actionUseDataSource)||void 0===l?void 0:l.rootDataSourceId;y=(null===(d=h.getDataSource(e))||void 0===d?void 0:d.getDataSourceJson())||(null===(u=h.getDataSource(t))||void 0===u?void 0:u.getDataSourceJson())?this.props.config.actionUseDataSource:null}else y=null;return y&&y.dataSourceId?{messageUseDataSource:f,actionUseDataSource:y,sqlExprObj:this.props.config.sqlExprObj,enableQueryWithCurrentExtent:m}:{messageUseDataSource:f,actionUseDataSource:y,sqlExprObj:null,enableQueryWithCurrentExtent:m}},this.handleTriggerLayerChange=e=>{e&&e.length>0?this.handleTriggerLayerSelected(e[0]):this.handleRemoveLayerForTriggerLayer()},this.handleActionLayerChange=e=>{e&&e.length>0?this.handleActionLayerSelected(e[0]):this.handleRemoveLayerForActionLayer()},this.handleTriggerLayerSelected=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",e)})},this.handleActionLayerSelected=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",e).set("sqlExprObj",null)})},this.handleRemoveLayerForTriggerLayer=()=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",null)})},this.handleRemoveLayerForActionLayer=()=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",null).set("sqlExprObj",null)})},this.showSqlExprPopup=()=>{this.setState({isSqlExprShow:!0})},this.toggleSqlExprPopup=()=>{this.setState({isSqlExprShow:!this.state.isSqlExprShow})},this.onSqlExprBuilderChange=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("sqlExprObj",e)})},this.onMessageFieldSelected=(e,t)=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",{dataSourceId:this.props.config.messageUseDataSource.dataSourceId,mainDataSourceId:this.props.config.messageUseDataSource.mainDataSourceId,dataViewId:this.props.config.messageUseDataSource.dataViewId,rootDataSourceId:this.props.config.messageUseDataSource.rootDataSourceId,fields:e.map((e=>e.jimuName))})})},this.onActionFieldSelected=(e,t)=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",{dataSourceId:this.props.config.actionUseDataSource.dataSourceId,mainDataSourceId:this.props.config.actionUseDataSource.mainDataSourceId,dataViewId:this.props.config.actionUseDataSource.dataViewId,rootDataSourceId:this.props.config.actionUseDataSource.rootDataSourceId,fields:e.map((e=>e.jimuName))})})},this.swicthEnabledDataRelationShip=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("enabledDataRelationShip",e)})},this.swicthEnabledQueryWithCurrentExtent=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("enableQueryWithCurrentExtent",e)})},this.checkIsDisableDataView=e=>{var t,i,o,s;if(this.props.messageType===a.MessageType.DataRecordsSelectionChange)return!0;const n=null===(i=null===(t=(0,a.getAppStore)().getState())||void 0===t?void 0:t.appStateInBuilder)||void 0===i?void 0:i.appConfig,r=null===(o=null==n?void 0:n.widgets)||void 0===o?void 0:o[e];return!!r&&"Map"===(null===(s=null==r?void 0:r.manifest)||void 0===s?void 0:s.label)},this.modalStyle.borderRight="1px solid black",this.modalStyle.borderBottom="1px solid black",this.state={isShowLayerList:!1,currentLayerType:null,isSqlExprShow:!1}}componentDidMount(){a.moduleLoader.loadModules(["jimu-ui","jimu-ui/advanced/setting-components","jimu-ui/advanced/data-source-selector","jimu-arcgis","jimu-ui/advanced/sql-expression-builder"]).then((e=>{this.setState({Button:e[0].Button,Icon:e[0].Icon,Switch:e[0].Switch,Collapse:e[0].Collapse,SettingSection:e[1].SettingSection,SettingRow:e[1].SettingRow,FieldSelector:e[2].FieldSelector,DataSourceSelector:e[2].DataSourceSelector,ArcGISDataSourceTypes:e[3].ArcGISDataSourceTypes,SqlExpressionBuilderPopup:e[4].SqlExpressionBuilderPopup,DSSelectorTypes:(0,a.Immutable)([a.AllDataSourceTypes.FeatureLayer,a.AllDataSourceTypes.SceneLayer])},(()=>{const e=this.getInitConfig();this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",e.messageUseDataSource).set("actionUseDataSource",e.actionUseDataSource).set("sqlExprObj",e.sqlExprObj)})}))}))}getStyle(e){return a.css`
      .setting-header {
        padding: ${a.polished.rem(10)} ${a.polished.rem(16)} ${a.polished.rem(0)} ${a.polished.rem(16)}
      }

      .deleteIcon {
        cursor: pointer;
        opacity: .8;
      }

      .deleteIcon:hover {
        opacity: 1;
      }

      .sql-expr-display {
        width: 100%;
        height: auto;
        min-height: 60px;
        line-height: 25px;
        padding: 3px 5px;
        color: ${e.colors.palette.dark[300]};
        border: 1px solid ${e.colors.palette.light[500]};
      }

      .relate-panel-left {
        flex: auto;
        overflow: hidden;
        .action-select-chooser {
          margin-top: ${a.polished.rem(12)};
        }
      }
    `}render(){var e,t;const{Button:i,Icon:o,Switch:s,Collapse:n,SettingSection:r,SettingRow:p,FieldSelector:l,DataSourceSelector:d,ArcGISDataSourceTypes:u,SqlExpressionBuilderPopup:c}=this.state,{messageWidgetId:g,messageType:h,config:f,theme:y}=this.props;if(!(i&&o&&s&&n&&r&&p&&l&&d&&u&&c))return null;const m=Qt({widgetId:g,useDataSource:f.messageUseDataSource,messageType:h,arcGISDataSourceTypes:u}),I=f.actionUseDataSource&&a.DataSourceManager.getInstance().getDataSource(f.actionUseDataSource.dataSourceId);return this.props.messageType===a.MessageType.ExtentChange?(0,a.jsx)("div",{css:this.getStyle(this.props.theme)},(0,a.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_ActionLayer",defaultMessage:Qe.frameworkAction_ActionLayer})},(0,a.jsx)(d,{types:this.state.DSSelectorTypes,useDataSources:this.props.config.actionUseDataSource?(0,a.Immutable)([this.props.config.actionUseDataSource]):(0,a.Immutable)([]),closeDataSourceListOnChange:!0,hideAddDataButton:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleActionLayerChange,widgetId:this.props.widgetId,enableToSelectOutputDsFromSelf:!0})),(0,a.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_Conditions",defaultMessage:Qe.frameworkAction_Conditions})},(0,a.jsx)(p,{label:this.props.intl.formatMessage({id:"frameworkAction_QueryByExtent",defaultMessage:Qe.frameworkAction_QueryByExtent})},(0,a.jsx)(s,{checked:this.props.config.enableQueryWithCurrentExtent,onChange:e=>{this.swicthEnabledQueryWithCurrentExtent(e.target.checked)}})),(0,a.jsx)(p,null,(0,a.jsx)(i,{className:"p-0 text-left",type:"link",disabled:!this.props.config.actionUseDataSource,onClick:this.showSqlExprPopup,title:this.props.intl.formatMessage({id:"frameworkAction_MoreConditions",defaultMessage:Qe.frameworkAction_MoreConditions})},this.props.intl.formatMessage({id:"frameworkAction_MoreConditions",defaultMessage:Qe.frameworkAction_MoreConditions}))),(0,a.jsx)(p,null,this.props.config.actionUseDataSource&&(0,a.jsx)(a.DataSourceComponent,{useDataSource:this.props.config.actionUseDataSource},(e=>(0,a.jsx)(c,{dataSource:e,mode:a.SqlExpressionMode.Simple,isOpen:this.state.isSqlExprShow,toggle:this.toggleSqlExprPopup,expression:this.props.config.sqlExprObj,onChange:e=>{this.onSqlExprBuilderChange(e)},id:"filter-widget-sql-expression-builder-popup"}))),(0,a.jsx)("div",{className:"sql-expr-display body-1"},this.props.config.sqlExprObj&&I?a.dataSourceUtils.getArcGISSQL(this.props.config.sqlExprObj,I).displaySQL:this.props.intl.formatMessage({id:"frameworkAction_SetExpression",defaultMessage:Qe.frameworkAction_SetExpression}))))):(0,a.jsx)("div",{css:this.getStyle(this.props.theme)},(0,a.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_TriggerLayer",defaultMessage:Qe.frameworkAction_TriggerLayer})},(0,a.jsx)(d,{types:this.state.DSSelectorTypes,useDataSources:m.useDataSources,fromRootDsIds:m.fromRootDsIds,fromDsIds:m.fromDsIds,closeDataSourceListOnChange:!0,disableRemove:()=>m.isReadOnly,disableDataSourceList:m.isReadOnly,hideAddDataButton:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleTriggerLayerChange,widgetId:this.props.messageWidgetId,disableDataView:!0,hideDataView:this.checkIsDisableDataView(this.props.messageWidgetId),enableToSelectOutputDsFromSelf:!0})),(0,a.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_ActionLayer",defaultMessage:Qe.frameworkAction_ActionLayer})},(0,a.jsx)(d,{types:this.state.DSSelectorTypes,useDataSources:this.props.config.actionUseDataSource?(0,a.Immutable)([this.props.config.actionUseDataSource]):(0,a.Immutable)([]),closeDataSourceListOnChange:!0,hideAddDataButton:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleActionLayerChange,widgetId:this.props.widgetId,enableToSelectOutputDsFromSelf:!0})),this.props.config&&this.props.config.actionUseDataSource&&this.props.config.messageUseDataSource&&(0,a.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_Conditions",defaultMessage:Qe.frameworkAction_Conditions})},(0,a.jsx)(p,{label:this.props.intl.formatMessage({id:"frameworkAction_RelateMessage",defaultMessage:Qe.frameworkAction_RelateMessage})},(0,a.jsx)(s,{checked:this.props.config.enabledDataRelationShip,onChange:e=>{this.swicthEnabledDataRelationShip(e.target.checked)}})),(0,a.jsx)(p,null,(0,a.jsx)(n,{isOpen:this.props.config.enabledDataRelationShip,className:"w-100"},ti(f)&&(0,a.jsx)("div",{className:"w-100 border p-1 mr-2"},this.props.intl.formatMessage({id:"frameworkAction_AutoBind",defaultMessage:Qe.frameworkAction_AutoBind})),!ti(f)&&(0,a.jsx)("div",{className:"w-100 d-flex align-items-center"},(0,a.jsx)("div",{className:"d-flex flex-column relate-panel-left"},(0,a.jsx)(l,{className:"w-100",useDataSources:(0,a.Immutable)([null===(e=this.props.config.messageUseDataSource)||void 0===e?void 0:e.asMutable({deep:!0})]),isDataSourceDropDownHidden:!0,placeholder:this.props.intl.formatMessage({id:"frameworkAction_TriggerLayerField",defaultMessage:Qe.frameworkAction_TriggerLayerField}),onChange:this.onMessageFieldSelected,useDropdown:!0,isSearchInputHidden:!0,selectedFields:this.props.config.messageUseDataSource&&this.props.config.messageUseDataSource.fields?this.props.config.messageUseDataSource.fields:(0,a.Immutable)([])}),(0,a.jsx)(l,{className:"w-100 action-select-chooser",placeholder:this.props.intl.formatMessage({id:"frameworkAction_ActionLayerField",defaultMessage:Qe.frameworkAction_ActionLayerField}),useDataSources:(0,a.Immutable)([null===(t=this.props.config.actionUseDataSource)||void 0===t?void 0:t.asMutable({deep:!0})]),isDataSourceDropDownHidden:!0,onChange:this.onActionFieldSelected,useDropdown:!0,isSearchInputHidden:!0,selectedFields:this.props.config.actionUseDataSource&&this.props.config.actionUseDataSource.fields?this.props.config.actionUseDataSource.fields:(0,a.Immutable)([])})),(0,a.jsx)(si,{autoFlip:!0,className:"flex-none",width:12,height:40,color:y.colors.dark[400]})))),(0,a.jsx)(p,null,(0,a.jsx)(i,{type:"link",disabled:!this.props.config.actionUseDataSource,className:"w-100 d-flex justify-content-start",onClick:this.showSqlExprPopup},(0,a.jsx)("div",{className:"w-100 text-truncate",style:{textAlign:"start"}},this.props.intl.formatMessage({id:"frameworkAction_MoreConditions",defaultMessage:Qe.frameworkAction_MoreConditions}))),this.props.config.actionUseDataSource&&(0,a.jsx)(a.DataSourceComponent,{useDataSource:this.props.config.actionUseDataSource},(e=>(0,a.jsx)(c,{dataSource:e,mode:a.SqlExpressionMode.Simple,isOpen:this.state.isSqlExprShow,toggle:this.toggleSqlExprPopup,expression:this.props.config.sqlExprObj,onChange:e=>{this.onSqlExprBuilderChange(e)},id:"filter-widget-sql-expression-builder-popup"})))),(0,a.jsx)(p,null,(0,a.jsx)("div",{className:"sql-expr-display"},this.props.config.sqlExprObj&&I?a.dataSourceUtils.getArcGISSQL(this.props.config.sqlExprObj,I).displaySQL:this.props.intl.formatMessage({id:"frameworkAction_SetExpression",defaultMessage:Qe.frameworkAction_SetExpression})))))}}ni.defaultProps={config:(0,a.Immutable)({messageUseDataSource:null,actionUseDataSource:null,sqlExprObj:null,enabledDataRelationShip:!0,enableQueryWithCurrentExtent:!0})};const ai=a.ReactRedux.connect((e=>({dataSources:e.appStateInBuilder&&e.appStateInBuilder.appConfig&&e.appStateInBuilder.appConfig.dataSources,dataSourcesInfo:e.appStateInBuilder&&e.appStateInBuilder.dataSourcesInfo})))((0,g.withTheme)(ni));class ri extends a.React.PureComponent{constructor(e){super(e),this.modalStyle={position:"absolute",top:"0",bottom:"0",width:"259px",height:"auto",borderRight:"",borderBottom:"",paddingBottom:"1px"},this.getInitConfig=()=>{var e,t,i,o,s,n,r,p,l,d,u;const{messageWidgetId:c,messageType:g}=this.props,h=a.DataSourceManager.getInstance();let f=null,y=null;if(this.props.config.messageUseDataSource)f=ei({widgetId:c,oldUseDataSource:this.props.config.messageUseDataSource,messageType:g,arcGISDataSourceTypes:this.state.ArcGISDataSourceTypes});else{const n=Yt(c,g);if((null==n?void 0:n[0])&&1===(null==n?void 0:n.length)){const r=null===(e=h.getDataSource(null==n?void 0:n[0].dataSourceId))||void 0===e?void 0:e.getDataSourceJson();f=!r||r.type!==this.state.ArcGISDataSourceTypes.WebMap&&r.type!==this.state.ArcGISDataSourceTypes.WebScene?(0,a.Immutable)({dataSourceId:null===(t=null==n?void 0:n[0])||void 0===t?void 0:t.dataSourceId,mainDataSourceId:null===(i=null==n?void 0:n[0])||void 0===i?void 0:i.mainDataSourceId,dataViewId:null===(o=null==n?void 0:n[0])||void 0===o?void 0:o.dataViewId,rootDataSourceId:null===(s=null==n?void 0:n[0])||void 0===s?void 0:s.rootDataSourceId}):null}}if(this.props.config.actionUseDataSource){const e=null===(r=null===(n=this.props.config)||void 0===n?void 0:n.actionUseDataSource)||void 0===r?void 0:r.dataSourceId,t=null===(l=null===(p=this.props.config)||void 0===p?void 0:p.actionUseDataSource)||void 0===l?void 0:l.rootDataSourceId;y=(null===(d=h.getDataSource(e))||void 0===d?void 0:d.getDataSourceJson())||(null===(u=h.getDataSource(t))||void 0===u?void 0:u.getDataSourceJson())?this.props.config.actionUseDataSource:null}else y=null;return y&&y.dataSourceId?{messageUseDataSource:f,actionUseDataSource:y,sqlExprObj:this.props.config.sqlExprObj}:{messageUseDataSource:f,actionUseDataSource:y,sqlExprObj:null}},this.handleTriggerLayerChange=e=>{e&&e.length>0?this.handleTriggerLayerSelected(e[0]):this.handleRemoveLayerForTriggerLayer()},this.handleActionLayerChange=e=>{e&&e.length>0?this.handleActionLayerSelected(e[0]):this.handleRemoveLayerForActionLayer()},this.handleTriggerLayerSelected=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",e)})},this.handleActionLayerSelected=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",e).set("sqlExprObj",null)})},this.handleRemoveLayerForTriggerLayer=()=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",null)})},this.handleRemoveLayerForActionLayer=()=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",null).set("sqlExprObj",null)})},this.showSqlExprPopup=()=>{this.setState({isSqlExprShow:!0})},this.toggleSqlExprPopup=()=>{this.setState({isSqlExprShow:!this.state.isSqlExprShow})},this.onSqlExprBuilderChange=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("sqlExprObj",e)})},this.onMessageFieldSelected=(e,t)=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",{dataSourceId:this.props.config.messageUseDataSource.dataSourceId,mainDataSourceId:this.props.config.messageUseDataSource.mainDataSourceId,dataViewId:this.props.config.messageUseDataSource.dataViewId,rootDataSourceId:this.props.config.messageUseDataSource.rootDataSourceId,fields:e.map((e=>e.jimuName))})})},this.onActionFieldSelected=(e,t)=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",{dataSourceId:this.props.config.actionUseDataSource.dataSourceId,mainDataSourceId:this.props.config.actionUseDataSource.mainDataSourceId,dataViewId:this.props.config.actionUseDataSource.dataViewId,rootDataSourceId:this.props.config.actionUseDataSource.rootDataSourceId,fields:e.map((e=>e.jimuName))})})},this.swicthEnabledDataRelationShip=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("enabledDataRelationShip",e)})},this.modalStyle.borderRight="1px solid black",this.modalStyle.borderBottom="1px solid black",this.state={isShowLayerList:!1,currentLayerType:null,isSqlExprShow:!1}}componentDidMount(){a.moduleLoader.loadModules(["jimu-ui","jimu-ui/advanced/setting-components","jimu-ui/advanced/data-source-selector","jimu-arcgis","jimu-ui/advanced/sql-expression-builder"]).then((e=>{this.setState({Button:e[0].Button,Icon:e[0].Icon,Switch:e[0].Switch,Collapse:e[0].Collapse,SettingSection:e[1].SettingSection,SettingRow:e[1].SettingRow,FieldSelector:e[2].FieldSelector,DataSourceSelector:e[2].DataSourceSelector,ArcGISDataSourceTypes:e[3].ArcGISDataSourceTypes,SqlExpressionBuilderPopup:e[4].SqlExpressionBuilderPopup,DSSelectorTypes:(0,a.Immutable)([a.AllDataSourceTypes.FeatureLayer,a.AllDataSourceTypes.SceneLayer])},(()=>{const e=this.getInitConfig();this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",e.messageUseDataSource).set("actionUseDataSource",e.actionUseDataSource).set("sqlExprObj",e.sqlExprObj)})}))}))}getStyle(e){return a.css`
      .setting-header {
        padding: ${a.polished.rem(10)} ${a.polished.rem(16)} ${a.polished.rem(0)} ${a.polished.rem(16)}
      }

      .deleteIcon {
        cursor: pointer;
        opacity: .8;
      }

      .deleteIcon:hover {
        opacity: 1;
      }

      .sql-expr-display {
        width: 100%;
        height: auto;
        min-height: 60px;
        line-height: 25px;
        padding: 3px 5px;
        color: ${e.colors.palette.dark[300]};
        border: 1px solid ${e.colors.palette.light[500]};
      }

      .relate-panel-left {
        flex: auto;
        overflow: hidden;
        .action-select-chooser {
          margin-top: ${a.polished.rem(12)};
        }
      }
    `}render(){var e,t;const{Button:i,Icon:o,Switch:s,Collapse:n,SettingSection:r,SettingRow:p,FieldSelector:l,DataSourceSelector:d,ArcGISDataSourceTypes:u,SqlExpressionBuilderPopup:c}=this.state,{messageWidgetId:g,messageType:h,config:f,theme:y}=this.props;if(!(i&&o&&s&&n&&r&&p&&l&&d&&u&&c))return null;const m=Qt({widgetId:g,useDataSource:f.messageUseDataSource,messageType:h,arcGISDataSourceTypes:u}),I=this.props.config.actionUseDataSource&&a.DataSourceManager.getInstance().getDataSource(this.props.config.actionUseDataSource.dataSourceId);return(0,a.jsx)("div",{css:this.getStyle(this.props.theme)},(0,a.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_TriggerLayer",defaultMessage:Qe.frameworkAction_TriggerLayer})},(0,a.jsx)(d,{types:this.state.DSSelectorTypes,useDataSources:m.useDataSources,fromRootDsIds:m.fromRootDsIds,fromDsIds:m.fromDsIds,closeDataSourceListOnChange:!0,disableRemove:()=>m.isReadOnly,disableDataSourceList:m.isReadOnly,hideAddDataButton:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleTriggerLayerChange,widgetId:this.props.messageWidgetId,hideDataView:!0,enableToSelectOutputDsFromSelf:!0})),(0,a.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_ActionLayer",defaultMessage:Qe.frameworkAction_ActionLayer})},(0,a.jsx)(d,{types:this.state.DSSelectorTypes,useDataSources:this.props.config.actionUseDataSource?(0,a.Immutable)([this.props.config.actionUseDataSource]):(0,a.Immutable)([]),closeDataSourceListOnChange:!0,hideAddDataButton:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleActionLayerChange,widgetId:this.props.widgetId,hideDataView:!0,enableToSelectOutputDsFromSelf:!0})),this.props.config&&this.props.config.actionUseDataSource&&this.props.config.messageUseDataSource&&(0,a.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_Conditions",defaultMessage:Qe.frameworkAction_Conditions})},(0,a.jsx)(p,{label:this.props.intl.formatMessage({id:"frameworkAction_RelateMessage",defaultMessage:Qe.frameworkAction_RelateMessage})},(0,a.jsx)(s,{checked:this.props.config.enabledDataRelationShip,onChange:e=>{this.swicthEnabledDataRelationShip(e.target.checked)}})),(0,a.jsx)(p,null,(0,a.jsx)(n,{isOpen:this.props.config.enabledDataRelationShip,className:"w-100"},ti(f)&&(0,a.jsx)("div",{className:"w-100 border p-1 mr-2"},this.props.intl.formatMessage({id:"frameworkAction_AutoBind",defaultMessage:Qe.frameworkAction_AutoBind})),!ti(f)&&(0,a.jsx)("div",{className:"w-100 d-flex align-items-center"},(0,a.jsx)("div",{className:"d-flex flex-column relate-panel-left"},(0,a.jsx)(l,{className:"w-100",useDataSources:(0,a.Immutable)([null===(e=this.props.config.messageUseDataSource)||void 0===e?void 0:e.asMutable({deep:!0})]),isDataSourceDropDownHidden:!0,placeholder:this.props.intl.formatMessage({id:"frameworkAction_TriggerLayerField",defaultMessage:Qe.frameworkAction_TriggerLayerField}),onChange:this.onMessageFieldSelected,useDropdown:!0,isSearchInputHidden:!0,selectedFields:this.props.config.messageUseDataSource&&this.props.config.messageUseDataSource.fields?this.props.config.messageUseDataSource.fields:(0,a.Immutable)([])}),(0,a.jsx)(l,{className:"w-100 action-select-chooser",placeholder:this.props.intl.formatMessage({id:"frameworkAction_ActionLayerField",defaultMessage:Qe.frameworkAction_ActionLayerField}),useDataSources:(0,a.Immutable)([null===(t=this.props.config.actionUseDataSource)||void 0===t?void 0:t.asMutable({deep:!0})]),isDataSourceDropDownHidden:!0,onChange:this.onActionFieldSelected,useDropdown:!0,isSearchInputHidden:!0,selectedFields:this.props.config.actionUseDataSource&&this.props.config.actionUseDataSource.fields?this.props.config.actionUseDataSource.fields:(0,a.Immutable)([])})),(0,a.jsx)(si,{autoFlip:!0,className:"flex-none",width:12,height:40,color:y.colors.dark[400]})))),(0,a.jsx)(p,null,(0,a.jsx)(i,{type:"link",disabled:!this.props.config.actionUseDataSource,className:"w-100 d-flex justify-content-start",onClick:this.showSqlExprPopup},(0,a.jsx)("div",{className:"w-100 text-truncate",style:{textAlign:"start"}},this.props.intl.formatMessage({id:"frameworkAction_MoreConditions",defaultMessage:Qe.frameworkAction_MoreConditions}))),this.props.config.actionUseDataSource&&(0,a.jsx)(a.DataSourceComponent,{useDataSource:this.props.config.actionUseDataSource},(e=>(0,a.jsx)(c,{dataSource:e,mode:a.SqlExpressionMode.Simple,isOpen:this.state.isSqlExprShow,toggle:this.toggleSqlExprPopup,expression:this.props.config.sqlExprObj,onChange:e=>{this.onSqlExprBuilderChange(e)},id:"filter-widget-sql-expression-builder-popup"})))),(0,a.jsx)(p,null,(0,a.jsx)("div",{className:"sql-expr-display"},this.props.config.sqlExprObj&&I?a.dataSourceUtils.getArcGISSQL(this.props.config.sqlExprObj,I).displaySQL:this.props.intl.formatMessage({id:"frameworkAction_SetExpression",defaultMessage:Qe.frameworkAction_SetExpression})))))}}ri.defaultProps={config:(0,a.Immutable)({messageUseDataSource:null,actionUseDataSource:null,sqlExprObj:null,enabledDataRelationShip:!0})};const pi=a.ReactRedux.connect((e=>({dataSources:e.appStateInBuilder&&e.appStateInBuilder.appConfig&&e.appStateInBuilder.appConfig.dataSources,dataSourcesInfo:e.appStateInBuilder&&e.appStateInBuilder.dataSourcesInfo})))((0,g.withTheme)(ri));var li=function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function a(e){try{p(o.next(e))}catch(e){n(e)}}function r(e){try{p(o.throw(e))}catch(e){n(e)}}function p(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};function di(){return li(this,void 0,void 0,(function*(){const e=(0,a.getAppStore)().getState().appContext.locale;return yield function(e,t){return li(this,void 0,void 0,(function*(){return(e=a.i18n.getLocaleToLoad(e,t))?yield a.i18n.loadLocaleMessages("jimu-for-builder/lib/translations",e).then((e=>e)):Promise.resolve(Qe)}))}(e,a.translatedLocales).then((e=>(e&&(0,a.getAppStore)().dispatch(a.appActions.i18nMessagesLoaded("jimu-for-builder",e)),a.i18n.resetIntls(),e)))}))}var ui=function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function a(e){try{p(o.next(e))}catch(e){n(e)}}function r(e){try{p(o.throw(e))}catch(e){n(e)}}function p(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};function ci(){return ui(this,void 0,void 0,(function*(){return b.getInstance().registerActionRawSettingClass("filter-data-record-action",ai),b.getInstance().registerActionRawSettingClass("select-data-record-action",pi),yield di(),yield Promise.resolve({})}))}})(),d})())}}}));
System.register(["jimu-core","jimu-for-builder/templates"],function(e,t){var n={},i={};return{setters:[function(e){n.CONSTANTS=e.CONSTANTS,n.ExtensionManager=e.ExtensionManager,n.Immutable=e.Immutable,n.SessionManager=e.SessionManager,n.USER_SETTING_FILE_KEY=e.USER_SETTING_FILE_KEY,n.appActions=e.appActions,n.appConfigUtils=e.appConfigUtils,n.esri=e.esri,n.extensionSpec=e.extensionSpec,n.getAppStore=e.getAppStore,n.i18n=e.i18n,n.moduleLoader=e.moduleLoader,n.portalUrlUtils=e.portalUrlUtils,n.semver=e.semver,n.sharedThemeUtils=e.sharedThemeUtils,n.urlUtils=e.urlUtils,n.utils=e.utils,n.version=e.version},function(e){i.TemplateType=e.TemplateType,i.getTemplateConfig=e.getTemplateConfig}],execute:function(){e((()=>{"use strict";var e={244:e=>{e.exports=n},884:e=>{e.exports=i}},t={};function o(n){var i=t[n];if(void 0!==i)return i.exports;var r=t[n]={exports:{}};return e[n](r,r.exports,o),r.exports}o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};o.r(r),o.d(r,{AppType:()=>l,PublishStatus:()=>d,SearchType:()=>c,appServices:()=>u,createAppCallBack:()=>$e,getNewTypeKeywordsWhenSaveApp:()=>_e,getPublishStatus:()=>qe,getResourceOrigin:()=>se,initAppConfigOfNewApp:()=>Ve,toCreateAppByDefaultTemplate:()=>Me,userServices:()=>a});var s={};o.r(s),o.d(s,{addItemResource:()=>N,checkItemVersion:()=>E,createItem:()=>C,getItem:()=>U,getItemData:()=>k,getItemResource:()=>D,getItemResources:()=>$,getOriginUrl:()=>S,getRequestMethod:()=>x,getUserContentUrl:()=>P,getUserName:()=>A,getUserTags:()=>M,importItem:()=>I,removeItem:()=>L,removeItemResource:()=>F,request:()=>w,searchItems:()=>v,searchItemsByPortalUrl:()=>g,updateItem:()=>W,updateItemResource:()=>q});var u={};o.r(u),o.d(u,{addToFavorites:()=>Rt,changeAppFolder:()=>Ft,checkImportAppVersion:()=>mt,createAppByDefaultTemplate:()=>dt,createAppByItemTemplateId:()=>lt,createAppByItemTemplateInfo:()=>ct,createTemplateByApp:()=>pt,deleteApp:()=>_t,duplicateApp:()=>vt,getAppGroups:()=>Mt,getAppInfo:()=>Ut,getDefaultTemplateConfig:()=>At,getDraftAppConfig:()=>Pt,getFolders:()=>Et,getGroupCategorySchema:()=>jt,getGroupContent:()=>It,getOrgCategorySchema:()=>Ct,getPublishedAppConfig:()=>bt,getUserTags:()=>Ot,importAppFromPortal:()=>yt,importAppFromZip:()=>gt,publishApp:()=>Wt,removeFromFavorites:()=>Lt,replaceExbVersionInAppConfig:()=>Ke,saveApp:()=>wt,saveAsApp:()=>St,searchApp:()=>xt,searchAppByPortalUrl:()=>Tt,searchGroups:()=>kt,transferAppToFullMode:()=>ht,updateAppInfo:()=>$t,updateAppInfoWhenSaveApp:()=>Dt,updateAppThumbnail:()=>Gt});var a={};o.r(a),o.d(a,{addUserResource:()=>Jt,getUserResource:()=>zt,getUserResources:()=>Ht,initUserResource:()=>Zt,removeUserResource:()=>Qt,updateUserResource:()=>Xt});var c,l,d,p=o(244);!function(e){e.AGOL="AGOL",e.Portal="Portal",e.Other="Other"}(c||(c={})),function(e){e.TemplateType="Web Experience Template",e.ExperienceType="Web Experience"}(l||(l={})),function(e){e.Published="Published",e.Draft="Draft",e.Changed="Changed"}(d||(d={}));var f=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};function v(e){return f(this,arguments,void 0,function*(e,t=c.Other){return yield h(e,"item",t)})}function h(e,t){return f(this,arguments,void 0,function*(e,t,n=c.Other){let i,o;return i=`${n===c.AGOL?"https://www.arcgis.com/":`${window.location.origin}${window.jimuConfig.mountPath}`}sharing/rest/search`,o="string"==typeof e||e instanceof p.esri.restPortal.SearchQueryBuilder?{params:{q:e}}:p.esri.restRequest.appendCustomParams(Object.assign(Object.assign({},e),{f:"json"}),["q","num","start","sortField","sortOrder","portalUrl","f","categories"]),w(i,o,"GET").then(n=>(n.nextStart&&-1!==n.nextStart&&(n.nextPage=function(){return f(this,void 0,void 0,function*(){let i;return"string"==typeof e||e instanceof p.esri.restPortal.SearchQueryBuilder?i={q:e,start:n.nextStart}:(i=e,i.start=n.nextStart),yield h(i,t)})}),n))})}function g(e,t){return f(this,void 0,void 0,function*(){return yield m(e,t)})}function m(e,t){return f(this,void 0,void 0,function*(){let n,i;n||Promise.resolve(null),n=`${t}/sharing/rest/search`,i="string"==typeof e||e instanceof p.esri.restPortal.SearchQueryBuilder?{params:{q:e}}:p.esri.restRequest.appendCustomParams(Object.assign(Object.assign({},e),{f:"json"}),["q","num","start","sortField","sortOrder","portalUrl","f"]);const o=null==i?void 0:i.authentication,r={params:null==i?void 0:i.params,httpMethod:"GET"};return o&&(r.authentication=o),p.esri.restRequest.request(n,r).then(t=>(t.nextStart&&-1!==t.nextStart&&(t.nextPage=function(){return f(this,void 0,void 0,function*(){let n;return"string"==typeof e||e instanceof p.esri.restPortal.SearchQueryBuilder?n={q:e,start:t.nextStart}:(n=e,n.start=t.nextStart),yield m(n,"item")})}),t))})}var y=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};function w(e){return y(this,arguments,void 0,function*(e,t={params:{f:"json"}},n="POST"){if("GET"===n){const n=e+function(e){if(!e)return"";const t=Object.keys(e);return t.length?"?"+t.map(t=>encodeURIComponent(t)+"="+encodeURIComponent(e[t])).join("&"):""}(t.params);return yield fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>y(this,void 0,void 0,function*(){return yield e.json()})).then(e=>y(this,void 0,void 0,function*(){return yield Promise.resolve(e)}))}return"POST"===n?t.params&&"FormData"===t.params.constructor.name?yield fetch(e,{method:"POST",body:t.params}).then(e=>y(this,void 0,void 0,function*(){return yield e.json()})).then(e=>y(this,void 0,void 0,function*(){return yield Promise.resolve(e)})):yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.params)}).then(e=>y(this,void 0,void 0,function*(){return yield e.json()})).then(e=>y(this,void 0,void 0,function*(){return yield Promise.resolve(e)})):yield Promise.reject(new Error(null))})}function S(e=!1){var t;if(e)return p.urlUtils.getArcgisOnlineUrl();{const e=(null===(t=window.jimuConfig.mountPath)||void 0===t?void 0:t.slice(0,-1))||"";return`${window.location.origin}${e}`}}const b=p.esri.restRequest.request;function P(e=!1){return e?"/sharing/rest/content/":"/sharing/rest/content/users/"}function A(){var e;return null===(e=(0,p.getAppStore)().getState().user)||void 0===e?void 0:e.username}function x(e=!1){return e?b:w}function T(e){const t=JSON.parse(JSON.stringify(e));return t.data&&("undefined"!=typeof Blob&&e.data instanceof Blob||"ReadStream"===e.data.constructor.name?t.file=e.data:t.text=e.data,delete t.data),t}var j=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};function C(e){return j(this,void 0,void 0,function*(){const t=Object.assign({folderId:null},e);return yield function(e){return j(this,void 0,void 0,function*(){var t,n;if(e.file&&!e.multipart)return yield Promise.reject(new Error("The request must be a multipart request for file uploading."));if(e.multipart&&!e.filename)return yield Promise.reject(new Error("The file name is required for a multipart request."));const i=A(),o=`${S()}${P()}addItem`;e.params=Object.assign(Object.assign(Object.assign({},e.params),T(e.item)),{portalUrl:null===(n=null===(t=(0,p.getAppStore)())||void 0===t?void 0:t.getState())||void 0===n?void 0:n.portalUrl});const r=p.esri.restRequest.appendCustomParams(e,["owner","folderId","file","dataUrl","text","async","multipart","filename","overwrite"],{params:Object.assign({},e.params)});return r.params.username=i,yield w(o,r)})}(t)})}function I(e,t){return j(this,void 0,void 0,function*(){const n=`${S()}${P()}importItem`;if(!(null==e?void 0:e.appZip))return Promise.reject(new Error("No app files"));t.params=Object.assign(Object.assign({},t.params),e);const i=Object.keys(t.params),o=new FormData;for(let e=0;e<i.length;e++)o.append(i[e],t.params[i[e]]);return t.params=o,yield w(n,t)})}function E(e,t){return j(this,void 0,void 0,function*(){const n=`${S()}${P()}checkItemVersion`;if(!(null==e?void 0:e.appZip))return Promise.reject(new Error("No app files"));t.params=Object.assign(Object.assign({},t.params),e);const i=Object.keys(t.params),o=new FormData;for(let e=0;e<i.length;e++)o.append(i[e],t.params[i[e]]);return t.params=o,yield w(n,t)})}var O=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};function k(e,t){return O(this,arguments,void 0,function*(e,t,n=!1){const i=`${S(n)}${P(n)}items/${e}/data`,o=Object.assign({params:{}},t);o.file&&(o.params.f=null),n&&!G()&&delete o.authentication;const r=x(n);return yield r(i,o,"GET").catch(e=>{if(!/Unexpected end of (JSON input|data at line 1 column 1)/i.test(e.message))throw new Error(e)})})}function U(e,t){return O(this,arguments,void 0,function*(e,t,n=!1){const i=`${S(n)}${P(n)}items/${e}`,o=Object.assign({},t);n&&!G()&&delete o.authentication;const r=x(n);return yield r(i,o,"GET")})}function M(e){return O(this,void 0,void 0,function*(){const t=`${S()}/community/users/${e.username}/tags`,n=Object.assign({},e);delete n.authentication;const i=x();return yield i(t,n,"GET")})}function $(e,t){return O(this,arguments,void 0,function*(e,t,n=!1){const i=`${S(n)}${P(n)}items/${e}/resources`;t.params=Object.assign(Object.assign({},t.params),{num:1e3}),n&&!G()&&delete t.authentication;const o=x(n);return yield o(i,t,"GET")})}function D(e,t){return O(this,arguments,void 0,function*(e,t,n=!1){const i=t.fileName,o=`${S(n)}${P(n)}items/${e}/resources/${i}`;n&&!G()&&delete t.authentication;const r=x(n);return yield r(o,t,"GET")})}function G(){const e=(0,p.getAppStore)().getState().portalUrl;return p.portalUrlUtils.isAGOLDomain(e)}var R=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};function L(e){return R(this,void 0,void 0,function*(){const t=A(),n=S();e.userName=t;const i=`${n}${P()}items/${e.id}/delete`;return yield w(i,e)})}function F(e){return R(this,void 0,void 0,function*(){const t=`${S()}${P()}items/${e.id}/removeResources`;return e.params=Object.assign(Object.assign({},e.params),{resource:e.resource}),yield w(t,e)})}var _=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};function W(e){return _(this,void 0,void 0,function*(){const t=A(),n=S();e.userName=t;const i=`${n}${P()}items/${e.item.id}/update`;if(e.params=Object.assign(Object.assign({},e.params),T(e.item)),e.item.thumbnail&&"string"!=typeof e.item.thumbnail){e.params=Object.assign(Object.assign({},e.params),e.item);const t=Object.keys(e.params),n=new FormData;for(let i=0;i<t.length;i++)n.append(t[i],e.params[t[i]]);e.params=n}return yield w(i,e)})}function q(e){return _(this,void 0,void 0,function*(){const t=`${S()}${P()}items/${e.id}/updateResources`;e.params=Object.assign(Object.assign({fileName:e.name,text:e.content},e.params),{file:e.resource}),delete e.params.file,e.params.file=e.resource,void 0!==e.private&&(e.params.access=e.private?"private":"inherit");const n=Object.keys(e.params),i=new FormData;for(let t=0;t<n.length;t++)i.append(n[t],e.params[n[t]]);return e.params=i,yield w(t,e)})}var B=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};function N(e){return B(this,void 0,void 0,function*(){const t=`${S()}${P()}items/${e.id}/addResources`;e.params=Object.assign(Object.assign({fileName:e.name,text:e.content,access:e.private?"private":"inherit"},e.params),{file:e.resource}),delete e.params.file,e.params.file=e.resource;const n=Object.keys(e.params),i=new FormData;for(let t=0;t<n.length;t++)i.append(n[t],e.params[n[t]]);return e.params=i,yield w(t,e)})}var K=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};const V=p.SessionManager.getInstance().isTrustedServer((0,p.getAppStore)().getState().portalUrl);function Y(e){return K(this,arguments,void 0,function*(e,t={f:"json"},n="POST"){if("GET"===n){const n=e+function(e){if(!e)return"";const t=Object.keys(e);return t.length?"?"+t.map(t=>encodeURIComponent(t)+"="+encodeURIComponent(e[t])).join("&"):""}(t);return yield fetch(n,{credentials:V?"include":"same-origin",method:"GET"}).then(e=>K(this,void 0,void 0,function*(){return yield e.json()})).then(e=>K(this,void 0,void 0,function*(){return yield Promise.resolve(e)}))}return"POST"===n?t&&"FormData"===t.constructor.name?yield fetch(e,{credentials:V?"include":"same-origin",method:"POST",body:t}).then(e=>K(this,void 0,void 0,function*(){return yield e.json()})).then(e=>K(this,void 0,void 0,function*(){return yield Promise.resolve(e)})):yield fetch(e,{credentials:V?"include":"same-origin",method:"POST",body:JSON.stringify(t)}).then(e=>K(this,void 0,void 0,function*(){return yield e.json()})).then(e=>K(this,void 0,void 0,function*(){return yield Promise.resolve(e)})):yield Promise.reject(new Error(null))})}var J=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};var z=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};function H(e,t){return z(this,arguments,void 0,function*(e,t,n=!1){const i=`${S(n)}/sharing/rest/content/groups/${e}/search`;n&&!function(){const e=(0,p.getAppStore)().getState().portalUrl;return p.portalUrlUtils.isAGOLDomain(e)}()&&delete t.authentication;const o=Object.assign(Object.assign({},t),{httpMethod:"GET"}),r=p.esri.restRequest.request;return yield r(i,o)})}var Q=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};var X=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};var Z=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};var ee=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};function te(e){return ee(this,arguments,void 0,function*(e,t=!1){const n=function(e=!1){var t;return e?p.urlUtils.getArcgisOnlineOrgId():null===(t=(0,p.getAppStore)().getState().user)||void 0===t?void 0:t.orgId}(t),i=`${S(t)}/sharing/rest/portals/${n}/categorySchema`;t&&!ne()&&delete e.authentication;const o=Object.assign(Object.assign({},e),{httpMethod:"GET"}),r=p.esri.restRequest.request;return yield r(i,o)})}function ne(){const e=(0,p.getAppStore)().getState().portalUrl;return p.portalUrlUtils.isAGOLDomain(e)}function ie(e){if(re(e))return{};const t=p.SessionManager.getInstance().getMainSession();return oe(e)?t:{}}function oe(e){var t,n;if(!(null==e?void 0:e.portalUrl))return!window.jimuConfig.isDevEdition;const i=(null==e?void 0:e.portalUrl)||"",o=(null===(n=null===(t=(0,p.getAppStore)())||void 0===t?void 0:t.getState())||void 0===n?void 0:n.portalUrl)||"",r=(null==o?void 0:o.includes(i))||(null==i?void 0:i.includes(o));return(p.portalUrlUtils.isAGOLDomain(i)&&p.portalUrlUtils.isAGOLDomain(o)||r)&&!re(e)}function re(e){return!!((null==e?void 0:e.portalUrl)||"").endsWith("localhost:")||e.isLocalApp}function se(e){const t=ue(e)?p.urlUtils.getArcgisOnlineUrl():(0,p.getAppStore)().getState().portalUrl;return(null==e?void 0:e.isLocalApp)?S()+"/apps/":p.portalUrlUtils.getPlatformUrlByOrgUrl(t)+"/sharing/rest/content/items/"}function ue(e){if(!(null==e?void 0:e.portalUrl))return!1;const t=(null==e?void 0:e.portalUrl)||"",n=p.portalUrlUtils.isAGOLDomain(t),i=!oe(e),o=!re(e);return i&&o&&n}var ae=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};var ce=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};var le=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};var de=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};const{importItem:pe,checkItemVersion:fe}=s;function ve(e,t,n){const i=n?s[n]:s[e],o=p.esri.restPortal[e];return t?oe(t)?o:i:window.jimuConfig.isDevEdition?i:o}function he(e,t){return de(this,void 0,void 0,function*(){return function(e){let t;const n=(0,p.getAppStore)().getState().portalUrl,i=p.portalUrlUtils.isAGOLDomain(n);switch(e){case c.Portal:t=p.esri.restPortal.searchItems;break;case c.AGOL:t=i?p.esri.restPortal.searchItems:v;break;case c.Other:t=window.jimuConfig.isDevEdition?v:p.esri.restPortal.searchItems}return t}(t)(e,t)})}function ge(e){return de(this,void 0,void 0,function*(){return ve("updateItem")(e)})}function me(e){return de(this,void 0,void 0,function*(){return window.jimuConfig.isDevEdition?yield W(e):yield function(e){return J(this,void 0,void 0,function*(){const t=p.SessionManager.getInstance().getMainSession(),n=e.owner?e.owner:null==t?void 0:t.username,i=`${(0,p.getAppStore)().getState().portalUrl}/sharing/rest/content/users/${n}/items/${e.item.id}/update`;e.params=Object.assign(Object.assign({},e.params),e.item);const o=Object.keys(e.params),r=new FormData;for(let t=0;t<o.length;t++)r.append(o[t],e.params[o[t]]);return e.params=r,yield Y(i,r)})}(e)})}function ye(e,t){return de(this,void 0,void 0,function*(){return ve("getItem",e)(e.id,t,ue(e))})}function we(e){return de(this,void 0,void 0,function*(){return function(e){return ce(this,void 0,void 0,function*(){const t=ie(e),n=oe(e)?`?token=${null==t?void 0:t.token}`:"",i=`${se(e)}${e.id}/resources/config/config.json${n}`;return yield Y(i,{},"GET")})}(e)})}function Se(e,t){return de(this,void 0,void 0,function*(){return yield function(e,t){return ae(this,void 0,void 0,function*(){const n=ie(e),i=oe(e),o=`${window.jimuConfig.isDevEdition?S():(0,p.getAppStore)().getState().portalUrl}/sharing/rest/content/items/${e.id}/copy`,r={params:t,httpMethod:"POST"};return i&&(r.authentication=n),yield p.esri.restRequest.request(o,r)})}(e,t)})}function be(e,t){return de(this,void 0,void 0,function*(){return yield function(e,t){return le(this,void 0,void 0,function*(){const n=ie(e),i=oe(e),o=p.SessionManager.getInstance().getMainSession(),r=`${window.jimuConfig.isDevEdition?S():(0,p.getAppStore)().getState().portalUrl}/sharing/rest/content/users/${null==o?void 0:o.username}/items/${e.id}/deleteThumbnail`,s={params:t,httpMethod:"POST"};return i&&(s.authentication=n),yield p.esri.restRequest.request(r,s)})}(e,t)})}function Pe(e,t,n){return de(this,void 0,void 0,function*(){return yield function(e,t){return ee(this,arguments,void 0,function*(e,t,n=!1){const i=`${S(n)}/sharing/rest/community/groups/${e}/c`;n&&!ne()&&delete t.authentication;const o=Object.assign(Object.assign({},t),{params:{id:e},httpMethod:"GET"}),r=p.esri.restRequest.request;return yield r(i,o)})}(e,t,n)})}function Ae(e){return de(this,void 0,void 0,function*(){return yield function(e){return Q(this,void 0,void 0,function*(){const t=p.SessionManager.getInstance().getMainSession(),n=`${(0,p.getAppStore)().getState().portalUrl}/sharing/rest/content/items/${e.items}/share`;e=Object.assign(Object.assign({},e),{f:"json",token:null==t?void 0:t.token});const i=Object.keys(e),o=new FormData;for(let t=0;t<i.length;t++)o.append(i[t],e[i[t]]);return e=o,yield Y(n,e)})}(e)})}function xe(e){return de(this,void 0,void 0,function*(){return yield function(e){return X(this,void 0,void 0,function*(){const t=p.SessionManager.getInstance().getMainSession(),n=`${(0,p.getAppStore)().getState().portalUrl}/sharing/rest/content/items/${e.items}/unshare`;e=Object.assign(Object.assign({},e),{f:"json",token:null==t?void 0:t.token});const i=Object.keys(e),o=new FormData;for(let t=0;t<i.length;t++)o.append(i[t],e[i[t]]);return e=o,yield Y(n,e)})}(e)})}function Te(e){return de(this,void 0,void 0,function*(){return yield function(e){return Z(this,void 0,void 0,function*(){const t=p.SessionManager.getInstance().getMainSession(),n=`${(0,p.getAppStore)().getState().portalUrl}/sharing/rest/content/itemsgroups`,i={params:e,httpMethod:"GET",authentication:t};return yield p.esri.restRequest.request(n,i)})}(e)})}function je(e){return function(e){return z(this,void 0,void 0,function*(){const t=p.SessionManager.getInstance().getMainSession(),n=`${(0,p.getAppStore)().getState().portalUrl}/sharing/rest/content/users/${null==t?void 0:t.username}`,i=Object.assign(Object.assign({},e.params),{f:"json",token:null==t?void 0:t.token});return yield Y(n,i,"GET")})}(e)}const Ce={frameworkAction_SetData:"Select data",frameworkAction_ActionLayer:"Action data",frameworkAction_Conditions:"Conditions",frameworkAction_RelateMessage:"Trigger / action connection",frameworkAction_UseRelationship:"Use layer's relationship",frameworkAction_CustomFields:"Set custom connection fields",frameworkAction_TriggerLayerField:"Select a trigger field",frameworkAction_None:"none",frameworkAction_Equals:"equals",frameworkAction_ActionLayerField:"Select an action field",frameworkAction_MoreConditions:"More conditions",frameworkAction_SetExpression:"Please set your expression first.",frameworkAction_ChooseLayer:"Select data",frameworkAction_AutoBind:"Auto bound.",frameworkAction_NoLayer:"No data.",frameworkAction_QueryByExtent:"Query by current extent",defaultTextPlaceholder:"Double click to edit text",titlePlaceholder:"Here is the title",subTitlePlaceholder:"Here is the subtitle",shortTitlePlaceholder:"Title",shortSubTitlePlaceholder:"Subtitle",copyrightPlaceholder:"Copyright info",cardTitle:"Card title",bookmark:"Bookmark",number:"Number",templateSearchResult:"Search result",logo:"Logo",appItemCopy:"Copy",openingGuideStep1Title:"Getting started",openingGuideStep1Content:"This tour will show you how to navigate in Experience Builder",openingGuideStep2Title:"Canvas",openingGuideStep2Content:"You can interact with widgets in your experience visually on the canvas.",openingGuideStep3Title:"Sidebar",openingGuideStep3Content:"Allows you to open the widget, page, data, and theme panels.",openingGuideStep4Title:"Insert widget",openingGuideStep4Content:"Click on the Map widget and drag it onto the canvas.",openingGuideStep5Title:"Resize widget",openingGuideStep5Content:"You can change the size of widget on the canvas.",openingGuideStep7Title:"Style",openingGuideStep7Content:"Click the Style tab to switch to the style setting panel.",openingGuideStep8Title:"Size and position",openingGuideStep8Content:"Click the Full size button located at the top right hand corner.",openingGuideStep8Title2:"Style",openingGuideStep8Content2:"Allows you to customize properties such as size, position, background, animation, border, and transform.",openingGuideStep9Title:"Action",openingGuideStep9Content:"Click the Action tab to switch to the action setting panel.",openingGuideStep10Title:"Action",openingGuideStep10Content:"Interactions between widgets can be configured using triggers and actions. Widget actions are in response to linked trigger actions in other widgets.",openingGuideStep11Title:"Header",openingGuideStep11Content:"Click Live view to make your experience interactive inside the builder.",openingGuideStep12Title:"Page",openingGuideStep12Content:"Shows the structure of your experience. You can create and organize pages and folders and change page settings.",openingGuideStep13Title:"Data",openingGuideStep13Content:"Displays all the data listed in your experience and the widgets connected to the data.",openingGuideStep14Title:"Theme",openingGuideStep14Content:"Defines the color scheme for the appearance of your experience.",openingGuideStep15Title:"End of tour",openingGuideStep15Content:"You can always return if you need a refresher.",DSSelectionStep1Title:"Widget content",DSSelectionStep1Content:"Click on Select map to add a new data source.",DSSelectionStep2Title:"Add new data",DSSelectionStep2Content:"Click add new data and select a web map for a data source.",DSSelectionStep3Title:"Select data",DSSelectionStep3Content:"Click the web map in the select data panel.",DSSelectionStep4Title:"Widget content",DSSelectionStep4Content:"Click on Select data to add a new data source.",DSSelectionStep5Title:"Select data",DSSelectionStep5Content:"Click the feature layer in the select data panel.",insertWidgetStep1Title:"Insert widget",insertWidgetStep1Content:"Click on the widget and drag it onto the canvas.",welcomeStep1Content:"This tour will show you how to navigate in Experience Builder express mode.",mapWidgetTitle:"Configure Widget",mapWidgetContent:"<p>Activate a widget by clicking on it. Widget configuration will open on the right side panel. For example, please <b>click on the map</b>.</p>",expressSelectDataTitle:"Configure map",expressSelectDataContent:"Select map source, enable map tools and configure other settings.",expressMessageActionTitle:"Message action",expressMessageActionContent:"Configure message actions to communicate with other widgets.",widgetControllerTitle:"Widget controller",widgetControllerContent:"<p><b>Click at the Widget controller area,</b> managing buttons will show on the top bar. Configure Widget controller behaviors on the right side.</p>",expressWidgetControllerAddWidgetTitle:"Add or manage widgets in Widget controller",expressWidgetControllerAddWidgetContent:"Click the Add button on the top bar to add widgets to the Widget controller. Use the Manage widget button to reorder or group widgets. To remove a widget, click on it and a Delete button will show on the top bar.",expressTextTitle:"Configure title",expressTextContent:"Double click to change the title for your app.",expressSectionTitle:"Add or manage views",expressSectionContent:"<p><b>Click on the View navigation area</b>, managing buttons will show on the top bar. You can add new views, reorder or remove views. You can add a widget to each view.</p>",expressSidebarTitle:"Configure widget in Sidebar",expressSidebarContent:"<p><b>Click the expand button</b> to open the sidebar. Click the widget inside to configure.</p>",expressSidebarTitle1:"Configure Sidebar",expressSidebarContent1:"You can decide whether to show the sidebar by enabling or disabling the sidebar Collapse button.",expressGridTitle:"Managing grids",expressGridContent:"Click on a grid and managing buttons will show on the top bar. You can remove a grid or split it in a preferred way.",expressPlaceholderTitle:"Add or manage widget",expressPlaceholderContent:"<p>Click the Add button on Placeholder to add a widget and configure it on the right side. <br> To remove the widget, click on the widget and a delete button will show on the top bar.</p>",expressThemeTitle:"Theme & General settings",expressThemeContent:"Select a preferred theme from Theme tab. Configure app general settings from General tab.",expressWindowTitle:"Page or Window switch",expressWindowContent:"<p><b>Click the outline menu</b> to switch between page and window.</p>",expressWindowTitle1:"Configure window",expressWindowContent1:"Configure Window behaviors on the right side. Double click text to edit. For other widgets, click to activate configuration on the right side.",expressWindowTitle2:"Configure window",expressWindowContent2:"<p><b>Click Window option</b> to switch Window settings. Hover on the Window option and click the Set as splash icon beside it to set a splash window. You can choose window design from templates.</p>",expressTopBarTitle:"Top bar options",expressTopBarContent:"<ul><li>Review different screen sizes </li><li>Undo or Redo operations </li><li>Save, publish and preview the experience.</li><li>More</li></ul>",expressFullEditModeTitle:"Full mode",expressFullEditModeContent:"You can switch to full mode which allows advanced experience design.",expressEndGuideTitle:"Congratulations! You have completed the tour!",expressEndGuideContent:"Now start to build your experience. You can always return to the guide by clicking the Help button on the bottom left corner of the builder if you need a refresher."};var Ie=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};const Ee=p.esri.restRequest.request,{TYPE_KEYWORDS_OF_EXPRESS_APP:Oe}=p.CONSTANTS;function ke(e){return Ie(this,arguments,void 0,function*(e,t=!1,n=""){const i=p.SessionManager.getInstance().getMainSession();let o=null;const r=(null==n?void 0:n.includes("Template"))?l.TemplateType:l.ExperienceType,s=window.isExpressBuilder?'typekeywords: "ExpressExperienceApp"':'NOT typekeywords: "ExpressExperienceApp"';return yield xt({q:`type: "${r}" ${s} AND owner:${null==i?void 0:i.username} AND  title:"${e}"`,sortField:"modified",sortOrder:"desc"},c.Other).then(n=>Ie(this,void 0,void 0,function*(){const i=n.results;if(i&&i.length>0){const n=function(e,t){const n=[],i=/^[\d]+$/;return e.forEach(e=>{var o,r;const s=null===(r=null===(o=e.title)||void 0===o?void 0:o.split(`${t} `)[1])||void 0===r?void 0:r.split(" ")[0];i.test(s)&&n.push(Number(s))}),n.sort(function(e,t){return e<t?1:-1}),n[0]||1}(i,e);return o=nt(e,i,n,t),yield Promise.resolve(o)}return o=t?e:`${e} 1`,yield Promise.resolve(o)})).catch(e=>Ie(this,void 0,void 0,function*(){return console.error(e),yield Promise.reject(new Error(e))}))})}function Ue(e){return Ie(this,void 0,void 0,function*(){const{originAppInfo:t,folder:n,title:i,name:o,updateAppVersion:r,removeFaviconInConfig:s,isDuplicateApp:u,deleteThumbnail:a,appInfoItemForNewApp:c,retainsAppSummary:l}=e;return ke(`${i||t.title}`,u,t.type).then(e=>Ie(this,void 0,void 0,function*(){e=e||(null==t?void 0:t.title);const i={name:o||e,title:e,folder:n,includeResources:!0,copyPrivateResources:!0,f:"json"};return Se(t,Object.assign(Object.assign({},i),{authentication:p.SessionManager.getInstance().getMainSession()})).then(n=>{const i=n.itemId;return Ut({id:i}).then(n=>(e&&(n.title=e),function(e){return Ie(this,arguments,void 0,function*(e,t=!1,n,i=!1){const o=e.id;return function(e){return Ie(this,arguments,void 0,function*(e,t=!1,n,i=!1){const o=(null==n?void 0:n.typeKeywords)||(null==e?void 0:e.typeKeywords)||[],r=e.id,s=Be(o,e.type,t);return i||(e.snippet="",e.description=""),e.url="",e.clearEmptyFields=!0,n&&((null==n?void 0:n.typeKeywords)&&delete n.typeKeywords,e=Object.assign(Object.assign({},e),n)),e.typeKeywords=s,$t(e,e.owner).then(e=>Promise.resolve(r))})}(e,t,n,i).then(e=>Re(o))})}(n,r,c,l).then(e=>Le(i,t,!0,r,s).then(e=>a?be(n).then(e=>Promise.resolve(i)):Promise.resolve(i),e=>(_t(i),Promise.reject(new Error(e)))),e=>(_t(i),Promise.reject(new Error(e))))))},e=>Promise.reject(new Error(e)))}))})}function Me(e,t){return Ie(this,void 0,void 0,function*(){const n=["EXB Experience","Ready To Use","JavaScript","status: Draft",`version:${p.version}`];window.isExpressBuilder&&n.push(Oe);const i={title:null==e?void 0:e.name,type:(null==e?void 0:e.type)||"Web Experience",typeKeywords:n,snippet:(null==e?void 0:e.snippet)||"",description:(null==e?void 0:e.description)||"",tags:(null==e?void 0:e.tags)||[],text:{__not_publish:!0}};return yield(()=>Ie(this,void 0,void 0,function*(){return yield Promise.resolve(!1)}))().then(function(e){return Ie(this,void 0,void 0,function*(){return e?yield Promise.reject(new Error("app existed.")):yield Ge(i,t)})})})}function $e(e,t,n,i){return Ie(this,void 0,void 0,function*(){const o=p.moduleLoader.getModuleSync("jimu-for-builder").AppResourceManager.getInstance(),r=t.id;let s=p.utils.replaceI18nPlaceholdersInObject(e,p.i18n.getIntl(),Ce);return s=function(e){e.attributes||(e.attributes={});e.widgets||(e.widgets={});e.widgetsManifest||(e.widgetsManifest={});e.views||(e.views={});e.sections||(e.sections={});e.dialogs||(e.dialogs={});e.pages||(e.pages={});e.layouts||(e.layouts={});e.dataSources||(e.dataSources={});e.messageConfigs||(e.messageConfigs={});return e}(s),p.appConfigUtils.addWebmapOrWebsceneToAppConfig(s,n,i,!0),o.uploadAppConfig(r.toString(),s).then(()=>Ie(this,void 0,void 0,function*(){return yield Promise.resolve(t)}))})}function De(e){return Ie(this,void 0,void 0,function*(){return yield function(e){return Ie(this,void 0,void 0,function*(){const t=(0,p.getAppStore)().getState().portalUrl,n={id:e,portalUrl:t,isLocalApp:!1};return yield Ut(n).then(e=>Ie(this,void 0,void 0,function*(){return yield Promise.resolve(n)})).catch(e=>Ie(this,void 0,void 0,function*(){return yield Promise.reject(new Error("Item does not exist or is inaccessible."))}))})}(e).then(e=>Ie(this,void 0,void 0,function*(){return yield Promise.resolve(e)})).catch(t=>Ie(this,void 0,void 0,function*(){return yield function(e){return Ie(this,void 0,void 0,function*(){const t=(0,p.getAppStore)().getState().portalUrl;if(p.portalUrlUtils.isAGOLDomain(t))return yield Promise.reject(!1);const n={id:e,portalUrl:"https://maps.arcgis.com",isLocalApp:!1};return yield Ut(n).then(e=>Ie(this,void 0,void 0,function*(){return yield Promise.resolve(n)})).catch(e=>Ie(this,void 0,void 0,function*(){return yield Promise.reject(new Error("Item does not exist or is inaccessible."))}))})}(e).then(e=>Ie(this,void 0,void 0,function*(){return yield Promise.resolve(e)})).catch(t=>Ie(this,void 0,void 0,function*(){return yield function(e){return Ie(this,void 0,void 0,function*(){if(window.jimuConfig.isDevEdition){const t=(0,p.getAppStore)().getState().portalUrl,n={id:e,portalUrl:t,isLocalApp:!0};return yield Ut(n).then(e=>Ie(this,void 0,void 0,function*(){return(null==e?void 0:e.success)?yield Promise.resolve(n):yield Promise.reject(new Error("Item does not exist or is inaccessible."))})).catch(e=>Ie(this,void 0,void 0,function*(){return yield Promise.reject(new Error("Item does not exist or is inaccessible."))}))}return yield Promise.reject(new Error("Item does not exist or is inaccessible."))})}(e)}))}))})}function Ge(e,t){return Ie(this,void 0,void 0,function*(){return t?yield(n={item:e,folderId:t,authentication:p.SessionManager.getInstance().getMainSession()},p.esri.restPortal.createItemInFolder(n)):yield function(e){return de(this,void 0,void 0,function*(){return ve("createItem")(e)})}({item:e,authentication:p.SessionManager.getInstance().getMainSession()});var n})}function Re(e){return Ie(this,void 0,void 0,function*(){const t=p.SessionManager.getInstance().getMainSession();return yield ge({item:{id:e,owner:null==t?void 0:t.username,text:{__not_publish:!0}},authentication:p.SessionManager.getInstance().getMainSession()}).then(()=>Ie(this,void 0,void 0,function*(){return yield Promise.resolve(!0)}),e=>Ie(this,void 0,void 0,function*(){return console.error(e),yield Promise.reject(new Error(e))}))})}function Le(e,t){return Ie(this,arguments,void 0,function*(e,t,n=!1,i=!1,o=!1){return(n?we(t):bt(t)).then(r=>Ie(this,void 0,void 0,function*(){return yield function(e,t,n){return Ie(this,void 0,void 0,function*(){const i=se(t)+t+"/resources/",o=new RegExp("^"+i);function r(e){return o.test(e)}function s(n){return n.replace("/"+t+"/","/"+e+"/")}const u={matcher:r,handler:s};return Promise.resolve(p.utils.replaceStringInObject(n,u))})}(e,t.id,r).then(s=>Ie(this,void 0,void 0,function*(){const u=Ve(s,t,i,o);if((null==r?void 0:r.__not_publish)&&!n)return yield Promise.reject(new Error("This item is not published"));const a=p.SessionManager.getInstance().getMainSession(),c=null==a?void 0:a.username;return p.moduleLoader.getModuleSync("jimu-for-builder").AppResourceManager.getInstance().uploadAppConfig(e,u,c).then(()=>Ie(this,void 0,void 0,function*(){return yield Promise.resolve(e)}),e=>Ie(this,void 0,void 0,function*(){return console.error(e),yield Promise.reject(new Error(e))}))}))}),e=>Ie(this,void 0,void 0,function*(){return yield Promise.reject(new Error("Resource does not exist or is inaccessible"))}))})}function Fe(e,t,n){return Ie(this,void 0,void 0,function*(){const i=ie({portalUrl:window.jimuConfig.isDevEdition?"localhost:":(0,p.getAppStore)().getState().portalUrl}),o=ie(t);if(n){const r=`${se(t)}${t.id}/info/${n}?token=${null==o?void 0:o.token}`,s=`${se(t)}${t.id}/${n}`;let u;return u=(null==n?void 0:n.startsWith("blob:"))?n:(null==n?void 0:n.includes("http"))?`${n}?token=${null==o?void 0:o.token}`:oe(t)?r:s,yield new Promise(function(t,n){const o=new XMLHttpRequest;o.open("GET",u,!0),o.responseType="blob",o.onload=function(o){if(200===this.status){const o=this.response;return Gt({id:e,thumbnail:o,f:"json",token:null==i?void 0:i.token}).then(()=>{t(!0)},()=>{n(!1)})}n(!1)},o.onerror=function(e){n(new Error(null))},o.send()})}return Promise.resolve(!0)})}function _e(e,t=!1){let n=!1,i=e.typeKeywords||[];const o=qe(e);if(i=i.map(e=>(e.includes("status:")&&(n=!0),e.includes("status:")&&o!==d.Draft?`status: ${d.Changed}`:e.includes("version:")&&t?`version:${p.version}`:e)),!n){const e=`status: ${d.Draft}`;i.push(e)}return We(i)}function We(e=[]){let t=!1;if(e=e.map(e=>e.includes("modified:")?(t=!0,`modified: ${(new Date).getTime()}`):e),!t){const t=`modified: ${(new Date).getTime()}`;e.push(t)}return e}function qe(e){let t;return((null==e?void 0:e.typeKeywords)||[]).forEach(e=>{if(e.includes("status:")){switch(e.split(": ")[1]){case d.Published:t=d.Published;break;case d.Changed:t=d.Changed;break;case d.Draft:t=d.Draft}}}),t}function Be(e,t,n=!1){const i=`version:${p.version}`,o=window.isExpressBuilder&&!(null==e?void 0:e.includes(Oe));if(!e||0===e.length){const e=["EXB Experience","Ready To Use","JavaScript","status: Draft",i];return o&&e.push(Oe),e}let r=!1,s=!1,u=e.map(e=>n&&e.includes("version:")?(s=!0,`version:${p.version}`):(e.includes("version:")&&(s=!0),!t||e!==l.ExperienceType&&e!==l.TemplateType?e.includes("status:")?(r=!0,"status: Draft"):e:t));return u=u.filter(e=>!e.includes("publishVersion:")&&!e.includes("Registered App")&&!e.includes("App Proxy")),!r&&u.push("status: Draft"),!s&&u.push(i),o&&u.push(Oe),u=Array.from(new Set(u)),u}function Ne(e,t){return Object.values(e.widgets).forEach(e=>{"widgets/common/text/"===e.uri&&function(e,t){const n=t.type===l.TemplateType;if(n)return e;tt(null==e?void 0:e.text)||delete e.placeholder}(e.config,t)}),e}function Ke(e){var t;if(!e)return null;p.semver.lt(p.version,null==e?void 0:e.exbVersion)&&(e=e.set("exbVersion",p.version));const n=(null===(t=(0,p.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig).widgets||{};return Object.keys(n).forEach(t=>{var i,o,r;const s=null===(o=null===(i=n[t])||void 0===i?void 0:i.manifest)||void 0===o?void 0:o.version;if(s&&p.semver.valid(s)){p.semver.lt(s,null===(r=n[t])||void 0===r?void 0:r.version)&&(e=e.setIn(["widgets",t,"version"],s))}}),e}function Ve(e,t,n=!1,i=!1){var o,r,s,u,a;let c=function(e,t){var n;const i=(0,p.getAppStore)().getState().portalUrl;if(e.attributes?e.attributes.portalUrl=(0,p.getAppStore)().getState().portalUrl:e.attributes={portalUrl:(0,p.getAppStore)().getState().portalUrl},!t||!(null==t?void 0:t.id))return e;const o=null==e?void 0:e.dataSources;if(o&&ue(t))for(const e in o)Je(null===(n=o[e])||void 0===n?void 0:n.portalUrl)&&(o[e].portalUrl=i);return e}(e,t);!(null==t?void 0:t.id)&&(null==t?void 0:t.template)?c.template=null==t?void 0:t.template:(null==t?void 0:t.id)&&(c.template=null==t?void 0:t.id),delete c.appProxies,delete c.historyLabels,n&&(c=null===(o=Ke((0,p.Immutable)(c)))||void 0===o?void 0:o.asMutable({deep:!0})),i&&(null===(r=null==c?void 0:c.attributes)||void 0===r?void 0:r.favicon)&&delete c.attributes.favicon,c=function(e){return Object.keys(e.widgets).forEach(t=>{const n=e.widgets[t];n.itemId&&n.uri&&delete n.uri}),e}(c);const l=(new Date).getTime();c.timestamp=`${l}`;const d=null===(u=null===(s=(0,p.getAppStore)().getState().portalSelf)||void 0===s?void 0:s.portalProperties)||void 0===u?void 0:u.sharedTheme;return e.sharedThemeVariables=p.sharedThemeUtils.createSharedThemeVariables(d),window.isExpressBuilder&&(null===(a=null==e?void 0:e.forBuilderAttributes)||void 0===a?void 0:a.lockLayout)&&(e.forBuilderAttributes.lockLayout=!1),e.mainLocale=window.locale,e}function Ye(e){return Ie(this,void 0,void 0,function*(){const t=p.SessionManager.getInstance(),n=(new Date).getTime();return window.jimuConfig.isDevEdition?yield window.fetch(`${window.jimuConfig.mountPath}apps/${e}/resources/config/config.json`).then(e=>Ie(this,void 0,void 0,function*(){return yield e.json()})):yield Ee(`${p.portalUrlUtils.getPortalRestUrl((0,p.getAppStore)().getState().portalUrl)}/content/items/${e}/resources/config/config.json`,{authentication:t.getSessionByUrl((0,p.getAppStore)().getState().portalUrl),httpMethod:"GET",params:{timestamp:n}}).catch(e=>Ie(this,void 0,void 0,function*(){return Promise.reject(new Error(e))}))})}function Je(e){let t=!1;const n=(0,p.getAppStore)().getState().portalUrl;return(it(n,e,"mapsdevext.arcgis.com")||it(n,e,"mapsqa.arcgis.com")||it(n,e,"maps.arcgis.com"))&&(t=!0),t}function ze(e){const t={};return Object.keys(e).forEach(n=>{t[n]=Object.assign({},e[n])}),t}function He(e){let t;const n=(0,p.getAppStore)().getState().portalUrl,i=p.SessionManager.getInstance().getMainSession(),o=p.portalUrlUtils.isAGOLDomain(n);switch(e){case c.Portal:t=i;break;case c.AGOL:t=o?i:{};break;case c.Other:t=window.jimuConfig.isDevEdition?{}:i}return t}function Qe(e=[]){return(null==e?void 0:e.includes(Oe))&&(e=null==e?void 0:e.filter(e=>e!==Oe)),e}function Xe(e,t){const n=e.historyLabels;Object.keys(n[t]||{}).forEach(i=>{var o;(null===(o=e[t])||void 0===o?void 0:o[i])||delete n[t][i]})}function Ze(e,t,n){const i=e[n],o=t[n];i&&o&&Object.keys(i).forEach(r=>{var s,u;const a=(null===(u=null===(s=t.historyLabels)||void 0===s?void 0:s[n])||void 0===u?void 0:u[r])||[];o[r]&&i[r].label!==o[r].label&&(a.includes(o[r].label)||a.push(o[r].label)),a.length>0&&(e.historyLabels?e.historyLabels[n]?e.historyLabels[n][r]=a:e.historyLabels[n]={[r]:a}:e.historyLabels={[n]:{[r]:a}})})}const et=/<[^>]*>/g,tt=e=>{if(!e)return!0;if("<p></p>"===e||"<p><br></p>"===e)return!0;let t="";return t=e.includes("<")?function(e){let t;do{t=e,e=e.replace(et,"")}while(e!==t);return e}(e):e,t=null==t?void 0:t.trim(),!t};function nt(e,t,n=1,i=!1){const o=1===n&&i?e:`${e} ${n}`;if(!function(e,t){let n=!1;return t.forEach(t=>{e===t.title&&(n=!0)}),n}(o,t))return o;return nt(e,t,n+1)}function it(e,t,n){return((null==e?void 0:e.endsWith(n))||(null==e?void 0:e.endsWith(`${n}/`)))&&((null==t?void 0:t.endsWith(n))||(null==t?void 0:t.endsWith(`${n}/`)))}var ot=o(884),rt=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};function st(e){return rt(this,void 0,void 0,function*(){const{originalAppInfo:t,useDraftConfig:n,updateAppConfigVersion:i,isRemoveFaviconInConfig:o,folderId:r}=e;return Ut(t).then(s=>rt(this,void 0,void 0,function*(){if(s){const u=(null==e?void 0:e.type)||l.ExperienceType;return ke(s.title).then(e=>rt(this,void 0,void 0,function*(){if(e){return function(e,t,n,i){return rt(this,void 0,void 0,function*(){const o=i||e.type||"Web Experience";return Ge({title:e.name,type:o,typeKeywords:Be(null==e?void 0:e.typeKeywords,o,n),snippet:(null==e?void 0:e.snippet)||"",description:(null==e?void 0:e.description)||"",tags:e.tags,thumbnail:e.thumbnail},t)})}({name:e,tags:s.tags,thumbnail:s.thumbnail,type:u,typeKeywords:null==t?void 0:t.typeKeywords},r).then(e=>rt(this,void 0,void 0,function*(){if(e){return function(e){return rt(this,void 0,void 0,function*(){const{newAppId:t}=e;return Re(t).then(t=>rt(this,void 0,void 0,function*(){return t?function(e){return rt(this,void 0,void 0,function*(){const{newAppId:t,originalAppInfo:n,useDraftConfig:i,updateAppConfigVersion:o,isRemoveFaviconInConfig:r}=e;return Le(t,n,i,o,r).then(e=>rt(this,void 0,void 0,function*(){return function(e,t){return rt(this,void 0,void 0,function*(){const n=ie(t);return function(e,t){return de(this,void 0,void 0,function*(){return ve("getItemResources",e)(e.id,t,ue(e))})}(t,{authentication:n}).then(n=>rt(this,void 0,void 0,function*(){const i=[],o=n&&n.resources;if(o)for(let n=0;n<o.length;n++){"config/config.json"===o[n].resource||i.push(ut(e,t,o[n]))}return Promise.all(i)}),e=>rt(this,void 0,void 0,function*(){return Promise.resolve(null)}))})}(t,n).then(e=>rt(this,void 0,void 0,function*(){return e?Promise.resolve(!0):Promise.reject(new Error("Resource does not exist or is inaccessible"))}),e=>rt(this,void 0,void 0,function*(){return Promise.reject(new Error(e))}))}))})}(e):Promise.reject(new Error(null))}),e=>rt(this,void 0,void 0,function*(){return Promise.reject(new Error(e))}))})}({newAppId:e.id,originalAppInfo:t,useDraftConfig:n,updateAppConfigVersion:i,isRemoveFaviconInConfig:o}).then(()=>rt(this,void 0,void 0,function*(){return Promise.resolve(e.id)}),t=>rt(this,void 0,void 0,function*(){return console.error(t),_t(e.id),Promise.reject(new Error(t))}))}return Promise.reject(new Error(null))}))}return Promise.reject(new Error(null))}))}return Promise.reject(new Error(null))}))})}function ut(e,t,n){return rt(this,void 0,void 0,function*(){const i=ie(t),o=oe(t)?`?token=${null==i?void 0:i.token}`:"",r=`${se(t)}${t.id}/resources/`,s=ie({portalUrl:window.jimuConfig.isDevEdition?"localhost:":(0,p.getAppStore)().getState().portalUrl}),u=r+n.resource+o;return yield new Promise(function(t,i){const o=new XMLHttpRequest;o.open("GET",u,!0),o.responseType="blob",o.onload=function(i){if(200===this.status){const i=this.response;return function(e){return de(this,void 0,void 0,function*(){return ve("addItemResource")(e)})}({id:e,resource:i,name:n.resource.split("/")[n.resource.split("/").length-1],params:{resourcesPrefix:n.resource.split("/").slice(0,n.resource.split("/").length-1).join("/")},authentication:s}).then(()=>{t(!0)},()=>{t(!1)})}t(!1)},o.onerror=function(e){t(!1)},o.send()})})}var at=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};function ct(e,t){return at(this,void 0,void 0,function*(){return st({originalAppInfo:e,useDraftConfig:!1,updateAppConfigVersion:!1,isRemoveFaviconInConfig:!0,folderId:t,type:l.ExperienceType})})}function lt(e){return at(this,void 0,void 0,function*(){return yield De(e).then(e=>at(this,void 0,void 0,function*(){return yield ct(e)}))})}function dt(e,t,n,i,o){return at(this,void 0,void 0,function*(){return yield ke(e).then(e=>at(this,void 0,void 0,function*(){if(e){const r={template:t,name:e,description:"",type:l.ExperienceType};return yield Promise.all([At(r)]).then(function(e){return at(this,void 0,void 0,function*(){let t=e[0];return t=Ve(t,r,!1,!0),yield Me(r,n).then(e=>at(this,void 0,void 0,function*(){return yield $e(t,e,i,o)}))})}).catch(e=>at(this,void 0,void 0,function*(){return console.error(e),yield Promise.reject(new Error(e))}))}return yield Promise.reject(new Error(null))}))})}function pt(e,t){return at(this,void 0,void 0,function*(){return st({originalAppInfo:e,useDraftConfig:!0,updateAppConfigVersion:!0,isRemoveFaviconInConfig:!0,folderId:t,type:l.TemplateType})})}var ft=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};function vt(e,t,n){return ft(this,void 0,void 0,function*(){return yield Ut(e).then(i=>ft(this,void 0,void 0,function*(){if(i){i.isLocalApp=null==e?void 0:e.isLocalApp;const o=p.i18n.getIntl().formatMessage({id:"copy"})||"copy",r=n?i.title:`${i.title} ${o}`;return Ue({originAppInfo:i,folder:t,title:r,newAppType:i.type,isDuplicateApp:!0,updateAppVersion:!1,useDraftConfig:!0,removeFaviconInConfig:!1,deleteThumbnail:!1,retainsAppSummary:!0}).then(e=>Promise.resolve(e))}return yield Promise.reject(new Error(null))}))})}function ht(e){return ft(this,void 0,void 0,function*(){return(null==e?void 0:e.transferDirectly)?function(e){return Ie(this,void 0,void 0,function*(){const t=Qe(null==e?void 0:e.typeKeywords);return e.typeKeywords=t,$t(Object.assign(Object.assign({},e),{thumbnailurl:void 0}),e.owner).then(t=>Promise.resolve({appInfo:e}))})}(e.appInfo):function(e){return Ie(this,void 0,void 0,function*(){const t=e.appInfo;return vt(t,null,!0).then(e=>Ut({id:e}).then(n=>Ie(this,void 0,void 0,function*(){const i=n,o=Qe(null==i?void 0:i.typeKeywords);return i.typeKeywords=o,i.snippet=null==t?void 0:t.snippet,$t({id:e,typeKeywords:o},i.owner).then(t=>({id:e,appInfo:i}))})))})}(e)})}function gt(e){return ft(this,void 0,void 0,function*(){const t=p.SessionManager.getInstance().getMainSession();return yield function(e,t){return de(this,void 0,void 0,function*(){return pe(e,t)})}(e,{authentication:t})})}function mt(e){return ft(this,void 0,void 0,function*(){const t=p.SessionManager.getInstance().getMainSession();return yield function(e,t){return de(this,void 0,void 0,function*(){return fe(e,t)})}(e,{authentication:t})})}function yt(e){return ft(this,void 0,void 0,function*(){return st({originalAppInfo:e,useDraftConfig:!0,updateAppConfigVersion:!1,isRemoveFaviconInConfig:!0,type:e.type})})}function wt(e,t,n,i){return ft(this,void 0,void 0,function*(){const o=p.SessionManager.getInstance().getMainSession(),r=p.moduleLoader.getModuleSync("jimu-for-builder").AppResourceManager,s=p.moduleLoader.getModuleSync("jimu-for-builder").appConfigUtils,u=p.ExtensionManager.getInstance().getExtensions(p.extensionSpec.ExtensionPoints.BuilderOperations).sort((e,t)=>(e.index||0)-(t.index||0));for(const e of u)if(e.beforeSave)try{t=yield e.beforeSave(t)}catch(e){return console.error("Invoke beforeSave error.",e),Promise.reject(new Error(e))}const a=(null==e?void 0:e.owner)||o.username,c=Object.assign({},s.getCleanAppConfig(t)),l=r.getInstance();if(c)try{yield l.uploadAppConfig(e.id,c,a);const o=[],{imageResources:r,iconResources:s}=l.getResourcesInDraft();if(r&&o.push(l.uploadImageResourceList(ze(r),i)),s&&o.push(l.uploadIconResourceList(ze(s),i)),t.translationJsons&&o.push(l.updateConfigTranslationResourceList(t.translationJsons,!0)),n){const t=_e(e,!0);e.typeKeywords=t}else{const t=We(e.typeKeywords);e.typeKeywords=t}o.push(Dt(e)),yield Promise.all(o)}catch(e){yield Promise.reject(new Error(e))}else yield Promise.reject(new Error(null))})}function St(e,t,n,i,o){return ft(this,void 0,void 0,function*(){return Ue({originAppInfo:e,folder:n,title:t.title,name:t.title,updateAppVersion:!0,useDraftConfig:!0,removeFaviconInConfig:!1,appInfoItemForNewApp:t}).then(t=>{const r=p.SessionManager.getInstance().getMainSession();return ye({id:t},{authentication:r}).then(r=>ft(this,void 0,void 0,function*(){return function(e,t,n){return Ie(this,void 0,void 0,function*(){if(!n)return yield Fe(t.id,e,(null==e?void 0:e.thumbnailurl)||e.thumbnail);{const e=p.SessionManager.getInstance().getMainSession(),i={id:t.id,f:"json",token:null==e?void 0:e.token,thumbnail:n};yield Gt(i,t.owner)}})}(e,r,i).then(()=>ft(this,void 0,void 0,function*(){var e;let i=(0,p.getAppStore)().getState().appStateInBuilder.appConfig;i=Ke(i);const s=null==i?void 0:i.asMutable({deep:!0});return delete s.appProxies,delete s.historyLabels,o&&(null===(e=null==s?void 0:s.forBuilderAttributes)||void 0===e?void 0:e.lockLayout)&&(s.forBuilderAttributes.lockLayout=!1),wt(r,(0,p.Immutable)(s),!1,t).then(()=>ft(this,void 0,void 0,function*(){return Ye(t).then(e=>ft(this,void 0,void 0,function*(){return"/"===n&&n!==r.ownerFolder&&r.ownerFolder?Ft({itemId:t,folderId:"/",authentication:null}).then(n=>Promise.resolve({id:t,appConfig:e,appInfo:r})):Promise.resolve({id:t,appConfig:e,appInfo:r})}))}),e=>(console.error(e),_t(t),Promise.reject(new Error(e))))}))}),e=>Promise.reject(new Error(e)))})})}function bt(e){return ft(this,void 0,void 0,function*(){const t=ie(e);return yield function(e,t){return de(this,void 0,void 0,function*(){return ve("getItemData",e)(e.id,t,ue(e))})}(e,{authentication:t}).then(e=>ft(this,void 0,void 0,function*(){return yield Promise.resolve(e)}),e=>ft(this,void 0,void 0,function*(){return yield Promise.reject(new Error(e))}))})}function Pt(e){return ft(this,void 0,void 0,function*(){return yield we(e).then(e=>ft(this,void 0,void 0,function*(){return yield Promise.resolve(e)}),e=>ft(this,void 0,void 0,function*(){return yield Promise.reject(new Error(e))}))})}function At(e){return ft(this,void 0,void 0,function*(){return(0,ot.getTemplateConfig)(ot.TemplateType.App,e.template)})}function xt(e,t){return ft(this,void 0,void 0,function*(){const n=He(t);return yield he(Object.assign(Object.assign({},e),{authentication:n}),t).then(e=>ft(this,void 0,void 0,function*(){return yield Promise.resolve(e)}))})}function Tt(e,t){return ft(this,void 0,void 0,function*(){const n=(0,p.getAppStore)().getState().portalUrl;if(t===n){const t=He(c.Portal);e.authentication=t}return yield function(e,t){return de(this,void 0,void 0,function*(){return g(e,t)})}(e,t).then(e=>ft(this,void 0,void 0,function*(){return yield Promise.resolve(e)}))})}function jt(e,t){return ft(this,void 0,void 0,function*(){const n=p.SessionManager.getInstance().getMainSession();return yield Pe(e,{authentication:n},t).then(e=>ft(this,void 0,void 0,function*(){return yield Promise.resolve(e)}))})}function Ct(e){return ft(this,void 0,void 0,function*(){const t=p.SessionManager.getInstance().getMainSession();return yield function(e,t){return de(this,void 0,void 0,function*(){return yield te(e,t)})}({authentication:t},e).then(e=>ft(this,void 0,void 0,function*(){return yield Promise.resolve(e)}))})}function It(e,t,n){return ft(this,void 0,void 0,function*(){const i=p.SessionManager.getInstance().getMainSession();return yield function(e,t,n){return de(this,void 0,void 0,function*(){return yield H(e,t,n)})}(e,{params:t,authentication:i},n).then(e=>ft(this,void 0,void 0,function*(){return yield Promise.resolve(e)}))})}function Et(e){return ft(this,void 0,void 0,function*(){return je(e).then(e=>ft(this,void 0,void 0,function*(){const t=(null==e?void 0:e.folders)||[];return yield Promise.resolve(t)}),e=>ft(this,void 0,void 0,function*(){return yield Promise.reject(new Error(e))}))})}function Ot(e){return ft(this,void 0,void 0,function*(){return yield function(e){return de(this,void 0,void 0,function*(){return ve("getUserTags")(e)})}({username:e,authentication:p.SessionManager.getInstance().getMainSession()})})}function kt(e){return ft(this,void 0,void 0,function*(){return yield function(e){return de(this,void 0,void 0,function*(){return yield p.esri.restPortal.searchGroups(e)})}(e)})}function Ut(e){return ft(this,void 0,void 0,function*(){const t=ie(e);return yield ye(e,{authentication:t}).then(e=>ft(this,void 0,void 0,function*(){return yield Promise.resolve(e)}))})}function Mt(e){return ft(this,void 0,void 0,function*(){return yield Te(e).then(e=>ft(this,void 0,void 0,function*(){return yield Promise.resolve(e)}))})}function $t(e,t){return ft(this,void 0,void 0,function*(){const n=p.SessionManager.getInstance().getMainSession();return t?yield ge({item:e,owner:t,authentication:n}).then(()=>null):Promise.reject(new Error("Missing owner, cannot update app info"))})}function Dt(e){return ft(this,void 0,void 0,function*(){return $t(Object.assign(Object.assign({},e),{thumbnailurl:void 0}),e.owner).then(t=>{var n;const i=null==e?void 0:e.thumbnailurl,o=null===(n=(0,p.getAppStore)().getState().appRuntimeInfo)||void 0===n?void 0:n.saveThumbnailUrl;return i&&i!==o?((0,p.getAppStore)().dispatch(p.appActions.saveThumbnailUrl(i)),Fe(e.id,e,i)):Promise.resolve(!0)}).catch(e=>Promise.reject(new Error("Update appInfo error")))})}function Gt(e){return ft(this,arguments,void 0,function*(e,t=""){const n=p.SessionManager.getInstance().getMainSession();return yield me({item:e,authentication:n,owner:t}).then(()=>null)})}function Rt(e){return ft(this,void 0,void 0,function*(){return yield Ae(e).then(e=>ft(this,void 0,void 0,function*(){return yield Promise.resolve(e)}))})}function Lt(e){return ft(this,void 0,void 0,function*(){return yield xe(e).then(e=>ft(this,void 0,void 0,function*(){return yield Promise.resolve(e)}))})}function Ft(e){return ft(this,void 0,void 0,function*(){return yield function(e){return de(this,void 0,void 0,function*(){return yield p.esri.restPortal.moveItem(e)})}(Object.assign(Object.assign({},e),{authentication:p.SessionManager.getInstance().getMainSession()}))})}function _t(e){return ft(this,void 0,void 0,function*(){const t=p.SessionManager.getInstance().getMainSession();return yield ye({id:e},{authentication:t}).then(t=>ft(this,void 0,void 0,function*(){return yield function(e){return de(this,void 0,void 0,function*(){return ve("removeItem")(e)})}({id:e,owner:t.owner,authentication:p.SessionManager.getInstance().getMainSession()})}))})}function Wt(e){return ft(this,void 0,void 0,function*(){const t=yield Ye(e.id);let n=yield bt(e);const i=p.SessionManager.getInstance().getMainSession();if(t&&n){const o=p.ExtensionManager.getInstance().getExtensions(p.extensionSpec.ExtensionPoints.BuilderOperations).sort((e,t)=>(e.index||0)-(t.index||0));for(const e of o)if(e.beforePublish)try{n=yield e.beforePublish(n)}catch(e){return console.error("Invoke beforePublish error.",e),Promise.reject(new Error(e))}const r=function(e,t){let n=!1,i=!1;const o=e.map(e=>e.includes("status:")?(n=!0,`status: ${d.Published}`):e.includes("publishVersion:")&&t?(i=!0,`publishVersion:${t}`):e);if(!n){const e=`status: ${d.Published}`;o.push(e)}return!i&&t&&o.push(`publishVersion:${t}`),o}(null==e?void 0:e.typeKeywords,null==n?void 0:n.exbVersion),s=p.moduleLoader.getModuleSync("jimu-for-builder").AppResourceManager.getInstance(),u=s.uploadLocalResource(t);let a=Promise.resolve([]);return t.translationJsons&&(a=s.updateConfigTranslationResourceList(t.translationJsons,!1)),Promise.all([u,a]).then(t=>ft(this,[t],void 0,function*([t,o]){if(!t)return yield Promise.reject(new Error("Local resource upload failed"));if(!(0===o.length||o.every(e=>e.success)))return yield Promise.reject(new Error("Config translation update failed"));t=function(e,t){return t.__not_publish||(e.historyLabels&&(Xe(e,"pages"),Xe(e,"views"),Xe(e,"dialogs")),Ze(e,t,"pages"),Ze(e,t,"views"),Ze(e,t,"dialogs")),e}(t=Ne(t,e),n);const s=(new Date).getTime();t.publishTimestamp=s;const u=function(e){const{type:t,id:n}=e;return window.jimuConfig.isDevEdition?null:p.urlUtils.getAppUrl({id:n,type:t===l.TemplateType?"template":"app",target:"current_portal",isFullUrl:!0})}(e);return yield ge({item:{id:e.id,owner:e.owner||(null==i?void 0:i.username),text:t,typeKeywords:r,url:u},authentication:p.SessionManager.getInstance().getMainSession()}).then(()=>ft(this,void 0,void 0,function*(){const t=Object.assign(Object.assign({},e),{typeKeywords:r});return Promise.resolve(t)}),()=>ft(this,void 0,void 0,function*(){return yield Promise.reject(new Error(null))}))}),()=>ft(this,void 0,void 0,function*(){return yield Promise.reject(new Error(null))})).catch(e=>ft(this,void 0,void 0,function*(){return yield Promise.reject(new Error(e))}))}yield Promise.reject(new Error(null))})}var qt=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})};const Bt=p.esri.restRequest.request;var Nt;let Kt,Vt;function Yt(e,t){return qt(this,void 0,void 0,function*(){const n=p.SessionManager.getInstance().getMainSession(),{username:i}=n,o=(0,p.getAppStore)().getState().portalUrl,r=p.portalUrlUtils.getBaseUserUrl(o),s=yield tn.getInstance().getToken();let u;switch(t=null!=t?t:en(),e){case Nt.Add:u=r+"/"+i+"/addResource/?token="+s;break;case Nt.Remove:u=r+"/"+i+"/removeResource/?token="+s;break;case Nt.Get:u=r+"/"+i+"/resources/"+t+"?token="+s;break;case Nt.GetAll:u=r+"/"+i+"/resources/?token="+s}return yield Promise.resolve(u)})}function Jt(e,t){return qt(this,void 0,void 0,function*(){t=null!=t?t:en();const n={httpMethod:"POST",params:Object.assign(Object.assign({},e),{key:t,access:"UserPrivateAllApps"})};return yield Yt(Nt.Add).then(e=>qt(this,void 0,void 0,function*(){return yield Bt(e,n).then(e=>qt(this,void 0,void 0,function*(){return yield Promise.resolve(e)}))})).catch(e=>qt(this,void 0,void 0,function*(){return yield Promise.reject(new Error("Failed adding user resource:"+e.message))}))})}function zt(e){return qt(this,void 0,void 0,function*(){return e=null!=e?e:en(),yield Yt(Nt.Get,e).then(e=>qt(this,void 0,void 0,function*(){return yield Bt(e,{params:{f:"json"}}).then(e=>qt(this,void 0,void 0,function*(){return yield Promise.resolve(e)}))})).catch(e=>qt(this,void 0,void 0,function*(){return yield Promise.reject(new Error("Failed retrieving user resource:"+e.message))}))})}function Ht(){return qt(this,void 0,void 0,function*(){return yield Yt(Nt.GetAll).then(e=>qt(this,void 0,void 0,function*(){return yield Bt(e,{params:{f:"json"}}).then(e=>qt(this,void 0,void 0,function*(){return yield Promise.resolve(e)}))})).catch(e=>qt(this,void 0,void 0,function*(){return yield Promise.reject(new Error("Failed retrieving user resource list:"+e.message))}))})}function Qt(e){return qt(this,void 0,void 0,function*(){return e=null!=e?e:en(),yield Yt(Nt.Remove).then(t=>qt(this,void 0,void 0,function*(){const n={params:{key:e}};return yield Bt(t,n).then(e=>qt(this,void 0,void 0,function*(){return yield Promise.resolve(e)}))})).catch(e=>qt(this,void 0,void 0,function*(){return yield Promise.reject(new Error("Failed removing user resource:"+e.message))}))})}function Xt(e){return qt(this,void 0,void 0,function*(){return yield zt().then(t=>qt(this,void 0,void 0,function*(){const n=(0,p.Immutable)(null!=t?t:{}).merge(e,{deep:!0});return yield Jt({text:JSON.stringify(Object.assign({},n))})})).then(e=>qt(this,void 0,void 0,function*(){return yield Promise.resolve(e)})).catch(e=>qt(this,void 0,void 0,function*(){return yield Promise.reject(new Error("Failed updating user resource:"+e.message))}))})}function Zt(){return Kt||(Kt=Ht().then(e=>qt(this,void 0,void 0,function*(){if(0===e.total)return yield Jt({text:"{}"});{const t=e.userResources[0],n=en();return t.key===n?yield Promise.resolve({success:!0}):yield zt(t.key).catch(e=>null).then(e=>qt(this,void 0,void 0,function*(){return e&&(e.showGuides||0===Object.keys(e).length)?yield Qt(t.key).then(()=>qt(this,void 0,void 0,function*(){return yield Jt({text:JSON.stringify(Object.assign({},e))})})):yield Jt({text:"{}"})}))}})).catch(e=>qt(this,void 0,void 0,function*(){return yield Promise.reject(new Error("Failed initializing user resource:"+e.message))}))),Promise.resolve(Kt)}function en(){if(!Vt){const e=p.SessionManager.getInstance().getMainSession();Vt=`${p.USER_SETTING_FILE_KEY}${(null==e?void 0:e.clientId)?`_${e.clientId}`:""}.json`}return Vt}!function(e){e.Add="ADD",e.Remove="REMOVE",e.Get="GET",e.GetAll="GETALL"}(Nt||(Nt={}));class tn{static getInstance(){return tn.instance||(tn.instance=new tn),tn.instance}constructor(){this.session=p.SessionManager.getInstance().getMainSession()}_shouldExchangeToken(){return qt(this,void 0,void 0,function*(){if(!this.exchangedToken||this.session.tokenExpires<new Date){if(!this.portalSelfPromise){const e=(0,p.getAppStore)().getState().portalUrl;this.portalSelfPromise=Bt(`${e}/sharing/rest/community/self?token=${this.session.token}`).then(e=>qt(this,[e],void 0,function*({appInfo:e}){return yield Promise.resolve("experienceBuilder"!==(null==e?void 0:e.appId))})).catch(e=>qt(this,void 0,void 0,function*(){return yield Promise.reject(new Error(e.message))}))}return yield this.portalSelfPromise}return yield Promise.resolve(!1)})}_exchangeToken(){return qt(this,void 0,void 0,function*(){const e=(0,p.getAppStore)().getState().portalUrl+"/sharing/rest/oauth2/exchangeToken",t={params:{client_id:this.session.clientId,token:this.session.token}};return yield Bt(e,t)})}getToken(){return qt(this,void 0,void 0,function*(){var e;return(yield this._shouldExchangeToken())?yield this._exchangeToken().catch(e=>(console.warn("Failed exchanging token. Using default token from user session."),{token:this.session.token})).then(e=>qt(this,void 0,void 0,function*(){return this.exchangedToken=null==e?void 0:e.token,yield Promise.resolve(this.exchangedToken)})):yield Promise.resolve(null!==(e=this.exchangedToken)&&void 0!==e?e:this.session.token)})}}return r})())}}});
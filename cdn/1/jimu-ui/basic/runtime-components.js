System.register(["jimu-core","jimu-core/emotion","jimu-layouts/layout-runtime","jimu-theme","jimu-ui"],function(e,t){var s={},i={},a={},l={},o={};return{setters:[function(e){s.CONSTANTS=e.CONSTANTS,s.DataSourceComponent=e.DataSourceComponent,s.DataSourceManager=e.DataSourceManager,s.DataSourceTypes=e.DataSourceTypes,s.EsriFieldType=e.EsriFieldType,s.Immutable=e.Immutable,s.JimuFieldType=e.JimuFieldType,s.LayoutItemType=e.LayoutItemType,s.MultipleDataSourceComponent=e.MultipleDataSourceComponent,s.React=e.React,s.ReactRedux=e.ReactRedux,s.SupportedUtilityType=e.SupportedUtilityType,s.UtilityManager=e.UtilityManager,s.classNames=e.classNames,s.dataSourceUtils=e.dataSourceUtils,s.defaultMessages=e.defaultMessages,s.getAppStore=e.getAppStore,s.injectIntl=e.injectIntl,s.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules,s.utils=e.utils},function(e){i.jsx=e.jsx,i.jsxs=e.jsxs},function(e){a.searchUtils=e.searchUtils},function(e){l.withStyles=e.withStyles,l.withTheme=e.withTheme},function(e){o.AdvancedSelect=e.AdvancedSelect,o.Button=e.Button,o.Icon=e.Icon,o.Select=e.Select,o.TextInput=e.TextInput,o.defaultMessages=e.defaultMessages}],execute:function(){e((()=>{var e={1888:e=>{"use strict";e.exports=l},7196:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="m5.635 9.86 2.168-2.18L8 7.471q.102-.11.185-.233t.138-.258a.7.7 0 0 0 .055-.283.73.73 0 0 0-.244-.558.8.8 0 0 0-.256-.151.9.9 0 0 0-.312-.054.82.82 0 0 0-.583.214.92.92 0 0 0-.276.573l-.993-.082q.03-.401.185-.709.153-.307.398-.512.244-.205.568-.311A2.2 2.2 0 0 1 7.566 5q.38 0 .706.102.327.103.572.304.244.2.386.512.142.311.142.73 0 .549-.24.946-.24.398-.62.758l-1.726 1.664h2.586v.886H5.635zM3.6 6.23 2.55 7.238 2 6.558l1.687-1.46h.86v5.804H3.6zm8.23 1.204h-.244v.886h.229q.212 0 .434.032.22.033.398.128a.8.8 0 0 1 .292.27q.114.177.114.455 0 .204-.075.373a.9.9 0 0 1-.205.287.986.986 0 0 1-.658.25q-.379 0-.6-.197a1.05 1.05 0 0 1-.307-.557l-1.01.278q.096.36.277.62.18.257.43.421.247.164.555.242.307.078.655.078.37 0 .713-.11.343-.111.603-.328.261-.217.414-.537.154-.321.154-.738 0-.54-.276-.935-.276-.393-.812-.475v-.016q.45-.115.702-.48.252-.364.252-.832a1.41 1.41 0 0 0-.536-1.16 1.7 1.7 0 0 0-.568-.29A2.4 2.4 0 0 0 12.076 5q-.307 0-.591.074-.285.074-.52.225-.237.151-.41.39a1.8 1.8 0 0 0-.268.557l1 .279a.95.95 0 0 1 .328-.472.83.83 0 0 1 .508-.168q.355 0 .576.213a.73.73 0 0 1 .22.55.8.8 0 0 1-.094.418.64.64 0 0 1-.248.237 1 1 0 0 1-.347.107 3 3 0 0 1-.398.024" clip-rule="evenodd"></path></svg>'},14321:e=>{"use strict";e.exports=o},18348:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M12.89 6.032q.214.113.442.452l.574-.58q-.31-.493-.67-.698A1.55 1.55 0 0 0 12.454 5q-.48 0-.882.214a2.05 2.05 0 0 0-.69.609 3 3 0 0 0-.454.955 4.4 4.4 0 0 0-.165 1.246q0 .669.165 1.218.164.549.453.94t.691.604.882.214q.456 0 .86-.242.405-.242.686-.774l-.61-.597q-.204.363-.441.528a.85.85 0 0 1-.49.166q-.321 0-.582-.162a1.5 1.5 0 0 1-.448-.443 2.2 2.2 0 0 1-.29-.67 3.3 3.3 0 0 1-.102-.846q0-.427.102-.799.102-.37.29-.649.187-.277.448-.435.26-.158.583-.158.216 0 .43.113m-8.448-.887h-.638L2 10.855h.826L3.2 9.548h1.798l.386 1.307h.843zm-.34 1.21.639 2.322H3.452zm2.59-1.21h1.615q.235 0 .463.077.228.076.407.25.18.173.29.447.111.275.111.662 0 .483-.199.798t-.521.452v.016a.9.9 0 0 1 .36.149q.167.117.284.298.117.182.185.42.067.237.067.512 0 .468-.135.778t-.354.5a1.3 1.3 0 0 1-.504.27 2.1 2.1 0 0 1-.577.08H6.691zm1.41 2.323H7.43V6.016h.61q.42 0 .611.182.19.18.19.552a.73.73 0 0 1-.184.52q-.185.198-.554.198M7.43 9.984h.68q.14 0 .301-.024a.675.675 0 0 0 .518-.367.96.96 0 0 0 .088-.448q0-.45-.214-.629-.213-.177-.664-.177h-.709z" clip-rule="evenodd"></path></svg>'},41496:e=>{"use strict";e.exports=a},50170:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0m-1.27 4.936a6.5 6.5 0 1 1 .707-.707l4.136 4.137a.5.5 0 1 1-.707.707z" clip-rule="evenodd"></path></svg>'},54663:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M5.5 1a.5.5 0 0 0-.5.5V2H2a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1h-3v-.5a.5.5 0 0 0-1 0V2H6v-.5a.5.5 0 0 0-.5-.5M10 3.5V3H6v.5a.5.5 0 0 1-1 0V3H2v2h12V3h-3v.5a.5.5 0 0 1-1 0M14 6H2v8h12zM5 8.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m.5 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1z" clip-rule="evenodd"></path></svg>'},60659:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M10.5 1a.5.5 0 0 1 .5.5V2h3a1 1 0 0 1 1 1v5.672A4.5 4.5 0 0 1 8.673 15H2a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h3v-.5a.5.5 0 0 1 1 0V2h4v-.5a.5.5 0 0 1 .5-.5m1 7a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7M2 14h5.759a4.5 4.5 0 0 1 6.249-6.236L14 7.758V6H2zm0-9h12V3h-3v.5a.5.5 0 0 1-1 0V3H6v.5a.5.5 0 0 1-1 0V3H2z" clip-rule="evenodd"></path><path fill="#000" d="M11.5 9a.5.5 0 0 1 .5.5V11h1.5a.5.5 0 0 1 0 1H11V9.5a.5.5 0 0 1 .5-.5"></path></svg>'},67386:e=>{"use strict";e.exports=i},75560:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M8.3 15.6A7.3 7.3 0 1 0 8.3 1a7.3 7.3 0 0 0 0 14.6M8.3 2A6.3 6.3 0 1 1 2 8.3 6.307 6.307 0 0 1 8.3 2m3.5 6.8h-4v-5h1v4h3z" clip-rule="evenodd"></path></svg>'},79244:e=>{"use strict";e.exports=s}},t={};function r(s){var i=t[s];if(void 0!==i)return i.exports;var a=t[s]={exports:{}};return e[s](a,a.exports,r),a.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};return(()=>{"use strict";r.r(n),r.d(n,{FieldSelector:()=>E,extractService:()=>P,getDsJsonOfOriginDs:()=>ce,getMultipleDefaultGeocodeConfigInRuntime:()=>ee,getNewDataSourceConfig:()=>de,getOutputDsJson:()=>pe,getZoomScaleOfUseUtility:()=>K,isUtilityMatch:()=>L,predefinedOrgUtilities:()=>_});var e=r(67386),t=r(79244),s=r(14321),i=r(7196),a=r.n(i),l=r(18348),o=r.n(l),d=r(60659),u=r.n(d),c=r(54663),p=r.n(c),h=r(75560),m=r.n(h);const g="CLICK_ME_TO_CLEAR_SELECTION";function v(e,i,l){if(!e||!i)return null;const r=l&&{[t.JimuFieldType.Number]:l.formatMessage({id:"numberField",defaultMessage:s.defaultMessages.numberField}),[t.JimuFieldType.String]:l.formatMessage({id:"stringField",defaultMessage:s.defaultMessages.stringField}),[t.JimuFieldType.Date]:l.formatMessage({id:"dateField",defaultMessage:s.defaultMessages.dateField}),[t.JimuFieldType.DateOnly]:l.formatMessage({id:"dateOnlyField",defaultMessage:s.defaultMessages.dateOnlyField}),[t.JimuFieldType.TimeOnly]:l.formatMessage({id:"timeOnlyField",defaultMessage:s.defaultMessages.timeOnlyField})},n={[t.JimuFieldType.Number]:a(),[t.JimuFieldType.String]:o(),[t.JimuFieldType.Date]:u(),[t.JimuFieldType.DateOnly]:p(),[t.JimuFieldType.TimeOnly]:m()},d={[t.JimuFieldType.Number]:i.sys.color.info.main,[t.JimuFieldType.String]:i.sys.color.success.main,[t.JimuFieldType.Date]:i.sys.color.warning.main,[t.JimuFieldType.DateOnly]:i.sys.color.warning.main,[t.JimuFieldType.TimeOnly]:i.sys.color.warning.main};return{icon:n[e],color:d[e],title:null==r?void 0:r[e]}}class S extends t.React.PureComponent{constructor(e){super(e),this.state={isOpen:!1}}render(){const i=this.props.fields;if(!i||!this.props.ds)return null;const a=i[g]?[g]:[];return(0,e.jsx)("div",{className:"field-list px-4",role:"menu",children:i&&a.concat(Object.keys(i).filter(e=>e!==g)).map(a=>{const l=v(i[a].type,this.props.theme,this.props.intl),o=this.props.selectedFields&&(this.props.isMultiple?this.props.selectedFields.some(e=>e===a):a===this.props.selectedFields[0]),r=i[a].alias||i[a].name;return(0,e.jsxs)(s.Button,{role:"menuitem"+(this.props.isMultiple?"checkbox":"radio"),title:r,"aria-checked":o,"aria-label":`${null==l?void 0:l.title} ${r}`,onClick:()=>{this.props.onFieldClick([i[a]])},className:(0,t.classNames)("field-item mt-2 py-1 px-2 d-flex w-100 align-items-center",{"field-item-selected":o}),children:[l&&(0,e.jsx)(s.Icon,{icon:l.icon,color:l.color,className:"mr-2 flex-shrink-0",size:16}),(0,e.jsx)("div",{className:"flex-grow-1 text-truncate",children:r})]},a)})})}}class f extends t.React.PureComponent{constructor(){super(...arguments),this.dropdownProps={autoWidth:!0},this.onChange=e=>{var s,i;const a=(null===(s=this.props.selectedFields)||void 0===s?void 0:s.asMutable().filter(e=>e!==g))||[],l=[],o=[];null===(i=this.props.disabledFields)||void 0===i||i.forEach(e=>{a.includes(e)?l.push(e):o.push(e)});const r=((null==e?void 0:e.map(e=>e.value))||[]).filter(e=>!o.includes(e)).concat(l),n=t.utils.diffArrays(!0,a,r),d=n.deleted.concat(n.added);d.length>0&&this.props.onFieldClick(d.map(e=>this.props.fields[e]))},this.getFields=()=>{if(this.props.fields){const e=[];return(this.props.fields[g]?[g]:[]).concat(Object.keys(this.props.fields).filter(e=>e!==g)).forEach(t=>{const s=this.getFieldItem(t);e.push(s)}),e}return[]},this.getSelectedFields=()=>{if(this.props.fields&&this.props.selectedFields){const e=[];return this.props.selectedFields.filter(e=>!!this.props.fields[e]).forEach(t=>{const s=this.getFieldItem(t);e.push(s)}),e}return[]},this.getFieldItem=t=>{var i,a,l,o;const r=(null===(i=this.props.fields[t])||void 0===i?void 0:i.alias)||(null===(a=this.props.fields[t])||void 0===a?void 0:a.name),n=v(null===(l=this.props.fields[t])||void 0===l?void 0:l.type,this.props.theme,this.props.intl);return{value:t,label:r,disabled:null===(o=this.props.disabledFields)||void 0===o?void 0:o.includes(t),render:()=>(0,e.jsxs)("div",{className:"d-flex justify-content-start align-items-center text-truncate","aria-label":`${null==n?void 0:n.title} ${r}`,children:[n&&(0,e.jsx)(s.Icon,{icon:n.icon,color:n.color,className:"d-inline-block mr-2",size:16}),(0,e.jsx)("div",{className:"text-truncate",title:r,children:r})]})}},this.toggleAdvancedSelect=e=>{this.props.toggle&&this.props.toggle(e)}}render(){if(!this.props.fields||!this.props.ds)return null;const t=this.props.dropdownProps?Object.assign(Object.assign({},this.props.dropdownProps),this.dropdownProps):this.dropdownProps;return(0,e.jsx)("div",{children:(0,e.jsx)(s.AdvancedSelect,Object.assign({size:"sm"},t,{staticValues:this.getFields(),sortList:!1,selectedValues:this.getSelectedFields(),onChange:this.onChange,placeholder:this.props.placeholder,isMultiple:this.props.isMultiple,hideSearchInput:this.props.isSearchInputHidden,hideBottomTools:!this.props.useMultiDropdownBottomTools,isEmptyOptionHidden:!0,title:this.getSelectedFields().map(e=>e.label).toString(),toggle:this.toggleAdvancedSelect}))})}}var D,I=r(41496),y=r(1888);function w(){const e=window&&window.jimuConfig&&window.jimuConfig.isBuilder?(0,t.getAppStore)().getState().appStateInBuilder:(0,t.getAppStore)().getState();return e&&e.appConfig}!function(e){e.First="POPULATED_VIEW_SELECTION_DEFAULT",e.Second="VIEW_DEFAULT_SELECTION_POPULATED"}(D||(D={}));const T="USE_MAIN_DATA_SOURCE";class F extends t.React.PureComponent{constructor(){super(...arguments),this.getWhetherUseDsIsShallowEqual=(e,t)=>{let s=!1;return e&&t&&e.length===t.length&&(s=!e.some((e,s)=>e.dataSourceId!==t[s].dataSourceId)),s},this.isPopulatedView=e=>(null==e?void 0:e.dataViewId)===t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID,this.isSelectionView=e=>(null==e?void 0:e.dataViewId)===t.CONSTANTS.SELECTION_DATA_VIEW_ID,this.isDefaultView=e=>(null==e?void 0:e.dataViewId)===T||(null==e?void 0:e.dataViewId)===t.CONSTANTS.OUTPUT_DATA_VIEW_ID,this.isCommonView=e=>(null==e?void 0:e.dataViewId)&&!this.isPopulatedView(e)&&!this.isSelectionView(e)&&!this.isDefaultView(e),this.getOneDefaultUseDs=(e,t,s)=>{const i=this.groupUseDataSourcesByMainDsAndAddAutoViews(e,t,s);let a=[];a=this.props.defaultDataViewPriority===D.Second?[this.isCommonView,this.isDefaultView,this.isSelectionView,this.isPopulatedView]:[this.isPopulatedView,this.isCommonView,this.isSelectionView,this.isDefaultView];const l=Object.values(i).find(e=>e.some(e=>a[0](e)))||Object.values(i).find(e=>e.some(e=>a[1](e)))||Object.values(i).find(e=>e.some(e=>a[2](e)))||Object.values(i).find(e=>e.some(e=>a[3](e)))||Object.values(i)[0];return l?l.find(e=>a[0](e))||l.find(e=>a[1](e))||l.find(e=>a[2](e))||l.find(e=>a[3](e))||l[0]:null},this.getSelectedUseDsFromProps=(e,s,i,a,l)=>{var o,r;const n=this.groupUseDataSourcesByMainDsAndAddAutoViews(e,i,l),d=this.getOneDefaultUseDs(e,i,l);return s?a?null===(o=n[s.mainDataSourceId])||void 0===o?void 0:o.find(e=>e.dataViewId===t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID):s.dataViewId?s:null===(r=n[s.mainDataSourceId])||void 0===r?void 0:r.find(e=>e.dataViewId===T):d},this.getWhetherUseRepeatedDataSourceContext=(e,s,i,a)=>{var l,o,r,n;const d=w();if(!(d&&e&&s&&0!==s.length&&i&&a))return!1;if(null===(r=null===(o=null===(l=d.widgets[e])||void 0===l?void 0:l.manifest)||void 0===o?void 0:o.properties)||void 0===r?void 0:r.canProvideRepeatDataSource)return!0;const u=I.searchUtils.getParentWidgetIdOfContent(d,e,t.LayoutItemType.Widget,a),c=d.widgets[u],p=c&&(null===(n=c.manifest.properties)||void 0===n?void 0:n.canProvideRepeatDataSource);if(!p)return!1;let h=!1;for(let e=0;e<s.length;e++){const t=this.getRealUseDataSources(s[e],i);if(h=(null==c?void 0:c.useDataSources)&&c.useDataSources.some(e=>(null==t?void 0:t.dataSourceId)===e.dataSourceId),h)break}return p&&h},this.groupUseDataSourcesByMainDsAndAddAutoViews=(e,s,i)=>{if(!i||!s||0===s.length)return{};const a={};return s.forEach(e=>{if(a[e.mainDataSourceId]||(a[e.mainDataSourceId]=[]),!a[e.mainDataSourceId].some(t=>t.dataSourceId===e.dataSourceId)){if(!e.dataViewId&&e.dataSourceId===e.mainDataSourceId){const s=e.set("dataSourceId",t.DataSourceManager.getInstance().getDataViewDataSourceId(e.mainDataSourceId,T)).set("dataViewId",T);a[e.mainDataSourceId]=a[e.mainDataSourceId].concat(s)}else a[e.mainDataSourceId]=a[e.mainDataSourceId].concat(e)}}),Object.keys(a).forEach(t=>{a[t]=a[t].concat(this.getAutoAddedDataViews(e,a[t],s,i))}),a},this.getAutoAddedDataViews=(e,s,i,a)=>{if(!s||0===s.length||!a)return[];const l=t.DataSourceManager.getInstance().getDataSource(s[0].mainDataSourceId);if(!!!(null==l?void 0:l.query))return[];let o=[];if(this.props.useSelectionDataView&&!s.some(e=>e.dataViewId===t.CONSTANTS.SELECTION_DATA_VIEW_ID)){const e=s[0].set("dataSourceId",t.DataSourceManager.getInstance().getDataViewDataSourceId(s[0].mainDataSourceId,t.CONSTANTS.SELECTION_DATA_VIEW_ID)).set("dataViewId",t.CONSTANTS.SELECTION_DATA_VIEW_ID);o=o.concat(e)}if(this.props.usePopulatedDataView&&this.getWhetherUseRepeatedDataSourceContext(e,s,i,a)){const e=s[0].set("dataSourceId",t.DataSourceManager.getInstance().getDataViewDataSourceId(s[0].mainDataSourceId,t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID)).set("dataViewId",t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID);o=o.concat(e)}return o},this.getDsLabel=(e,i)=>{if(i&&i===t.CONSTANTS.SELECTION_DATA_VIEW_ID)return this.props.intl.formatMessage({id:"selectionDataView",defaultMessage:s.defaultMessages.selectionDataView});if(i&&i===t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID)return this.props.intl.formatMessage({id:"populatedDataView",defaultMessage:s.defaultMessages.populatedDataView});if(i&&(i===T||i===t.CONSTANTS.OUTPUT_DATA_VIEW_ID))return this.props.intl.formatMessage({id:"default",defaultMessage:s.defaultMessages.default});const a=t.DataSourceManager.getInstance().getDataSource(e);return a?a.getLabel()||a.id:e},this.getRealUseDataSources=(e,s)=>{if(!e)return null;if(e.dataViewId===T)return e.set("dataSourceId",e.mainDataSourceId).without("dataViewId");if(e.dataViewId===t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID){const i=s.find(t=>t.mainDataSourceId===e.mainDataSourceId);return i&&(0,t.Immutable)(i)}return e},this.onMainDataChange=e=>{const s=e.target.value;if(s!==this.props.selectedUseDataSource.mainDataSourceId){const e=this.props.useDataSources.find(e=>e.mainDataSourceId===s)||{dataSourceId:s,mainDataSourceId:s},i=this.getOneDefaultUseDs(this.props.widgetId,(0,t.Immutable)([e]),this.props.browserSizeMode);this.props.onChange(this.getRealUseDataSources(i,this.props.useDataSources),(null==i?void 0:i.dataViewId)===t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID)}},this.onDataViewChange=e=>{if(!this.props.selectedUseDataSource)return;const s=e.target.value,i=this.props.selectedUseDataSource.set("dataSourceId",t.DataSourceManager.getInstance().getDataViewDataSourceId(this.props.selectedUseDataSource.mainDataSourceId,s)).set("dataViewId",s);this.props.onChange(this.getRealUseDataSources(i,this.props.useDataSources),(null==i?void 0:i.dataViewId)===t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID)}}componentDidMount(){if(!this.props.selectedUseDataSource){const e=this.getOneDefaultUseDs(this.props.widgetId,this.props.useDataSources,this.props.browserSizeMode);this.props.onChange(this.getRealUseDataSources(e,this.props.useDataSources),(null==e?void 0:e.dataViewId)===t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID)}}componentDidUpdate(e){if(e.widgetId!==this.props.widgetId||!this.getWhetherUseDsIsShallowEqual(e.useDataSources,this.props.useDataSources)||e.browserSizeMode!==this.props.browserSizeMode||!this.props.selectedUseDataSource){const e=this.getOneDefaultUseDs(this.props.widgetId,this.props.useDataSources,this.props.browserSizeMode);this.props.onChange(this.getRealUseDataSources(e,this.props.useDataSources),(null==e?void 0:e.dataViewId)===t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID)}}render(){var i;if(!this.props.useDataSources)return null;const a=this.groupUseDataSourcesByMainDsAndAddAutoViews(this.props.widgetId,this.props.useDataSources,this.props.browserSizeMode),l=this.getSelectedUseDsFromProps(this.props.widgetId,this.props.selectedUseDataSource,this.props.useDataSources,this.props.isSelectedFromRepeatedDataSourceContext,this.props.browserSizeMode);return(0,e.jsx)("div",{className:(0,t.classNames)("main-data-and-view-selector w-100",{[this.props.className]:!!this.props.className}),children:(0,e.jsxs)("div",{className:"component-main-data-and-view",role:"group","aria-label":this.props.intl.formatMessage({id:"data",defaultMessage:s.defaultMessages.data}),children:[!this.props.hideMainDataSourceSelect&&(0,e.jsx)("div",{className:"w-100 text-truncate mb-3 option-label mb-2",children:this.props.intl.formatMessage({id:"data",defaultMessage:s.defaultMessages.data})}),!this.props.hideMainDataSourceSelect&&(0,e.jsx)("div",{className:"flex-grow-1",children:(0,e.jsx)(s.Select,{value:null==l?void 0:l.mainDataSourceId,className:"jimu-outline-inside",onChange:this.onMainDataChange,size:"sm",children:Object.keys(a).sort((e,t)=>null==e?void 0:e.localeCompare(t)).map((t,s)=>(0,e.jsx)("option",{value:t,title:this.getDsLabel(t),children:(0,e.jsx)("div",{className:"text-truncate",children:this.getDsLabel(t)})},s))})}),(0,e.jsx)("div",{className:(0,t.classNames)("flex-grow-1",{"mt-2":!this.props.hideMainDataSourceSelect}),children:(0,e.jsx)(s.Select,{value:null==l?void 0:l.dataViewId,className:"jimu-outline-inside",onChange:this.onDataViewChange,size:"sm",children:null===(i=a[null==l?void 0:l.mainDataSourceId])||void 0===i?void 0:i.sort((e,t)=>{var s;return null===(s=null==e?void 0:e.dataSourceId)||void 0===s?void 0:s.localeCompare(null==t?void 0:t.dataSourceId)}).map((t,s)=>(0,e.jsx)("option",{value:t.dataViewId,title:this.getDsLabel(t.dataSourceId,t.dataViewId),children:(0,e.jsx)("div",{className:"text-truncate",children:this.getDsLabel(t.dataSourceId,t.dataViewId)})},s))})})]})})}}const b=t.ReactRedux.connect((e,t)=>{var s,i;return{browserSizeMode:(null===(s=null==e?void 0:e.appContext)||void 0===s?void 0:s.isBuilder)?null===(i=null==e?void 0:e.appStateInBuilder)||void 0===i?void 0:i.browserSizeMode:null==e?void 0:e.browserSizeMode}})(F),M=(0,t.injectIntl)((0,y.withStyles)(b,"MainDataAndViewSelector"));var A=r(50170),O=r.n(A),C=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(i=Object.getOwnPropertySymbols(e);a<i.length;a++)t.indexOf(i[a])<0&&Object.prototype.propertyIsEnumerable.call(e,i[a])&&(s[i[a]]=e[i[a]])}return s};const N=s=>{const i=window.SVG,{className:a}=s,l=C(s,["className"]),o=(0,t.classNames)("jimu-icon jimu-icon-component",a);return i?(0,e.jsx)(i,Object.assign({className:o,src:O()},l)):(0,e.jsx)("svg",Object.assign({className:o},l))};class x extends t.React.PureComponent{constructor(e){super(e),this.getWhetherArrayIsShallowEqual=(e,t)=>{let s=!1;return e&&t&&e.length===t.length&&(s=!e.some((e,s)=>e!==t[s])),s},this.getDefaultSelectedDs=(e,t)=>this.hasSelectedFields()||this.props.isDataSourceDropDownHidden?this.getDsFromSelectedFieldsAndUseDss(e,t):null,this.hasSelectedFields=()=>!!this.props.selectedFields&&(Array.isArray(this.props.selectedFields)?this.props.selectedFields.length>0:"object"==typeof this.props.selectedFields&&Object.values(this.props.selectedFields).every(e=>e&&e.length>0)),this.getDsFromSelectedFieldsAndUseDss=(e,s)=>{let i;if(s&&e){if(this.getAreFromMultipleDss(e,s)){const e=Object.keys(this.props.selectedFields)[0];if(e.split("-").reverse()[0]===t.CONSTANTS.SELECTION_DATA_VIEW_ID){const s=t.DataSourceManager.getInstance().getDataSource(e),a=s&&s.getMainDataSource(),l=a&&a.id;i=this.props.dataSources.some(e=>e&&e.getMainDataSource().id===l)?s:null}else i=this.props.dataSources.find(t=>t&&t.id===e)}else i=e[0]}else e&&(i=e[0]);return i},this.getAreFromMultipleDss=(e,t)=>t?!Array.isArray(t):(null==e?void 0:e.length)>1,this.getDsLabel=e=>e&&e.getDataSourceJson()&&(e.getLabel()||e.id)||"",this.getFieldsJimuNameFromMultiDssFields=(e,s,i,a)=>{if(!e||!e.id||!i)return(0,t.Immutable)([]);const l=this.getAreFromMultipleDss(s,i)?(0,t.Immutable)(i[e.id]):i;return l?a?l:l.slice(0,1):(0,t.Immutable)([])},this.getSelectedUseDataSource=()=>this.state.selectedDs?this.getUseDataSources([this.state.selectedDs])[0]:null,this.getWhetherJimuNameIsInHiddenFields=e=>{var s;let i=!1;if(this.props.hiddenFields){const a=this.getAreFromMultipleDss(this.props.dataSources,this.props.selectedFields);let l=(0,t.Immutable)([]);l=a?this.props.hiddenFields[null===(s=this.state.selectedDs)||void 0===s?void 0:s.id]:this.props.hiddenFields,i=l.some(t=>t===e)}return i},this.getValidFields=e=>{const s=this.getAllFields(e);if(!s)return null;let i;if(this.props.types||this.props.hiddenFields||this.state.searchValue){let e,a,l=(0,t.Immutable)({});Object.keys(s).forEach(t=>{e=s[t].type,a=s[t].alias||s[t].name;const i=!this.props.types||e&&this.props.types&&this.props.types.some(t=>t===e),o=this.getWhetherJimuNameIsInHiddenFields(t),r=!this.state.searchValue||this.state.searchValue&&a&&a.toLowerCase().includes(this.state.searchValue.toLowerCase());i&&!o&&r&&(l=l.setIn([t],s[t]))}),i=l}else i=s;return i&&this.props.noSelectionItem&&(i=i.set(g,this.getNoSelectionItem())),i},this.getNoSelectionItem=()=>(0,t.Immutable)(Object.assign(Object.assign({},this.props.noSelectionItem),{jimuName:g})),this.getUseDataSources=e=>{if(!e)return null;let s=(0,t.Immutable)([]);return e.forEach(e=>{var t;e&&(s=s.concat({dataSourceId:e.id,mainDataSourceId:e.getMainDataSource().id,dataViewId:e.dataViewId,rootDataSourceId:null===(t=e.getRootDataSource())||void 0===t?void 0:t.id}))}),s},this.onSelectedUseDsChange=(e,s)=>{const i=t.DataSourceManager.getInstance().getDataSource(e.dataSourceId);if(this.setState({selectedDs:i,isFromRepeatedDs:s}),this.hasSelectedFields()){const e=this.getFieldsJimuNameFromMultiDssFields(this.state.selectedDs,this.props.dataSources,this.props.selectedFields,this.props.isMultiple).map(e=>{var t;return i&&(null===(t=this.getAllFields(i))||void 0===t?void 0:t[e])}).filter(e=>!!e);this.props.onChange&&this.props.onChange(e.asMutable(),i,s)}},this.onSearchChange=e=>{this.setState({searchValue:e.target.value})},this.onSelectedFieldsChange=e=>{if(e.some(e=>(null==e?void 0:e.jimuName)===g))return void(this.props.onChange&&this.props.onChange([],this.state.selectedDs,this.state.isFromRepeatedDs));const t=this.getFieldsJimuNameFromMultiDssFields(this.state.selectedDs,this.props.dataSources,this.props.selectedFields,this.props.isMultiple).asMutable(),s=this.getAllFields(this.state.selectedDs);let i=t.map(e=>null==s?void 0:s[e]).filter(e=>e);e.forEach(e=>{e&&(i=t.some(t=>t===e.jimuName)?i.filter(t=>t.jimuName!==e.jimuName):i.concat(e))}),this.props.onChange&&this.props.onChange(this.props.isMultiple?i:[i.pop()],this.state.selectedDs,this.state.isFromRepeatedDs)},this.toggleDropdown=e=>{this.props.toggle&&this.props.toggle(e)},this.state={selectedDs:this.getDefaultSelectedDs(this.props.dataSources,this.props.selectedFields),searchValue:"",isFromRepeatedDs:!!this.props.isSelectedFromRepeatedDataSourceContext}}componentDidMount(){var e;if(this.props.useDefault&&!this.props.selectedFields){const t=Object.values(null!==(e=this.getValidFields(this.state.selectedDs))&&void 0!==e?e:{})[0];t&&this.props.onChange([t],this.state.selectedDs,this.state.isFromRepeatedDs)}}componentDidUpdate(e,t){var s;if(this.getWhetherArrayIsShallowEqual(this.props.dataSources,e.dataSources)&&this.props.selectedFields===e.selectedFields||this.setState({selectedDs:this.getDefaultSelectedDs(this.props.dataSources,this.props.selectedFields)}),this.props.useDefault&&!this.props.selectedFields&&t.selectedDs!==this.state.selectedDs){const e=Object.values(null!==(s=this.getValidFields(this.state.selectedDs))&&void 0!==s?s:{})[0];e&&this.props.onChange([e],this.state.selectedDs,this.state.isFromRepeatedDs)}e.isSelectedFromRepeatedDataSourceContext!==this.props.isSelectedFromRepeatedDataSourceContext&&this.setState({isFromRepeatedDs:!!this.props.isSelectedFromRepeatedDataSourceContext})}getAllFields(e){var t;const s=null==e?void 0:e.getSelectedFields(),i=null===(t=null==e?void 0:e.getSchema())||void 0===t?void 0:t.fields,a=i?Object.keys(i).filter(e=>!s.includes(e)):[];return null==i?void 0:i.without(...a)}render(){if(!this.props.dataSources||0===this.props.dataSources.filter(e=>!!e).length)return console.warn("No data sources"),null;const i=this.getValidFields(this.state.selectedDs),a=this.getFieldsJimuNameFromMultiDssFields(this.state.selectedDs,this.props.dataSources,this.props.selectedFields,this.props.isMultiple),l=this.getFieldsJimuNameFromMultiDssFields(this.state.selectedDs,this.props.dataSources,this.props.disabledFields,this.props.isMultiple),o=this.props.noSelectionItem&&0===a.length?(0,t.Immutable)([this.getNoSelectionItem().jimuName]):a,r=Object.assign(Object.assign({},this.props.dropdownProps),{useKeyUpEvent:this.props.useKeyUpEvent,"aria-label":this.props["aria-label"]||this.props.intl.formatMessage({id:"fieldSelector",defaultMessage:s.defaultMessages.fieldSelector})});return(0,e.jsx)("div",{style:this.props.style,className:(0,t.classNames)("w-100 h-100",{[this.props.className]:!!this.props.className}),children:(0,e.jsxs)("div",{className:"component-field-selector w-100 h-100",children:[this.props.isDataSourceDropDownHidden?null:(0,e.jsx)("div",{className:"ds-name p-4 d-flex justify-content-between align-items-center",children:(0,e.jsx)(M,{widgetId:this.props.widgetId,useDataSources:this.getUseDataSources(this.props.dataSources),onChange:this.onSelectedUseDsChange,useSelectionDataView:this.props.useSelectionDataView,usePopulatedDataView:this.props.usePopulatedDataView,selectedUseDataSource:this.getSelectedUseDataSource(),isSelectedFromRepeatedDataSourceContext:this.state.isFromRepeatedDs})}),this.props.isSearchInputHidden||this.props.useDropdown?null:(0,e.jsx)("div",{className:"d-inline-block w-100 px-4 mb-2 item-selector-search",children:(0,e.jsx)(s.TextInput,{placeholder:this.props.intl.formatMessage({id:"search",defaultMessage:t.defaultMessages.search}),onChange:this.onSearchChange,className:"d-inline-block search-input",value:this.state.searchValue,prefix:(0,e.jsx)(N,{color:this.props.theme.ref.palette.neutral[1200]})})}),this.props.useDropdown?(0,e.jsx)(f,{placeholder:this.props.placeholder,ds:this.state.selectedDs,fields:i,selectedFields:o,isMultiple:this.props.isMultiple,isSearchInputHidden:this.props.isSearchInputHidden,onFieldClick:this.onSelectedFieldsChange,theme:this.props.theme,dropdownProps:r,useMultiDropdownBottomTools:this.props.useMultiDropdownBottomTools,intl:this.props.intl,toggle:this.props.toggle,disabledFields:l}):(0,e.jsx)(S,{ds:this.state.selectedDs,fields:i,selectedFields:o,intl:this.props.intl,isMultiple:this.props.isMultiple,onFieldClick:this.onSelectedFieldsChange,theme:this.props.theme})]})})}}const j=(0,y.withStyles)((0,y.withTheme)((0,t.injectIntl)(x)),"FieldSelector");var V=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(i=Object.getOwnPropertySymbols(e);a<i.length;a++)t.indexOf(i[a])<0&&Object.prototype.propertyIsEnumerable.call(e,i[a])&&(s[i[a]]=e[i[a]])}return s};class E extends t.React.PureComponent{render(){const s=this.props,{useDataSources:i,dataSources:a}=s,l=V(s,["useDataSources","dataSources"]);return a?(0,e.jsx)(j,Object.assign({},this.props)):1===(null==i?void 0:i.length)?(0,e.jsx)(t.DataSourceComponent,{useDataSource:i[0],children:(t,s)=>(0,e.jsx)(j,Object.assign({},l,{dataSources:[t]}))}):(0,e.jsx)(t.MultipleDataSourceComponent,{useDataSources:i,children:(t,s)=>(0,e.jsx)(j,Object.assign({},l,{dataSources:t&&Object.values(t)}))})}}var U=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(i=Object.getOwnPropertySymbols(e);a<i.length;a++)t.indexOf(i[a])<0&&Object.prototype.propertyIsEnumerable.call(e,i[a])&&(s[i[a]]=e[i[a]])}return s};const _=[{name:"printTask",type:t.SupportedUtilityType.Printing},{name:"geometry",type:t.SupportedUtilityType.Geometry},{name:"geoenrichment",type:t.SupportedUtilityType.GeoEnrichment},{name:"route",type:t.SupportedUtilityType.Routing},{name:"geocode",dynamic:!0,type:t.SupportedUtilityType.GeoCoding}];function P(e,t,s,i,a){const l=[];return _.forEach(o=>{const r=e[o.name],n=a(o.name);if(o.dynamic){if(Array.isArray(r))l.push({id:o.name,name:o.name,label:n,type:o.type,children:r.map((e,t)=>{var s;const i=R(o.name,e);return{id:`${o.name}_${t}`,name:o.name,type:o.type,index:t,label:null!==(s=e.name)&&void 0!==s?s:e.id,url:e.url,setting:i}}).filter(e=>L(e,t,s,i))});else if(r){const e=R(o.name,r);l.push({id:o.name,name:o.name,label:n,type:o.type,url:r.url,setting:e})}}else if(r){const e=R(o.name,r);l.push({id:o.name,name:o.name,label:n,type:o.type,url:r.url,setting:e})}}),l.filter(e=>e.children?e.children.length>0:L(e,t,s,i))}function R(e,t){if(/rest\/services\/.*\/GeocodeServer/.test(t.url)){const{url:e}=t;return U(t,["url"])}return"printTask"===e?{templates:t.templates}:null}function L(e,t,s,i){const{url:a,label:l}=e,o=null===t||t.includes(e.type),r=!s||l.toLowerCase().includes(s.toLowerCase()),n=!i||i.test(a);return o&&r&&n}const J="objectid",k="default_geocode";var W,q;!function(e){e.Both="Both",e.GeocodeService="GeocodeService",e.FeatureService="FeatureService"}(W||(W={})),function(e){e.GeocodeService="GeocodeService",e.FeatureService="FeatureService"}(q||(q={}));var z,H=function(e,t,s,i){return new(s||(s=Promise))(function(a,l){function o(e){try{n(i.next(e))}catch(e){l(e)}}function r(e){try{n(i.throw(e))}catch(e){l(e)}}function n(e){var t;e.done?a(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(o,r)}n((i=i.apply(e,t||[])).next())})};!function(e){e.Pass="Pass",e.NotHttps="Not_Https",e.InvalidURL="Invalid_URL"}(z||(z={}));const B=e=>{const{urlCheckResult:t,useUtility:s,fields:i,datasourceConfig:a,configId:l,viewId:o,createOutputDs:r,id:n,dataSourceConfigItem:d,geocodeURL:u,notAddNewUtility:c}=e,{singleLineFieldName:p,spatialReference:h,isSupportSuggest:m}=t,g=le(null==a?void 0:a.asMutable({deep:!0})),v=l||oe(g,o);let S=a?a.asMutable({deep:!0}):[];const f=G(s,u),D=X(s,u),I=K(s),{addressFieldsSchema:y,defaultAddressFieldName:w}=ae(i),T={configId:v,icon:null,label:f,hint:D,useUtility:s,searchServiceType:q.GeocodeService,singleLineFieldName:p,isSupportSuggest:m,spatialReference:h,zoomScale:I};return c&&(T.geocodeURL=u),r&&(T.outputDataSourceId=`${n}_output_${v}`,T.addressFields=y,T.displayFields=$(y,w),T.defaultAddressFieldName=w),(null==d?void 0:d.configId)?S=a.map(e=>(null==e?void 0:e.configId)===v?T:e):S.push(T),S},$=(e,t)=>{let s;return null==e||e.forEach(e=>{var i;(null===(i=null==e?void 0:e.jimuName)||void 0===i?void 0:i.toLocaleLowerCase())===t&&(s=e)}),s||(s=e[0]),[s]},G=(e,s)=>{if(null==e?void 0:e.utilityId)return t.UtilityManager.getInstance().getLabelOfUseUtility(e);if(s){const e=Z(s);return null==e?void 0:e.name}},X=(e,s)=>{var i;if(null==e?void 0:e.utilityId){const s=t.UtilityManager.getInstance().getUtilityJson(e.utilityId);return null===(i=null==s?void 0:s.orgSetting)||void 0===i?void 0:i.placeholder}if(s){const e=Z(s);return null==e?void 0:e.placeholder}},K=e=>{if(!e)return null;const s=t.UtilityManager.getInstance().getUtilityJson(e.utilityId),i=null==s?void 0:s.url,a=Z(i);return(null==a?void 0:a.zoomScale)||null},Z=e=>{var s;const i=null===(s=(0,t.getAppStore)().getState().portalSelf)||void 0===s?void 0:s.helperServices;return((null==i?void 0:i.geocode)||[]).filter(t=>(null==t?void 0:t.url)===e)[0]},Q=e=>H(void 0,void 0,void 0,function*(){return t.UtilityManager.getInstance().getUrlOfUseUtility(e).then(e=>Promise.resolve(e),e=>Promise.reject(new Error(e)))}),Y=e=>H(void 0,void 0,void 0,function*(){const s=new RegExp("^(([h][t]{2}[p][s])?://)");if(!e||!s.test(e))return Promise.resolve({urlCheckResultType:z.NotHttps});try{return(0,t.loadArcGISJSAPIModules)(["esri/request"]).then(t=>{const[s]=t;return s(e,{query:{f:"json"},responseType:"json"}).then(e=>{var t;const s=(null==e?void 0:e.data)||{};if(null==s?void 0:s.capabilities){const e=(null==s?void 0:s.singleLineAddressField)||{},i=(null==s?void 0:s.addressFields)||[],a=(null==s?void 0:s.spatialReference)||null,l=(null==s?void 0:s.candidateFields)||[],o=(null===(t=null==s?void 0:s.capabilities)||void 0===t?void 0:t.split(","))||[],r=null==o?void 0:o.includes("Suggest");return Promise.resolve({urlCheckResultType:z.Pass,singleLineFieldName:null==e?void 0:e.name,addressFields:i,isSupportSuggest:r,candidateFields:l,spatialReference:a})}return Promise.resolve({urlCheckResultType:z.InvalidURL})},e=>Promise.resolve({urlCheckResultType:z.InvalidURL}))},e=>Promise.resolve({urlCheckResultType:z.InvalidURL}))}catch(e){return Promise.resolve({urlCheckResultType:z.InvalidURL})}});function ee(e){return H(this,void 0,void 0,function*(){var s,i;const{nls:a,createOutputDs:l,id:o,notAddNewUtility:r}=e,n=(null===(i=null===(s=function(e){var s;return P(null===(s=(0,t.getAppStore)().getState().portalSelf)||void 0===s?void 0:s.helperServices,t.SupportedUtilityType.GeoCoding,null,null,e)}(a))||void 0===s?void 0:s[0])||void 0===i?void 0:i.children)||[],d=null==n?void 0:n.map((e,s)=>function(e,s){return H(this,void 0,void 0,function*(){const{utility:i,id:a,createOutputDs:l,viewId:o,notAddNewUtility:r,index:n}=e;if(!i)return Promise.resolve(null);const d=s||t.UtilityManager.getInstance().getIdOfOrgUtility(i.name,i.url,i.index,i.label),u=o?`${o}_${d||n}`:`${k}_${d||n}`,c=o?`${o}_${i.index}`:`${k}_${i.index}`;return function(e){return H(this,void 0,void 0,function*(){const{useUtility:t}=e,s=(null==e?void 0:e.geocodeURL)||(yield Q(t));return Y(s).then(t=>{if((null==t?void 0:t.urlCheckResultType)!==z.Pass)return Promise.resolve({urlCheckResult:t});{const s=t.addressFields.concat(t.candidateFields),i=Object.assign(Object.assign({},e),{urlCheckResult:t,fields:s}),a=B(i);return Promise.resolve({urlCheckResult:t,dataSourceConfig:a})}})})}({id:a,createOutputDs:l,dataSourceConfigItem:null,viewId:r?c:u,configId:null,datasourceConfig:null,useUtility:{utilityId:d},geocodeURL:i.url,notAddNewUtility:r}).then(e=>{var t,s;return(null===(t=e.urlCheckResult)||void 0===t?void 0:t.urlCheckResultType)===z.Pass&&(null===(s=e.dataSourceConfig)||void 0===s?void 0:s.length)>0?Promise.resolve(e.dataSourceConfig[0]):Promise.resolve(null)})})}({utility:e,id:o,createOutputDs:l,viewId:k,notAddNewUtility:r,index:s})),u=yield Promise.all(d),c=null==u?void 0:u.filter(e=>!!e);return Promise.resolve(c)})}const te={jimuName:J,alias:"OBJECTID",esriType:t.EsriFieldType.OID,type:t.JimuFieldType.Number,name:J},se=(e="",t=[])=>{const s={};return null==t||t.forEach((e,t)=>{s[null==e?void 0:e.jimuName]=e,0===t&&(s[J]=te)}),{label:e,idField:J,fields:s}},ie=(e,t=0)=>{let s="default_address";return null==e||e.forEach(i=>{s=t?`${s}${t}`:s,i.jimuName===s&&(s=ie(e,t+=1))}),s},ae=(e=[])=>{var s;const i=null===(s=null==e?void 0:e.map(e=>t.dataSourceUtils.convertFieldToJimuField(e,e)))||void 0===s?void 0:s.filter(e=>e),a=ie(i,0),l={jimuName:a,alias:"Default Address",type:t.JimuFieldType.String,esriType:t.EsriFieldType.String,name:a};return i.unshift(l),{addressFieldsSchema:i,defaultAddressFieldName:a}},le=e=>null==e?void 0:e.map(e=>e.configId),oe=(e,t)=>{if(!e||0===(null==e?void 0:e.length))return t?`config_${t}_0`:"config_0";const s=re(e);return t?`config_${t}_${s+1}`:`config_${s+1}`},re=e=>{var t;const s=null==e?void 0:e.map(e=>{var t;const s=null===(t=null==e?void 0:e.split("_"))||void 0===t?void 0:t.pop();return s?Number(s):0});return null===(t=null==s?void 0:s.sort((e,t)=>t-e))||void 0===t?void 0:t[0]},ne=e=>{var t,s,i,a;const l=(null===(s=null===(t=null==e?void 0:e.searchFields)||void 0===t?void 0:t.asMutable({deep:!0}))||void 0===s?void 0:s.map(e=>null==e?void 0:e.jimuName))||[],o=(null===(a=null===(i=null==e?void 0:e.displayFields)||void 0===i?void 0:i.asMutable({deep:!0}))||void 0===a?void 0:a.map(e=>null==e?void 0:e.jimuName))||[],r=Array.from(new Set(l.concat(o)));return e.setIn(["useDataSource","fields"],r)},de=e=>{const{datasourceConfig:s,datasourceConfigItem:i,configId:a}=e;let l=s?s.asMutable({deep:!0}):[];const o=(e=>{var s;const{datasourceConfig:i,dsJsonOriginDs:a,useDataSource:l,configId:o,viewId:r,fieldsInMapSearchProperties:n,exactMatch:d,label:u,searchInCurrentMapExtent:c}=e,p=le(null==i?void 0:i.asMutable({deep:!0})),h=o||oe(p,r),m=u||(null==a?void 0:a.getLabel()),g=ue(l,n);if(p&&p.includes(h)){const e=i.filter(e=>e.configId===h)[0],a=null===(s=e.useDataSource)||void 0===s?void 0:s.dataSourceId,o=l.dataSourceId;if(a&&o&&t.dataSourceUtils.areDerivedFromSameMain(a,o)){const s=ne((0,t.Immutable)(Object.assign(Object.assign({},e),{configId:h,useDataSource:l,label:m})));return null==s?void 0:s.asMutable({deep:!0})}}return l.fields=null==g?void 0:g.map(e=>null==e?void 0:e.jimuName),{configId:h,icon:null,label:m,displayLabel:!0,useDataSource:l,displayFields:g,searchFields:g,hint:"",searchServiceType:q.FeatureService,searchExact:!!d,searchInCurrentMapExtent:!!c}})(e);return(null==i?void 0:i.configId)?l=l.map(e=>(null==e?void 0:e.configId)===a?o:e):l.push(o),{dsConfigItem:o,datasourceConfig:l}},ue=(e,s)=>{var i,a,l,o,r;const n=t.DataSourceManager.getInstance().getDataSource(null==e?void 0:e.dataSourceId),d=(null==n?void 0:n.getLayerDefinition)&&(null===(i=null==n?void 0:n.getLayerDefinition())||void 0===i?void 0:i.displayField);let u;(null==s?void 0:s.length)>0&&(u=s.map(e=>null==e?void 0:e.name));const c=null===(a=null==n?void 0:n.getSchema())||void 0===a?void 0:a.fields;let p;const h=[];for(const e in c)(null===(l=null==c?void 0:c[e])||void 0===l?void 0:l.type)!==t.JimuFieldType.Date&&h.push(null==c?void 0:c[e]),(null===(o=null==c?void 0:c[e])||void 0===o?void 0:o.name)===d&&(null===(r=null==c?void 0:c[e])||void 0===r?void 0:r.type)!==t.JimuFieldType.Date&&d&&(p=null==c?void 0:c[e]);let m=[];return u?m=null==h?void 0:h.filter(e=>u.includes(e.name)):(null==h?void 0:h.length)>0&&(m=(null==h?void 0:h.length)>1?[(0,t.Immutable)(h[1])]:[(0,t.Immutable)(h[0])]),u&&0===(null==m?void 0:m.length)&&(null==h?void 0:h.length)>0&&(m=(null==h?void 0:h.length)>1?[(0,t.Immutable)(h[1])]:[(0,t.Immutable)(h[0])]),u&&(null==m?void 0:m.length)>0?m:p?[(0,t.Immutable)(p)]:m},ce=e=>t.DataSourceManager.getInstance().createDataSourceByUseDataSource((0,t.Immutable)(e)).then(e=>{const s=(i=e)?i.type===t.DataSourceTypes.SceneLayer?i.getAssociatedDataSource():i:null;var i;return s||Promise.reject(Error("")),s}),pe=(e,s=!0)=>{let i;return(null==e?void 0:e.searchServiceType)===q.GeocodeService&&(i={id:null==e?void 0:e.outputDataSourceId,type:t.DataSourceTypes.FeatureLayer,label:null==e?void 0:e.label,originDataSources:[],isOutputFromWidget:s,isDataInDataSourceInstance:!1,schema:se(null==e?void 0:e.label,null==e?void 0:e.addressFields),geometryType:"esriGeometryPoint"}),i}})(),n})())}}});
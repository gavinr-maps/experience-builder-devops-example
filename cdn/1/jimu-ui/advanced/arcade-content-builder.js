System.register(["jimu-core","jimu-core/emotion","jimu-for-builder","jimu-theme","jimu-ui"],function(e,t){var a={},n={},r={},l={},s={};return{setters:[function(e){a.ArcadeContentCapability=e.ArcadeContentCapability,a.ArcadeProfileContextProvider=e.ArcadeProfileContextProvider,a.ArcadeProfileType=e.ArcadeProfileType,a.CONSTANTS=e.CONSTANTS,a.DataSourceManager=e.DataSourceManager,a.DynamicStyleType=e.DynamicStyleType,a.Immutable=e.Immutable,a.JimuFieldType=e.JimuFieldType,a.React=e.React,a.arcadeContentUtils=e.arcadeContentUtils,a.classNames=e.classNames,a.css=e.css,a.getAppStore=e.getAppStore,a.hooks=e.hooks,a.indexedDBUtils=e.indexedDBUtils,a.injectIntl=e.injectIntl,a.loadArcGISJSAPIModule=e.loadArcGISJSAPIModule,a.moduleLoader=e.moduleLoader,a.urlUtils=e.urlUtils,a.uuidv1=e.uuidv1},function(e){n.jsx=e.jsx,n.jsxs=e.jsxs},function(e){r.helpUtils=e.helpUtils},function(e){l.withTheme=e.withTheme},function(e){s.Alert=e.Alert,s.Button=e.Button,s.Label=e.Label,s.Loading=e.Loading,s.LoadingType=e.LoadingType,s.Modal=e.Modal,s.ModalBody=e.ModalBody,s.ModalFooter=e.ModalFooter,s.ModalHeader=e.ModalHeader,s.Popper=e.Popper,s.TextArea=e.TextArea,s.TextInput=e.TextInput,s.Tooltip=e.Tooltip,s.defaultMessages=e.defaultMessages}],execute:function(){e((()=>{var e={1888:e=>{"use strict";e.exports=l},4108:e=>{"use strict";e.exports=r},14321:e=>{"use strict";e.exports=s},23662:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M7.5 0a.5.5 0 0 0-.5.5V7H.5a.5.5 0 0 0 0 1H7v6.5a.5.5 0 0 0 1 0V8h6.5a.5.5 0 0 0 0-1H8V.5a.5.5 0 0 0-.5-.5"></path></svg>'},28996:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M8 2.125 14.334 14H1.667zm-.882-.47a1 1 0 0 1 1.765 0l6.333 11.874A1 1 0 0 1 14.334 15H1.667a1 1 0 0 1-.882-1.47zM8 4.874a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0L8.9 5.87a.905.905 0 0 0-.9-.995m1 7a1 1 0 1 1-2 0 1 1 0 0 1 2 0" clip-rule="evenodd"></path></svg>'},30655:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M2.146 4.653a.485.485 0 0 1 .708 0L8 10.24l5.146-5.587a.485.485 0 0 1 .708 0 .54.54 0 0 1 0 .738l-5.5 5.956a.485.485 0 0 1-.708 0l-5.5-5.956a.54.54 0 0 1 0-.738" clip-rule="evenodd"></path></svg>'},45508:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2M6.5 7.5A.5.5 0 0 1 7 7h1.5v4.5h1a.5.5 0 0 1 0 1h-3a.5.5 0 0 1 0-1h1V8H7a.5.5 0 0 1-.5-.5"></path><path fill="#000" fill-rule="evenodd" d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16m0-1A7 7 0 1 0 8 1a7 7 0 0 0 0 14" clip-rule="evenodd"></path></svg>'},62838:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="m8.745 8 6.1 6.1a.527.527 0 1 1-.745.746L8 8.746l-6.1 6.1a.527.527 0 1 1-.746-.746l6.1-6.1-6.1-6.1a.527.527 0 0 1 .746-.746l6.1 6.1 6.1-6.1a.527.527 0 0 1 .746.746z"></path></svg>'},67386:e=>{"use strict";e.exports=n},72259:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M14 8A6 6 0 1 1 2 8a6 6 0 0 1 12 0m1 0A7 7 0 1 1 1 8a7 7 0 0 1 14 0M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8" clip-rule="evenodd"></path></svg>'},79244:e=>{"use strict";e.exports=a},94064:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M13.854 11.347a.486.486 0 0 1-.708 0L8 5.76l-5.146 5.587a.485.485 0 0 1-.708 0 .54.54 0 0 1 0-.738l5.5-5.956a.485.485 0 0 1 .708 0l5.5 5.956a.54.54 0 0 1 0 .738" clip-rule="evenodd"></path></svg>'},98657:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M11 2v10H3V4.414L5.414 2zM2 4.414a1 1 0 0 1 .293-.707l2.414-2.414A1 1 0 0 1 5.414 1H11a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1zM13.048 3v10.56c0 .265-.214.48-.477.48H4V15h8.571c.79 0 1.429-.645 1.429-1.44V3z" clip-rule="evenodd"></path></svg>'}},t={};function o(a){var n=t[a];if(void 0!==n)return n.exports;var r=t[a]={exports:{}};return e[a](r,r.exports,o),r.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var a in t)o.o(t,a)&&!o.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};return(()=>{"use strict";o.r(i),o.d(i,{ArcadeContentBuilder:()=>Z,ArcadeContentBuilderPopup:()=>ee});var e=o(67386),t=o(79244),a=o(14321),n=o(1888),r=o(4108),l=o(28996),s=o.n(l),c=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(a[n[r]]=e[n[r]])}return a};const d=a=>{const n=window.SVG,{className:r}=a,l=c(a,["className"]),o=(0,t.classNames)("jimu-icon jimu-icon-component",r);return n?(0,e.jsx)(n,Object.assign({className:o,src:s()},l)):(0,e.jsx)("svg",Object.assign({className:o},l))};var u=o(98657),p=o.n(u),m=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(a[n[r]]=e[n[r]])}return a};const f=a=>{const n=window.SVG,{className:r}=a,l=m(a,["className"]),s=(0,t.classNames)("jimu-icon jimu-icon-component",r);return n?(0,e.jsx)(n,Object.assign({className:s,src:p()},l)):(0,e.jsx)("svg",Object.assign({className:s},l))};var v=o(45508),y=o.n(v),h=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(a[n[r]]=e[n[r]])}return a};const g=a=>{const n=window.SVG,{className:r}=a,l=h(a,["className"]),s=(0,t.classNames)("jimu-icon jimu-icon-component",r);return n?(0,e.jsx)(n,Object.assign({className:s,src:y()},l)):(0,e.jsx)("svg",Object.assign({className:s},l))};var b=o(23662),x=o.n(b),j=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(a[n[r]]=e[n[r]])}return a};const S=a=>{const n=window.SVG,{className:r}=a,l=j(a,["className"]),s=(0,t.classNames)("jimu-icon jimu-icon-component",r);return n?(0,e.jsx)(n,Object.assign({className:s,src:x()},l)):(0,e.jsx)("svg",Object.assign({className:s},l))};var w=o(94064),O=o.n(w),R=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(a[n[r]]=e[n[r]])}return a};const N=a=>{const n=window.SVG,{className:r}=a,l=R(a,["className"]),s=(0,t.classNames)("jimu-icon jimu-icon-component",r);return n?(0,e.jsx)(n,Object.assign({className:s,src:O()},l)):(0,e.jsx)("svg",Object.assign({className:s},l))};var C=o(30655),T=o.n(C),A=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(a[n[r]]=e[n[r]])}return a};const M=a=>{const n=window.SVG,{className:r}=a,l=A(a,["className"]),s=(0,t.classNames)("jimu-icon jimu-icon-component",r);return n?(0,e.jsx)(n,Object.assign({className:s,src:T()},l)):(0,e.jsx)("svg",Object.assign({className:s},l))};var I=o(62838),P=o.n(I),k=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(a[n[r]]=e[n[r]])}return a};const D=a=>{const n=window.SVG,{className:r}=a,l=k(a,["className"]),s=(0,t.classNames)("jimu-icon jimu-icon-component",r);return n?(0,e.jsx)(n,Object.assign({className:s,src:P()},l)):(0,e.jsx)("svg",Object.assign({className:s},l))};var _=o(72259),E=o.n(_),F=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(a[n[r]]=e[n[r]])}return a};const L=a=>{const n=window.SVG,{className:r}=a,l=F(a,["className"]),s=(0,t.classNames)("jimu-icon jimu-icon-component",r);return n?(0,e.jsx)(n,Object.assign({className:s,src:E()},l)):(0,e.jsx)("svg",Object.assign({className:s},l))},B=t.css`
  display: flex;
  flex-direction: column;
  .icons-body {
    overflow: auto;
  }

  .text-input-and-icon-picker {
    width: calc(100% - 16px);
  }
`;const U=(0,n.withTheme)((0,t.injectIntl)(function(n){const r=n.inModal,l=n.expand,s=n.icons,o=t.React.useMemo(()=>{let e=null;return e=(null==s?void 0:s.length)>0?s:(0,t.Immutable)([]),e=e.filter(e=>!!e),e},[s]),i=n.onExpandChange,c=n.onClose,d=n.onIconsChange,[u,p]=t.hooks.useLoadedModule("jimu-ui/advanced/setting-components"),m=u&&p?p.SettingRow:null,[f,v]=t.hooks.useLoadedModule("jimu-ui/advanced/resource-selector"),y=v?v.IconPicker:null,h=u&&m&&f&&y,g=t.hooks.useTranslation(a.defaultMessages),b=g("icons"),x=g("add"),j=g("collapse"),w=g("expand"),O=g("close"),R=g("name"),C=g("icon"),T=g("remove"),A=g("duplicatedLabel"),I=t.React.useCallback(e=>{d&&d(e)},[d]),P=t.React.useCallback(()=>{const e=o.asMutable({deep:!0}),a=function(e){let t="",a=0;function n(e){const t=/^Icon\s+([1-9]\d*)$/,a=e.match(t);return a?Number(a[1]):null}const r=[];(null==e?void 0:e.length)>0&&e.forEach(e=>{const t=null==e?void 0:e.name;t&&r.push(t)});r.forEach(e=>{const t=n(e);"number"==typeof t&&t>0&&(a=Math.max(a,t))});let l=a+1;for(;t=`Icon ${l}`,r.includes(t);)l++;return t}(o)||"",n={name:a,data:null};e.push(n);const r=(0,t.Immutable)(e);I(r)},[o,I]),k=t.React.useCallback(()=>{i&&i(!l)},[l,i]),_=t.React.useCallback(()=>{c&&c()},[c]),E=t.React.useRef(o),F=t.React.useCallback(()=>{E.current=(0,t.Immutable)(o.asMutable({deep:!0}))},[o]),U=t.React.useCallback((e,t)=>{if(t&&(null==o?void 0:o.length)>0){if(o.find((a,n)=>(null==a?void 0:a.name)===t&&n!==e))return{valid:!1,msg:A}}return{valid:!0}},[A,o]),$=t.React.useCallback(e=>({valid:!0}),[]),K=t.React.useCallback((e,t)=>{const a=o.map((a,n)=>{if(n===e){return a.set("name",t)}return a});I(a)},[o,I]),V=t.React.useCallback((e,t)=>{var a;const n=(null===(a=null==t?void 0:t.target)||void 0===a?void 0:a.value)||"";K(e,n)},[K]),z=t.React.useCallback((e,t)=>{var a;const n=(null===(a=null==t?void 0:t.target)||void 0===a?void 0:a.value)||"",r=n.trim();if(r&&U(e,r).valid)r!==n&&K(e,r);else{const t=E.current,a=t&&e<=t.length-1?t[e]:null,n=null==a?void 0:a.name;n&&K(e,n)}},[K,U]),H=t.React.useCallback((e,t)=>{const a=o.map((a,n)=>{if(n===e){return a.set("data",t)}return a});I(a)},[o,I]),J=t.React.useCallback(e=>{const t=o.filter((t,a)=>a!==e);I(t)},[o,I]),G=!(!r&&!l);return(0,e.jsx)("div",{className:(0,t.classNames)("icons-selector h-100 p-3",n.className),css:B,children:h&&(0,e.jsxs)(t.React.Fragment,{children:[(0,e.jsxs)(m,{children:[(0,e.jsx)(a.Label,{className:"w-100 d-inline",children:b}),G&&(0,e.jsx)(a.Button,{className:"add-icon-btn mr-2",icon:!0,size:"sm",type:"tertiary",title:x,"aria-label":x,onClick:P,children:(0,e.jsx)(S,{})}),!r&&(0,e.jsx)(a.Button,{className:"collapse-icon-btn",icon:!0,size:"sm",type:"tertiary",title:l?j:w,"aria-label":l?j:w,onClick:k,children:l?(0,e.jsx)(N,{}):(0,e.jsx)(M,{})}),r&&(0,e.jsx)(a.Button,{className:"close-btn",icon:!0,size:"sm",type:"tertiary",title:O,"aria-label":O,onClick:_,children:(0,e.jsx)(D,{})})]}),G&&(0,e.jsxs)("div",{className:"icons-body h-100",children:[(null==o?void 0:o.length)>0&&(0,e.jsxs)(m,{className:"mt-2",children:[(0,e.jsx)(a.Label,{className:"d-inline",style:{width:"70px"},children:R}),(0,e.jsx)(a.Label,{className:"d-inline ml-3",children:C})]}),null==o?void 0:o.map((t,n)=>(0,e.jsxs)(m,{children:[(0,e.jsxs)("div",{className:"text-input-and-icon-picker d-flex",children:[(0,e.jsx)(a.TextInput,{required:!0,size:"sm",style:{width:"70px"},value:(null==t?void 0:t.name)||"",onFocus:F,checkValidityOnChange:e=>U(n,e),checkValidityOnAccept:$,onChange:e=>{V(n,e)},onBlur:e=>{z(n,e)}}),(0,e.jsx)(y,{className:"ml-3",icon:null==t?void 0:t.data,configurableOption:"none",onChange:e=>{H(n,e)},"aria-label":C,setButtonUseColor:!1})]}),(0,e.jsx)(a.Button,{icon:!0,size:"sm",type:"tertiary",title:T,"aria-label":T,onClick:()=>{J(n)},children:(0,e.jsx)(L,{})})]},n))]})]})})}));function $(e){var a;if(!e)return null;const n=function(){const e=(0,t.getAppStore)().getState(),a=window.jimuConfig.isBuilder?null==e?void 0:e.appStateInBuilder:e;return null==a?void 0:a.appConfig}();return null===(a=null==n?void 0:n.widgets)||void 0===a?void 0:a[e]}var K=function(e,t,a,n){return new(a||(a=Promise))(function(r,l){function s(e){try{i(n.next(e))}catch(e){l(e)}}function o(e){try{i(n.throw(e))}catch(e){l(e)}}function i(e){var t;e.done?r(e.value):(t=e.value,t instanceof a?t:new a(function(e){e(t)})).then(s,o)}i((n=n.apply(e,t||[])).next())})};let V=0;const z=t.css`
position: relative;
flex-direction: column;

.hidden {
  visibility: hidden;
}

.script-section {
  position: relative;
  display: flex;
  flex-direction: column;

  .text-area-container {
    position: relative;

    .jimu-input-area {
      textarea {
        height: 100%;
        resize: none;
      }
    }

    .copy-script-btn {
      position: absolute;
      right: 0;
      top: 0;
      cursor: pointer;
    }
  }
}

.arcade-script-stored-locally-tip {
  color: var(--sys-color-surface-overlay-hint, #DCDCDC);
  line-height: 20px;
}

.modal-arcgis-arcade-editor-container {
  position: relative;
  height: 600px;
  max-height: calc(100vh - 298px);

  .modal-arcgis-arcade-editor-overlay {
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
  }
}

.invalid-msg {
  white-space: nowrap;
  align-items: center;
}

arcgis-arcade-editor {
  --arcgis-coding-components-border: 1px solid var(--sys-color-divider-secondary, #585858);
  border-color: var(--sys-color-divider-secondary, #585858);

  calcite-action-bar.main-action-bar,
  arcgis-editor-variables.side-panel,
  arcgis-language-api-panel.side-panel,
  arcgis-arcade-suggestions.side-panel,
  calcite-action-bar.side-action-bar {
    border-color: var(--sys-color-divider-secondary, #585858);
  }

  --calcite-action-background-color-hover: #212121;
  --calcite-color-foreground-3: var(--sys-color-action-pressed);
  --calcite-list-background-color: var(--sys-color-surface-overlay);
  --calcite-list-background-color-hover: #212121;
}

.arcade-content-builder-loading {
  background-color: var(--ref-palette-custom1-300);
}

.modal-icons-section {
  height: 40px;
  border: 1px solid var(--sys-color-divider-secondary, #585858);
  border-top: none;
}
`;function H(n){const r=n.invalidMessage,l=n.invalidKeys,s=n.unsupportedReturnTypeLabel;if(r){const o=(0,e.jsxs)("div",{className:(0,t.classNames)("invalid-msg d-flex",n.className),children:[(0,e.jsx)(d,{size:16,color:"var(--sys-color-error-main)"}),(0,e.jsx)(a.Label,{className:"mb-0 ml-1",children:r})]});let i="";return(null==l?void 0:l.length)>0&&(i=s+": "+l.join(", ")),i?(0,e.jsx)(a.Tooltip,{title:i,showArrow:!0,placement:"top",children:o}):o}return null}function J(e){let t=null;if(null==e||"number"==typeof e||"string"==typeof e||"boolean"==typeof e||e instanceof Date)t=e;else if(e&&"esri.arcade.Dictionary"===e.declaredClass){t={};const a=e.attributes;a&&Object.keys(a).forEach(e=>{t[e]=J(a[e])})}else G(e)||q(e)?t=e.toString():Array.isArray(e)&&(t=e.map(e=>J(e)));return t}function G(e){return"esri.core.sql.dateonly"===(null==e?void 0:e.declaredRootClass)}function q(e){return"esri.core.sql.timeonly"===(null==e?void 0:e.declaredRootClass)}function W(e,a){if(e&&a){const{profile:n,profileVariableInstances:r,timeZone:l}=a,s=n;a.type===t.ArcadeProfileType.FeatureProfile?s.id="experience-builder-list-item-widget-formatting":a.type===t.ArcadeProfileType.DataSourcesProfile&&(s.id="experience-builder-widget-formatting"),e.profile=s,e.testData={profileVariableInstances:r,timeZone:l||"system"}}}function X(e,a,n,r,l,s){const o={id:e,title:a,scriptContent:n,valueType:r,icons:l};(null==s?void 0:s.length)>0&&(o.useDataSources=s);return(0,t.Immutable)(o)}function Y(e){return`${t.arcadeContentUtils.doesWidgetHaveRepeatDataSource(e)?t.CONSTANTS.FEATURE_PROFILE_ARCADE_CONTENT_ID_PREFIX:t.CONSTANTS.DATA_SOURCES_PROFILE_ARCADE_CONTENT_ID_PREFIX}${(0,t.uuidv1)()}`}const Z=(0,n.withTheme)((0,t.injectIntl)(function(n){const l=n.onChange,s=n.capabilities,o=t.React.useMemo(()=>(null==s?void 0:s.length)>0?s:[t.ArcadeContentCapability.Value,t.ArcadeContentCapability.Style],[s]),i=n.useTitle,c=n.widgetId,d=t.React.useRef(c);d.current=c;const u=n.config,p=null==u?void 0:u.id,m=t.React.useMemo(()=>{let e=u;if(e){if(!e.id){const t=Y(c);e=e.set("id",t)}}else{e=X(Y(c),"","",null,[],null)}return e},[u,c]),v=m.id,y=t.React.useRef(v);y.current=v;const h=n.useDataSources,b=n.dynamicStyleTypes,x=n.modalOnly,j=n.insertMode,S=n.onModalClose,[w,O]=t.React.useState(!1),R=t.React.useRef(null);R.current=h,t.React.useEffect(()=>{const e=R.current;(null==e?void 0:e.length)>0&&function(e){return K(this,void 0,void 0,function*(){if((null==e?void 0:e.length)>0){const a=t.DataSourceManager.getInstance(),n=e.map(e=>K(this,void 0,void 0,function*(){try{yield a.createDataSourceByUseDataSource(e)}catch(t){console.error("dsManager.createDataSourceByUseDataSource() error",e,t)}}));yield Promise.all(n)}})}(e).then(()=>{O(!0)})},[]);const N=t.hooks.useArcgisArcadeEditor(),C=t.React.useMemo(()=>{if(!p&&v&&v.includes(t.CONSTANTS.DATA_SOURCES_PROFILE_ARCADE_CONTENT_ID_PREFIX)){return!t.arcadeContentUtils.canAddNewDataSourcesProfileArcadeContent(c)}return!1},[v,p,c]),T=m.title||"",A=m.scriptContent||"",M=m.icons,I=o.includes(t.ArcadeContentCapability.Value),P=o.includes(t.ArcadeContentCapability.Style),k=n.useIcons,D=t.React.useMemo(()=>!!o.includes(t.ArcadeContentCapability.Style)&&!("boolean"==typeof k&&!k),[o,k]),[_,E]=t.React.useState(!1),F=_||x,L=t.React.useRef(0),[B,Z]=t.React.useState(null),Q=t.React.useRef(null);Q.current=B;const ee=t.React.useRef(!1),[te,ae]=t.React.useState(null),ne=!!te,re=t.React.useRef(null),[le,se]=t.React.useState(!1),oe=!w||!le||!ne,[ie,ce]=t.React.useState(!1),de=t.React.useRef(null),[ue,pe]=t.React.useState(!1),me=!w||!ue||!ne,[fe,ve]=t.React.useState(T),ye=t.React.useRef(T),[he,ge]=t.React.useState(A),[be,xe]=t.React.useState(""),[je,Se]=t.React.useState([]),[we,Oe]=t.React.useState(M),Re=t.React.useRef(null),[Ne,Ce]=t.React.useState(!1),[Te,Ae]=t.React.useState(!1),Me=t.React.useRef(null),[Ie,Pe]=t.React.useState(!1),ke=Ie?Me.current:null,De=t.hooks.useTranslation(a.defaultMessages),_e=De("editScriptInArcadeEditor"),Ee=De("arcadeEditor"),Fe=De("dataSourcesArcadeContentCountLimit"),Le=De("scriptInUse"),Be=De("addScriptFirst"),Ue=De("copyToClipboard"),$e=De("scriptCopied"),Ke=De("arcadeScriptStoredLocally"),Ve=De("reset"),ze=De("invalidArcadeScript"),He=De("unsupportedReturnType"),Je=De(j?"insert":"apply"),Ge=De("close"),qe=De("arcadeScript"),We=De("icons");t.React.useEffect(()=>{!function(){K(this,void 0,void 0,function*(){let e="",a="";try{if(e=yield r.helpUtils.getWidgetHelpLink("advanced-formatting"),e||(e=""),e)try{a=yield t.urlUtils.createShortUrl(e),a||(a="")}catch(e){console.error("can not create short link for Arcade content help url",e),a=""}}catch(e){console.error("get Arcade content help doc url error",e)}ae({url:a||e||""})})}()},[]),t.React.useEffect(()=>(function(e){return K(this,void 0,void 0,function*(){var a;let n=null;try{if(e){const r=$(e),l=(null===(a=null==r?void 0:r.manifest)||void 0===a?void 0:a.name)||e;n=new t.indexedDBUtils.IndexedDBCache(e,l,"arcade"),yield n.init()}}catch(t){console.error("initialize arcade db error",e,t),n=null}return n&&!n.initialized()&&(n=null),n})}(d.current).then(e=>{Me.current=e,Pe(!0);const t=y.current;e&&t&&e.get(t).then(e=>{console.log("get Arcade script from indexedDB",t),"string"==typeof e&&e&&ge(e)}).catch(e=>{console.error("get Arcade script from indexedDB error",t,e)})}),()=>{Me.current&&Me.current.close()}),[]);const Xe=t.React.useCallback(e=>{l&&(ee.current=!0,l(e))},[l]),Ye=t.React.useCallback(()=>{const e=Q.current;if(!p&&!A&&!he&&e&&te){const a=function(e,a,n,r,l){var s;let o="";a&&(o=`// Documentation: ${a}\n\n`);let i="";if((null==e?void 0:e.type)===t.ArcadeProfileType.DataSourcesProfile){const u="function getFilteredFeatureSet(ds) {\n  var result = ds.layer;\n  var queryParams = ds.queryParams;\n\n  if (!IsEmpty(queryParams.where)) {\n    result = Filter(result, queryParams.where);\n  }\n\n  if (!IsEmpty(queryParams.geometry)) {\n    result = Intersects(result, queryParams.geometry);\n  }\n\n  return result;\n}\n\n",p=e,m=null===(s=null==p?void 0:p.profileVariableInstances)||void 0===s?void 0:s.$dataSources,f=[];if(m){const y=t.DataSourceManager.getInstance();Object.keys(m).forEach((e,t)=>{const a=t+1,n=y.getDataSource(e);if(n){const t=`\n// ${n.getLabel()||e}\n// The filteredFeatureSet${a} has already been filtered using spatial filters and attribute filters.\n// var filteredFeatureSet${a} = getFilteredFeatureSet($dataSources["${e}"]);\n// selectedFeatures${a} is the selection view of data source.\n// var selectedFeatures${a} = $dataSources["${e}"].selectedFeatures;\n\n`;f.push(t)}})}const v="\n// NOTE: When using selectedFeatures, cases with no selected features must be handled manually.\n\n";i=u+f.join("")+v}let c="";if(r&&(null==l?void 0:l.length)>0){function h(e,t){let a=e;const n=`[placeholder_${t}_start]`,r=`[placeholder_${t}_end]`,l=e.indexOf(n),s=e.indexOf(r);if(l>=0&&s>=0){const t=s+r.length;a=e.slice(0,l)+e.slice(t)}return a}c="\nreturn {\n  [placeholder_value_start]value: '',[placeholder_value_end]\n  [placeholder_background_start]background: {\n    // color: 'green',\n    // fillType: 'fill', // 'fit', 'fill', 'center', 'tile', 'stretch'\n    // image: ''\n  },[placeholder_background_end]\n  [placeholder_text_start]text: {\n    // size: 14,\n    // color: 'rgb(0, 0, 255)',\n    // bold: true,\n    // italic: false,\n    // underline: false,\n    // strike: false\n  },[placeholder_text_end]\n  [placeholder_border_start]border: {\n    // border: {\n    //   type: 'dashed', // 'solid', 'dashed', 'dotted', 'double'\n    //   color: 'red',\n    //   width: 1\n    // }\n  },[placeholder_border_end]\n  [placeholder_borderRadius_start]borderRadius: {\n    // unit: 'px', // 'px', 'rem', 'em', 'vw', '%'\n    // number: [5, 5, 5, 5]\n  },[placeholder_borderRadius_end]\n  [placeholder_icon_start]icon: {\n    // name: '',\n    // position: 'LEFT', // 'LEFT', 'RIGHT'\n    // size: 30,\n    // color: 'green'\n  }[placeholder_icon_end]\n};\n  ",n||(c=h(c,"value")),l.includes(t.DynamicStyleType.Background)||(c=h(c,"background")),l.includes(t.DynamicStyleType.Text)||(c=h(c,"text")),l.includes(t.DynamicStyleType.Border)||(c=h(c,"border")),l.includes(t.DynamicStyleType.BorderRadius)||(c=h(c,"borderRadius")),l.includes(t.DynamicStyleType.Icon)||(c=h(c,"icon"));const g=/\[placeholder_\w+_(?:start|end)\]/g;c=c.replace(g,"");const b=/^\s*$(?:\r\n?|\n)/gm;c=c.replace(b,""),c="\n"+c}else c=n?'return "";':"return {};";const d=o+i+c;return d}(e,te.url,I,P,b);a&&a!==A&&ge(a)}},[p,b,te,he,A,P,I]),Ze=t.React.useRef(null);Ze.current=Ye;const Qe=t.React.useCallback(e=>{Q.current=e,Z(e),W(re.current,e),W(de.current,e),!B&&e&&Ze.current()},[B]);t.React.useEffect(()=>{te&&Ze.current()},[te]);const et=t.React.useRef(!1);et.current=i&&!T;const tt=t.React.useRef(!1),at=t.React.useRef("");at.current=De("arcade"),t.React.useEffect(()=>{if(et.current){V++,tt.current=!0;const e=`${at.current} ${V}`;ve(e)}return()=>{tt.current&&!ee.current&&V--}},[]);const nt=t.React.useCallback(()=>{C||(xe(""),Se([]),Ae(!1),E(!0))},[C]),rt=t.React.useCallback(()=>{!function(){K(this,void 0,void 0,function*(){try{yield navigator.clipboard.writeText(A),ce(!0)}catch(e){console.error("copy Arcade script error",e)}finally{setTimeout(()=>{ce(!1)},2e3)}})}()},[A]),lt=t.React.useCallback(e=>{e&&e.componentOnReady().then(()=>{se(!0)}).catch(e=>{console.error("ArcgisArcadeEditor componentOnReady error",e)}),re.current=e,W(e,B)},[B]),st=Te||i&&!fe||!he||fe===T&&he===A&&we===M,ot=he!==A&&!(!p&&j),it=t.React.useCallback(e=>{var t;const a=(null===(t=null==e?void 0:e.target)||void 0===t?void 0:t.value)||"";ve(a)},[]),ct=t.React.useCallback(e=>{var t;const a=(null===(t=null==e?void 0:e.target)||void 0===t?void 0:t.value)||"";ye.current=a},[]),dt=t.React.useCallback(e=>{var t;!((null===(t=null==e?void 0:e.target)||void 0===t?void 0:t.value)||"")&&ye.current&&ve(ye.current)},[]),ut=t.React.useCallback(()=>{ge(A)},[A]),pt=t.React.useCallback(e=>{e&&e.componentOnReady().then(()=>{pe(!0)}).catch(e=>{console.error("ArcgisArcadeEditor componentOnReady error",e)}),de.current=e,W(e,B)},[B]),mt=t.React.useCallback(e=>{const t=e.detail||"";ge(t)},[]),ft=t.React.useCallback(()=>{Ce(!Ne)},[Ne]),vt=t.React.useCallback(()=>{Ce(!1)},[]),yt=t.React.useCallback(()=>{Ce(!1)},[]),ht=t.React.useCallback(e=>{Oe(e)},[]),gt=t.React.useCallback(()=>{const e=de.current;if(!e)return;L.current++,Ae(!0);const a=L.current;(function(e,a,n,r,l,s){return K(this,void 0,void 0,function*(){let o=null;const i={valueType:null,errorMsg:s,invalidKeys:[]},c={valueType:null,errorMsg:l,invalidKeys:[]},d=(null==n?void 0:n.script)||"",u=null==n?void 0:n.profile;let p=[];try{const l=n.getTestResult(),m=function(e,a,n,r){return K(this,void 0,void 0,function*(){var l,s;let o=[];try{if(1===(null===(l=r.variables)||void 0===l?void 0:l.length)){const l=r.variables[0],i=t.DataSourceManager.getInstance();if("$feature"===(null==l?void 0:l.name)){let l=t.arcadeContentUtils.tryGetRepeatedUseDataSource(e);if(l){const e=[];(null==a?void 0:a.length)>0&&a.forEach(t=>{const a=null==t?void 0:t.dataSourceId;a&&e.push(a)}),e.includes(l.dataSourceId)||(l=null)}if(l){const e=yield(0,t.loadArcGISJSAPIModule)("esri/arcade"),a=yield e.createArcadeExecutor(n,r);if((null===(s=null==a?void 0:a.fieldsUsed)||void 0===s?void 0:s.length)>0){const e=a.fieldsUsed.slice().map(e=>e.toLocaleLowerCase()),t=l.asMutable({deep:!0}),n=i.getDataSource(t.dataSourceId);if(n){const a=n.getSchema(),r=null==a?void 0:a.fields;if(r){const a=Object.keys(r).filter(t=>e.includes(t.toLocaleLowerCase()));a.length>0&&(delete t.useFieldsInPopupInfo,delete t.useFieldsInSymbol,t.fields=a,o=[t])}}}}}else"$dataSources"===(null==l?void 0:l.name)&&n&&(null==a?void 0:a.length)>0&&a.forEach(e=>{if(e){const t=i.getDataSource(e.dataSourceId);if(t){const a=t.getSchema(),r=null==a?void 0:a.fields;if(r){const t=Object.keys(r).filter(e=>{let t=n.includes(`'${e}'`)||n.includes(`"${e}"`);if(!t)try{const a=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");t=new RegExp(`\\.${a}\\b`,"g").test(n)}catch(e){t=!1}return t});if(t.length>0){const a=e.asMutable({deep:!0});delete a.useFieldsInPopupInfo,delete a.useFieldsInSymbol,a.fields=t,o.push(a)}}}}})}}catch(e){console.error("getArcadeUseDataSources() error",e),o=[]}return o})}(e,a,d,u),[f,v]=yield Promise.all([l,m]);if(p=v,f){const e=f.type;if("error"===e)return o=c,o;if("number"===e)o={valueType:t.JimuFieldType.Number,errorMsg:"",invalidKeys:[]};else if("text"===e)o={valueType:t.JimuFieldType.String,errorMsg:"",invalidKeys:[]};else if("date"===e)o={valueType:t.JimuFieldType.Date,errorMsg:"",invalidKeys:[]};else if("dateOnly"===e)o={valueType:t.JimuFieldType.DateOnly,errorMsg:"",invalidKeys:[]};else if("time"===e)o={valueType:t.JimuFieldType.TimeOnly,errorMsg:"",invalidKeys:[]};else if("dictionary"===e){const e=f.value;if(e&&"esri.arcade.Dictionary"===e.declaredClass){const a=e.attributes;if(a){const n=a.value;G(n)?o={valueType:t.JimuFieldType.DateOnly,errorMsg:"",invalidKeys:[]}:q(n)?o={valueType:t.JimuFieldType.TimeOnly,errorMsg:"",invalidKeys:[]}:"number"==typeof n?o={valueType:t.JimuFieldType.Number,errorMsg:"",invalidKeys:[]}:"string"==typeof n?o={valueType:t.JimuFieldType.String,errorMsg:"",invalidKeys:[]}:n instanceof Date?o={valueType:t.JimuFieldType.Date,errorMsg:"",invalidKeys:[]}:null==n&&(o=r?{valueType:null,errorMsg:s,invalidKeys:["value"]}:{valueType:null,errorMsg:"",invalidKeys:[]}),o||(o={valueType:null,errorMsg:s,invalidKeys:["value"]}),o.invalidKeys||(o.invalidKeys=[]);const l=J(e);if(l){delete l.value;const e=t.arcadeContentUtils.validateArcadeScriptResult(l);e.valid||(o.errorMsg=s),o.invalidKeys.push(...e.invalidKeys)}}}}o||(o=i)}}catch(e){console.error("ArcadeEditor can not get test result",e),o=c}return o&&r&&!o.valueType&&!o.errorMsg&&(o=c),o||(o=c),o.invalidKeys||(o.invalidKeys=[]),(null==p?void 0:p.length)>0&&(o.arcadeUseDataSources=p),o})})(c,h,e,I,ze,He).then(e=>K(this,void 0,void 0,function*(){if(L.current!==a)return;Ae(!1);const{valueType:t,errorMsg:n,invalidKeys:r,arcadeUseDataSources:l}=e;if(n)xe(n||ze),Se(r);else{const e=X(v,fe,he,t,we,l);if(Xe(e),xe(""),Se([]),E(!1),ke&&v)try{yield ke.delete(v),console.log("delete Arcade script from indexedDB",v)}catch(e){console.error("delete Arcade script from indexedDB error",v,e)}S&&S()}}))},[v,ke,ze,he,we,fe,S,He,Xe,h,I,c]),bt=t.React.useCallback(()=>{if(L.current++,E(!1),Ae(!1),!j){let e=m;fe&&fe!==T&&(e=e.set("title",fe)),we!==M&&(e=e.set("icons",we));const t=!p&&e.id&&ot;(t||p&&e!==m)&&Xe(e);ke&&v&&(t||p)&&ke.put(v,he).then(()=>{console.log("save Arcade script into indexedDB",v)}).catch(e=>{console.error("save Arcade script into indexedDB error",v,e)})}S&&S()},[v,p,m,M,ke,j,he,we,fe,S,ot,T,Xe]),xt=x?"d-none":"d-flex";return(0,e.jsxs)("div",{className:(0,t.classNames)("arcade-style-builder p-4 h-100",xt,n.className),css:z,children:[!x&&(0,e.jsxs)(t.React.Fragment,{children:[(0,e.jsx)("div",{className:"mb-4","aria-label":_e,children:_e}),(0,e.jsx)(a.Button,{className:"mb-4",color:"primary","aria-label":Ee,disabled:C,onClick:nt,children:Ee}),C&&(0,e.jsx)(a.Alert,{className:"w-100 mt-2",form:"basic",text:Fe,type:"warning",withIcon:!0}),!C&&(0,e.jsxs)(t.React.Fragment,{children:[(0,e.jsx)("div",{className:"mb-4","aria-label":Le,children:Le}),(0,e.jsx)("div",{className:"script-section h-100",children:(0,e.jsxs)("div",{className:"text-area-container h-100",children:[(0,e.jsx)(a.TextArea,{className:"h-100",disabled:!0,value:A,placeholder:Be}),A&&(0,e.jsx)(a.Tooltip,{title:$e,open:ie,disableFocusListener:!0,disableHoverListener:!0,disableTouchListener:!0,children:(0,e.jsx)(a.Button,{className:"copy-script-btn",size:"sm",icon:!0,type:"tertiary",target:"_blank",disableHoverEffect:!0,disableRipple:!0,title:Ue,"aria-label":Ue,onClick:rt,children:(0,e.jsx)(f,{})})})]})})]}),N&&(0,e.jsx)("arcgis-arcade-editor",{className:"hidden-arcgis-arcade-editor d-none",ref:lt,editorOptions:{theme:"vs-dark"},script:he}),oe&&(0,e.jsx)(a.Loading,{className:"arcade-content-builder-loading",type:a.LoadingType.Secondary})]}),(0,e.jsx)(t.ArcadeProfileContextProvider,{usedForArcadeEditor:!0,widgetId:c,useDataSources:h,onProfileContextChange:Qe}),F&&!C&&(0,e.jsxs)(a.Modal,{className:(0,t.classNames)("arcade-editor-modal",n.className),css:z,style:{maxWidth:1120,flexDirection:"row"},centered:!0,contentClassName:"border-0 h-100",isOpen:!0,keyboard:!0,children:[(0,e.jsx)(a.ModalHeader,{className:"d-flex justify-content-between align-items-center",toggle:bt,children:qe}),(0,e.jsxs)(a.ModalBody,{className:"w-auto pt-2",children:[i&&(0,e.jsxs)("div",{className:"mb-2",children:[(0,e.jsx)(a.Label,{children:De("name")}),(0,e.jsx)(a.TextInput,{disabled:Te,value:fe,onChange:it,onFocus:ct,onBlur:dt})]}),(0,e.jsxs)("div",{className:(0,t.classNames)(["arcade-script-stored-locally-tip-container d-flex align-items-center",{hidden:!ot}]),children:[(0,e.jsx)(g,{color:"var(--sys-color-info-main)"}),(0,e.jsx)("div",{className:"arcade-script-stored-locally-tip ml-2","aria-label":Ke,children:Ke}),(0,e.jsx)(a.Button,{className:"ml-2",size:"sm",onClick:ut,children:Ve})]}),N&&(0,e.jsxs)("div",{className:"modal-arcgis-arcade-editor-container mt-2",children:[(0,e.jsx)("arcgis-arcade-editor",{className:"modal-arcgis-arcade-editor h-100",ref:pt,editorOptions:{theme:"vs-dark"},script:he,onarcgisScriptChange:mt}),Te&&(0,e.jsx)("div",{className:"modal-arcgis-arcade-editor-overlay"})]}),D&&(0,e.jsxs)("div",{className:"modal-icons-section d-flex align-items-center w-100",children:[(0,e.jsx)(a.Button,{className:"ml-2",type:"default",size:"sm","aria-label":We,ref:Re,onClick:ft,children:We}),Ne&&(0,e.jsx)(a.Popper,{open:Ne,placement:"top-start",reference:Re,toggle:vt,offsetOptions:[0,8],children:(0,e.jsx)("div",{className:"modal-icons-selector-container",style:{minWidth:"230px",height:"246px"},children:(0,e.jsx)(U,{inModal:!0,expand:!1,icons:we,onClose:yt,onIconsChange:ht})})})]}),me&&(0,e.jsx)(a.Loading,{className:"arcade-content-builder-loading",type:a.LoadingType.Secondary})]}),(0,e.jsx)(a.ModalFooter,{className:"d-flex flex-column pb-30",children:(0,e.jsxs)("div",{className:"w-100 d-flex justify-content-between",children:[(0,e.jsx)(H,{className:"modal-invalid-msg mr-2",invalidMessage:be,invalidKeys:je,unsupportedReturnTypeLabel:He}),(0,e.jsxs)(a.Button,{type:"primary",className:"ml-auto mr-2",style:{minWidth:"64px",minHeight:"32px"},"aria-label":Je,disabled:st,onClick:gt,children:[Te&&(0,e.jsx)(a.Loading,{type:a.LoadingType.Donut,height:20,width:20}),!Te&&Je]}),!j&&(0,e.jsx)(a.Button,{type:"secondary",style:{minWidth:"64px",minHeight:"32px"},"aria-label":Ge,onClick:bt,children:Ge})]})})]})]})}));class Q extends t.React.PureComponent{constructor(e){super(e),this.overflowYStyle={overflow:"hidden"},this.__unmount=!1,this.state={SidePopper:null}}componentDidMount(){this.__unmount=!1,t.moduleLoader.loadModule("jimu-ui/advanced/setting-components").then(e=>{!this.__unmount&&this.setState({SidePopper:e.SidePopper})})}componentWillUnmount(){this.__unmount=!0}render(){const n=this.state.SidePopper,r=this.props.intl.formatMessage({id:"arcade",defaultMessage:a.defaultMessages.arcade});return(0,e.jsx)("div",{className:"arcade-content-builder-popup w-100 h-100",children:n&&(0,e.jsx)(n,{isOpen:this.props.isOpen&&!t.urlUtils.getAppIdPageIdFromUrl().pageId,position:"right",toggle:this.props.onClose,trigger:this.props.trigger,backToFocusNode:this.props.backToFocusNode,title:r,children:(0,e.jsx)("div",{className:"h-100 bg-default border-color-gray-400 component-arcade-content-builder-popup",children:(0,e.jsx)("div",{className:"w-100 h-100 arcade-popup",children:(0,e.jsx)("div",{style:this.overflowYStyle,className:"h-100",children:(0,e.jsx)(Z,Object.assign({},this.props))})})})})})}}const ee=(0,n.withTheme)((0,t.injectIntl)(Q))})(),i})())}}});
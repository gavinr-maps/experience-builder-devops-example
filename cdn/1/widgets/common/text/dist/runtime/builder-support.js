System.register(["jimu-core","jimu-ui","jimu-ui/advanced/rich-text-editor"],(function(e,t){var o={},r={},n={};return{setters:[function(e){o.DataSourceManager=e.DataSourceManager,o.Immutable=e.Immutable,o.React=e.React,o.ReactRedux=e.ReactRedux,o.appActions=e.appActions,o.css=e.css,o.getAppStore=e.getAppStore,o.jsx=e.jsx},function(e){r.defaultMessages=e.defaultMessages,r.hooks=e.hooks,r.richTextUtils=e.richTextUtils,r.sanitizer=e.sanitizer},function(e){n.Bubble=e.Bubble,n.Delta=e.Delta,n.Expression=e.Expression,n.RichTextEditor=e.RichTextEditor,n.richTextEditorUtils=e.richTextEditorUtils}],execute:function(){e((()=>{"use strict";var e={48891:e=>{e.exports=o},30726:e=>{e.exports=r},65492:e=>{e.exports=n}},t={};function s(o){var r=t[o];if(void 0!==r)return r.exports;var n=t[o]={exports:{}};return e[o](n,n.exports,s),n.exports}s.d=(e,t)=>{for(var o in t)s.o(t,o)&&!s.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var a={};return(()=>{s.r(a),s.d(a,{default:()=>j});var e={};s.r(e),s.d(e,{DATA_SOURCE_ID_REGEXP:()=>l,getDataSourceIds:()=>c,getDefaultValue:()=>h,getExpressionParts:()=>d,getInvalidDataSourceIds:()=>u,getUseDataSourceIds:()=>i,sanitizeHTML:()=>f,shouldShowPlaceholder:()=>p});var t=s(48891),o=s(30726),r=s(65492);const n=(e,t)=>{const r=o.richTextUtils.getHTMLTextContent(e);return e.replace(null==r?void 0:r.trim(),t)},l=/data-dsid=\"(((?![\=|\>|\"]).)*)[\"\>|"\s)]/gm,c=(e=(0,t.Immutable)([]))=>e.map((e=>{return o=null==e?void 0:e.dataSourceId,null!=t.DataSourceManager.getInstance().getDataSource(o)?null==e?void 0:e.dataSourceId:null;var o})).filter((e=>null!=e)),i=e=>{const t=l;let o,r=[];for(;null!==(o=t.exec(e));){let e=o[1];e.indexOf(",")>0?(e=e.split(","),r=r.concat(e)):r.push(e)}return r},u=(e,t)=>{const o=i(e);if(null==o||o.length<=0)return;const r=c(t),n=o.filter((e=>!r.includes(e)));return n.length>=0?n:void 0},d=e=>{let t=[];for(const o in e){const r=e[o],n=null==r?void 0:r.parts;null!=n&&(t=t.concat(n))}return t},p=(e,t,r)=>{const n=o.richTextUtils.isBlankRichText(e)&&!!t;return void 0!==r?!r&&n:n},f=(e="")=>""!==e?o.sanitizer.sanitize(e):e,h=(e,t,r="")=>{let s=t;const a=p(t,r);return e?a&&(s=n(r,o.richTextUtils.BLANK_CHARATER)):s=a?r:t,f(s)};const{useEffect:m,useRef:g,useState:b,useMemo:v}=t.React,x={toolbar:!1,autoformat:{link:{trigger:/[\s]/,find:/https?:\/\/[\S]+|(www\.[\S]+)/gi,transform:function(e,t){return t?"http://"+e:e},format:"link"}},clipboard:{matchers:[["img",()=>new r.Delta]]}},R=/(?!^\n$)[\n]/gm,S=(e,t)=>(t.forEach((e=>{"string"==typeof e.insert&&(e.insert=e.insert.replace(R," "))})),t),y=e=>{e.clipboard.addMatcher("*",S)},E=(e,t)=>{if(null==e)return;const o=(e=>{const t=e.clipboard.matchers;let o=-1;if(t.some((([e,t],r)=>"*"===e&&t===S&&(o=r,!0))),o>-1)return e.clipboard.matchers.splice(o,1),!0})(e);t=f(t);const n=e.clipboard.convert(t);e.setContents(n,"silent"),r.richTextEditorUtils.setEditorCursorEnd(e,"silent"),o&&y(e)},C=e=>{const{editorRef:s,value:a,placeholder:l,enabled:c,onChange:i,onComplete:u}=e,d=function(e,t){var o={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(o[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(o[r[n]]=e[r[n]])}return o}(e,["editorRef","value","placeholder","enabled","onChange","onComplete"]),[f,R]=o.hooks.useForwardRef(s),[S,C]=b(a),[O,w]=b(l),I=((e,t,o,r,n)=>{const s=g({enabled:e,value:t,placeholder:o,onChange:r,onComplete:n});return m((()=>{s.current={enabled:e,value:t,placeholder:o,onChange:r,onComplete:n}}),[e,t,o,r,n]),s})(c,S,O,i,u),T=v((()=>h(c,S,O)),[]),j=o.hooks.useEventCallback(((e,t,o)=>{"silent"!==o&&(p(S,O,c)?w(e):(C(e),null==i||i(e)))}));return o.hooks.useUpdateEffect((()=>{if(w(l),p(S,l)){const e=f.current;E(e,l)}}),[l]),o.hooks.useUpdateEffect((()=>{const{value:e,placeholder:t,onComplete:r}=I.current,s=f.current;if(c){const r=f.current;if(p(e,t)){const e=n(t,o.richTextUtils.BLANK_CHARATER);E(r,e),r.focus()}}else p(e,t)&&E(s,t),null==r||r(e,t)}),[c]),m((()=>{const e=f.current;null!=e&&y(e)}),[f]),o.hooks.useUnmount((()=>{const{value:e,placeholder:t,onComplete:o}=I.current;null==o||o(e,t)})),t.React.createElement(r.RichTextEditor,Object.assign({autoFocus:!0,enabled:c,editorRef:R,onChange:j,defaultValue:T,modules:x},d))},O=e=>{const{editor:n,formats:s,selection:a,useDataSources:l,widgetId:c,enabled:i,onInitResizeHandler:u}=e,d=t.ReactRedux.useSelector((e=>{var t;return null===(t=e.widgetsState[c])||void 0===t?void 0:t.showExpression})),p=o.hooks.useTranslate(o.defaultMessages),[f,h]=t.React.useState(0),[m,g]=t.React.useState(0),b=t.React.useRef(null);t.React.useEffect((()=>{null==u||u((()=>{var e;h((e=>e+1)),null===(e=b.current)||void 0===e||e.classList.add("d-none")}),null,(()=>{var e;g((e=>e+1)),null===(e=b.current)||void 0===e||e.classList.remove("d-none")}))}),[u]);const v=t.React.useMemo((()=>({title:p("dynamicContent"),onClose:()=>(0,t.getAppStore)().dispatch(t.appActions.widgetStatePropChange(c,"showExpression",!1))})),[c,p]);return o.hooks.useUpdateEffect((()=>{h((e=>e+1))}),[i]),t.React.createElement(t.React.Fragment,null,t.React.createElement(r.Bubble,{editor:n,formats:s,selection:a,source:"user",version:f}),t.React.createElement(r.Expression,{ref:b,version:m,source:"user",editor:n,formats:s,selection:a,open:d,useDataSources:l,header:v,widgetId:c}))};const{useMemo:w,useCallback:I}=t.React,T=t.css`
  opacity: 0.5;
  background: red;
  outline: 1px solid white;
`,j={Editor:e=>{const{value:o,widgetId:r,useDataSources:n,onComplete:s,onCreate:a,onDestory:l,onInitResizeHandler:c,enabled:i}=e,d=function(e,t){var o={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(o[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(o[r[n]]=e[r[n]])}return o}(e,["value","widgetId","useDataSources","onComplete","onCreate","onDestory","onInitResizeHandler","enabled"]),[p,f]=t.React.useState(o),h=((e,t)=>I((o=>null!=o?null==e?void 0:e(o):null==t?void 0:t()),[e,t]))(a,l),m=((e,o,r,n)=>t.React.useMemo((()=>({editor:s,selection:a,formats:l})=>(0,t.jsx)(O,{editor:s,selection:a,formats:l,widgetId:e,useDataSources:o,enabled:r,onInitResizeHandler:n})),[r,n,o,e]))(r,n,i,c),g=((e,o)=>w((()=>{const r=u(e,o);let n;return null!=r&&r.length>0&&(n=r.map((e=>t.css`
          exp[data-dsid*="${e}"] {
           ${T}
          }
        `))),t.css`${n}`}),[e,o]))(p,n);return(0,t.jsx)(C,Object.assign({editorRef:h,css:g,value:o,plugin:m,onChange:f,onComplete:s,enabled:i},d))},builderUtils:e}})(),a})())}}}));
System.register(["jimu-core/emotion","jimu-core","jimu-ui/advanced/rich-text-editor","jimu-ui","jimu-theme","jimu-for-builder"],function(e,t){var r={},o={},n={},i={},a={},s={};return{setters:[function(e){r.jsx=e.jsx,r.jsxs=e.jsxs},function(e){o.ArcadeContentCapability=e.ArcadeContentCapability,o.BrowserSizeMode=e.BrowserSizeMode,o.DataSourceManager=e.DataSourceManager,o.DynamicStyleType=e.DynamicStyleType,o.Immutable=e.Immutable,o.React=e.React,o.ReactRedux=e.ReactRedux,o.appActions=e.appActions,o.appConfigUtils=e.appConfigUtils,o.arcadeContentUtils=e.arcadeContentUtils,o.dataSourceUtils=e.dataSourceUtils,o.focusElementInKeyboardMode=e.focusElementInKeyboardMode,o.getAppStore=e.getAppStore,o.hooks=e.hooks},function(e){n.Bubble=e.Bubble,n.RichExpressionBuilderPopper=e.RichExpressionBuilderPopper,n.RichTextEditor=e.RichTextEditor,n.richTextEditorUtils=e.richTextEditorUtils},function(e){i.ModalOverlayIdContext=e.ModalOverlayIdContext,i.defaultMessages=e.defaultMessages,i.richTextUtils=e.richTextUtils,i.sanitizer=e.sanitizer},function(e){a.ThemeSwitchComponent=e.ThemeSwitchComponent},function(e){s.appBuilderSync=e.appBuilderSync}],execute:function(){e((()=>{var e={1888:e=>{"use strict";e.exports=a},4108:e=>{"use strict";e.exports=s},14321:e=>{"use strict";e.exports=i},33949:e=>{"use strict";e.exports=n},67386:e=>{"use strict";e.exports=r},79244:e=>{"use strict";e.exports=o}},t={};function l(r){var o=t[r];if(void 0!==o)return o.exports;var n=t[r]={exports:{}};return e[r](n,n.exports,l),n.exports}l.d=(e,t)=>{for(var r in t)l.o(t,r)&&!l.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),l.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},l.p="";var d={};return l.p=window.jimuConfig.baseUrl,(()=>{"use strict";l.r(d),l.d(d,{default:()=>ee});var e={};l.r(e),l.d(e,{DATA_SOURCE_ID_REGEXP:()=>R,canAddArcadeContent:()=>B,getDefaultValue:()=>O,getExpressionParts:()=>s,getInvalidDataSourceIds:()=>w,getMainDataSourceIds:()=>T,getOtherArcadeContentCount:()=>D,getUseDataSourceIds:()=>x,sanitizeHTML:()=>v,shouldShowPlaceholder:()=>I});var t=l(67386),r=l(79244),o=l(33949),n=l(14321);const i=(e,t)=>{const r=n.richTextUtils.getHTMLTextContent(e);return e.replace(null==r?void 0:r.trim(),t)},a=(e,t)=>(t.forEach(e=>{var t;const r=null===(t=null==e?void 0:e.attributes)||void 0===t?void 0:t.linespace;r&&isNaN(Number(r))&&(e.attributes.linespace=1.5)}),t),s=e=>{let t=[];for(const r in e){const o=e[r];null!=(null==o?void 0:o.parts)&&(t=t.concat(null==o?void 0:o.parts))}return t};var c,u,p,h,g,S,f,_,E;!function(e){e.Small="SMALL",e.Medium="MEDIUM",e.Large="LARGE"}(c||(c={})),function(e){e.String="STRING",e.Number="NUMBER",e.Date="DATE",e.DateOnly="DATE_ONLY",e.TimeOnly="TIME_ONLY"}(u||(u={})),function(e){e.BigInteger="esriFieldTypeBigInteger",e.Blob="esriFieldTypeBlob",e.Date="esriFieldTypeDate",e.DateOnly="esriFieldTypeDateOnly",e.TimeOnly="esriFieldTypeTimeOnly",e.Double="esriFieldTypeDouble",e.Geometry="esriFieldTypeGeometry",e.GlobalID="esriFieldTypeGlobalID",e.GUID="esriFieldTypeGUID",e.Integer="esriFieldTypeInteger",e.OID="esriFieldTypeOID",e.Raster="esriFieldTypeRaster",e.Single="esriFieldTypeSingle",e.SmallInteger="esriFieldTypeSmallInteger",e.String="esriFieldTypeString",e.XML="esriFieldTypeXML"}(p||(p={})),function(e){e.Fetching="FETCHING",e.Success="SUCCESS",e.Error="ERROR"}(h||(h={})),function(e){e.Design="DESIGN",e.Run="RUN",e.Express="EXPRESS"}(g||(g={})),function(e){e.Opened="OPENED",e.Active="ACTIVE",e.Closed="CLOSED",e.Hidden="HIDDEN"}(S||(S={})),function(e){e.None="NONE",e.Page="PAGE",e.Dialog="DIALOG",e.View="VIEW",e.WebAddress="WEB_ADDRESS",e.Block="BLOCK",e.Screen="SCREEN",e.PageTop="PAGE_TOP",e.PrintPreview="PRINT_PREVIEW",e.CookieBanner="COOKIE_BANNER"}(f||(f={})),function(e){e.CurrentWindow="_self",e.TopWindow="_top",e.NewWindow="_blank"}(_||(_={})),function(e){e.Normal="NORMAL",e.Layout="LAYOUT"}(E||(E={}));var b,m;!function(e){e.Header="HEADER",e.Footer="FOOTER",e.Body="BODY"}(b||(b={})),function(e){e.Http="http:",e.Https="https:"}(m||(m={}));var y,A;!function(e){e.Image="IMAGE",e.Config="CONFIG",e.Translation="TRANSLATION"}(y||(y={})),function(e){e.EXB_DATA_SOURCE_ID_SET_TO_CREATED_JS_API_LAYER="_exb_data_source_id_set_to_created_js_api_layer",e.EXB_OID="_exb_oid",e.EXB_NOT_EDITABLE="_exb_not_editable",e.EXB_DATA_SOURCE="__exb_data_source",e.EXB_DATA_SET="__exb_data_set",e.EXB_LAYER_VIEW_IGNORE_SPATIAL_FILTER="__exb_layer_view_ignore_spatial_filter",e.EXB_LAYER_FROM_RUNTIME="__exb_layer_from_runtime",e.EXB_DATA_SOURCE_ID="__exb_data_source_id",e.EXB_JIMU_LAYER_VIEW_ID="__exb_jimu_layer_view_id",e.EXB_PREDEFINED_RENDERER="__exb_predefined_renderer",e.EXB_LAYER_REMOVED_BEFORE="__exb_layer_removed_before",e.EXB_LAYER_CREATED_BY_DATA_SOURCE="__exb_layer_created_by_data_source"}(A||(A={}));const C={};C[c.Large]=[{width:1024,height:768},{width:1280,height:800},{width:1280,height:1024},{width:1366,height:768},{width:1440,height:900},{width:1536,height:864},{width:1600,height:900},{width:1920,height:1080}],C[c.Medium]=[{width:601,height:962},{width:600,height:1024},{width:768,height:1024},{width:800,height:1280},{width:834,height:1112}],C[c.Small]=[{width:360,height:640},{width:360,height:720},{width:360,height:740},{width:375,height:667},{width:414,height:736}];const R=/data-dsid=\"(((?![\=|\>|\"]).)*)[\"\>|"\s)]/gm,T=(e=(0,r.Immutable)([]))=>e.map(e=>{return t=null==e?void 0:e.dataSourceId,null!=r.DataSourceManager.getInstance().getDataSource(t)?null==e?void 0:e.mainDataSourceId:null;var t}).filter(e=>null!=e),x=e=>{const t=R;let r,o=[];for(;null!==(r=t.exec(e));){let e=r[1];e.indexOf(",")>0?(e=e.split(","),o=o.concat(e)):o.push(e)}return o},w=(e,t)=>{const o=x(e);if(null==o||!o.length)return;let n=o.map(e=>r.dataSourceUtils.getMainDataSourceId(e)).filter(e=>null!=e);n=Array.from(new Set(n));const i=T(t);return n.filter(e=>!i.includes(e))},I=(e,t,r)=>{const o=n.richTextUtils.isBlankRichText(e)&&!!t;return void 0!==r?!r&&o:o},v=(e="")=>""!==e?n.sanitizer.sanitize(e):e,O=(e,t,r="")=>{let o=t;const n=I(t,r);return e?n&&(o=i(r,"\ufeff")):o=n?r:t,v(o)},D=(e,t)=>{const o=n.richTextUtils.getArcades(e),i=Object.keys(o).length,a=r.arcadeContentUtils.getWidgetRestAvailableArcadeContentCount(t);if(a===1/0)return 1/0;return 10-a-i},B=(e,t,o)=>{if(e===1/0)return(0,r.getAppStore)().dispatch(r.appActions.widgetStatePropChange(o,"canAddArcadeContent",!0)),(0,r.getAppStore)().dispatch(r.appActions.widgetToolbarStateChange(o,["text-arcade"])),!0;const i=n.richTextUtils.getArcades(t),a=10-e-Object.keys(i).length>0;return(0,r.getAppStore)().dispatch(r.appActions.widgetStatePropChange(o,"canAddArcadeContent",a)),(0,r.getAppStore)().dispatch(r.appActions.widgetToolbarStateChange(o,["text-arcade"])),a};var M=function(e,t){var r={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(r[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(o=Object.getOwnPropertySymbols(e);n<o.length;n++)t.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(r[o[n]]=e[o[n]])}return r};const{useEffect:U,useRef:P,useState:j,useMemo:N,useCallback:L}=r.React,F={toolbar:!1,autoformat:{link:{trigger:/[\s]/,find:/https?:\/\/[\S]+|(www\.[\S]+)/gi,transform:function(e,t){return t?"http://"+e:e},format:"link"}},clipboard:{matchers:[["p",a],["li",a],["h1",a],["h2",a],["h3",a],["h4",a],["h5",a],["h6",a]]}},k=/(?!^\n$)[\n]/gm,G=(e,t)=>(t.forEach(e=>{"string"==typeof e.insert&&(e.insert=e.insert.replace(k," "))}),t),X=e=>{e.clipboard.addMatcher("*",G)},z=(e,t)=>{if(null==e)return;const r=(e=>{const t=e.clipboard.matchers;let r=-1;if(t.some(([e,t],o)=>"*"===e&&t===G&&(r=o,!0)),r>-1)return e.clipboard.matchers.splice(r,1),!0})(e);t=v(t);const n=e.clipboard.convert({html:t});e.setContents(n,"silent"),o.richTextEditorUtils.setEditorCursorEnd(e,"silent"),r&&X(e)},H=e=>{const{editorRef:a,value:s,placeholder:l,enabled:d,widgetId:c,onChange:u,onComplete:p}=e,h=M(e,["editorRef","value","placeholder","enabled","widgetId","onChange","onComplete"]),g=r.React.useContext(n.ModalOverlayIdContext),S=r.React.useMemo(()=>Object.assign(Object.assign({},F),{imageResize:{modalId:g}}),[g]),[f,_]=r.hooks.useForwardRef(a),[E,b]=j(s),[m,y]=j(l),A=((e,t,r,o,n)=>{const i=P({enabled:e,value:t,placeholder:r,onChange:o,onComplete:n});return U(()=>{i.current={enabled:e,value:t,placeholder:r,onChange:o,onComplete:n}},[e,t,r,o,n]),i})(d,E,m,u,p),[C,R]=j(),T=P(!0),x=N(()=>O(d,E,m),[]);U(()=>{const e=D(s,c);R(e),T.current=B(e,s,c)},[s,c]);const w=r.hooks.useEventCallback((e,t,r)=>{"silent"!==r&&(I(E,m,d)?y(e):(b(e),null==u||u(e)),T.current=B(C,e,c))});r.hooks.useUpdateEffect(()=>{if(y(l),I(E,l)){const e=f.current;z(e,l)}},[l]),r.hooks.useUpdateEffect(()=>{const{value:e,placeholder:t,onComplete:o}=A.current,n=f.current;if(d){const o=f.current;if(I(e,t)){const e=i(t,"\ufeff");z(o,e),(0,r.focusElementInKeyboardMode)(o,!0)}}else I(e,t)&&z(n,t),null==o||o(e,t)},[d]),U(()=>{const e=f.current;null!=e&&X(e)},[f]),r.hooks.useUnmount(()=>{const{value:e,placeholder:t,enabled:r,onComplete:o}=A.current;r&&(null==o||o(e,t))});const v=L((e,t,o)=>{if("user"===t&&!T.current)if(e&&e.length>0){const t=o.getFormat(e),n=null!=(null==t?void 0:t.arcade);if(!n)return;(0,r.getAppStore)().dispatch(r.appActions.widgetStatePropChange(c,"canAddArcadeContent",n)),(0,r.getAppStore)().dispatch(r.appActions.widgetToolbarStateChange(c,["text-arcade"]))}else(0,r.getAppStore)().dispatch(r.appActions.widgetStatePropChange(c,"canAddArcadeContent",!1)),(0,r.getAppStore)().dispatch(r.appActions.widgetToolbarStateChange(c,["text-arcade"]))},[c]);return(0,t.jsx)(o.RichTextEditor,Object.assign({autoFocus:!0,enabled:d,editorRef:_,onChange:w,defaultValue:x,modules:S,onSelectionChange:v},h))};var Y=l(1888),V=l(4108);const W=[r.ArcadeContentCapability.Value,r.ArcadeContentCapability.Style],K=(0,r.Immutable)([r.DynamicStyleType.Text]),$=e=>{const{editor:i,formats:a,selection:s,useDataSources:l,widgetId:d,enabled:c,onInitResizeHandler:u}=e,p=r.ReactRedux.useSelector(e=>{var t;return!!(null===(t=e.widgetsState[d])||void 0===t?void 0:t.showExpression)}),h=r.ReactRedux.useSelector(e=>{var t;return!!(null===(t=e.widgetsState[d])||void 0===t?void 0:t.showArcade)}),g=r.ReactRedux.useSelector(e=>e.browserSizeMode),S=r.ReactRedux.useSelector(e=>{var t;return null===(t=e.appConfig.widgets[d])||void 0===t?void 0:t.uri}),f=r.hooks.useTranslation(n.defaultMessages),[_,E]=r.React.useState(0),[b,m]=r.React.useState(0),y=r.React.useRef(null);r.React.useEffect(()=>{null==u||u(()=>{var e;E(e=>e+1),null===(e=y.current)||void 0===e||e.classList.add("d-none")},null,()=>{var e;m(e=>e+1),null===(e=y.current)||void 0===e||e.classList.remove("d-none")})},[u]);const A=r.React.useMemo(()=>({title:f("dynamicContent"),onClose:()=>{(0,r.getAppStore)().dispatch(r.appActions.widgetStatePropChange(d,"showExpression",!1)),(0,r.getAppStore)().dispatch(r.appActions.widgetToolbarStateChange(d,["text-expression"]))}}),[d,f]);return g===r.BrowserSizeMode.Small&&p&&V.appBuilderSync.publishSidePanelToApp({type:"textExpression",widgetId:d,uri:S,editor:i,formats:a,selection:s,useDataSources:l,active:p}),h&&V.appBuilderSync.publishShowTextArcadePanelBuilder({widgetId:d,editor:i,formats:a,selection:s,useDataSources:l,useTitle:!0,useIcons:!1,dynamicStyleTypes:K,capabilities:W,onModalClose:()=>{V.appBuilderSync.publishShowTextArcadePanelBuilder(null),(0,r.getAppStore)().dispatch(r.appActions.widgetStatePropChange(d,"showArcade",!1)),(0,r.getAppStore)().dispatch(r.appActions.widgetToolbarStateChange(d,["text-arcade"]))}}),r.hooks.useUpdateEffect(()=>{E(e=>e+1)},[c]),(0,t.jsxs)(Y.ThemeSwitchComponent,{useTheme2:!0,children:[(0,t.jsx)(o.Bubble,{editor:i,formats:a,selection:s,source:"user",version:_}),g!==r.BrowserSizeMode.Small&&p&&(0,t.jsx)(o.RichExpressionBuilderPopper,{ref:y,version:b,source:"user",editor:i,formats:a,selection:s,open:p,useDataSources:l,header:A,widgetId:d})]})};var J=function(e,t){var r={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(r[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(o=Object.getOwnPropertySymbols(e);n<o.length;n++)t.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(r[o[n]]=e[o[n]])}return r};const{useMemo:q,useCallback:Q}=r.React,Z={opacity:.5,background:"var(--sys-color-error-main)",outline:"1px solid white"},ee={Editor:e=>{const{value:o,widgetId:n,useDataSources:i,onComplete:a,onCreate:s,onDestroy:l,onInitResizeHandler:d,enabled:c}=e,u=J(e,["value","widgetId","useDataSources","onComplete","onCreate","onDestroy","onInitResizeHandler","enabled"]),[p,h]=r.React.useState(o),g=((e,t)=>Q(r=>null!=r?null==e?void 0:e(r):null==t?void 0:t(),[e,t]))(s,l),S=((e,o,n,i)=>r.React.useMemo(()=>({editor:r,selection:a,formats:s})=>(0,t.jsx)($,{editor:r,selection:a,formats:s,widgetId:e,useDataSources:o,enabled:n,onInitResizeHandler:i}),[n,i,o,e]))(n,i,c,d),f=((e,t)=>q(()=>{const r=w(e,t),o={".ql-editor":{lineHeight:1.42}};return null==r||r.forEach(e=>{o[`exp[data-dsid*="${e}"]`]=Z,o[`arcade[data-dsid*="${e}"]`]=Z}),o},[e,t]))(p,i);return(0,t.jsx)(H,Object.assign({editorRef:g,css:f,value:o,plugin:S,onChange:h,onComplete:(e,t)=>{const o=r.appConfigUtils.restoreResourceUrl(e);null==a||a(o,t)},enabled:c,widgetId:n},u))},builderUtils:e}})(),d})())}}});
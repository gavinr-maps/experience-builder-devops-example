/*! For license information please see arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-63fc72.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-63fc72"],{19780:(e,t,s)=>{s.r(t),s.d(t,{arcgis_field_delete:()=>d});var l=s(7263),i=s(1991),a=s(62159),n=s(28926),o=s(94788),r=s(96536);s(77040),s(78613),s(58233),s(70506),s(99004),s(31670),s(11935),s(2174);const d=class{constructor(e){(0,l.r)(this,e),this.arcgisFieldDeleteFieldDeleted=(0,l.c)(this,"arcgisFieldDeleteFieldDeleted",7),this.arcgisFieldDeleteModalClose=(0,l.c)(this,"arcgisFieldDeleteModalClose",7),this.layerFieldsMap=new Map,this.arcadeExpMap=new Map,this.fieldIsDeletable=!1,this.layer=void 0,this.mapView=void 0,this.config=void 0,this.fieldName=void 0,this.deleteInProgress=!1,this.currentLayerInfo=void 0}async componentWillLoad(){const{layer:e,mapView:t,fieldName:s}=this,[l]=await(0,a.g)(this.hostElement);this.strings=l,s&&(this.layerField=e.fields.find((e=>e.name===s)),this.fieldIsDeletable=await(0,r.a)(t,e,this.layerField),this.fieldIsDeletable&&(await this.loadAllModules(),this.layerFieldsMap=await(0,i.e)(e),this.arcadeExpMap=(0,i.f)(e.popupTemplate)))}render(){const{strings:e,fieldIsDeletable:t}=this;return t?(0,l.h)(l.H,null,(0,l.h)("calcite-modal",{widthScale:"s",ref:e=>this.modalNode=e,open:!0,outsideCloseDisabled:!0,escapeDisabled:!0,onCalciteModalClose:()=>this.arcgisFieldDeleteModalClose.emit()},(0,l.h)("div",{slot:"header"},e.deleteField),(0,l.h)("div",{slot:"content",ref:e=>this.modalContentNode=e},(0,l.h)(l.F,null,this.renderDeleteLoader(),this.renderWarning(),(0,l.h)("calcite-label",null,e.deletePrompt),this.renderFieldPreview())),this.renderCancelButton(),this.renderDeleteButton())):(console.error("Field cannot be deleted"),null)}renderDeleteLoader(){const{strings:e,deleteInProgress:t}=this;return(0,l.h)("div",{class:"loader-container "+(t?"active":"")},(0,l.h)("calcite-loader",{class:"loader",label:e.deletingField,hidden:!t}),(0,l.h)("div",{class:"loader-text"},e.deletingField))}renderWarning(){const{config:e,strings:t}=this,{helpBase:s,helpMap:i}=e;return(0,l.h)("calcite-notice",{class:"warning",open:!0,icon:"exclamation-mark-triangle",scale:"s",kind:"warning"},(0,l.h)("div",{slot:"message",class:"warning-message"},t.deleteWarning),(0,l.h)("calcite-link",{slot:"link",target:"_blank",href:`${s}${i[120004852]}`},t.learnMore))}renderFieldPreview(){const{fieldName:e,layerField:t,layerFieldsMap:s,arcadeExpMap:a}=this;return(0,l.h)("calcite-list",null,(0,l.h)("calcite-list-item",{label:this.getFieldLabel(),description:`{${e}}`,value:e,disabled:!t.editable},(0,l.h)("div",{slot:"actions-end",class:"field-icons"},(0,l.h)(r.F,{fieldType:(0,i.b)(e,s,a)}))))}renderCancelButton(){const{strings:e}=this;return(0,l.h)("calcite-button",{onClick:()=>this.modalNode.open=!1,slot:"secondary",width:"full",appearance:"outline",ref:e=>this.cancelNode=e},e.cancel)}renderDeleteButton(){const{strings:e}=this;return(0,l.h)("calcite-button",{kind:"danger",slot:"primary",width:"full",onClick:async e=>{e.target.disabled=!0,this.cancelNode.disabled=!0,this.modalNode.closeButtonDisabled=!0,this.deleteInProgress=!0,await this.deleteField()}},e.deleteField)}async loadAllModules(){const[e,t,s,l,i]=await(0,n.l)(["esri/request","esri/layers/support/FeatureTemplate","esri/Graphic","esri/layers/support/arcadeUtils","esri/layers/support/fieldUtils"]);this.modules={request:e,FeatureTemplate:t,Graphic:s,arcadeUtils:l,fieldUtils:i}}getFieldLabel(){var e,t;const{layer:s,fieldName:l,arcadeExpMap:a}=this,n=null===(t=(null!==(e=s.popupTemplate)&&void 0!==e?e:s.createPopupTemplate()).fieldInfos)||void 0===t?void 0:t.find((e=>e.fieldName===l));return(0,i.c)(n,a)}async deleteField(){const{layer:e,modules:t,fieldName:s}=this,{request:l}=t,i=e.portalItem,a=`${e.url.replace("/rest/services","/rest/admin/services")}/${e.layerId}/deleteFromDefinition`,n={fields:[{name:s}]},o={deleteFromDefinition:JSON.stringify(n)};await l(a,{query:Object.assign(Object.assign({},o),{f:"json",token:i.portal.credential.token,async:!1}),method:"post",responseType:"json"}).then((async t=>{var i,a;if(null===(i=t.data)||void 0===i?void 0:i.success){const t=`${e.url.replace("/rest/services","/rest/admin/services")}/${e.layerId}`;"feature"===e.type&&(null===(a=e.floorInfo)||void 0===a?void 0:a.floorField)===s&&(e.floorInfo=null),await l(t,{query:{f:"json"},responseType:"json"}).then((async e=>{var t;const i=e.data;this.currentLayerInfo=e.data,i&&(this.updateTypesAndTemplatesOnLayer(),(null===(t=i.templates)||void 0===t?void 0:t.length)?i.templates.forEach((e=>{delete e.prototype.attributes[s]})):i.types.forEach((e=>{e.templates.forEach((e=>{delete e.prototype.attributes[s]}))})),this.updateFeatureService(i,l))}))}}),(()=>this.handleError()))}updateTypesAndTemplatesOnLayer(){var e;const{currentLayerInfo:t}=this,s=t;if(null===(e=s.templates)||void 0===e?void 0:e.length){const e=this.updateTemplatesList(s.templates);s.templates=e}else if(s.types){const e=s.types;s.types=[],e.forEach((e=>{e.templates=this.updateTemplatesList(e.templates),this.addType(s,e)}))}}updateTemplatesList(e){const{currentLayerInfo:t,modules:s,strings:l}=this,i=[];return(null!=e?e:[]).forEach((e=>{var a;const n=new s.FeatureTemplate;n.description=null!==(a=e.description)&&void 0!==a?a:"",n.name=e.name||l.newFeature,n.drawingTool=e.drawingTool||"point";const o={};t.fields.forEach((t=>{let s=!1;for(const l in e.prototype.attributes)if(l===t.name){s=!0,o[t.name]=e.prototype.attributes[t.name];break}!s&&t.editable&&(o[t.name]=t.defaultValue||null)}));const r=new s.Graphic({attributes:o});n.prototype=r,i.push(n)})),i}addType(e,t){if(e.types){e.types.some((e=>e.id===t.id))||e.types.push(t)}else e.types=[t]}async updateFeatureService(e,t){const{layer:s,fieldName:l}=this,i=s.portalItem,a={templates:e.templates,types:e.types},n=`${s.url.replace("/rest/services","/rest/admin/services")}/${s.layerId}/updateDefinition`,r={f:"json",updateDefinition:JSON.stringify(a)};await t(n,{query:Object.assign(Object.assign({},r),{f:"json",token:i.portal.credential.token}),method:"post",responseType:"json"}).then((async e=>{var a,n,r,d;if(null===(a=e.data)||void 0===a?void 0:a.success){const e=`${(0,o.g)(s.portalItem.portal)}content/items/${s.portalItem.id}/data`;(null===(n=s.popupTemplate)||void 0===n?void 0:n.fieldInfos)&&(s.popupTemplate.fieldInfos=s.popupTemplate.fieldInfos.filter((e=>e.fieldName!==l))),null===(d=null===(r=s.popupTemplate)||void 0===r?void 0:r.content)||void 0===d||d.forEach(((e,t)=>{var i,a,n;"fields"===e.type&&e.fieldInfos&&((null===(i=s.popupTemplate)||void 0===i?void 0:i.content)[t].fieldInfos=null===(n=(null===(a=s.popupTemplate)||void 0===a?void 0:a.content)[t].fieldInfos)||void 0===n?void 0:n.filter((e=>e.fieldName!==l)))})),await t(e,{query:{f:"json"},method:"get",responseType:"json",token:i.portal.credential.token}).then((async e=>{var a;const n=e.data;if((null==n?void 0:n.layers)||(null==n?void 0:n.tables)){const e=s.isTable,r=e?n.tables:n.layers,d=r.find((e=>e.id===s.layerId));if(null==d?void 0:d.popupInfo){d.popupInfo.fieldInfos=d.popupInfo.fieldInfos.filter((e=>e.fieldName!==l)),null===(a=d.popupInfo.popupElements)||void 0===a||a.forEach(((e,t)=>{"fields"===e.type&&e.fieldInfos&&(d.popupInfo.popupElements[t].fieldInfos=d.popupInfo.popupElements[t].fieldInfos.filter((e=>e.fieldName!==l)))}));const n=`${(0,o.g)(s.portalItem.portal)}content/users/${s.portalItem.owner}/items/${s.portalItem.id}/update`,c={};e?c.tables=r:c.layers=r;const p={f:"json",text:JSON.stringify(c)};await t(n,{query:Object.assign(Object.assign({f:"json"},p),{token:i.portal.credential.token}),method:"post",responseType:"json"}).then((e=>{var t;(null===(t=e.data)||void 0===t?void 0:t.success)?this.handleSuccess():this.handleError()}),(()=>this.handleError()))}else this.handleSuccess()}else 200!==e.httpStatus||e.data&&"{}"!==JSON.stringify(e.data)?this.handleError():this.handleSuccess()}),(()=>this.handleError()))}}),(()=>this.handleError()))}handleSuccess(){this.arcgisFieldDeleteFieldDeleted.emit(),this.modalNode.open=!1,this.displaySuccessAlert()}handleError(){this.modalNode.open=!1,this.displayErrorAlert()}displaySuccessAlert(){var e;const{strings:t}=this;this.successAlertNode&&(null===(e=this.successAlertNode.parentElement)||void 0===e||e.removeChild(this.successAlertNode),this.successAlertNode=null);const s=this.successAlertNode=document.createElement("calcite-alert");s.kind="success",s.icon="check-circle";const l=document.createElement("div");l.slot="message",l.innerHTML=t.fieldDeleted,s.append(l),s.open=!0,s.autoClose=!0,document.body.append(s),setTimeout((()=>s.setFocus()),1e3)}displayErrorAlert(){var e;const{strings:t}=this;this.errorAlertNode&&(null===(e=this.errorAlertNode.parentElement)||void 0===e||e.removeChild(this.errorAlertNode),this.errorAlertNode=null);const s=this.errorAlertNode=document.createElement("calcite-alert");s.kind="danger",s.icon="exclamation-mark-triangle";const l=document.createElement("div");l.slot="message",l.innerHTML=t.fieldDeletionUnsuccessful,s.append(l),s.open=!0,s.autoClose=!0,document.body.append(s),setTimeout((()=>s.setFocus()),1e3)}get hostElement(){return(0,l.d)(this)}};d.style=".field-icons{padding:0 var(--arcgis-app-cap-spacing);display:flex;align-items:center}.warning{border-bottom:1px solid var(--calcite-color-border-3);margin-bottom:12px}.warning-message{font-size:var(--calcite-font-size--1);font-weight:var(--calcite-font-weight-bold)}.loader-container{position:absolute;top:0px;right:0px;z-index:40;display:none;height:100%;width:100%;overflow:hidden;background:rgba(255, 255, 255, 0.95);padding:0px}.active{display:flex;flex-direction:column;place-content:center;align-items:center;justify-items:center}.loader{padding:0px}.loader-text{text-align:center;font-size:1rem;font-weight:500;margin-right:6.25rem;margin-left:6.25rem}"}}]);
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_common_feature-report_node_modules_arcgis-survey123_feature-report-ee47fb"],{26954:(e,t,s)=>{s.d(t,{E:()=>r,R:()=>l,q:()=>n});var r,o=s(12542),a=s(45511),i=s(28593);function n(e){const t=function(e,t,s){const r=Object.assign(Object.assign({params:{}},s),e);return r.params=t.reduce(((t,s)=>((e[s]||"boolean"==typeof e[s]||"number"==typeof e[s]&&0===e[s])&&(t[s]=e[s]),t)),r.params),["params","httpMethod","rawResponse","authentication","portal","fetch","maxUrlLength","headers"].reduce(((e,t)=>(r[t]&&(e[t]=r[t]),e)),{})}(e,["where","objectIds","relationParam","time","distance","units","outFields","geometry","geometryType","spatialRel","returnGeometry","maxAllowableOffset","geometryPrecision","inSR","outSR","gdbVersion","returnDistinctValues","returnIdsOnly","returnCountOnly","returnExtentOnly","orderByFields","groupByFieldsForStatistics","outStatistics","returnZ","returnM","multipatchOption","resultOffset","resultRecordCount","quantizationParameters","returnCentroid","resultType","historicMoment","returnTrueCurves","sqlFormat","returnExceededLimitFeatures","f"],{httpMethod:"GET",params:Object.assign({where:"1=1",outFields:"*"},e.params)});return(0,i.r)(`${(0,i.c)(e.url)}/query`,t)}!function(e){e.submitted="esriJobSubmitted",e.executing="esriJobExecuting",e.succeeded="esriJobSucceeded",e.partialSucceeded="esriJobPartialSucceeded",e.failed="esriJobFailed",e.cancelled="esriJobStatusCancelled"}(r||(r={}));class l{constructor(){this.checkingList=[],this.isRequestingTasks=!1,this.jobList={},this.sessionJobs=[],this.templateItemsCache=[],this.stateService=a.S.getService(),this.paramCache={}}static getService(){return this.service||(this.service=new l),this.service}resetService(){this.resetParamCache(),this.clearHelperObj(),this.checkingList=[],this.isRequestingTasks=!1,this.jobList={},this.queryJobTimmer=null,this.sessionJobs=[],this.templateItemsCache=[]}getParamCache(e){return e?this.paramCache?this.paramCache[e]:null:this.paramCache}setParamCache(e){e&&(this.paramCache=Object.assign(this.paramCache||{},e))}resetParamCache(){this.paramCache={}}getHelperObj(e){return e?this.helperObj?this.helperObj[e]:null:this.helperObj}setHelperObj(e){e&&(this.helperObj=Object.assign(this.helperObj||{},e))}clearHelperObj(){this.helperObj=null}getReportTemplates(e,t){let s=!1;"templateIds"in(t=t||{})&&void 0!==t.templateIds&&(s=!0);const r=(null==t?void 0:t.templateIds)||"",o=this.templateItemsCache||[],a=i.U.getService();return Promise.resolve(!0).then((()=>{if(!a.supportFeatureReport())throw new Error("This portal does not support custom report.");return!0})).then((()=>{if(s){const e=[];return r.split(",").forEach((t=>{const s=o.find((e=>e.id===t));let r=null;r=s?Promise.resolve(s):(0,i.g)(t,a.getBaseRequestOptions()).then((e=>e)).catch((()=>(console.log("Cannot get item info for the report template with id"+t),{}))),e.push(r)})),Promise.all(e).then((e=>({relatedItems:e})))}if(e&&!this.getHelperObj("surveyIsInvalid")){const t=Object.assign({id:e,relationshipType:"Survey2Data"},a.getBaseRequestOptions());return(0,i.b)(t)}return{relatedItems:[]}})).then((e=>{if(!e||e.error)throw new Error("Failed to get related templates");this.templateItemsCache=e.relatedItems||[];const t="Print Template",s="Microsoft Word";return e.relatedItems.filter((e=>e.type===s&&-1!==e.typeKeywords.indexOf(t)))||[]})).then((e=>{const t=[];return e.forEach((e=>{const s=this.getCustomPrintingFileUrl(e.id),r={id:e.id,name:e.name,title:e.title,summary:e.snippet,modified:new Date(e.modified),url:s,typeKeywords:e.typeKeywords,type:e.type};t.push(r)})),s&&t.sort(((e,t)=>e.modified<t.modified?1:-1)),t}))}getLayerJson(e){e=e||o.P.featureLayerUrl;const t=this.getHelperObj("layerJsons")||[],s=t.find((t=>t.url=e&&t.json));return s?Promise.resolve(s.json):(r={url:o.P.featureLayerUrl,authentication:o.P.token},(0,i.r)((0,i.c)(r.url),r)).then((s=>(t.push({url:e,json:s}),this.setHelperObj({layerJsons:t}),s)));var r}getFeatureCount(){const e=JSON.parse(o.P.queryParameters);delete e.orderByFields;const t=Object.assign({url:o.P.featureLayerUrl,authentication:o.P.token,returnCountOnly:!0},e),s="where"in t?t.where:null,r="objectIds"in t?t.objectIds:null,a={};return null!==s&&(a.where=s),null!=r&&(a.objectIds=r),r||s||(a.where="1<>1",delete a.objectIds),t.params=a,delete t.where,delete t.objectIds,n(t).then((t=>{let s=t.count;e.resultRecordCount<s&&(s=e.resultRecordCount),this.setHelperObj({featureCount:s}),this.stateService.notifyDataChanged("feature-count-updated")})).catch((e=>{this.manageError(e,"featureLayerUrl")}))}getCustomPrintingFileUrl(e){return`${o.P.portalUrl}/sharing/rest/content/items/${e}/data?token=${o.P.token}`}estimateReportCosts(e){const t={portalUrl:o.P.portalUrl,token:o.P.token,f:"json"},s=Object.assign(t,e||{}),r=new URLSearchParams;Object.keys(s).forEach((e=>{const t=s[e];r.append(e,t)}));const a=`${o.P.apiUrl}/estimateCredits`;return fetch(a,{method:"POST",headers:this._generateRequestHeaders(),body:r}).then((e=>e.json()))}executeReport(e){const t=o.P.locale||"en",s={portalUrl:o.P.portalUrl,utcOffset:"||"+this._getLocalTimezoneOffset(),locale:"||"+t,token:o.P.token,f:"json"},r=Object.assign(s,e||{});r.uploadInfo&&"null"!==r.uploadInfo||!Object.prototype.hasOwnProperty.call(r,"uploadInfo")||delete r.uploadInfo;const a=new URLSearchParams;Object.keys(r).forEach((e=>{const t=r[e];a.append(e,t)}));const i=`${o.P.apiUrl}/createReport/submitJob`;return fetch(i,{method:"POST",headers:this._generateRequestHeaders(),body:a}).then((e=>e.json()))}createSampleReport(e){const t=o.P.locale||"en",s={portalUrl:o.P.portalUrl,utcOffset:"||"+this._getLocalTimezoneOffset(),locale:"||"+t,token:o.P.token,f:"json"},r=Object.assign(s,e||{}),a=new URLSearchParams;Object.keys(r).forEach((e=>{const t=r[e];a.append(e,t)}));const i=`${o.P.apiUrl}/createSampleReport/submitJob`;return fetch(i,{method:"POST",headers:this._generateRequestHeaders(),body:a}).then((e=>e.json()))}removeJob(e){const t={portalUrl:o.P.portalUrl,token:o.P.token,f:"json"},s=new URLSearchParams;Object.keys(t).forEach((e=>{const r=t[e];s.append(e,r)}));const r=`${o.P.apiUrl}/jobs/${e}/remove`;return fetch(r,{method:"POST",headers:this._generateRequestHeaders(),body:s}).then((e=>e.json()))}cancelJob(e){const t={portalUrl:o.P.portalUrl,token:o.P.token,f:"json"},s=new URLSearchParams;Object.keys(t).forEach((e=>{const r=t[e];s.append(e,r)}));const r=`${o.P.apiUrl}/jobs/${e}/cancel`;return fetch(r,{method:"POST",headers:this._generateRequestHeaders(),body:s}).then((e=>e.json()))}removeJobFromList(e){if(e&&this.jobList&&this.jobList.jobs){const t=this.jobList.jobs.findIndex((t=>t.jobId===e.jobId));this.jobList.jobs.splice(t,1),this.jobList.jobs=[].concat(this.jobList.jobs)}}queryJobs(e){return this.checkingList.length<1&&!e||this.isRequestingTasks?Promise.resolve(null):(this.isRequestingTasks=!0,this.sendQueryJobsRequest(o.P.surveyItemId).then((e=>{if(e.error)throw e.error;return e})).then((e=>{if(this.isRequestingTasks=!1,this.jobList.jobs||(this.jobList.jobs=[]),e&&e.jobs&&e.jobs.length)e.jobs.forEach(((t,s)=>{const r=t.jobId,o=this.jobList.jobs.filter((e=>e.jobId===r));o&&o.length&&(e.jobs[s]=o[0]),o&&o._tempRuntime&&(e.jobs[s]._tempRuntime=Object.assign(o._tempRuntime,e.jobs[s]._tempRuntime||{}))})),this.jobList.jobs=e.jobs;else if(e&&e.error){const t="Oops! An error occurred loading the job list";return console.log(e.error&&e.error.message?e.error.message:t),!1}return this.queryJobTimmer&&clearTimeout(this.queryJobTimmer),this.queryJobTimmer=setTimeout((()=>{this.queryJobs()}),1e4),this.jobList})).catch((()=>{throw this.isRequestingTasks=!1,console.log("query jobs failed."),this.queryJobTimmer&&clearTimeout(this.queryJobTimmer),this.queryJobTimmer=setTimeout((()=>{this.queryJobs()}),1e4),new Error})))}checkJobListDetails(){const e=this.jobList.jobs;e&&e.length&&e.forEach(((e,t)=>{if("esriJobSucceeded"!==e.jobStatus&&"esriJobPartialSucceeded"!==e.jobStatus||e.resultInfo&&e.resultInfo.resultFiles)if(e.jobStatus===r.executing||e.jobStatus===r.submitted){this.sessionJobs.indexOf(e.jobId)>=0||this.checkJobStatus(e.jobId)}else this.jobList.jobs[t]=Object.assign({},this.updateJobDetail(this.jobList.jobs[t])),this.stateService.notifyDataChanged("job-updated",{value:this.jobList.jobs[t]}),e.jobStatus===r.failed&&this.stateService.notifyDataChanged("job-complete",{value:e});else this.checkJobStatus(e.jobId).then((e=>{this.jobList.jobs[t]=Object.assign({},this.updateJobDetail(e)),this.stateService.notifyDataChanged("job-updated",{value:this.jobList.jobs[t]}),this.stateService.notifyDataChanged("job-complete",{value:this.jobList.jobs[t]})}))}))}checkJobDetails(e){if(!e||e.hasDetail)return Promise.resolve(e);if([r.succeeded,r.partialSucceeded,r.failed,r.cancelled].indexOf(e.jobStatus)>=0&&this.stateService.notifyDataChanged("job-complete",{value:e}),!(e.jobStatus!==r.succeeded&&e.jobStatus!==r.partialSucceeded||e.resultInfo&&e.resultInfo.resultFiles))return this.checkJobStatus(e.jobId).then((t=>(e=this.updateJobDetail(t),this.stateService.notifyDataChanged("job-updated",{value:e}),this.stateService.notifyDataChanged("job-complete",{value:e}),e)));if(!(e.jobStatus!==r.failed||e.resultInfo&&e.resultInfo.details))return this.checkJobStatus(e.jobId).then((t=>(e=this.updateJobDetail(t),this.stateService.notifyDataChanged("job-updated",{value:e}),e)));if(e.jobStatus===r.executing||e.jobStatus===r.submitted){this.stateService.notifyDataChanged("job-updated",{value:e});return this.sessionJobs.indexOf(e.jobId)>=0||this.checkJobStatus(e.jobId).then((e=>this.checkJobDetails(e))),Promise.resolve(e)}return e=Object.assign({},this.updateJobDetail(e)),this.stateService.notifyDataChanged("job-updated",{value:e}),Promise.resolve(e)}sendQueryJobsRequest(e){const t={portalUrl:o.P.portalUrl,f:"json",token:o.P.token};e&&(t.surveyItemId=e);const s=new URLSearchParams;Object.keys(t).forEach((e=>{const r=t[e];s.append(e,r)}));const r=o.P.apiUrl+"/queryJobs";return fetch(r,{method:"POST",headers:this._generateRequestHeaders(),body:s}).then((e=>e.json()))}checkJobStatus(e){const t={f:"json",portalUrl:o.P.portalUrl,token:o.P.token},s=new URLSearchParams;Object.keys(t).forEach((e=>{const r=t[e];s.append(e,r)}));const r=`${o.P.apiUrl}/jobs/${e}/status`;return fetch(r,{method:"POST",headers:this._generateRequestHeaders(),body:s}).then((e=>e.json()))}downloadReport(e){let t="docx";e.inputInfo&&e.inputInfo.parameters&&(t=e.inputInfo.parameters.outputFormat||"docx"),this.downloadFile(e,"pdf"===t)}downloadFile(e,t){if(!e||!e.resultInfo||!e.resultInfo.resultFiles)return;e.resultInfo.resultFiles.forEach(((e,s)=>{let r=e.url;if(!r){const t=e.id||"";r=`${o.P.portalUrl}/sharing/rest/content/items/${t}/data?`,r=r+"token="+o.P.token}s>0?setTimeout((()=>{this.startDownload(r,t)}),3e3):this.startDownload(r,t)}))}startDownload(e,t){const s=document.createElement("a");s.style.display="block",document.body.appendChild(s),s.setAttribute("href",e),t&&s.setAttribute("target","_blank"),s.click(),s.remove()}getErrorStr(e){let t="";return e&&("string"==typeof e?t=e:e.error&&"string"==typeof e.error||e.error&&e.error.message?t=e.error:!t&&e.status&&e.statusText?t=e.status+" "+e.statusText:t||!e.status||e.statusText||(t="Error code: "+e.status)),t}showError(e,t){let s="",r=(t=t||{}).detail||"";t.errorStr?s=t.errorStr:e.error&&e.error.message&&(s=e.error.message),!t.detail&&t.showDetails&&(e.error.response&&e.error.response.error&&e.error.response.error.detail&&(r=e.error.response.error.detail),!r&&t.errorStr&&e.error&&e.error.message&&(r=e.error.message)),!s&&e.message&&(s=e.message),this.stateService.notifyDataChanged("show-error",{value:{alertType:t.alertType||"danger",html:s,detail:r}})}manageError(e,t){var s,r,a,i,n;if(400===(null===(r=null===(s=e.response)||void 0===s?void 0:s.error)||void 0===r?void 0:r.code)||"CONT_0001"===e.code||403===(null===(i=null===(a=e.response)||void 0===a?void 0:a.error)||void 0===i?void 0:i.code)||"GWM_0003"===e.code){const e=null===(n=(o.T.getService().getTranslateSync()||{}).customPrint)||void 0===n?void 0:n.noItemErr;if(e&&t)throw Error(e.replace("${$notFoundItemID}",t+"="+o.P[t]))}throw e}updateJobDetail(e){const t=i.U.getService(),s=e;if(s&&this.jobList.jobs&&this.jobList.jobs.length){const e=this.jobList.jobs.find((e=>e.jobId===s.jobId));e&&e._tempRuntime&&(s._tempRuntime=Object.assign(e._tempRuntime,s._tempRuntime||{}))}if(!e||!e.resultInfo)return s;if(e.resultInfo.resultFiles&&e.resultInfo.resultFiles.length){let r="";const a=e.resultInfo.resultFiles;let i=!0;e.inputInfo&&e.inputInfo.parameters&&e.inputInfo.parameters.uploadInfo&&"arcgis"===e.inputInfo.parameters.uploadInfo.type&&(i=!1),s.multipleFiles=a.length>1,i?isNaN(Number(s.completed))||(s.multipleFiles||(r=a[0].url),"expired"===a[0].status&&(s.urlExpired=!0)):(a.forEach(((e,s)=>{const r=e.id||"";let i=`${o.P.portalUrl}/sharing/rest/content/items/${r}/data?`;i=i+"token="+o.P.token,a[s].url=i,a[s].size=t.getFileSize(e.size)})),s.multipleFiles||(r=a[0].url)),s.multipleFiles||(s.url=r)}if(s.resultInfo.details){const e=s.resultInfo.details||[],t=(e,t)=>{const s=e.status,r=e.messages,o=e.success,a=e.objectId;for(const e in t){const i=t[e];if(s===i.status&&o===i.success&&JSON.stringify(r||[])===JSON.stringify(i.messages||[])&&i.objectIds.indexOf(a)<0)return i}return null};if(e&&e.length){const r=[];e.forEach((e=>{const s=t(e,r);if(s)s.objectIds.push(e.objectId);else{const t=(e.objectId+"").split(",").join(", ");r.push({status:e.status,messages:e.messages,success:e.success,objectIds:[t]})}})),r.forEach((e=>{e.objectIds=e.objectIds.join(", ")})),s.failedInfo=r}}return s.hasDetail=!0,s}_getLocalTimezoneOffset(){if(o.P.utcOffset)return o.P.utcOffset;const e=(new Date).getTimezoneOffset();let t=Math.abs(e/60),s=Math.abs(e%60);t<10&&(t="0"+t),s<10&&(s="0"+s);return(e<=0?"+":"-")+t+":"+s}_generateRequestHeaders(){const e={contentType:"application/x-www-form-urlencoded"};return void 0===o.P.requestSource?e["X-Survey123-Request-Source"]="MapsSDKJS/WebComponent":o.P.requestSource&&"none"!==(o.P.requestSource+"").toLowerCase()&&(e["X-Survey123-Request-Source"]=o.P.requestSource),e}}}}]);
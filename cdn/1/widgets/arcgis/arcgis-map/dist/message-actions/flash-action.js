System.register(["jimu-core"],(function(e,t){var a={};return{setters:[function(e){a.AbstractMessageAction=e.AbstractMessageAction,a.AppMode=e.AppMode,a.DataSourceManager=e.DataSourceManager,a.Immutable=e.Immutable,a.MessageActionConnectionType=e.MessageActionConnectionType,a.MessageType=e.MessageType,a.MutableStoreManager=e.MutableStoreManager,a.dataSourceUtils=e.dataSourceUtils,a.getAppStore=e.getAppStore,a.messageActionUtils=e.messageActionUtils}],execute:function(){e((()=>{"use strict";var e={79244:e=>{e.exports=a}},t={};function s(a){var r=t[a];if(void 0!==r)return r.exports;var n=t[a]={exports:{}};return e[a](n,n.exports,s),n.exports}s.d=(e,t)=>{for(var a in t)s.o(t,a)&&!s.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};return(()=>{s.r(r),s.d(r,{default:()=>a});var e=s(79244),t=function(e,t,a,s){return new(a||(a=Promise))((function(r,n){function o(e){try{l(s.next(e))}catch(e){n(e)}}function i(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(o,i)}l((s=s.apply(e,t||[])).next())}))};class a extends e.AbstractMessageAction{filterMessageDescription(t){return t.messageType===e.MessageType.DataRecordsSelectionChange}filterMessage(e){return!0}getSettingComponentUri(t,a){return(0,e.getAppStore)().getState().appRuntimeInfo.appMode===e.AppMode.Express?null:"message-actions/flash-action-setting"}onExecute(a,s){return t(this,void 0,void 0,(function*(){switch(a.type){case e.MessageType.DataRecordsSelectionChange:const t=a.records;if(0===t.length)break;let r=null;if(s)if(s.messageUseDataSource&&s.actionUseDataSource){if(t.length>0){const a=[],r=t[0].dataSource.getMainDataSource();if(r){a.push(r.id);const e=r.getAssociatedDataSource&&r.getAssociatedDataSource();e&&a.push(e.id)}if(!a.includes(s.messageUseDataSource.mainDataSourceId)){e.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"flashActionValue",null);break}}const n=e.DataSourceManager.getInstance().getDataSource(s.messageUseDataSource.mainDataSourceId),o=e.DataSourceManager.getInstance().getDataSource(s.actionUseDataSource.mainDataSourceId);if(n&&o)if(s.enabledDataRelationShip){let t=null,i=null;if(s.messageUseDataSource.mainDataSourceId===s.actionUseDataSource.mainDataSourceId&&s.messageUseDataSource.rootDataSourceId===s.actionUseDataSource.rootDataSourceId){const e=n.getSchema(),a=e&&e.fields&&Object.keys(e.fields).find((t=>"esriFieldTypeOID"===e.fields[t].esriType));t=e&&e.fields&&e.fields[a],i=t}else{let a,r;if(s.connectionType===e.MessageActionConnectionType.UseLayersRelationship){const t=e.dataSourceUtils.getJimuDataSourceRelationship(n,o);t&&(a=t.keyField,r=t.relatedKeyField)}else a=s.messageUseDataSource.fields[0],r=s.actionUseDataSource.fields[0];a&&(t=n.getSchema().fields[a]),r&&(i=o.getSchema().fields[r])}let l="";if(t&&i){const r=t.name,c=t.type,u=a;let d=[];if(s.connectionType===e.MessageActionConnectionType.UseLayersRelationship){const e=(yield null==n?void 0:n.queryRelatedFieldValues(u.records||[],o,i.name))||[];d=this.getUniqueFormatedMessageFieldValues(e,c),0===d.length&&(d=["-1"],i=o.getSchema().fields[o.getIdField()])}else{const e=u.records.map((e=>e.getData()[r]));d=this.getUniqueFormatedMessageFieldValues(e,c)}if(l="",d.length>0){const t=!0,a=e.messageActionUtils.getSqlExpressionWidthMessageFieldValues(d,i,o,t);if(a){const t=(0,e.Immutable)(a),s=e.dataSourceUtils.getArcGISSQL(t,o);(null==s?void 0:s.sql)&&(l=null==s?void 0:s.sql)}}l||(l="")}if(a.records.length>0){const t=s.sqlExprObj?e.dataSourceUtils.getArcGISSQL(s.sqlExprObj,o).sql:null;t&&(l=l?l+" AND "+t:t)}else l="";const c={outFields:[],where:l,returnGeometry:!0},u=o.getRealQueryParams(c,"query");r={layerDataSourceId:o&&o.id,querySQL:u&&u.where}}else{let t="";if(a.records.length>0){const a=s.sqlExprObj?e.dataSourceUtils.getArcGISSQL(s.sqlExprObj,o).sql:null;a&&(t=a)}else t="";const n={outFields:[],where:t,returnGeometry:!0},i=o.getRealQueryParams(n,"query");r={layerDataSourceId:o&&o.id,querySQL:i&&i.where}}else r=null}else r=null;const n=`flashActionValue-${null==r?void 0:r.layerDataSourceId}`;e.MutableStoreManager.getInstance().updateStateValue(this.widgetId,n,r)}return!0}))}getLayerIdFromLayerDs(e){return e.layerId?e.layerId:e.layer?e.layer.id:null}getUniqueFormatedMessageFieldValues(t,a){const s=[];for(let r=0;r<t.length;r++){const n=t[r],o=e.messageActionUtils.formatValue(n,a);s.includes(o)||s.push(o)}return s}}})(),r})())}}}));
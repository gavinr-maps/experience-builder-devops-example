System.register(["jimu-core","jimu-ui/advanced/setting-components","jimu-ui/advanced/data-source-selector","jimu-theme","jimu-arcgis"],(function(e,t){var a={},o={},r={},s={},i={};return{setters:[function(e){a.AllDataSourceTypes=e.AllDataSourceTypes,a.CONSTANTS=e.CONSTANTS,a.DataSourceManager=e.DataSourceManager,a.DataSourceTypes=e.DataSourceTypes,a.Immutable=e.Immutable,a.MessageCarryData=e.MessageCarryData,a.MessageType=e.MessageType,a.React=e.React,a.css=e.css,a.getAppStore=e.getAppStore,a.jsx=e.jsx,a.polished=e.polished},function(e){o.SettingSection=e.SettingSection},function(e){r.DEFAULT_DATA_VIEW_ID=e.DEFAULT_DATA_VIEW_ID,r.DataSourceSelector=e.DataSourceSelector},function(e){s.withTheme=e.withTheme},function(e){i.ArcGISDataSourceTypes=e.ArcGISDataSourceTypes}],execute:function(){e((()=>{"use strict";var e={62686:e=>{e.exports=i},79244:e=>{e.exports=a},1888:e=>{e.exports=s},13089:e=>{e.exports=r},79298:e=>{e.exports=o}},t={};function u(a){var o=t[a];if(void 0!==o)return o.exports;var r=t[a]={exports:{}};return e[a](r,r.exports,u),r.exports}u.d=(e,t)=>{for(var a in t)u.o(t,a)&&!u.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},u.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),u.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};return(()=>{u.r(n),u.d(n,{default:()=>h});var e=u(79244),t=u(79298),a=u(13089);const o="Trigger data";var r=u(1888),s=u(62686);function i(t,a){var o,r;const s=S(),i=null===(o=null==s?void 0:s.widgets)||void 0===o?void 0:o[t],u=null===(r=null==i?void 0:i.manifest)||void 0===r?void 0:r.publishMessages;let n=e.MessageCarryData.UseDataSource;return null==u||u.forEach((e=>{const t=e;(null==t?void 0:t.messageCarryData)&&(null==t?void 0:t.messageType)===a&&(n=null==t?void 0:t.messageCarryData)})),n}function c(t,a){if(a===e.MessageType.DataSourceFilterChange){const a=e.DataSourceManager.getInstance().getDataSource(t);if(a&&a.type===e.DataSourceTypes.ImageryLayer)return!1}return!0}function l(t,a,o){var r,i,u,n;const c=S(),l=p(t,o);let d=null,g=!1;const D=l&&l[0]&&l[0].dataSourceId;if(!D)return null;const h=c.dataSources[D];!h||h.type!==s.ArcGISDataSourceTypes.WebMap&&h.type!==s.ArcGISDataSourceTypes.WebScene||(g=!0);const m=null===(i=null===(r=e.DataSourceManager.getInstance().getDataSource(a.dataSourceId))||void 0===r?void 0:r.getDataSourceJson())||void 0===i?void 0:i.isOutputFromWidget;if(g){let e=!1;if(l)for(let t=0;t<l.length;t++)if(l[t].dataSourceId===a.rootDataSourceId){e=!0;break}d=e?a:null}else{let t=!1;if(l)for(let e=0;e<l.length;e++){const o=m?null==a?void 0:a.mainDataSourceId:null==a?void 0:a.dataSourceId;if((m?null===(u=l[e])||void 0===u?void 0:u.mainDataSourceId:null===(n=l[e])||void 0===n?void 0:n.dataSourceId)===o){t=!0;break}}d=t?a:l&&1===l.length?(0,e.Immutable)({dataSourceId:l[0].dataSourceId,mainDataSourceId:l[0].mainDataSourceId,rootDataSourceId:l[0].rootDataSourceId}):null}return d}function d(t,a,o,r){var u;const n=S(),l=null===(u=null==n?void 0:n.widgets)||void 0===u?void 0:u[t];let d=!1;const g=function(t){var a,o;const r=S(),i=null===(a=null==r?void 0:r.widgets)||void 0===a?void 0:a[t],u=[],n=e.DataSourceManager.getInstance();return null===(o=null==i?void 0:i.useDataSources)||void 0===o||o.forEach((e=>{const t=n.getDataSource(e.dataSourceId);(null==t?void 0:t.type)!==s.ArcGISDataSourceTypes.WebMap&&(null==t?void 0:t.type)!==s.ArcGISDataSourceTypes.WebScene||u.push(e.dataSourceId)})),u.length>0?(0,e.Immutable)(u):void 0}(t);let D;if(g&&0!==(null==g?void 0:g.length)||(d=function(t,a,o){const r=i(null==t?void 0:t.id,a),s=(null==t?void 0:t.outputDataSources)||[],u=(null==t?void 0:t.useDataSources)||[];if(o)return!1;switch(r){case e.MessageCarryData.OutputDataSource:return 1===(null==s?void 0:s.length);case e.MessageCarryData.UseDataSource:return 1===(null==u?void 0:u.length);case e.MessageCarryData.BothDataSource:return 1===s.length+u.length}}(l,r,g)),g)D=void 0;else{const a=function(t,a){var o;const r=p(t,a);return(0,e.Immutable)(null!==(o=r.map((t=>{const a=e.DataSourceManager.getInstance().getDataSource(t.dataSourceId);let o;return o=a&&a.isDataView?null==a?void 0:a.getMainDataSource():a,null==o?void 0:o.id})))&&void 0!==o?o:[])}(t,r);D=a.filter((e=>c(e,r)))}return{isReadOnly:d,useDataSource:a,useDataSources:o||(0,e.Immutable)([]),fromRootDsIds:g,fromDsIds:D}}function p(t,a){var o;const r=i(t,a),s=S(),u=null===(o=null==s?void 0:s.widgets)||void 0===o?void 0:o[t],n=(null==u?void 0:u.useDataSources)||(0,e.Immutable)([]),c=function(t){var a;const o=null!==(a=null==t?void 0:t.map((e=>({dataSourceId:e,mainDataSourceId:e,rootDataSourceId:null}))))&&void 0!==a?a:[];return(0,e.Immutable)(o)}(null==u?void 0:u.outputDataSources)||(0,e.Immutable)([]),l=null==n?void 0:n.asMutable({deep:!0}).concat(null==c?void 0:c.asMutable({deep:!0}));switch(r){case e.MessageCarryData.OutputDataSource:return c;case e.MessageCarryData.UseDataSource:return n;case e.MessageCarryData.BothDataSource:return(0,e.Immutable)(l)}}function S(){var t,a,o;return window.jimuConfig.isBuilder?null===(a=null===(t=(0,e.getAppStore)().getState())||void 0===t?void 0:t.appStateInBuilder)||void 0===a?void 0:a.appConfig:null===(o=(0,e.getAppStore)().getState())||void 0===o?void 0:o.appConfig}const g=(0,e.Immutable)([e.AllDataSourceTypes.FeatureLayer,e.AllDataSourceTypes.SceneLayer,e.AllDataSourceTypes.BuildingComponentSubLayer,e.AllDataSourceTypes.ImageryLayer,e.AllDataSourceTypes.OrientedImageryLayer]);class D extends e.React.PureComponent{constructor(t){super(t),this.modalStyle={position:"absolute",top:"0",bottom:"0",width:"259px",height:"auto",borderRight:"",borderBottom:"",paddingBottom:"1px"},this.handleTriggerLayerChange=e=>{e&&e.length>0?this.handleTriggerLayerSelected(e):this.handleRemoveLayerForTriggerLayer()},this.handleTriggerLayerSelected=t=>{const a=p(this.props.messageWidgetId,this.props.messageType);let o;o=this.checkIsDisableDataView()?t:a.filter((a=>!!t.find((t=>{var o;return t.dataViewId&&t.dataViewId!==e.CONSTANTS.OUTPUT_DATA_VIEW_ID||(null===(o=this.props.config.useDataSources)||void 0===o?void 0:o.find((e=>t.mainDataSourceId===e.mainDataSourceId)))?t.dataSourceId===a.dataSourceId:t.mainDataSourceId===a.mainDataSourceId}))));let r=this.props.config.set("useDataSource",o[0]);r=r.set("useDataSources",o),this.props.onSettingChange({actionId:this.props.actionId,config:r})},this.handleRemoveLayerForTriggerLayer=()=>{let e=this.props.config.set("useDataSource",null);e=e.set("useDataSources",[]),this.props.onSettingChange({actionId:this.props.actionId,config:e})},this.checkIsSupportMultipleTriggerDataSources=t=>{var a,o,r,s;const i=null===(o=null===(a=(0,e.getAppStore)().getState())||void 0===a?void 0:a.appStateInBuilder)||void 0===o?void 0:o.appConfig,u=null===(r=null==i?void 0:i.widgets)||void 0===r?void 0:r[t],n=p(this.props.messageWidgetId,this.props.messageType);return"Map"===(null===(s=null==u?void 0:u.manifest)||void 0===s?void 0:s.label)||n.length>1&&(this.props.messageType===e.MessageType.DataSourceFilterChange||this.props.messageType===e.MessageType.DataRecordsSelectionChange)},this.checkIsDisableDataView=()=>this.props.messageType===e.MessageType.DataRecordsSelectionChange,this.onGoToInitialMapExtentWhenSelectionClearedCheckboxChanged=(e,t)=>{t=!!t;const a=this.props.config.set("goToInitialMapExtentWhenSelectionCleared",t);this.props.onSettingChange({actionId:this.props.actionId,config:a})},this.modalStyle.borderRight="1px solid black",this.modalStyle.borderBottom="1px solid black",this.state={isShowLayerList:!1}}componentDidMount(){const t=function(t,a,o){const r=S();let i=null;const u=[];if(t.useDataSource)i=l(a,t.useDataSource,o),t.useDataSources&&t.useDataSources.forEach((e=>{const t=l(a,e,o);t&&u.push(t)}));else{let t=p(a,o);t=t.filter((e=>c(e.dataSourceId,o))),t.length>0&&t.forEach(((t,a)=>{const o=r.dataSources[t.dataSourceId];let n;!o||o.type!==s.ArcGISDataSourceTypes.WebMap&&o.type!==s.ArcGISDataSourceTypes.WebScene?(n=(0,e.Immutable)({dataSourceId:t.dataSourceId,mainDataSourceId:t.mainDataSourceId,rootDataSourceId:t.rootDataSourceId,dataViewId:t.dataViewId}),i||(i=n),u.push(n)):n=null}))}return{useDataSource:i,useDataSources:u}}(this.props.config,this.props.messageWidgetId,this.props.messageType);let a=this.props.config.set("useDataSource",t.useDataSource);a=a.set("useDataSources",t.useDataSources),this.props.onSettingChange({actionId:this.props.actionId,config:a})}getStyle(t){return e.css`
      .setting-header {
        padding: ${e.polished.rem(10)} ${e.polished.rem(16)} ${e.polished.rem(0)} ${e.polished.rem(16)}
      }

      .deleteIcon {
        cursor: pointer;
        opacity: .8;
      }

      .deleteIcon:hover {
        opacity: 1;
      }
    `}render(){const r=d(this.props.messageWidgetId,this.props.config.useDataSource,this.props.config.useDataSources,this.props.messageType);let s;return s=this.checkIsSupportMultipleTriggerDataSources(this.props.messageWidgetId)||r.useDataSources?(0,e.Immutable)(r.useDataSources):r.useDataSource?(0,e.Immutable)([r.useDataSource]):(0,e.Immutable)([]),(0,e.jsx)("div",{css:this.getStyle(this.props.theme)},(0,e.jsx)(t.SettingSection,{title:this.props.intl.formatMessage({id:"mapAction_TriggerLayer",defaultMessage:o})},(0,e.jsx)(a.DataSourceSelector,{types:g,useDataSources:s,fromRootDsIds:r.fromRootDsIds,fromDsIds:r.fromDsIds,hideAddDataButton:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleTriggerLayerChange,widgetId:this.props.messageWidgetId,disableDataView:!1,hideDataView:(e,t)=>!p(this.props.messageWidgetId,this.props.messageType).filter((e=>e.mainDataSourceId===t)).find((t=>{let o;return o=t.dataViewId?t.dataViewId:a.DEFAULT_DATA_VIEW_ID,o===e.id})),isMultiple:this.checkIsSupportMultipleTriggerDataSources(this.props.messageWidgetId),isMultipleDataView:!0,hideCreateViewButton:!0,enableToSelectOutputDsFromSelf:!0})))}}D.defaultProps={config:(0,e.Immutable)({useDataSource:null})};const h=(0,r.withTheme)(D)})(),n})())}}}));
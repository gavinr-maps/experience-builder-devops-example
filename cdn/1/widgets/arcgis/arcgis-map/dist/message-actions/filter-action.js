System.register(["jimu-core"],(function(e,t){var a={};return{setters:[function(e){a.AbstractMessageAction=e.AbstractMessageAction,a.AppMode=e.AppMode,a.DataSourceManager=e.DataSourceManager,a.Immutable=e.Immutable,a.MessageActionConnectionType=e.MessageActionConnectionType,a.MessageType=e.MessageType,a.MutableStoreManager=e.MutableStoreManager,a.dataSourceUtils=e.dataSourceUtils,a.getAppStore=e.getAppStore,a.lodash=e.lodash,a.messageActionUtils=e.messageActionUtils}],execute:function(){e((()=>{"use strict";var e={79244:e=>{e.exports=a}},t={};function s(a){var r=t[a];if(void 0!==r)return r.exports;var o=t[a]={exports:{}};return e[a](o,o.exports,s),o.exports}s.d=(e,t)=>{for(var a in t)s.o(t,a)&&!s.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};return(()=>{s.r(r),s.d(r,{default:()=>o});var e=s(79244),t=function(e,t,a,s){return new(a||(a=Promise))((function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function n(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(i,n)}l((s=s.apply(e,t||[])).next())}))};const a="filterActionValue-";class o extends e.AbstractMessageAction{constructor(){super(...arguments),this.filterActions={}}filterMessageDescription(t){return(0,e.getAppStore)().getState().appRuntimeInfo.appMode!==e.AppMode.Express&&t.messageType===e.MessageType.DataRecordsSelectionChange}filterMessage(e){return!0}onRemoveListen(t,a){Object.keys(this.filterActions||{}).forEach((t=>{Object.entries(this.filterActions[t]||{}).forEach((s=>{var r;const o=s[0];(null===(r=s[1])||void 0===r?void 0:r.messageWidgetId)===a&&e.lodash.setValue(this.filterActions,`${t}.${o}.querySQL`,"")}));const s={layerDataSourceId:t.slice(18),querySQL:this.getUnionAllFilterQuerySQL(t)};e.MutableStoreManager.getInstance().updateStateValue(this.widgetId,t,s)}))}onExecute(a,s){return t(this,void 0,void 0,(function*(){switch(a.type){case e.MessageType.DataRecordsSelectionChange:const t=a.records;let r,o,i=null;if(s)if(s.messageUseDataSource&&s.actionUseDataSource){if(t.length>0){const a=[],r=t[0].dataSource.getMainDataSource();if(r){a.push(r.id);const e=r.getAssociatedDataSource&&r.getAssociatedDataSource();e&&a.push(e.id)}if(!a.includes(s.messageUseDataSource.mainDataSourceId)){e.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"filterActionValue",null);break}}if(r=e.DataSourceManager.getInstance().getDataSource(s.messageUseDataSource.mainDataSourceId),o=e.DataSourceManager.getInstance().getDataSource(s.actionUseDataSource.mainDataSourceId),r&&o)if(t.length<=0)i={layerDataSourceId:o&&o.id,querySQL:""};else if(s.enabledDataRelationShip){let t=null,n=null;if(s.messageUseDataSource.mainDataSourceId===s.actionUseDataSource.mainDataSourceId&&s.messageUseDataSource.rootDataSourceId===s.actionUseDataSource.rootDataSourceId){const e=r.getSchema(),a=e&&e.fields&&Object.keys(e.fields).find((t=>"esriFieldTypeOID"===e.fields[t].esriType));t=e&&e.fields&&e.fields[a],n=t}else{let a,i;if(s.connectionType===e.MessageActionConnectionType.UseLayersRelationship){const t=e.dataSourceUtils.getJimuDataSourceRelationship(r,o);t&&(a=t.keyField,i=t.relatedKeyField)}else a=s.messageUseDataSource.fields[0],i=s.actionUseDataSource.fields[0];a&&(t=r.getSchema().fields[a]),i&&(n=o.getSchema().fields[i])}let l="";if(t&&n){const i=t.name,c=t.type,u=a;let d=[];if(s.connectionType===e.MessageActionConnectionType.UseLayersRelationship){const e=(yield null==r?void 0:r.queryRelatedFieldValues(u.records||[],o,n.name))||[];d=this.getUniqueFormatedMessageFieldValues(e,c),0===d.length&&(d=["-1"],n=o.getSchema().fields[o.getIdField()])}else{const e=u.records.map((e=>e.getData()[i]));d=this.getUniqueFormatedMessageFieldValues(e,c)}if(l="",d.length>0){const t=!0,a=e.messageActionUtils.getSqlExpressionWidthMessageFieldValues(d,n,o,t);if(a){const t=(0,e.Immutable)(a),s=e.dataSourceUtils.getArcGISSQL(t,o);(null==s?void 0:s.sql)&&(l=null==s?void 0:s.sql)}}l||(l="")}if(a.records.length>0){const t=s.sqlExprObj?e.dataSourceUtils.getArcGISSQL(s.sqlExprObj,o).sql:null;t&&(l=l?l+" AND "+t:t)}else l="";i={layerDataSourceId:o&&o.id,querySQL:l}}else{let t="";if(a.records.length>0){const a=s.sqlExprObj?e.dataSourceUtils.getArcGISSQL(s.sqlExprObj,o).sql:null;a&&(t=a)}else t="";i={layerDataSourceId:o&&o.id,querySQL:t}}else i=null}else i=null;const n=this.getFilterMessageKey(a.widgetId,null==r?void 0:r.id),l=this.getFilterActionKey(null==i?void 0:i.layerDataSourceId);i&&(e.lodash.setValue(this.filterActions,`${l}.${n}`,{querySQL:null==i?void 0:i.querySQL,messageWidgetId:a.widgetId}),i.querySQL=this.getUnionAllFilterQuerySQL(l)),e.MutableStoreManager.getInstance().updateStateValue(this.widgetId,l,i)}return!0}))}getUnionAllFilterQuerySQL(e){let t="";return Object.entries(this.filterActions[e]||{}).forEach((e=>{var a;const s=null===(a=e[1])||void 0===a?void 0:a.querySQL;t=t&&s?` ${t} AND ${s} `:s||t})),t}getFilterActionKey(e){return`${a}${e}`}getFilterMessageKey(e,t){return`filterMessageValue-${e}-${t}`}getLayerIdFromLayerDs(e){return e.layerId?e.layerId:e.layer?e.layer.id:null}getUniqueFormatedMessageFieldValues(t,a){const s=[];for(let r=0;r<t.length;r++){const o=t[r],i=e.messageActionUtils.formatValue(o,a);s.includes(i)||s.push(i)}return s}}})(),r})())}}}));
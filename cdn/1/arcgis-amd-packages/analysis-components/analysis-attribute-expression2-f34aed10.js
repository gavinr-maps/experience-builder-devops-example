define(["exports","./index-86304dcd","./index2-600fb1b2","./t9n-cc9a26c8","./expressions-86d9b535","./utils-2b3d82c1","./analysis-query-entry2-c95d7a4d"],(function(e,t,s,i,a,n,l){"use strict";const o="flex-container",r="half-width",u=t.proxyCustomElement(class extends t.H{constructor(){super(),this.__registerHost(),this.__attachShadow(),this.analysisExpressionChange=t.createEvent(this,"analysisExpressionChange",7),this.analysisExpressionRemoveClick=t.createEvent(this,"analysisExpressionRemoveClick",7),this.defaultMaxDropdownItems=2e3,this.renderFieldValueComboBoxItem=e=>{let s=!1;return s="multi-value"===this.expression.type&&void 0!==this.expression.value?this.expression.value.includes(e.value):this.expression.value===e.value,t.h("calcite-combobox-item",{key:e.label,value:e.value,textLabel:e.label,selected:s})},this.onRemoveClick=e=>{this.analysisExpressionRemoveClick.emit(),e.stopPropagation()},this.onFieldSelect=e=>{var t;const s=e.target.selectedOption.value,i=null===(t=this.fields)||void 0===t?void 0:t.find((e=>e.name===s));void 0!==i&&(this.expression=new a.ExpressionController(this.expression).changeField(i,this.options),this.loadFieldValues(i.name)),this.analysisExpressionChange.emit()},this.setFieldValuesByUniqueValues=async e=>{var t;this.loadingMessage=this.strings.loadingFieldValues;let i=[];const a=`${this.target.id}-${e}`;let n=s.inCache("layerFieldValues",a);if(void 0===n)try{n=await s.fromCache((()=>s.getUniqueValues({layer:this.target,fieldName:e})),"layerFieldValues",a)}catch(e){this.loadingMessage=this.strings.errorRetrievingFieldValues}return i=(null!==(t=null==n?void 0:n.uniqueValueInfos)&&void 0!==t?t:[]).map((e=>{var t;return{value:e.value,label:null!==(t=e.label)&&void 0!==t?t:e.value}})),i},this.onOperatorSelect=e=>{const t=e.target.selectedOption.value;this.expression=new a.ExpressionController(this.expression).changeOperator(t),this.analysisExpressionChange.emit()},this.onValueInputChange=e=>{const t=e.target.value;this.expression.value=this.parseStringInput(t,this.expression.dataType),this.analysisExpressionChange.emit()},this.onValueComboboxChange=e=>{const t=e.target.value,s=Array.isArray(t)?t[0]:t;this.expression.value=this.parseStringInput(s,this.expression.dataType),this.analysisExpressionChange.emit()},this.onValuesComboboxChange=e=>{a.assert("multi-value"===this.expression.type,"Incorrect render function for expression type.");const t=e.target.value,i=(Array.isArray(t)?t:[t]).map((e=>this.parseStringInput(e,this.expression.dataType)));this.expression.value=i.filter((e=>!1===s.isEmptyDataItem(e))),this.analysisExpressionChange.emit()},this.onValueDateChange=()=>{const e=this.parseDateValueFromInputs(this.valueDateInputElement,this.valueTimeInputElement);this.expression.value=e,this.analysisExpressionChange.emit()},this.onRangeStartDateChange=()=>{a.assert("range"===this.expression.type,"Incorrect render function for expression type.");const e=this.parseDateValueFromInputs(this.startDateInputElement,this.startTimeInputElement);this.expression.value[0]=e,this.analysisExpressionChange.emit()},this.onRangeEndDateChange=()=>{a.assert("range"===this.expression.type,"Incorrect render function for expression type.");const e=this.parseDateValueFromInputs(this.endDateInputElement,this.endTimeInputElement);this.expression.value[1]=e,this.analysisExpressionChange.emit()},this.onRangeStartInputChange=e=>{a.assert("range"===this.expression.type,"Incorrect render function for expression type.");const t=e.target.value;this.expression.value[0]=this.parseStringInput(t,this.expression.dataType),this.analysisExpressionChange.emit()},this.onRangeEndInputChange=e=>{a.assert("range"===this.expression.type,"Incorrect render function for expression type.");const t=e.target.value;this.expression.value[1]=this.parseStringInput(t,this.expression.dataType),this.analysisExpressionChange.emit()},this.parseStringInput=(e,t)=>{let i;return i=s.isEmptyDataItem(e)?void 0:a.isFloatFieldType(t)?""===e?void 0:parseFloat(e):a.isIntFieldType(t)?""===e?void 0:parseInt(e):e,i},this.parseDateValueFromInputs=(e,t)=>{const s=null==e?void 0:e.valueAsDate,i=(null==t?void 0:t.value)?t.value.split(":"):[0,0];return new Date(s.getFullYear(),s.getMonth(),s.getDate(),Number(i[0]),Number(i[1]))},this.fields=void 0,this.fieldValues=[],this.loadingMessage=void 0,this.expression=void 0,this.target=void 0,this.options=void 0}get selectedField(){var e;return null===(e=this.fields)||void 0===e?void 0:e.find((e=>{var t;return e.name===(null===(t=this.expression)||void 0===t?void 0:t.field)}))}async loadFields(e){var t,s;null===(t=this.loadAbortController)||void 0===t||t.abort(),this.loadAbortController=new AbortController;try{await(null==e?void 0:e.load(this.loadAbortController.signal))}catch(e){}const i=null!==(s=null==e?void 0:e.fields)&&void 0!==s?s:[];this.fields=i.filter((t=>a.isSupportedField(t,this.options,e)))}async componentWillLoad(){this.strings=i.getStrings(),await this.loadFields(this.target),this.loadFieldValues(this.expression.field)}render(){switch(this.expression.type){case"value":return t.h("analysis-query-entry",{kind:"expression",appearance:"inline",onAnalysisQueryEntryRemove:this.onRemoveClick},t.h("div",{class:"single-value"},this.renderFieldSelect("auto"),this.renderOperatorSelect("auto"),this.renderValueInput()));case"multi-value":return t.h("analysis-query-entry",{kind:"expression",appearance:"section",onAnalysisQueryEntryRemove:this.onRemoveClick},t.h("div",{class:o},this.renderFieldSelect("half"),this.renderOperatorSelect("half")),this.renderValuesInput());case"range":return t.h("analysis-query-entry",{kind:"expression",appearance:"section",onAnalysisQueryEntryRemove:this.onRemoveClick},t.h("div",{class:o},this.renderFieldSelect("half"),this.renderOperatorSelect("half")),this.renderRangeInputs())}}renderFieldSelect(e="auto"){var s;return t.h("calcite-select",{class:"field-select",label:this.strings.fieldSelect,width:e,onCalciteSelectChange:this.onFieldSelect},null===(s=this.fields)||void 0===s?void 0:s.map((e=>{var s;return t.h("calcite-option",{value:e.name,selected:e.name===(null===(s=this.expression)||void 0===s?void 0:s.field)},e.alias)})))}renderOperatorSelect(e="auto"){const s=function(e){switch(e.dataType){case"string":return a.StringOperators;case"small-integer":case"integer":case"big-integer":case"single":case"double":case"long":case"oid":return a.NumericOperators;case"date":return a.DateOperators;case"geometry":return a.GeometryOperators;case"boolean":return a.BooleanOperators}}(this.expression),i=void 0!==this.getSelectedFieldDomainOptions(),n=s.filter((e=>!(i&&a.isRangeOperator(e))));return t.h("calcite-select",{label:this.strings.expressionOperatorSelect,key:this.expression.operator,width:e,onCalciteSelectChange:this.onOperatorSelect},n.map((e=>{var s;const i=this.strings.operators[e],a="is_true"===e||"is_false"===e?i.toLocaleLowerCase():i;return t.h("calcite-option",{value:e,selected:(null===(s=this.expression)||void 0===s?void 0:s.operator)===e},a)})))}renderValueInput(){var e,s;a.assert("value"===this.expression.type,"Incorrect render function for expression type.");const{dataType:i,value:l,operator:o}=this.expression,r=void 0!==l&&t.h("calcite-combobox-item",{key:`${l}`,value:l,textLabel:`${l}`,selected:!0});let u=this.fieldValues.filter((e=>e.value!==l));const d=u.length>this.defaultMaxDropdownItems;let h;if(u=u.slice(0,null!==(s=null===(e=this.options)||void 0===e?void 0:e.maxDropdownItems)&&void 0!==s?s:this.defaultMaxDropdownItems),a.isNoValueOperator(o))h=null;else if(a.isFloatFieldType(i)||a.isIntFieldType(i)){const e=a.isFloatFieldType(i)?"any":1,s=this.getSelectedFieldMinMax();h=t.h("calcite-input-number",{step:e,placeholder:this.strings.inputPlaceholderText,value:void 0===l?void 0:`${l}`,onCalciteInputNumberChange:this.onValueInputChange,min:null==s?void 0:s.min,max:null==s?void 0:s.max})}else h="date"===i?this.renderValueDateInput():t.h("calcite-combobox",{class:"value-select",label:this.strings.choiceList,allowCustomValues:!0,scale:n.UIDefaults.MediumScale,selectionMode:"single",key:this.expression.operator,value:void 0===l?void 0:`${l}`,placeholder:this.strings.inputPlaceholderText,onCalciteComboboxChange:this.onValueComboboxChange,overlayPositioning:"fixed"},r,void 0!==this.loadingMessage?t.h(t.Fragment,null,t.h("calcite-combobox-item",{key:this.loadingMessage,value:void 0,textLabel:this.loadingMessage,selected:!1,disabled:!0})):t.h(t.Fragment,null,u.map((e=>this.renderFieldValueComboBoxItem(e))),d&&t.h("calcite-combobox-item",{key:this.strings.tooManyValuesToDisplay,value:void 0,textLabel:this.strings.tooManyValuesToDisplay,selected:!1,disabled:!0})));return h}renderValuesInput(){var e,i;a.assert("multi-value"===this.expression.type,"Incorrect render function for expression type.");let l=[];!1===s.isEmptyDataItem(this.expression.value)&&(l=this.expression.value.map((e=>`${e}`)));const o=l.map((e=>t.h("calcite-combobox-item",{key:e,value:e,textLabel:e,selected:!0})));let r;if(!1===s.isEmptyDataItem(this.fieldValues)){let s=this.fieldValues.filter((e=>!l.includes(`${e.value}`)));const a=s.length>this.defaultMaxDropdownItems;s=s.slice(0,null!==(i=null===(e=this.options)||void 0===e?void 0:e.maxDropdownItems)&&void 0!==i?i:this.defaultMaxDropdownItems),r=t.h(t.Fragment,null,o,void 0!==this.loadingMessage?t.h("calcite-combobox-item",{key:this.loadingMessage,value:void 0,textLabel:this.loadingMessage,selected:!1,disabled:!0}):t.h(t.Fragment,null,null==s?void 0:s.map((e=>t.h("calcite-combobox-item",{key:`${e.label}`,value:e.value,textLabel:`${e.label}`,selected:l.includes(`${e.value}`)}))),a&&t.h("calcite-combobox-item",{key:this.strings.tooManyValuesToDisplay,value:void 0,textLabel:this.strings.tooManyValuesToDisplay,selected:!1,disabled:!0})))}else r=o;return t.h("calcite-combobox",{label:this.strings.multiInputPlaceholderText,onCalciteComboboxChange:this.onValuesComboboxChange,allowCustomValues:!0,selectionMode:"multiple",scale:n.UIDefaults.MediumScale,value:l,key:this.expression.operator,overlayPositioning:"fixed",placeholder:this.strings.inputPlaceholderText,clearDisabled:!0},r)}renderValueDateInput(){a.assert("value"===this.expression.type,"Incorrect render function for expression type.");const{operator:e,value:s}=this.expression,i=s,n=this.parseTimeValue(i),l=["is_on","is_not_on"].includes(e);return t.h("div",{class:o},t.h("calcite-input-date-picker",{key:"value-date",placement:"bottom",class:l?o:r,layout:"vertical",overlayPositioning:"fixed",valueAsDate:i,onCalciteInputDatePickerChange:this.onValueDateChange,ref:e=>{this.valueDateInputElement=e}}),!l&&t.h("calcite-input-time-picker",{key:"value-time",placement:"bottom",class:r,overlayPositioning:"fixed",value:n,onCalciteInputTimePickerChange:this.onValueDateChange,ref:e=>{this.valueTimeInputElement=e}}))}renderRangeInputs(){a.assert("range"===this.expression.type,"Incorrect render function for expression type.");const{dataType:e,value:s}=this.expression;let i;if(a.isFloatFieldType(e)||a.isIntFieldType(e)){const n=a.isFloatFieldType(e)?"any":1,l=this.getSelectedFieldMinMax();i=t.h("div",{class:o},t.h("calcite-input-number",{step:n,class:r,value:void 0===s[0]?"":`${s[0]}`,onCalciteInputNumberChange:this.onRangeStartInputChange,min:null==l?void 0:l.min,max:null==l?void 0:l.max}),t.h("calcite-input-number",{step:n,class:r,value:void 0===s[1]?"":`${s[1]}`,onCalciteInputNumberChange:this.onRangeEndInputChange,min:null==l?void 0:l.min,max:null==l?void 0:l.max}))}else i="date"===e?this.renderRangeDateInputs():t.h("p",null,"Not supported yet.");return i}renderRangeDateInputs(){a.assert("range"===this.expression.type,"Incorrect render function for expression type.");const{value:e}=this.expression,s=e[0],i=e[1],n=this.parseTimeValue(s),l=this.parseTimeValue(i);return t.h("div",{class:o},t.h("calcite-input-date-picker",{key:"start-date",class:r,placement:"bottom",overlayPositioning:"fixed",valueAsDate:s,onCalciteInputDatePickerChange:this.onRangeStartDateChange,ref:e=>{this.startDateInputElement=e}}),t.h("calcite-input-time-picker",{key:"start-time",class:r,placement:"bottom",overlayPositioning:"fixed",value:n,onCalciteInputTimePickerChange:this.onRangeStartDateChange,ref:e=>{this.startTimeInputElement=e}}),t.h("calcite-input-date-picker",{key:"end-date",class:r,placement:"bottom",overlayPositioning:"fixed",valueAsDate:i,onCalciteInputDatePickerChange:this.onRangeEndDateChange,ref:e=>{this.endDateInputElement=e}}),t.h("calcite-input-time-picker",{key:"end-time",class:r,placement:"bottom",overlayPositioning:"fixed",value:l,onCalciteInputTimePickerChange:this.onRangeEndDateChange,ref:e=>{this.endTimeInputElement=e}}))}async loadFieldValues(e){var t;let i=null!==(t=this.getSelectedFieldDomainOptions())&&void 0!==t?t:[];s.isEmptyDataItem(i)&&(i=await this.setFieldValuesByUniqueValues(e)),this.fieldValues=i,this.loadingMessage!==this.strings.errorRetrievingFieldValues&&(this.loadingMessage=s.isEmptyDataItem(this.fieldValues)?this.strings.noFieldValuesRetrieved:void 0)}getSelectedFieldMinMax(){var e;let t;const s=null===(e=this.selectedField)||void 0===e?void 0:e.domain;return"range"===(null==s?void 0:s.type)&&(t={min:s.minValue,max:s.maxValue}),t}getSelectedFieldDomainOptions(){var e,t,s,i,a;let n;const l=null===(e=this.selectedField)||void 0===e?void 0:e.name,o=null===(t=this.selectedField)||void 0===t?void 0:t.domain;if("coded-value"===(null==o?void 0:o.type))n=o.codedValues.map((e=>({label:e.name,value:e.code})));else if(void 0!==l&&l===(null===(s=this.target)||void 0===s?void 0:s.typeIdField))n=null===(i=this.target)||void 0===i?void 0:i.types.map((e=>({label:e.name,value:e.id})));else if(void 0!==l&&void 0!==(null===(a=this.target)||void 0===a?void 0:a.types)){const e=new Map;for(const t of this.target.types){const s=t.domains[l];if("coded-value"===(null==s?void 0:s.type))for(const t of s.codedValues){const s=e.get(t.code);void 0===s?e.set(t.code,[t.name]):s.includes(t.name)||s.push(t.name)}}if(e.size>0){n=[];for(const[t,s]of e)n.push({label:s.join(" | "),value:t})}}return n}parseTimeValue(e){return e instanceof Date?e.toTimeString().substring(0,5):void 0}get hostElement(){return this}static get watchers(){return{target:["loadFields"]}}static get style(){return":root{--analysis-quarter-spacing:0.25rem;--analysis-half-spacing:0.5rem;--analysis-three-quarter-spacing:0.75rem;--analysis-full-spacing:1rem;--analysis-component-default-width:100%;--analysis-ui-border-input:var(--calcite-ui-border-2);--analysis-label-font-size:var(--calcite-font-size--2);--analysis-popover-content-min-height:30vh;--analysis-popover-content-max-height:60vh;--analysis-popover-content-height:45vh}.flex-container{display:flex}.half-width{width:50%}.single-value{display:flex}.single-value .field-select{max-inline-size:45%}.single-value .value-select{--calcite-combobox-input-height:1rem;min-width:150px}"}},[1,"analysis-attribute-expression",{expression:[1040],target:[16],options:[16],fields:[32],fieldValues:[32],loadingMessage:[32]}]);function d(){"undefined"!=typeof customElements&&["analysis-attribute-expression","analysis-query-entry"].forEach((e=>{switch(e){case"analysis-attribute-expression":customElements.get(e)||customElements.define(e,u);break;case"analysis-query-entry":customElements.get(e)||l.defineCustomElement()}}))}d(),e.AnalysisAttributeExpression=u,e.defineCustomElement=d}));
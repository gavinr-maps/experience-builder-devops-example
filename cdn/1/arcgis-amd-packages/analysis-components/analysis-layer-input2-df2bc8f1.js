define(["exports","./index-86304dcd","./index2-600fb1b2","./utils-2b3d82c1","./helpmap-dbc7a68f","./analysis-item-browser2-db031f89","./analysis-label2-b880686f","./analysis-layer-input-popover2-fe1e3b94","./isEqual-7dac7fee"],(function(e,t,s,i,a,r,l,o,n){"use strict";const d=t.proxyCustomElement(class extends t.H{constructor(){super(),this.__registerHost(),this.__attachShadow(),this.analysisLayerInputChange=t.createEvent(this,"analysisLayerInputChange",7),this.analysisLayerInputClose=t.createEvent(this,"analysisLayerInputClose",7),this.analysisHelpClick=t.createEvent(this,"analysisHelpClick",7),this.replaceId=null,this.filteredMapLayers=[],this.showNoticeMessage=!1,this.noticeMessage=[],this.warningMessageForPopover=[],this.filterFeatureLayers=e=>e.filter((e=>void 0!==e&&s.isFeatureLayer(e)&&e.loaded)),this.updateWarningMessage=(e,t)=>{var i,a,r;const l=t.length-e.length;if(this.warningMessage=void 0,l>0){const o=new Map(this.mapLayers.map((e=>[e.id,e]))),n=null!==(i=t.find((t=>!e.includes(t))))&&void 0!==i?i:"",d=null!==(r=null===(a=o.get(n))||void 0===a?void 0:a.title)&&void 0!==r?r:"",h=1===l?this.strings.layerNotAvailable:this.strings.multipleLayersNotAvailable;this.warningMessage=s.formatMessage(h,{layerName:d})}},this.filterInternalLayers=async e=>{const t=e.map((e=>{var t,i;return s.getProxyServiceInfo(e,null===(i=null===(t=this.user)||void 0===t?void 0:t.portal)||void 0===i?void 0:i.url)}));let i=await Promise.all(t);return i=i.filter((e=>void 0!==e)),e.filter((e=>i.includes(e.id)))},this.syncValueWithIds=async()=>{var e;const t=[...this.browsedLayers,...this.mapLayers],i=[],a=[],r="multi"!==this.selectionMode;for(const r of null!==(e=this.selectedLayerIds)&&void 0!==e?e:[]){const e=t.find((e=>r===e.id));if(void 0!==e){let t;a.push(e),s.isFeatureLayer(e)?t=s.getGPFeatureRecordSetLayerValue(e,this.mapView):(s.isImageryLayer(e)||s.isImageryTileLayer(e))&&(t=s.getImageryLayerValue(e)),void 0!==t&&i.push(t)}}if(this.value=r?i[0]:i,this.selectedLayers=r?a[0]:a,this.processedLayerProperties={},r||Array.isArray(this.selectedLayers)&&1===this.selectedLayers.length){const e=a[0];if(void 0!==e&&(s.isImageryLayer(e)||s.isImageryTileLayer(e)))this.processedLayerProperties=await s.processImageryLayer(e);else if(void 0!==e&&s.isFeatureLayer(e)){const t=e.fields,s=null==t?void 0:t.map((e=>e.name));this.processedLayerProperties.fieldNames=s}}this.analysisLayerInputChange.emit()},this.renderInitialMode=()=>(this.removeTooltip(),t.h("section",null,void 0!==this.label&&""!==this.label?t.h("analysis-label",{label:this.label,required:this.required,onAnalysisLabelHelpActionClick:()=>this.analysisHelpClick.emit()}):null,this.renderButton())),this.renderErrorMessage=()=>{var e;const a=!1===s.isEmptyDataItem(null===(e=this.validationParams)||void 0===e?void 0:e.message)||void 0!==this.errorMessage,r=this.formatValidationParamsMessage();return t.h("calcite-input-message",{status:s.UIInputStatus.INVALID,hidden:!a,scale:i.UIDefaults.Scale,icon:"exclamationMarkTriangle"},null!=r?r:this.errorMessage)},this.formatValidationParamsMessage=()=>{var e;let t=null===(e=this.validationParams)||void 0===e?void 0:e.message;return void 0!==this.validationParams&&void 0!==this.validationParams.message&&void 0!==this.validationParams.variables&&(t=s.formatMessage(this.validationParams.message,this.validationParams.variables)),t},this.renderWarningMessage=()=>void 0!==this.warningMessage?t.h("calcite-input-message",{icon:"exclamationMarkTriangle",scale:i.UIDefaults.Scale},t.h("div",{class:"warning-message"},this.warningMessage)):null,this.renderButton=()=>t.h("div",{class:"flex-container"},t.h("calcite-button",{class:"primary-button",appearance:"outline",kind:"neutral",scale:i.UIDefaults.Scale,round:!0,"icon-start":"plus",onClick:this.primaryButtonClicked},this.strings.layer)),this.renderListMode=()=>{const e=Array.isArray(this.selectedLayers)?this.selectedLayers:[this.selectedLayers];return t.h("section",null,t.h("calcite-label",null,void 0!==this.label&&""!==this.label?t.h("analysis-label",{label:this.label,required:this.required,onAnalysisLabelHelpActionClick:()=>this.analysisHelpClick.emit()}):null,t.h("calcite-value-list",{class:"border",onClick:this.replaceLayer,onMouseOver:this.mouseOver,onMouseOut:this.mouseOut},e.map((e=>this.renderListModeItem(e))))),"multi"===this.selectionMode?this.renderButton():null)},this.renderListModeItem=e=>{var i,a;let r="";if(s.isFeatureLayer(e)&&"featureCount"===this.descriptionDisplay)r=s.formatMessage(this.strings.numberFeatures,{featureCount:null!==(i=this.featureCounts.get(e.id))&&void 0!==i?i:this.strings.numberFeaturesLoading});else if("spatialReference"===this.descriptionDisplay){const t=e.fullExtent.spatialReference.latestWkid;r=null!==(a=this.wkidMap.get(t))&&void 0!==a?a:""}const l=s.formatMessage(this.strings.layerAction,{layerName:e.title});return t.h("calcite-value-list-item",{key:e.id,value:e.id,label:s.getLayerLabel(e),description:r},t.h("calcite-action",{"data-layerId":e.id,text:l,slot:"actions-end",label:l,appearance:"transparent",icon:"x",onClick:this.actionClicked}))},this.layerSelectionChange=async e=>{var t,s;const i=Array.from(e.detail.selectedLayers.keys());if(null===this.replaceId){const e=(null!==(t=this.selectedLayerIds)&&void 0!==t?t:[]).filter((e=>this.browsedLayers.some((t=>t.id===e))));this.selectedLayerIds=[...i,...e]}else this.browsedLayers=this.browsedLayers.map((t=>this.replaceId===t.id?e.detail[0]:t)).filter((e=>void 0!==e)),this.selectedLayerIds=null===(s=this.selectedLayerIds)||void 0===s?void 0:s.map((e=>e===this.replaceId?i[0]:e)),this.replaceId=null;await this.syncValueWithIds(),this.validate()},this.handleLayerBrowsed=e=>{var t,s;"multi"!==this.selectionMode?(this.browsedLayers=e.detail,this.selectedLayers=this.browsedLayers):null===this.replaceId?(this.browsedLayers=[...this.browsedLayers,...e.detail],this.selectedLayers=[...null!==(t=this.selectedLayers)&&void 0!==t?t:[],...this.browsedLayers]):(this.browsedLayers=this.browsedLayers.map((t=>this.replaceId===t.id?e.detail[0]:t)),this.selectedLayers=null===(s=this.selectedLayers)||void 0===s?void 0:s.map((t=>this.replaceId===t.id?e.detail[0]:t)),this.replaceId=null),this.validate(),this.updateFeatureCounts(this.browsedLayers)},this.primaryButtonClicked=e=>{this.createLayerPopover(e.target)},this.replaceLayer=e=>{const t=e.target;"calcite-value-list-item"===(null==t?void 0:t.localName)&&(this.replaceId=t.value,this.createLayerPopover(t),void 0!==this.layerInputPopover&&null!==this.replaceId&&(this.layerInputPopover.selectedLayerIds=[this.replaceId]))},this.actionClicked=async e=>{var t,s;const i=null===(t=e.target)||void 0===t?void 0:t.getAttribute("data-layerId");this.selectedLayerIds=null===(s=this.selectedLayerIds)||void 0===s?void 0:s.filter((e=>e!==i)),this.browsedLayers=this.browsedLayers.filter((e=>e.id!==i)),this.analysisLayerInputClose.emit(),await this.syncValueWithIds(),this.validate()},this.mouseOver=e=>{const t=e.target;"calcite-value-list-item"===(null==t?void 0:t.localName)&&(void 0===this.replaceTooltip&&(this.replaceTooltip=document.createElement("calcite-tooltip"),this.replaceTooltip.placement="bottom",this.replaceTooltip.innerText=this.strings.replaceLayer),this.replaceTooltip.referenceElement=t,i.addOpenableDomElement(document,this.replaceTooltip))},this.mouseOut=()=>{this.removeTooltip()},this.layerPopoverClose=()=>{this.replaceId=null,i.removeOpenableDomElement(this.layerInputPopover),this.layerInputPopover=void 0,this.validate()},this.validate=()=>{var e,t,i,a;this.warningMessage=void 0,this.errorMessage=void 0;const r=this.formatValidationParamsMessage();!1!=(!this.required||void 0!==this.selectedLayers&&(!Array.isArray(this.selectedLayers)||this.selectedLayers.length>0))?void 0!==this.selectedLayerFeatureCount&&(void 0!==this.minimumFeatureCount&&this.selectedLayerFeatureCount<this.minimumFeatureCount&&(this.errorMessage=void 0!==(null===(i=this.validationParams)||void 0===i?void 0:i.message)?r:s.formatMessage(this.strings.featureCountBelowMinimum,{label:this.label,minimum:this.minimumFeatureCount.toString()})),void 0!==this.maximumFeatureCount&&this.selectedLayerFeatureCount>this.maximumFeatureCount&&(this.errorMessage=void 0!==(null===(a=this.validationParams)||void 0===a?void 0:a.message)?r:s.formatMessage(this.strings.featureCountAboveMaximum,{label:this.label,maximum:this.maximumFeatureCount.toString()}))):this.errorMessage=void 0!==(null===(e=this.validationParams)||void 0===e?void 0:e.message)?r:s.formatMessage(this.strings.isRequired,{label:null!==(t=this.label)&&void 0!==t?t:this.strings.layer})},this.removeTooltip=()=>{i.removeOpenableDomElement(this.replaceTooltip)},this.updateFeatureCounts=e=>{const{mapView:t}=this,i=this.filterFeatureLayers(e).map((async e=>{let i;try{i=(await s.queryCount(e,t)).toString()}catch(e){}return[e.id,i]}));return Promise.all(i).then((e=>{const t=e.filter((([,e])=>void 0!==e)),s=[...this.featureCounts].filter((([e])=>{var t;return null===(t=this.selectedLayerIds)||void 0===t?void 0:t.includes(e)}));this.featureCounts=new Map([...s,...t])})).catch((()=>{}))},this.value=void 0,this.label=void 0,this.required=!1,this.validationParams=void 0,this.user=void 0,this.portalHelpMap=void 0,this.mapLayers=[],this.mapView=void 0,this.selectionMode=void 0,this.selectedLayers=void 0,this.selectedLayerIds=void 0,this.selectedLayerFeatureCount=void 0,this.minimumFeatureCount=void 0,this.maximumFeatureCount=void 0,this.processedLayerProperties={},this.layerFilterType=void 0,this.descriptionDisplay="featureCount",this.hideBrowseButton=!1,this.featureCounts=new Map,this.browsedLayers=[],this.errorMessage=void 0}async mapLayersChange(e){var t,a;let r=e;!1===s.isEmptyDataItem(null===(t=this.user)||void 0===t?void 0:t.portal)&&!1===(null===(a=this.user)||void 0===a?void 0:a.portal.isPortal)&&(r=await this.filterInternalLayers(e));const{validLayers:l}=await i.filterLayersByType({layers:r,layerFilterTypes:this.layerFilterType,user:this.user}),o=s.filterLayersAllowAnalysis(l);if(o.length<e.length){this.noticeMessage=[];const t=r.length<e.length,s=o.length<l.length;t&&this.warningMessageForPopover.push("proxyReason"),s&&this.warningMessageForPopover.push("allowAnalysisReason")}this.showNoticeMessage=this.warningMessageForPopover.length>0,this.filteredMapLayers=o.filter((e=>e.loaded)),void 0!==this.layerInputPopover&&(this.layerInputPopover.mapLayers=this.filteredMapLayers),"featureCount"===this.descriptionDisplay&&this.updateFeatureCounts(e)}async selectedLayersChange(e,t){var s,i;if(void 0!==e&&!n.isEqual(e,t)){let t=Array.isArray(e)?e:[e];const a=t.map((e=>e.id)),r=await Promise.allSettled(t.map((e=>e.loaded?Promise.resolve(e):e.load())));t=r.filter((e=>"fulfilled"===e.status)).map((e=>e.value));const l=t.filter((e=>e.loaded)).map((e=>e.id));this.updateWarningMessage(l,a),this.selectedLayerIds=Array.from(new Set(l));const o=this.featureCounts.get(null!==(i=null===(s=this.selectedLayerIds)||void 0===s?void 0:s[0])&&void 0!==i?i:"");void 0!==o&&"multi"!==this.selectionMode&&(this.selectedLayerFeatureCount=parseInt(o)),await this.syncValueWithIds(),void 0===this.warningMessage&&this.validate()}}layerFilterTypeChange(e){this.layerFilterType=e,this.mapLayersChange(this.mapLayers)}onFeatureCountChange(){if(void 0!==this.selectedLayerIds&&this.selectedLayerIds.length>0&&"multi"!==this.selectionMode){const e=this.featureCounts.get(this.selectedLayerIds[0]);void 0!==e&&this.selectedLayerFeatureCount!==parseInt(e)&&(this.selectedLayerFeatureCount=parseInt(e),this.analysisLayerInputChange.emit())}}async checkValidity(){this.validate();const e=void 0===this.errorMessage;return Promise.resolve(e)}disconnectedCallback(){i.removeOpenableDomElement(this.layerInputPopover),i.removeOpenableDomElement(this.replaceTooltip)}async componentWillLoad(){({strings:this.strings,dir:this.dir}=await s.fetchComponentLocaleStrings(this.hostElement,t.getAssetPath("."))),this.wkidMap=s.getWkidMap(),void 0!==this.mapLayers&&this.mapLayersChange(this.mapLayers),await this.selectedLayersChange(this.selectedLayers,void 0)}get isInitialMode(){return void 0===this.selectedLayerIds||0===this.selectedLayerIds.length}render(){return t.h(t.Host,null,this.isInitialMode?this.renderInitialMode():this.renderListMode(),this.renderErrorMessage(),this.renderWarningMessage())}createLayerPopover(e){var t,r,l,o,n,d,h,u,p;void 0===this.layerInputPopover&&(this.layerInputPopover=document.createElement("analysis-layer-input-popover"),this.layerInputPopover.addEventListener("analysisLayerInputPopoverClose",this.layerPopoverClose),this.layerInputPopover.addEventListener("analysisLayerInputPopoverSelectionChange",this.layerSelectionChange),this.layerInputPopover.addEventListener("analysisLayerInputPopoverLayerBrowsed",this.handleLayerBrowsed)),!0===this.isInitialMode||"calcite-button"===e.localName?(this.layerInputPopover.selectionMode=this.selectionMode,void 0!==this.selectedLayerIds&&(this.layerInputPopover.selectedLayerIds=[...this.selectedLayerIds])):this.layerInputPopover.selectionMode="single",this.layerInputPopover.mapLayers=this.filteredMapLayers,this.layerInputPopover.itemBrowserFilter=i.makePortalSearchFilterByType(this.layerFilterType),this.layerInputPopover.itemBrowserAllowedGeometries=i.makeAllowedGeometriesByType(this.layerFilterType),this.layerInputPopover.layerFilterType=this.layerFilterType,this.layerInputPopover.showNoticeMessage=this.showNoticeMessage;const y=!0===(null===(r=null===(t=this.user)||void 0===t?void 0:t.portal)||void 0===r?void 0:r.isPortal)&&void 0!==this.portalHelpMap?null===(l=this.portalHelpMap)||void 0===l?void 0:l.m[a.helpMap.map.OtherHelpLinks.supportedData]:a.helpMap.map.OtherHelpLinks.supportedData,c=s.formatLearnMoreHelpUrl({url:y,basePath:s.getHelpBaseUrl(null===(o=this.user)||void 0===o?void 0:o.portal),portalUrl:null===(d=null===(n=this.user)||void 0===n?void 0:n.portal)||void 0===d?void 0:d.restUrl}),m=this.warningMessageForPopover.map((e=>s.formatMessage(this.strings[e],{docLink:c})));this.layerInputPopover.noticeMessage=[...this.noticeMessage,...m],this.layerInputPopover.placement="leading",this.layerInputPopover.dir=this.dir,this.layerInputPopover.hideBrowseButton=this.hideBrowseButton,this.layerInputPopover.referenceElement=null!==(h=e.parentElement)&&void 0!==h?h:e,this.layerInputPopover.popoverWidth=null===(u=e.parentElement)||void 0===u?void 0:u.offsetWidth,this.layerInputPopover.mapView=this.mapView,void 0!==this.user&&(this.layerInputPopover.user=this.user,this.layerInputPopover.portal=null===(p=this.user)||void 0===p?void 0:p.portal),i.addOpenableDomElement(document,this.layerInputPopover)}static get assetsDirs(){return["t9n"]}get hostElement(){return this}static get watchers(){return{mapLayers:["mapLayersChange"],selectedLayers:["selectedLayersChange"],layerFilterType:["layerFilterTypeChange"],featureCounts:["onFeatureCountChange"]}}static get style(){return":root{--analysis-quarter-spacing:0.25rem;--analysis-half-spacing:0.5rem;--analysis-three-quarter-spacing:0.75rem;--analysis-full-spacing:1rem;--analysis-component-default-width:100%;--analysis-ui-border-input:var(--calcite-ui-border-2);--analysis-label-font-size:var(--calcite-font-size--2);--analysis-popover-content-min-height:30vh;--analysis-popover-content-max-height:60vh;--analysis-popover-content-height:45vh}:host{display:flex;flex-direction:column;width:var(--analysis-component-default-width);margin-bottom:var(--analysis-half-spacing);--calcite-label-margin-bottom:0}.flex-container{display:flex;width:var(--analysis-component-default-width);column-gap:3%}.primary-button{flex:1 1 auto}.secondary-button{flex:auto 1 auto}.text{padding-bottom:var(--analysis-quarter-spacing);margin-block-start:0;margin-block-end:0}.border{border:1px solid var(--calcite-ui-border-input);margin-bottom:var(--analysis-half-spacing)}.warning-message{word-wrap:break-word;overflow-wrap:anywhere}"}},[1,"analysis-layer-input",{value:[1040],label:[513],required:[516],validationParams:[16],user:[16],portalHelpMap:[16],mapLayers:[16],mapView:[16],selectionMode:[513,"selection-mode"],selectedLayers:[1040],selectedLayerIds:[1040],selectedLayerFeatureCount:[1026,"selected-layer-feature-count"],minimumFeatureCount:[2,"minimum-feature-count"],maximumFeatureCount:[2,"maximum-feature-count"],processedLayerProperties:[1040],layerFilterType:[1,"layer-filter-type"],descriptionDisplay:[513,"description-display"],hideBrowseButton:[516,"hide-browse-button"],featureCounts:[32],browsedLayers:[32],errorMessage:[32],checkValidity:[64]}]);function h(){"undefined"!=typeof customElements&&["analysis-layer-input","analysis-item-browser","analysis-label","analysis-layer-input-popover"].forEach((e=>{switch(e){case"analysis-layer-input":customElements.get(e)||customElements.define(e,d);break;case"analysis-item-browser":customElements.get(e)||r.defineCustomElement();break;case"analysis-label":customElements.get(e)||l.defineCustomElement();break;case"analysis-layer-input-popover":customElements.get(e)||o.defineCustomElement()}}))}h(),e.AnalysisLayerInput=d,e.defineCustomElement=h}));